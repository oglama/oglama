/*!
 * @architect Mark Jivko <mark@oglama.com>
 * @copyright Â© 2024-2025 Oglama (https://oglama.com)
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var uh=Object.defineProperty;var Do=J=>{throw TypeError(J)};var dh=(J,y,d)=>y in J?uh(J,y,{enumerable:!0,configurable:!0,writable:!0,value:d}):J[y]=d;var Ze=(J,y)=>()=>(y||J((y={exports:{}}).exports,y),y.exports);var P=(J,y,d)=>dh(J,typeof y!="symbol"?y+"":y,d),No=(J,y,d)=>y.has(J)||Do("Cannot "+d);var w=(J,y,d)=>(No(J,y,"read from private field"),d?d.call(J):y.get(J)),ge=(J,y,d)=>y.has(J)?Do("Cannot add the same private member more than once"):y instanceof WeakSet?y.add(J):y.set(J,d),Je=(J,y,d,m)=>(No(J,y,"write to private field"),m?m.call(J,d):y.set(J,d),d);var fn=Ze((Wh,Oo)=>{var wt;Oo.exports=(wt=class{static getSourceChannelName(y){return"".concat(wt.WINDOW_SOURCE,"/").concat(y)}static getTargetChannelName(y){return"".concat(wt.WINDOW_TARGET,"/").concat(y)}static generateKey(){return"".concat(Date.now().toString(36)).concat(Math.random().toString(36).substring(2,13))}},P(wt,"WINDOW_MAIN_LOGIN","@main/login"),P(wt,"WINDOW_MAIN","@main"),P(wt,"WINDOW_SOURCE","@source"),P(wt,"WINDOW_TARGET","@target"),wt)});var Pt=Ze((qh,Lo)=>{var{ipcRenderer:hh}=require("electron"),fr,Uo;Lo.exports=(Uo=class{constructor(){ge(this,fr,{})}_register(y){if(typeof y=="string")for(let d of Object.getOwnPropertyNames(this))["_","#"].includes(d[0])||typeof this[d]!="function"||(w(this,fr)[d]="ipc:".concat(y,":").concat(d))}_runner(y,...d){let m=function(v,I,x){this.run=async function(){let R=null;if(typeof w(v,fr)[I]=="string"&&(R=await hh.invoke(w(v,fr)[I],...x)),R instanceof Error)throw new Error("".concat(w(v,fr)[I]," ").concat(R.message??R));return R}};return new m(this,y,d)}async _promise(y,...d){return await this._runner(y,...d).run()}},fr=new WeakMap,Uo)});var Wo=Ze((Kh,Vo)=>{var fh=Pt();Vo.exports=class extends fh{constructor(){super();P(this,"openAgentFiles",d=>this._promise("openAgentFiles",d));P(this,"purge",d=>this._promise("purge",d));P(this,"runInit",(d,m=null,v=null,I=null)=>this._promise("runInit",d,m,v,I));P(this,"runDelete",(d,m)=>this._promise("runDelete",d,m));P(this,"envGet",d=>this._promise("envGet",d));P(this,"envSet",(d,m)=>this._promise("envSet",d,m));P(this,"sourceGet",d=>this._promise("sourceGet",d));P(this,"sourceSet",(d,m)=>this._promise("sourceSet",d,m));P(this,"inputsGet",(d,m="session",v=null)=>this._promise("inputsGet",d,m,v));P(this,"inputScalarsSet",(d,m,v=null)=>this._promise("inputScalarsSet",d,m,v));P(this,"inputFilesAdd",(d,m,v,I=null)=>this._promise("inputFilesAdd",d,m,v,I));P(this,"inputFilesDelete",(d,m,v,I=null)=>this._promise("inputFilesDelete",d,m,v,I));P(this,"inputTableQuery",(d,m,v=1,I=5e3,x=null)=>this._promise("inputTableQuery",d,m,v,I,x));P(this,"inputTableAdd",(d,m,v=[],I=null)=>this._promise("inputTableAdd",d,m,v,I));P(this,"inputTableGet",(d,m,v,I="session",x=null)=>this._promise("inputTableGet",d,m,v,I,x));P(this,"inputTableUpdate",(d,m,v,I,x=null)=>this._promise("inputTableUpdate",d,m,v,I,x));P(this,"inputTableDelete",(d,m,v=null,I=null)=>this._promise("inputTableDelete",d,m,v,I));P(this,"outputTableQuery",(d,m,v,I=1,x=5e3)=>this._promise("outputTableQuery",d,m,v,I,x));P(this,"outputTableAdd",(d,m,v,I)=>this._promise("outputTableAdd",d,m,v,I));P(this,"outputsGet",(d,m)=>this._promise("outputsGet",d,m));P(this,"outputsQuery",(d,m,v=null,I=null,x=null)=>this._promise("outputsQuery",d,m,v,I,x));P(this,"outputScalarSet",async(d,m,v,I)=>this._promise("outputScalarSet",d,m,v,I));P(this,"outputFilesInit",async(d,m,v,I=null)=>this._promise("outputFilesInit",d,m,v,I));P(this,"outputFilesAppend",async(d,m,v,I,x=null)=>this._promise("outputFilesAppend",d,m,v,I,x));P(this,"outputFilesDelete",async(d,m,v)=>this._promise("outputFilesDelete",d,m,v));this._register("diskStorage")}}});var $o=Ze((Yh,Ho)=>{var mh=Pt();Ho.exports=class extends mh{constructor(){super();P(this,"getAt",(d,m)=>this._promise("getAt",d,m));P(this,"create",(d,m,v)=>this._promise("create",d,m,v));P(this,"readAll",(d,m)=>this._promise("readAll",d,m));P(this,"read",(d,m)=>this._promise("read",d,m));P(this,"updateName",(d,m,v)=>this._promise("updateName",d,m,v));P(this,"updateInfo",(d,m,v)=>this._promise("updateInfo",d,m,v));P(this,"updateReady",(d,m,v)=>this._promise("updateReady",d,m,v));P(this,"updateEnabled",(d,m,v)=>this._promise("updateEnabled",d,m,v));P(this,"delete",(d,m=null,v=null)=>this._promise("delete",d,m,v));this._register("session")}}});var jo=Ze((ef,qo)=>{var ph=Pt();qo.exports=class extends ph{constructor(){super();P(this,"install",()=>this._promise("install"));P(this,"check",()=>this._promise("check"));this._register("updater")}}});var Ko=Ze((sf,Qo)=>{var gh=Pt();Qo.exports=class extends gh{constructor(){super();P(this,"getOS",()=>this._promise("getOS"));P(this,"getName",()=>this._promise("getName"));P(this,"getUUID",()=>this._promise("getUUID"));P(this,"getSerialNumber",()=>this._promise("getSerialNumber"));P(this,"getRam",()=>this._promise("getRam"));P(this,"getCpuArch",()=>this._promise("getCpuArch"));P(this,"getCpuName",()=>this._promise("getCpuName"));P(this,"setPostAuth",d=>this._promise("setPostAuth",!!d));P(this,"getPostAuth",()=>this._promise("getPostAuth"));P(this,"showFileInFolder",d=>this._promise("showFileInFolder",d));P(this,"request",(d,m="GET",v={},I={},x=!0,R=60,W=!0)=>this._promise("request",d,m,v,I,x,R,W));this._register("device")}}});var Xo=Ze((of,Go)=>{var wh=Pt();Go.exports=class extends wh{constructor(){super();P(this,"list",()=>this._promise("list"));P(this,"closeAll",()=>this._promise("closeAll"));P(this,"open",d=>this._promise("open",d));P(this,"close",d=>this._promise("close",d));P(this,"webContents",(d,m,v)=>this._promise("webContents",d,m,v));this._register("source")}}});var Zo=Ze((uf,Yo)=>{var bh=Pt();Yo.exports=class extends bh{constructor(){super();P(this,"list",()=>this._promise("list"));P(this,"removeAll",()=>this._promise("removeAll"));P(this,"add",(d,m,v=!1)=>this._promise("add",d,m,v));P(this,"remove",d=>this._promise("remove",d));P(this,"select",d=>this._promise("select",d));P(this,"getSelected",()=>this._promise("getSelected"));P(this,"setControlled",(d,m=!0)=>this._promise("setControlled",d,m));P(this,"openDevTools",(d,m=null)=>this._promise("openDevTools",d,m));P(this,"getBounds",d=>this._promise("getBounds",d));P(this,"mouse",(d,m,v,I=null,x=!1,R=[])=>this._promise("mouse",d,m,v,I,x,R));P(this,"typeAt",(d,m,v,I,x=!1,R=5)=>this._promise("typeAt",d,m,v,I,x,R));P(this,"loadUrl",(d,m)=>this._promise("loadUrl",d,m));P(this,"getUrl",d=>this._promise("getUrl",d));P(this,"getTitle",d=>this._promise("getTitle",d));P(this,"reload",(d,m=!1)=>this._promise("reload",d,m));P(this,"goHome",d=>this._promise("goHome",d));P(this,"goBack",d=>this._promise("goBack",d));P(this,"goForward",d=>this._promise("goForward",d));P(this,"setFileInput",(d,m,v)=>this._promise("setFileInput",d,m,v));P(this,"openInNewWindow",(d,m)=>this._promise("openInNewWindow",d,m));P(this,"waitForDomReady",(d,m=30)=>this._promise("waitForDomReady",d,m));P(this,"saveDownload",(d,m,v,I=600,x=null)=>this._promise("saveDownload",d,m,v,I,x));P(this,"saveScreenshot",(d,m,v,I=null)=>this._promise("saveScreenshot",d,m,v,I));P(this,"getScreenshotData",(d,m=null,v=null)=>this._promise("getScreenshotData",d,m,v));P(this,"webContents",(d,m,v=[],I=null,x=[])=>this._promise("webContents",d,m,v,I,x));P(this,"sendKeys",(d,m,v={})=>this._promise("sendKeys",d,m,v));this._register("target")}}});var ec=Ze((ff,Jo)=>{var yh=Pt();Jo.exports=class extends yh{constructor(){super();P(this,"openExternal",d=>this._promise("openExternal","".concat(d)));this._register("main/login")}}});var rc=Ze((gf,tc)=>{var kh=Pt(),Th=ec();tc.exports=class extends kh{constructor(){super();P(this,"login",null);P(this,"focus",()=>this._promise("focus"));P(this,"setOnTop",(d=!0)=>this._promise("setOnTop",!!d));P(this,"getOnTop",()=>this._promise("getOnTop"));P(this,"setDarkMode",d=>this._promise("setDarkMode",!!d));P(this,"getDarkMode",()=>this._promise("getDarkMode"));P(this,"getProcessVersions",()=>this._promise("getProcessVersions"));P(this,"quit",()=>this._promise("quit"));P(this,"openExternal",d=>this._promise("openExternal","".concat(d)));P(this,"showOpenDialog",(d,m=[],v=!1)=>this._promise("showOpenDialog",d,m,v));this._register("main"),this.login=new Th}}});var sc=Ze((yf,ic)=>{var Sh=Pt();ic.exports=class extends Sh{constructor(){super();P(this,"install",d=>this._promise("install",d));P(this,"getPort",()=>this._promise("getPort"));this._register("llm")}}});var oc=Ze((Sf,ac)=>{var{ipcRenderer:Wi,contextBridge:vh}=require("electron"),Ch=Wo(),_h=$o(),xh=jo(),Ih=Ko(),Ph=Xo(),Eh=Zo(),Ah=rc(),Bh=sc(),Lt=fn(),ct,Nr,et,Or,nc;ac.exports=(nc=class{constructor(y,d=!0){ge(this,ct,"");ge(this,Nr,{});ge(this,et,{});ge(this,Or,{});P(this,"source",{send:(y,d,m)=>{this.send(Lt.getSourceChannelName(y),d,m)},invoke:async(y,d,m,v=0)=>await this.invoke(Lt.getSourceChannelName(y),d,m,v)});P(this,"target",{send:(y,d,m)=>{(async()=>this.send(Lt.getTargetChannelName(y),d,m))()},invoke:async(y,d,m,v=0)=>await this.invoke(Lt.getTargetChannelName(y),d,m,v)});let m=this;Je(this,ct,y),Je(this,Or,{ibc:{handle:(...v)=>this.handle.call(this,...v),send:(...v)=>this.send.call(this,...v),invoke:async(...v)=>await this.invoke.call(this,...v),source:{send:(...v)=>this.source.send.call(this,...v),invoke:async(...v)=>await this.source.invoke.call(this,...v)},target:{send:(...v)=>this.target.send.call(this,...v),invoke:async(...v)=>await this.target.invoke.call(this,...v)},winName:w(this,ct)},ipc:{diskStorage:new Ch,session:new _h,updater:new xh,device:new Ih,source:new Ph,target:new Eh,main:new Ah,llm:new Bh},devMode:!1}),Wi.on(w(this,ct),(v,I)=>{if(I[0]==="ibc-target:cancel-promises"&&typeof I[1]=="string"){for(let pe of Object.keys(w(this,et)))if(w(this,et)[pe].toWinName===Lt.getTargetChannelName(I[1])){try{typeof I[2]=="string"?w(this,et)[pe].reject(new Error(I[2])):w(this,et)[pe].resolve(null)}catch{}delete w(m,et)[pe]}return}if(I.length<3)return;let[x,R,W]=I,{type:X,fromWin:Pe,promiseId:ve}=W??{};if(X==="req")(async()=>{let pe=null;try{if(typeof x!="string"||typeof w(m,Nr)[x]!="function")throw new Error('Inter-Browser Communication: handle "'.concat(x,'" not declared yet'));Array.isArray(R)||(R=[]),pe=await w(m,Nr)[x](...R)}catch(h){let ut=w(m,ct).indexOf(Lt.WINDOW_TARGET)===0?"ibc.target.invoke":w(m,ct).indexOf(Lt.WINDOW_SOURCE)===0?"ibc.source.invoke":w(m,ct);pe=new Error("".concat(ut,"(").concat(JSON.stringify(x),") ").concat(h.message??h)),w(m,ct).indexOf(Lt.WINDOW_TARGET)===0&&console.warn("".concat(x,"() ").concat(h.message??h))}typeof Pe=="string"&&typeof ve=="string"&&Wi.send(Pe,x,pe,{type:"res",promiseId:ve})})();else{let pe=typeof ve=="string"?"".concat(x,":").concat(ve):null;if(pe!==null){let h=w(m,et)[pe]??null;h!==null&&(R instanceof Error?h.reject(R):h.resolve(R),delete w(m,et)[pe])}}}),d&&vh.exposeInMainWorld("sdk",w(this,Or))}getSdk(){return w(this,Or)}handle(y,d){typeof y=="string"&&typeof d=="function"&&(w(this,Nr)[y]=d)}send(y,d,m){do{if(typeof y!="string"||typeof d!="string")break;Array.isArray(m)||(m=[]),Wi.send(y,d,m,{type:"req",fromWin:w(this,ct)})}while(!1)}async invoke(y,d,m,v=0){let I=this;if(typeof y!="string"||typeof d!="string")return null;Array.isArray(m)||(m=[]),v=parseInt(v,10),(!Number.isInteger(v)||v<0)&&(v=0);let x=Lt.generateKey(),R=new Promise((W,X)=>{w(this,et)["".concat(d,":").concat(x)]={resolve:W,reject:X,toWinName:y}});return v>0&&setTimeout(()=>{let W=typeof x=="string"?"".concat(d,":").concat(x):null;if(typeof w(I,et)[W]<"u"){try{w(I,et)[W].reject(new Error("".concat(d,"() timed out")))}catch{}delete w(I,et)[W]}},v*1e3),Wi.send(y,d,m,{type:"req",fromWin:w(this,ct),promiseId:x}),R}},ct=new WeakMap,Nr=new WeakMap,et=new WeakMap,Or=new WeakMap,nc)});var uc=Ze((Cf,Hi)=>{"use strict";var Mh=(()=>{var J=Object.create,y=Object.defineProperty,d=Object.getOwnPropertyDescriptor,m=Object.getOwnPropertyNames,v=Object.getPrototypeOf,I=Object.prototype.hasOwnProperty,x=(e,t)=>function(){return t||(0,e[m(e)[0]])((t={exports:{}}).exports,t),t.exports},R=(e,t)=>{for(var r in t)y(e,r,{get:t[r],enumerable:!0})},W=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of m(t))!I.call(e,s)&&s!==r&&y(e,s,{get:()=>t[s],enumerable:!(i=d(t,s))||i.enumerable});return e},X=(e,t,r)=>(r=e!=null?J(v(e)):{},W(t||!e||!e.__esModule?y(r,"default",{value:e,enumerable:!0}):r,e)),Pe=e=>W(y({},"__esModule",{value:!0}),e),ve=x({"(disabled):src/node"(){}}),pe={};R(pe,{ADTS:()=>qa,ALL_FORMATS:()=>Ql,ALL_TRACK_TYPES:()=>Bo,AUDIO_CODECS:()=>Qe,AdtsInputFormat:()=>Na,AdtsOutputFormat:()=>Ld,AttachedFile:()=>wi,AudioBufferSink:()=>ul,AudioBufferSource:()=>Jd,AudioSample:()=>St,AudioSampleSink:()=>xi,AudioSampleSource:()=>rn,AudioSource:()=>Rr,BaseMediaSampleSink:()=>cs,BlobSource:()=>Xl,BufferSource:()=>Gl,BufferTarget:()=>bo,CanvasSink:()=>ea,CanvasSource:()=>Yd,Conversion:()=>ah,CustomAudioDecoder:()=>Xn,CustomAudioEncoder:()=>Zn,CustomVideoDecoder:()=>Gn,CustomVideoEncoder:()=>Yn,EncodedAudioPacketSource:()=>Ao,EncodedPacket:()=>Ce,EncodedPacketSink:()=>Cr,EncodedVideoPacketSource:()=>Eo,FLAC:()=>ja,FilePathSource:()=>Jl,FilePathTarget:()=>vd,FlacInputFormat:()=>Da,FlacOutputFormat:()=>Vd,Input:()=>Xa,InputAudioTrack:()=>dt,InputDisposedError:()=>Ke,InputFormat:()=>Rt,InputTrack:()=>Ii,InputVideoTrack:()=>_r,IsobmffInputFormat:()=>Ps,IsobmffOutputFormat:()=>Hs,MATROSKA:()=>La,MP3:()=>Wa,MP4:()=>Oa,MatroskaInputFormat:()=>Es,MediaSource:()=>Vi,MediaStreamAudioTrackSource:()=>eh,MediaStreamVideoTrackSource:()=>Zd,MkvOutputFormat:()=>js,MovOutputFormat:()=>qs,Mp3InputFormat:()=>Fa,Mp3OutputFormat:()=>Nd,Mp4InputFormat:()=>Aa,Mp4OutputFormat:()=>$s,NON_PCM_AUDIO_CODECS:()=>nr,NullTarget:()=>ko,OGG:()=>$a,OggInputFormat:()=>Ra,OggOutputFormat:()=>Ud,Output:()=>cn,OutputFormat:()=>Nt,PCM_AUDIO_CODECS:()=>ze,QTFF:()=>Ua,QUALITY_HIGH:()=>Zs,QUALITY_LOW:()=>Hd,QUALITY_MEDIUM:()=>$d,QUALITY_VERY_HIGH:()=>qd,QUALITY_VERY_LOW:()=>Wd,Quality:()=>Xe,QuickTimeInputFormat:()=>Ba,ReadableStreamSource:()=>eu,RichImageData:()=>sr,SUBTITLE_CODECS:()=>kt,Source:()=>Kt,StreamSource:()=>Ga,StreamTarget:()=>yo,SubtitleSource:()=>an,Target:()=>Fr,TextSubtitleSource:()=>nh,UrlSource:()=>Zl,VIDEO_CODECS:()=>qe,VideoSample:()=>it,VideoSampleSink:()=>_i,VideoSampleSource:()=>en,VideoSource:()=>zr,WAVE:()=>Ha,WEBM:()=>Va,WavOutputFormat:()=>Od,WaveInputFormat:()=>za,WebMInputFormat:()=>Ma,WebMOutputFormat:()=>Qs,canEncode:()=>jd,canEncodeAudio:()=>Oi,canEncodeSubtitles:()=>Ui,canEncodeVideo:()=>Ni,getEncodableAudioCodecs:()=>Li,getEncodableCodecs:()=>Qd,getEncodableSubtitleCodecs:()=>Io,getEncodableVideoCodecs:()=>xo,getFirstEncodableAudioCodec:()=>Kd,getFirstEncodableSubtitleCodec:()=>Gd,getFirstEncodableVideoCodec:()=>Po,registerDecoder:()=>Zc,registerEncoder:()=>Jc});function h(e){if(!e)throw new Error("Assertion failed.")}var ut=e=>{let t=(e%360+360)%360;if(t===0||t===90||t===180||t===270)return t;throw new Error("Invalid rotation ".concat(e,"."))},se=e=>e&&e[e.length-1],Re=e=>e>=0&&e<2**32,he=class cc{constructor(t){this.bytes=t,this.pos=0}seekToByte(t){this.pos=8*t}readBit(){let t=Math.floor(this.pos/8),r=this.bytes[t]??0,i=7-(this.pos&7),s=(r&1<<i)>>i;return this.pos++,s}readBits(t){if(t===1)return this.readBit();let r=0;for(let i=0;i<t;i++)r<<=1,r|=this.readBit();return r}writeBits(t,r){let i=this.pos+t;for(let s=this.pos;s<i;s++){let n=Math.floor(s/8),a=this.bytes[n],o=7-(s&7);a&=~(1<<o),a|=(r&1<<i-s-1)>>i-s-1<<o,this.bytes[n]=a}this.pos=i}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let t=this.pos/8,r=this.bytes[t]??0;return this.pos+=8,r}skipBits(t){this.pos+=t}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let t=new cc(this.bytes);return t.pos=this.pos,t}},H=e=>{let t=0;for(;e.readBits(1)===0&&t<32;)t++;if(t>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<t)-1+e.readBits(t)},xe=e=>{let t=H(e);return(t&1)===0?-(t>>1):t+1>>1},tr=(e,t,r,i)=>{for(let s=t;s<r;s++){let n=Math.floor(s/8),a=e[n],o=7-(s&7);a&=~(1<<o),a|=(i&1<<r-s-1)>>r-s-1<<o,e[n]=a}},ne=e=>e.constructor===Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength),oe=e=>e.constructor===DataView?e:e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),Me=new TextDecoder,we=new TextEncoder,Fe=e=>{for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0},rr=e=>Object.fromEntries(Object.entries(e).map(([t,r])=>[r,t])),tt={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},ir=rr(tt),Vt={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},Vr=rr(Vt),At={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Wr=rr(At),di=e=>!!e&&!!e.primaries&&!!e.transfer&&!!e.matrix&&e.fullRange!==void 0,hi=e=>e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e),wr=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e,t=new Promise(i=>{e=i}),r=this.currentPromise;return this.currentPromise=t,await r,e}},gn=e=>[...e].map(t=>t.toString(16).padStart(2,"0")).join(""),wn=e=>(e=e>>1&1431655765|(e&1431655765)<<1,e=e>>2&858993459|(e&858993459)<<2,e=e>>4&252645135|(e&252645135)<<4,e=e>>8&16711935|(e&16711935)<<8,e=e>>16&65535|(e&65535)<<16,e>>>0),ji=(e,t,r)=>{let i=0,s=e.length-1,n=-1;for(;i<=s;){let a=i+s>>1,o=r(e[a]);o===t?(n=a,s=a-1):o<t?i=a+1:s=a-1}return n},be=(e,t,r)=>{let i=0,s=e.length-1,n=-1;for(;i<=s;){let a=i+(s-i+1)/2|0;r(e[a])<=t?(n=a,i=a+1):s=a-1}return n},bn=(e,t,r)=>{let i=be(e,r(t),r);e.splice(i+1,0,t)},Ie=()=>{let e,t;return{promise:new Promise((i,s)=>{e=i,t=s}),resolve:e,reject:t}},yn=(e,t)=>{for(let r=e.length-1;r>=0;r--)if(t(e[r]))return e[r]},kn=(e,t)=>{for(let r=e.length-1;r>=0;r--)if(t(e[r]))return r;return-1},gc=async function*(e){Symbol.iterator in e?yield*e[Symbol.iterator]():yield*e[Symbol.asyncIterator]()},wc=e=>{if(!(Symbol.iterator in e)&&!(Symbol.asyncIterator in e))throw new TypeError("Argument must be an iterable or async iterable.")},$e=e=>{throw new Error("Unexpected value: ".concat(e))},fi=(e,t,r)=>{let i=e.getUint8(t),s=e.getUint8(t+1),n=e.getUint8(t+2);return r?i|s<<8|n<<16:i<<16|s<<8|n},bc=(e,t,r)=>fi(e,t,r)<<8>>8,Tn=(e,t,r,i)=>{r=r>>>0,r=r&16777215,i?(e.setUint8(t,r&255),e.setUint8(t+1,r>>>8&255),e.setUint8(t+2,r>>>16&255)):(e.setUint8(t,r>>>16&255),e.setUint8(t+1,r>>>8&255),e.setUint8(t+2,r&255))},yc=(e,t,r,i)=>{r=Ne(r,-8388608,8388607),r<0&&(r=r+16777216&16777215),Tn(e,t,r,i)},kc=(e,t,r,i)=>{i?(e.setUint32(t+0,r,!0),e.setInt32(t+4,Math.floor(r/2**32),!0)):(e.setInt32(t+0,Math.floor(r/2**32),!0),e.setUint32(t+4,r,!0))},mi=(e,t)=>({async next(){let r=await e.next();return r.done?{value:void 0,done:!0}:{value:t(r.value),done:!1}},return(){return e.return()},throw(r){return e.throw(r)},[Symbol.asyncIterator](){return this}}),Ne=(e,t,r)=>Math.max(t,Math.min(r,e)),rt="und",pi=(e,t)=>{let r=10**t;return Math.round(e*r)/r},Qi=(e,t)=>Math.round(e/t)*t,Tc=e=>{let t=0;for(;e;)t++,e>>=1;return t},Sc=/^[a-z]{3}$/,Hr=e=>Sc.test(e),Wt=1e6*(1+Number.EPSILON),Sn=(e,t)=>{let r={...e,...t};if(e.headers||t.headers){let i=e.headers?vn(e.headers):{},s=t.headers?vn(t.headers):{},n={...i};Object.entries(s).forEach(([a,o])=>{let c=Object.keys(n).find(l=>l.toLowerCase()===a.toLowerCase());c&&delete n[c],n[a]=o}),r.headers=n}return r},vn=e=>{if(e instanceof Headers){let t={};return e.forEach((r,i)=>{t[i]=r}),t}if(Array.isArray(e)){let t={};return e.forEach(([r,i])=>{t[r]=i}),t}return e},Cn=async(e,t,r,i)=>{let s=0;for(;;)try{return await e(t,r)}catch(n){s++;let a=i(s,n,t);if(a===null)throw n;if(console.error("Retrying failed fetch. Error:",n),!Number.isFinite(a)||a<0)throw new TypeError("Retry delay must be a non-negative finite number.");a>0&&await new Promise(o=>setTimeout(o,1e3*a))}},vc=(e,t)=>{let r=e<0?-1:1;e=Math.abs(e);let i=0,s=1,n=1,a=0,o=e;for(;;){let c=Math.floor(o),l=c*n+i,u=c*a+s;if(u>t)return{numerator:r*n,denominator:a};if(i=n,s=a,n=l,a=u,o=1/(o-c),!isFinite(o))break}return{numerator:r*n,denominator:a}},gi=class{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}},Ki=null,Gi=()=>{if(Ki!==null)return Ki;let e=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return Ki=e,e},Xi=null,$r=()=>Xi!==null?Xi:Xi=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox"),br=(e,t)=>e!==-1?e:t,Yi=(e,t,r,i)=>e<=i&&r<=t,yr=function*(e){for(let t in e){let r=e[t];r!==void 0&&(yield{key:t,value:r})}},Cc=e=>{switch(e.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},_c=e=>{let t=atob(e),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r},xc=e=>{let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)},Ic=(e,t)=>{if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0},_n=()=>{Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose"))},kr=e=>typeof e=="number"&&!Number.isNaN(e),sr=class{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof t!="string")throw new TypeError("mimeType must be a string.")}},wi=class{constructor(e,t,r,i){if(this.data=e,this.mimeType=t,this.name=r,this.description=i,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!==void 0&&typeof t!="string")throw new TypeError("mimeType, when provided, must be a string.");if(r!==void 0&&typeof r!="string")throw new TypeError("name, when provided, must be a string.");if(i!==void 0&&typeof i!="string")throw new TypeError("description, when provided, must be a string.")}},Zi=e=>{if(!e||typeof e!="object")throw new TypeError("tags must be an object.");if(e.title!==void 0&&typeof e.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(e.description!==void 0&&typeof e.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(e.artist!==void 0&&typeof e.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(e.album!==void 0&&typeof e.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(e.albumArtist!==void 0&&typeof e.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(e.trackNumber!==void 0&&(!Number.isInteger(e.trackNumber)||e.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(e.tracksTotal!==void 0&&(!Number.isInteger(e.tracksTotal)||e.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(e.discNumber!==void 0&&(!Number.isInteger(e.discNumber)||e.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(e.discsTotal!==void 0&&(!Number.isInteger(e.discsTotal)||e.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(e.genre!==void 0&&typeof e.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(e.date!==void 0&&(!(e.date instanceof Date)||Number.isNaN(e.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(e.lyrics!==void 0&&typeof e.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(e.images!==void 0){if(!Array.isArray(e.images))throw new TypeError("tags.images, when provided, must be an array.");for(let t of e.images){if(!t||typeof t!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(t.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof t.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(t.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(e.comment!==void 0&&typeof e.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(e.raw!==void 0){if(!e.raw||typeof e.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(let t of Object.values(e.raw))if(t!==null&&typeof t!="string"&&!(t instanceof Uint8Array)&&!(t instanceof sr)&&!(t instanceof wi))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}},bi=e=>e.title===void 0&&e.description===void 0&&e.artist===void 0&&e.album===void 0&&e.albumArtist===void 0&&e.trackNumber===void 0&&e.tracksTotal===void 0&&e.discNumber===void 0&&e.discsTotal===void 0&&e.genre===void 0&&e.date===void 0&&e.lyrics===void 0&&(!e.images||e.images.length===0)&&e.comment===void 0&&(e.raw===void 0||Object.keys(e.raw).length===0),qe=["avc","hevc","vp9","av1","vp8"],ze=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],nr=["aac","opus","mp3","vorbis","flac"],Qe=[...nr,...ze],kt=["webvtt"],xn=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],In=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Ht=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],Pn=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],En=".01.01.01.01.00",An=".0.110.01.01.01.0",Pc=(e,t,r,i)=>{if(e==="avc"){let n=Math.ceil(t/16)*Math.ceil(r/16),a=xn.find(f=>n<=f.maxMacroblocks&&i<=f.maxBitrate)??se(xn),o=a?a.level:0,c="64".padStart(2,"0"),l="00",u=o.toString(16).padStart(2,"0");return"avc1.".concat(c).concat(l).concat(u)}else if(e==="hevc"){let o=t*r,c=In.find(u=>o<=u.maxPictureSize&&i<=u.maxBitrate)??se(In);return"hev1.1.6.".concat(c.tier).concat(c.level,".").concat("B0")}else{if(e==="vp8")return"vp8";if(e==="vp9"){let n=t*r,a=Ht.find(c=>n<=c.maxPictureSize&&i<=c.maxBitrate)??se(Ht);return"vp09.00.".concat(a.level.toString().padStart(2,"0"),".").concat("08")}else if(e==="av1"){let n=t*r,a=Pn.find(l=>n<=l.maxPictureSize&&i<=l.maxBitrate)??se(Pn),o=a.level.toString().padStart(2,"0");return"av01.0.".concat(o).concat(a.tier,".").concat("08")}}throw new TypeError("Unhandled codec '".concat(e,"'."))},Ec=e=>{let t=e.split("."),r=Number(t[1]),i=Number(t[2]),s=Number(t[3]),n=t[4]?Number(t[4]):1;return[1,1,r,2,1,i,3,1,s,4,1,n]},Bn=e=>{let t=e.split("."),s=(1<<7)+1,n=Number(t[1]),a=t[2],o=Number(a.slice(0,-1)),c=(n<<5)+o,l=a.slice(-1)==="H"?1:0,f=Number(t[3])===8?0:1,p=0,k=t[4]?Number(t[4]):0,T=t[5]?Number(t[5][0]):1,b=t[5]?Number(t[5][1]):1,C=t[5]?Number(t[5][2]):0,S=(l<<7)+(f<<6)+(p<<5)+(k<<4)+(T<<3)+(b<<2)+C;return[s,c,S,0]},Mn=e=>{let{codec:t,codecDescription:r,colorSpace:i,avcCodecInfo:s,hevcCodecInfo:n,vp9CodecInfo:a,av1CodecInfo:o}=e;if(t==="avc"){if(s){let c=new Uint8Array([s.avcProfileIndication,s.profileCompatibility,s.avcLevelIndication]);return"avc1.".concat(gn(c))}if(!r||r.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return"avc1.".concat(gn(r.subarray(1,4)))}else if(t==="hevc"){let c,l,u,f,p,k;if(n)c=n.generalProfileSpace,l=n.generalProfileIdc,u=wn(n.generalProfileCompatibilityFlags),f=n.generalTierFlag,p=n.generalLevelIdc,k=[...n.generalConstraintIndicatorFlags];else{if(!r||r.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let b=oe(r),C=b.getUint8(1);c=C>>6&3,l=C&31,u=wn(b.getUint32(2)),f=C>>5&1,p=b.getUint8(12),k=[];for(let S=0;S<6;S++)k.push(b.getUint8(6+S))}let T="hev1.";for(T+=["","A","B","C"][c]+l,T+=".",T+=u.toString(16).toUpperCase(),T+=".",T+=f===0?"L":"H",T+=p;k.length>0&&k[k.length-1]===0;)k.pop();return k.length>0&&(T+=".",T+=k.map(b=>b.toString(16).toUpperCase()).join(".")),T}else{if(t==="vp8")return"vp8";if(t==="vp9"){if(!a){let S=e.width*e.height,_=se(Ht).level;for(let E of Ht)if(S<=E.maxPictureSize){_=E.level;break}return"vp09.00.".concat(_.toString().padStart(2,"0"),".08")}let c=a.profile.toString().padStart(2,"0"),l=a.level.toString().padStart(2,"0"),u=a.bitDepth.toString().padStart(2,"0"),f=a.chromaSubsampling.toString().padStart(2,"0"),p=a.colourPrimaries.toString().padStart(2,"0"),k=a.transferCharacteristics.toString().padStart(2,"0"),T=a.matrixCoefficients.toString().padStart(2,"0"),b=a.videoFullRangeFlag.toString().padStart(2,"0"),C="vp09.".concat(c,".").concat(l,".").concat(u,".").concat(f);return C+=".".concat(p,".").concat(k,".").concat(T,".").concat(b),C.endsWith(En)&&(C=C.slice(0,-En.length)),C}else if(t==="av1"){if(!o){let E=e.width*e.height,A=se(Ht).level;for(let F of Ht)if(E<=F.maxPictureSize){A=F.level;break}return"av01.0.".concat(A.toString().padStart(2,"0"),"M.08")}let c=o.profile,l=o.level.toString().padStart(2,"0"),u=o.tier?"H":"M",f=o.bitDepth.toString().padStart(2,"0"),p=o.monochrome?"1":"0",k=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),T=i?.primaries?tt[i.primaries]:1,b=i?.transfer?Vt[i.transfer]:1,C=i?.matrix?At[i.matrix]:1,S=i?.fullRange?1:0,_="av01.".concat(c,".").concat(l).concat(u,".").concat(f);return _+=".".concat(p,".").concat(k.toString().padStart(3,"0")),_+=".".concat(T.toString().padStart(2,"0")),_+=".".concat(b.toString().padStart(2,"0")),_+=".".concat(C.toString().padStart(2,"0")),_+=".".concat(S),_.endsWith(An)&&(_=_.slice(0,-An.length)),_}}throw new TypeError("Unhandled codec '".concat(t,"'."))},Ac=(e,t,r)=>{if(e==="aac")return t>=2&&r<=24e3?"mp4a.40.29":r<=24e3?"mp4a.40.5":"mp4a.40.2";if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(ze.includes(e))return e;throw new TypeError("Unhandled codec '".concat(e,"'."))},Fn=e=>{let{codec:t,codecDescription:r,aacCodecInfo:i}=e;if(t==="aac"){if(!i)throw new TypeError("AAC codec info must be provided.");if(i.isMpeg2)return"mp4a.67";{let s=Ji(r);return"mp4a.40.".concat(s.objectType)}}else{if(t==="mp3")return"mp3";if(t==="opus")return"opus";if(t==="vorbis")return"vorbis";if(t==="flac")return"flac";if(t&&ze.includes(t))return t}throw new TypeError("Unhandled codec '".concat(t,"'."))},yi=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],zn=[-1,1,2,3,4,5,6,8],Ji=e=>{if(!e||e.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let t=new he(e),r=t.readBits(5);r===31&&(r=32+t.readBits(6));let i=t.readBits(4),s=null;i===15?s=t.readBits(24):i<yi.length&&(s=yi[i]);let n=t.readBits(4),a=null;return n>=1&&n<=7&&(a=zn[n]),{objectType:r,frequencyIndex:i,sampleRate:s,channelConfiguration:n,numberOfChannels:a}},Tr=48e3,Rn=/^pcm-([usf])(\d+)+(be)?$/,Tt=e=>{if(h(ze.includes(e)),e==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(e==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let t=Rn.exec(e);h(t);let r;t[1]==="u"?r="unsigned":t[1]==="s"?r="signed":r="float";let i=Number(t[2])/8,s=t[3]!=="be",n=e==="pcm-u8"?2**7:0;return{dataType:r,sampleSize:i,littleEndian:s,silentValue:n}},Dn=e=>e.startsWith("avc1")||e.startsWith("avc3")?"avc":e.startsWith("hev1")||e.startsWith("hvc1")?"hevc":e==="vp8"?"vp8":e.startsWith("vp09")?"vp9":e.startsWith("av01")?"av1":e.startsWith("mp4a.40")||e==="mp4a.67"?"aac":e==="mp3"||e==="mp4a.69"||e==="mp4a.6B"||e==="mp4a.6b"?"mp3":e==="opus"?"opus":e==="vorbis"?"vorbis":e==="flac"?"flac":e==="ulaw"?"ulaw":e==="alaw"?"alaw":Rn.test(e)?e:e==="webvtt"?"webvtt":null,Bc=e=>e==="avc"?{avc:{format:"avc"}}:e==="hevc"?{hevc:{format:"hevc"}}:{},Mc=e=>e==="aac"?{aac:{format:"aac"}}:e==="opus"?{opus:{format:"opus"}}:{},Fc=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],zc=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,Rc=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,Dc=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Nc=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,Nn=e=>{if(!e)throw new TypeError("Video chunk metadata must be provided.");if(typeof e!="object")throw new TypeError("Video chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof e.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof e.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Fc.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.codedWidth)||e.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(e.decoderConfig.codedHeight)||e.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(e.decoderConfig.description!==void 0&&!hi(e.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.colorSpace!==void 0){let{colorSpace:t}=e.decoderConfig;if(typeof t!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let r=Object.keys(tt);if(t.primaries!=null&&!r.includes(t.primaries))throw new TypeError("Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ".concat(r.join(", "),"."));let i=Object.keys(Vt);if(t.transfer!=null&&!i.includes(t.transfer))throw new TypeError("Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ".concat(i.join(", "),"."));let s=Object.keys(At);if(t.matrix!=null&&!s.includes(t.matrix))throw new TypeError("Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ".concat(s.join(", "),"."));if(t.fullRange!=null&&typeof t.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(e.decoderConfig.codec.startsWith("avc1")||e.decoderConfig.codec.startsWith("avc3")){if(!zc.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(e.decoderConfig.codec.startsWith("hev1")||e.decoderConfig.codec.startsWith("hvc1")){if(!Rc.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(e.decoderConfig.codec.startsWith("vp8")){if(e.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(e.decoderConfig.codec.startsWith("vp09")){if(!Dc.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(e.decoderConfig.codec.startsWith("av01")&&!Nc.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Oc=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],Sr=e=>{if(!e)throw new TypeError("Audio chunk metadata must be provided.");if(typeof e!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof e.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof e.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Oc.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.sampleRate)||e.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(e.decoderConfig.numberOfChannels)||e.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(e.decoderConfig.description!==void 0&&!hi(e.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.codec.startsWith("mp4a")&&e.decoderConfig.codec!=="mp4a.69"&&e.decoderConfig.codec!=="mp4a.6B"&&e.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(e.decoderConfig.codec.startsWith("mp3")||e.decoderConfig.codec.startsWith("mp4a")){if(e.decoderConfig.codec!=="mp3"&&e.decoderConfig.codec!=="mp4a.69"&&e.decoderConfig.codec!=="mp4a.6B"&&e.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(e.decoderConfig.codec.startsWith("opus")){if(e.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(e.decoderConfig.description&&e.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(e.decoderConfig.codec.startsWith("vorbis")){if(e.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(e.decoderConfig.codec.startsWith("flac")){if(e.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!e.decoderConfig.description||e.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((e.decoderConfig.codec.startsWith("pcm")||e.decoderConfig.codec.startsWith("ulaw")||e.decoderConfig.codec.startsWith("alaw"))&&!ze.includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (".concat(ze.join(", "),")."))},On=e=>{if(!e)throw new TypeError("Subtitle metadata must be provided.");if(typeof e!="object")throw new TypeError("Subtitle metadata must be an object.");if(!e.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof e.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof e.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")},ar=class{constructor(e){this.mutex=new wr,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,r){t+=e.source._timestampOffset;let i=this.trackTimestampInfo.get(e);if(!i){if(!r)throw new Error("First frame must be a key frame.");i={maxTimestamp:t,maxTimestampBeforeLastKeyFrame:t},this.trackTimestampInfo.set(e,i)}if(t<0)throw new Error("Timestamps must be non-negative (got ".concat(t,"s)."));if(r&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),t<i.maxTimestampBeforeLastKeyFrame)throw new Error("Timestamps cannot be smaller than the highest timestamp of the previous GOP (a GOP begins with a key frame and ends right before the next key frame). Got ".concat(t,"s, but highest timestamp is ").concat(i.maxTimestampBeforeLastKeyFrame,"s."));return i.maxTimestamp=Math.max(i.maxTimestamp,t),t}},Uc=class extends ar{constructor(e,t){super(e),this.header=new Uint8Array(7),this.headerBitstream=new he(this.header),this.audioSpecificConfig=null,this.format=t,this.writer=e._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),!this.audioSpecificConfig){Sr(r);let a=r?.decoderConfig?.description;h(a),this.audioSpecificConfig=Ji(ne(a));let{objectType:o,frequencyIndex:c,channelConfiguration:l}=this.audioSpecificConfig,u=o-1;this.headerBitstream.writeBits(12,4095),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(2,0),this.headerBitstream.writeBits(1,1),this.headerBitstream.writeBits(2,u),this.headerBitstream.writeBits(4,c),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(3,l),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.skipBits(13),this.headerBitstream.writeBits(11,2047),this.headerBitstream.writeBits(2,0)}let s=t.data.byteLength+this.header.byteLength;this.headerBitstream.pos=30,this.headerBitstream.writeBits(13,s);let n=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(t.data),this.format._options.onFrame){let a=new Uint8Array(s);a.set(this.header,0),a.set(t.data,this.header.byteLength),this.format._options.onFrame(a,n)}await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}},qr=e=>{let t=[],r=0;for(;r<e.length;){let i=-1,s=0;for(let n=r;n<e.length-3;n++){if(e[n]===0&&e[n+1]===0&&e[n+2]===1){i=n,s=3;break}if(n<e.length-4&&e[n]===0&&e[n+1]===0&&e[n+2]===0&&e[n+3]===1){i=n,s=4;break}}if(i===-1)break;if(r>0&&i>r){let n=e.subarray(r,i);n.length>0&&t.push(n)}r=i+s}if(r<e.length){let i=e.subarray(r);i.length>0&&t.push(i)}return t},Un=(e,t)=>{let r=[],i=0,s=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;i+t<=e.length;){let n;t===1?n=s.getUint8(i):t===2?n=s.getUint16(i,!1):t===3?n=fi(s,i,!1):t===4?n=s.getUint32(i,!1):($e(t),h(!1)),i+=t;let a=e.subarray(i,i+n);r.push(a),i+=n}return r},es=e=>{let t=[],r=e.length;for(let i=0;i<r;i++)i+2<r&&e[i]===0&&e[i+1]===0&&e[i+2]===3?(t.push(0,0),i+=2):t.push(e[i]);return new Uint8Array(t)},Lc=e=>{let r=qr(e);if(r.length===0)return null;let i=0;for(let o of r)i+=4+o.byteLength;let s=new Uint8Array(i),n=new DataView(s.buffer),a=0;for(let o of r){let c=o.byteLength;n.setUint32(a,c,!1),a+=4,s.set(o,a),a+=o.byteLength}return s},Vc=(e,t)=>{if(t.description){let s=(ne(t.description)[4]&3)+1;return Un(e,s)}else return qr(e)},ki=e=>e[0]&31,Ln=e=>{try{let t=qr(e),r=t.filter(p=>ki(p)===7),i=t.filter(p=>ki(p)===8),s=t.filter(p=>ki(p)===13);if(r.length===0||i.length===0)return null;let n=r[0],a=new he(es(n));if(a.skipBits(1),a.skipBits(2),a.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;let c=a.readAlignedByte(),l=a.readAlignedByte(),u=a.readAlignedByte(),f={configurationVersion:1,avcProfileIndication:c,profileCompatibility:l,avcLevelIndication:u,lengthSizeMinusOne:3,sequenceParameterSets:r,pictureParameterSets:i,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){H(a);let p=H(a);p===3&&a.skipBits(1);let k=H(a),T=H(a);f.chromaFormat=p,f.bitDepthLumaMinus8=k,f.bitDepthChromaMinus8=T,f.sequenceParameterSetExt=s}return f}catch(t){return console.error("Error building AVC Decoder Configuration Record:",t),null}},Wc=e=>{let t=[];t.push(e.configurationVersion),t.push(e.avcProfileIndication),t.push(e.profileCompatibility),t.push(e.avcLevelIndication),t.push(252|e.lengthSizeMinusOne&3),t.push(224|e.sequenceParameterSets.length&31);for(let r of e.sequenceParameterSets){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}t.push(e.pictureParameterSets.length);for(let r of e.pictureParameterSets){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}if(e.avcProfileIndication===100||e.avcProfileIndication===110||e.avcProfileIndication===122||e.avcProfileIndication===144){h(e.chromaFormat!==null),h(e.bitDepthLumaMinus8!==null),h(e.bitDepthChromaMinus8!==null),h(e.sequenceParameterSetExt!==null),t.push(252|e.chromaFormat&3),t.push(248|e.bitDepthLumaMinus8&7),t.push(248|e.bitDepthChromaMinus8&7),t.push(e.sequenceParameterSetExt.length);for(let r of e.sequenceParameterSetExt){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}}return new Uint8Array(t)},Vn=(e,t)=>{if(t.description){let s=(ne(t.description)[21]&3)+1;return Un(e,s)}else return qr(e)},$t=e=>e[0]>>1&63,Wn=e=>{try{let t=qr(e),r=t.filter(ee=>$t(ee)===32),i=t.filter(ee=>$t(ee)===33),s=t.filter(ee=>$t(ee)===34),n=t.filter(ee=>$t(ee)===39||$t(ee)===40);if(i.length===0||s.length===0)return null;let a=i[0],o=new he(es(a));o.skipBits(16),o.readBits(4);let c=o.readBits(3),l=o.readBits(1),{general_profile_space:u,general_tier_flag:f,general_profile_idc:p,general_profile_compatibility_flags:k,general_constraint_indicator_flags:T,general_level_idc:b}=Hc(o,c);H(o);let C=H(o);C===3&&o.skipBits(1),H(o),H(o),o.readBits(1)&&(H(o),H(o),H(o),H(o));let S=H(o),_=H(o);H(o);let A=o.readBits(1)?0:c;for(let ee=A;ee<=c;ee++)H(o),H(o),H(o);H(o),H(o),H(o),H(o),H(o),H(o),o.readBits(1)&&o.readBits(1)&&$c(o),o.skipBits(1),o.skipBits(1),o.readBits(1)&&(o.skipBits(4),o.skipBits(4),H(o),H(o),o.skipBits(1));let F=H(o);if(qc(o,F),o.readBits(1)){let ee=H(o);for(let q=0;q<ee;q++)H(o),o.skipBits(1)}o.skipBits(1),o.skipBits(1);let B=0;o.readBits(1)&&(B=Qc(o,c));let D=0;if(s.length>0){let ee=s[0],q=new he(es(ee));q.skipBits(16),H(q),H(q),q.skipBits(1),q.skipBits(1),q.skipBits(3),q.skipBits(1),q.skipBits(1),H(q),H(q),xe(q),q.skipBits(1),q.skipBits(1),q.readBits(1)&&H(q),xe(q),xe(q),q.skipBits(1),q.skipBits(1),q.skipBits(1),q.skipBits(1);let ie=q.readBits(1),ke=q.readBits(1);!ie&&!ke?D=0:ie&&!ke?D=2:!ie&&ke?D=3:D=0}let $=[...r.length?[{arrayCompleteness:1,nalUnitType:32,nalUnits:r}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:33,nalUnits:i}]:[],...s.length?[{arrayCompleteness:1,nalUnitType:34,nalUnits:s}]:[],...n.length?[{arrayCompleteness:1,nalUnitType:$t(n[0]),nalUnits:n}]:[]];return{configurationVersion:1,generalProfileSpace:u,generalTierFlag:f,generalProfileIdc:p,generalProfileCompatibilityFlags:k,generalConstraintIndicatorFlags:T,generalLevelIdc:b,minSpatialSegmentationIdc:B,parallelismType:D,chromaFormatIdc:C,bitDepthLumaMinus8:S,bitDepthChromaMinus8:_,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:l,lengthSizeMinusOne:3,arrays:$}}catch(t){return console.error("Error building HEVC Decoder Configuration Record:",t),null}},Hc=(e,t)=>{let r=e.readBits(2),i=e.readBits(1),s=e.readBits(5),n=0;for(let u=0;u<32;u++)n=n<<1|e.readBits(1);let a=new Uint8Array(6);for(let u=0;u<6;u++)a[u]=e.readBits(8);let o=e.readBits(8),c=[],l=[];for(let u=0;u<t;u++)c.push(e.readBits(1)),l.push(e.readBits(1));if(t>0)for(let u=t;u<8;u++)e.skipBits(2);for(let u=0;u<t;u++)c[u]&&e.skipBits(88),l[u]&&e.skipBits(8);return{general_profile_space:r,general_tier_flag:i,general_profile_idc:s,general_profile_compatibility_flags:n,general_constraint_indicator_flags:a,general_level_idc:o}},$c=e=>{for(let t=0;t<4;t++)for(let r=0;r<(t===3?2:6);r++)if(!e.readBits(1))H(e);else{let s=Math.min(64,1<<4+(t<<1));t>1&&xe(e);for(let n=0;n<s;n++)xe(e)}},qc=(e,t)=>{let r=[];for(let i=0;i<t;i++)r[i]=jc(e,i,t,r)},jc=(e,t,r,i)=>{let s=0,n=0,a=0;if(t!==0&&(n=e.readBits(1)),n){if(t===r){let c=H(e);a=t-(c+1)}else a=t-1;e.readBits(1),H(e);let o=i[a]??0;for(let c=0;c<=o;c++)e.readBits(1)||e.readBits(1);s=i[a]}else{let o=H(e),c=H(e);for(let l=0;l<o;l++)H(e),e.readBits(1);for(let l=0;l<c;l++)H(e),e.readBits(1);s=o+c}return s},Qc=(e,t)=>{if(e.readBits(1)&&e.readBits(8)===255&&(e.readBits(16),e.readBits(16)),e.readBits(1)&&e.readBits(1),e.readBits(1)&&(e.readBits(3),e.readBits(1),e.readBits(1)&&(e.readBits(8),e.readBits(8),e.readBits(8))),e.readBits(1)&&(H(e),H(e)),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1)&&(H(e),H(e),H(e),H(e)),e.readBits(1)&&(e.readBits(32),e.readBits(32),e.readBits(1)&&H(e),e.readBits(1)&&Kc(e,!0,t)),e.readBits(1)){e.readBits(1),e.readBits(1),e.readBits(1);let r=H(e);return H(e),H(e),H(e),H(e),r}return 0},Kc=(e,t,r)=>{let i=!1,s=!1,n=!1;t&&(i=e.readBits(1)===1,s=e.readBits(1)===1,(i||s)&&(n=e.readBits(1)===1,n&&(e.readBits(8),e.readBits(5),e.readBits(1),e.readBits(5)),e.readBits(4),e.readBits(4),n&&e.readBits(4),e.readBits(5),e.readBits(5),e.readBits(5)));for(let a=0;a<=r;a++){let o=e.readBits(1)===1,c=!0;o||(c=e.readBits(1)===1);let l=!1;c?H(e):l=e.readBits(1)===1;let u=1;l||(u=H(e)+1),i&&Hn(e,u,n),s&&Hn(e,u,n)}},Hn=(e,t,r)=>{for(let i=0;i<t;i++)H(e),H(e),r&&(H(e),H(e)),e.readBits(1)},Gc=e=>{let t=[];t.push(e.configurationVersion),t.push((e.generalProfileSpace&3)<<6|(e.generalTierFlag&1)<<5|e.generalProfileIdc&31),t.push(e.generalProfileCompatibilityFlags>>>24&255),t.push(e.generalProfileCompatibilityFlags>>>16&255),t.push(e.generalProfileCompatibilityFlags>>>8&255),t.push(e.generalProfileCompatibilityFlags&255),t.push(...e.generalConstraintIndicatorFlags),t.push(e.generalLevelIdc&255),t.push(240|e.minSpatialSegmentationIdc>>8&15),t.push(e.minSpatialSegmentationIdc&255),t.push(252|e.parallelismType&3),t.push(252|e.chromaFormatIdc&3),t.push(248|e.bitDepthLumaMinus8&7),t.push(248|e.bitDepthChromaMinus8&7),t.push(e.avgFrameRate>>8&255),t.push(e.avgFrameRate&255),t.push((e.constantFrameRate&3)<<6|(e.numTemporalLayers&7)<<3|(e.temporalIdNested&1)<<2|e.lengthSizeMinusOne&3),t.push(e.arrays.length&255);for(let r of e.arrays){t.push((r.arrayCompleteness&1)<<7|0|r.nalUnitType&63),t.push(r.nalUnits.length>>8&255),t.push(r.nalUnits.length&255);for(let i of r.nalUnits){t.push(i.length>>8&255),t.push(i.length&255);for(let s=0;s<i.length;s++)t.push(i[s])}}return new Uint8Array(t)},$n=e=>{let t=new he(e);if(t.readBits(2)!==2)return null;let i=t.readBits(1),n=(t.readBits(1)<<1)+i;if(n===3&&t.skipBits(1),t.readBits(1)===1||t.readBits(1)!==0||(t.skipBits(2),t.readBits(24)!==4817730))return null;let l=8;n>=2&&(l=t.readBits(1)?12:10);let u=t.readBits(3),f=0,p=0;if(u!==7)if(p=t.readBits(1),n===1||n===3){let D=t.readBits(1),$=t.readBits(1);f=!D&&!$?3:D&&!$?2:1,t.skipBits(1)}else f=1;else f=3,p=1;let k=t.readBits(16),T=t.readBits(16),b=k+1,C=T+1,S=b*C,_=se(Ht).level;for(let B of Ht)if(S<=B.maxPictureSize){_=B.level;break}return{profile:n,level:_,bitDepth:l,chromaSubsampling:f,videoFullRangeFlag:p,colourPrimaries:u===2?1:u===1?6:2,transferCharacteristics:u===2?1:u===1?6:2,matrixCoefficients:u===7?0:u===2?1:u===1?6:2}},qn=function*(e){let t=new he(e),r=()=>{let i=0;for(let s=0;s<8;s++){let n=t.readAlignedByte();if(i|=(n&127)<<s*7,!(n&128))break;if(s===7&&n&128)return null}return i>=2**32-1?null:i};for(;t.getBitsLeft()>=8;){t.skipBits(1);let i=t.readBits(4),s=t.readBits(1),n=t.readBits(1);t.skipBits(1),s&&t.skipBits(8);let a;if(n){let o=r();if(o===null)return;a=o}else a=Math.floor(t.getBitsLeft()/8);h(t.pos%8===0),yield{type:i,data:e.subarray(t.pos/8,t.pos/8+a)},t.skipBits(a*8)}},jn=e=>{for(let{type:t,data:r}of qn(e)){if(t!==1)continue;let i=new he(r),s=i.readBits(3),n=i.readBits(1),a=i.readBits(1),o=0,c=0,l=0;if(a)o=i.readBits(5);else{if(i.readBits(1)&&(i.skipBits(32),i.skipBits(32),i.readBits(1)))return null;let S=i.readBits(1);S&&(l=i.readBits(5),i.skipBits(32),i.skipBits(5),i.skipBits(5));let _=i.readBits(5);for(let E=0;E<=_;E++){i.skipBits(12);let A=i.readBits(5);if(E===0&&(o=A),A>7){let B=i.readBits(1);E===0&&(c=B)}if(S&&i.readBits(1)){let D=l+1;i.skipBits(D),i.skipBits(D),i.skipBits(1)}i.readBits(1)&&i.skipBits(4)}}let u=i.readBits(1),f=8;s===2&&u?f=i.readBits(1)?12:10:s<=2&&(f=u?10:8);let p=0;s!==1&&(p=i.readBits(1));let k=1,T=1,b=0;return p||(s===0?(k=1,T=1):s===1?(k=0,T=0):f===12&&(k=i.readBits(1),k&&(T=i.readBits(1))),k&&T&&(b=i.readBits(2))),{profile:s,level:o,tier:c,bitDepth:f,monochrome:p,chromaSubsamplingX:k,chromaSubsamplingY:T,chromaSamplePosition:b}}return null},Ti=e=>{let t=oe(e),r=t.getUint8(9),i=t.getUint16(10,!0),s=t.getUint32(12,!0),n=t.getInt16(16,!0),a=t.getUint8(18),o=null;return a&&(o=e.subarray(19,21+r)),{outputChannelCount:r,preSkip:i,inputSampleRate:s,outputGain:n,channelMappingFamily:a,channelMappingTable:o}},Xc=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],Yc=e=>{let t=e[0]>>3;return{durationInSamples:Xc[t]}},Qn=e=>{if(e.length<7)throw new Error("Setup header is too short.");if(e[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...e.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let r=e.length,i=new Uint8Array(r);for(let f=0;f<r;f++)i[f]=e[r-1-f];let s=new he(i),n=0;for(;s.getBitsLeft()>97;)if(s.readBits(1)===1){n=s.pos;break}if(n===0)throw new Error("Invalid Setup header: framing bit not found.");let a=0,o=!1,c=0;for(;s.getBitsLeft()>=97;){let f=s.pos,p=s.readBits(8),k=s.readBits(16),T=s.readBits(16);if(p>63||k!==0||T!==0){s.pos=f;break}if(s.skipBits(1),a++,a>64)break;s.clone().readBits(6)+1===a&&(o=!0,c=a)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error("Unsupported mode count: ".concat(c,"."));let l=c;s.pos=0,s.skipBits(n);let u=Array(l).fill(0);for(let f=l-1;f>=0;f--)s.skipBits(40),u[f]=s.readBits(1);return{modeBlockflags:u}},Kn=(e,t,r)=>{switch(e){case"avc":return Vc(r,t).some(n=>ki(n)===5)?"key":"delta";case"hevc":return Vn(r,t).some(n=>{let a=$t(n);return 16<=a&&a<=23})?"key":"delta";case"vp8":return(r[0]&1)===0?"key":"delta";case"vp9":{let i=new he(r);if(i.readBits(2)!==2)return null;let s=i.readBits(1);return(i.readBits(1)<<1)+s===3&&i.skipBits(1),i.readBits(1)?null:i.readBits(1)===0?"key":"delta"}case"av1":{let i=!1;for(let{type:s,data:n}of qn(r))if(s===1){let a=new he(n);a.skipBits(4),i=!!a.readBits(1)}else if(s===3||s===6||s===7){if(i)return"key";let a=new he(n);return a.readBits(1)?null:a.readBits(2)===0?"key":"delta"}return null}default:$e(e),h(!1)}},ts=(e,t)=>{var o,c;let r=oe(e),i=0,s=r.getUint32(i,!0);i+=4;let n=Me.decode(e.subarray(i,i+s));i+=s,s>0&&(t.raw??(t.raw={}),(o=t.raw).vendor??(o.vendor=n));let a=r.getUint32(i,!0);i+=4;for(let l=0;l<a;l++){let u=r.getUint32(i,!0);i+=4;let f=Me.decode(e.subarray(i,i+u));i+=u;let p=f.indexOf("=");if(p===-1)continue;let k=f.slice(0,p).toUpperCase(),T=f.slice(p+1);switch(t.raw??(t.raw={}),(c=t.raw)[k]??(c[k]=T),k){case"TITLE":t.title??(t.title=T);break;case"DESCRIPTION":t.description??(t.description=T);break;case"ARTIST":t.artist??(t.artist=T);break;case"ALBUM":t.album??(t.album=T);break;case"ALBUMARTIST":t.albumArtist??(t.albumArtist=T);break;case"COMMENT":t.comment??(t.comment=T);break;case"LYRICS":t.lyrics??(t.lyrics=T);break;case"TRACKNUMBER":{let b=T.split("/"),C=Number.parseInt(b[0],10),S=b[1]&&Number.parseInt(b[1],10);Number.isInteger(C)&&C>0&&(t.trackNumber??(t.trackNumber=C)),S&&Number.isInteger(S)&&S>0&&(t.tracksTotal??(t.tracksTotal=S))}break;case"TRACKTOTAL":{let b=Number.parseInt(T,10);Number.isInteger(b)&&b>0&&(t.tracksTotal??(t.tracksTotal=b))}break;case"DISCNUMBER":{let b=T.split("/"),C=Number.parseInt(b[0],10),S=b[1]&&Number.parseInt(b[1],10);Number.isInteger(C)&&C>0&&(t.discNumber??(t.discNumber=C)),S&&Number.isInteger(S)&&S>0&&(t.discsTotal??(t.discsTotal=S))}break;case"DISCTOTAL":{let b=Number.parseInt(T,10);Number.isInteger(b)&&b>0&&(t.discsTotal??(t.discsTotal=b))}break;case"DATE":{let b=new Date(T);Number.isNaN(b.getTime())||(t.date??(t.date=b))}break;case"GENRE":t.genre??(t.genre=T);break;case"METADATA_BLOCK_PICTURE":{let b=_c(T),C=oe(b),S=C.getUint32(0,!1),_=C.getUint32(4,!1),E=String.fromCharCode(...b.subarray(8,8+_)),A=C.getUint32(8+_,!1),F=Me.decode(b.subarray(12+_,12+_+A)),B=C.getUint32(_+A+28),D=b.subarray(_+A+32,_+A+32+B);t.images??(t.images=[]),t.images.push({data:D,mimeType:E,kind:S===3?"coverFront":S===4?"coverBack":"unknown",name:void 0,description:F||void 0})}break}}},rs=(e,t,r)=>{let i=[e],n=we.encode("Mediabunny"),a=new Uint8Array(4+n.length),o=new DataView(a.buffer);o.setUint32(0,n.length,!0),a.set(n,4),i.push(a);let c=new Set,l=(T,b)=>{let C="".concat(T,"=").concat(b),S=we.encode(C);a=new Uint8Array(4+S.length),o=new DataView(a.buffer),o.setUint32(0,S.length,!0),a.set(S,4),i.push(a),c.add(T)};for(let{key:T,value:b}of yr(t))switch(T){case"title":l("TITLE",b);break;case"description":l("DESCRIPTION",b);break;case"artist":l("ARTIST",b);break;case"album":l("ALBUM",b);break;case"albumArtist":l("ALBUMARTIST",b);break;case"genre":l("GENRE",b);break;case"date":{let C=t.raw?.DATE??t.raw?.date;C&&typeof C=="string"?l("DATE",C):l("DATE",b.toISOString().slice(0,10))}break;case"comment":l("COMMENT",b);break;case"lyrics":l("LYRICS",b);break;case"trackNumber":l("TRACKNUMBER",b.toString());break;case"tracksTotal":l("TRACKTOTAL",b.toString());break;case"discNumber":l("DISCNUMBER",b.toString());break;case"discsTotal":l("DISCTOTAL",b.toString());break;case"images":{if(!r)break;for(let C of b){let S=C.kind==="coverFront"?3:C.kind==="coverBack"?4:0,_=new Uint8Array(C.mimeType.length);for(let D=0;D<C.mimeType.length;D++)_[D]=C.mimeType.charCodeAt(D);let E=we.encode(C.description??""),A=new Uint8Array(8+_.length+4+E.length+16+4+C.data.length),F=oe(A);F.setUint32(0,S,!1),F.setUint32(4,_.length,!1),A.set(_,8),F.setUint32(8+_.length,E.length,!1),A.set(E,12+_.length),F.setUint32(28+_.length+E.length,C.data.length,!1),A.set(C.data,32+_.length+E.length);let B=xc(A);l("METADATA_BLOCK_PICTURE",B)}}break;case"raw":break;default:$e(T)}if(t.raw)for(let T in t.raw){let b=t.raw[T]??t.raw[T.toLowerCase()];T==="vendor"||b==null||c.has(T)||typeof b=="string"&&l(T,b)}let u=new Uint8Array(4);oe(u).setUint32(0,c.size,!0),i.splice(2,0,u);let f=i.reduce((T,b)=>T+b.length,0),p=new Uint8Array(f),k=0;for(let T of i)p.set(T,k),k+=T.length;return p},or=class{constructor(e){this.input=e}},Gn=class{static supports(e,t){return!1}},Xn=class{static supports(e,t){return!1}},Yn=class{static supports(e,t){return!1}},Zn=class{static supports(e,t){return!1}},Si=[],vi=[],jr=[],Qr=[],Zc=e=>{if(e.prototype instanceof Gn){let t=e;if(Si.includes(t)){console.warn("Video decoder already registered.");return}Si.push(t)}else if(e.prototype instanceof Xn){let t=e;if(vi.includes(t)){console.warn("Audio decoder already registered.");return}vi.push(t)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Jc=e=>{if(e.prototype instanceof Yn){let t=e;if(jr.includes(t)){console.warn("Video encoder already registered.");return}jr.push(t)}else if(e.prototype instanceof Zn){let t=e;if(Qr.includes(t)){console.warn("Audio encoder already registered.");return}Qr.push(t)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")},nt=new Uint8Array(0),Ce=class mn{constructor(t,r,i,s,n=-1,a,o){if(this.data=t,this.type=r,this.timestamp=i,this.duration=s,this.sequenceNumber=n,t===nt&&a===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(a===void 0&&(a=t.byteLength),!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(r!=="key"&&r!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(i))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(s)||s<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(n))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(a)||a<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=a,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===nt}get microsecondTimestamp(){return Math.trunc(Wt*this.timestamp)}get microsecondDuration(){return Math.trunc(Wt*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(t=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:t,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(t,r){if(!(t instanceof EncodedVideoChunk||t instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let i=new Uint8Array(t.byteLength);return t.copyTo(i),new mn(i,t.type,t.timestamp/1e6,(t.duration??0)/1e6,void 0,void 0,r)}clone(t){if(t!==void 0&&(typeof t!="object"||t===null))throw new TypeError("options, when provided, must be an object.");if(t?.timestamp!==void 0&&!Number.isFinite(t.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&!Number.isFinite(t.duration))throw new TypeError("options.duration, when provided, must be a number.");return new mn(this.data,this.type,t?.timestamp??this.timestamp,t?.duration??this.duration,this.sequenceNumber,this.byteLength)}},el=e=>{let i=e,s=4096,n=0,a=12,o=0;for(i<0&&(i=-i,n=128),i+=33,i>8191&&(i=8191);(i&s)!==s&&a>=5;)s>>=1,a--;return o=i>>a-4&15,~(n|a-5<<4|o)&255},tl=e=>{let r=0,i=0,s=~e;s&128&&(s&=-129,r=-1),i=((s&240)>>4)+5;let n=(1<<i|(s&15)<<i-4|1<<i-5)-33;return r===0?n:-n},rl=e=>{let r=2048,i=0,s=11,n=0,a=e;for(a<0&&(a=-a,i=128),a>4095&&(a=4095);(a&r)!==r&&s>=5;)r>>=1,s--;return n=a>>(s===4?1:s-4)&15,(i|s-4<<4|n)^85},il=e=>{let t=0,r=0,i=e^85;i&128&&(i&=-129,t=-1),r=((i&240)>>4)+4;let s=0;return r!==4?s=1<<r|(i&15)<<r-4|1<<r-5:s=i<<1|1,t===0?s:-s};_n();var it=class ni{constructor(t,r){if(this._closed=!1,t instanceof ArrayBuffer||ArrayBuffer.isView(t)){if(!r||typeof r!="object")throw new TypeError("init must be an object.");if(!("format"in r)||typeof r.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(r.codedWidth)||r.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(r.codedHeight)||r.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(r.timestamp))throw new TypeError("init.timestamp must be a number.");if(r.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=ne(t).slice(),this.format=r.format,this.codedWidth=r.codedWidth,this.codedHeight=r.codedHeight,this.rotation=r.rotation??0,this.timestamp=r.timestamp,this.duration=r.duration??0,this.colorSpace=new VideoColorSpace(r.colorSpace)}else if(typeof VideoFrame<"u"&&t instanceof VideoFrame){if(r?.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(r?.timestamp!==void 0&&!Number.isFinite(r?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(r?.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=t,this.format=t.format,this.codedWidth=t.displayWidth,this.codedHeight=t.displayHeight,this.rotation=r?.rotation??0,this.timestamp=r?.timestamp??t.timestamp/1e6,this.duration=r?.duration??(t.duration??0)/1e6,this.colorSpace=t.colorSpace}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof SVGImageElement<"u"&&t instanceof SVGImageElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas){if(!r||typeof r!="object")throw new TypeError("init must be an object.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(r.timestamp))throw new TypeError("init.timestamp must be a number.");if(r.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new ni(new VideoFrame(t,{timestamp:Math.trunc(r.timestamp*Wt),duration:Math.trunc((r.duration??0)*Wt)||void 0}),r);let i=0,s=0;if("naturalWidth"in t?(i=t.naturalWidth,s=t.naturalHeight):"videoWidth"in t?(i=t.videoWidth,s=t.videoHeight):"width"in t&&(i=Number(t.width),s=Number(t.height)),!i||!s)throw new TypeError("Could not determine dimensions.");let n=new OffscreenCanvas(i,s),a=n.getContext("2d",{alpha:$r(),willReadFrequently:!0});h(a),a.drawImage(t,0,0),this._data=n,this.format="RGBX",this.codedWidth=i,this.codedHeight=s,this.rotation=r.rotation??0,this.timestamp=r.timestamp,this.duration=r.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(Wt*this.timestamp)}get microsecondDuration(){return Math.trunc(Wt*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}clone(){if(this._closed)throw new Error("VideoSample is closed.");return h(this._data!==null),Kr(this._data)?new ni(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new ni(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new ni(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(Kr(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return h(this._data!==null),Kr(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(t){if(!hi(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(h(this._data!==null),Kr(this._data))await this._data.copyTo(t);else if(this._data instanceof Uint8Array)ne(t).set(this._data);else{let i=this._data.getContext("2d");h(i);let s=i.getImageData(0,0,this.codedWidth,this.codedHeight);ne(t).set(s.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return h(this._data!==null),Kr(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(t,r,i,s,n,a,o,c,l){let u=0,f=0,p=this.displayWidth,k=this.displayHeight,T=0,b=0,C=this.displayWidth,S=this.displayHeight;if(a!==void 0?(u=r,f=i,p=s,k=n,T=a,b=o,c!==void 0?(C=c,S=l):(C=p,S=k)):(T=r,b=i,s!==void 0&&(C=s,S=n)),!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(u))throw new TypeError("sx must be a number.");if(!Number.isFinite(f))throw new TypeError("sy must be a number.");if(!Number.isFinite(p)||p<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(k)||k<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(T))throw new TypeError("dx must be a number.");if(!Number.isFinite(b))throw new TypeError("dy must be a number.");if(!Number.isFinite(C)||C<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(S)||S<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:u,sy:f,sWidth:p,sHeight:k}=this._rotateSourceRegion(u,f,p,k,this.rotation));let _=this.toCanvasImageSource();t.save();let E=T+C/2,A=b+S/2;t.translate(E,A),t.rotate(this.rotation*Math.PI/180);let F=this.rotation%180===0?1:C/S;t.scale(1/F,F),t.drawImage(_,u,f,p,k,-C/2,-S/2,C,S),t.restore()}drawWithFit(t,r){if(!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(r.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");r.crop!==void 0&&ss(r.crop,"options.");let i=t.canvas.width,s=t.canvas.height,n=r.rotation??this.rotation,[a,o]=n%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];r.crop&&is(r.crop,a,o);let c,l,u,f,{sx:p,sy:k,sWidth:T,sHeight:b}=this._rotateSourceRegion(r.crop?.left??0,r.crop?.top??0,r.crop?.width??a,r.crop?.height??o,n);if(r.fit==="fill")c=0,l=0,u=i,f=s;else{let[S,_]=r.crop?[r.crop.width,r.crop.height]:[a,o],E=r.fit==="contain"?Math.min(i/S,s/_):Math.max(i/S,s/_);u=S*E,f=_*E,c=(i-u)/2,l=(s-f)/2}let C=n%180===0?1:u/f;t.translate(i/2,s/2),t.rotate(n*Math.PI/180),t.scale(1/C,C),t.translate(-i/2,-s/2),t.drawImage(this.toCanvasImageSource(),p,k,T,b,c,l,u,f)}_rotateSourceRegion(t,r,i,s,n){return n===90?[t,r,i,s]=[r,this.codedHeight-t-i,s,i]:n===180?[t,r]=[this.codedWidth-t-i,this.codedHeight-r-s]:n===270&&([t,r,i,s]=[this.codedWidth-r-s,t,s,i]),{sx:t,sy:r,sWidth:i,sHeight:s}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(h(this._data!==null),this._data instanceof Uint8Array){let t=this.toVideoFrame();return queueMicrotask(()=>t.close()),t}else return this._data}setRotation(t){if(![0,90,180,270].includes(t))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}setDuration(t){if(!Number.isFinite(t)||t<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=t}[Symbol.dispose](){this.close()}},Kr=e=>typeof VideoFrame<"u"&&e instanceof VideoFrame,is=(e,t,r)=>{e.left=Math.min(e.left,t),e.top=Math.min(e.top,r),e.width=Math.min(e.width,t-e.left),e.height=Math.min(e.height,r-e.top),h(e.width>=0),h(e.height>=0)},ss=(e,t)=>{if(!e||typeof e!="object")throw new TypeError(t+"crop, when provided, must be an object.");if(!Number.isInteger(e.left)||e.left<0)throw new TypeError(t+"crop.left must be a non-negative integer.");if(!Number.isInteger(e.top)||e.top<0)throw new TypeError(t+"crop.top must be a non-negative integer.");if(!Number.isInteger(e.width)||e.width<0)throw new TypeError(t+"crop.width must be a non-negative integer.");if(!Number.isInteger(e.height)||e.height<0)throw new TypeError(t+"crop.height must be a non-negative integer.")},ns=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),St=class ai{constructor(t){if(this._closed=!1,Xr(t)){if(t.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=t,this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=t.numberOfFrames,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp/1e6,this.duration=t.numberOfFrames/t.sampleRate}else{if(!t||typeof t!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!ns.has(t.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(t.sampleRate)||t.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(t.numberOfChannels)||t.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp must be a number.");let r=t.data.byteLength/(Gr(t.format)*t.numberOfChannels);if(!Number.isInteger(r))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=r,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp,this.duration=r/t.sampleRate;let i;if(t.data instanceof ArrayBuffer)i=new Uint8Array(t.data);else if(ArrayBuffer.isView(t.data))i=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let s=this.numberOfFrames*this.numberOfChannels*Gr(this.format);if(i.byteLength<s)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=i}}get microsecondTimestamp(){return Math.trunc(Wt*this.timestamp)}get microsecondDuration(){return Math.trunc(Wt*this.duration)}allocationSize(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!ns.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let r=t.format??this.format,i=t.frameOffset??0;if(i>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let s=t.frameCount!==void 0?t.frameCount:this.numberOfFrames-i;if(s>this.numberOfFrames-i)throw new RangeError("frameCount out of range");let n=Gr(r),a=Ci(r);if(a&&t.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!a&&t.planeIndex!==0)throw new RangeError("planeIndex out of range");return(a?s:s*this.numberOfChannels)*n}copyTo(t,r){if(!hi(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(r.planeIndex)||r.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(r.format!==void 0&&!ns.has(r.format))throw new TypeError("Invalid format.");if(r.frameOffset!==void 0&&(!Number.isInteger(r.frameOffset)||r.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(r.frameCount!==void 0&&(!Number.isInteger(r.frameCount)||r.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:i,format:s,frameCount:n,frameOffset:a}=r,o=s??this.format;if(!o)throw new Error("Destination format not determined");let c=this.numberOfFrames,l=this.numberOfChannels,u=a??0;if(u>=c)throw new RangeError("frameOffset out of range");let f=n!==void 0?n:c-u;if(f>c-u)throw new RangeError("frameCount out of range");let p=Gr(o),k=Ci(o);if(k&&i>=l)throw new RangeError("planeIndex out of range");if(!k&&i!==0)throw new RangeError("planeIndex out of range");let b=(k?f:f*l)*p;if(t.byteLength<b)throw new RangeError("Destination buffer is too small");let C=oe(t),S=nl(o);if(Xr(this._data))if(k)if(o==="f32-planar")this._data.copyTo(t,{planeIndex:i,frameOffset:u,frameCount:f,format:"f32-planar"});else{let _=new ArrayBuffer(f*4),E=new Float32Array(_);this._data.copyTo(E,{planeIndex:i,frameOffset:u,frameCount:f,format:"f32-planar"});let A=new DataView(_);for(let F=0;F<f;F++){let B=F*p,D=A.getFloat32(F*4,!0);S(C,B,D)}}else{let _=l,E=new Float32Array(f);for(let A=0;A<_;A++){this._data.copyTo(E,{planeIndex:A,frameOffset:u,frameCount:f,format:"f32-planar"});for(let F=0;F<f;F++){let D=(F*_+A)*p;S(C,D,E[F])}}}else{let _=this._data,E=new DataView(_.buffer,_.byteOffset,_.byteLength),A=this.format,F=sl(A),B=Gr(A),D=Ci(A);for(let $=0;$<f;$++)if(k){let ye=$*p,ee;D?ee=(i*c+($+u))*B:ee=(($+u)*l+i)*B;let q=F(E,ee);S(C,ye,q)}else for(let ye=0;ye<l;ye++){let q=($*l+ye)*p,ie;D?ie=(ye*c+($+u))*B:ie=(($+u)*l+ye)*B;let ke=F(E,ie);S(C,q,ke)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(Xr(this._data)){let t=new ai(this._data.clone());return t.setTimestamp(this.timestamp),t}else return new ai({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(Xr(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(Xr(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(Ci(this.format)){let t=this.allocationSize({planeIndex:0,format:this.format}),r=new ArrayBuffer(t*this.numberOfChannels);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(new Uint8Array(r,i*t,t),{planeIndex:i,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:r})}else{let t=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(t,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let t=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),r=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(r,{planeIndex:i,format:"f32-planar"}),t.copyToChannel(r,i);return t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}[Symbol.dispose](){this.close()}static*_fromAudioBuffer(t,r){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let i=48e3*5,s=t.numberOfChannels,n=t.sampleRate,a=t.length,o=Math.floor(i/s),c=0,l=a;for(;l>0;){let u=Math.min(o,l),f=new Float32Array(s*u);for(let p=0;p<s;p++)t.copyFromChannel(f.subarray(p*u,(p+1)*u),p,c);yield new ai({format:"f32-planar",sampleRate:n,numberOfFrames:u,numberOfChannels:s,timestamp:r+c/n,data:f}),c+=u,l-=u}}static fromAudioBuffer(t,r){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let i=48e3*5,s=t.numberOfChannels,n=t.sampleRate,a=t.length,o=Math.floor(i/s),c=0,l=a,u=[];for(;l>0;){let f=Math.min(o,l),p=new Float32Array(s*f);for(let T=0;T<s;T++)t.copyFromChannel(p.subarray(T*f,(T+1)*f),T,c);let k=new ai({format:"f32-planar",sampleRate:n,numberOfFrames:f,numberOfChannels:s,timestamp:r+c/n,data:p});u.push(k),c+=f,l-=f}return u}},Gr=e=>{switch(e){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},Ci=e=>{switch(e){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},sl=e=>{switch(e){case"u8":case"u8-planar":return(t,r)=>(t.getUint8(r)-128)/128;case"s16":case"s16-planar":return(t,r)=>t.getInt16(r,!0)/32768;case"s32":case"s32-planar":return(t,r)=>t.getInt32(r,!0)/2147483648;case"f32":case"f32-planar":return(t,r)=>t.getFloat32(r,!0)}},nl=e=>{switch(e){case"u8":case"u8-planar":return(t,r,i)=>t.setUint8(r,Ne((i+1)*127.5,0,255));case"s16":case"s16-planar":return(t,r,i)=>t.setInt16(r,Ne(Math.round(i*32767),-32768,32767),!0);case"s32":case"s32-planar":return(t,r,i)=>t.setInt32(r,Ne(Math.round(i*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(t,r,i)=>t.setFloat32(r,i,!0)}},Xr=e=>typeof AudioData<"u"&&e instanceof AudioData,vr=e=>{if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.metadataOnly!==void 0&&typeof e.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(e.verifyKeyPackets!==void 0&&typeof e.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(e.verifyKeyPackets&&e.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},Bt=e=>{if(!kr(e))throw new TypeError("timestamp must be a number.")},as=(e,t,r)=>r.verifyKeyPackets?t.then(async i=>{if(!i||i.type==="delta")return i;let s=await e.determinePacketType(i);return s&&(i.type=s),i}):t,Cr=class{constructor(e){if(!(e instanceof Ii))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){if(vr(e),this._track.input._disposed)throw new Ke;return as(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){if(Bt(e),vr(t),this._track.input._disposed)throw new Ke;return as(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof Ce))throw new TypeError("packet must be an EncodedPacket.");if(vr(t),this._track.input._disposed)throw new Ke;return as(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(Bt(e),vr(t),this._track.input._disposed)throw new Ke;if(!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);let r=await this._track._backing.getKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,t):r}async getNextKeyPacket(e,t={}){if(!(e instanceof Ce))throw new TypeError("packet must be an EncodedPacket.");if(vr(t),this._track.input._disposed)throw new Ke;if(!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);let r=await this._track._backing.getNextKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,t):r}packets(e,t,r={}){if(e!==void 0&&!(e instanceof Ce))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof Ce))throw new TypeError("endPacket must be an EncodedPacket.");if(vr(r),this._track.input._disposed)throw new Ke;let i=[],{promise:s,resolve:n}=Ie(),{promise:a,resolve:o}=Ie(),c=!1,l=!1,u=null,f=[],p=()=>Math.max(2,f.length);(async()=>{let T=e??await this.getFirstPacket(r);for(;T&&!l&&!this._track.input._disposed&&!(t&&T.sequenceNumber>=t?.sequenceNumber);){if(i.length>p()){({promise:a,resolve:o}=Ie()),await a;continue}i.push(T),n(),{promise:s,resolve:n}=Ie(),T=await this.getNextPacket(T,r)}c=!0,n()})().catch(T=>{u||(u=T,n())});let k=this._track;return{async next(){for(;;){if(k.input._disposed)throw new Ke;if(l)return{value:void 0,done:!0};if(u)throw u;if(i.length>0){let T=i.shift(),b=performance.now();for(f.push(b);f.length>0&&b-f[0]>=1e3;)f.shift();return o(),{value:T,done:!1}}else{if(c)return{value:void 0,done:!0};await s}}},async return(){return l=!0,o(),n(),{value:void 0,done:!0}},async throw(T){throw T},[Symbol.asyncIterator](){return this}}}},os=class{constructor(e,t){this.onSample=e,this.onError=t}},cs=class{mediaSamplesInRange(e=0,t=1/0){Bt(e),Bt(t);let r=[],i=!1,s=null,{promise:n,resolve:a}=Ie(),{promise:o,resolve:c}=Ie(),l=!1,u=!1,f=!1,p=null;(async()=>{let b=new Error,C=await this._createDecoder(B=>{if(c(),B.timestamp>=t&&(u=!0),u){B.close();return}s&&(B.timestamp>e?(r.push(s),i=!0):s.close()),B.timestamp>=e&&(r.push(B),i=!0),s=i?null:B,r.length>0&&(a(),{promise:n,resolve:a}=Ie())},B=>{p||(B.stack=b.stack,p=B,a())}),S=this._createPacketSink(),_=await S.getKeyPacket(e,{verifyKeyPackets:!0})??await S.getFirstPacket();if(!_)return;let E=_,A;if(t<1/0){let B=await S.getPacket(t),D=B?B.type==="key"&&B.timestamp===t?B:await S.getNextKeyPacket(B,{verifyKeyPackets:!0}):null;D&&(A=D)}let F=S.packets(_,A);for(await F.next();E&&!u&&!this._track.input._disposed;){let B=Jn(r.length);if(r.length+C.getDecodeQueueSize()>B){({promise:o,resolve:c}=Ie()),await o;continue}C.decode(E);let D=await F.next();if(D.done)break;E=D.value}await F.return(),!f&&!this._track.input._disposed&&await C.flush(),C.close(),!i&&s&&r.push(s),l=!0,a()})().catch(b=>{p||(p=b,a())});let k=this._track,T=()=>{s?.close();for(let b of r)b.close()};return{async next(){for(;;){if(k.input._disposed)throw T(),new Ke;if(f)return{value:void 0,done:!0};if(p)throw T(),p;if(r.length>0){let b=r.shift();return c(),{value:b,done:!1}}else if(!l)await n;else return{value:void 0,done:!0}}},async return(){return f=!0,u=!0,c(),a(),T(),{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){wc(e);let t=gc(e),r=[],i=[],{promise:s,resolve:n}=Ie(),{promise:a,resolve:o}=Ie(),c=!1,l=!1,u=null,f=T=>{i.push(T),n(),{promise:s,resolve:n}=Ie()};(async()=>{let T=new Error,b=await this._createDecoder(B=>{if(o(),l){B.close();return}let D=0;for(;r.length>0&&B.timestamp-r[0]>-1e-10;)D++,r.shift();if(D>0)for(let $=0;$<D;$++)f($<D-1?B.clone():B);else B.close()},B=>{u||(B.stack=T.stack,u=B,n())}),C=this._createPacketSink(),S=null,_=null,E=-1,A=async()=>{h(_);let B=_;for(b.decode(B);B.sequenceNumber<E;){let D=Jn(i.length);for(;i.length+b.getDecodeQueueSize()>D&&!l;)({promise:a,resolve:o}=Ie()),await a;if(l)break;let $=await C.getNextPacket(B);h($),b.decode($),B=$}E=-1},F=async()=>{await b.flush();for(let B=0;B<r.length;B++)f(null);r.length=0};for await(let B of t){if(Bt(B),l||this._track.input._disposed)break;let D=await C.getPacket(B),$=D&&await C.getKeyPacket(B,{verifyKeyPackets:!0});if(!$){E!==-1&&(await A(),await F()),f(null),S=null;continue}S&&($.sequenceNumber!==_.sequenceNumber||D.timestamp<S.timestamp)&&(await A(),await F()),r.push(D.timestamp),E=Math.max(D.sequenceNumber,E),S=D,_=$}!l&&!this._track.input._disposed&&(E!==-1&&await A(),await F()),b.close(),c=!0,n()})().catch(T=>{u||(u=T,n())});let p=this._track,k=()=>{for(let T of i)T?.close()};return{async next(){for(;;){if(p.input._disposed)throw k(),new Ke;if(l)return{value:void 0,done:!0};if(u)throw k(),u;if(i.length>0){let T=i.shift();return h(T!==void 0),o(),{value:T,done:!1}}else if(!c)await s;else return{value:void 0,done:!0}}},async return(){return l=!0,o(),n(),k(),{value:void 0,done:!0}},async throw(T){throw T},[Symbol.asyncIterator](){return this}}}},Jn=e=>e===0?40:8,al=class extends os{constructor(e,t,r,i,s,n){super(e,t),this.codec=r,this.decoderConfig=i,this.rotation=s,this.timeResolution=n,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new gi,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[],this.currentPacketIndex=0,this.raslSkipped=!1,this.alphaDecoder=null,this.alphaHadKeyframe=!1,this.colorQueue=[],this.alphaQueue=[],this.merger=null,this.mergerCreationFailed=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue=[],this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1;let a=Si.find(o=>o.supports(r,i));if(a)this.customDecoder=new a,this.customDecoder.codec=r,this.customDecoder.config=i,this.customDecoder.onSample=o=>{if(!(o instanceof it))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(o)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let o=c=>{if(this.alphaQueue.length>0){let l=this.alphaQueue.shift();h(l!==void 0),this.mergeAlpha(c,l)}else this.colorQueue.push(c)};this.decoder=new VideoDecoder({output:c=>{try{o(c)}catch(l){this.onError(l)}},error:t}),this.decoder.configure(i)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(h(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}this.currentPacketIndex++,this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(h(this.decoder),Gi()||bn(this.inputTimestamps,e.timestamp,t=>t),this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e))}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new ol}catch(r){console.error("Due to an error, only color data will be decoded.",r),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){let r=i=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){let s=this.colorQueue.shift();h(s!==void 0),this.mergeAlpha(s,i)}else this.alphaQueue.push(i);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){let s=this.colorQueue.shift();h(s!==void 0),this.mergeAlpha(s,null)}else this.alphaQueue.push(null)};this.alphaDecoder=new VideoDecoder({output:i=>{try{r(i)}catch(s){this.onError(s)}},error:this.onError}),this.alphaDecoder.configure(this.decoderConfig)}let t=Kn(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=t==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(t??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){return Vn(e,this.decoderConfig).some(r=>{let i=$t(r);return i===8||i===9})}sampleHandler(e){if(Gi()){if(this.sampleQueue.length>0&&e.timestamp>=se(this.sampleQueue).timestamp){for(let t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}bn(this.sampleQueue,e,t=>t.timestamp)}else{let t=this.inputTimestamps.shift();h(t!==void 0),e.setTimestamp(t),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,t){if(!t){let s=new it(e);this.sampleHandler(s);return}h(this.merger),this.merger.update(e,t),e.close(),t.close();let r=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),i=new it(r);this.sampleHandler(i)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(h(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),Gi()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(h(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(let e of this.sampleQueue)e.close();this.sampleQueue.length=0}},ol=class{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");let e=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=e,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){let e=this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n			in vec2 a_position;\n			in vec2 a_texCoord;\n			out vec2 v_texCoord;\n			\n			void main() {\n				gl_Position = vec4(a_position, 0.0, 1.0);\n				v_texCoord = a_texCoord;\n			}\n		"),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_colorTexture;\n			uniform sampler2D u_alphaTexture;\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n			\n			void main() {\n				vec3 color = texture(u_colorTexture, v_texCoord).rgb;\n				float alpha = texture(u_alphaTexture, v_texCoord).r;\n				fragColor = vec4(color, alpha);\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.program,"a_position"),s=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}update(e,t){(e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},_i=class extends cs{constructor(e){if(!(e instanceof _r))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,i=this._track.rotation,s=await this._track.getDecoderConfig(),n=this._track.timeResolution;return h(r&&s),new al(e,t,r,s,i,n)}_createPacketSink(){return new Cr(this._track)}async getSample(e){Bt(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},ea=class{constructor(e,t={}){if(this._nextCanvasIndex=0,!(e instanceof _r))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.alpha!==void 0&&typeof t.alpha!="boolean")throw new TypeError("options.alpha, when provided, must be a boolean.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.crop!==void 0&&ss(t.crop,"options."),t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=t.rotation??e.rotation,[i,s]=r%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],n=t.crop;n&&is(n,i,s);let[a,o]=n?[n.width,n.height]:[i,s],c=a/o;t.width!==void 0&&t.height===void 0?(a=t.width,o=Math.round(a/c)):t.width===void 0&&t.height!==void 0?(o=t.height,a=Math.round(o*c)):t.width!==void 0&&t.height!==void 0&&(a=t.width,o=t.height),this._videoTrack=e,this._alpha=t.alpha??!1,this._width=a,this._height=o,this._rotation=r,this._crop=n,this._fit=t.fit??"fill",this._videoSampleSink=new _i(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex],r=!1;t||(typeof document<"u"?(t=document.createElement("canvas"),t.width=this._width,t.height=this._height):t=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let i=t.getContext("2d",{alpha:this._alpha||$r()});h(i),i.resetTransform(),r||(!this._alpha&&$r()?(i.fillStyle="black",i.fillRect(0,0,this._width,this._height)):i.clearRect(0,0,this._width,this._height)),e.drawWithFit(i,{fit:this._fit,rotation:this._rotation,crop:this._crop});let s={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),s}async getCanvas(e){Bt(e);let t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return mi(this._videoSampleSink.samples(e,t),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(e){return mi(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}},cl=class extends os{constructor(e,t,r,i){super(e,t),this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new gi,this.customDecoderQueueSize=0,this.currentTimestamp=null;let s=a=>{(this.currentTimestamp===null||Math.abs(a.timestamp-this.currentTimestamp)>=a.duration)&&(this.currentTimestamp=a.timestamp);let o=this.currentTimestamp;if(this.currentTimestamp+=a.duration,a.numberOfFrames===0){a.close();return}let c=i.sampleRate;a.setTimestamp(Math.round(o*c)/c),e(a)},n=vi.find(a=>a.supports(r,i));n?(this.customDecoder=new n,this.customDecoder.codec=r,this.customDecoder.config=i,this.customDecoder.onSample=a=>{if(!(a instanceof St))throw new TypeError("The argument passed to onSample must be an AudioSample.");s(a)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:a=>{try{s(new St(a))}catch(o){this.onError(o)}},error:t}),this.decoder.configure(i))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(h(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(h(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(h(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(h(this.decoder),this.decoder.close())}},ll=class extends os{constructor(e,t,r){super(e,t),this.decoderConfig=r,this.currentTimestamp=null,h(ze.includes(r.codec)),this.codec=r.codec;let{dataType:i,sampleSize:s,littleEndian:n}=Tt(this.codec);switch(this.inputSampleSize=s,s){case 1:i==="unsigned"?this.readInputValue=(a,o)=>a.getUint8(o)-2**7:i==="signed"?this.readInputValue=(a,o)=>a.getInt8(o):i==="ulaw"?this.readInputValue=(a,o)=>tl(a.getUint8(o)):i==="alaw"?this.readInputValue=(a,o)=>il(a.getUint8(o)):h(!1);break;case 2:i==="unsigned"?this.readInputValue=(a,o)=>a.getUint16(o,n)-2**15:i==="signed"?this.readInputValue=(a,o)=>a.getInt16(o,n):h(!1);break;case 3:i==="unsigned"?this.readInputValue=(a,o)=>fi(a,o,n)-2**23:i==="signed"?this.readInputValue=(a,o)=>bc(a,o,n):h(!1);break;case 4:i==="unsigned"?this.readInputValue=(a,o)=>a.getUint32(o,n)-2**31:i==="signed"?this.readInputValue=(a,o)=>a.getInt32(o,n):i==="float"?this.readInputValue=(a,o)=>a.getFloat32(o,n):h(!1);break;case 8:i==="float"?this.readInputValue=(a,o)=>a.getFloat64(o,n):h(!1);break;default:$e(s),h(!1)}switch(s){case 1:i==="ulaw"||i==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(a,o,c)=>a.setInt16(o,c,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(a,o,c)=>a.setUint8(o,c+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(a,o,c)=>a.setInt16(o,c,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(a,o,c)=>a.setInt32(o,c<<8,!0);break;case 4:this.outputSampleSize=4,i==="float"?(this.outputFormat="f32",this.writeOutputValue=(a,o,c)=>a.setFloat32(o,c,!0)):(this.outputFormat="s32",this.writeOutputValue=(a,o,c)=>a.setInt32(o,c,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(a,o,c)=>a.setFloat32(o,c,!0);break;default:$e(s),h(!1)}}getDecodeQueueSize(){return 0}decode(e){let t=oe(e.data),r=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,i=r*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(i),n=new DataView(s);for(let l=0;l<r*this.decoderConfig.numberOfChannels;l++){let u=l*this.inputSampleSize,f=l*this.outputSampleSize,p=this.readInputValue(t,u);this.writeOutputValue(n,f,p)}let a=r/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=a)&&(this.currentTimestamp=e.timestamp);let o=this.currentTimestamp;this.currentTimestamp+=a;let c=new St({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:r,timestamp:o});this.onSample(c)}async flush(){}close(){}},xi=class extends cs{constructor(e){if(!(e instanceof dt))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,i=await this._track.getDecoderConfig();return h(r&&i),ze.includes(i.codec)?new ll(e,t,i):new cl(e,t,r,i)}_createPacketSink(){return new Cr(this._track)}async getSample(e){Bt(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},ul=class{constructor(e){if(!(e instanceof dt))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new xi(e)}_audioSampleToWrappedArrayBuffer(e){return{buffer:e.toAudioBuffer(),timestamp:e.timestamp,duration:e.duration}}async getBuffer(e){Bt(e);let t=await this._audioSampleSink.getSample(e);return t&&this._audioSampleToWrappedArrayBuffer(t)}buffers(e=0,t=1/0){return mi(this._audioSampleSink.samples(e,t),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(e){return mi(this._audioSampleSink.samplesAtTimestamps(e),t=>t&&this._audioSampleToWrappedArrayBuffer(t))}},Ii=class{constructor(e,t){this.input=e,this._backing=t}isVideoTrack(){return this instanceof _r}isAudioTrack(){return this instanceof dt}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){let t=new Cr(this),r=1/0,i=-1/0,s=0,n=0;for await(let a of t.packets(void 0,void 0,{metadataOnly:!0})){if(s>=e&&a.timestamp>=i)break;r=Math.min(r,a.timestamp),i=Math.max(i,a.timestamp+a.duration),s++,n+=a.byteLength}return{packetCount:s,averagePacketRate:s?Number((s/(i-r)).toPrecision(16)):0,averageBitrate:s?Number((8*n/(i-r)).toPrecision(16)):0}}},_r=class extends Ii{constructor(e,t){super(e,t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return h(t!==null),Si.some(i=>i.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof Ce))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;let t=await this.getDecoderConfig();return h(t),Kn(this.codec,t,e.data)}},dt=class extends Ii{constructor(e,t){super(e,t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return h(t!==null),vi.some(r=>r.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof Ce))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}},ta=e=>{let r=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isQuickTime?"quicktime":"mp4");if(e.codecStrings.length>0){let i=[...new Set(e.codecStrings)];r+='; codecs="'.concat(i.join(", "),'"')}return r},Mt=8,cr=16,qt=e=>{let t=L(e),r=Oe(e,4),i=8;t===1&&(t=mt(e),i=16);let n=t-i;return n<0?null:{name:r,totalSize:t,headerSize:i,contentSize:n}},lr=e=>dr(e)/65536,ls=e=>dr(e)/1073741824,us=e=>{let t=0;for(let r=0;r<4;r++){t<<=7;let i=j(e);if(t|=i&127,(i&128)===0)break}return t},vt=e=>{let t=Le(e);return e.skip(2),t=Math.min(t,e.remainingLength),Me.decode(Z(e,t))},dl=e=>{let t=qt(e);if(!t||t.name!=="data"||e.remainingLength<8)return null;let r=L(e);e.skip(4);let i=Z(e,t.contentSize-8);switch(r){case 1:return Me.decode(i);case 2:return new TextDecoder("utf-16be").decode(i);case 13:return new sr(i,"image/jpeg");case 14:return new sr(i,"image/png");case 27:return new sr(i,"image/bmp");default:return i}},hl=class extends or{constructor(e){super(e),this.moovSlice=null,this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.metadataTags={},this.currentMetadataKeys=null,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.currentFragment=null,this.lastReadFragment=null,this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(t=>t.inputTrack.getCodecParameterString()));return ta({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(t=>t.info?.type==="video"),hasAudio:this.tracks.some(t=>t.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,Mt,cr);if(t instanceof Promise&&(t=await t),!t)break;let r=e,i=qt(t);if(!i)break;if(i.name==="ftyp"){let s=Oe(t,4);this.isQuickTime=s==="qt  "}else if(i.name==="moov"){let s=this.reader.requestSlice(t.filePos,i.contentSize);if(s instanceof Promise&&(s=await s),!s)break;this.moovSlice=s,this.readContiguousBoxes(this.moovSlice);for(let n of this.tracks){let a=n.editListPreviousSegmentDurations/this.movieTimescale;n.editListOffset-=Math.round(a*n.timescale)}break}e=r+i.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let t=this.reader.requestSlice(this.reader.fileSize-4,4);t instanceof Promise&&(t=await t),h(t);let r=L(t),i=this.reader.fileSize-r;if(i>=0&&i<=this.reader.fileSize-cr){let s=this.reader.requestSliceRange(i,Mt,cr);if(s instanceof Promise&&(s=await s),s){let n=qt(s);if(n&&n.name==="mfra"){let a=this.reader.requestSlice(s.filePos,n.contentSize);a instanceof Promise&&(a=await a),a&&this.readContiguousBoxes(a)}}}}})())}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=t,h(this.moovSlice);let r=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(r),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&ze.includes(e.info.codec)&&t.sampleCompositionTimeOffsets.length===0){h(e.info?.type==="audio");let s=Tt(e.info.codec),n=[],a=[];for(let o=0;o<t.sampleToChunk.length;o++){let c=t.sampleToChunk[o],l=t.sampleToChunk[o+1],u=(l?l.startChunkIndex:t.chunkOffsets.length)-c.startChunkIndex;for(let f=0;f<u;f++){let p=c.startSampleIndex+f*c.samplesPerChunk,k=p+c.samplesPerChunk,T=be(t.sampleTimingEntries,p,D=>D.startIndex),b=t.sampleTimingEntries[T],C=be(t.sampleTimingEntries,k,D=>D.startIndex),S=t.sampleTimingEntries[C],_=b.startDecodeTimestamp+(p-b.startIndex)*b.delta,A=S.startDecodeTimestamp+(k-S.startIndex)*S.delta-_,F=se(n);F&&F.delta===A?F.count++:n.push({startIndex:c.startChunkIndex+f,startDecodeTimestamp:_,count:1,delta:A});let B=c.samplesPerChunk*s.sampleSize*e.info.numberOfChannels;a.push(B)}c.startSampleIndex=c.startChunkIndex,c.samplesPerChunk=1}t.sampleTimingEntries=n,t.sampleSizes=a}if(t.sampleCompositionTimeOffsets.length>0){t.presentationTimestamps=[];for(let s of t.sampleTimingEntries)for(let n=0;n<s.count;n++)t.presentationTimestamps.push({presentationTimestamp:s.startDecodeTimestamp+n*s.delta,sampleIndex:s.startIndex+n});for(let s of t.sampleCompositionTimeOffsets)for(let n=0;n<s.count;n++){let a=s.startIndex+n,o=t.presentationTimestamps[a];o&&(o.presentationTimestamp+=s.offset)}t.presentationTimestamps.sort((s,n)=>s.presentationTimestamp-n.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let s=0;s<t.presentationTimestamps.length;s++)t.presentationTimestampIndexMap[t.presentationTimestamps[s].sampleIndex]=s}return t}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let t=this.reader.requestSliceRange(e,Mt,cr);t instanceof Promise&&(t=await t),h(t);let r=qt(t);h(r?.name==="moof");let i=this.reader.requestSlice(e,r.totalSize);i instanceof Promise&&(i=await i),h(i),this.traverseBox(i);let s=this.lastReadFragment;h(s&&s.moofOffset===e);for(let[,n]of s.trackData){let a=n.track,{fragmentPositionCache:o}=a;if(!n.startTimestampIsFinal){let l=a.fragmentLookupTable.find(u=>u.moofOffset===s.moofOffset);if(l)ds(n,l.timestamp);else{let u=be(o,s.moofOffset-1,f=>f.moofOffset);if(u!==-1){let f=o[u];ds(n,f.endTimestamp)}}n.startTimestampIsFinal=!0}let c=be(o,n.startTimestamp,l=>l.startTimestamp);(c===-1||o[c].moofOffset!==s.moofOffset)&&o.splice(c+1,0,{moofOffset:s.moofOffset,startTimestamp:n.startTimestamp,endTimestamp:n.endTimestamp})}return s}readContiguousBoxes(e){let t=e.filePos;for(;e.filePos-t<=e.length-Mt&&this.traverseBox(e););}*iterateContiguousBoxes(e){let t=e.filePos;for(;e.filePos-t<=e.length-Mt;){let r=e.filePos,i=qt(e);if(!i)break;yield{boxInfo:i,slice:e},e.filePos=r+i.totalSize}}traverseBox(e){var n,a,o,c,l,u,f,p,k,T,b,C,S,_,E,A,F,B,D,$,ye,ee,q,ie,ke,Ye,Ot,We,He,je,Ut,It,si;let t=e.filePos,r=qt(e);if(!r)return!1;let i=e.filePos,s=t+r.totalSize;switch(r.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"mvhd":{let g=j(e);e.skip(3),g===1?(e.skip(16),this.movieTimescale=L(e),this.movieDurationInTimescale=mt(e)):(e.skip(8),this.movieTimescale=L(e),this.movieDurationInTimescale=L(e))}break;case"trak":{let g={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:rt,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=g,this.readContiguousBoxes(e.slice(i,r.contentSize)),g.id!==-1&&g.timescale!==-1&&g.info!==null){if(g.info.type==="video"&&g.info.width!==-1){let N=g;g.inputTrack=new _r(this.input,new fl(N)),this.tracks.push(g)}else if(g.info.type==="audio"&&g.info.numberOfChannels!==-1){let N=g;g.inputTrack=new dt(this.input,new ml(N)),this.tracks.push(g)}}this.currentTrack=null}break;case"tkhd":{let g=this.currentTrack;if(!g)break;let N=j(e);if(!((Br(e)&1)!==0))break;if(N===0)e.skip(8),g.id=L(e),e.skip(4),g.durationInMovieTimescale=L(e);else if(N===1)e.skip(16),g.id=L(e),e.skip(4),g.durationInMovieTimescale=mt(e);else throw new Error("Incorrect track header version ".concat(N,"."));e.skip(16);let Y=[lr(e),lr(e),ls(e),lr(e),lr(e),ls(e),lr(e),lr(e),ls(e)],U=ut(Qi(bl(Y),90));h(U===0||U===90||U===180||U===270),g.rotation=U}break;case"elst":{let g=this.currentTrack;if(!g)break;let N=j(e);e.skip(3);let z=!1,M=0,Y=L(e);for(let U=0;U<Y;U++){let V=N===1?mt(e):L(e),ae=N===1?iu(e):dr(e),re=lr(e);if(V!==0){if(z){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(ae===-1){M+=V;continue}if(re!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}g.editListPreviousSegmentDurations=M,g.editListOffset=ae,z=!0}}}break;case"mdhd":{let g=this.currentTrack;if(!g)break;let N=j(e);e.skip(3),N===0?(e.skip(8),g.timescale=L(e),g.durationInMediaTimescale=L(e)):N===1&&(e.skip(16),g.timescale=L(e),g.durationInMediaTimescale=mt(e));let z=Le(e);if(z>0){g.languageCode="";for(let M=0;M<3;M++)g.languageCode=String.fromCharCode(96+(z&31))+g.languageCode,z>>=5;Hr(g.languageCode)||(g.languageCode=rt)}}break;case"hdlr":{let g=this.currentTrack;if(!g)break;e.skip(8);let N=Oe(e,4);N==="vide"?g.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:N==="soun"&&(g.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let g=this.currentTrack;if(!g)break;g.sampleTableByteOffset=t,this.readContiguousBoxes(e.slice(i,r.contentSize))}break;case"stsd":{let g=this.currentTrack;if(!g||g.info===null||g.sampleTable)break;let N=j(e);e.skip(3);let z=L(e);for(let M=0;M<z;M++){let Y=e.filePos,U=qt(e);if(!U)break;g.internalCodecId=U.name;let V=U.name.toLowerCase();if(g.info.type==="video")V==="avc1"?g.info.codec="avc":V==="hvc1"||V==="hev1"?g.info.codec="hevc":V==="vp08"?g.info.codec="vp8":V==="vp09"?g.info.codec="vp9":V==="av01"?g.info.codec="av1":console.warn("Unsupported video codec (sample entry type '".concat(U.name,"').")),e.skip(24),g.info.width=Le(e),g.info.height=Le(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,Y+U.totalSize-e.filePos));else{V==="mp4a"||(V==="opus"?g.info.codec="opus":V==="flac"?g.info.codec="flac":V==="twos"||V==="sowt"||V==="raw "||V==="in24"||V==="in32"||V==="fl32"||V==="fl64"||V==="lpcm"||V==="ipcm"||V==="fpcm"||(V==="ulaw"?g.info.codec="ulaw":V==="alaw"?g.info.codec="alaw":console.warn("Unsupported audio codec (sample entry type '".concat(U.name,"').")))),e.skip(8);let ae=Le(e);e.skip(6);let re=Le(e),te=Le(e);e.skip(4);let Ee=L(e)/65536;if(N===0&&ae>0){if(ae===1)e.skip(4),te=8*L(e),e.skip(8);else if(ae===2){e.skip(4),Ee=Za(e),re=L(e),e.skip(4),te=L(e);let Ae=L(e);if(e.skip(8),V==="lpcm"){let le=te+7>>3,ot=!!(Ae&1),Te=!!(Ae&2),dn=Ae&4?-1:0;te>0&&te<=64&&(ot?te===32&&(g.info.codec=Te?"pcm-f32be":"pcm-f32"):dn&1<<le-1?le===1?g.info.codec="pcm-s8":le===2?g.info.codec=Te?"pcm-s16be":"pcm-s16":le===3?g.info.codec=Te?"pcm-s24be":"pcm-s24":le===4&&(g.info.codec=Te?"pcm-s32be":"pcm-s32"):le===1&&(g.info.codec="pcm-u8")),g.info.codec===null&&console.warn("Unsupported PCM format.")}}}g.info.codec==="opus"&&(Ee=Tr),g.info.numberOfChannels=re,g.info.sampleRate=Ee,V==="twos"?te===8?g.info.codec="pcm-s8":te===16?g.info.codec="pcm-s16be":(console.warn("Unsupported sample size ".concat(te," for codec 'twos'.")),g.info.codec=null):V==="sowt"?te===8?g.info.codec="pcm-s8":te===16?g.info.codec="pcm-s16":(console.warn("Unsupported sample size ".concat(te," for codec 'sowt'.")),g.info.codec=null):V==="raw "?g.info.codec="pcm-u8":V==="in24"?g.info.codec="pcm-s24be":V==="in32"?g.info.codec="pcm-s32be":V==="fl32"?g.info.codec="pcm-f32be":V==="fl64"?g.info.codec="pcm-f64be":V==="ipcm"?g.info.codec="pcm-s16be":V==="fpcm"&&(g.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,Y+U.totalSize-e.filePos))}}}break;case"avcC":{let g=this.currentTrack;if(!g)break;h(g.info),g.info.codecDescription=Z(e,r.contentSize)}break;case"hvcC":{let g=this.currentTrack;if(!g)break;h(g.info),g.info.codecDescription=Z(e,r.contentSize)}break;case"vpcC":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="video"),e.skip(4);let N=j(e),z=j(e),M=j(e),Y=M>>4,U=M>>1&7,V=M&1,ae=j(e),re=j(e),te=j(e);g.info.vp9CodecInfo={profile:N,level:z,bitDepth:Y,chromaSubsampling:U,videoFullRangeFlag:V,colourPrimaries:ae,transferCharacteristics:re,matrixCoefficients:te}}break;case"av1C":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="video"),e.skip(1);let N=j(e),z=N>>5,M=N&31,Y=j(e),U=Y>>7,V=Y>>6&1,ae=Y>>5&1,re=Y>>4&1,te=Y>>3&1,Ee=Y>>2&1,Ae=Y&3,le=z===2&&V?ae?12:10:V?10:8;g.info.av1CodecInfo={profile:z,level:M,tier:U,bitDepth:le,monochrome:re,chromaSubsamplingX:te,chromaSubsamplingY:Ee,chromaSamplePosition:Ae}}break;case"colr":{let g=this.currentTrack;if(!g||(h(g.info?.type==="video"),Oe(e,4)!=="nclx"))break;let z=Le(e),M=Le(e),Y=Le(e),U=!!(j(e)&128);g.info.colorSpace={primaries:ir[z],transfer:Vr[M],matrix:Wr[Y],fullRange:U}}break;case"wave":this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"esds":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="audio"),e.skip(4);let N=j(e);h(N===3),us(e),e.skip(2);let z=j(e),M=(z&128)!==0,Y=(z&64)!==0,U=(z&32)!==0;if(M&&e.skip(2),Y){let Ee=j(e);e.skip(Ee)}U&&e.skip(2);let V=j(e);h(V===4);let ae=us(e),re=e.filePos,te=j(e);if(te===64||te===103?(g.info.codec="aac",g.info.aacCodecInfo={isMpeg2:te===103}):te===105||te===107?g.info.codec="mp3":te===221?g.info.codec="vorbis":console.warn("Unsupported audio codec (objectTypeIndication ".concat(te,") - discarding track.")),e.skip(12),ae>e.filePos-re){let Ee=j(e);h(Ee===5);let Ae=us(e);if(g.info.codecDescription=Z(e,Ae),g.info.codec==="aac"){let le=Ji(g.info.codecDescription);le.numberOfChannels!==null&&(g.info.numberOfChannels=le.numberOfChannels),le.sampleRate!==null&&(g.info.sampleRate=le.sampleRate)}}}break;case"enda":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="audio"),Le(e)&255&&(g.info.codec==="pcm-s16be"?g.info.codec="pcm-s16":g.info.codec==="pcm-s24be"?g.info.codec="pcm-s24":g.info.codec==="pcm-s32be"?g.info.codec="pcm-s32":g.info.codec==="pcm-f32be"?g.info.codec="pcm-f32":g.info.codec==="pcm-f64be"&&(g.info.codec="pcm-f64"))}break;case"pcmC":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="audio"),e.skip(4);let z=!!(j(e)&1),M=j(e);g.info.codec==="pcm-s16be"?z?M===16?g.info.codec="pcm-s16":M===24?g.info.codec="pcm-s24":M===32?g.info.codec="pcm-s32":(console.warn("Invalid ipcm sample size ".concat(M,".")),g.info.codec=null):M===16?g.info.codec="pcm-s16be":M===24?g.info.codec="pcm-s24be":M===32?g.info.codec="pcm-s32be":(console.warn("Invalid ipcm sample size ".concat(M,".")),g.info.codec=null):g.info.codec==="pcm-f32be"&&(z?M===32?g.info.codec="pcm-f32":M===64?g.info.codec="pcm-f64":(console.warn("Invalid fpcm sample size ".concat(M,".")),g.info.codec=null):M===32?g.info.codec="pcm-f32be":M===64?g.info.codec="pcm-f64be":(console.warn("Invalid fpcm sample size ".concat(M,".")),g.info.codec=null));break}case"dOps":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="audio"),e.skip(1);let N=j(e),z=Le(e),M=L(e),Y=Ms(e),U=j(e),V;U!==0?V=Z(e,2+N):V=new Uint8Array(0);let ae=new Uint8Array(19+V.byteLength),re=new DataView(ae.buffer);re.setUint32(0,1332770163,!1),re.setUint32(4,1214603620,!1),re.setUint8(8,1),re.setUint8(9,N),re.setUint16(10,z,!0),re.setUint32(12,M,!0),re.setInt16(16,Y,!0),re.setUint8(18,U),ae.set(V,19),g.info.codecDescription=ae,g.info.numberOfChannels=N}break;case"dfLa":{let g=this.currentTrack;if(!g)break;h(g.info?.type==="audio"),e.skip(4);let N=127,z=128,M=e.filePos;for(;e.filePos<s;){let re=j(e),te=Br(e);if((re&N)===0){e.skip(10);let Ae=L(e),le=Ae>>>12,ot=(Ae>>9&7)+1;g.info.sampleRate=le,g.info.numberOfChannels=ot,e.skip(20)}else e.skip(te);if(re&z)break}let Y=e.filePos;e.filePos=M;let U=Z(e,Y-M),V=new Uint8Array(4+U.byteLength);new DataView(V.buffer).setUint32(0,1716281667,!1),V.set(U,4),g.info.codecDescription=V}break;case"stts":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4);let N=L(e),z=0,M=0;for(let Y=0;Y<N;Y++){let U=L(e),V=L(e);g.sampleTable.sampleTimingEntries.push({startIndex:z,startDecodeTimestamp:M,count:U,delta:V}),z+=U,M+=U*V}}break;case"ctts":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4);let N=L(e),z=0;for(let M=0;M<N;M++){let Y=L(e),U=dr(e);g.sampleTable.sampleCompositionTimeOffsets.push({startIndex:z,count:Y,offset:U}),z+=Y}}break;case"stsz":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4);let N=L(e),z=L(e);if(N===0)for(let M=0;M<z;M++){let Y=L(e);g.sampleTable.sampleSizes.push(Y)}else g.sampleTable.sampleSizes.push(N)}break;case"stz2":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4),e.skip(3);let N=j(e),z=L(e),M=Z(e,Math.ceil(z*N/8)),Y=new he(M);for(let U=0;U<z;U++){let V=Y.readBits(N);g.sampleTable.sampleSizes.push(V)}}break;case"stss":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4),g.sampleTable.keySampleIndices=[];let N=L(e);for(let z=0;z<N;z++){let M=L(e)-1;g.sampleTable.keySampleIndices.push(M)}g.sampleTable.keySampleIndices[0]!==0&&g.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4);let N=L(e);for(let M=0;M<N;M++){let Y=L(e)-1,U=L(e),V=L(e);g.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:Y,samplesPerChunk:U,sampleDescriptionIndex:V})}let z=0;for(let M=0;M<g.sampleTable.sampleToChunk.length;M++)if(g.sampleTable.sampleToChunk[M].startSampleIndex=z,M<g.sampleTable.sampleToChunk.length-1){let U=g.sampleTable.sampleToChunk[M+1].startChunkIndex-g.sampleTable.sampleToChunk[M].startChunkIndex;z+=U*g.sampleTable.sampleToChunk[M].samplesPerChunk}}break;case"stco":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4);let N=L(e);for(let z=0;z<N;z++){let M=L(e);g.sampleTable.chunkOffsets.push(M)}}break;case"co64":{let g=this.currentTrack;if(!g||!g.sampleTable)break;e.skip(4);let N=L(e);for(let z=0;z<N;z++){let M=mt(e);g.sampleTable.chunkOffsets.push(M)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"mehd":{let g=j(e);e.skip(3);let N=g===1?mt(e):L(e);this.movieDurationInTimescale=N}break;case"trex":{e.skip(4);let g=L(e),N=L(e),z=L(e),M=L(e),Y=L(e);this.fragmentTrackDefaults.push({trackId:g,defaultSampleDescriptionIndex:N,defaultSampleDuration:z,defaultSampleSize:M,defaultSampleFlags:Y})}break;case"tfra":{let g=j(e);e.skip(3);let N=L(e),z=this.tracks.find(le=>le.id===N);if(!z)break;let M=L(e),Y=(M&48)>>4,U=(M&12)>>2,V=M&3,ae=[j,Le,Br,L],re=ae[Y],te=ae[U],Ee=ae[V],Ae=L(e);for(let le=0;le<Ae;le++){let ot=g===1?mt(e):L(e),Te=g===1?mt(e):L(e);re(e),te(e),Ee(e),z.fragmentLookupTable.push({timestamp:ot,moofOffset:Te})}z.fragmentLookupTable.sort((le,ot)=>le.timestamp-ot.timestamp);for(let le=0;le<z.fragmentLookupTable.length-1;le++){let ot=z.fragmentLookupTable[le],Te=z.fragmentLookupTable[le+1];ot.timestamp===Te.timestamp&&(z.fragmentLookupTable.splice(le+1,1),le--)}}break;case"moof":this.currentFragment={moofOffset:t,moofSize:r.totalSize,implicitBaseDataOffset:t,trackData:new Map},this.readContiguousBoxes(e.slice(i,r.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(h(this.currentFragment),this.readContiguousBoxes(e.slice(i,r.contentSize)),this.currentTrack){let g=this.currentFragment.trackData.get(this.currentTrack.id);if(g){let{currentFragmentState:N}=this.currentTrack;h(N),N.startTimestamp!==null&&(ds(g,N.startTimestamp),g.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{h(this.currentFragment),e.skip(1);let g=Br(e),N=!!(g&1),z=!!(g&2),M=!!(g&8),Y=!!(g&16),U=!!(g&32),V=!!(g&65536),ae=!!(g&131072),re=L(e),te=this.tracks.find(Ae=>Ae.id===re);if(!te)break;let Ee=this.fragmentTrackDefaults.find(Ae=>Ae.trackId===re);this.currentTrack=te,te.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:Ee?.defaultSampleDescriptionIndex??null,defaultSampleDuration:Ee?.defaultSampleDuration??null,defaultSampleSize:Ee?.defaultSampleSize??null,defaultSampleFlags:Ee?.defaultSampleFlags??null,startTimestamp:null},N?te.currentFragmentState.baseDataOffset=mt(e):ae&&(te.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),z&&(te.currentFragmentState.sampleDescriptionIndex=L(e)),M&&(te.currentFragmentState.defaultSampleDuration=L(e)),Y&&(te.currentFragmentState.defaultSampleSize=L(e)),U&&(te.currentFragmentState.defaultSampleFlags=L(e)),V&&(te.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let g=this.currentTrack;if(!g)break;h(g.currentFragmentState);let N=j(e);e.skip(3);let z=N===0?L(e):mt(e);g.currentFragmentState.startTimestamp=z}break;case"trun":{let g=this.currentTrack;if(!g)break;if(h(this.currentFragment),h(g.currentFragmentState),this.currentFragment.trackData.has(g.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let N=j(e),z=Br(e),M=!!(z&1),Y=!!(z&4),U=!!(z&256),V=!!(z&512),ae=!!(z&1024),re=!!(z&2048),te=L(e),Ee=g.currentFragmentState.baseDataOffset;M&&(Ee+=dr(e));let Ae=null;Y&&(Ae=L(e));let le=Ee;if(te===0){this.currentFragment.implicitBaseDataOffset=le;break}let ot=0,Te={track:g,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(g.id,Te);for(let st=0;st<te;st++){let gt;U?gt=L(e):(h(g.currentFragmentState.defaultSampleDuration!==null),gt=g.currentFragmentState.defaultSampleDuration);let Zt;V?Zt=L(e):(h(g.currentFragmentState.defaultSampleSize!==null),Zt=g.currentFragmentState.defaultSampleSize);let Dr;ae?Dr=L(e):(h(g.currentFragmentState.defaultSampleFlags!==null),Dr=g.currentFragmentState.defaultSampleFlags),st===0&&Ae!==null&&(Dr=Ae);let hn=0;re&&(N===0?hn=L(e):hn=dr(e));let lh=!(Dr&65536);Te.samples.push({presentationTimestamp:ot+hn,duration:gt,byteOffset:le,byteSize:Zt,isKeyFrame:lh}),le+=Zt,ot+=gt}Te.presentationTimestamps=Te.samples.map((st,gt)=>({presentationTimestamp:st.presentationTimestamp,sampleIndex:gt})).sort((st,gt)=>st.presentationTimestamp-gt.presentationTimestamp);for(let st=0;st<Te.presentationTimestamps.length;st++){let gt=Te.presentationTimestamps[st],Zt=Te.samples[gt.sampleIndex];if(Te.firstKeyFrameTimestamp===null&&Zt.isKeyFrame&&(Te.firstKeyFrameTimestamp=Zt.presentationTimestamp),st<Te.presentationTimestamps.length-1){let Dr=Te.presentationTimestamps[st+1];Zt.duration=Dr.presentationTimestamp-gt.presentationTimestamp}}let dn=Te.samples[Te.presentationTimestamps[0].sampleIndex],Ro=Te.samples[se(Te.presentationTimestamps).sampleIndex];Te.startTimestamp=dn.presentationTimestamp,Te.endTimestamp=Ro.presentationTimestamp+Ro.duration,this.currentFragment.implicitBaseDataOffset=le}break;case"udta":{let g=this.iterateContiguousBoxes(e.slice(i,r.contentSize));for(let{boxInfo:N,slice:z}of g){if(N.name!=="meta"&&!this.currentTrack){let M=z.filePos;(n=this.metadataTags).raw??(n.raw={}),N.name[0]==="\xA9"?(a=this.metadataTags.raw)[o=N.name]??(a[o]=vt(z)):(c=this.metadataTags.raw)[l=N.name]??(c[l]=Z(z,N.contentSize)),z.filePos=M}switch(N.name){case"meta":z.skip(-N.headerSize),this.traverseBox(z);break;case"\xA9nam":case"name":this.currentTrack?this.currentTrack.name=Me.decode(Z(z,N.contentSize)):(u=this.metadataTags).title??(u.title=vt(z));break;case"\xA9des":this.currentTrack||((f=this.metadataTags).description??(f.description=vt(z)));break;case"\xA9ART":this.currentTrack||((p=this.metadataTags).artist??(p.artist=vt(z)));break;case"\xA9alb":this.currentTrack||((k=this.metadataTags).album??(k.album=vt(z)));break;case"albr":this.currentTrack||((T=this.metadataTags).albumArtist??(T.albumArtist=vt(z)));break;case"\xA9gen":this.currentTrack||((b=this.metadataTags).genre??(b.genre=vt(z)));break;case"\xA9day":if(!this.currentTrack){let M=new Date(vt(z));Number.isNaN(M.getTime())||((C=this.metadataTags).date??(C.date=M))}break;case"\xA9cmt":this.currentTrack||((S=this.metadataTags).comment??(S.comment=vt(z)));break;case"\xA9lyr":this.currentTrack||((_=this.metadataTags).lyrics??(_.lyrics=vt(z)));break}}}break;case"meta":{if(this.currentTrack)break;let N=L(e)!==0;this.currentMetadataKeys=new Map,N?this.readContiguousBoxes(e.slice(i,r.contentSize)):this.readContiguousBoxes(e.slice(i+4,r.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);let g=L(e);for(let N=0;N<g;N++){let z=L(e);e.skip(4);let M=Me.decode(Z(e,z-8));this.currentMetadataKeys.set(N+1,M)}}break;case"ilst":{if(!this.currentMetadataKeys)break;let g=this.iterateContiguousBoxes(e.slice(i,r.contentSize));for(let{boxInfo:N,slice:z}of g){let M=N.name,Y=(M.charCodeAt(0)<<24)+(M.charCodeAt(1)<<16)+(M.charCodeAt(2)<<8)+M.charCodeAt(3);this.currentMetadataKeys.has(Y)&&(M=this.currentMetadataKeys.get(Y));let U=dl(z);switch((E=this.metadataTags).raw??(E.raw={}),(A=this.metadataTags.raw)[M]??(A[M]=U),M){case"\xA9nam":case"titl":case"com.apple.quicktime.title":case"title":typeof U=="string"&&((F=this.metadataTags).title??(F.title=U));break;case"\xA9des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof U=="string"&&((B=this.metadataTags).description??(B.description=U));break;case"\xA9ART":case"com.apple.quicktime.artist":case"artist":typeof U=="string"&&((D=this.metadataTags).artist??(D.artist=U));break;case"\xA9alb":case"albm":case"com.apple.quicktime.album":case"album":typeof U=="string"&&(($=this.metadataTags).album??($.album=U));break;case"aART":case"album_artist":typeof U=="string"&&((ye=this.metadataTags).albumArtist??(ye.albumArtist=U));break;case"\xA9cmt":case"com.apple.quicktime.comment":case"comment":typeof U=="string"&&((ee=this.metadataTags).comment??(ee.comment=U));break;case"\xA9gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof U=="string"&&((q=this.metadataTags).genre??(q.genre=U));break;case"\xA9lyr":case"lyrics":typeof U=="string"&&((ie=this.metadataTags).lyrics??(ie.lyrics=U));break;case"\xA9day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof U=="string"){let V=new Date(U);Number.isNaN(V.getTime())||((ke=this.metadataTags).date??(ke.date=V))}break;case"covr":case"com.apple.quicktime.artwork":U instanceof sr?((Ye=this.metadataTags).images??(Ye.images=[]),this.metadataTags.images.push({data:U.data,kind:"coverFront",mimeType:U.mimeType})):U instanceof Uint8Array&&((Ot=this.metadataTags).images??(Ot.images=[]),this.metadataTags.images.push({data:U,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof U=="string"){let V=U.split("/"),ae=Number.parseInt(V[0],10),re=V[1]&&Number.parseInt(V[1],10);Number.isInteger(ae)&&ae>0&&((We=this.metadataTags).trackNumber??(We.trackNumber=ae)),re&&Number.isInteger(re)&&re>0&&((He=this.metadataTags).tracksTotal??(He.tracksTotal=re))}break;case"trkn":if(U instanceof Uint8Array&&U.length>=6){let V=oe(U),ae=V.getUint16(2,!1),re=V.getUint16(4,!1);ae>0&&((je=this.metadataTags).trackNumber??(je.trackNumber=ae)),re>0&&((Ut=this.metadataTags).tracksTotal??(Ut.tracksTotal=re))}break;case"disc":case"disk":if(U instanceof Uint8Array&&U.length>=6){let V=oe(U),ae=V.getUint16(2,!1),re=V.getUint16(4,!1);ae>0&&((It=this.metadataTags).discNumber??(It.discNumber=ae)),re>0&&((si=this.metadataTags).discsTotal??(si.discsTotal=re))}break}}}break}return e.filePos=s,!0}},ra=class{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){let t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(null,r=>r.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return pi(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){let r=this.mapTimestampIntoTimescale(e),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=ia(i,r),n=await this.fetchPacketForSampleIndex(s,t);return!sa(i)||!this.internalTrack.demuxer.isFragmented?n:this.performFragmentedLookup(null,a=>{let o=a.trackData.get(this.internalTrack.id);if(!o)return{sampleIndex:-1,correctSampleFound:!1};let c=be(o.presentationTimestamps,r,f=>f.presentationTimestamp),l=c!==-1?o.presentationTimestamps[c].sampleIndex:-1,u=c!==-1&&r<o.endTimestamp;return{sampleIndex:l,correctSampleFound:u}},r,r,t)}async getNextPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,t);let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(i.fragment,s=>{if(s===i.fragment){let n=s.trackData.get(this.internalTrack.id);if(i.sampleIndex+1<n.samples.length)return{sampleIndex:i.sampleIndex+1,correctSampleFound:!0}}else if(s.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.mapTimestampIntoTimescale(e),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=ia(i,r),n=s===-1?-1:gl(i,s),a=await this.fetchPacketForSampleIndex(n,t);return!sa(i)||!this.internalTrack.demuxer.isFragmented?a:this.performFragmentedLookup(null,o=>{let c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};let l=kn(c.presentationTimestamps,p=>c.samples[p.sampleIndex].isKeyFrame&&p.presentationTimestamp<=r),u=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,f=l!==-1&&r<c.endTimestamp;return{sampleIndex:u,correctSampleFound:f}},r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0){let s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),n=wl(s,r);return this.fetchPacketForSampleIndex(n,t)}let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(i.fragment,s=>{if(s===i.fragment){let a=s.trackData.get(this.internalTrack.id).samples.findIndex((o,c)=>o.isKeyFrame&&c>i.sampleIndex);if(a!==-1)return{sampleIndex:a,correctSampleFound:!0}}else{let n=s.trackData.get(this.internalTrack.id);if(n&&n.firstKeyFrameTimestamp!==null){let a=n.samples.findIndex(o=>o.isKeyFrame);return h(a!==-1),{sampleIndex:a,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=pl(r,e);if(!i)return null;let s;if(t.metadataOnly)s=nt;else{let c=this.internalTrack.demuxer.reader.requestSlice(i.sampleOffset,i.sampleSize);c instanceof Promise&&(c=await c),h(c),s=Z(c,i.sampleSize)}let n=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,a=i.duration/this.internalTrack.timescale,o=new Ce(s,i.isKeyFrame?"key":"delta",n,a,e,i.sampleSize);return this.packetToSampleIndex.set(o,e),o}async fetchPacketInFragment(e,t,r){if(t===-1)return null;let s=e.trackData.get(this.internalTrack.id).samples[t];h(s);let n;if(r.metadataOnly)n=nt;else{let l=this.internalTrack.demuxer.reader.requestSlice(s.byteOffset,s.byteSize);l instanceof Promise&&(l=await l),h(l),n=Z(l,s.byteSize)}let a=(s.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=s.duration/this.internalTrack.timescale,c=new Ce(n,s.isKeyFrame?"key":"delta",a,o,e.moofOffset+t,s.byteSize);return this.packetToFragmentLocation.set(c,{fragment:e,sampleIndex:t}),c}async performFragmentedLookup(e,t,r,i,s){let n=this.internalTrack.demuxer,a=null,o=null,c=-1;if(e){let{sampleIndex:b,correctSampleFound:C}=t(e);if(C)return this.fetchPacketInFragment(e,b,s);b!==-1&&(o=e,c=b)}let l=be(this.internalTrack.fragmentLookupTable,r,b=>b.timestamp),u=l!==-1?this.internalTrack.fragmentLookupTable[l]:null,f=be(this.internalTrack.fragmentPositionCache,r,b=>b.startTimestamp),p=f!==-1?this.internalTrack.fragmentPositionCache[f]:null,k=Math.max(u?.moofOffset??0,p?.moofOffset??0)||null,T;for(e?k===null||e.moofOffset>=k?(T=e.moofOffset+e.moofSize,a=e):T=k:T=k??0;;){if(a){let _=a.trackData.get(this.internalTrack.id);if(_&&_.startTimestamp>i)break}let b=n.reader.requestSliceRange(T,Mt,cr);if(b instanceof Promise&&(b=await b),!b)break;let C=T,S=qt(b);if(!S)break;if(S.name==="moof"){a=await n.readFragment(C);let{sampleIndex:_,correctSampleFound:E}=t(a);if(E)return this.fetchPacketInFragment(a,_,s);_!==-1&&(o=a,c=_)}T=C+S.totalSize}if(u&&(!o||o.moofOffset<u.moofOffset)){let b=this.internalTrack.fragmentLookupTable[l-1];h(!b||b.timestamp<u.timestamp);let C=b?.timestamp??-1/0;return this.performFragmentedLookup(null,t,C,i,s)}return o?this.fetchPacketInFragment(o,c,s):null}},fl=class extends ra{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??(this.decoderConfigPromise=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&$n(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&jn(e.data)}return{codec:Mn(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})()):null}},ml=class extends ra{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??(this.decoderConfig={codec:Fn(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}):null}},ia=(e,t)=>{if(e.presentationTimestamps){let r=be(e.presentationTimestamps,t,i=>i.presentationTimestamp);return r===-1?-1:e.presentationTimestamps[r].sampleIndex}else{let r=be(e.sampleTimingEntries,t,s=>s.startDecodeTimestamp);if(r===-1)return-1;let i=e.sampleTimingEntries[r];return i.startIndex+Math.min(Math.floor((t-i.startDecodeTimestamp)/i.delta),i.count-1)}},pl=(e,t)=>{let r=be(e.sampleTimingEntries,t,S=>S.startIndex),i=e.sampleTimingEntries[r];if(!i||i.startIndex+i.count<=t)return null;let n=i.startDecodeTimestamp+(t-i.startIndex)*i.delta,a=be(e.sampleCompositionTimeOffsets,t,S=>S.startIndex),o=e.sampleCompositionTimeOffsets[a];o&&t-o.startIndex<o.count&&(n+=o.offset);let c=e.sampleSizes[Math.min(t,e.sampleSizes.length-1)],l=be(e.sampleToChunk,t,S=>S.startSampleIndex),u=e.sampleToChunk[l];h(u);let f=u.startChunkIndex+Math.floor((t-u.startSampleIndex)/u.samplesPerChunk),p=e.chunkOffsets[f],k=u.startSampleIndex+(f-u.startChunkIndex)*u.samplesPerChunk,T=0,b=p;if(e.sampleSizes.length===1)b+=c*(t-k),T+=c*u.samplesPerChunk;else for(let S=k;S<k+u.samplesPerChunk;S++){let _=e.sampleSizes[S];S<t&&(b+=_),T+=_}let C=i.delta;if(e.presentationTimestamps){let S=e.presentationTimestampIndexMap[t];h(S!==void 0),S<e.presentationTimestamps.length-1&&(C=e.presentationTimestamps[S+1].presentationTimestamp-n)}return{presentationTimestamp:n,duration:C,sampleOffset:b,sampleSize:c,chunkOffset:p,chunkSize:T,isKeyFrame:e.keySampleIndices?ji(e.keySampleIndices,t,S=>S)!==-1:!0}},gl=(e,t)=>{if(!e.keySampleIndices)return t;let r=be(e.keySampleIndices,t,i=>i);return e.keySampleIndices[r]??-1},wl=(e,t)=>{if(!e.keySampleIndices)return t+1;let r=be(e.keySampleIndices,t,i=>i);return e.keySampleIndices[r+1]??-1},ds=(e,t)=>{e.startTimestamp+=t,e.endTimestamp+=t;for(let r of e.samples)r.presentationTimestamp+=t;for(let r of e.presentationTimestamps)r.presentationTimestamp+=t},bl=e=>{let[t,,,r]=e,i=Math.hypot(t,r),s=t/i,n=r/i,a=-Math.atan2(n,s)*(180/Math.PI);return Number.isFinite(a)?a:0},sa=e=>e.sampleSizes.length===0,hs=class{constructor(e){this.value=e}},fs=class{constructor(e){this.value=e}},na=class{constructor(e){this.value=e}},jt=class{constructor(e){this.value=e}},yl=[440786851,408125543],Yr=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],Pi=[...yl,...Yr],aa=e=>e<256?1:e<65536?2:e<1<<24?3:e<2**32?4:e<2**40?5:6,oa=e=>e<1n<<8n?1:e<1n<<16n?2:e<1n<<24n?3:e<1n<<32n?4:e<1n<<40n?5:e<1n<<48n?6:e<1n<<56n?7:8,ca=e=>e>=-64&&e<64?1:e>=-8192&&e<8192?2:e>=-(1<<20)&&e<1<<20?3:e>=-(1<<27)&&e<1<<27?4:e>=-(2**34)&&e<2**34?5:6,kl=e=>{if(e<127)return 1;if(e<16383)return 2;if(e<(1<<21)-1)return 3;if(e<(1<<28)-1)return 4;if(e<2**35-1)return 5;if(e<2**42-1)return 6;throw new Error("EBML varint size not supported "+e)},Tl=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=aa(e)){let r=0;switch(t){case 6:this.helperView.setUint8(r++,e/2**40|0);case 5:this.helperView.setUint8(r++,e/2**32|0);case 4:this.helperView.setUint8(r++,e>>24);case 3:this.helperView.setUint8(r++,e>>16);case 2:this.helperView.setUint8(r++,e>>8);case 1:this.helperView.setUint8(r++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,r))}writeUnsignedBigInt(e,t=oa(e)){let r=0;for(let i=t-1;i>=0;i--)this.helperView.setUint8(r++,Number(e>>BigInt(i*8)&0xffn));this.writer.write(this.helper.subarray(0,r))}writeSignedInt(e,t=ca(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=kl(e)){let r=0;switch(t){case 1:this.helperView.setUint8(r++,128|e);break;case 2:this.helperView.setUint8(r++,64|e>>8),this.helperView.setUint8(r++,e);break;case 3:this.helperView.setUint8(r++,32|e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 4:this.helperView.setUint8(r++,16|e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 5:this.helperView.setUint8(r++,8|e/2**32&7),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 6:this.helperView.setUint8(r++,4|e/2**40&3),this.helperView.setUint8(r++,e/2**32|0),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let t=this.writer.getPos(),r=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let i=this.writer.getPos();if(this.dataOffsets.set(e,i),this.writeEBML(e.data),e.size!==-1){let s=this.writer.getPos()-i,n=this.writer.getPos();this.writer.seek(t),this.writeVarInt(s,r),this.writer.seek(n)}}else if(typeof e.data=="number"){let t=e.size??aa(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="bigint"){let t=e.size??oa(e.data);this.writeVarInt(t),this.writeUnsignedBigInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof hs)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof fs)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof na){let t=e.size??ca(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof jt){let t=we.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else $e(e.data)}},ms=8,ht=2,Ft=2*ms,la=e=>{let t=j(e);if(e.skip(-1),t===0)return null;let r=1,i=128;for(;(t&i)===0;)r++,i>>=1;return r},Zr=e=>{let t=j(e);if(t===0)return null;let r=1,i=128;for(;(t&i)===0;)r++,i>>=1;let s=t&i-1;for(let n=1;n<r;n++)s*=256,s+=j(e);return s},ue=(e,t)=>{if(t<1||t>8)throw new Error("Bad unsigned int size "+t);let r=0;for(let i=0;i<t;i++)r*=256,r+=j(e);return r},Sl=(e,t)=>{if(t<1)throw new Error("Bad unsigned int size "+t);let r=0n;for(let i=0;i<t;i++)r<<=8n,r+=BigInt(j(e));return r},vl=(e,t)=>{let r=ue(e,t);return r&1<<t*8-1&&(r-=2**(t*8)),r},ps=e=>{let t=la(e);return t===null?null:ue(e,t)},ua=e=>{let t=j(e);return t===255?t=null:(e.skip(-1),t=Zr(e),t===72057594037927940&&(t=null)),t},zt=e=>{let t=ps(e);if(t===null)return null;let r=ua(e);return{id:t,size:r}},xr=(e,t)=>{let r=Z(e,t),i=0;for(;i<t&&r[i]!==0;)i+=1;return String.fromCharCode(...r.subarray(0,i))},Jr=(e,t)=>{let r=Z(e,t),i=0;for(;i<t&&r[i]!==0;)i+=1;return Me.decode(r.subarray(0,i))},gs=(e,t)=>{if(t===0)return 0;if(t!==4&&t!==8)throw new Error("Bad float size "+t);return t===4?nu(e):Za(e)},ws=async(e,t,r,i)=>{let s=new Set(r),n=t;for(;i===null||n<i;){let a=e.requestSliceRange(n,ht,Ft);if(a instanceof Promise&&(a=await a),!a)break;let o=zt(a);if(!o)break;if(s.has(o.id))return{pos:n,found:!0};Qt(o.size),n=a.filePos+o.size}return{pos:i!==null&&i>n?i:n,found:!1}},da=async(e,t,r,i)=>{let n=new Set(r),a=t;for(;a<i;){let o=e.requestSliceRange(a,0,Math.min(65536,i-a));if(o instanceof Promise&&(o=await o),!o||o.length<ms)break;for(let c=0;c<o.length-ms;c++){o.filePos=a;let l=ps(o);if(l!==null&&n.has(l))return a;a++}}return null},ft={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function Qt(e){if(e===null)throw new Error("Undefined element size is used in a place where it is not supported.")}var ha=e=>{let r=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isWebM?"webm":"x-matroska");if(e.codecStrings.length>0){let i=[...new Set(e.codecStrings.filter(Boolean))];r+='; codecs="'.concat(i.join(", "),'"')}return r},bs=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],fa=10*2**20,Cl=class extends or{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentBlockAdditional=null,this.currentCueTime=null,this.currentDecodingInstruction=null,this.currentTagTargetIsMovie=!0,this.currentSimpleTagName=null,this.currentAttachedFile=null,this.isWebM=!1,this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(t=>t.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.getCodecParameterString()));return ha({isWebM:this.isWebM,hasVideo:this.segments.some(r=>r.tracks.some(i=>i.info?.type==="video")),hasAudio:this.segments.some(r=>r.tracks.some(i=>i.info?.type==="audio")),codecStrings:t.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(let t of this.segments)t.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(t),t.metadataTagsCollected=!0);let e={};for(let t of this.segments)e={...e,...t.metadataTags};return e}readMetadata(){return this.readMetadataPromise??(this.readMetadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,ht,Ft);if(t instanceof Promise&&(t=await t),!t)break;let r=zt(t);if(!r)break;let i=r.id,s=r.size,n=t.filePos;if(i===440786851){Qt(s);let a=this.reader.requestSlice(n,s);if(a instanceof Promise&&(a=await a),!a)break;this.readContiguousElements(a)}else if(i===408125543){if(await this.readSegment(n,s),s===null||this.reader.fileSize===null)break}else if(i===524531317){if(this.reader.fileSize===null)break;s===null&&(s=(await ws(this.reader,n,Pi,this.reader.fileSize)).pos-n);let a=se(this.segments);a&&(a.elementEndPos=n+s)}Qt(s),e=n+s}})())}async readSegment(e,t){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:t===null?null:e+t,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let r=e;for(;this.currentSegment.elementEndPos===null||r<this.currentSegment.elementEndPos;){let a=this.reader.requestSliceRange(r,ht,Ft);if(a instanceof Promise&&(a=await a),!a)break;let o=r,c=zt(a);if(!c||!Yr.includes(c.id)&&c.id!==236){let k=await da(this.reader,o,Yr,Math.min(this.currentSegment.elementEndPos??1/0,o+fa));if(k){r=k;continue}else break}let{id:l,size:u}=c,f=a.filePos,p=bs.findIndex(k=>k.id===l);if(p!==-1){let k=bs[p].flag;this.currentSegment[k]=!0,Qt(u);let T=this.reader.requestSlice(f,u);T instanceof Promise&&(T=await T),T&&this.readContiguousElements(T)}else if(l===307544935||l===423732329){l===307544935?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,Qt(u);let k=this.reader.requestSlice(f,u);k instanceof Promise&&(k=await k),k&&this.readContiguousElements(k)}else if(l===524531317){this.currentSegment.clusterSeekStartPos=o;break}if(u===null)break;r=f+u}if(this.currentSegment.seekEntries.sort((a,o)=>a.segmentPosition-o.segmentPosition),this.reader.fileSize!==null)for(let a of this.currentSegment.seekEntries){let o=bs.find(k=>k.id===a.id);if(!o||this.currentSegment[o.flag])continue;let c=this.reader.requestSliceRange(e+a.segmentPosition,ht,Ft);if(c instanceof Promise&&(c=await c),!c)continue;let l=zt(c);if(!l)continue;let{id:u,size:f}=l;if(u!==o.id)continue;Qt(f),this.currentSegment[o.flag]=!0;let p=this.reader.requestSlice(c.filePos,f);p instanceof Promise&&(p=await p),p&&this.readContiguousElements(p)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((a,o)=>Number(o.isDefault)-Number(a.isDefault));let i=new Map(this.currentSegment.tracks.map(a=>[a.id,a]));for(let a of this.currentSegment.cuePoints){let o=i.get(a.trackId);o&&o.cuePoints.push(a)}for(let a of this.currentSegment.tracks){a.cuePoints.sort((o,c)=>o.time-c.time);for(let o=0;o<a.cuePoints.length-1;o++){let c=a.cuePoints[o],l=a.cuePoints[o+1];c.time===l.time&&(a.cuePoints.splice(o+1,1),o--)}}let s=null,n=-1/0;for(let a of this.currentSegment.tracks)a.cuePoints.length>n&&(n=a.cuePoints.length,s=a);for(let a of this.currentSegment.tracks)a.cuePoints.length===0&&(a.cuePoints=s.cuePoints);this.currentSegment=null}async readCluster(e,t){if(t.lastReadCluster?.elementStartPos===e)return t.lastReadCluster;let r=this.reader.requestSliceRange(e,ht,Ft);r instanceof Promise&&(r=await r),h(r);let i=e,s=zt(r);h(s);let n=s.id;h(n===524531317);let a=s.size,o=r.filePos;a===null&&(a=(await ws(this.reader,o,Pi,t.elementEndPos)).pos-o);let c=this.reader.requestSlice(o,a);c instanceof Promise&&(c=await c);let l={segment:t,elementStartPos:i,elementEndPos:o+a,dataStartPos:o,timestamp:-1,trackData:new Map};if(this.currentCluster=l,c){let u=this.readContiguousElements(c,Pi);l.elementEndPos=u}for(let[,u]of l.trackData){let f=u.track;h(u.blocks.length>0);let p=!1,k=!1;for(let S=0;S<u.blocks.length;S++){let _=u.blocks[S];_.timestamp+=l.timestamp,p||(p=_.referencedTimestamps.length>0),k||(k=_.lacing!==0)}p&&(u.blocks=Il(u.blocks)),u.presentationTimestamps=u.blocks.map((S,_)=>({timestamp:S.timestamp,blockIndex:_})).sort((S,_)=>S.timestamp-_.timestamp);for(let S=0;S<u.presentationTimestamps.length;S++){let _=u.presentationTimestamps[S],E=u.blocks[_.blockIndex];if(u.firstKeyFrameTimestamp===null&&E.isKeyFrame&&(u.firstKeyFrameTimestamp=E.timestamp),S<u.presentationTimestamps.length-1){let A=u.presentationTimestamps[S+1];E.duration=A.timestamp-E.timestamp}else E.duration===0&&f.defaultDuration!=null&&E.lacing===0&&(E.duration=f.defaultDuration)}k&&(this.expandLacedBlocks(u.blocks,f),u.presentationTimestamps=u.blocks.map((S,_)=>({timestamp:S.timestamp,blockIndex:_})).sort((S,_)=>S.timestamp-_.timestamp));let T=u.blocks[u.presentationTimestamps[0].blockIndex],b=u.blocks[se(u.presentationTimestamps).blockIndex];u.startTimestamp=T.timestamp,u.endTimestamp=b.timestamp+b.duration;let C=be(f.clusterPositionCache,u.startTimestamp,S=>S.startTimestamp);(C===-1||f.clusterPositionCache[C].elementStartPos!==i)&&f.clusterPositionCache.splice(C+1,0,{elementStartPos:l.elementStartPos,startTimestamp:u.startTimestamp})}return t.lastReadCluster=l,l}getTrackDataInCluster(e,t){let r=e.trackData.get(t);if(!r){let i=e.segment.tracks.find(s=>s.id===t);if(!i)return null;r={track:i,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,r)}return r}expandLacedBlocks(e,t){for(let r=0;r<e.length;r++){let i=e[r];if(i.lacing===0)continue;i.decoded||(i.data=this.decodeBlockData(t,i.data),i.decoded=!0);let s=zi.tempFromBytes(i.data),n=[],a=j(s)+1;switch(i.lacing){case 1:{let o=0;for(let c=0;c<a-1;c++){let l=0;for(;s.bufferPos<s.length;){let u=j(s);if(l+=u,u<255){n.push(l),o+=l;break}}}n.push(s.length-(s.bufferPos+o))}break;case 2:{let o=s.length-1,c=Math.floor(o/a);for(let l=0;l<a;l++)n.push(c)}break;case 3:{let o=Zr(s);h(o!==null);let c=o;n.push(c);let l=c;for(let u=1;u<a-1;u++){let f=s.bufferPos,p=Zr(s);h(p!==null);let k=p,b=(1<<(s.bufferPos-f)*7-1)-1,C=k-b;c+=C,n.push(c),l+=c}n.push(s.length-(s.bufferPos+l))}break;default:h(!1)}h(n.length===a),e.splice(r,1);for(let o=0;o<a;o++){let c=n[o],l=Z(s,c),u=i.duration||a*(t.defaultDuration??0),f=i.timestamp+u*o/a,p=u/a;e.splice(r+o,0,{timestamp:f,duration:p,isKeyFrame:i.isKeyFrame,referencedTimestamps:i.referencedTimestamps,data:l,lacing:0,decoded:!0,mainAdditional:i.mainAdditional})}r+=a,r--}}async loadSegmentMetadata(e){for(let t of e.seekEntries){if(!(t.id===307544935&&!e.tagsSeen)){if(!(t.id===423732329&&!e.attachmentsSeen))continue}let r=this.reader.requestSliceRange(e.dataStartPos+t.segmentPosition,ht,Ft);if(r instanceof Promise&&(r=await r),!r)continue;let i=zt(r);if(!i||i.id!==t.id)continue;let{size:s}=i;Qt(s),h(!this.currentSegment),this.currentSegment=e;let n=this.reader.requestSlice(r.filePos,s);n instanceof Promise&&(n=await n),n&&this.readContiguousElements(n),this.currentSegment=null,t.id===307544935?e.tagsSeen=!0:t.id===423732329&&(e.attachmentsSeen=!0)}}readContiguousElements(e,t){let r=e.filePos;for(;e.filePos-r<=e.length-ht;){let i=e.filePos;if(!this.traverseElement(e,t))return i}return e.filePos}traverseElement(e,t){let r=zt(e);if(!r||t&&t.includes(r.id))return!1;let{id:i,size:s}=r,n=e.filePos;switch(Qt(s),i){case 17026:this.isWebM=xr(e,s)==="webm";break;case 19899:{if(!this.currentSegment)break;let a={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(a),this.readContiguousElements(e.slice(n,s)),(a.id===-1||a.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let a=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!a)break;a.id=ue(e,s)}break;case 21420:{let a=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!a)break;a.segmentPosition=ue(e,s)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=ue(e,s),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=gs(e,s)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:rt,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(n,s)),this.currentTrack.decodingInstructions.some(a=>a.data?.type!=="decompress"||a.scope!==1||a.data.algorithm!==3)&&(console.warn("Track #".concat(this.currentTrack.id," has an unsupported content encoding; dropping.")),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let a=this.currentTrack.codecId.indexOf("/"),o=a===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,a);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===ft.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===ft.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):o===ft.vp8?this.currentTrack.info.codec="vp8":o===ft.vp9?this.currentTrack.info.codec="vp9":o===ft.av1&&(this.currentTrack.info.codec="av1");let c=this.currentTrack,l=new _r(this.input,new _l(c));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){o===ft.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===ft.mp3?this.currentTrack.info.codec="mp3":o===ft.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=Tr):o===ft.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):o===ft.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let c=this.currentTrack,l=new dt(this.input,new xl(c));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=ue(e,s)}break;case 131:{if(!this.currentTrack)break;let a=ue(e,s);a===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:a===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;ue(e,s)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!ue(e,s)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=xr(e,s)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=Z(e,s)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*ue(e,s)/1e9}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=Jr(e,s)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==rt)break;this.currentTrack.languageCode=xr(e,s),Hr(this.currentTrack.languageCode)||(this.currentTrack.languageCode=rt)}break;case 2274717:{if(!this.currentTrack)break;let o=xr(e,s).split("-")[0];o?this.currentTrack.languageCode=o:this.currentTrack.languageCode=rt}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(n,s))}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=ue(e,s)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=ue(e,s)}break;case 21440:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=ue(e,s)===1}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(n,s))}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let a=ue(e,s),o=Wr[a]??null;this.currentTrack.info.colorSpace.matrix=o}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=ue(e,s)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let a=ue(e,s),o=Vr[a]??null;this.currentTrack.info.colorSpace.transfer=o}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let a=ue(e,s),o=ir[a]??null;this.currentTrack.info.colorSpace.primaries=o}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(n,s))}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let o=-gs(e,s);try{this.currentTrack.info.rotation=ut(o)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(n,s))}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=gs(e,s)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=ue(e,s)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=ue(e,s)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(n,s)),this.currentCueTime=null}break;case 179:this.currentCueTime=ue(e,s);break;case 183:{if(this.currentCueTime===null)break;h(this.currentSegment);let a={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(a),this.readContiguousElements(e.slice(n,s)),(a.trackId===-1||a.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let a=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!a)break;a.trackId=ue(e,s)}break;case 241:{let a=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!a)break;h(this.currentSegment),a.clusterPosition=this.currentSegment.dataStartPos+ue(e,s)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=ue(e,s)}break;case 163:{if(!this.currentCluster)break;let a=Zr(e);if(a===null)break;let o=this.getTrackDataInCluster(this.currentCluster,a);if(!o)break;let c=Ms(e),l=j(e),u=!!(l&128),f=l>>1&3,p=Z(e,s-(e.filePos-n)),k=o.track.decodingInstructions.length>0;o.blocks.push({timestamp:c,duration:0,isKeyFrame:u,referencedTimestamps:[],data:p,lacing:f,decoded:!k,mainAdditional:null})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(e.slice(n,s)),this.currentBlock){for(let a=0;a<this.currentBlock.referencedTimestamps.length;a++)this.currentBlock.referencedTimestamps[a]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let a=Zr(e);if(a===null)break;let o=this.getTrackDataInCluster(this.currentCluster,a);if(!o)break;let c=Ms(e),u=j(e)>>1&3,f=Z(e,s-(e.filePos-n)),p=o.track.decodingInstructions.length>0;this.currentBlock={timestamp:c,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:f,lacing:u,decoded:!p,mainAdditional:null},o.blocks.push(this.currentBlock)}break;case 30113:this.readContiguousElements(e.slice(n,s));break;case 166:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(n,s)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case 165:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=Z(e,s)}break;case 238:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=ue(e,s)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=ue(e,s)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let a=vl(e,s);this.currentBlock.referencedTimestamps.push(a)}break;case 29555:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(n,s));break;case 25536:this.readContiguousElements(e.slice(n,s));break;case 26826:ue(e,s)!==50&&(this.currentTagTargetIsMovie=!1);break;case 25541:case 25545:case 25540:case 25542:this.currentTagTargetIsMovie=!1;break;case 26568:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(n,s))}break;case 17827:this.currentSimpleTagName=Jr(e,s);break;case 17543:{if(!this.currentSimpleTagName)break;let a=Jr(e,s);this.processTagValue(this.currentSimpleTagName,a)}break;case 17541:{if(!this.currentSimpleTagName)break;let a=Z(e,s);this.processTagValue(this.currentSimpleTagName,a)}break;case 24999:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(n,s));let a=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(a.raw??(a.raw={}),a.raw[this.currentAttachedFile.fileUid.toString()]=new wi(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){let o=this.currentAttachedFile.fileName,c="unknown";if(o){let l=o.toLowerCase();l.startsWith("cover.")?c="coverFront":l.startsWith("back.")&&(c="coverBack")}a.images??(a.images=[]),a.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:c,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case 18094:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=Sl(e,s)}break;case 18030:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=Jr(e,s)}break;case 18016:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=xr(e,s)}break;case 18012:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=Z(e,s)}break;case 18046:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=Jr(e,s)}break;case 28032:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(n,s)),this.currentTrack.decodingInstructions.sort((a,o)=>o.order-a.order)}break;case 25152:this.currentDecodingInstruction={order:0,scope:1,data:null},this.readContiguousElements(e.slice(n,s)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case 20529:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=ue(e,s)}break;case 20530:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=ue(e,s)}break;case 20532:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:0,settings:null},this.readContiguousElements(e.slice(n,s))}break;case 16980:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=ue(e,s)}break;case 16981:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=Z(e,s)}break;case 20533:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=n+s,!0}decodeBlockData(e,t){h(e.decodingInstructions.length>0);let r=t;for(let i of e.decodingInstructions)switch(h(i.data),i.data.type){case"decompress":switch(i.data.algorithm){case 3:if(i.data.settings&&i.data.settings.length>0){let s=i.data.settings,n=new Uint8Array(s.length+r.length);n.set(s,0),n.set(r,s.length),r=n}break;default:}break;default:}return r}processTagValue(e,t){var i;if(!this.currentSegment?.metadataTags)return;let r=this.currentSegment.metadataTags;if(r.raw??(r.raw={}),(i=r.raw)[e]??(i[e]=t),typeof t=="string")switch(e.toLowerCase()){case"title":r.title??(r.title=t);break;case"description":r.description??(r.description=t);break;case"artist":r.artist??(r.artist=t);break;case"album":r.album??(r.album=t);break;case"album_artist":r.albumArtist??(r.albumArtist=t);break;case"genre":r.genre??(r.genre=t);break;case"comment":r.comment??(r.comment=t);break;case"lyrics":r.lyrics??(r.lyrics=t);break;case"date":{let s=new Date(t);Number.isNaN(s.getTime())||(r.date??(r.date=s))}break;case"track_number":case"part_number":{let s=t.split("/"),n=Number.parseInt(s[0],10),a=s[1]&&Number.parseInt(s[1],10);Number.isInteger(n)&&n>0&&(r.trackNumber??(r.trackNumber=n)),a&&Number.isInteger(a)&&a>0&&(r.tracksTotal??(r.tracksTotal=a))}break;case"disc_number":case"disc":{let s=t.split("/"),n=Number.parseInt(s[0],10),a=s[1]&&Number.parseInt(s[1],10);Number.isInteger(n)&&n>0&&(r.discNumber??(r.discNumber=n)),a&&Number.isInteger(a)&&a>0&&(r.discsTotal??(r.discsTotal=a))}break}}},ma=class{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(null,t=>t.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,e)}intoTimescale(e){return pi(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(null,i=>{let s=i.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};let n=be(s.presentationTimestamps,r,c=>c.timestamp),a=n!==-1?s.presentationTimestamps[n].blockIndex:-1,o=n!==-1&&r<s.endTimestamp;return{blockIndex:a,correctBlockFound:o}},r,r,t)}async getNextPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,i=>{if(i===r.cluster){let s=i.trackData.get(this.internalTrack.id);if(r.blockIndex+1<s.blocks.length)return{blockIndex:r.blockIndex+1,correctBlockFound:!0}}else if(i.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(null,i=>{let s=i.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};let n=kn(s.presentationTimestamps,c=>s.blocks[c.blockIndex].isKeyFrame&&c.timestamp<=r),a=n!==-1?s.presentationTimestamps[n].blockIndex:-1,o=n!==-1&&r<s.endTimestamp;return{blockIndex:a,correctBlockFound:o}},r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,i=>{if(i===r.cluster){let n=i.trackData.get(this.internalTrack.id).blocks.findIndex((a,o)=>a.isKeyFrame&&o>r.blockIndex);if(n!==-1)return{blockIndex:n,correctBlockFound:!0}}else{let s=i.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){let n=s.blocks.findIndex(a=>a.isKeyFrame);return h(n!==-1),{blockIndex:n,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,r){if(t===-1)return null;let s=e.trackData.get(this.internalTrack.id).blocks[t];h(s),s.decoded||(s.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,s.data),s.decoded=!0);let n=r.metadataOnly?nt:s.data,a=s.timestamp/this.internalTrack.segment.timestampFactor,o=s.duration/this.internalTrack.segment.timestampFactor,c={};s.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(c.alpha=r.metadataOnly?nt:s.mainAdditional,c.alphaByteLength=s.mainAdditional.byteLength);let l=new Ce(n,s.isKeyFrame?"key":"delta",a,o,e.dataStartPos+t,s.data.byteLength,c);return this.packetToClusterLocation.set(l,{cluster:e,blockIndex:t}),l}async performClusterLookup(e,t,r,i,s){let{demuxer:n,segment:a}=this.internalTrack,o=null,c=null,l=-1;if(e){let{blockIndex:C,correctBlockFound:S}=t(e);if(S)return this.fetchPacketInCluster(e,C,s);C!==-1&&(c=e,l=C)}let u=be(this.internalTrack.cuePoints,r,C=>C.time),f=u!==-1?this.internalTrack.cuePoints[u]:null,p=be(this.internalTrack.clusterPositionCache,r,C=>C.startTimestamp),k=p!==-1?this.internalTrack.clusterPositionCache[p]:null,T=Math.max(f?.clusterPosition??0,k?.elementStartPos??0)||null,b;for(e?T===null||e.elementStartPos>=T?(b=e.elementEndPos,o=e):b=T:b=T??a.clusterSeekStartPos;a.elementEndPos===null||b<=a.elementEndPos-ht;){if(o){let D=o.trackData.get(this.internalTrack.id);if(D&&D.startTimestamp>i)break}let C=n.reader.requestSliceRange(b,ht,Ft);if(C instanceof Promise&&(C=await C),!C)break;let S=b,_=zt(C);if(!_||!Yr.includes(_.id)&&_.id!==236){let D=await da(n.reader,S,Yr,Math.min(a.elementEndPos??1/0,S+fa));if(D){b=D;continue}else break}let E=_.id,A=_.size,F=C.filePos;if(E===524531317){o=await n.readCluster(S,a),A=o.elementEndPos-F;let{blockIndex:D,correctBlockFound:$}=t(o);if($)return this.fetchPacketInCluster(o,D,s);D!==-1&&(c=o,l=D)}A===null&&(h(E!==524531317),A=(await ws(n.reader,F,Pi,a.elementEndPos)).pos-F);let B=F+A;if(a.elementEndPos===null){let D=n.reader.requestSliceRange(B,ht,Ft);if(D instanceof Promise&&(D=await D),!D)break;if(ps(D)===408125543){a.elementEndPos=B;break}}b=B}if(f&&(!c||c.elementStartPos<f.clusterPosition)){let C=this.internalTrack.cuePoints[u-1];h(!C||C.time<f.time);let S=C?.time??-1/0;return this.performClusterLookup(null,t,S,i,s)}return c?this.fetchPacketInCluster(c,l,s):null}},_l=class extends ma{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??(this.decoderConfigPromise=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:Mn({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Ln(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?Wn(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?$n(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?jn(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})()):null}},xl=class extends ma{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??(this.decoderConfig={codec:Fn({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}):null}},Il=e=>{let t=new Map;for(let n=0;n<e.length;n++){let a=e[n];t.set(a.timestamp,a)}let r=new Set,i=[],s=n=>{if(!r.has(n)){r.add(n);for(let a=0;a<n.referencedTimestamps.length;a++){let o=n.referencedTimestamps[a],c=t.get(o);c&&s(c)}i.push(n)}};for(let n=0;n<e.length;n++)s(e[n]);return i},pa=4,Pl=[44100,48e3,32e3],ys=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],ks=1483304551,ga=1231971951,Ts=(e,t,r,i,s)=>t===0?0:t===1?Math.floor(144*r/(i<<e))+s:t===2?Math.floor(144*r/i)+s:(Math.floor(12*r/i)+s)*4,Ss=(e,t)=>e===3?t===3?21:36:t===3?13:21,wa=(e,t)=>{let r=e>>>24,i=e>>>16&255,s=e>>>8&255,n=e&255;if(r!==255&&i!==255&&s!==255&&n!==255)return{header:null,bytesAdvanced:4};if(r!==255)return{header:null,bytesAdvanced:1};if((i&224)!==224)return{header:null,bytesAdvanced:1};let a=0,o=0;i&16?a=i&8?0:1:(a=1,o=1);let c=i>>3&3,l=i>>1&3,u=s>>4&15,f=(s>>2&3)%3,p=s>>1&1,k=n>>6&3,T=n>>4&3,b=n>>3&1,C=n>>2&1,S=n&3,_=ys[a*16*4+l*16+u];if(_===-1)return{header:null,bytesAdvanced:1};let E=_*1e3,A=Pl[f]>>a+o,F=Ts(a,l,E,A,p);if(t!==null&&t<F)return{header:null,bytesAdvanced:1};let B;return c===3?B=l===3?384:1152:l===3?B=384:l===2?B=1152:B=576,{header:{totalSize:F,mpegVersionId:c,layer:l,bitrate:E,frequencyIndex:f,sampleRate:A,channel:k,modeExtension:T,copyright:b,original:C,emphasis:S,audioSamplesInFrame:B},bytesAdvanced:1}},El=e=>{let t=127,r=0,i=e;for(;(t^2147483647)!==0;)r=i&~t,r<<=1,r|=i&t,t=(t+1<<8)-1,i=r;return r},vs=e=>{let t=2130706432,r=0;for(;t!==0;)r>>=1,r|=e&t,t>>=8;return r},Ei=128,Ai=10,Ir=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],Al=(e,t)=>{var f;let r=e.filePos;t.raw??(t.raw={}),(f=t.raw).TAG??(f.TAG=Z(e,Ei-3)),e.filePos=r;let i=Pr(e,30);i&&(t.title??(t.title=i));let s=Pr(e,30);s&&(t.artist??(t.artist=s));let n=Pr(e,30);n&&(t.album??(t.album=n));let a=Pr(e,4),o=Number.parseInt(a,10);Number.isInteger(o)&&o>0&&(t.date??(t.date=new Date(o,0,1)));let c=Z(e,30),l;if(c[28]===0&&c[29]!==0){let p=c[29];p>0&&(t.trackNumber??(t.trackNumber=p)),e.skip(-30),l=Pr(e,28),e.skip(2)}else e.skip(-30),l=Pr(e,30);l&&(t.comment??(t.comment=l));let u=j(e);u<Ir.length&&(t.genre??(t.genre=Ir[u]))},Pr=(e,t)=>{let r=Z(e,t),i=br(r.indexOf(0),r.length),s=r.subarray(0,i),n="";for(let a=0;a<s.length;a++)n+=String.fromCharCode(s[a]);return n.trimEnd()},Bi=e=>{let t=e.filePos,r=Oe(e,3),i=j(e),s=j(e),n=j(e),a=L(e);if(r!=="ID3"||i===255||s===255||(a&2155905152)!==0)return e.filePos=t,null;let o=vs(a);return{majorVersion:i,revision:s,flags:n,size:o}},ba=(e,t,r)=>{var n,a,o,c;if(![2,3,4].includes(t.majorVersion)){console.warn("Unsupported ID3v2 major version: ".concat(t.majorVersion));return}let i=Z(e,t.size),s=new Bl(t,i);if(t.flags&16&&s.removeFooter(),t.flags&128&&t.majorVersion===3&&s.ununsynchronizeAll(),t.flags&64){let l=s.readU32();t.majorVersion===3?s.pos+=l:s.pos+=l-4}for(;s.pos<=s.bytes.length-s.frameHeaderSize();){let l=s.readId3V2Frame();if(!l)break;let u=s.pos,f=s.pos+l.size,p=!1,k=!1,T=!1;if(t.majorVersion===3?(p=!!(l.flags&64),k=!!(l.flags&128)):t.majorVersion===4&&(p=!!(l.flags&4),k=!!(l.flags&8),T=!!(l.flags&2)||!!(t.flags&128)),p){console.warn("Skipping encrypted ID3v2 frame ".concat(l.id)),s.pos=f;continue}if(k){console.warn("Skipping compressed ID3v2 frame ".concat(l.id)),s.pos=f;continue}switch(T&&s.ununsynchronizeRegion(s.pos,f),r.raw??(r.raw={}),l.id[0]==="T"?(n=r.raw)[a=l.id]??(n[a]=s.readId3V2EncodingAndText(f)):(o=r.raw)[c=l.id]??(o[c]=s.readBytes(l.size)),s.pos=u,l.id){case"TIT2":case"TT2":r.title??(r.title=s.readId3V2EncodingAndText(f));break;case"TIT3":case"TT3":r.description??(r.description=s.readId3V2EncodingAndText(f));break;case"TPE1":case"TP1":r.artist??(r.artist=s.readId3V2EncodingAndText(f));break;case"TALB":case"TAL":r.album??(r.album=s.readId3V2EncodingAndText(f));break;case"TPE2":case"TP2":r.albumArtist??(r.albumArtist=s.readId3V2EncodingAndText(f));break;case"TRCK":case"TRK":{let C=s.readId3V2EncodingAndText(f).split("/"),S=Number.parseInt(C[0],10),_=C[1]&&Number.parseInt(C[1],10);Number.isInteger(S)&&S>0&&(r.trackNumber??(r.trackNumber=S)),_&&Number.isInteger(_)&&_>0&&(r.tracksTotal??(r.tracksTotal=_))}break;case"TPOS":case"TPA":{let C=s.readId3V2EncodingAndText(f).split("/"),S=Number.parseInt(C[0],10),_=C[1]&&Number.parseInt(C[1],10);Number.isInteger(S)&&S>0&&(r.discNumber??(r.discNumber=S)),_&&Number.isInteger(_)&&_>0&&(r.discsTotal??(r.discsTotal=_))}break;case"TCON":case"TCO":{let b=s.readId3V2EncodingAndText(f),C=/^\((\d+)\)/.exec(b);if(C){let S=Number.parseInt(C[1]);if(Ir[S]!==void 0){r.genre??(r.genre=Ir[S]);break}}if(C=/^\d+$/.exec(b),C){let S=Number.parseInt(C[0]);if(Ir[S]!==void 0){r.genre??(r.genre=Ir[S]);break}}r.genre??(r.genre=b)}break;case"TDRC":case"TDAT":{let b=s.readId3V2EncodingAndText(f),C=new Date(b);Number.isNaN(C.getTime())||(r.date??(r.date=C))}break;case"TYER":case"TYE":{let b=s.readId3V2EncodingAndText(f),C=Number.parseInt(b,10);Number.isInteger(C)&&(r.date??(r.date=new Date(C,0,1)))}break;case"USLT":case"ULT":{let b=s.readU8();s.pos+=3,s.readId3V2Text(b,f),r.lyrics??(r.lyrics=s.readId3V2Text(b,f))}break;case"COMM":case"COM":{let b=s.readU8();s.pos+=3,s.readId3V2Text(b,f),r.comment??(r.comment=s.readId3V2Text(b,f))}break;case"APIC":case"PIC":{let b=s.readId3V2TextEncoding(),C;if(t.majorVersion===2){let A=s.readAscii(3);C=A==="PNG"?"image/png":A==="JPG"?"image/jpeg":"image/*"}else C=s.readId3V2Text(b,f);let S=s.readU8(),_=s.readId3V2Text(b,f).trimEnd(),E=f-s.pos;if(E>=0){let A=s.readBytes(E);r.images||(r.images=[]),r.images.push({data:A,mimeType:C,kind:S===3?"coverFront":S===4?"coverBack":"unknown",description:_})}}break;default:s.pos+=l.size;break}s.pos=f}},Bl=class{constructor(e,t){this.header=e,this.bytes=t,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){let e=[];for(let t=0;t<this.bytes.length;t++){let r=this.bytes[t];e.push(r),r===255&&t!==this.bytes.length-1&&this.bytes[t]===0&&t++}this.bytes=new Uint8Array(e),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(e,t){let r=[];for(let n=e;n<t;n++){let a=this.bytes[n];r.push(a),a===255&&n!==t-1&&this.bytes[n+1]===0&&n++}let i=this.bytes.subarray(0,e),s=this.bytes.subarray(t);this.bytes=new Uint8Array(i.length+r.length+s.length),this.bytes.set(i,0),this.bytes.set(r,i.length),this.bytes.set(s,i.length+r.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-Ai),this.view=new DataView(this.bytes.buffer)}readBytes(e){let t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t}readU8(){let e=this.view.getUint8(this.pos);return this.pos+=1,e}readU16(){let e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}readU24(){let e=this.view.getUint16(this.pos,!1),t=this.view.getUint8(this.pos+1);return this.pos+=3,e*256+t}readU32(){let e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}readAscii(e){let t="";for(let r=0;r<e;r++)t+=String.fromCharCode(this.view.getUint8(this.pos+r));return this.pos+=e,t}readId3V2Frame(){if(this.header.majorVersion===2){let e=this.readAscii(3);if(e==="\0\0\0")return null;let t=this.readU24();return{id:e,size:t,flags:0}}else{let e=this.readAscii(4);if(e==="\0\0\0\0")return null;let t=this.readU32(),r=this.header.majorVersion===4?vs(t):t,i=this.readU16(),s=this.pos,n=a=>{let o=this.pos+a;if(o>this.bytes.length)return!1;if(o<=this.bytes.length-this.frameHeaderSize()){this.pos+=a;let c=this.readAscii(4);if(c!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(c))return!1}return!0};if(!n(r)){let a=this.header.majorVersion===4?t:vs(t);n(a)&&(r=a)}return this.pos=s,{id:e,size:r,flags:i}}}readId3V2TextEncoding(){let e=this.readU8();if(e>3)throw new Error("Unsupported text encoding: ".concat(e));return e}readId3V2Text(e,t){let r=this.pos,i=this.readBytes(t-this.pos);switch(e){case 0:{let s="";for(let n=0;n<i.length;n++){let a=i[n];if(a===0){this.pos=r+n+1;break}s+=String.fromCharCode(a)}return s}case 1:if(i[0]===255&&i[1]===254){let s=new TextDecoder("utf-16le"),n=br(i.findIndex((a,o)=>a===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(n+2,i.length),s.decode(i.subarray(2,n))}else if(i[0]===254&&i[1]===255){let s=new TextDecoder("utf-16be"),n=br(i.findIndex((a,o)=>a===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(n+2,i.length),s.decode(i.subarray(2,n))}else{let s=br(i.findIndex(n=>n===0),i.length);return this.pos=r+Math.min(s+1,i.length),Me.decode(i.subarray(0,s))}case 2:{let s=new TextDecoder("utf-16be"),n=br(i.findIndex((a,o)=>a===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(n+2,i.length),s.decode(i.subarray(0,n))}case 3:{let s=br(i.findIndex(n=>n===0),i.length);return this.pos=r+Math.min(s+1,i.length),Me.decode(i.subarray(0,s))}}}readId3V2EncodingAndText(e){if(this.pos>=e)return"";let t=this.readId3V2TextEncoding();return this.readId3V2Text(t,e)}},ya=class{constructor(e){this.helper=new Uint8Array(8),this.helperView=oe(this.helper),this.writer=e}writeId3V2Tag(e){let t=this.writer.getPos();this.writeAscii("ID3"),this.writeU8(4),this.writeU8(0),this.writeU8(0),this.writeSynchsafeU32(0);let r=this.writer.getPos(),i=new Set;for(let{key:a,value:o}of yr(e))switch(a){case"title":this.writeId3V2TextFrame("TIT2",o),i.add("TIT2");break;case"description":this.writeId3V2TextFrame("TIT3",o),i.add("TIT3");break;case"artist":this.writeId3V2TextFrame("TPE1",o),i.add("TPE1");break;case"album":this.writeId3V2TextFrame("TALB",o),i.add("TALB");break;case"albumArtist":this.writeId3V2TextFrame("TPE2",o),i.add("TPE2");break;case"trackNumber":{let c=e.tracksTotal!==void 0?"".concat(o,"/").concat(e.tracksTotal):o.toString();this.writeId3V2TextFrame("TRCK",c),i.add("TRCK")}break;case"discNumber":{let c=e.discsTotal!==void 0?"".concat(o,"/").concat(e.discsTotal):o.toString();this.writeId3V2TextFrame("TPOS",c),i.add("TPOS")}break;case"genre":this.writeId3V2TextFrame("TCON",o),i.add("TCON");break;case"date":this.writeId3V2TextFrame("TDRC",o.toISOString().slice(0,10)),i.add("TDRC");break;case"lyrics":this.writeId3V2LyricsFrame(o),i.add("USLT");break;case"comment":this.writeId3V2CommentFrame(o),i.add("COMM");break;case"images":{let c={coverFront:3,coverBack:4,unknown:0};for(let l of o){let u=c[l.kind]??0,f=l.description??"";this.writeId3V2ApicFrame(l.mimeType,u,f,l.data)}}break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:$e(a)}if(e.raw)for(let a in e.raw){let o=e.raw[a];if(o==null||a.length!==4||i.has(a))continue;let c;if(typeof o=="string"){let l=we.encode(o);c=new Uint8Array(l.byteLength+2),c[0]=3,c.set(l,1)}else if(o instanceof Uint8Array)c=o;else continue;this.writeAscii(a),this.writeSynchsafeU32(c.byteLength),this.writeU16(0),this.writer.write(c)}let s=this.writer.getPos(),n=s-r;return this.writer.seek(t+6),this.writeSynchsafeU32(n),this.writer.seek(s),n+10}writeU8(e){this.helper[0]=e,this.writer.write(this.helper.subarray(0,1))}writeU16(e){this.helperView.setUint16(0,e,!1),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeAscii(e){for(let t=0;t<e.length;t++)this.helper[t]=e.charCodeAt(t);this.writer.write(this.helper.subarray(0,e.length))}writeSynchsafeU32(e){this.writeU32(El(e))}writeIsoString(e){let t=new Uint8Array(e.length+1);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);t[e.length]=0,this.writer.write(t)}writeUtf8String(e){let t=we.encode(e);this.writer.write(t),this.writeU8(0)}writeId3V2TextFrame(e,t){let r=Fe(t),s=1+(r?t.length:we.encode(t).byteLength)+1;this.writeAscii(e),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(r?0:3),r?this.writeIsoString(t):this.writeUtf8String(t)}writeId3V2LyricsFrame(e){let t=Fe(e),r="",i=4+r.length+1+e.length+1;this.writeAscii("USLT"),this.writeSynchsafeU32(i),this.writeU16(0),this.writeU8(t?0:3),this.writeAscii("und"),t?(this.writeIsoString(r),this.writeIsoString(e)):(this.writeUtf8String(r),this.writeUtf8String(e))}writeId3V2CommentFrame(e){let t=Fe(e),r=t?e.length:we.encode(e).byteLength,i="",s=4+i.length+1+r+1;this.writeAscii("COMM"),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(t?0:3),this.writeU8(117),this.writeU8(110),this.writeU8(100),t?(this.writeIsoString(i),this.writeIsoString(e)):(this.writeUtf8String(i),this.writeUtf8String(e))}writeId3V2ApicFrame(e,t,r,i){let s=Fe(e)&&Fe(r),n=s?r.length:we.encode(r).byteLength,a=1+e.length+1+1+n+1+i.byteLength;this.writeAscii("APIC"),this.writeSynchsafeU32(a),this.writeU16(0),this.writeU8(s?0:3),s?this.writeIsoString(e):this.writeUtf8String(e),this.writeU8(t),s?this.writeIsoString(r):this.writeUtf8String(r),this.writer.write(i)}},Cs=async(e,t,r)=>{let i=t;for(;r===null||i<r;){let s=e.requestSlice(i,pa);if(s instanceof Promise&&(s=await s),!s)break;let n=L(s),a=wa(n,e.fileSize!==null?e.fileSize-i:null);if(a.header)return{header:a.header,startPos:i};i+=a.bytesAdvanced}return null},Ml=class extends or{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.metadataTags=null,this.tracks=[],this.readingMutex=new wr,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new dt(this.input,new Fl(this))]})())}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let a=this.reader.requestSlice(this.lastLoadedPos,Ai);if(a instanceof Promise&&(a=await a),!a){this.lastSampleLoaded=!0;return}let o=Bi(a);if(!o)break;this.lastLoadedPos=a.filePos+o.size}let e=await Cs(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}let t=e.header;this.lastLoadedPos=e.startPos+t.totalSize-1;let r=Ss(t.mpegVersionId,t.channel),i=this.reader.requestSlice(e.startPos+r,4);if(i instanceof Promise&&(i=await i),i){let a=L(i);if(a===ks||a===ga)return}this.firstFrameHeader||(this.firstFrameHeader=t),t.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn("MP3 changed sample rate mid-file: ".concat(this.firstFrameHeader.sampleRate," Hz to ").concat(t.sampleRate," Hz. Might be a bug, so please report this file."));let s=t.audioSamplesInFrame/this.firstFrameHeader.sampleRate,n={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:s,dataStart:e.startPos,dataSize:t.totalSize};this.loadedSamples.push(n),this.nextTimestampInSamples+=t.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return h(e),e.computeDuration()}async getMetadataTags(){let e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let t=0,r=!1;for(;;){let i=this.reader.requestSlice(t,Ai);if(i instanceof Promise&&(i=await i),!i)break;let s=Bi(i);if(!s)break;r=!0;let n=this.reader.requestSlice(i.filePos,s.size);if(n instanceof Promise&&(n=await n),!n)break;ba(n,s,this.metadataTags),t=i.filePos+s.size}if(!r&&this.reader.fileSize!==null&&this.reader.fileSize>=Ei){let i=this.reader.requestSlice(this.reader.fileSize-Ei,Ei);i instanceof Promise&&(i=await i),h(i),Oe(i,3)==="TAG"&&Al(i,this.metadataTags)}return this.metadataTags}finally{e()}}},Fl=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return h(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return rt}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return h(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return h(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return h(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=nt;else{let s=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;i=Z(s,r.dataSize)}return new Ce(i,"key",r.timestamp,r.duration,e,r.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=ji(this.demuxer.loadedSamples,e.timestamp,n=>n.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let s=i+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=be(this.demuxer.loadedSamples,e,s=>s.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,t);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,t);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},_s=1399285583,zl=79764919,ka=new Uint32Array(256);for(let e=0;e<256;e++){let t=e<<24;for(let r=0;r<8;r++)t=t&2147483648?t<<1^zl:t<<1;ka[e]=t>>>0&4294967295}var Ta=e=>{let t=oe(e),r=t.getUint32(22,!0);t.setUint32(22,0,!0);let i=0;for(let s=0;s<e.length;s++){let n=e[s];i=(i<<8^ka[i>>>24^n])>>>0}return t.setUint32(22,r,!0),i},Sa=(e,t,r)=>{let i=0,s=null;if(e.length>0)if(t.codec==="vorbis"){h(t.vorbisInfo);let n=t.vorbisInfo.modeBlockflags.length,o=(1<<Tc(n-1))-1<<1,c=(e[0]&o)>>1;if(c>=t.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let l=r,u=t.vorbisInfo.modeBlockflags[c];if(s=t.vorbisInfo.blocksizes[u],u===1){let f=(o|1)+1,p=e[0]&f?1:0;l=t.vorbisInfo.blocksizes[p]}i=l!==null?l+s>>2:0}else t.codec==="opus"&&(i=Yc(e).durationInSamples);return{durationInSamples:i,vorbisBlockSize:s}},va=e=>{let t="audio/ogg";if(e.codecStrings){let r=[...new Set(e.codecStrings)];t+='; codecs="'.concat(r.join(", "),'"')}return t},ur=27,Er=282,Ca=Er+65025,ei=e=>{let t=e.filePos;if(Mr(e)!==_s)return null;e.skip(1);let i=j(e),s=su(e),n=Mr(e),a=Mr(e),o=Mr(e),c=j(e),l=new Uint8Array(c);for(let k=0;k<c;k++)l[k]=j(e);let u=27+c,f=l.reduce((k,T)=>k+T,0),p=u+f;return{headerStartPos:t,totalSize:p,dataStartPos:t+u,dataSize:f,headerType:i,granulePosition:s,serialNumber:n,sequenceNumber:a,checksum:o,lacingValues:l}},Rl=(e,t)=>{for(;e.filePos<t-3;){let r=Mr(e),i=r&255,s=r>>>8&255,n=r>>>16&255,a=r>>>24&255,o=79;if(!(i!==o&&s!==o&&n!==o&&a!==o)){if(e.skip(-4),r===_s)return!0;e.skip(1)}}return!1},Dl=class extends or{constructor(e){super(e),this.metadataPromise=null,this.bitstreams=[],this.tracks=[],this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,ur,Er);if(t instanceof Promise&&(t=await t),!t)break;let r=ei(t);if(!r||!!!(r.headerType&2))break;this.bitstreams.push({serialNumber:r.serialNumber,bosPage:r,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=r.headerStartPos+r.totalSize}for(let t of this.bitstreams){let r=await this.readPacket(t.bosPage,0);r&&(r.data.byteLength>=7&&r.data[0]===1&&r.data[1]===118&&r.data[2]===111&&r.data[3]===114&&r.data[4]===98&&r.data[5]===105&&r.data[6]===115?await this.readVorbisMetadata(r,t):r.data.byteLength>=8&&r.data[0]===79&&r.data[1]===112&&r.data[2]===117&&r.data[3]===115&&r.data[4]===72&&r.data[5]===101&&r.data[6]===97&&r.data[7]===100&&await this.readOpusMetadata(r,t),t.codecInfo.codec!==null&&this.tracks.push(new dt(this.input,new Nl(t,this))))}})())}async readVorbisMetadata(e,t){let r=await this.findNextPacketStart(e);if(!r)return;let i=await this.readPacket(r.startPage,r.startSegmentIndex);if(!i||(r=await this.findNextPacketStart(i),!r))return;let s=await this.readPacket(r.startPage,r.startSegmentIndex);if(!s||i.data[0]!==3||s.data[0]!==5)return;let n=[],a=u=>{for(;n.push(Math.min(255,u)),!(u<255);)u-=255};a(e.data.length),a(i.data.length);let o=new Uint8Array(1+n.length+e.data.length+i.data.length+s.data.length);o[0]=2,o.set(n,1),o.set(e.data,1+n.length),o.set(i.data,1+n.length+e.data.length),o.set(s.data,1+n.length+e.data.length+i.data.length),t.codecInfo.codec="vorbis",t.description=o,t.lastMetadataPacket=s;let c=oe(e.data);t.numberOfChannels=c.getUint8(11),t.sampleRate=c.getUint32(12,!0);let l=c.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:Qn(s.data).modeBlockflags},ts(i.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,t){let r=await this.findNextPacketStart(e);if(!r)return;let i=await this.readPacket(r.startPage,r.startSegmentIndex);if(!i)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=i;let s=Ti(e.data);t.numberOfChannels=s.outputChannelCount,t.sampleRate=Tr,t.codecInfo.opusInfo={preSkip:s.preSkip},ts(i.data.subarray(8),this.metadataTags)}async readPacket(e,t){h(t<e.lacingValues.length);let r=0;for(let u=0;u<t;u++)r+=e.lacingValues[u];let i=e,s=r,n=t,a=[];e:for(;;){let u=this.reader.requestSlice(i.dataStartPos,i.dataSize);u instanceof Promise&&(u=await u),h(u);let f=Z(u,i.dataSize);for(;;){if(n===i.lacingValues.length){a.push(f.subarray(r,s));break}let k=i.lacingValues[n];if(s+=k,k<255){a.push(f.subarray(r,s));break e}n++}let p=i.headerStartPos+i.totalSize;for(;;){let k=this.reader.requestSliceRange(p,ur,Er);if(k instanceof Promise&&(k=await k),!k)return null;let T=ei(k);if(!T)return null;if(i=T,i.serialNumber===e.serialNumber)break;p=i.headerStartPos+i.totalSize}r=0,s=0,n=0}let o=a.reduce((u,f)=>u+f.length,0),c=new Uint8Array(o),l=0;for(let u=0;u<a.length;u++){let f=a[u];c.set(f,l),l+=f.length}return{data:c,endPage:i,endSegmentIndex:n}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let r=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let i=this.reader.requestSliceRange(r,ur,Er);if(i instanceof Promise&&(i=await i),!i)return null;let s=ei(i);if(!s)return null;if(s.serialNumber===e.endPage.serialNumber)return{startPage:s,startSegmentIndex:0};r=s.headerStartPos+s.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(t=>t.getCodecParameterString()));return va({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Nl=class{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.sequentialScanCache=[],this.sequentialScanMutex=new wr,this.internalSampleRate=e.codecInfo.codec==="opus"?Tr:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return h(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return rt}async getFirstTimestamp(){return 0}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(h(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,r){if(!e)return null;let{durationInSamples:i,vorbisBlockSize:s}=Sa(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),n=new Ce(r.metadataOnly?nt:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,i/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(n,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:i,vorbisLastBlockSize:t.vorbisLastBlocksize,vorbisBlockSize:s}),n}async getFirstPacket(e){h(this.bitstream.lastMetadataPacket);let t=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!t)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(h(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let i=await this.demuxer.readPacket(t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:r,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){let r=this.encodedPacketToMetadata.get(e);if(!r)throw new Error("Packet was not created from this track.");let i=await this.demuxer.findNextPacketStart(r.packet);if(!i)return null;let s=r.timestampInSamples+r.durationInSamples,n=await this.demuxer.readPacket(i.startPage,i.startSegmentIndex);return this.createEncodedPacketFromOggPacket(n,{timestampInSamples:s,vorbisLastBlocksize:r.vorbisBlockSize},t)}async getPacket(e,t){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(e,t);let r=pi(e*this.internalSampleRate,14);if(r===0)return this.getFirstPacket(t);if(r<0)return null;h(this.bitstream.lastMetadataPacket);let i=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!i)return null;let s=i.startPage,n=this.demuxer.reader.fileSize,a=[s];e:for(;s.headerStartPos+s.totalSize<n;){let S=s.headerStartPos,_=Math.floor((S+n)/2),E=_;for(;;){let A=Math.min(E+Ca,n-ur),F=this.demuxer.reader.requestSlice(E,A-E);if(F instanceof Promise&&(F=await F),h(F),!Rl(F,A)){n=_+ur;continue e}let D=this.demuxer.reader.requestSliceRange(F.filePos,ur,Er);D instanceof Promise&&(D=await D),h(D);let $=ei(D);h($);let ye=!1;if($.serialNumber===this.bitstream.serialNumber)ye=!0;else{let q=this.demuxer.reader.requestSlice($.headerStartPos,$.totalSize);q instanceof Promise&&(q=await q),h(q);let ie=Z(q,$.totalSize);ye=Ta(ie)===$.checksum}if(!ye){E=$.headerStartPos+4;continue}if(ye&&$.serialNumber!==this.bitstream.serialNumber){E=$.headerStartPos+$.totalSize;continue}if($.granulePosition===-1){E=$.headerStartPos+$.totalSize;continue}this.granulePositionToTimestampInSamples($.granulePosition)>r?n=$.headerStartPos:(s=$,a.push($));continue e}}let o=i.startPage;for(let S of a){if(S.granulePosition===s.granulePosition)break;(!o||S.headerStartPos>o.headerStartPos)&&(o=S)}let c=o,l=[c];for(;!(c.serialNumber===this.bitstream.serialNumber&&c.granulePosition===s.granulePosition);){let S=c.headerStartPos+c.totalSize,_=this.demuxer.reader.requestSliceRange(S,ur,Er);_ instanceof Promise&&(_=await _),h(_);let E=ei(_);h(E),c=E,c.serialNumber===this.bitstream.serialNumber&&l.push(c)}h(c.granulePosition!==-1);let u=null,f,p,k=c,T=0;if(c.headerStartPos===i.startPage.headerStartPos)f=this.granulePositionToTimestampInSamples(0),p=!0,u=0;else{f=0,p=!1;for(let E=c.lacingValues.length-1;E>=0;E--)if(c.lacingValues[E]<255){u=E+1;break}if(u===null)throw new Error("Invalid page with granule position: no packets end on this page.");T=u-1;let S={data:nt,endPage:k,endSegmentIndex:T};if(await this.demuxer.findNextPacketStart(S)){let E=xa(l,c,u);h(E);let A=_a(l,E.page,E.segmentIndex);A&&(c=A.page,u=A.segmentIndex)}else for(;;){let E=xa(l,c,u);if(!E)break;let A=_a(l,E.page,E.segmentIndex);if(!A)break;if(c=A.page,u=A.segmentIndex,E.page.headerStartPos!==k.headerStartPos){k=E.page,T=E.segmentIndex;break}}}let b=null,C=null;for(;c!==null;){h(u!==null);let S=await this.demuxer.readPacket(c,u);if(!S)break;if(!(c.headerStartPos===i.startPage.headerStartPos&&u<i.startSegmentIndex)){let A=this.createEncodedPacketFromOggPacket(S,{timestampInSamples:f,vorbisLastBlocksize:C?.vorbisBlockSize??null},t);h(A);let F=this.encodedPacketToMetadata.get(A);if(h(F),!p&&S.endPage.headerStartPos===k.headerStartPos&&S.endSegmentIndex===T?(f=this.granulePositionToTimestampInSamples(c.granulePosition),p=!0,A=this.createEncodedPacketFromOggPacket(S,{timestampInSamples:f-F.durationInSamples,vorbisLastBlocksize:C?.vorbisBlockSize??null},t),h(A),F=this.encodedPacketToMetadata.get(A),h(F)):f+=F.durationInSamples,b=A,C=F,p&&(Math.max(f,0)>r||Math.max(F.timestampInSamples,0)===r))break}let E=await this.demuxer.findNextPacketStart(S);if(!E)break;c=E.startPage,u=E.startSegmentIndex}return b}async getPacketSequential(e,t){let r=await this.sequentialScanMutex.acquire();try{let i=pi(e*this.internalSampleRate,14);e=i/this.internalSampleRate;let s=be(this.sequentialScanCache,i,o=>o.timestampInSamples),n;if(s!==-1){let o=this.sequentialScanCache[s];n=this.createEncodedPacketFromOggPacket(o.packet,{timestampInSamples:o.timestampInSamples,vorbisLastBlocksize:o.vorbisLastBlockSize},t)}else n=await this.getFirstPacket(t);let a=0;for(;n&&n.timestamp<e;){let o=await this.getNextPacket(n,t);if(!o||o.timestamp>e)break;if(n=o,a++,a===100){a=0;let c=this.encodedPacketToMetadata.get(n);h(c),this.sequentialScanCache.length>0&&h(se(this.sequentialScanCache).timestampInSamples<=c.timestampInSamples),this.sequentialScanCache.push(c)}}return n}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},_a=(e,t,r)=>{let i=t,s=r;e:for(;;){for(s--,s;s>=0;s--)if(i.lacingValues[s]<255){s++;break e}if(h(s===-1),!(i.headerType&1)){s=0;break}let a=yn(e,o=>o.headerStartPos<i.headerStartPos);if(!a)return null;i=a,s=i.lacingValues.length}if(h(s!==-1),s===i.lacingValues.length){let n=e[e.indexOf(i)+1];h(n),i=n,s=0}return{page:i,segmentIndex:s}},xa=(e,t,r)=>{if(r>0)return{page:t,segmentIndex:r-1};let i=yn(e,s=>s.headerStartPos<t.headerStartPos);return i?{page:i,segmentIndex:i.lacingValues.length-1}:null},Ol=class extends or{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.lastKnownPacketIndex=0,this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),h(e);let t=Oe(e,4),r=t!=="RIFX",i=t==="RF64",s=Gt(e,r),n=i?this.reader.fileSize:Math.min(s+8,this.reader.fileSize??1/0);if(Oe(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let o=0,c=null,l=e.filePos;for(;n===null||l<n;){let f=this.reader.requestSlice(l,8);if(f instanceof Promise&&(f=await f),!f)break;let p=Oe(f,4),k=Gt(f,r),T=f.filePos;if(i&&o===0&&p!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(p==="fmt ")await this.parseFmtChunk(T,k,r);else if(p==="data"){if(c??(c=k),this.dataStart=f.filePos,this.dataSize=Math.min(c,(n??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(p==="ds64"){let b=this.reader.requestSlice(T,k);if(b instanceof Promise&&(b=await b),!b)break;let C=Ya(b,r);c=Ya(b,r),n=Math.min(C+8,this.reader.fileSize??1/0)}else p==="LIST"?await this.parseListChunk(T,k,r):(p==="ID3 "||p==="id3 ")&&await this.parseId3Chunk(T,k);l=T+k+(k&1),o++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let u=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/u)*u,this.tracks.push(new dt(this.input,new Ul(this)))})())}async parseFmtChunk(e,t,r){let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;let s=ti(i,r),n=ti(i,r),a=Gt(i,r);i.skip(4);let o=ti(i,r),c;if(t===14?c=8:c=ti(i,r),t>=18&&s!==357){let l=ti(i,r),u=t-18;if(Math.min(u,l)>=22&&s===65534){i.skip(6);let p=Z(i,16);s=p[0]|p[1]<<8}}(s===7||s===6)&&(c=8),this.audioInfo={format:s,numberOfChannels:n,sampleRate:a,sampleSizeInBytes:Math.ceil(c/8),blockSizeInBytes:o}}async parseListChunk(e,t,r){var a,o,c,l,u,f,p,k,T,b,C;let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;let s=Oe(i,4);if(s!=="INFO"&&s!=="INF0")return;let n=i.filePos;for(;n<=e+t-8;){i.filePos=n;let S=Oe(i,4),_=Gt(i,r),E=Z(i,_),A=0;for(let B=0;B<E.length&&E[B]!==0;B++)A++;let F=String.fromCharCode(...E.subarray(0,A));switch((a=this.metadataTags).raw??(a.raw={}),this.metadataTags.raw[S]=F,S){case"INAM":case"TITL":(o=this.metadataTags).title??(o.title=F);break;case"TIT3":(c=this.metadataTags).description??(c.description=F);break;case"IART":(l=this.metadataTags).artist??(l.artist=F);break;case"IPRD":(u=this.metadataTags).album??(u.album=F);break;case"IPRT":case"ITRK":case"TRCK":{let B=F.split("/"),D=Number.parseInt(B[0],10),$=B[1]&&Number.parseInt(B[1],10);Number.isInteger(D)&&D>0&&((f=this.metadataTags).trackNumber??(f.trackNumber=D)),$&&Number.isInteger($)&&$>0&&((p=this.metadataTags).tracksTotal??(p.tracksTotal=$))}break;case"ICRD":case"IDIT":{let B=new Date(F);Number.isNaN(B.getTime())||((k=this.metadataTags).date??(k.date=B))}break;case"YEAR":{let B=Number.parseInt(F,10);Number.isInteger(B)&&B>0&&((T=this.metadataTags).date??(T.date=new Date(B,0,1)))}break;case"IGNR":case"GENR":(b=this.metadataTags).genre??(b.genre=F);break;case"ICMT":case"CMNT":case"COMM":(C=this.metadataTags).comment??(C.comment=F);break}n+=8+_+(_&1)}}async parseId3Chunk(e,t){let r=this.reader.requestSlice(e,t);if(r instanceof Promise&&(r=await r),!r)return;let i=Bi(r);if(i){let s=r.slice(e+10,i.size);ba(s,i,this.metadataTags)}}getCodec(){if(h(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return h(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Ar=2048,Ul=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let e=this.demuxer.getCodec();return e?(h(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getNumberOfChannels(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return rt}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){h(this.demuxer.audioInfo);let r=e*Ar*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(Ar*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(this.demuxer.reader.fileSize===null){let o=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);if(o instanceof Promise&&(o=await o),!o)return null}let s;if(t.metadataOnly)s=nt;else{let o=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);o instanceof Promise&&(o=await o),h(o),s=Z(o,i)}let n=e*Ar/this.demuxer.audioInfo.sampleRate,a=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(e,n),new Ce(s,"key",n,a,e,i)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getPacket(e,t){h(this.demuxer.audioInfo);let r=Math.floor(Math.min(e*this.demuxer.audioInfo.sampleRate/Ar,(this.demuxer.dataSize-1)/(Ar*this.demuxer.audioInfo.blockSizeInBytes))),i=await this.getPacketAtIndex(r,t);if(i)return i;if(r===0)return null;h(this.demuxer.reader.fileSize===null);let s=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,t);for(;s;){let n=await this.getNextPacket(s,t);if(!n)break;s=n}return s}getNextPacket(e,t){h(this.demuxer.audioInfo);let r=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/Ar);return this.getPacketAtIndex(r+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},Mi=7,Fi=9,xs=e=>{let t=e.filePos,r=Z(e,9),i=new he(r);if(i.readBits(12)!==4095||(i.skipBits(1),i.readBits(2)!==0))return null;let a=i.readBits(1),o=i.readBits(2)+1,c=i.readBits(4);if(c===15)return null;i.skipBits(1);let l=i.readBits(3);if(l===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);let u=i.readBits(13);i.skipBits(11);let f=i.readBits(2)+1;if(f!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let p=null;return a===1?e.filePos-=2:p=i.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:l,frameLength:u,numberOfAacFrames:f,crcCheck:p,startPos:t}},Is=1024,Ll=class extends or{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.readingMutex=new wr,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();h(this.firstFrameHeader),this.tracks=[new dt(this.input,new Vl(this))]})())}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,Mi,Fi);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}let t=xs(e);if(!t){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&t.startPos+t.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=t);let r=yi[t.samplingFrequencyIndex];h(r!==void 0);let i=Is/r,s=t.crcCheck?Fi:Mi,n={timestamp:this.nextTimestampInSamples/r,duration:i,dataStart:t.startPos+s,dataSize:t.frameLength-s};this.loadedSamples.push(n),this.nextTimestampInSamples+=Is,this.lastLoadedPos=t.startPos+t.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return h(e),e.computeDuration()}async getMetadataTags(){return{}}},Vl=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/Is}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return rt}getCodec(){return"aac"}getInternalCodecId(){return h(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){h(this.demuxer.firstFrameHeader);let e=zn[this.demuxer.firstFrameHeader.channelConfiguration];return h(e!==void 0),e}getSampleRate(){h(this.demuxer.firstFrameHeader);let e=yi[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return h(e!==void 0),e}async getDecoderConfig(){h(this.demuxer.firstFrameHeader);let e=new Uint8Array(3),t=new he(e),{objectType:r,samplingFrequencyIndex:i,channelConfiguration:s}=this.demuxer.firstFrameHeader;return r>31?(t.writeBits(5,31),t.writeBits(6,r-32)):t.writeBits(5,r),t.writeBits(4,i),t.writeBits(4,s),{codec:"mp4a.40.".concat(this.demuxer.firstFrameHeader.objectType),numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:e.subarray(0,Math.ceil((t.pos-1)/8))}}async getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=nt;else{let s=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;i=Z(s,r.dataSize)}return new Ce(i,"key",r.timestamp,r.duration,e,r.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=ji(this.demuxer.loadedSamples,e.timestamp,n=>n.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let s=i+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=be(this.demuxer.loadedSamples,e,s=>s.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,t);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,t);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},Ia=e=>e===0?null:e===1?192:e>=2&&e<=5?144*2**e:e===6?"uncommon-u8":e===7?"uncommon-u16":e>=8&&e<=15?2**e:null,Wl=(e,t)=>{switch(e){case 0:return t;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},Pa=e=>{let t=0,r=new he(Z(e,1));for(;r.readBits(1)===1;)t++;if(t===0)return r.readBits(7);let i=[],s=t-1,n=new he(Z(e,s)),a=8-t-1;for(let c=0;c<a;c++)i.unshift(r.readBits(1));for(let c=0;c<s;c++)for(let l=0;l<8;l++){let u=n.readBits(1);l<2||i.unshift(u)}return i.reduce((c,l,u)=>c|l<<u,0)},Ea=(e,t)=>{if(t==="uncommon-u16")return Le(e)+1;if(t==="uncommon-u8")return j(e)+1;if(typeof t=="number")return t;$e(t),h(!1)},Hl=(e,t)=>t==="uncommon-u16"?Le(e):t==="uncommon-u16-10"?Le(e)*10:t==="uncommon-u8"?j(e):typeof t=="number"?t:null,$l=e=>{let r=0;for(let i of e){r^=i;for(let s=0;s<8;s++)(r&128)!==0?r=r<<1^7:r<<=1,r&=255}return r},ql=class extends or{constructor(e){super(e),this.loadedSamples=[],this.metadataPromise=null,this.track=null,this.metadataTags={},this.audioInfo=null,this.lastLoadedPos=null,this.blockingBit=null,this.readingMutex=new wr,this.lastSampleLoaded=!1,this.reader=e._reader}async computeDuration(){return await this.readMetadata(),h(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),h(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??(this.metadataPromise=(async()=>{var t;for(;this.reader.fileSize===null||e<this.reader.fileSize;){let r=this.reader.requestSlice(e,4);if(r instanceof Promise&&(r=await r),e+=4,r===null)throw new Error("Metadata block at position ".concat(e," is too small! Corrupted file."));h(r);let i=j(r),s=Br(r),n=(i&128)!==0;switch(i&127){case 0:{let o=this.reader.requestSlice(e,s);if(o instanceof Promise&&(o=await o),h(o),o===null)throw new Error("StreamInfo block at position ".concat(e," is too small! Corrupted file."));let c=Z(o,34),l=new he(c),u=l.readBits(16),f=l.readBits(16),p=l.readBits(24),k=l.readBits(24),T=l.readBits(20),b=l.readBits(3)+1;l.readBits(5);let C=l.readBits(36);l.skipBits(128);let S=new Uint8Array(42);S.set(new Uint8Array([102,76,97,67]),0),S.set(new Uint8Array([128,0,0,34]),4),S.set(c,8),this.audioInfo={numberOfChannels:b,sampleRate:T,totalSamples:C,minimumBlockSize:u,maximumBlockSize:f,minimumFrameSize:p,maximumFrameSize:k,description:S},this.track=new dt(this.input,new jl(this));break}case 4:{let o=this.reader.requestSlice(e,s);o instanceof Promise&&(o=await o),h(o),ts(Z(o,s),this.metadataTags);break}case 6:{let o=this.reader.requestSlice(e,s);o instanceof Promise&&(o=await o),h(o);let c=L(o),l=L(o),u=Me.decode(Z(o,l)),f=L(o),p=Me.decode(Z(o,f));o.skip(16);let k=L(o),T=Z(o,k);(t=this.metadataTags).images??(t.images=[]),this.metadataTags.images.push({data:T,mimeType:u,kind:c===3?"coverFront":c===4?"coverBack":"unknown",description:p});break}default:break}if(e+=s,n){this.lastLoadedPos=e;break}}})())}async readNextFlacFrame({startPos:e,isFirstPacket:t}){h(this.audioInfo);let r=6,s=this.audioInfo.maximumFrameSize+16,n=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,s);if(!n)return null;let a=this.readFlacFrameHeader({slice:n,isFirstPacket:t});if(!a)return null;for(n.filePos=e+this.audioInfo.minimumFrameSize;;){if(n.filePos>n.end-r)return{num:a.num,blockSize:a.blockSize,sampleRate:a.sampleRate,size:n.end-e,isLastFrame:!0};if(j(n)===255){let c=j(n),l=this.blockingBit===1?249:248;if(c!==l){n.skip(-1);continue}n.skip(-2);let u=n.filePos-e;if(!this.readFlacFrameHeader({slice:n,isFirstPacket:!1})){n.skip(-1);continue}return{num:a.num,blockSize:a.blockSize,sampleRate:a.sampleRate,size:u,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:t}){let r=e.filePos,i=Z(e,4),s=new he(i);if(s.readBits(15)!==32764)return null;if(this.blockingBit===null){h(t);let b=s.readBits(1);this.blockingBit=b}else if(this.blockingBit===1){if(h(!t),s.readBits(1)!==1)return null}else if(this.blockingBit===0){if(h(!t),s.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");let a=Ia(s.readBits(4));if(!a)return null;h(this.audioInfo);let o=Wl(s.readBits(4),this.audioInfo.sampleRate);if(!o||(s.readBits(4),s.readBits(3),s.readBits(1)!==0))return null;let l=Pa(e),u=Ea(e,a),f=Hl(e,o);if(f===null)return null;let p=e.filePos-r,k=j(e);e.skip(-p),e.skip(-1);let T=$l(Z(e,p));return k!==T?null:{num:l,blockSize:u,sampleRate:f}}async advanceReader(){await this.readMetadata(),h(this.lastLoadedPos!==null),h(this.audioInfo);let e=this.lastLoadedPos,t=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!t){this.lastSampleLoaded=!0;return}let r=this.loadedSamples[this.loadedSamples.length-1],s={blockOffset:r?r.blockOffset+r.blockSize:0,blockSize:t.blockSize,byteOffset:e,byteSize:t.size};if(this.lastLoadedPos=this.lastLoadedPos+t.size,this.loadedSamples.push(s),t.isLastFrame){this.lastSampleLoaded=!0;return}}},jl=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getSampleRate(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return rt}getTimeResolution(){return h(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}async getFirstTimestamp(){return 0}async getDecoderConfig(){return h(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(e,t){if(h(this.demuxer.audioInfo),e<0)throw new Error("Timestamp cannot be negative");let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=be(this.demuxer.loadedSamples,e,o=>o.blockOffset/this.demuxer.audioInfo.sampleRate);if(i===-1){await this.demuxer.advanceReader();continue}let s=this.demuxer.loadedSamples[i],n=s.blockOffset/this.demuxer.audioInfo.sampleRate,a=s.blockSize/this.demuxer.audioInfo.sampleRate;if(n+a<=e){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,t);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(i,t)}}finally{r()}}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=e.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&i>=this.demuxer.loadedSamples.length)return null;for(;i>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(i,t)}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}async getPacketAtIndex(e,t){let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=nt;else{let a=this.demuxer.reader.requestSlice(r.byteOffset,r.byteSize);if(a instanceof Promise&&(a=await a),!a)return null;i=Z(a,r.byteSize)}h(this.demuxer.audioInfo);let s=r.blockOffset/this.demuxer.audioInfo.sampleRate,n=r.blockSize/this.demuxer.audioInfo.sampleRate;return new Ce(i,"key",s,n,e,r.byteSize)}async getFirstPacket(e){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,e)}},Rt=class{},Ps=class extends Rt{async _getMajorBrand(e){let t=e._reader.requestSlice(0,12);return t instanceof Promise&&(t=await t),!t||(t.skip(4),Oe(t,4)!=="ftyp")?null:Oe(t,4)}_createDemuxer(e){return new hl(e)}},Aa=class extends Ps{async _canReadInput(e){let t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},Ba=class extends Ps{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},Es=class extends Rt{async isSupportedEBMLOfDocType(e,t){let r=e._reader.requestSlice(0,Ft);if(r instanceof Promise&&(r=await r),!r)return!1;let i=la(r);if(i===null||i<1||i>8||ue(r,i)!==440786851)return!1;let n=ua(r);if(n===null)return!1;let a=e._reader.requestSlice(r.filePos,n);if(a instanceof Promise&&(a=await a),!a)return!1;let o=r.filePos;for(;a.filePos<=o+n-ht;){let c=zt(a);if(!c)break;let{id:l,size:u}=c,f=a.filePos;if(u===null)return!1;switch(l){case 17030:if(ue(a,u)!==1)return!1;break;case 17143:if(ue(a,u)!==1)return!1;break;case 17026:if(xr(a,u)!==t)return!1;break;case 17031:if(ue(a,u)>4)return!1;break}a.filePos=f+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new Cl(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},Ma=class extends Es{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},Fa=class extends Rt{async _canReadInput(e){let t=e._reader.requestSlice(0,10);if(t instanceof Promise&&(t=await t),!t)return!1;let r=0,i=!1;for(;;){let c=e._reader.requestSlice(r,Ai);if(c instanceof Promise&&(c=await c),!c)break;let l=Bi(c);if(!l)break;i=!0,r=c.filePos+l.size}let s=await Cs(e._reader,r,r+4096);if(!s)return!1;if(i)return!0;r=s.startPos+s.header.totalSize;let n=await Cs(e._reader,r,r+pa);if(!n)return!1;let a=s.header,o=n.header;return!(a.channel!==o.channel||a.sampleRate!==o.sampleRate)}_createDemuxer(e){return new Ml(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},za=class extends Rt{async _canReadInput(e){let t=e._reader.requestSlice(0,12);if(t instanceof Promise&&(t=await t),!t)return!1;let r=Oe(t,4);return r!=="RIFF"&&r!=="RIFX"&&r!=="RF64"?!1:(t.skip(4),Oe(t,4)==="WAVE")}_createDemuxer(e){return new Ol(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},Ra=class extends Rt{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Oe(t,4)==="OggS":!1}_createDemuxer(e){return new Dl(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},Da=class extends Rt{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Oe(t,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(e){return new ql(e)}},Na=class extends Rt{async _canReadInput(e){let t=e._reader.requestSliceRange(0,Mi,Fi);if(t instanceof Promise&&(t=await t),!t)return!1;let r=xs(t);if(!r||(t=e._reader.requestSliceRange(r.frameLength,Mi,Fi),t instanceof Promise&&(t=await t),!t))return!1;let i=xs(t);return i?r.objectType===i.objectType&&r.samplingFrequencyIndex===i.samplingFrequencyIndex&&r.channelConfiguration===i.channelConfiguration:!1}_createDemuxer(e){return new Ll(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},Oa=new Aa,Ua=new Ba,La=new Es,Va=new Ma,Wa=new Fa,Ha=new za,$a=new Ra,qa=new Na,ja=new Da,Ql=[Oa,Ua,La,Va,Ha,$a,ja,Wa,qa],Qa=X(ve(),1),Kl=typeof Qa<"u"?Qa:void 0,Kt=class{constructor(){this._disposed=!1,this._sizePromise=null,this.onread=null}async getSizeOrNull(){if(this._disposed)throw new Ke;return this._sizePromise??(this._sizePromise=Promise.resolve(this._retrieveSize()))}async getSize(){if(this._disposed)throw new Ke;let e=await this.getSizeOrNull();if(e===null)throw new Error("Cannot determine the size of an unsized source.");return e}},Gl=class extends Kt{constructor(e){if(!(e instanceof ArrayBuffer)&&!ArrayBuffer.isView(e))throw new TypeError("buffer must be an ArrayBuffer or ArrayBufferView.");super(),this._onreadCalled=!1,this._bytes=ne(e),this._view=oe(e)}_retrieveSize(){return this._bytes.byteLength}_read(){return this._onreadCalled||(this.onread?.(0,this._bytes.byteLength),this._onreadCalled=!0),{bytes:this._bytes,view:this._view,offset:0}}_dispose(){}},Xl=class extends Kt{constructor(e,t={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!kr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._readers=new WeakMap,this._blob=e,this._orchestrator=new Bs({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:As.fileSystem})}_retrieveSize(){let e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){let t=this._readers.get(e);for(t===void 0&&("stream"in this._blob?t=this._blob.slice(e.currentPos).stream().getReader():t=null,this._readers.set(e,t));e.currentPos<e.targetPos&&!e.aborted;)if(t){let{done:r,value:i}=await t.read();if(r){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Blob reader stopped unexpectedly before all requested data was read.");break}this.onread?.(e.currentPos,e.currentPos+i.length),this._orchestrator.supplyWorkerData(e,i)}else{let r=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();this.onread?.(e.currentPos,e.currentPos+r.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(r))}e.running=!1}_dispose(){this._orchestrator.dispose()}},Ka=.5*2**20,Yl=(e,t,r)=>{if(t instanceof Error&&(t.message.includes("Failed to fetch")||t.message.includes("Load failed")||t.message.includes("NetworkError when attempting to fetch resource"))){let s=null;try{typeof window<"u"&&typeof window.location<"u"&&(s=new URL(r instanceof Request?r.url:r,window.location.href).origin)}catch{}if((typeof navigator<"u"&&typeof navigator.onLine=="boolean"?navigator.onLine:!0)&&s!==null&&s!==window.location.origin)return null}return Math.min(2**(e-2),16)},Zl=class extends Kt{constructor(e,t={}){if(typeof e!="string"&&!(e instanceof URL)&&!(typeof Request<"u"&&e instanceof Request))throw new TypeError("url must be a string, URL or Request.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.requestInit!==void 0&&(!t.requestInit||typeof t.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(t.getRetryDelay!==void 0&&typeof t.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");if(t.maxCacheSize!==void 0&&(!kr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(t.fetchFn!==void 0&&typeof t.fetchFn!="function")throw new TypeError("options.fetchFn, when provided, must be a function.");super(),this._existingResponses=new WeakMap,this._url=e,this._options=t,this._getRetryDelay=t.getRetryDelay??Yl,this._orchestrator=new Bs({maxCacheSize:t.maxCacheSize??64*2**20,maxWorkerCount:2,runWorker:this._runWorker.bind(this),prefetchProfile:As.network})}async _retrieveSize(){let e=new AbortController,t=await Cn(this._options.fetchFn??fetch,this._url,Sn(this._options.requestInit??{},{headers:{Range:"bytes=0-"},signal:e.signal}),this._getRetryDelay);if(!t.ok)throw new Error("Error fetching ".concat(String(this._url),": ").concat(t.status," ").concat(t.statusText));let r,i;if(t.status===206)i=this._getPartialLengthFromRangeResponse(t),r=this._orchestrator.createWorker(0,Math.min(i,Ka));else{let s=t.headers.get("Content-Length");if(s)i=Number(s),r=this._orchestrator.createWorker(0,i),this._orchestrator.options.maxCacheSize=1/0,console.warn("HTTP server did not respond with 206 Partial Content, meaning the entire remote resource now has to be downloaded. For efficient media file streaming across a network, please make sure your server supports range requests.");else throw new Error("HTTP response (status ".concat(t.status,") must surface Content-Length header."))}return this._orchestrator.fileSize=i,this._existingResponses.set(r,{response:t,abortController:e}),this._orchestrator.runWorker(r),i}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){for(;!e.aborted;){let t=this._existingResponses.get(e);this._existingResponses.delete(e);let r=t?.abortController,i=t?.response;if(r||(r=new AbortController,i=await Cn(this._options.fetchFn??fetch,this._url,Sn(this._options.requestInit??{},{headers:{Range:"bytes=".concat(e.currentPos,"-")},signal:r.signal}),this._getRetryDelay)),h(i),!i.ok)throw new Error("Error fetching ".concat(String(this._url),": ").concat(i.status," ").concat(i.statusText));if(e.currentPos>0&&i.status!==206)throw new Error("HTTP server did not respond with 206 Partial Content to a range request. To enable efficient media file streaming across a network, please make sure your server supports range requests.");let s=this._getPartialLengthFromRangeResponse(i),n=e.targetPos-e.currentPos;if(s<n)throw new Error("HTTP response unexpectedly too short: Needed at least ".concat(n," bytes, got only ").concat(s,"."));if(!i.body)throw new Error("Missing HTTP response body stream. The used fetch function must provide the response body as a ReadableStream.");let a=i.body.getReader();for(;;){if(e.currentPos>=e.targetPos||e.aborted){r.abort(),e.running=!1;return}let o;try{o=await a.read()}catch(u){let f=this._getRetryDelay(1,u,this._url);if(f!==null){console.error("Error while reading response stream. Attempting to resume.",u),await new Promise(p=>setTimeout(p,1e3*f));break}else throw u}let{done:c,value:l}=o;if(c){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Response stream reader stopped unexpectedly before all requested data was read.");e.running=!1;return}this.onread?.(e.currentPos,e.currentPos+l.length),this._orchestrator.supplyWorkerData(e,l)}}e.running=!1}_getPartialLengthFromRangeResponse(e){let t=e.headers.get("Content-Range");if(t){let r=/\/(\d+)/.exec(t);if(r)return Number(r[1]);throw new Error("Invalid Content-Range header: ".concat(t))}else{let r=e.headers.get("Content-Length");if(r)return Number(r);throw new Error("Partial HTTP response (status 206) must surface either Content-Range or Content-Length header.")}}_dispose(){this._orchestrator.dispose()}},Jl=class extends Kt{constructor(e,t={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!kr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._fileHandle=null,this._streamSource=new Ga({getSize:async()=>(this._fileHandle=await Kl.fs.open(e,"r"),(await this._fileHandle.stat()).size),read:async(r,i)=>{h(this._fileHandle);let s=new Uint8Array(i-r);return await this._fileHandle.read(s,0,i-r,r),s},maxCacheSize:t.maxCacheSize,prefetchProfile:"fileSystem"})}_read(e,t){return this._streamSource._read(e,t)}_retrieveSize(){return this._streamSource._retrieveSize()}_dispose(){this._streamSource._dispose(),this._fileHandle?.close(),this._fileHandle=null}},Ga=class extends Kt{constructor(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(typeof e.getSize!="function")throw new TypeError("options.getSize must be a function.");if(typeof e.read!="function")throw new TypeError("options.read must be a function.");if(e.dispose!==void 0&&typeof e.dispose!="function")throw new TypeError("options.dispose, when provided, must be a function.");if(e.maxCacheSize!==void 0&&(!kr(e.maxCacheSize)||e.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(e.prefetchProfile&&!["none","fileSystem","network"].includes(e.prefetchProfile))throw new TypeError("options.prefetchProfile, when provided, must be one of 'none', 'fileSystem' or 'network'.");super(),this._options=e,this._orchestrator=new Bs({maxCacheSize:e.maxCacheSize??8*2**20,maxWorkerCount:2,prefetchProfile:As[e.prefetchProfile??"none"],runWorker:this._runWorker.bind(this)})}_retrieveSize(){let e=this._options.getSize();if(e instanceof Promise)return e.then(t=>{if(!Number.isInteger(t)||t<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=t,t});if(!Number.isInteger(e)||e<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){for(;e.currentPos<e.targetPos&&!e.aborted;){let t=e.currentPos,r=e.targetPos,i=this._options.read(e.currentPos,r);if(i instanceof Promise&&(i=await i),i instanceof Uint8Array){if(i=ne(i),i.length!==r-e.currentPos)throw new Error("options.read returned a Uint8Array with unexpected length: Requested ".concat(r-e.currentPos," bytes, but got ").concat(i.length,"."));this.onread?.(e.currentPos,e.currentPos+i.length),this._orchestrator.supplyWorkerData(e,i)}else if(i instanceof ReadableStream){let s=i.getReader();for(;e.currentPos<r&&!e.aborted;){let{done:n,value:a}=await s.read();if(n){if(e.currentPos<r)throw new Error("ReadableStream returned by options.read ended before supplying enough data. Requested ".concat(r-t," bytes, but got ").concat(e.currentPos-t));break}if(!(a instanceof Uint8Array))throw new TypeError("ReadableStream returned by options.read must yield Uint8Array chunks.");let o=ne(a);this.onread?.(e.currentPos,e.currentPos+o.length),this._orchestrator.supplyWorkerData(e,o)}}else throw new TypeError("options.read must return or resolve to a Uint8Array or a ReadableStream.")}e.running=!1}_dispose(){this._orchestrator.dispose(),this._options.dispose?.()}},eu=class extends Kt{constructor(e,t={}){if(!(e instanceof ReadableStream))throw new TypeError("stream must be a ReadableStream.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!kr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._reader=null,this._cache=[],this._pendingSlices=[],this._currentIndex=0,this._targetIndex=0,this._maxRequestedIndex=0,this._endIndex=null,this._pulling=!1,this._stream=e,this._maxCacheSize=t.maxCacheSize??16*2**20}_retrieveSize(){return this._endIndex}_read(e,t){if(this._endIndex!==null&&t>this._endIndex)return null;this._maxRequestedIndex=Math.max(this._maxRequestedIndex,t);let r=be(this._cache,e,l=>l.start),i=r!==-1?this._cache[r]:null;if(i&&i.start<=e&&t<=i.end)return{bytes:i.bytes,view:i.view,offset:i.start};let s=e,n=new Uint8Array(t-e);if(r!==-1)for(let l=r;l<this._cache.length;l++){let u=this._cache[l];if(u.start>=t)break;let f=Math.max(e,u.start);f>s&&this._throwDueToCacheMiss();let p=Math.min(t,u.end);f<p&&(n.set(u.bytes.subarray(f-u.start,p-u.start),f-e),s=p)}if(s===t)return{bytes:n,view:oe(n),offset:e};this._currentIndex>s&&this._throwDueToCacheMiss();let{promise:a,resolve:o,reject:c}=Ie();return this._pendingSlices.push({start:e,end:t,bytes:n,resolve:o,reject:c}),this._targetIndex=Math.max(this._targetIndex,t),this._pulling||(this._pulling=!0,this._pull().catch(l=>{if(this._pulling=!1,this._pendingSlices.length>0)this._pendingSlices.forEach(u=>u.reject(l)),this._pendingSlices.length=0;else throw l})),a}_throwDueToCacheMiss(){throw new Error("Read is before the cached region. With ReadableStreamSource, you must access the data more sequentially or increase the size of its cache.")}async _pull(){for(this._reader??(this._reader=this._stream.getReader());this._currentIndex<this._targetIndex&&!this._disposed;){let{done:e,value:t}=await this._reader.read();if(e){for(let s of this._pendingSlices)s.resolve(null);this._pendingSlices.length=0,this._endIndex=this._currentIndex;break}let r=this._currentIndex,i=this._currentIndex+t.byteLength;for(let s=0;s<this._pendingSlices.length;s++){let n=this._pendingSlices[s],a=Math.max(r,n.start),o=Math.min(i,n.end);a<o&&(n.bytes.set(t.subarray(a-r,o-r),a-n.start),o===n.end&&(n.resolve({bytes:n.bytes,view:oe(n.bytes),offset:n.start}),this._pendingSlices.splice(s,1),s--))}for(this._cache.push({start:r,end:i,bytes:t,view:oe(t),age:0});this._cache.length>0;){let s=this._cache[0];if(this._maxRequestedIndex-s.end<=this._maxCacheSize)break;this._cache.shift()}this._currentIndex+=t.byteLength}this._pulling=!1}_dispose(){this._pendingSlices.length=0,this._cache.length=0}},As={none:(e,t)=>({start:e,end:t}),fileSystem:(e,t)=>(e=Math.floor((e-65536)/65536)*65536,t=Math.ceil((t+65536)/65536)*65536,{start:e,end:t}),network:(e,t,r)=>{e=Math.max(0,Math.floor((e-65536)/65536)*65536);for(let s of r){let a=Math.max((s.startPos+s.targetPos)/2,s.targetPos-8388608);if(Yi(e,t,a,s.targetPos)){let o=s.targetPos-s.startPos,c=Math.ceil((o+1)/8388608)*8388608,l=2**Math.ceil(Math.log2(o+1)),u=Math.min(l,c);t=Math.max(t,s.startPos+u)}}return t=Math.max(t,e+Ka),{start:e,end:t}}},Bs=class{constructor(e){this.options=e,this.fileSize=null,this.nextAge=0,this.workers=[],this.cache=[],this.currentCacheSize=0,this.disposed=!1}read(e,t){h(this.fileSize!==null);let r=this.options.prefetchProfile(e,t,this.workers),i=Math.max(r.start,0),s=Math.min(r.end,this.fileSize);h(i<=e&&t<=s);let n=null,a=be(this.cache,e,S=>S.start),o=a!==-1?this.cache[a]:null;o&&o.start<=e&&t<=o.end&&(o.age=this.nextAge++,n={bytes:o.bytes,view:o.view,offset:o.start});let c=be(this.cache,i,S=>S.start),l=n?null:new Uint8Array(t-e),u=0,f=i,p=[];if(c!==-1){for(let S=c;S<this.cache.length;S++){let _=this.cache[S];if(_.start>=s)break;if(_.end<=i)continue;let E=Math.max(i,_.start),A=Math.min(s,_.end);if(h(E<=A),f<E&&p.push({start:f,end:E}),f=A,l){let F=Math.max(e,_.start),B=Math.min(t,_.end);if(F<B){let D=F-e;l.set(_.bytes.subarray(F-_.start,B-_.start),D),D===u&&(u=B-e)}}_.age=this.nextAge++}f<s&&p.push({start:f,end:s})}else p.push({start:i,end:s});if(l&&u>=l.length&&(n={bytes:l,view:oe(l),offset:e}),p.length===0)return h(n),n;let{promise:k,resolve:T,reject:b}=Ie(),C=[];for(let S of p){let _=Math.max(e,S.start),E=Math.min(t,S.end);_===S.start&&E===S.end?C.push(S):_<E&&C.push({start:_,end:E})}for(let S of p){let _=l&&{start:e,bytes:l,holes:C,resolve:T,reject:b},E=!1;for(let A of this.workers)if(Yi(S.start-131072,S.start,A.currentPos,A.targetPos)){A.targetPos=Math.max(A.targetPos,S.end),E=!0,_&&!A.pendingSlices.includes(_)&&A.pendingSlices.push(_),A.running||this.runWorker(A);break}if(!E){let A=this.createWorker(S.start,S.end);_&&(A.pendingSlices=[_]),this.runWorker(A)}}return n||(h(l),n=k.then(S=>({bytes:S,view:oe(S),offset:e}))),n}createWorker(e,t){let r={startPos:e,currentPos:e,targetPos:t,running:!1,aborted:!1,pendingSlices:[],age:this.nextAge++};for(this.workers.push(r);this.workers.length>this.options.maxWorkerCount;){let i=0,s=this.workers[0];for(let n=1;n<this.workers.length;n++){let a=this.workers[n];a.age<s.age&&(i=n,s=a)}if(s.running&&s.pendingSlices.length>0)break;s.aborted=!0,this.workers.splice(i,1)}return r}runWorker(e){h(!e.running),h(e.currentPos<e.targetPos),e.running=!0,e.age=this.nextAge++,this.options.runWorker(e).catch(t=>{if(e.running=!1,e.pendingSlices.length>0)e.pendingSlices.forEach(r=>r.reject(t)),e.pendingSlices.length=0;else throw t})}supplyWorkerData(e,t){if(this.disposed)return;let r=e.currentPos,i=r+t.length;this.insertIntoCache({start:r,end:i,bytes:t,view:oe(t),age:this.nextAge++}),e.currentPos+=t.length,e.targetPos=Math.max(e.targetPos,e.currentPos);for(let s=0;s<e.pendingSlices.length;s++){let n=e.pendingSlices[s],a=Math.max(r,n.start),o=Math.min(i,n.start+n.bytes.length);a<o&&n.bytes.set(t.subarray(a-r,o-r),a-n.start);for(let c=0;c<n.holes.length;c++){let l=n.holes[c];r<=l.start&&i>l.start&&(l.start=i),l.end<=l.start&&(n.holes.splice(c,1),c--)}n.holes.length===0&&(n.resolve(n.bytes),e.pendingSlices.splice(s,1),s--)}for(let s=0;s<this.workers.length;s++){let n=this.workers[s];e===n||n.running||Yi(r,i,n.currentPos,n.targetPos)&&(this.workers.splice(s,1),s--)}}forgetWorker(e){let t=this.workers.indexOf(e);h(t!==-1),this.workers.splice(t,1)}insertIntoCache(e){if(this.options.maxCacheSize===0)return;let t=be(this.cache,e.start,r=>r.start)+1;if(t>0){let r=this.cache[t-1];if(r.end>=e.end)return;if(r.end>e.start){let i=new Uint8Array(e.end-r.start);i.set(r.bytes,0),i.set(e.bytes,e.start-r.start),this.currentCacheSize+=e.end-r.end,r.bytes=i,r.view=oe(i),r.end=e.end,t--,e=r}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length;for(let r=t+1;r<this.cache.length;r++){let i=this.cache[r];if(e.end<=i.start)break;if(e.end>=i.end){this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length,r--;continue}let s=new Uint8Array(i.end-e.start);s.set(e.bytes,0),s.set(i.bytes,i.start-e.start),this.currentCacheSize-=e.end-i.start,e.bytes=s,e.view=oe(s),e.end=i.end,this.cache.splice(r,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let r=0,i=this.cache[0];for(let s=1;s<this.cache.length;s++){let n=this.cache[s];n.age<i.age&&(r=s,i=n)}if(this.currentCacheSize-i.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length}}dispose(){for(let e of this.workers)e.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}};_n();var Xa=class{constructor(e){if(this._demuxerPromise=null,this._format=null,this._disposed=!1,!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof Rt)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof Kt))throw new TypeError("options.source must be a Source.");if(e.source._disposed)throw new Error("options.source must not be disposed.");this._formats=e.formats,this._source=e.source,this._reader=new tu(e.source)}get disposed(){return this._disposed}_getDemuxer(){return this._demuxerPromise??(this._demuxerPromise=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(let e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})())}get source(){return this._source}async getFormat(){return await this._getDemuxer(),h(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}},Ke=class extends Error{constructor(e="Input has been disposed."){super(e),this.name="InputDisposedError"}},tu=class{constructor(e){this.source=e}requestSlice(e,t){if(this.source._disposed)throw new Ke;if(this.fileSize!==null&&e+t>this.fileSize)return null;let r=e+t,i=this.source._read(e,r);return i instanceof Promise?i.then(s=>s?new zi(s.bytes,s.view,s.offset,e,r):null):i?new zi(i.bytes,i.view,i.offset,e,r):null}requestSliceRange(e,t,r){if(this.source._disposed)throw new Ke;if(this.fileSize!==null)return this.requestSlice(e,Ne(this.fileSize-e,t,r));{let i=this.requestSlice(e,r),s=n=>{if(n)return n;let a=c=>(h(c!==null),this.requestSlice(e,Ne(c-e,t,r))),o=this.source._retrieveSize();return o instanceof Promise?o.then(a):a(o)};return i instanceof Promise?i.then(s):s(i)}}},zi=class pn{constructor(t,r,i,s,n){this.bytes=t,this.view=r,this.offset=i,this.start=s,this.end=n,this.bufferPos=s-i}static tempFromBytes(t){return new pn(t,oe(t),0,0,t.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(t){this.bufferPos=t-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(t){this.bufferPos+=t}slice(t,r=this.end-t){if(t<this.start||t+r>this.end)throw new RangeError("Slicing outside of original slice.");return new pn(this.bytes,this.view,this.offset,t,t+r)}},Ge=(e,t)=>{if(e.filePos<e.start||e.filePos+t>e.end)throw new RangeError("Tried reading [".concat(e.filePos,", ").concat(e.filePos+t,"), but slice is [").concat(e.start,", ").concat(e.end,"). This is likely an internal error, please report it alongside the file that caused it."))},Z=(e,t)=>{Ge(e,t);let r=e.bytes.subarray(e.bufferPos,e.bufferPos+t);return e.bufferPos+=t,r},j=e=>(Ge(e,1),e.view.getUint8(e.bufferPos++)),ti=(e,t)=>{Ge(e,2);let r=e.view.getUint16(e.bufferPos,t);return e.bufferPos+=2,r},Le=e=>{Ge(e,2);let t=e.view.getUint16(e.bufferPos,!1);return e.bufferPos+=2,t},Br=e=>{Ge(e,3);let t=fi(e.view,e.bufferPos,!1);return e.bufferPos+=3,t},Ms=e=>{Ge(e,2);let t=e.view.getInt16(e.bufferPos,!1);return e.bufferPos+=2,t},Gt=(e,t)=>{Ge(e,4);let r=e.view.getUint32(e.bufferPos,t);return e.bufferPos+=4,r},L=e=>{Ge(e,4);let t=e.view.getUint32(e.bufferPos,!1);return e.bufferPos+=4,t},Mr=e=>{Ge(e,4);let t=e.view.getUint32(e.bufferPos,!0);return e.bufferPos+=4,t},dr=e=>{Ge(e,4);let t=e.view.getInt32(e.bufferPos,!1);return e.bufferPos+=4,t},ru=e=>{Ge(e,4);let t=e.view.getInt32(e.bufferPos,!0);return e.bufferPos+=4,t},Ya=(e,t)=>{let r,i;return t?(r=Gt(e,!0),i=Gt(e,!0)):(i=Gt(e,!1),r=Gt(e,!1)),i*4294967296+r},mt=e=>{let t=L(e),r=L(e);return t*4294967296+r},iu=e=>{let t=dr(e),r=L(e);return t*4294967296+r},su=e=>{let t=Mr(e);return ru(e)*4294967296+t},nu=e=>{Ge(e,4);let t=e.view.getFloat32(e.bufferPos,!1);return e.bufferPos+=4,t},Za=e=>{Ge(e,8);let t=e.view.getFloat64(e.bufferPos,!1);return e.bufferPos+=8,t},Oe=(e,t)=>{Ge(e,t);let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(e.bytes[e.bufferPos++]);return r},Ja=new Uint8Array([102,76,97,67]),au=38,ou=34,cu=class extends ar{constructor(e,t){super(e),this.metadataWritten=!1,this.blockSizes=[],this.frameSizes=[],this.sampleRate=null,this.channels=null,this.bitsPerSample=null,this.writer=e._writer,this.format=t}async start(){this.writer.write(Ja)}writeHeader({bitsPerSample:e,minimumBlockSize:t,maximumBlockSize:r,minimumFrameSize:i,maximumFrameSize:s,sampleRate:n,channels:a,totalSamples:o}){h(this.writer.getPos()===4);let c=!bi(this.output._metadataTags),l=new he(new Uint8Array(4));l.writeBits(1,+!c),l.writeBits(7,0),l.writeBits(24,ou),this.writer.write(l.bytes);let u=new he(new Uint8Array(18));if(u.writeBits(16,t),u.writeBits(16,r),u.writeBits(24,i),u.writeBits(24,s),u.writeBits(20,n),u.writeBits(3,a-1),u.writeBits(5,e-1),o>=2**32)throw new Error("This muxer only supports writing up to 2 ** 32 samples");u.writeBits(4,0),u.writeBits(32,o),this.writer.write(u.bytes),this.writer.write(new Uint8Array(16))}writePictureBlock(e){let t=32+e.mimeType.length+(e.description?.length??0)+e.data.length,r=new Uint8Array(t),i=0,s=oe(r);s.setUint32(i,e.kind==="coverFront"?3:e.kind==="coverBack"?4:0),i+=4,s.setUint32(i,e.mimeType.length),i+=4,r.set(we.encode(e.mimeType),8),i+=e.mimeType.length,s.setUint32(i,e.description?.length??0),i+=4,r.set(we.encode(e.description??""),i),i+=e.description?.length??0,i+=16,s.setUint32(i,e.data.length),i+=4,r.set(e.data,i),i+=e.data.length,h(i===t);let n=new he(new Uint8Array(4));n.writeBits(1,0),n.writeBits(7,6),n.writeBits(24,t),this.writer.write(n.bytes),this.writer.write(r)}writeVorbisCommentAndPictureBlock(){if(this.writer.seek(au+Ja.byteLength),bi(this.output._metadataTags)){this.metadataWritten=!0;return}let e=this.output._metadataTags.images??[];for(let i of e)this.writePictureBlock(i);let t=rs(new Uint8Array(0),this.output._metadataTags,!1),r=new he(new Uint8Array(4));r.writeBits(1,1),r.writeBits(7,4),r.writeBits(24,t.length),this.writer.write(r.bytes),this.writer.write(t),this.metadataWritten=!0}async getMimeType(){return"audio/flac"}async addEncodedVideoPacket(){throw new Error("FLAC does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();Sr(r),h(r),h(r.decoderConfig),h(r.decoderConfig.description);try{if(this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),this.sampleRate===null&&(this.sampleRate=r.decoderConfig.sampleRate),this.channels===null&&(this.channels=r.decoderConfig.numberOfChannels),this.bitsPerSample===null){let u=new he(ne(r.decoderConfig.description));u.skipBits(167);let f=u.readBits(5)+1;this.bitsPerSample=f}this.metadataWritten||this.writeVorbisCommentAndPictureBlock();let s=zi.tempFromBytes(t.data);Z(s,2);let n=Z(s,2),a=new he(n),o=Ia(a.readBits(4));if(o===null)throw new Error("Invalid FLAC frame: Invalid block size.");Pa(s);let c=Ea(s,o);this.blockSizes.push(c),this.frameSizes.push(t.data.length);let l=this.writer.getPos();this.writer.write(t.data),this.format._options.onFrame&&this.format._options.onFrame(t.data,l),await this.writer.flush()}finally{i()}}addSubtitleCue(){throw new Error("FLAC does not support subtitles.")}async finalize(){let e=await this.mutex.acquire(),t=1/0,r=0,i=1/0,s=0,n=0;for(let a=0;a<this.blockSizes.length;a++)i=Math.min(i,this.frameSizes[a]),s=Math.max(s,this.frameSizes[a]),r=Math.max(r,this.blockSizes[a]),n+=this.blockSizes[a],a!==this.blockSizes.length-1&&(t=Math.min(t,this.blockSizes[a]));h(this.sampleRate!==null),h(this.channels!==null),h(this.bitsPerSample!==null),this.writer.seek(4),this.writeHeader({minimumBlockSize:t,maximumBlockSize:r,minimumFrameSize:i,maximumFrameSize:s,sampleRate:this.sampleRate,channels:this.channels,bitsPerSample:this.bitsPerSample,totalSamples:n}),e()}},ri=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,lu=/^WEBVTT(.|\n)*?\n{2}/,Ri=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,uu=class{constructor(e){this.preambleText=null,this.preambleEmitted=!1,this.options=e}parse(e){e=e.replaceAll("\r\n","\n").replaceAll("\r","\n"),ri.lastIndex=0;let t;if(!this.preambleText){if(!lu.test(e))throw new Error("WebVTT preamble incorrect.");t=ri.exec(e);let r=e.slice(0,t?.index??e.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,t&&(e=e.slice(t.index),ri.lastIndex=0)}for(;t=ri.exec(e);){let r=e.slice(0,t.index),i=t[1],s=t.index+t[0].length,n=e.indexOf("\n",s)+1,a=e.slice(s,n).trim(),o=e.indexOf("\n\n",s);o===-1&&(o=e.length);let c=Fs(t[2]),u=Fs(t[3])-c,f=e.slice(n,o).trim();e=e.slice(o).trimStart(),ri.lastIndex=0;let p={timestamp:c/1e3,duration:u/1e3,text:f,identifier:i,settings:a,notes:r},k={};this.preambleEmitted||(k.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(p,k)}}},du=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,Fs=e=>{let t=du.exec(e);if(!t)throw new Error("Expected match.");return 3600*1e3*Number(t[1]||"0")+60*1e3*Number(t[2])+1e3*Number(t[3])+Number(t[4])},eo=e=>{let t=Math.floor(e/36e5),r=Math.floor(e%(3600*1e3)/(60*1e3)),i=Math.floor(e%(60*1e3)/1e3),s=e%1e3;return t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+s.toString().padStart(3,"0")},to=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let s of e.children)s&&this.writeBox(s);let r=this.writer.getPos(),i=e.size??r-t;this.writer.seek(t),this.writeBoxHeader(e,i),this.writer.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.offsets.get(e);h(t!==void 0);let r=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(r)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let r of e.children)r&&(t+=this.measureBox(r));return t}}},ce=new Uint8Array(8),Ct=new DataView(ce.buffer),_e=e=>[(e%256+256)%256],Q=e=>(Ct.setUint16(0,e,!1),[ce[0],ce[1]]),ro=e=>(Ct.setInt16(0,e,!1),[ce[0],ce[1]]),io=e=>(Ct.setUint32(0,e,!1),[ce[1],ce[2],ce[3]]),O=e=>(Ct.setUint32(0,e,!1),[ce[0],ce[1],ce[2],ce[3]]),Xt=e=>(Ct.setInt32(0,e,!1),[ce[0],ce[1],ce[2],ce[3]]),hr=e=>(Ct.setUint32(0,Math.floor(e/2**32),!1),Ct.setUint32(4,e,!1),[ce[0],ce[1],ce[2],ce[3],ce[4],ce[5],ce[6],ce[7]]),so=e=>(Ct.setInt16(0,2**8*e,!1),[ce[0],ce[1]]),Dt=e=>(Ct.setInt32(0,2**16*e,!1),[ce[0],ce[1],ce[2],ce[3]]),zs=e=>(Ct.setInt32(0,2**30*e,!1),[ce[0],ce[1],ce[2],ce[3]]),Rs=(e,t)=>{let r=[],i=e;do{let s=i&127;i>>=7,r.length>0&&(s|=128),r.push(s),t!==void 0&&t--}while(i>0||t);return r.reverse()},Ve=(e,t=!1)=>{let r=Array(e.length).fill(null).map((i,s)=>e.charCodeAt(s));return t&&r.push(0),r},Ds=e=>{let t=null;for(let r of e)(!t||r.timestamp>t.timestamp)&&(t=r);return t},no=e=>{let t=e*(Math.PI/180),r=Math.round(Math.cos(t)),i=Math.round(Math.sin(t));return[r,i,0,-i,r,0,0,0,1]},ao=no(0),oo=e=>[Dt(e[0]),Dt(e[1]),zs(e[2]),Dt(e[3]),Dt(e[4]),zs(e[5]),Dt(e[6]),Dt(e[7]),zs(e[8])],G=(e,t,r)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:r}),fe=(e,t,r,i,s)=>G(e,[_e(t),io(r),i??[]],s),hu=e=>e.isQuickTime?G("ftyp",[Ve("qt  "),O(512),Ve("qt  ")]):e.fragmented?G("ftyp",[Ve("iso5"),O(512),Ve("iso5"),Ve("iso6"),Ve("mp41")]):G("ftyp",[Ve("isom"),O(512),Ve("isom"),e.holdsAvc?Ve("avc1"):[],Ve("mp41")]),Di=e=>({type:"mdat",largeSize:e}),fu=e=>({type:"free",size:e}),ii=e=>G("moov",void 0,[mu(e.creationTime,e.trackDatas),...e.trackDatas.map(t=>pu(t,e.creationTime)),e.isFragmented?Xu(e.trackDatas):null,ld(e)]),mu=(e,t)=>{let r=De(Math.max(0,...t.filter(a=>a.samples.length>0).map(a=>{let o=Ds(a.samples);return o.timestamp+o.duration})),Ws),i=Math.max(0,...t.map(a=>a.track.id))+1,s=!Re(e)||!Re(r),n=s?hr:O;return fe("mvhd",+s,0,[n(e),n(e),O(Ws),n(r),Dt(1),so(1),Array(10).fill(0),oo(ao),Array(24).fill(0),O(i)])},pu=(e,t)=>{let r=_d(e);return G("trak",void 0,[gu(e,t),wu(e,t),r.name!==void 0?G("udta",void 0,[G("name",[...we.encode(r.name)])]):null])},gu=(e,t)=>{let r=Ds(e.samples),i=De(r?r.timestamp+r.duration:0,Ws),s=!Re(t)||!Re(i),n=s?hr:O,a;if(e.type==="video"){let o=e.track.metadata.rotation;a=no(o??0)}else a=ao;return fe("tkhd",+s,3,[n(t),n(t),O(e.track.id),O(0),n(i),Array(8).fill(0),Q(0),Q(e.track.id),so(e.type==="audio"?1:0),Q(0),oo(a),Dt(e.type==="video"?e.info.width:0),Dt(e.type==="video"?e.info.height:0)])},wu=(e,t)=>G("mdia",void 0,[bu(e,t),Ns(!0,yu[e.type],ku[e.type]),Tu(e)]),bu=(e,t)=>{let r=Ds(e.samples),i=De(r?r.timestamp+r.duration:0,e.timescale),s=!Re(t)||!Re(i),n=s?hr:O;return fe("mdhd",+s,0,[n(t),n(t),O(e.timescale),n(i),Q(po(e.track.metadata.languageCode??rt)),Q(0)])},yu={video:"vide",audio:"soun",subtitle:"text"},ku={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Ns=(e,t,r,i="\0\0\0\0")=>fe("hdlr",0,0,[e?Ve("mhlr"):O(0),Ve(t),Ve(i),O(0),O(0),Ve(r,!0)]),Tu=e=>G("minf",void 0,[_u[e.type](),xu(),Eu(e)]),Su=()=>fe("vmhd",0,1,[Q(0),Q(0),Q(0),Q(0)]),vu=()=>fe("smhd",0,0,[Q(0),Q(0)]),Cu=()=>fe("nmhd",0,0),_u={video:Su,audio:vu,subtitle:Cu},xu=()=>G("dinf",void 0,[Iu()]),Iu=()=>fe("dref",0,0,[O(1)],[Pu()]),Pu=()=>fe("url ",0,1),Eu=e=>{let t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some(r=>r.sampleCompositionTimeOffset!==0);return G("stbl",void 0,[Au(e),Hu(e),t?Ku(e):null,t?Gu(e):null,qu(e),ju(e),Qu(e),$u(e)])},Au=e=>{let t;if(e.type==="video")t=Bu(fd[e.track.source._codec],e);else if(e.type==="audio"){let r=mo(e.track.source._codec,e.muxer.isQuickTime);h(r),t=Du(r,e)}else e.type==="subtitle"&&(t=Vu(gd[e.track.source._codec],e));return h(t),fe("stsd",0,0,[O(1)],[t])},Bu=(e,t)=>G(e,[Array(6).fill(0),Q(1),Q(0),Q(0),Array(12).fill(0),Q(t.info.width),Q(t.info.height),O(4718592),O(4718592),O(0),Q(1),Array(32).fill(0),Q(24),ro(65535)],[md[t.track.source._codec](t),di(t.info.decoderConfig.colorSpace)?Mu(t):null]),Mu=e=>G("colr",[Ve("nclx"),Q(tt[e.info.decoderConfig.colorSpace.primaries]),Q(Vt[e.info.decoderConfig.colorSpace.transfer]),Q(At[e.info.decoderConfig.colorSpace.matrix]),_e((e.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),Fu=e=>e.info.decoderConfig&&G("avcC",[...ne(e.info.decoderConfig.description)]),zu=e=>e.info.decoderConfig&&G("hvcC",[...ne(e.info.decoderConfig.description)]),co=e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig,r=t.codec.split("."),i=Number(r[1]),s=Number(r[2]),n=Number(r[3]),a=r[4]?Number(r[4]):1,o=r[8]?Number(r[8]):Number(t.colorSpace?.fullRange??0),c=(n<<4)+(a<<1)+o,l=r[5]?Number(r[5]):t.colorSpace?.primaries?tt[t.colorSpace.primaries]:2,u=r[6]?Number(r[6]):t.colorSpace?.transfer?Vt[t.colorSpace.transfer]:2,f=r[7]?Number(r[7]):t.colorSpace?.matrix?At[t.colorSpace.matrix]:2;return fe("vpcC",1,0,[_e(i),_e(s),_e(c),_e(l),_e(u),_e(f),Q(0)])},Ru=e=>G("av1C",Bn(e.info.decoderConfig.codec)),Du=(e,t)=>{let r=0,i,s=16;if(ze.includes(t.track.source._codec)){let n=t.track.source._codec,{sampleSize:a}=Tt(n);s=8*a,s>16&&(r=1)}return r===0?i=[Array(6).fill(0),Q(1),Q(r),Q(0),O(0),Q(t.info.numberOfChannels),Q(s),Q(0),Q(0),Q(t.info.sampleRate<2**16?t.info.sampleRate:0),Q(0)]:i=[Array(6).fill(0),Q(1),Q(r),Q(0),O(0),Q(t.info.numberOfChannels),Q(Math.min(s,16)),Q(0),Q(0),Q(t.info.sampleRate<2**16?t.info.sampleRate:0),Q(0),O(1),O(s/8),O(t.info.numberOfChannels*s/8),O(2)],G(e,i,[pd(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},Os=e=>{let t;switch(e.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw new Error("Unhandled audio codec: ".concat(e.track.source._codec))}let r=[..._e(t),..._e(21),...io(0),...O(0),...O(0)];if(e.info.decoderConfig.description){let i=ne(e.info.decoderConfig.description);r=[...r,..._e(5),...Rs(i.byteLength),...i]}return r=[...Q(1),..._e(0),..._e(4),...Rs(r.length),...r,..._e(6),..._e(1),..._e(2)],r=[..._e(3),...Rs(r.length),...r],fe("esds",0,0,r)},Yt=e=>G("wave",void 0,[Nu(e),Ou(e),G("\0\0\0\0")]),Nu=e=>G("frma",[Ve(mo(e.track.source._codec,e.muxer.isQuickTime))]),Ou=e=>{let{littleEndian:t}=Tt(e.track.source._codec);return G("enda",[Q(+t)])},Uu=e=>{let t=e.info.numberOfChannels,r=3840,i=e.info.sampleRate,s=0,n=0,a=new Uint8Array(0),o=e.info.decoderConfig?.description;if(o){h(o.byteLength>=18);let c=ne(o),l=Ti(c);t=l.outputChannelCount,r=l.preSkip,i=l.inputSampleRate,s=l.outputGain,n=l.channelMappingFamily,l.channelMappingTable&&(a=l.channelMappingTable)}return G("dOps",[_e(0),_e(t),Q(r),O(i),ro(s),_e(n),...a])},Lu=e=>{let t=e.info.decoderConfig?.description;h(t);let r=ne(t);return fe("dfLa",0,0,[...r.subarray(4)])},_t=e=>{let{littleEndian:t,sampleSize:r}=Tt(e.track.source._codec),i=+t;return fe("pcmC",0,0,[_e(i),_e(8*r)])},Vu=(e,t)=>G(e,[Array(6).fill(0),Q(1)],[wd[t.track.source._codec](t)]),Wu=e=>G("vttC",[...we.encode(e.info.config.description)]),Hu=e=>fe("stts",0,0,[O(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[O(t.sampleCount),O(t.sampleDelta)])]),$u=e=>{if(e.samples.every(r=>r.type==="key"))return null;let t=[...e.samples.entries()].filter(([,r])=>r.type==="key");return fe("stss",0,0,[O(t.length),t.map(([r])=>O(r+1))])},qu=e=>fe("stsc",0,0,[O(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[O(t.firstChunk),O(t.samplesPerChunk),O(1)])]),ju=e=>{if(e.type==="audio"&&e.info.requiresPcmTransformation){let{sampleSize:t}=Tt(e.track.source._codec);return fe("stsz",0,0,[O(t*e.info.numberOfChannels),O(e.samples.reduce((r,i)=>r+De(i.duration,e.timescale),0))])}return fe("stsz",0,0,[O(0),O(e.samples.length),e.samples.map(t=>O(t.size))])},Qu=e=>e.finalizedChunks.length>0&&se(e.finalizedChunks).offset>=2**32?fe("co64",0,0,[O(e.finalizedChunks.length),e.finalizedChunks.map(t=>hr(t.offset))]):fe("stco",0,0,[O(e.finalizedChunks.length),e.finalizedChunks.map(t=>O(t.offset))]),Ku=e=>fe("ctts",1,0,[O(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map(t=>[O(t.sampleCount),Xt(t.sampleCompositionTimeOffset)])]),Gu=e=>{let t=1/0,r=-1/0,i=1/0,s=-1/0;h(e.compositionTimeOffsetTable.length>0),h(e.samples.length>0);for(let a=0;a<e.compositionTimeOffsetTable.length;a++){let o=e.compositionTimeOffsetTable[a];t=Math.min(t,o.sampleCompositionTimeOffset),r=Math.max(r,o.sampleCompositionTimeOffset)}for(let a=0;a<e.samples.length;a++){let o=e.samples[a];i=Math.min(i,De(o.timestamp,e.timescale)),s=Math.max(s,De(o.timestamp+o.duration,e.timescale))}let n=Math.max(-t,0);return s>=2**31?null:fe("cslg",0,0,[Xt(n),Xt(t),Xt(r),Xt(i),Xt(s)])},Xu=e=>G("mvex",void 0,e.map(Yu)),Yu=e=>fe("trex",0,0,[O(e.track.id),O(1),O(0),O(0),O(0)]),lo=(e,t)=>G("moof",void 0,[Zu(e),...t.map(Ju)]),Zu=e=>fe("mfhd",0,0,[O(e)]),uo=e=>{let t=0,r=0,i=0,s=0,n=e.type==="delta";return r|=+n,n?t|=1:t|=2,t<<24|r<<16|i<<8|s},Ju=e=>G("traf",void 0,[ed(e),td(e),rd(e)]),ed=e=>{h(e.currentChunk);let t=0;t|=8,t|=16,t|=32,t|=131072;let r=e.currentChunk.samples[1]??e.currentChunk.samples[0],i={duration:r.timescaleUnitsToNextSample,size:r.size,flags:uo(r)};return fe("tfhd",0,t,[O(e.track.id),O(i.duration),O(i.size),O(i.flags)])},td=e=>(h(e.currentChunk),fe("tfdt",1,0,[hr(De(e.currentChunk.startTimestamp,e.timescale))])),rd=e=>{h(e.currentChunk);let t=e.currentChunk.samples.map(b=>b.timescaleUnitsToNextSample),r=e.currentChunk.samples.map(b=>b.size),i=e.currentChunk.samples.map(uo),s=e.currentChunk.samples.map(b=>De(b.timestamp-b.decodeTimestamp,e.timescale)),n=new Set(t),a=new Set(r),o=new Set(i),c=new Set(s),l=o.size===2&&i[0]!==i[1],u=n.size>1,f=a.size>1,p=!l&&o.size>1,k=c.size>1||[...c].some(b=>b!==0),T=0;return T|=1,T|=4*+l,T|=256*+u,T|=512*+f,T|=1024*+p,T|=2048*+k,fe("trun",1,T,[O(e.currentChunk.samples.length),O(e.currentChunk.offset-e.currentChunk.moofOffset||0),l?O(i[0]):[],e.currentChunk.samples.map((b,C)=>[u?O(t[C]):[],f?O(r[C]):[],p?O(i[C]):[],k?Xt(s[C]):[]])])},id=e=>G("mfra",void 0,[...e.map(sd),nd()]),sd=(e,t)=>fe("tfra",1,0,[O(e.track.id),O(63),O(e.finalizedChunks.length),e.finalizedChunks.map(i=>[hr(De(i.samples[0].timestamp,e.timescale)),hr(i.moofOffset),O(t+1),O(1),O(1)])]),nd=()=>fe("mfro",0,0,[O(0)]),ad=()=>G("vtte"),od=(e,t,r,i,s)=>G("vttc",void 0,[s!==null?G("vsid",[Xt(s)]):null,r!==null?G("iden",[...we.encode(r)]):null,t!==null?G("ctim",[...we.encode(eo(t))]):null,i!==null?G("sttg",[...we.encode(i)]):null,G("payl",[...we.encode(e)])]),cd=e=>G("vtta",[...we.encode(e)]),ld=e=>{let t=[],r=e.format._options.metadataFormat??"auto",i=e.output._metadataTags;if(r==="mdir"||r==="auto"&&!e.isQuickTime){let s=dd(i);s&&t.push(s)}else if(r==="mdta"){let s=hd(i);s&&t.push(s)}else(r==="udta"||r==="auto"&&e.isQuickTime)&&ud(t,e.output._metadataTags);return t.length===0?null:G("udta",void 0,t)},ud=(e,t)=>{for(let{key:r,value:i}of yr(t))switch(r){case"title":e.push(xt("\xA9nam",i));break;case"description":e.push(xt("\xA9des",i));break;case"artist":e.push(xt("\xA9ART",i));break;case"album":e.push(xt("\xA9alb",i));break;case"albumArtist":e.push(xt("albr",i));break;case"genre":e.push(xt("\xA9gen",i));break;case"date":e.push(xt("\xA9day",i.toISOString().slice(0,10)));break;case"comment":e.push(xt("\xA9cmt",i));break;case"lyrics":e.push(xt("\xA9lyr",i));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:$e(r)}if(t.raw)for(let r in t.raw){let i=t.raw[r];i==null||r.length!==4||e.some(s=>s.type===r)||(typeof i=="string"?e.push(xt(r,i)):i instanceof Uint8Array&&e.push(G(r,Array.from(i))))}},xt=(e,t)=>{let r=we.encode(t);return G(e,[Q(r.length),Q(po("und")),Array.from(r)])},ho={"image/jpeg":13,"image/png":14,"image/bmp":27},fo=(e,t)=>{let r=[];for(let{key:i,value:s}of yr(e))switch(i){case"title":r.push({key:t?"title":"\xA9nam",value:pt(s)});break;case"description":r.push({key:t?"description":"\xA9des",value:pt(s)});break;case"artist":r.push({key:t?"artist":"\xA9ART",value:pt(s)});break;case"album":r.push({key:t?"album":"\xA9alb",value:pt(s)});break;case"albumArtist":r.push({key:t?"album_artist":"aART",value:pt(s)});break;case"comment":r.push({key:t?"comment":"\xA9cmt",value:pt(s)});break;case"genre":r.push({key:t?"genre":"\xA9gen",value:pt(s)});break;case"lyrics":r.push({key:t?"lyrics":"\xA9lyr",value:pt(s)});break;case"date":r.push({key:t?"date":"\xA9day",value:pt(s.toISOString().slice(0,10))});break;case"images":for(let n of s)n.kind==="coverFront"&&r.push({key:"covr",value:G("data",[O(ho[n.mimeType]??0),O(0),Array.from(n.data)])});break;case"trackNumber":if(t){let n=e.tracksTotal!==void 0?"".concat(s,"/").concat(e.tracksTotal):s.toString();r.push({key:"track",value:pt(n)})}else r.push({key:"trkn",value:G("data",[O(0),O(0),Q(0),Q(s),Q(e.tracksTotal??0),Q(0)])});break;case"discNumber":t||r.push({key:"disc",value:G("data",[O(0),O(0),Q(0),Q(s),Q(e.discsTotal??0),Q(0)])});break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:$e(i)}if(e.raw)for(let i in e.raw){let s=e.raw[i];s==null||!t&&i.length!==4||r.some(n=>n.key===i)||(typeof s=="string"?r.push({key:i,value:pt(s)}):s instanceof Uint8Array?r.push({key:i,value:G("data",[O(0),O(0),Array.from(s)])}):s instanceof sr&&r.push({key:i,value:G("data",[O(ho[s.mimeType]??0),O(0),Array.from(s.data)])}))}return r},dd=e=>{let t=fo(e,!1);return t.length===0?null:fe("meta",0,0,void 0,[Ns(!1,"mdir","","appl"),G("ilst",void 0,t.map(r=>G(r.key,void 0,[r.value])))])},hd=e=>{let t=fo(e,!0);return t.length===0?null:G("meta",void 0,[Ns(!1,"mdta",""),fe("keys",0,0,[O(t.length)],t.map(r=>G("mdta",[...we.encode(r.key)]))),G("ilst",void 0,t.map((r,i)=>{let s=String.fromCharCode(...O(i+1));return G(s,void 0,[r.value])}))])},pt=e=>G("data",[O(1),O(0),...we.encode(e)]),fd={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},md={avc:Fu,hevc:zu,vp8:co,vp9:co,av1:Ru},mo=(e,t)=>{switch(e){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(e){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(e){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},pd=(e,t)=>{switch(e){case"aac":return Os;case"mp3":return Os;case"opus":return Uu;case"vorbis":return Os;case"flac":return Lu}if(t)switch(e){case"pcm-s24":return Yt;case"pcm-s24be":return Yt;case"pcm-s32":return Yt;case"pcm-s32be":return Yt;case"pcm-f32":return Yt;case"pcm-f32be":return Yt;case"pcm-f64":return Yt;case"pcm-f64be":return Yt}else switch(e){case"pcm-s16":return _t;case"pcm-s16be":return _t;case"pcm-s24":return _t;case"pcm-s24be":return _t;case"pcm-s32":return _t;case"pcm-s32be":return _t;case"pcm-f32":return _t;case"pcm-f32be":return _t;case"pcm-f64":return _t;case"pcm-f64be":return _t}return null},gd={webvtt:"wvtt"},wd={webvtt:Wu},po=e=>{h(e.length===3);let t=0;for(let r=0;r<3;r++)t<<=5,t+=e.charCodeAt(r)-96;return t},Us=class{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}let r=t+e.byteLength-this.trackedStart,i=this.trackedWrites.byteLength;for(;i<r;)i*=2;if(i!==this.trackedWrites.byteLength){let s=new Uint8Array(i);s.set(this.trackedWrites,0),this.trackedWrites=s}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let t={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,t}},Ls=2**16,Vs=2**32,go=class extends Us{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(Ls,{maxByteLength:Vs})}catch{this.buffer=new ArrayBuffer(Ls),this.supportsResize=!1}else this.buffer=new ArrayBuffer(Ls);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>Vs)throw new Error("ArrayBuffer exceeded maximum size of ".concat(Vs," bytes. Please consider using another target."));if(this.supportsResize)this.buffer.resize(t);else{let r=new ArrayBuffer(t),i=new Uint8Array(r);i.set(this.bytes,0),this.buffer=r,this.bytes=i}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}},bd=2**24,yd=2,kd=class extends Us{constructor(e){super(),this.pos=0,this.sections=[],this.lastWriteEnd=0,this.lastFlushEnd=0,this.writer=null,this.chunks=[],this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??bd}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let t=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(t))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}if(h(this.writer),this.sections.length===0)return;let e=[],t=[...this.sections].sort((r,i)=>r.start-i.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let r=1;r<t.length;r++){let i=e[e.length-1],s=t[r];s.start<=i.start+i.size?i.size=Math.max(i.size,s.start+s.data.byteLength-i.start):e.push({start:s.start,size:s.data.byteLength})}for(let r of e){r.data=new Uint8Array(r.size);for(let i of this.sections)r.start<=i.start&&i.start<r.start+r.size&&r.data.set(i.data,i.start-r.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(r.data,r.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&r.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data,position:r.start}),this.lastFlushEnd=r.start+r.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,t){let r=this.chunks.findIndex(o=>o.start<=t&&t<o.start+this.chunkSize);r===-1&&(r=this.createChunk(t));let i=this.chunks[r],s=t-i.start,n=e.subarray(0,Math.min(this.chunkSize-s,e.byteLength));i.data.set(n,s);let a={start:s,end:s+n.byteLength};if(this.insertSectionIntoChunk(i,a),i.written[0].start===0&&i.written[0].end===this.chunkSize&&(i.shouldFlush=!0),this.chunks.length>yd){for(let o=0;o<this.chunks.length-1;o++)this.chunks[o].shouldFlush=!0;this.tryToFlushChunks()}n.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(n.byteLength),t+n.byteLength)}insertSectionIntoChunk(e,t){let r=0,i=e.written.length-1,s=-1;for(;r<=i;){let n=Math.floor(r+(i-r+1)/2);e.written[n].start<=t.start?(r=n+1,s=n):i=n-1}for(e.written.splice(s+1,0,t),(s===-1||e.written[s].end<t.start)&&s++;s<e.written.length-1&&e.written[s].end>=e.written[s+1].start;)e.written[s].end=Math.max(e.written[s].end,e.written[s+1].end),e.written.splice(s+1,1)}createChunk(e){let r={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((i,s)=>i.start-s.start),this.chunks.indexOf(r)}tryToFlushChunks(e=!1){h(this.writer);for(let t=0;t<this.chunks.length;t++){let r=this.chunks[t];if(!(!r.shouldFlush&&!e)){for(let i of r.written){let s=r.start+i.start;if(this.ensureMonotonicity&&s!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data.subarray(i.start,i.end),position:s}),this.lastFlushEnd=r.start+i.end}this.chunks.splice(t--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),h(this.writer),this.writer.close()}async close(){return this.writer?.close()}},Td=class extends Us{constructor(e){super(),this.target=e,this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}},wo=X(ve(),1),Sd=typeof wo<"u"?wo:void 0,Fr=class{constructor(){this._output=null,this.onwrite=null}},bo=class extends Fr{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new go(this)}},yo=class extends Fr{constructor(e,t={}){if(super(),!(e instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(t!=null&&typeof t!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(t.chunked!==void 0&&typeof t.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(t.chunkSize!==void 0&&(!Number.isInteger(t.chunkSize)||t.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=e,this._options=t}_createWriter(){return new kd(this)}},vd=class extends Fr{constructor(e,t={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");super(),this._fileHandle=null;let r=new WritableStream({start:async()=>{this._fileHandle=await Sd.fs.open(e,"w")},write:async i=>{h(this._fileHandle),await this._fileHandle.write(i.data,0,i.data.byteLength,i.position)},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}});this._streamTarget=new yo(r,{chunked:!0,...t}),this._streamTarget._output=this._output}_createWriter(){return this._streamTarget._createWriter()}},ko=class extends Fr{_createWriter(){return new Td(this)}},Ws=1e3,Cd=2082844800,_d=e=>{let t={},r=e.track;return r.metadata.name!==void 0&&(t.name=r.metadata.name),t},De=(e,t,r=!0)=>{let i=e*t;return r?Math.round(i):i},xd=class extends ar{constructor(e,t){super(e),this.auxTarget=new bo,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new to(this.auxWriter),this.mdat=null,this.ftypSize=null,this.trackDatas=[],this.allTracksKnown=Ie(),this.creationTime=Math.floor(Date.now()/1e3)+Cd,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new to(this.writer),this.isQuickTime=t instanceof qs;let r=this.writer instanceof go?"in-memory":!1;this.fastStart=t._options.fastStart??r,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),t=this.output._tracks.some(r=>r.type==="video"&&r.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(hu({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onFtyp(r,i)}if(this.ftypSize=this.writer.getPos(),this.fastStart!=="in-memory")if(this.fastStart==="reserve"){for(let r of this.output._tracks)if(r.metadata.maximumPacketCount===void 0)throw new Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Di(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return ta({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,r){let i=this.trackDatas.find(c=>c.track===e);if(i)return i;Nn(r),h(r),h(r.decoderConfig);let s={...r.decoderConfig};h(s.codedWidth!==void 0),h(s.codedHeight!==void 0);let n=!1;if(e.source._codec==="avc"&&!s.description){let c=Ln(t.data);if(!c)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");s.description=Wc(c),n=!0}else if(e.source._codec==="hevc"&&!s.description){let c=Wn(t.data);if(!c)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");s.description=Gc(c),n=!0}let a=vc(1/(e.metadata.frameRate??57600),1e6).denominator,o={muxer:this,track:e,type:"video",info:{width:s.codedWidth,height:s.codedHeight,decoderConfig:s,requiresAnnexBTransformation:n},timescale:a,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(o),this.trackDatas.sort((c,l)=>c.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}getAudioTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;Sr(t),h(t),h(t.decoderConfig);let i={muxer:this,track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig,requiresPcmTransformation:!this.isFragmented&&ze.includes(e.source._codec)},timescale:t.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(i),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;On(t),h(t),h(t.config);let i={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(i),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,t,r),n=t.data;if(s.info.requiresAnnexBTransformation){let c=Lc(n);if(!c)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");n=c}let a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),o=this.createSampleForTrack(s,n,a,t.duration,t.type);await this.registerSample(s,o)}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r),n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),a=this.createSampleForTrack(s,t.data,n,t.duration,t.type);s.info.requiresPcmTransformation&&await this.maybePadWithSilence(s,n),await this.registerSample(s,a)}finally{i()}}async maybePadWithSilence(e,t){let r=se(e.samples),i=r?r.timestamp+r.duration:0,s=t-i,n=De(s,e.timescale);if(n>0){let{sampleSize:a,silentValue:o}=Tt(e.info.decoderConfig.codec),c=n*e.info.numberOfChannels,l=new Uint8Array(a*c).fill(o),u=this.createSampleForTrack(e,new Uint8Array(l.buffer),i,s,"key");await this.registerSample(e,u)}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,r);this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),e.source._codec==="webvtt"&&(s.cueQueue.push(t),await this.processWebVTTCues(s,t.timestamp))}finally{i()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){let r=new Set([]);for(let c of e.cueQueue)h(c.timestamp<=t),h(e.lastCueEndTimestamp<=c.timestamp+c.duration),r.add(Math.max(c.timestamp,e.lastCueEndTimestamp)),r.add(c.timestamp+c.duration);let i=[...r].sort((c,l)=>c-l),s=i[0],n=i[1]??s;if(t<n)break;if(e.lastCueEndTimestamp<s){this.auxWriter.seek(0);let c=ad();this.auxBoxWriter.writeBox(c);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,l,e.lastCueEndTimestamp,s-e.lastCueEndTimestamp,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let c=0;c<e.cueQueue.length;c++){let l=e.cueQueue[c];if(l.timestamp>=n)break;Ri.lastIndex=0;let u=Ri.test(l.text),f=l.timestamp+l.duration,p=e.cueToSourceId.get(l);if(p===void 0&&n<f&&(p=e.nextSourceId++,e.cueToSourceId.set(l,p)),l.notes){let T=cd(l.notes);this.auxBoxWriter.writeBox(T)}let k=od(l.text,u?s:null,l.identifier??null,l.settings??null,p??null);this.auxBoxWriter.writeBox(k),f===n&&e.cueQueue.splice(c--,1)}let a=this.auxWriter.getSlice(0,this.auxWriter.getPos()),o=this.createSampleForTrack(e,a,s,n-s,"key");await this.registerSample(e,o),e.lastCueEndTimestamp=n}}createSampleForTrack(e,t,r,i,s){return{timestamp:r,decodeTimestamp:r,duration:i,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:De(i,e.timescale)}}processTimestamps(e,t){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let i=0;for(let s=0;s<e.timestampProcessingQueue.length;s++){let n=e.timestampProcessingQueue[s],a=De(n.duration,e.timescale);i+=a}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:i,sampleDelta:1});else{let s=se(e.timeToSampleTable);s.sampleCount+=i}e.timestampProcessingQueue.length=0;return}let r=e.timestampProcessingQueue.map(i=>i.timestamp).sort((i,s)=>i-s);for(let i=0;i<e.timestampProcessingQueue.length;i++){let s=e.timestampProcessingQueue[i];s.decodeTimestamp=r[i],!this.isFragmented&&e.lastTimescaleUnits===null&&(s.decodeTimestamp=0);let n=De(s.timestamp-s.decodeTimestamp,e.timescale),a=De(s.duration,e.timescale);if(e.lastTimescaleUnits!==null){h(e.lastSample);let o=De(s.decodeTimestamp,e.timescale,!1),c=Math.round(o-e.lastTimescaleUnits);if(h(c>=0),e.lastTimescaleUnits+=c,e.lastSample.timescaleUnitsToNextSample=c,!this.isFragmented){let l=se(e.timeToSampleTable);if(h(l),l.sampleCount===1){l.sampleDelta=c;let f=e.timeToSampleTable[e.timeToSampleTable.length-2];f&&f.sampleDelta===c&&(f.sampleCount++,e.timeToSampleTable.pop(),l=f)}else l.sampleDelta!==c&&(l.sampleCount--,e.timeToSampleTable.push(l={sampleCount:1,sampleDelta:c}));l.sampleDelta===a?l.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:a});let u=se(e.compositionTimeOffsetTable);h(u),u.sampleCompositionTimeOffset===n?u.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:n})}}else e.lastTimescaleUnits=De(s.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:a}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:n}));e.lastSample=s}if(e.timestampProcessingQueue.length=0,h(e.lastSample),h(e.lastTimescaleUnits!==null),t!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){h(t.type==="key");let i=De(t.timestamp,e.timescale,!1),s=Math.round(i-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=s}}async registerSample(e,t){t.type==="key"&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):this.fastStart==="reserve"?await this.registerSampleFastStartReserve(e,t):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){if(!this.isFragmented&&(e.samples.push(t),this.fastStart==="reserve")){let i=e.track.metadata.maximumPacketCount;if(h(i!==void 0),e.samples.length>i)throw new Error("Track #".concat(e.track.id," has already reached the maximum packet count (").concat(i,"). Either add less packets or increase the maximum packet count."))}let r=!1;if(!e.currentChunk)r=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);let i=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let s=this.trackDatas.every(n=>{if(e===n)return t.type==="key";let a=n.sampleQueue[0];return a?a.type==="key":n.track.source._closed});i>=this.minimumFragmentDuration&&s&&t.timestamp>this.maxWrittenTimestamp&&(r=!0,await this.finalizeFragment())}else r=i>=.5}r&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),h(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if(h(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((r,i)=>r+De(i.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||se(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(let r of e.currentChunk.samples)h(r.data),this.writer.write(r.data),r.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(h(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let t=null,r=1/0;for(let s of this.trackDatas){if(!e&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<r&&(t=s,r=s.sampleQueue[0].timestamp)}if(!t)break;let i=t.sampleQueue.shift();await this.addSampleToTrack(t,i)}}async finalizeFragment(e=!0){h(this.isFragmented);let t=this.nextFragmentNumber++;if(t===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let p=ii(this);if(this.boxWriter.writeBox(p),this.format._options.onMoov){let{data:k,start:T}=this.writer.stopTrackingWrites();this.format._options.onMoov(k,T)}}let r=this.trackDatas.filter(p=>p.currentChunk),i=lo(t,r),s=this.writer.getPos(),n=s+this.boxWriter.measureBox(i),a=n+Mt,o=1/0;for(let p of r){p.currentChunk.offset=a,p.currentChunk.moofOffset=s;for(let k of p.currentChunk.samples)a+=k.size;o=Math.min(o,p.currentChunk.startTimestamp)}let c=a-n,l=c>=2**32;if(l)for(let p of r)p.currentChunk.offset+=cr-Mt;this.format._options.onMoof&&this.writer.startTrackingWrites();let u=lo(t,r);if(this.boxWriter.writeBox(u),this.format._options.onMoof){let{data:p,start:k}=this.writer.stopTrackingWrites();this.format._options.onMoof(p,k,o)}h(this.writer.getPos()===n),this.format._options.onMdat&&this.writer.startTrackingWrites();let f=Di(l);f.size=c,this.boxWriter.writeBox(f),this.writer.seek(n+(l?cr:Mt));for(let p of r)for(let k of p.currentChunk.samples)this.writer.write(k.data),k.data=null;if(this.format._options.onMdat){let{data:p,start:k}=this.writer.stopTrackingWrites();this.format._options.onMdat(p,k)}for(let p of r)p.finalizedChunks.push(p.currentChunk),this.finalizedChunks.push(p.currentChunk),p.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,t){if(this.allTracksAreKnown()){if(!this.mdat){let r=ii(this),s=this.boxWriter.measureBox(r)+this.computeSampleTableSizeUpperBound()+4096;h(this.ftypSize!==null),this.writer.seek(this.ftypSize+s),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Di(!0),this.boxWriter.writeBox(this.mdat);for(let n of this.trackDatas){for(let a of n.sampleQueue)await this.addSampleToTrack(n,a);n.sampleQueue.length=0}}await this.addSampleToTrack(e,t)}else e.sampleQueue.push(t)}computeSampleTableSizeUpperBound(){h(this.fastStart==="reserve");let e=0;for(let t of this.trackDatas){let r=t.track.metadata.maximumPacketCount;h(r!==void 0),e+=8*Math.ceil(2/3*r),e+=4*r,e+=8*Math.ceil(2/3*r),e+=12*Math.ceil(2/3*r),e+=4*r,e+=8*r}return e}async onTrackClose(e){let t=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){let r=this.trackDatas.find(i=>i.track===e);r&&await this.processWebVTTCues(r,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve();for(let t of this.trackDatas)t.type==="subtitle"&&t.track.source._codec==="webvtt"&&await this.processWebVTTCues(t,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let t of this.trackDatas)this.processTimestamps(t);await this.finalizeFragment(!1)}else for(let t of this.trackDatas)this.processTimestamps(t),await this.finalizeCurrentChunk(t);if(this.fastStart==="in-memory"){this.mdat=Di(!1);let t;for(let i=0;i<2;i++){let s=ii(this),n=this.boxWriter.measureBox(s);t=this.boxWriter.measureBox(this.mdat);let a=this.writer.getPos()+n+t;for(let o of this.finalizedChunks){o.offset=a;for(let{data:c}of o.samples)h(c),a+=c.byteLength,t+=c.byteLength}if(a<2**32)break;t>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let r=ii(this);if(this.boxWriter.writeBox(r),this.format._options.onMoov){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(i,s)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=t,this.boxWriter.writeBox(this.mdat);for(let i of this.finalizedChunks)for(let s of i.samples)h(s.data),this.writer.write(s.data),s.data=null;if(this.format._options.onMdat){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(i,s)}}else if(this.isFragmented){let t=this.writer.getPos(),r=id(this.trackDatas);this.boxWriter.writeBox(r);let i=this.writer.getPos()-t;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(i)}else{h(this.mdat);let t=this.boxWriter.offsets.get(this.mdat);h(t!==void 0);let r=this.writer.getPos()-t;if(this.mdat.size=r,this.mdat.largeSize=r>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:s,start:n}=this.writer.stopTrackingWrites();this.format._options.onMdat(s,n)}let i=ii(this);if(this.fastStart==="reserve"){h(this.ftypSize!==null),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(i);let s=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(fu(s))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(i);if(this.format._options.onMoov){let{data:s,start:n}=this.writer.stopTrackingWrites();this.format._options.onMoov(s,n)}}e()}},Id=-(2**15),Pd=2**15-1,To="Mediabunny",So=6,vo=5,Ed={video:1,audio:2,subtitle:17},Ad=class extends ar{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=Ie(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new Tl(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof Qs?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:t,start:r}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(t,r)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;let t=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),s=new Uint8Array([25,65,164,105]),n=new Uint8Array([18,84,195,103]),a={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:19899,data:[{id:21419,data:n},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=a}createSegmentInfo(){let e={id:17545,data:new fs(0)};this.segmentDuration=e;let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:To},{id:22337,data:To},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){let e={id:374648427,data:[]};this.tracksElement=e;for(let t of this.trackDatas){let r=ft[t.track.source._codec];h(r);let i=0;if(t.type==="audio"&&t.track.source._codec==="opus"){i=1e6*80;let s=t.info.decoderConfig.description;if(s){let n=ne(s),a=Ti(n);i=Math.round(1e9*(a.preSkip/Tr))}}e.data.push({id:174,data:[{id:215,data:t.track.id},{id:29637,data:t.track.id},{id:131,data:Ed[t.type]},{id:156,data:0},{id:2274716,data:t.track.metadata.languageCode??rt},{id:134,data:r},{id:22186,data:0},{id:22203,data:i},t.track.metadata.name!==void 0?{id:21358,data:new jt(t.track.metadata.name)}:null,t.type==="video"?this.videoSpecificTrackInfo(t):null,t.type==="audio"?this.audioSpecificTrackInfo(t):null,t.type==="subtitle"?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){let{frameRate:t,rotation:r}=e.track.metadata,i=[e.info.decoderConfig.description?{id:25506,data:ne(e.info.decoderConfig.description)}:null,t?{id:2352003,data:1e9/t}:null],s=r?ut(-r):0,n=e.info.decoderConfig.colorSpace,a={id:224,data:[{id:176,data:e.info.width},{id:186,data:e.info.height},e.info.alphaMode?{id:21440,data:1}:null,di(n)?{id:21936,data:[{id:21937,data:At[n.matrix]},{id:21946,data:Vt[n.transfer]},{id:21947,data:tt[n.primaries]},{id:21945,data:n.fullRange?2:1}]}:null,s?{id:30320,data:[{id:30321,data:0},{id:30325,data:new hs((s+180)%360-180)}]}:null]};return i.push(a),i}audioSpecificTrackInfo(e){let t=ze.includes(e.track.source._codec)?Tt(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:25506,data:ne(e.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new hs(e.info.sampleRate)},{id:159,data:e.info.numberOfChannels},t?{id:25188,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:25506,data:we.encode(e.info.config.description)}]}maybeCreateTags(){let e=[],t=(s,n)=>{e.push({id:26568,data:[{id:17827,data:new jt(s)},typeof n=="string"?{id:17543,data:new jt(n)}:{id:17541,data:n}]})},r=this.output._metadataTags,i=new Set;for(let{key:s,value:n}of yr(r))switch(s){case"title":t("TITLE",n),i.add("TITLE");break;case"description":t("DESCRIPTION",n),i.add("DESCRIPTION");break;case"artist":t("ARTIST",n),i.add("ARTIST");break;case"album":t("ALBUM",n),i.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",n),i.add("ALBUM_ARTIST");break;case"genre":t("GENRE",n),i.add("GENRE");break;case"comment":t("COMMENT",n),i.add("COMMENT");break;case"lyrics":t("LYRICS",n),i.add("LYRICS");break;case"date":t("DATE",n.toISOString().slice(0,10)),i.add("DATE");break;case"trackNumber":{let a=r.tracksTotal!==void 0?"".concat(n,"/").concat(r.tracksTotal):n.toString();t("PART_NUMBER",a),i.add("PART_NUMBER")}break;case"discNumber":{let a=r.discsTotal!==void 0?"".concat(n,"/").concat(r.discsTotal):n.toString();t("DISC",a),i.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:$e(s)}if(r.raw)for(let s in r.raw){let n=r.raw[s];n==null||i.has(s)||(typeof n=="string"||n instanceof Uint8Array)&&t(s,n)}e.length!==0&&(this.tagsElement={id:307544935,data:[{id:29555,data:[{id:25536,data:[{id:26826,data:50},{id:25546,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){let e=this.output._metadataTags,t=[],r=new Set,i=e.images??[];for(let s of i){let n=s.name;n===void 0&&(n=(s.kind==="coverFront"?"cover":s.kind==="coverBack"?"back":"image")+(Cc(s.mimeType)??""));let a;for(;;){a=0n;for(let o=0;o<8;o++)a<<=8n,a|=BigInt(Math.floor(Math.random()*256));if(a!==0n&&!r.has(a))break}r.add(a),t.push({id:24999,data:[s.description!==void 0?{id:18046,data:new jt(s.description)}:null,{id:18030,data:new jt(n)},{id:18016,data:s.mimeType},{id:18012,data:s.data},{id:18094,data:a}]})}for(let[s,n]of Object.entries(e.raw??{}))!(n instanceof wi)||!/^\d+$/.test(s)||i.find(o=>o.mimeType===n.mimeType&&Ic(o.data,n.data))||t.push({id:24999,data:[n.description!==void 0?{id:18046,data:new jt(n.description)}:null,{id:18030,data:new jt(n.name??"")},{id:18016,data:n.mimeType??""},{id:18012,data:n.data},{id:18094,data:BigInt(s)}]});t.length!==0&&(this.attachmentsElement={id:423732329,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);let e={id:408125543,size:this.format._options.appendOnly?-1:So,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:t,start:r}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(t,r)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return h(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return ha({isWebM:this.format instanceof Qs,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,r){let i=this.trackDatas.find(n=>n.track===e);if(i)return i;Nn(r),h(r),h(r.decoderConfig),h(r.decoderConfig.codedWidth!==void 0),h(r.decoderConfig.codedHeight!==void 0);let s={track:e,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(Ec(s.info.decoderConfig.codec))}:e.source._codec==="av1"&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(Bn(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((n,a)=>n.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;Sr(t),h(t),h(t.decoderConfig);let i={track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;On(t),h(t),h(t.config);let i={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((s,n)=>s.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,t,r),n=t.type==="key",a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,n),o=t.duration;e.metadata.frameRate!==void 0&&(a=Qi(a,1/e.metadata.frameRate),o=Qi(o,1/e.metadata.frameRate));let c=s.info.alphaMode?t.sideData.alpha??null:null,l=this.createInternalChunk(t.data,a,o,t.type,c);e.source._codec==="vp9"&&this.fixVP9ColorSpace(s,l),s.chunkQueue.push(l),await this.interleaveChunks()}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r),n=t.type==="key",a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,n),o=this.createInternalChunk(t.data,a,t.duration,t.type);s.chunkQueue.push(o),await this.interleaveChunks()}finally{i()}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,r),n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),a=t.text,o=Math.round(n*1e3);Ri.lastIndex=0,a=a.replace(Ri,f=>{let k=Fs(f.slice(1,-1))-o;return"<".concat(eo(k),">")});let c=we.encode(a),l="".concat(t.settings??"","\n").concat(t.identifier??"","\n").concat(t.notes??""),u=this.createInternalChunk(c,n,t.duration,"key",l.trim()?we.encode(l):null);s.chunkQueue.push(u),await this.interleaveChunks()}finally{i()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let t=null,r=1/0;for(let s of this.trackDatas){if(!e&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<r&&(t=s,r=s.chunkQueue[0].timestamp)}if(!t)break;let i=t.chunkQueue.shift();this.writeBlock(t,i)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if(t.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let r=new he(t.data);r.skipBits(2);let i=r.readBits(1),n=(r.readBits(1)<<1)+i;if(n===3&&r.skipBits(1),r.readBits(1)||r.readBits(1)!==0||(r.skipBits(2),r.readBits(24)!==4817730))return;n>=2&&r.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];tr(t.data,r.pos,r.pos+3,l)}createInternalChunk(e,t,r,i,s=null){return{data:e,type:i,timestamp:t,duration:r,additions:s}}writeBlock(e,t){this.segment||this.createSegment();let r=Math.round(1e3*t.timestamp),i=this.trackDatas.every(l=>{if(e===l)return t.type==="key";let u=l.chunkQueue[0];return u?u.type==="key":l.track.source._closed}),s=!1;if(!this.currentCluster)s=!0;else{h(this.currentClusterStartMsTimestamp!==null),h(this.currentClusterMaxMsTimestamp!==null);let l=r-this.currentClusterStartMsTimestamp;s=i&&r>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>Pd}s&&this.createNewCluster(r);let n=r-this.currentClusterStartMsTimestamp;if(n<Id)return;let a=new Uint8Array(4),o=new DataView(a.buffer);o.setUint8(0,128|e.track.id),o.setInt16(1,n,!1);let c=Math.round(1e3*t.duration);if(t.additions){let l={id:160,data:[{id:161,data:[a,t.data]},t.type==="delta"?{id:251,data:new na(e.lastWrittenMsTimestamp-r)}:null,t.additions?{id:30113,data:[{id:166,data:[{id:238,data:1},{id:165,data:t.additions}]}]}:null,c>0?{id:155,data:c}:null]};this.ebmlWriter.writeEBML(l)}else{o.setUint8(3,+(t.type==="key")<<7);let l={id:163,data:[a,t.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,r+c),e.lastWrittenMsTimestamp=r,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:r}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,r)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:vo,data:[{id:231,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(h(this.currentCluster),!this.format._options.appendOnly){let i=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),s=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(i,vo),this.writer.seek(s)}if(this.format._options.onCluster){h(this.currentClusterStartMsTimestamp!==null);let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onCluster(i,s,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(let[i,{firstMsTimestamp:s}]of this.trackDatasInCurrentCluster)t.has(s)||t.set(s,[]),t.get(s).push(i);let r=[...t.entries()].sort((i,s)=>i[0]-s[0]);for(let[i,s]of r)h(this.cues),this.cues.data.push({id:187,data:[{id:179,data:i},...s.map(n=>({id:183,data:[{id:247,data:n.track.id},{id:241,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),h(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let t=this.writer.getPos(),r=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(r,So),this.segmentDuration.data=new fs(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),h(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(t)}e()}},Bd=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer)}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(e){let t=this.writer.getPos(),r=255,i=224|e.mpegVersionId<<3|e.layer<<1,s;e.mpegVersionId&2?s=e.mpegVersionId&1?0:1:s=1;let n=0,a=155,o=-1,c=s*16*4+e.layer*16;for(let b=0;b<16;b++){let C=ys[c+b];if(Ts(s,e.layer,1e3*C,e.sampleRate,n)>=a){o=b;break}}if(o===-1)throw new Error("No suitable bitrate found.");let l=o<<4|e.frequencyIndex<<2|n<<1,u=e.channel<<6|e.modeExtension<<4|e.copyright<<3|e.original<<2|e.emphasis;this.helper[0]=r,this.helper[1]=i,this.helper[2]=l,this.helper[3]=u,this.writer.write(this.helper.subarray(0,4));let f=Ss(e.mpegVersionId,e.channel);this.writer.seek(t+f),this.writeU32(ks);let p=0;e.frameCount!==null&&(p|=1),e.fileSize!==null&&(p|=2),e.toc!==null&&(p|=4),this.writeU32(p),this.writeU32(e.frameCount??0),this.writeU32(e.fileSize??0),this.writer.write(e.toc??new Uint8Array(100));let k=ys[c+o],T=Ts(s,e.layer,1e3*k,e.sampleRate,n);this.writer.seek(t+T)}},Md=class extends ar{constructor(e,t){super(e),this.xingFrameData=null,this.frameCount=0,this.framePositions=[],this.xingFramePos=null,this.format=t,this.writer=e._writer,this.mp3Writer=new Bd(e._writer)}async start(){bi(this.output._metadataTags)||new ya(this.writer).writeId3V2Tag(this.output._metadataTags)}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(e,t){let r=await this.mutex.acquire();try{let i=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&i){let s=oe(t.data);if(s.byteLength<4)throw new Error("Invalid MP3 header in sample.");let n=s.getUint32(0,!1),a=wa(n,null).header;if(!a)throw new Error("Invalid MP3 header in sample.");let o=Ss(a.mpegVersionId,a.channel);if(s.byteLength>=o+4){let c=s.getUint32(o,!1);if(c===ks||c===ga)return}this.xingFrameData={mpegVersionId:a.mpegVersionId,layer:a.layer,frequencyIndex:a.frequencyIndex,sampleRate:a.sampleRate,channel:a.channel,modeExtension:a.modeExtension,copyright:a.copyright,original:a.original,emphasis:a.emphasis,frameCount:null,fileSize:null,toc:null},this.xingFramePos=this.writer.getPos(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),this.writer.write(t.data),this.frameCount++,await this.writer.flush(),i&&this.framePositions.push(this.writer.getPos())}finally{r()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData||this.xingFramePos===null)return;let e=await this.mutex.acquire(),t=this.writer.getPos();this.writer.seek(this.xingFramePos);let r=new Uint8Array(100);for(let i=0;i<100;i++){let s=Math.floor(this.framePositions.length*(i/100));h(s!==-1&&s<this.framePositions.length);let n=this.framePositions[s];r[i]=256*(n/t)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=t,this.xingFrameData.toc=r,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(i,s)}this.writer.seek(t),e()}},Fd=8192,zd=class extends ar{constructor(e,t){super(e),this.trackDatas=[],this.bosPagesWritten=!1,this.allTracksKnown=Ie(),this.pageBytes=new Uint8Array(Ca),this.pageView=new DataView(this.pageBytes.buffer),this.format=t,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,va({codecStrings:this.trackDatas.map(e=>e.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(e,t){let r=this.trackDatas.find(n=>n.track===e);if(r)return r;let i;do i=Math.floor(2**32*Math.random());while(this.trackDatas.some(n=>n.serialNumber===i));h(e.source._codec==="vorbis"||e.source._codec==="opus"),Sr(t),h(t),h(t.decoderConfig);let s={track:e,serialNumber:i,internalSampleRate:e.source._codec==="opus"?Tr:t.decoderConfig.sampleRate,codecInfo:{codec:e.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(s,t),this.trackDatas.push(s),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}queueHeaderPackets(e,t){if(h(t.decoderConfig),e.track.source._codec==="vorbis"){h(t.decoderConfig.description);let r=ne(t.decoderConfig.description);if(r[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let i=1,s=()=>{let T=0;for(;;){let b=r[i++];if(b===void 0)throw new TypeError("Vorbis decoder description is too short.");if(T+=b,b<255)return T}},n=s(),a=s();if(r.length-i<=0)throw new TypeError("Vorbis decoder description is too short.");let c=r.subarray(i,i+=n);i+=a;let l=r.subarray(i),u=new Uint8Array(7);u[0]=3,u[1]=118,u[2]=111,u[3]=114,u[4]=98,u[5]=105,u[6]=115;let f=rs(u,this.output._metadataTags,!0);e.packetQueue.push({data:c,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:f,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let k=oe(c).getUint8(28);e.codecInfo.vorbisInfo={blocksizes:[1<<(k&15),1<<(k>>4)],modeBlockflags:Qn(l).modeBlockflags}}else if(e.track.source._codec==="opus"){if(!t.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let r=ne(t.decoderConfig.description),i=new Uint8Array(8),s=oe(i);s.setUint32(0,1332770163,!1),s.setUint32(4,1415669619,!1);let n=rs(i,this.output._metadataTags,!0);e.packetQueue.push({data:r,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:n,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),e.codecInfo.opusInfo={preSkip:Ti(r).preSkip}}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getTrackData(e,r);this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key");let n=s.currentTimestampInSamples,{durationInSamples:a,vorbisBlockSize:o}=Sa(t.data,s.codecInfo,s.vorbisLastBlocksize);s.currentTimestampInSamples+=a,s.vorbisLastBlocksize=o,s.packetQueue.push({data:t.data,endGranulePosition:s.currentTimestampInSamples,timestamp:n/s.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{i()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async interleavePages(e=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown())return;for(let t of this.trackDatas)for(;t.packetQueue.length>0;){let r=t.packetQueue.shift();if(this.writePacket(t,r,!1),r.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let t=null,r=1/0;for(let n of this.trackDatas){if(!e&&n.packetQueue.length<=1&&!n.track.source._closed)break e;n.packetQueue.length>0&&n.packetQueue[0].timestamp<r&&(t=n,r=n.packetQueue[0].timestamp)}if(!t)break;let i=t.packetQueue.shift(),s=t.packetQueue.length===0;this.writePacket(t,i,s)}e||await this.writer.flush()}writePacket(e,t,r){let i=t.data.length,s=0,n=0;for(;;){e.currentLacingValues.length===0&&s>0&&(e.currentPageStartsWithFreshPacket=!1);let o=Math.min(255,i);e.currentLacingValues.push(o),e.currentPageSize++,n+=o;let c=i<255;if(e.currentLacingValues.length===255){let l=t.data.subarray(s,n);if(s=n,e.currentPageData.push(l),e.currentPageSize+=l.length,this.writePage(e,r&&c),c)return}if(c)break;i-=255}let a=t.data.subarray(s);e.currentPageData.push(a),e.currentPageSize+=a.length,e.currentGranulePosition=t.endGranulePosition,(e.currentPageSize>=Fd||t.forcePageFlush)&&this.writePage(e,r)}writePage(e,t){this.pageView.setUint32(0,_s,!0),this.pageView.setUint8(4,0);let r=0;e.currentPageStartsWithFreshPacket||(r|=1),e.pagesWritten===0&&(r|=2),t&&(r|=4),this.pageView.setUint8(5,r);let i=e.currentLacingValues.every(o=>o===255)?-1:e.currentGranulePosition;kc(this.pageView,6,i,!0),this.pageView.setUint32(14,e.serialNumber,!0),this.pageView.setUint32(18,e.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,e.currentLacingValues.length),this.pageBytes.set(e.currentLacingValues,27);let s=27+e.currentLacingValues.length;for(let o of e.currentPageData)this.pageBytes.set(o,s),s+=o.length;let n=this.pageBytes.subarray(0,s),a=Ta(n);if(this.pageView.setUint32(22,a,!0),e.pagesWritten++,e.currentLacingValues.length=0,e.currentPageData.length=0,e.currentPageSize=27,e.currentPageStartsWithFreshPacket=!0,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(n),this.format._options.onPage){let{data:o,start:c}=this.writer.stopTrackingWrites();this.format._options.onPage(o,c,e.track.source)}}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let t of this.trackDatas)t.currentLacingValues.length>0&&this.writePage(t,!0);e()}},Rd=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer)}writeU16(e){this.helperView.setUint16(0,e,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,e,!0),this.helperView.setUint32(4,Math.floor(e/2**32),!0),this.writer.write(this.helper)}writeAscii(e){this.writer.write(new TextEncoder().encode(e))}},Dd=class extends ar{constructor(e,t){super(e),this.headerWritten=!1,this.dataSize=0,this.sampleRate=null,this.sampleCount=0,this.riffSizePos=null,this.dataSizePos=null,this.ds64RiffSizePos=null,this.ds64DataSizePos=null,this.ds64SampleCountPos=null,this.format=t,this.writer=e._writer,this.riffWriter=new Rd(e._writer),this.isRf64=!!t._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{if(this.headerWritten||(Sr(r),h(r),h(r.decoderConfig),this.writeHeader(e,r.decoderConfig),this.sampleRate=r.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),!this.isRf64&&this.writer.getPos()+t.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(t.data),this.dataSize+=t.data.byteLength,this.sampleCount+=Math.round(t.duration*this.sampleRate),await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(e,t){this.format._options.onHeader&&this.writer.startTrackingWrites();let r,i=e.source._codec,s=Tt(i);s.dataType==="ulaw"?r=7:s.dataType==="alaw"?r=6:s.dataType==="float"?r=3:r=1;let n=t.numberOfChannels,a=t.sampleRate,o=s.sampleSize*n;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.riffSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.ds64RiffSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64DataSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64SampleCountPos=this.writer.getPos(),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(r),this.riffWriter.writeU16(n),this.riffWriter.writeU32(a),this.riffWriter.writeU32(a*o),this.riffWriter.writeU16(o),this.riffWriter.writeU16(8*s.sampleSize),!bi(this.output._metadataTags)){let c=this.format._options.metadataFormat??"info";c==="info"?this.writeInfoChunk(this.output._metadataTags):c==="id3"?this.writeId3Chunk(this.output._metadataTags):$e(c)}if(this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.dataSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.format._options.onHeader){let{data:c,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(c,l)}}writeInfoChunk(e){let t=this.writer.getPos();this.riffWriter.writeAscii("LIST"),this.riffWriter.writeU32(0),this.riffWriter.writeAscii("INFO");let r=new Set,i=(a,o)=>{if(!Fe(o)){console.warn("Didn't write tag '".concat(a,"' because '").concat(o,"' is not ISO 8859-1-compatible."));return}let c=o.length+1,l=new Uint8Array(c);for(let u=0;u<o.length;u++)l[u]=o.charCodeAt(u);this.riffWriter.writeAscii(a),this.riffWriter.writeU32(c),this.writer.write(l),c&1&&this.writer.write(new Uint8Array(1)),r.add(a)};for(let{key:a,value:o}of yr(e))switch(a){case"title":i("INAM",o),r.add("INAM");break;case"artist":i("IART",o),r.add("IART");break;case"album":i("IPRD",o),r.add("IPRD");break;case"trackNumber":{let c=e.tracksTotal!==void 0?"".concat(o,"/").concat(e.tracksTotal):o.toString();i("ITRK",c),r.add("ITRK")}break;case"genre":i("IGNR",o),r.add("IGNR");break;case"date":i("ICRD",o.toISOString().slice(0,10)),r.add("ICRD");break;case"comment":i("ICMT",o),r.add("ICMT");break;case"albumArtist":case"discNumber":case"tracksTotal":case"discsTotal":case"description":case"lyrics":case"images":break;case"raw":break;default:$e(a)}if(e.raw)for(let a in e.raw){let o=e.raw[a];o==null||a.length!==4||r.has(a)||typeof o=="string"&&i(a,o)}let s=this.writer.getPos(),n=s-t-8;this.writer.seek(t+4),this.riffWriter.writeU32(n),this.writer.seek(s),n&1&&this.writer.write(new Uint8Array(1))}writeId3Chunk(e){let t=this.writer.getPos();this.riffWriter.writeAscii("ID3 "),this.riffWriter.writeU32(0);let i=new ya(this.writer).writeId3V2Tag(e),s=this.writer.getPos();this.writer.seek(t+4),this.riffWriter.writeU32(i),this.writer.seek(s),i&1&&this.writer.write(new Uint8Array(1))}async finalize(){let e=await this.mutex.acquire(),t=this.writer.getPos();this.isRf64?(h(this.ds64RiffSizePos!==null),this.writer.seek(this.ds64RiffSizePos),this.riffWriter.writeU64(t-8),h(this.ds64DataSizePos!==null),this.writer.seek(this.ds64DataSizePos),this.riffWriter.writeU64(this.dataSize),h(this.ds64SampleCountPos!==null),this.writer.seek(this.ds64SampleCountPos),this.riffWriter.writeU64(this.sampleCount)):(h(this.riffSizePos!==null),this.writer.seek(this.riffSizePos),this.riffWriter.writeU32(t-8),h(this.dataSizePos!==null),this.writer.seek(this.dataSizePos),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(t),e()}},Nt=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>qe.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>Qe.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>kt.includes(e))}_codecUnsupportedHint(e){return""}},Hs=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","reserve","fragmented"].includes(e.fastStart))throw new TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(e.minimumFragmentDuration!==void 0&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(e.onFtyp!==void 0&&typeof e.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(e.onMoov!==void 0&&typeof e.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(e.onMdat!==void 0&&typeof e.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(e.onMoof!==void 0&&typeof e.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");if(e.metadataFormat!==void 0&&!["mdir","mdta","udta","auto"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new xd(e,this)}},$s=class extends Hs{constructor(e){super(e)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...qe,...nr,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...kt]}_codecUnsupportedHint(e){return new qs().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}},qs=class extends Hs{constructor(e){super(e)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...qe,...Qe]}_codecUnsupportedHint(e){return new $s().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}},js=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.appendOnly!==void 0&&typeof e.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(e.minimumClusterDuration!==void 0&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(e.onEbmlHeader!==void 0&&typeof e.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(e.onSegmentHeader!==void 0&&typeof e.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(e.onCluster!==void 0&&typeof e.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Ad(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...qe,...nr,...ze.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...kt]}get supportsVideoRotationMetadata(){return!1}},Qs=class extends js{constructor(e){super(e)}getSupportedCodecs(){return[...qe.filter(e=>["vp8","vp9","av1"].includes(e)),...Qe.filter(e=>["opus","vorbis"].includes(e)),...kt]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new js().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}},Nd=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.xingHeader!==void 0&&typeof e.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(e.onXingFrame!==void 0&&typeof e.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Md(e,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},Od=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.large!==void 0&&typeof e.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(e.metadataFormat!==void 0&&!["info","id3"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'info' or 'id3'.");if(e.onHeader!==void 0&&typeof e.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Dd(e,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...ze.filter(e=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},Ud=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onPage!==void 0&&typeof e.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new zd(e,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...Qe.filter(e=>["vorbis","opus"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},Ld=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onFrame!==void 0&&typeof e.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Uc(e,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}},Vd=class extends Nt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");super(),this._options=e}_createMuxer(e){return new cu(e,this)}get _name(){return"FLAC"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".flac"}get mimeType(){return"audio/flac"}getSupportedCodecs(){return["flac"]}get supportsVideoRotationMetadata(){return!1}},Ks=e=>{if(!e||typeof e!="object")throw new TypeError("Encoding config must be an object.");if(!qe.includes(e.codec))throw new TypeError("Invalid video codec '".concat(e.codec,"'. Must be one of: ").concat(qe.join(", "),"."));if(!(e.bitrate instanceof Xe)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(e.keyFrameInterval!==void 0&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(e.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(e.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(e.onEncodedPacket!==void 0&&typeof e.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(e.onEncoderConfig!==void 0&&typeof e.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");Co(e.codec,e)},Co=(e,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.alpha!==void 0&&!["discard","keep"].includes(t.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.latencyMode!==void 0&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&Dn(t.fullCodecString)!==e)throw new TypeError("fullCodecString, when provided, must be a string that matches the specified codec (".concat(e,")."));if(t.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(t.scalabilityMode!==void 0&&typeof t.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(t.contentHint!==void 0&&typeof t.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},Gs=e=>{let t=e.bitrate instanceof Xe?e.bitrate._toVideoBitrate(e.codec,e.width,e.height):e.bitrate;return{codec:e.fullCodecString??Pc(e.codec,e.width,e.height,t),width:e.width,height:e.height,bitrate:t,bitrateMode:e.bitrateMode,alpha:e.alpha??"discard",framerate:e.framerate,latencyMode:e.latencyMode,hardwareAcceleration:e.hardwareAcceleration,scalabilityMode:e.scalabilityMode,contentHint:e.contentHint,...Bc(e.codec)}},Xs=e=>{if(!e||typeof e!="object")throw new TypeError("Encoding config must be an object.");if(!Qe.includes(e.codec))throw new TypeError("Invalid audio codec '".concat(e.codec,"'. Must be one of: ").concat(Qe.join(", "),"."));if(e.bitrate===void 0&&(!ze.includes(e.codec)||e.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(e.bitrate!==void 0&&!(e.bitrate instanceof Xe)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(e.onEncodedPacket!==void 0&&typeof e.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(e.onEncoderConfig!==void 0&&typeof e.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");_o(e.codec,e)},_o=(e,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&Dn(t.fullCodecString)!==e)throw new TypeError("fullCodecString, when provided, must be a string that matches the specified codec (".concat(e,")."))},Ys=e=>{let t=e.bitrate instanceof Xe?e.bitrate._toAudioBitrate(e.codec):e.bitrate;return{codec:e.fullCodecString??Ac(e.codec,e.numberOfChannels,e.sampleRate),numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,bitrate:t,bitrateMode:e.bitrateMode,...Mc(e.codec)}},Xe=class{constructor(e){this._factor=e}_toVideoBitrate(e,t,r){let i=t*r,s={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},n=1920*1080,a=3e6,o=Math.pow(i/n,.95),u=a*o*s[e]*this._factor;return Math.ceil(u/1e3)*1e3}_toAudioBitrate(e){if(ze.includes(e)||e==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!r)throw new Error("Unhandled codec: ".concat(e));let i=r*this._factor;return e==="aac"?i=[96e3,128e3,16e4,192e3].reduce((n,a)=>Math.abs(a-i)<Math.abs(n-i)?a:n):e==="opus"||e==="vorbis"?i=Math.max(6e3,i):e==="mp3"&&(i=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((n,a)=>Math.abs(a-i)<Math.abs(n-i)?a:n)),Math.round(i/1e3)*1e3}},Wd=new Xe(.3),Hd=new Xe(.6),$d=new Xe(1),Zs=new Xe(2),qd=new Xe(4),jd=e=>{if(qe.includes(e))return Ni(e);if(Qe.includes(e))return Oi(e);if(kt.includes(e))return Ui(e);throw new TypeError("Unknown codec '".concat(e,"'."))},Ni=async(e,t={})=>{let{width:r=1280,height:i=720,bitrate:s=1e6,...n}=t;if(!qe.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("height must be a positive integer.");if(!(s instanceof Xe)&&(!Number.isInteger(s)||s<=0))throw new TypeError("bitrate must be a positive integer or a quality.");Co(e,n);let a=null;return jr.length>0&&(a??(a=Gs({codec:e,width:r,height:i,bitrate:s,framerate:void 0,...n})),jr.some(l=>l.supports(e,a)))?!0:typeof VideoEncoder>"u"||(r%2===1||i%2===1)&&(e==="avc"||e==="hevc")?!1:(a??(a=Gs({codec:e,width:r,height:i,bitrate:s,framerate:void 0,...n,alpha:"discard"})),(await VideoEncoder.isConfigSupported(a)).supported===!0)},Oi=async(e,t={})=>{let{numberOfChannels:r=2,sampleRate:i=48e3,bitrate:s=128e3,...n}=t;if(!Qe.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(s instanceof Xe)&&(!Number.isInteger(s)||s<=0))throw new TypeError("bitrate must be a positive integer.");_o(e,n);let a=null;return Qr.length>0&&(a??(a=Ys({codec:e,numberOfChannels:r,sampleRate:i,bitrate:s,...n})),Qr.some(c=>c.supports(e,a)))||ze.includes(e)?!0:typeof AudioEncoder>"u"?!1:(a??(a=Ys({codec:e,numberOfChannels:r,sampleRate:i,bitrate:s,...n})),(await AudioEncoder.isConfigSupported(a)).supported===!0)},Ui=async e=>!!kt.includes(e),Qd=async()=>{let[e,t,r]=await Promise.all([xo(),Li(),Io()]);return[...e,...t,...r]},xo=async(e=qe,t)=>{let r=await Promise.all(e.map(i=>Ni(i,t)));return e.filter((i,s)=>r[s])},Li=async(e=Qe,t)=>{let r=await Promise.all(e.map(i=>Oi(i,t)));return e.filter((i,s)=>r[s])},Io=async(e=kt)=>{let t=await Promise.all(e.map(Ui));return e.filter((r,i)=>t[i])},Po=async(e,t)=>{for(let r of e)if(await Ni(r,t))return r;return null},Kd=async(e,t)=>{for(let r of e)if(await Oi(r,t))return r;return null},Gd=async e=>{for(let t of e)if(await Ui(t))return t;return null},Vi=class{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;let e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise?this._closingPromise:this._flushAndClose(e)}},zr=class extends Vi{constructor(e){if(super(),this._connectedTrack=null,!qe.includes(e))throw new TypeError("Invalid video codec '".concat(e,"'. Must be one of: ").concat(qe.join(", "),"."));this._codec=e}},Eo=class extends zr{constructor(e){super(e)}add(e,t){if(!(e instanceof Ce))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}},Js=class{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new gi,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){let a=this.encodingConfig.sizeChangeBehavior??"deny";if(a!=="passThrough"){if(a==="deny")throw new Error("Video sample size must remain constant. Expected ".concat(this.codedWidth,"x").concat(this.codedHeight,", got ").concat(e.codedWidth,"x").concat(e.codedHeight,". To allow the sample size to change over time, set `sizeChangeBehavior` to a value other than 'strict' in the encoding options."));{let o=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),o=!0);let c=this.resizeCanvas.getContext("2d",{alpha:$r()});h(c),o||($r()?(c.fillStyle="black",c.fillRect(0,0,this.codedWidth,this.codedHeight)):c.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(c,{fit:a}),t&&e.close(),e=new it(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),h(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,s=Math.floor(e.timestamp/i),n={...r,keyFrame:r?.keyFrame||i===0||s!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=s,this.customEncoder){this.customEncoderQueueSize++;let a=e.clone(),o=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(a,n)).then(()=>this.customEncoderQueueSize--).catch(c=>this.error??(this.error=c)).finally(()=>{a.close()});this.customEncoderQueueSize>=4&&await o}else{h(this.encoder);let a=e.toVideoFrame();if(!this.alphaEncoder)this.encoder.encode(a,n),a.close();else if(!!a.format&&!a.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(a,n),a.close();else{let c=a.displayWidth,l=a.displayHeight;if(!this.splitter)try{this.splitter=new Xd(c,l)}catch(u){console.error("Due to an error, only color data will be encoded.",u),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(a,n),a.close()}if(this.splitter){let u=this.splitter.extractColor(a),f=this.splitter.extractAlpha(a);this.alphaFrameQueue.push(f),this.encoder.encode(u,n),u.close(),a.close()}}t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(o=>this.encoder.addEventListener("dequeue",o,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){let t=new Error;this.ensureEncoderPromise=(async()=>{let r=Gs({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let i=jr.find(s=>s.supports(this.encodingConfig.codec,r));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(s,n)=>{if(!(s instanceof Ce))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(n!==void 0&&(!n||typeof n!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,n),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,s,n).catch(a=>{this.error??(this.error=a),this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(r.alpha="discard",this.encodingConfig.alpha==="keep"&&(r.latencyMode="quality"),(r.width%2===1||r.height%2===1)&&(this.encodingConfig.codec==="avc"||this.encodingConfig.codec==="hevc"))throw new Error("The dimensions ".concat(r.width,"x").concat(r.height," are not supported for codec '").concat(this.encodingConfig.codec,"'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number."));if(!(await VideoEncoder.isConfigSupported(r)).supported)throw new Error("This specific encoder configuration (".concat(r.codec,", ").concat(r.bitrate," bps, ").concat(r.width,"x").concat(r.height,", hardware acceleration: ").concat(r.hardwareAcceleration??"no-preference",") is not supported by this browser. Consider using another codec or changing your video parameters."));let a=[],o=[],c=0,l=0,u=(f,p,k)=>{let T={};if(p){let C=new Uint8Array(p.byteLength);p.copyTo(C),T.alpha=C}let b=Ce.fromEncodedChunk(f,T);this.encodingConfig.onEncodedPacket?.(b,k),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,b,k).catch(C=>{this.error??(this.error=C),this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(f,p)=>{if(!this.alphaEncoder){u(f,null,p);return}let k=this.alphaFrameQueue.shift();h(k!==void 0),k?(this.alphaEncoder.encode(k,{keyFrame:f.type==="key"}),l++,k.close(),a.push({chunk:f,meta:p})):l===0?u(f,null,p):(o.push(c+l),a.push({chunk:f,meta:p}))},error:f=>{f.stack=t.stack,this.error??(this.error=f)}}),this.encoder.configure(r),this.encodingConfig.alpha==="keep"&&(this.alphaEncoder=new VideoEncoder({output:(f,p)=>{l--;let k=a.shift();for(h(k!==void 0),u(k.chunk,f,k.meta),c++;o.length>0&&o[0]===c;){o.shift();let T=a.shift();h(T!==void 0),u(T.chunk,null,T.meta)}},error:f=>{f.stack=t.stack,this.error??(this.error=f)}}),this.alphaEncoder.configure(r))}h(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await this.alphaEncoder?.flush()),this.encoder.state!=="closed"&&this.encoder.close(),this.alphaEncoder&&this.alphaEncoder.state!=="closed"&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(t=>t?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},Xd=class{constructor(e,t){this.lastFrame=null,typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);let r=this.canvas.getContext("webgl2",{alpha:!0});if(!r)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=r,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n			in vec2 a_position;\n			in vec2 a_texCoord;\n			out vec2 v_texCoord;\n			\n			void main() {\n				gl_Position = vec4(a_position, 0.0, 1.0);\n				v_texCoord = a_texCoord;\n			}\n		")}createColorProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_sourceTexture;\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n			\n			void main() {\n				vec4 source = texture(u_sourceTexture, v_texCoord);\n				fragColor = vec4(source.rgb, 1.0);\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createAlphaProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_sourceTexture;\n			uniform vec2 u_resolution; // The width and height of the canvas\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n\n			// This function determines the value for a single byte in the YUV stream\n			float getByteValue(float byteOffset) {\n				float width = u_resolution.x;\n				float height = u_resolution.y;\n\n				float yPlaneSize = width * height;\n\n				if (byteOffset < yPlaneSize) {\n					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from\n					float y = floor(byteOffset / width);\n					float x = mod(byteOffset, width);\n					\n					// Add 0.5 to sample the center of the texel\n					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;\n					\n					// The luma value is the alpha from the source texture\n					return texture(u_sourceTexture, sampleCoord).a;\n				} else {\n					// Write a fixed value for chroma and beyond\n					return 128.0 / 255.0;\n				}\n			}\n			\n			void main() {\n				// Each fragment writes 4 bytes (R, G, B, A)\n				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);\n				float baseByteOffset = pixelIndex * 4.0;\n\n				vec4 result;\n				for (int i = 0; i < 4; i++) {\n					float currentByteOffset = baseByteOffset + float(i);\n					result[i] = getByteValue(currentByteOffset);\n				}\n				\n				fragColor = result;\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(r)),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.colorProgram,"a_position"),s=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&((e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);let{width:t,height:r}=this.canvas,i=Math.ceil(t/2)*Math.ceil(r/2),s=t*r+i*2,n=Math.ceil(s/(t*4)),a=new Uint8Array(4*t*n);this.gl.readPixels(0,0,t,n,this.gl.RGBA,this.gl.UNSIGNED_BYTE,a),a=a.subarray(0,s),h(a[t*r]===128),h(a[a.length-1]===128);let o={format:"I420",codedWidth:t,codedHeight:r,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[a.buffer]};return new VideoFrame(a,o)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},en=class extends zr{constructor(e){Ks(e),super(e.codec),this._encoder=new Js(this,e)}add(e,t){if(!(e instanceof it))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Yd=class extends zr{constructor(e,t){if(!(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");Ks(t),super(t.codec),this._encoder=new Js(this,t),this._canvas=e}add(e,t=0,r){if(!Number.isFinite(e)||e<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(t)||t<0)throw new TypeError("duration must be a non-negative number.");let i=new it(this._canvas,{timestamp:e,duration:t});return this._encoder.add(i,!0,r)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Zd=class extends zr{constructor(e,t){if(!(e instanceof MediaStreamTrack)||e.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");Ks(t),t={...t,latencyMode:"realtime"},super(t.codec),this._abortController=null,this._workerTrackId=null,this._workerListener=null,this._promiseWithResolvers=Ie(),this._errorPromiseAccessed=!1,this._encoder=new Js(this,t),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,t=!1,r=i=>{if(t){i.close();return}if(e===null){e=i.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new it(i),!0).catch(s=>{t=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(s),this._workerTrackId!==null&&nn({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let i=new MediaStreamTrackProcessor({track:this._track}),s=new WritableStream({write:r});i.readable.pipeTo(s,{signal:this._abortController.signal}).catch(n=>{n instanceof DOMException&&n.name==="AbortError"||this._promiseWithResolvers.reject(n)})}else if(await sh())this._workerTrackId=rh++,nn({type:"videoTrack",trackId:this._workerTrackId,track:this._track},[this._track]),this._workerListener=s=>{let n=s.data;n.type==="videoFrame"&&n.trackId===this._workerTrackId?r(n.videoFrame):n.type==="error"&&n.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(n.error)},at.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(h(this._workerListener),nn({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(t=>{let r=i=>{let s=i.data;s.type==="trackStopped"&&s.trackId===this._workerTrackId&&(h(this._workerListener),at.removeEventListener("message",this._workerListener),at.removeEventListener("message",r),t())};at.addEventListener("message",r)})),await this._encoder.flushAndClose(e)}},Rr=class extends Vi{constructor(e){if(super(),this._connectedTrack=null,!Qe.includes(e))throw new TypeError("Invalid audio codec '".concat(e,"'. Must be one of: ").concat(Qe.join(", "),"."));this._codec=e}},Ao=class extends Rr{constructor(e){super(e)}add(e,t){if(!(e instanceof Ce))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}},tn=class{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new gi,this.customEncoderQueueSize=0,this.error=null,this.errorNeedsNewStack=!0}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error("Audio parameters must remain constant. Expected ".concat(this.lastNumberOfChannels," channels at ").concat(this.lastSampleRate," Hz, got ").concat(e.numberOfChannels," channels at ").concat(e.sampleRate," Hz."))}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),h(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let r=e.clone(),i=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(s=>this.error??(this.error=s)).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await i,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{h(this.encoder);let r=e.toAudioData();this.encoder.encode(r),r.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(i=>this.encoder.addEventListener("dequeue",i,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){h(this.outputSampleSize),h(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:s,timestamp:n}=e,a=2048,o=[];for(let f=0;f<i;f+=a){let p=Math.min(a,e.numberOfFrames-f),k=p*r*this.outputSampleSize,T=new ArrayBuffer(k),b=new DataView(T);o.push({frameCount:p,view:b})}let c=e.allocationSize({planeIndex:0,format:"f32-planar"}),l=new Float32Array(c/Float32Array.BYTES_PER_ELEMENT);for(let f=0;f<r;f++){e.copyTo(l,{planeIndex:f,format:"f32-planar"});for(let p=0;p<o.length;p++){let{frameCount:k,view:T}=o[p];for(let b=0;b<k;b++)this.writeOutputValue(T,(b*r+f)*this.outputSampleSize,l[p*a+b])}}t&&e.close();let u={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:s}};for(let f=0;f<o.length;f++){let{frameCount:p,view:k}=o[f],T=k.buffer,b=f*a,C=new Ce(new Uint8Array(T),"key",n+b/s,p/s);this.encodingConfig.onEncodedPacket?.(C,u),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,C,u)}}ensureEncoder(e){let t=new Error;this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:i}=e,s=Ys({numberOfChannels:r,sampleRate:i,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(s);let n=Qr.find(a=>a.supports(this.encodingConfig.codec,s));if(n)this.customEncoder=new n,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=s,this.customEncoder.onPacket=(a,o)=>{if(!(a instanceof Ce))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(o!==void 0&&(!o||typeof o!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(a,o),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,a,o).catch(c=>{this.error??(this.error=c),this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(ze.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(s)).supported)throw new Error("This specific encoder configuration (".concat(s.codec,", ").concat(s.bitrate," bps, ").concat(s.numberOfChannels," channels, ").concat(s.sampleRate," Hz) is not supported by this browser. Consider using another codec or changing your audio parameters."));this.encoder=new AudioEncoder({output:(o,c)=>{let l=Ce.fromEncodedChunk(o);this.encodingConfig.onEncodedPacket?.(l,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,l,c).catch(u=>{this.error??(this.error=u),this.errorNeedsNewStack=!1})},error:o=>{o.stack=t.stack,this.error??(this.error=o)}}),this.encoder.configure(s)}h(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:r,littleEndian:i}=Tt(e);switch(this.outputSampleSize=r,r){case 1:t==="unsigned"?this.writeOutputValue=(s,n,a)=>s.setUint8(n,Ne((a+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(s,n,a)=>{s.setInt8(n,Ne(Math.round(a*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(s,n,a)=>{let o=Ne(Math.floor(a*32767),-32768,32767);s.setUint8(n,el(o))}:t==="alaw"?this.writeOutputValue=(s,n,a)=>{let o=Ne(Math.floor(a*32767),-32768,32767);s.setUint8(n,rl(o))}:h(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(s,n,a)=>s.setUint16(n,Ne((a+1)*32767.5,0,65535),i):t==="signed"?this.writeOutputValue=(s,n,a)=>s.setInt16(n,Ne(Math.round(a*32767),-32768,32767),i):h(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(s,n,a)=>Tn(s,n,Ne((a+1)*83886075e-1,0,16777215),i):t==="signed"?this.writeOutputValue=(s,n,a)=>yc(s,n,Ne(Math.round(a*8388607),-8388608,8388607),i):h(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(s,n,a)=>s.setUint32(n,Ne((a+1)*21474836475e-1,0,4294967295),i):t==="signed"?this.writeOutputValue=(s,n,a)=>s.setInt32(n,Ne(Math.round(a*2147483647),-2147483648,2147483647),i):t==="float"?this.writeOutputValue=(s,n,a)=>s.setFloat32(n,a,i):h(!1);break;case 8:t==="float"?this.writeOutputValue=(s,n,a)=>s.setFloat64(n,a,i):h(!1);break;default:$e(r),h(!1)}}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},rn=class extends Rr{constructor(e){Xs(e),super(e.codec),this._encoder=new tn(this,e)}add(e){if(!(e instanceof St))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Jd=class extends Rr{constructor(e){Xs(e),super(e.codec),this._accumulatedTime=0,this._encoder=new tn(this,e)}async add(e){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let t=St._fromAudioBuffer(e,this._accumulatedTime);this._accumulatedTime+=e.duration;for(let r of t)await this._encoder.add(r,!0)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},eh=class extends Rr{constructor(e,t){if(!(e instanceof MediaStreamTrack)||e.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");Xs(t),super(t.codec),this._abortController=null,this._audioContext=null,this._scriptProcessorNode=null,this._promiseWithResolvers=Ie(),this._errorPromiseAccessed=!1,this._encoder=new tn(this,t),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){if(this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController,typeof MediaStreamTrackProcessor<"u"){let e=null,t=new MediaStreamTrackProcessor({track:this._track}),r=new WritableStream({write:i=>{if(e===null){e=i.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new St(i),!0).catch(s=>{this._abortController?.abort(),this._promiseWithResolvers.reject(s)})}});t.readable.pipeTo(r,{signal:this._abortController.signal}).catch(i=>{i instanceof DOMException&&i.name==="AbortError"||this._promiseWithResolvers.reject(i)})}else{let e=window.AudioContext||window.webkitAudioContext;this._audioContext=new e({sampleRate:this._track.getSettings().sampleRate});let t=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),t.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let r=!1,i=0;this._scriptProcessorNode.onaudioprocess=s=>{let n=St._fromAudioBuffer(s.inputBuffer,i);i+=s.inputBuffer.duration;for(let a of n){if(!r){r=!0;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?o.firstMediaStreamTimestamp=performance.now()/1e3:this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp}if(this._encoder.getQueueSize()>=4){a.close();continue}this._encoder.add(a,!0).catch(o=>{this._audioContext.suspend(),this._promiseWithResolvers.reject(o)})}}}}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(h(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(e)}},th=()=>{let e=(i,s)=>{s?self.postMessage(i,{transfer:s}):self.postMessage(i)};e({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let t=new Map,r=new Set;self.addEventListener("message",i=>{let s=i.data;switch(s.type){case"videoTrack":{let n=new MediaStreamTrackProcessor({track:s.track}),a=new WritableStream({write:c=>{if(r.has(s.trackId)){c.close();return}e({type:"videoFrame",trackId:s.trackId,videoFrame:c},[c])}}),o=new AbortController;t.set(s.trackId,o),n.readable.pipeTo(a,{signal:o.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||e({type:"error",trackId:s.trackId,error:c})})}break;case"stopTrack":{let n=t.get(s.trackId);n&&(n.abort(),t.delete(s.trackId)),r.add(s.trackId),e({type:"trackStopped",trackId:s.trackId})}break;default:$e(s)}})},rh=0,at=null,ih=()=>{let e=new Blob(["(".concat(th.toString(),")()")],{type:"application/javascript"}),t=URL.createObjectURL(e);at=new Worker(t)},sn=null,sh=async()=>sn!==null?sn:(at||ih(),new Promise(e=>{h(at);let t=r=>{let i=r.data;i.type==="support"&&(sn=i.supported,at.removeEventListener("message",t),e(i.supported))};at.addEventListener("message",t)})),nn=(e,t)=>{h(at),t?at.postMessage(e,t):at.postMessage(e)},an=class extends Vi{constructor(e){if(super(),this._connectedTrack=null,!kt.includes(e))throw new TypeError("Invalid subtitle codec '".concat(e,"'. Must be one of: ").concat(kt.join(", "),"."));this._codec=e}},nh=class extends an{constructor(e){super(e),this._error=null,this._parser=new uu({codec:e,output:(t,r)=>{this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,t,r).catch(i=>{this._error??(this._error=i)})}})}add(e){if(typeof e!="string")throw new TypeError("text must be a string.");return this._checkForError(),this._ensureValidAdd(),this._parser.parse(e),this._connectedTrack.output._muxer.mutex.currentPromise}_checkForError(){if(this._error)throw this._error}async _flushAndClose(e){e||this._checkForError()}},Bo=["video","audio","subtitle"],on=e=>{if(!e||typeof e!="object")throw new TypeError("metadata must be an object.");if(e.languageCode!==void 0&&!Hr(e.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(e.name!==void 0&&typeof e.name!="string")throw new TypeError("metadata.name, when provided, must be a string.");if(e.maximumPacketCount!==void 0&&(!Number.isInteger(e.maximumPacketCount)||e.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")},cn=class{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new wr,this._metadataTags={},!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof Nt))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof Fr))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof zr))throw new TypeError("source must be a VideoSource.");if(on(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("Invalid video rotation: ".concat(t.rotation,". Has to be 0, 90, 180 or 270."));if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error("".concat(this.format._name," does not support video rotation metadata."));if(t.frameRate!==void 0&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError("Invalid video frame rate: ".concat(t.frameRate,". Must be a positive number."));this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof Rr))throw new TypeError("source must be an AudioSource.");on(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof an))throw new TypeError("source must be a SubtitleSource.");on(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if(Zi(e),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),s=this._tracks.reduce((c,l)=>c+(l.type===e?1:0),0),n=i[e].max;if(s===n)throw new Error(n===0?"".concat(this.format._name," does not support ").concat(e," tracks."):"".concat(this.format._name," does not support more than ").concat(n," ").concat(e," track").concat(n===1?"":"s","."));let a=i.total.max;if(this._tracks.length===a)throw new Error("".concat(this.format._name," does not support more than ").concat(a," tracks").concat(a===1?"":"s"," in total."));let o={id:this._tracks.length+1,output:this,type:e,source:t,metadata:r};if(o.type==="video"){let c=this.format.getSupportedVideoCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support video tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported video codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}else if(o.type==="audio"){let c=this.format.getSupportedAudioCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support audio tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported audio codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}else if(o.type==="subtitle"){let c=this.format.getSupportedSubtitleCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support subtitle tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported subtitle codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}this._tracks.push(o),t._connectedTrack=o}async start(){let e=this.format.getSupportedTrackCounts();for(let r of Bo){let i=this._tracks.reduce((n,a)=>n+(a.type===r?1:0),0),s=e[r].min;if(i<s)throw new Error(s===e[r].max?"".concat(this.format._name," requires exactly ").concat(s," ").concat(r," track").concat(s===1?"":"s","."):"".concat(this.format._name," requires at least ").concat(s," ").concat(r," track").concat(s===1?"":"s","."))}let t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?"".concat(this.format._name," requires exactly ").concat(t," track").concat(t===1?"":"s","."):"".concat(this.format._name," requires at least ").concat(t," track").concat(t===1?"":"s","."));if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let i=this._tracks.map(s=>s.source._start());await Promise.all(i),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}},Mo=e=>{if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("options.video, when provided, must be an object.");if(e?.discard!==void 0&&typeof e.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(e?.forceTranscode!==void 0&&typeof e.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(e?.codec!==void 0&&!qe.includes(e.codec))throw new TypeError("options.video.codec, when provided, must be one of: ".concat(qe.join(", "),"."));if(e?.bitrate!==void 0&&!(e.bitrate instanceof Xe)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(e?.width!==void 0&&(!Number.isInteger(e.width)||e.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(e?.height!==void 0&&(!Number.isInteger(e.height)||e.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(e?.fit!==void 0&&!["fill","contain","cover"].includes(e.fit))throw new TypeError("options.video.fit, when provided, must be one of 'fill', 'contain', or 'cover'.");if(e?.width!==void 0&&e.height!==void 0&&e.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(e?.rotate!==void 0&&![0,90,180,270].includes(e.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(e?.crop!==void 0&&ss(e.crop,"options.video."),e?.frameRate!==void 0&&(!Number.isFinite(e.frameRate)||e.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.");if(e?.alpha!==void 0&&!["discard","keep"].includes(e.alpha))throw new TypeError("options.video.alpha, when provided, must be either 'discard' or 'keep'.");if(e?.keyFrameInterval!==void 0&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("options.video.keyFrameInterval, when provided, must be a non-negative number.");if(e?.process!==void 0&&typeof e.process!="function")throw new TypeError("options.video.process, when provided, must be a function.");if(e?.processedWidth!==void 0&&(!Number.isInteger(e.processedWidth)||e.processedWidth<=0))throw new TypeError("options.video.processedWidth, when provided, must be a positive integer.");if(e?.processedHeight!==void 0&&(!Number.isInteger(e.processedHeight)||e.processedHeight<=0))throw new TypeError("options.video.processedHeight, when provided, must be a positive integer.")},Fo=e=>{if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(e?.discard!==void 0&&typeof e.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(e?.forceTranscode!==void 0&&typeof e.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(e?.codec!==void 0&&!Qe.includes(e.codec))throw new TypeError("options.audio.codec, when provided, must be one of: ".concat(Qe.join(", "),"."));if(e?.bitrate!==void 0&&!(e.bitrate instanceof Xe)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(e?.numberOfChannels!==void 0&&(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(e?.sampleRate!==void 0&&(!Number.isInteger(e.sampleRate)||e.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(e?.process!==void 0&&typeof e.process!="function")throw new TypeError("options.audio.process, when provided, must be a function.");if(e?.processedNumberOfChannels!==void 0&&(!Number.isInteger(e.processedNumberOfChannels)||e.processedNumberOfChannels<=0))throw new TypeError("options.audio.processedNumberOfChannels, when provided, must be a positive integer.");if(e?.processedSampleRate!==void 0&&(!Number.isInteger(e.processedSampleRate)||e.processedSampleRate<=0))throw new TypeError("options.audio.processedSampleRate, when provided, must be a positive integer.")},ln=2,un=48e3,ah=class lc{constructor(t){if(this._addedCounts={video:0,audio:0,subtitle:0},this._totalTrackCount=0,this._trackPromises=[],this._executed=!1,this._synchronizer=new oh,this._totalDuration=null,this._maxTimestamps=new Map,this._canceled=!1,this.onProgress=void 0,this._computeProgress=!1,this._lastProgress=0,this.isValid=!1,this.utilizedTracks=[],this.discardedTracks=[],!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.input instanceof Xa))throw new TypeError("options.input must be an Input.");if(!(t.output instanceof cn))throw new TypeError("options.output must be an Output.");if(t.output._tracks.length>0||Object.keys(t.output._metadataTags).length>0||t.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks or metadata tags added and not started.");if(typeof t.video!="function"&&Mo(t.video),typeof t.audio!="function"&&Fo(t.audio),t.trim!==void 0&&(!t.trim||typeof t.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(t.trim?.start!==void 0&&(!Number.isFinite(t.trim.start)||t.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(t.trim?.end!==void 0&&(!Number.isFinite(t.trim.end)||t.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(t.trim?.start!==void 0&&t.trim.end!==void 0&&t.trim.start>=t.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(t.tags!==void 0&&(typeof t.tags!="object"||!t.tags)&&typeof t.tags!="function")throw new TypeError("options.tags, when provided, must be an object or a function.");if(typeof t.tags=="object"&&Zi(t.tags),t.showWarnings!==void 0&&typeof t.showWarnings!="boolean")throw new TypeError("options.showWarnings, when provided, must be a boolean.");this._options=t,this.input=t.input,this.output=t.output,this._startTimestamp=t.trim?.start??0,this._endTimestamp=t.trim?.end??1/0;let{promise:r,resolve:i}=Ie();this._started=r,this._start=i}static async init(t){let r=new lc(t);return await r._init(),r}async _init(){let t=await this.input.getTracks(),r=this.output.format.getSupportedTrackCounts(),i=1,s=1;for(let l of t){let u;if(l.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(u=await this._options.video(l,i),Mo(u),i++):u=this._options.video):l.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(u=await this._options.audio(l,s),Fo(u),s++):u=this._options.audio):h(!1),u?.discard){this.discardedTracks.push({track:l,reason:"discarded_by_user"});continue}if(this._totalTrackCount===r.total.max){this.discardedTracks.push({track:l,reason:"max_track_count_reached"});continue}if(this._addedCounts[l.type]===r[l.type].max){this.discardedTracks.push({track:l,reason:"max_track_count_of_type_reached"});continue}l.isVideoTrack()?await this._processVideoTrack(l,u??{}):l.isAudioTrack()&&await this._processAudioTrack(l,u??{})}let n=await this.input.getMetadataTags(),a;if(this._options.tags){let l=typeof this._options.tags=="function"?await this._options.tags(n):this._options.tags;Zi(l),a=l}else a=n;let o=(await this.input.getFormat()).mimeType===this.output.format.mimeType,c=n.raw===a.raw;if(n.raw&&c&&!o&&delete a.raw,this.output.setMetadataTags(a),this.isValid=this._totalTrackCount>=r.total.min&&this._addedCounts.video>=r.video.min&&this._addedCounts.audio>=r.audio.min&&this._addedCounts.subtitle>=r.subtitle.min,this._options.showWarnings??!0){let l=[],u=this.discardedTracks.filter(f=>f.reason!=="discarded_by_user");u.length>0&&l.push("Some tracks had to be discarded from the conversion:",u),this.isValid||l.push("\n\n"+this._getInvalidityExplanation().join("")),l.length>0&&console.warn(...l)}}_getInvalidityExplanation(){let t=[];if(this.discardedTracks.length===0)t.push("Due to missing tracks, this conversion cannot be executed.");else{let r=this.discardedTracks.every(i=>i.reason==="discarded_by_user"||i.reason==="no_encodable_target_codec");if(t.push("Due to discarded tracks, this conversion cannot be executed."),r){let i=this.discardedTracks.flatMap(s=>s.reason==="discarded_by_user"?[]:s.track.type==="video"?this.output.format.getSupportedVideoCodecs():s.track.type==="audio"?this.output.format.getSupportedAudioCodecs():this.output.format.getSupportedSubtitleCodecs());i.length===1?t.push("\nTracks were discarded because your environment is not able to encode '".concat(i[0],"'.")):t.push("\nTracks were discarded because your environment is not able to encode any of the following codecs: ".concat(i.map(s=>"'".concat(s,"'")).join(", "),".")),i.includes("mp3")&&t.push("\nThe @mediabunny/mp3-encoder extension package provides support for encoding MP3.")}else t.push("\nCheck the discardedTracks field for more info.")}return t}async execute(){if(!this.isValid)throw new Error("Cannot execute this conversion because its output configuration is invalid. Make sure to always check the isValid field before executing a conversion.\n"+this._getInvalidityExplanation().join(""));if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(let t of this.utilizedTracks)this._maxTimestamps.set(t.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(t){throw this._canceled||this.cancel(),t}this._canceled&&await new Promise(()=>{}),await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(t,r){let i=t.codec;if(!i){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let s,n=ut(t.rotation+(r.rotate??0)),a=this.output.format.supportsVideoRotationMetadata,[o,c]=n%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],l=r.crop;l&&is(l,o,c);let[u,f]=l?[l.width,l.height]:[o,c],p=u,k=f,T=p/k,b=F=>Math.ceil(F/2)*2;r.width!==void 0&&r.height===void 0?(p=b(r.width),k=b(Math.round(p/T))):r.width===void 0&&r.height!==void 0?(k=b(r.height),p=b(Math.round(k*T))):r.width!==void 0&&r.height!==void 0&&(p=b(r.width),k=b(r.height));let C=await t.getFirstTimestamp(),S=!!r.forceTranscode||this._startTimestamp>0||C<0||!!r.frameRate||r.keyFrameInterval!==void 0||r.process!==void 0,_=p!==u||k!==f||n!==0&&!a||!!l,E=r.alpha??"discard",A=this.output.format.getSupportedVideoCodecs();if(!S&&!r.bitrate&&!_&&A.includes(i)&&(!r.codec||r.codec===i)){let F=new Eo(i);s=F,this._trackPromises.push((async()=>{await this._started;let B=new Cr(t),$={decoderConfig:await t.getDecoderConfig()??void 0},ye=Number.isFinite(this._endTimestamp)?await B.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let ee of B.packets(void 0,ye,{verifyKeyPackets:!0})){if(this._canceled)return;E==="discard"&&(delete ee.sideData.alpha,delete ee.sideData.alphaByteLength),this._reportProgress(t.id,ee.timestamp),await F.add(ee,$),this._synchronizer.shouldWait(t.id,ee.timestamp)&&await this._synchronizer.wait(ee.timestamp)}F.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}r.codec&&(A=A.filter(ee=>ee===r.codec));let B=r.bitrate??Zs,D=await Po(A,{width:r.process&&r.processedWidth?r.processedWidth:p,height:r.process&&r.processedHeight?r.processedHeight:k,bitrate:B});if(!D){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}let $={codec:D,bitrate:B,keyFrameInterval:r.keyFrameInterval,sizeChangeBehavior:r.fit??"passThrough",alpha:E},ye=new en($);if(s=ye,!_){let ee=new cn({format:new $s,target:new ko}),q=new en($);ee.addVideoTrack(q),await ee.start();let ke=await new _i(t).getSample(C);if(ke)try{await q.add(ke),ke.close(),await ee.finalize()}catch(Ye){console.info("Error when probing encoder support. Falling back to rerender path.",Ye),_=!0,ee.cancel()}else await ee.cancel()}_?this._trackPromises.push((async()=>{await this._started;let q=new ea(t,{width:p,height:k,fit:r.fit??"fill",rotation:n,crop:r.crop,poolSize:1,alpha:E==="keep"}).canvases(this._startTimestamp,this._endTimestamp),ie=r.frameRate,ke=null,Ye=null,Ot=null,We=async He=>{h(ke),h(ie!==void 0);let je=Math.round((He-Ye)*ie);for(let Ut=1;Ut<je;Ut++){let It=new it(ke,{timestamp:Ye+Ut/ie,duration:1/ie});await this._registerVideoSample(t,r,ye,It)}};for await(let{canvas:He,timestamp:je,duration:Ut}of q){if(this._canceled)return;let It=Math.max(je-this._startTimestamp,0);if(Ot=It+Ut,ie!==void 0){let g=Math.floor(It*ie)/ie;if(ke!==null)if(g<=Ye){ke=He,Ye=g;continue}else await We(g);It=g}let si=new it(He,{timestamp:It,duration:ie!==void 0?1/ie:Ut});await this._registerVideoSample(t,r,ye,si),ie!==void 0?(ke=He,Ye=It):si.close()}ke&&(h(Ot!==null),h(ie!==void 0),await We(Math.floor(Ot*ie)/ie)),ye.close(),this._synchronizer.closeTrack(t.id)})()):this._trackPromises.push((async()=>{await this._started;let ee=new _i(t),q=r.frameRate,ie=null,ke=null,Ye=null,Ot=async We=>{h(ie),h(q!==void 0);let He=Math.round((We-ke)*q);for(let je=1;je<He;je++)ie.setTimestamp(ke+je/q),ie.setDuration(1/q),await this._registerVideoSample(t,r,ye,ie);ie.close()};for await(let We of ee.samples(this._startTimestamp,this._endTimestamp)){if(this._canceled){ie?.close();return}let He=Math.max(We.timestamp-this._startTimestamp,0);if(Ye=He+We.duration,q!==void 0){let je=Math.floor(He*q)/q;if(ie!==null)if(je<=ke){ie.close(),ie=We,ke=je;continue}else await Ot(je);He=je,We.setDuration(1/q)}We.setTimestamp(He),await this._registerVideoSample(t,r,ye,We),q!==void 0?(ie=We,ke=He):We.close()}ie&&(h(Ye!==null),h(q!==void 0),await Ot(Math.floor(Ye*q)/q)),ye.close(),this._synchronizer.closeTrack(t.id)})())}this.output.addVideoTrack(s,{frameRate:r.frameRate,languageCode:Hr(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,rotation:_?0:n}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerVideoSample(t,r,i,s){if(this._canceled)return;this._reportProgress(t.id,s.timestamp);let n;if(!r.process)n=[s];else{let a=r.process(s);a instanceof Promise&&(a=await a),Array.isArray(a)||(a=a===null?[]:[a]),n=a.map(o=>o instanceof it?o:typeof VideoFrame<"u"&&o instanceof VideoFrame?new it(o):new it(o,{timestamp:s.timestamp,duration:s.duration}))}for(let a of n){if(this._canceled)break;await i.add(a),this._synchronizer.shouldWait(t.id,a.timestamp)&&await this._synchronizer.wait(a.timestamp)}for(let a of n)a!==s&&a.close()}async _processAudioTrack(t,r){let i=t.codec;if(!i){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let s,n=t.numberOfChannels,a=t.sampleRate,o=await t.getFirstTimestamp(),c=r.numberOfChannels??n,l=r.sampleRate??a,u=c!==n||l!==a||this._startTimestamp>0||o<0,f=this.output.format.getSupportedAudioCodecs();if(!r.forceTranscode&&!r.bitrate&&!u&&f.includes(i)&&(!r.codec||r.codec===i)&&!r.process){let p=new Ao(i);s=p,this._trackPromises.push((async()=>{await this._started;let k=new Cr(t),b={decoderConfig:await t.getDecoderConfig()??void 0},C=Number.isFinite(this._endTimestamp)?await k.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let S of k.packets(void 0,C)){if(this._canceled)return;this._reportProgress(t.id,S.timestamp),await p.add(S,b),this._synchronizer.shouldWait(t.id,S.timestamp)&&await this._synchronizer.wait(S.timestamp)}p.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}let k=null;r.codec&&(f=f.filter(C=>C===r.codec));let T=r.bitrate??Zs,b=await Li(f,{numberOfChannels:r.process&&r.processedNumberOfChannels?r.processedNumberOfChannels:c,sampleRate:r.process&&r.processedSampleRate?r.processedSampleRate:l,bitrate:T});if(!b.some(C=>nr.includes(C))&&f.some(C=>nr.includes(C))&&(c!==ln||l!==un)){let S=(await Li(f,{numberOfChannels:ln,sampleRate:un,bitrate:T})).find(_=>nr.includes(_));S&&(u=!0,k=S,c=ln,l=un)}else k=b[0]??null;if(k===null){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}if(u)s=this._resampleAudio(t,r,k,c,l,T);else{let C=new rn({codec:k,bitrate:T});s=C,this._trackPromises.push((async()=>{await this._started;let S=new xi(t);for await(let _ of S.samples(void 0,this._endTimestamp)){if(this._canceled)return;await this._registerAudioSample(t,r,C,_),_.close()}C.close(),this._synchronizer.closeTrack(t.id)})())}}this.output.addAudioTrack(s,{languageCode:Hr(t.languageCode)?t.languageCode:void 0,name:t.name??void 0}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerAudioSample(t,r,i,s){if(this._canceled)return;this._reportProgress(t.id,s.timestamp);let n;if(!r.process)n=[s];else{let a=r.process(s);if(a instanceof Promise&&(a=await a),Array.isArray(a)||(a=a===null?[]:[a]),!a.every(o=>o instanceof St))throw new TypeError("The audio process function must return an AudioSample, null, or an array of AudioSamples.");n=a}for(let a of n){if(this._canceled)break;await i.add(a),this._synchronizer.shouldWait(t.id,a.timestamp)&&await this._synchronizer.wait(a.timestamp)}for(let a of n)a!==s&&a.close()}_resampleAudio(t,r,i,s,n,a){let o=new rn({codec:i,bitrate:a});return this._trackPromises.push((async()=>{await this._started;let c=new ch({targetNumberOfChannels:s,targetSampleRate:n,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:f=>this._registerAudioSample(t,r,o,f)}),u=new xi(t).samples(this._startTimestamp,this._endTimestamp);for await(let f of u){if(this._canceled)return;await c.add(f)}await c.finalize(),o.close(),this._synchronizer.closeTrack(t.id)})()),o}_reportProgress(t,r){if(!this._computeProgress)return;h(this._totalDuration!==null),this._maxTimestamps.set(t,Math.max(r,this._maxTimestamps.get(t)));let i=Math.min(...this._maxTimestamps.values()),s=Ne(i/this._totalDuration,0,1);s!==this._lastProgress&&(this._lastProgress=s,this.onProgress?.(s))}},zo=5,oh=class{constructor(){this.maxTimestamps=new Map,this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(let[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){let r=this.resolvers[t];r.timestamp-e<zo&&(r.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));let r=this.computeMinAndMaybeResolve();return t-r>=zo}wait(e){let{promise:t,resolve:r}=Ie();return this.resolvers.push({timestamp:e,resolve:r}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}},ch=class{constructor(e){this.sourceSampleRate=null,this.sourceNumberOfChannels=null,this.targetSampleRate=e.targetSampleRate,this.targetNumberOfChannels=e.targetNumberOfChannels,this.startTime=e.startTime,this.endTime=e.endTime,this.onSample=e.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){h(this.sourceNumberOfChannels!==null);let e=this.sourceNumberOfChannels,t=this.targetNumberOfChannels;e===1&&t===2?this.channelMixer=(r,i)=>r[i*e]:e===1&&t===4?this.channelMixer=(r,i,s)=>r[i*e]*+(s<2):e===1&&t===6?this.channelMixer=(r,i,s)=>r[i*e]*+(s===2):e===2&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return .5*(r[s]+r[s+1])}:e===2&&t===4?this.channelMixer=(r,i,s)=>r[i*e+s]*+(s<2):e===2&&t===6?this.channelMixer=(r,i,s)=>r[i*e+s]*+(s<2):e===4&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return .25*(r[s]+r[s+1]+r[s+2]+r[s+3])}:e===4&&t===2?this.channelMixer=(r,i,s)=>{let n=i*e;return .5*(r[n+s]+r[n+s+2])}:e===4&&t===6?this.channelMixer=(r,i,s)=>{let n=i*e;return s<2?r[n+s]:s===2||s===3?0:r[n+s-2]}:e===6&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return Math.SQRT1_2*(r[s]+r[s+1])+r[s+2]+.5*(r[s+4]+r[s+5])}:e===6&&t===2?this.channelMixer=(r,i,s)=>{let n=i*e;return r[n+s]+Math.SQRT1_2*(r[n+2]+r[n+s+4])}:e===6&&t===4?this.channelMixer=(r,i,s)=>{let n=i*e;return s<2?r[n+s]+Math.SQRT1_2*r[n+2]:r[n+s+2]}:this.channelMixer=(r,i,s)=>s<e?r[i*e+s]:0}ensureTempBufferSize(e){let t=this.tempSourceBuffer.length;for(;t<e;)t*=2;if(t!==this.tempSourceBuffer.length){let r=new Float32Array(t);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(e){this.sourceSampleRate===null&&(this.sourceSampleRate=e.sampleRate,this.sourceNumberOfChannels=e.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());let t=e.numberOfFrames*e.numberOfChannels;this.ensureTempBufferSize(t);let r=e.allocationSize({planeIndex:0,format:"f32"}),i=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);e.copyTo(i,{planeIndex:0,format:"f32"});let s=e.timestamp-this.startTime,n=e.numberOfFrames/this.sourceSampleRate,a=Math.min(s+n,this.endTime-this.startTime),o=Math.floor(s*this.targetSampleRate),c=Math.ceil(a*this.targetSampleRate);for(let l=o;l<c;l++){if(l<this.bufferStartFrame)continue;for(;l>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let u=l-this.bufferStartFrame;h(u<this.bufferSizeInFrames);let k=(l/this.targetSampleRate-s)*this.sourceSampleRate,T=Math.floor(k),b=Math.ceil(k),C=k-T;for(let S=0;S<this.targetNumberOfChannels;S++){let _=0,E=0;T>=0&&T<e.numberOfFrames&&(_=this.channelMixer(i,T,S)),b>=0&&b<e.numberOfFrames&&(E=this.channelMixer(i,b,S));let A=_+C*(E-_),F=u*this.targetNumberOfChannels+S;this.outputBuffer[F]+=A}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,u)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let e=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,t=new Float32Array(e);t.set(this.outputBuffer.subarray(0,e));let r=this.bufferStartFrame/this.targetSampleRate,i=new St({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:t});await this.onSample(i),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};return Pe(pe)})();typeof Hi=="object"&&typeof Hi.exports=="object"&&Object.assign(Hi.exports,Mh)});var mc=Ze((Lp,fc)=>{var Jt=fn(),Fh=oc(),{Output:zh,Mp4OutputFormat:Rh,StreamTarget:Dh,VideoSampleSource:Nh,VideoSample:dc,QUALITY_HIGH:Oh}=uc(),Uh=require("fs/promises"),er=150,me,de,mr,Ur,Be,bt,Ue,K,pr,Se,$i,oi,lt,Lr,Et,qi,ci,li,yt,gr,ui,hc;fc.exports=(hc=class{constructor(y){ge(this,me);ge(this,de);ge(this,mr,new WeakMap);ge(this,Ur,new Map);ge(this,Be,{x:0,y:0,name:null});ge(this,bt,!1);ge(this,Ue,new AbortController);ge(this,K,async y=>{if(w(this,Ue).signal.aborted)throw Je(this,Ue,new AbortController),new Error("action aborted");await new Promise(d=>setTimeout(d,y))});ge(this,pr,y=>{if(!(y instanceof Element)||!y.isConnected)return null;let d=w(this,mr).get(y);return typeof d!="string"&&(d=Jt.generateKey(),w(this,mr).set(y,d),w(this,Ur).set(d,y)),d});ge(this,Se,y=>{if(typeof y!="string")return null;let d=w(this,Ur).get(y);return typeof d!="object"?null:!(d instanceof Element)||!d.isConnected||y!==w(this,mr).get(d)?(w(this,mr).delete(d),w(this,Ur).delete(y),null):d});ge(this,$i,y=>{let d=w(this,Se).call(this,y),m=null,v=(x,R)=>typeof R=="string"&&x===document.querySelector(R),I=x=>{let R=x.tagName.toLowerCase();if(v(x,R))return R;for(let X of x.attributes)if((["type","name","role","aria-label","aria-labelledby","for"].includes(X.name.toLowerCase())||X.name.toLowerCase().indexOf("data-")===0)&&(R+="[".concat(X.name,'="').concat(CSS.escape(X.value),'"]'),v(x,R)))return R;let W=R;for(let X of x.classList)if(R+=".".concat(CSS.escape(X)),v(x,R))return R;return W};do{if(!(d instanceof Element))break;let x=d.id?"#".concat(CSS.escape(d.id)):null;if(v(d,x)){m=x;break}let R=I(d);if(v(d,R)){m=R;break}let W=d,X=R;for(;W.parentElement;){W=W.parentElement;let Pe=I(W),ve=Array.from(W.parentElement?.children??[]);if(ve.length&&(Pe+=":nth-child(".concat(ve.indexOf(W)+1,")")),X="".concat(Pe," > ").concat(X),v(d,X)){m=X;break}}}while(!1);return m});ge(this,oi,()=>{let y=[];for(let d of[...document.querySelectorAll("select[multiple]")])if(w(this,li).call(this,d,0)){let{left:m,top:v,width:I,height:x}=d.getBoundingClientRect();y.push({x:parseInt(m,10),y:parseInt(v,10),w:parseInt(I,10),h:parseInt(x,10)})}return y});ge(this,lt,async(y,d,m=null,v=!1)=>{if(await w(this,K).call(this,10),y=parseInt(y,10),d=parseInt(d,10),!Number.isInteger(y)||!Number.isInteger(d))return!1;y<0&&(y=0),d<0&&(d=0),["click","double-click"].includes(m)||(m=null);let I=await w(this,de).ipc.target.mouse(w(this,me),y,d,m,v,w(this,oi).call(this));return Je(this,Be,{x:y,y:d,name:m}),I});ge(this,Lr,async(y,d)=>{let m=window.innerWidth||document.documentElement.clientWidth,v=window.innerHeight||document.documentElement.clientHeight,I=y<100?1:y>m-100?0:Math.floor(Math.random()*2),x=d<100?1:d>v-100?0:Math.floor(Math.random()*2),R=Math.abs(y+(I?1:-1)*(10+Math.floor(Math.random()*41))),W=Math.abs(d+(x?1:-1)*(10+Math.floor(Math.random()*41))),X=await w(this,lt).call(this,R,W);return await w(this,K).call(this,150),X});ge(this,Et,y=>{if(!(y instanceof Element))return null;let{left:d,top:m,width:v,height:I}=y.getBoundingClientRect(),x=Math.floor(d+v/2+(v>4?-1+Math.floor(Math.random()*3):0)),R=Math.floor(m+I/2+(I>4?-1+Math.floor(Math.random()*3):0));return{x,y:R,left:d,top:m}});ge(this,qi,y=>{let d=!1;do{if(!(y instanceof Element))break;let m=y.tagName.toLowerCase();if(y.isContentEditable||m==="textarea"){d=!0;break}if(m==="input"&&["text","search","email","url","tel","password","number"].includes(y.type.toLowerCase())){d=!0;break}}while(!1);return d});ge(this,ci,y=>{let d=!1;do{if(!(y instanceof Element))break;let m=getComputedStyle(y);d=y.offsetParent!==null&&m.display!=="none"&&m.visibility!=="hidden"&&m.opacity!=="0"}while(!1);return d});ge(this,li,(y,d=1)=>{let m=!1;do{if(!(y instanceof Element))break;let v=y.getBoundingClientRect();m=v.top+v.height-d>0&&v.top+d<(window.innerHeight||document.documentElement.clientHeight)}while(!1);return m});ge(this,yt,async y=>{if(await w(this,K).call(this,50),!(y instanceof Element))return!1;await w(this,de).ipc.target.webContents(w(this,me),"sendInputEvent",[{type:"mouseWheel",x:w(this,Be).x,y:w(this,Be).y,deltaX:0,deltaY:(Math.floor(Math.random()*2)?1:-1)*(Math.floor(Math.random()*3)+1)}]),await w(this,K).call(this,50+Math.floor(Math.random()*51)),y.scrollIntoView({behavior:"instant",block:"center",inline:"center"}),await w(this,K).call(this,350+Math.floor(Math.random()*51));let d=w(this,Et).call(this,y);return d!==null&&await w(this,lt).call(this,d.x,d.y),!0});ge(this,gr,async(y,d=60)=>{let m=new Date().getTime(),v=!1;do{if(new Date().getTime()-m>=d*1e3){v=!1;break}if(v=await y(),v!==!1)break;await w(this,K).call(this,1e3)}while(!0);return v});ge(this,ui,(y="GET",d={},m={},v=!0)=>{let I=typeof y=="string"?y.trim().toUpperCase():"GET";I.length||(I="GET");let x;if(!["GET","HEAD"].includes(I)){if(v)x=JSON.stringify(d);else if(x=new FormData,typeof d=="object"&&d!==null)for(let W of Object.keys(d))FormData.append(W,d[W])}let R={};if(typeof m=="object"&&m!==null)for(let W of Object.keys(m)){let X=W.toLowerCase().trim();X.length&&(R[X]=m[W])}return v&&(R["content-type"]="application/json"),{method:I,body:x,headers:R}});P(this,"controlled",async(y=!0)=>{y?w(this,Ue).signal.aborted&&Je(this,Ue,new AbortController):w(this,Ue).signal.aborted||w(this,Ue).abort("Action cancelled"),await w(this,de).ipc.target.setControlled(w(this,me),!!y)});P(this,"query",async(y,d=null,m=null,v=!1)=>{await w(this,K).call(this,10);let I=[],x=[];if(y=typeof y=="string"?y.trim():"",d=typeof d=="string"&&d.length?d.trim().toLowerCase():null,y.length){let R=typeof m=="string"?w(this,Se).call(this,m):document;x=typeof R?.querySelectorAll=="function"?[...R.querySelectorAll(y)].filter(W=>W instanceof Element&&W.isConnected):[],x.length&&v&&(x=x.filter(W=>{let{top:X,height:Pe}=W.getBoundingClientRect();return X+Pe>0})),x.length&&typeof d=="string"&&(x=x.filter(W=>W.innerText.toLowerCase().indexOf(d)!==-1)),I=x.map(W=>w(this,pr).call(this,W))}return I});P(this,"queryParent",async(y,d=null,m=null)=>{await w(this,K).call(this,10);let v=null,I=null;d=typeof d=="string"?d.trim():"",m=typeof m=="string"&&m.length?m.trim().toLowerCase():null;let x=w(this,Se).call(this,y);if(x instanceof Element){for(;I===null&&x&&x!==document;)x=x.parentElement,x&&(!d.length||x.matches(d))&&(typeof m!="string"||x.innerText.toLowerCase().indexOf(m)!==-1)&&(I=x);v=w(this,pr).call(this,I)}return v});P(this,"querySiblings",async(y,d,m=null)=>{await w(this,K).call(this,10);let v=[],I=[];d=typeof d=="string"?d.trim():"",m=typeof m=="string"&&m.length?m.trim().toLowerCase():null;let x=w(this,Se).call(this,y);if(x instanceof Element){let R=x.parentElement;if(document!==R)for(let W of Array.from(R.children))W&&W!==x&&(!d.length||W.matches(d))&&(typeof m!="string"||W.innerText.toLowerCase().indexOf(m)!==-1)&&(I.push(W),v.push(w(this,pr).call(this,W)))}return v});P(this,"queryAt",async(y,d,m=null,v=null)=>{await w(this,K).call(this,10);let I=null,x=null;m=typeof m=="string"?m.trim():"",v=typeof v=="string"&&v.length?v.trim().toLowerCase():null;let R=[],W=[],X=null;for(;(X=document.elementFromPoint(y,d))&&!W.includes(X);){if((!m.length||X.matches(m))&&(typeof v!="string"||X.innerText.toLowerCase().indexOf(v)!==-1)){x=X,I=w(this,pr).call(this,X);break}W.push(X),R.push({element:X,display:X.style.display}),X.style.display="none"}return R.forEach(({element:Pe,display:ve})=>{Pe.style.display=ve}),I});P(this,"awaitPresent",async(y,d=null,m=null,v=60)=>(await w(this,K).call(this,10),await w(this,gr).call(this,async()=>{let I=await this.query(y,d,m);return Array.isArray(I)&&I.length?I:!1},v)));P(this,"awaitNotPresent",async(y,d=60)=>(await w(this,K).call(this,10),await w(this,gr).call(this,async()=>!(w(this,Se).call(this,y)instanceof Element),d)));P(this,"awaitVisible",async(y,d=60)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y);return m instanceof Element?await w(this,gr).call(this,async()=>w(this,ci).call(this,m),d):!1});P(this,"awaitNotVisible",async(y,d=60)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y);return m instanceof Element?await w(this,gr).call(this,async()=>{let v=getComputedStyle(m);return!(m.offsetParent!==null&&v.display!=="none"&&v.visibility!=="hidden"&&v.opacity!=="0")},d):!0});P(this,"scrollIntoView",async y=>await w(this,yt).call(this,w(this,Se).call(this,y)));P(this,"getBox",async y=>{await w(this,K).call(this,10);let d=w(this,Se).call(this,y);if(!(d instanceof Element))return null;let{top:m,left:v,width:I,height:x}=d.getBoundingClientRect();return{left:parseInt(v,10),top:parseInt(m,10),width:parseInt(I,10),height:parseInt(x,10)}});P(this,"getValue",async y=>{await w(this,K).call(this,10);let d=w(this,Se).call(this,y),m=null;if(d instanceof Element){let v=d.closest("form")||document;switch(d.tagName.toLowerCase()){case"input":switch(d.type.toLowerCase()){case"checkbox":if(v){let I=v.querySelectorAll('input[type="checkbox"][name="'.concat(CSS.escape(d.name),'"]'));m=I.length>1?[...I].filter(x=>x.checked).map(x=>x.value):d.checked}break;case"radio":v&&(m=[...v.querySelectorAll('input[type="radio"][name="'.concat(CSS.escape(d.name),'"]'))].reduce((x,R)=>R.checked?R.value:x,null));break;case"file":m=[...d.files].map(I=>({name:I.name,size:I.size,type:I.type,lastModified:I.lastModified}));break;default:m=d.value;break}break;case"textarea":m=d.value;break;case"select":m=d.multiple?Array.from(d.selectedOptions).map(I=>I.value):d.value;break}}return m});P(this,"getAttributes",async(y,d=[])=>{await w(this,K).call(this,10);let m={},v=w(this,Se).call(this,y);if(v instanceof Element)for(let I of v.attributes){let x=I.name.toLowerCase();(!d.length||d.includes(x))&&(m[x]="".concat(I.value))}return m});P(this,"getTagName",async y=>{await w(this,K).call(this,10);let d=w(this,Se).call(this,y),m=null;return d instanceof Element&&(m=d.tagName.toLowerCase()),m});P(this,"getContent",async(y,d=!1)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y),v=null;return m instanceof Element&&(v=d?m.innerHTML:m.innerText),v});P(this,"getVisible",async y=>(await w(this,K).call(this,10),w(this,ci).call(this,w(this,Se).call(this,y))));P(this,"getInViewport",async y=>(await w(this,K).call(this,10),w(this,li).call(this,w(this,Se).call(this,y))));P(this,"getViewportSize",async()=>(await w(this,K).call(this,10),{width:window.innerWidth||document.documentElement.clientWidth,height:window.innerHeight||document.documentElement.clientHeight}));P(this,"scroll",async(y,d=!0)=>(await w(this,K).call(this,10),y=parseInt(y,10),Number.isInteger(y)?(await w(this,de).ipc.target.webContents(w(this,me),"sendInputEvent",[{type:"mouseWheel",x:w(this,Be).x,y:w(this,Be).y,...d?{deltaX:0,deltaY:-y}:{deltaX:-y,deltaY:0}}]),await w(this,K).call(this,er),!0):!1));P(this,"scrollTo",async(y,d=0)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y);if(!(m instanceof Element))return!1;await w(this,yt).call(this,m),d=parseInt(d,10),Number.isInteger(d)||(d=0);let v=w(this,Et).call(this,m);await w(this,lt).call(this,v.x,w(this,Be).y);let I=Math.round(d-m.getBoundingClientRect().top);return await w(this,de).ipc.target.webContents(w(this,me),"sendInputEvent",[{type:"mouseWheel",x:w(this,Be).x,y:w(this,Be).y,deltaX:0,deltaY:I}]),v=w(this,Et).call(this,m),await w(this,lt).call(this,v.x,v.top+10+Math.floor(Math.random()*11)),await w(this,K).call(this,er),!0});P(this,"chooseFiles",async(y,d)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y);if(!(m instanceof Element)||m.tagName.toLowerCase()!=="input"||m.type.toLowerCase()!=="file"||(d=(Array.isArray(d)?d:[]).map(x=>"".concat(x).trim()).filter(x=>x.length),!d.length))return!1;let v=w(this,$i).call(this,y);if(typeof v!="string")return!1;await w(this,yt).call(this,m);let I=await w(this,de).ipc.target.setFileInput(w(this,me),v,d);return await w(this,K).call(this,er),I});P(this,"saveRequest",async(y,d,m,v="GET",I={},x={},R=!0,W=600,X=null)=>{await w(this,K).call(this,10);let Pe="".concat(y,"-").concat(d),ve=new Date().getTime();if(typeof X!="string"||!X.length){X=null;try{let ne=new URL(m).pathname.match(/\.([\w]+)$/i);ne&&(X=ne[1])}catch{}}let{body:pe,method:h,headers:ut}=w(this,ui).call(this,v,I,x,R),{fileName:se,filePath:Re,minSize:he,maxSize:H}=await w(this,de).ipc.diskStorage.outputFilesInit(w(this,me),y,d,X),xe=0,tr=(ne=null)=>{w(this,de).ibc.send(Jt.WINDOW_MAIN,"ibc-target:download:info",[w(this,me),Pe,{fileName:se,totalBytes:xe,progress:"100",done:!0,error:ne}])};try{if(w(this,Ue).signal.aborted)throw new Error('Download cancelled for "'.concat(se,'"'));w(this,de).ibc.send(Jt.WINDOW_MAIN,"ibc-target:download:info",[w(this,me),Pe,{fileName:se,totalBytes:xe,progress:"0",done:!1,error:null}]);let ne=await fetch(m,{signal:w(this,Ue).signal,body:pe,method:h,headers:ut,priority:"high",redirect:"follow"});if(!ne.ok)throw new Error('HTTP status for "'.concat(se,'": ').concat(ne.status));let oe=ne.headers.get("Content-Length");if(oe!==null&&(xe=oe),xe>0){if(Number.isInteger(he)&&xe<he*1048576)throw new Error('Minimum file size not met for "'.concat(se,'" (').concat((xe/1048576).toFixed(3),"MB)"));if(Number.isInteger(H)&&xe>H*1048576)throw new Error('Maximum file size exceeded for "'.concat(se,'" (').concat((xe/1048576).toFixed(3),"MB)"))}let Me=ne.body.getReader(),we=!1,Fe=0;for(;;){let{done:rr,value:tt}=await Me.read();if(typeof tt<"u"){if(!await w(this,de).ipc.diskStorage.outputFilesAppend(w(this,me),y,se,Buffer.from(tt),H))throw new Error('Could not save "'.concat(se,'"'));if(new Date().getTime()-ve>=W*1e3)throw new Error('Download timed out for "'.concat(se,'" after ').concat(W,"s"));Fe+=tt.length}if(!we||xe>0){we=!0;let ir=xe>0?(Fe/xe*100).toFixed(2):"0";w(this,de).ibc.send(Jt.WINDOW_MAIN,"ibc-target:download:info",[w(this,me),Pe,{fileName:se,totalBytes:xe,progress:ir,done:!1,error:null}])}if(w(this,Ue).signal.aborted)throw new Error('Download cancelled for "'.concat(se,'"'));if(rr){tr();break}}}catch(ne){return tr("".concat(ne.message??ne)),await w(this,de).ipc.diskStorage.outputFilesDelete(w(this,me),y,se),null}return Re});P(this,"makeRequest",async(y,d="GET",m={},v={},I=!0,x=60,R=!0)=>{await w(this,K).call(this,10);let{body:W,method:X,headers:Pe}=w(this,ui).call(this,d,m,v,I),ve=setTimeout(()=>w(this,Ue).abort("Request timed out after ".concat(x,"s")),x*1e3);try{if(w(this,Ue).signal.aborted)throw new Error("Request cancelled");let pe=await fetch(y,{signal:w(this,Ue).signal,body:W,method:X,headers:Pe,priority:"high",redirect:"follow"});return!R&&pe.body?.cancel?.(),{ok:pe.ok,status:pe.status,headers:Object.fromEntries(pe.headers.entries()),data:R?I?await pe.json():await pe.text():null}}finally{clearTimeout(ve)}});P(this,"saveUrl",async(y,d,m,v=600,I=null)=>(m=new URL(m).toString(),setTimeout(()=>{let x=document.createElement("a");x.href=m,x.style.display="none",x.download=m.replace(/\/+$/g,"").replace(/^.*\//g,"")||d,document.body.appendChild(x),x.click(),document.body.removeChild(x)},250),await w(this,de).ipc.target.saveDownload(w(this,me),y,d,v,I)));P(this,"clickAt",async(y,d,m=!1,v=!1)=>{await w(this,K).call(this,10);let I=await w(this,lt).call(this,y,d,m?"double-click":"click");return!v&&await w(this,Lr).call(this,y,d),I});P(this,"clickOn",async(y,d=!1,m=!1)=>{await w(this,K).call(this,10);let v=w(this,Se).call(this,y);if(!(v instanceof Element))return!1;await w(this,yt).call(this,v);let I=w(this,Et).call(this,v);return await this.clickAt(I.x,I.y,d,m)});P(this,"hoverAt",async(y,d)=>await w(this,lt).call(this,y,d));P(this,"hoverOn",async y=>{await w(this,K).call(this,10);let d=w(this,Se).call(this,y);if(!(d instanceof Element))return!1;await w(this,yt).call(this,d);let m=w(this,Et).call(this,d);return await w(this,lt).call(this,m.x,m.y)});P(this,"hoverCenter",async()=>{await w(this,K).call(this,10),await w(this,Lr).call(this,w(this,Be).x??0,w(this,Be).y??0);let y=Math.round(window.innerWidth||document.documentElement.clientWidth)/2,d=Math.round(window.innerHeight||document.documentElement.clientHeight)/2;return await w(this,lt).call(this,y,d)});P(this,"jiggle",async(y=10)=>{if(await w(this,K).call(this,10),!Number.isInteger(y)||y<1)return!1;let d=Math.floor(Math.random()*3)+5,m=[];for(let I=1;I<=d;I++){let x=Math.floor(Math.random()*(y/2))+Math.round(y/2),R=Math.floor(Math.random()*360)*(Math.PI/180),W=w(this,Be).x+x*Math.cos(R),X=w(this,Be).y+x*Math.sin(R);m.push({x:W,y:X})}m.push(w(this,Be));let v=w(this,oi).call(this);for(let I of m)await w(this,de).ipc.target.mouse(w(this,me),I.x,I.y,null,!0,v),Je(this,Be,{...I,name:null});return await w(this,K).call(this,er),!0});P(this,"type",async(y,d,m=!1,v=!1,I=5)=>{await w(this,K).call(this,10),typeof d!="string"&&(d=""),I=parseInt(I,10),I=Number.isInteger(I)?I>250?250:I<1?1:I:5;let x=w(this,Se).call(this,y);if(!w(this,qi).call(this,x))return!1;await w(this,yt).call(this,x);let R=w(this,Et).call(this,x),W=await w(this,de).ipc.target.typeAt(w(this,me),R.x,R.y,d,m,I);return v&&(await w(this,K).call(this,75+Math.floor(Math.random()*125)),await w(this,de).ipc.target.sendKeys(w(this,me),"enter")),await w(this,K).call(this,er),W});P(this,"typeAt",async(y,d,m,v=!1,I=!1,x=5)=>{await w(this,K).call(this,10),typeof m!="string"&&(m=""),x=parseInt(x,10),x=Number.isInteger(x)?x>250?250:x<1?1:x:5;let R=await w(this,de).ipc.target.typeAt(w(this,me),y,d,m,v,x);return I&&await w(this,de).ipc.target.sendKeys(w(this,me),"enter"),await w(this,K).call(this,er),R});P(this,"select",async(y,d)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y);if(!(m instanceof HTMLSelectElement))return!1;d=(Array.isArray(d)?d:[d]).map(x=>"".concat(x)),await w(this,yt).call(this,m),m.focus();let v=process.platform==="darwin"&&!m.multiple;if(v&&(m.multiple=!0),m.multiple){for(let x of m.options)(d.includes(x.value)?!x.selected:x.selected)&&(x.selected=d.includes(x.value));await w(this,K).call(this,25+Math.floor(Math.random()*26));for(let x=0;x<=1;x++)await w(this,de).ipc.target.sendKeys(w(this,me),"space",{ctrl:!0}),await w(this,K).call(this,25+Math.floor(Math.random()*26))}else{let x=Array.from(m.options).map(R=>R.value).indexOf(d[0]);if(x!==-1){m.value=d[0],await w(this,K).call(this,25+Math.floor(Math.random()*26));let R=x===0?["right","left"]:["left","right"];for(let W of R)await w(this,de).ipc.target.sendKeys(w(this,me),W),await w(this,K).call(this,25+Math.floor(Math.random()*26))}}v&&(m.multiple=!1),m.blur(),await w(this,Lr).call(this,w(this,Be).x,w(this,Be).y);let{bottom:I}=m.getBoundingClientRect();return await w(this,lt).call(this,w(this,Be).x,I+10),await w(this,K).call(this,er),!0});P(this,"check",async(y,d)=>{await w(this,K).call(this,10);let m=w(this,Se).call(this,y);if(!(m instanceof Element)||m.tagName.toLowerCase()!=="input"||!["checkbox","radio"].includes(m.type.toLowerCase()))return!1;d=(Array.isArray(d)?d:[d]).map(I=>"".concat(I));let v=[];do{let I=m.closest("form")||document;if(!I)break;if(m.type.toLowerCase()==="checkbox"){let R=I.querySelectorAll('input[type="checkbox"][name="'.concat(CSS.escape(m.name),'"]'));for(let W of R)(d.includes(W.value)?!W.checked:W.checked)&&v.push(W);break}if(!d.length)break;let x=I.querySelectorAll('input[type="radio"][name="'.concat(CSS.escape(m.name),'"]'));for(let R of x)if(d[0]===R.value&&!R.checked){v.push(R);break}}while(!1);if(await w(this,K).call(this,250),v.length){for(let I of v){await w(this,yt).call(this,I);let x=w(this,Et).call(this,I);x!==null&&await this.clickAt(x.x,x.y)}await w(this,K).call(this,er)}return!0});P(this,"videoStart",async(y,d,m=null,v=20,I="av1")=>{await w(this,K).call(this,10);let x="".concat(y,"-").concat(d);if(w(this,bt)!==!1){if(x===w(this,bt))return null;throw new Error("Cannot record more than one video per agent")}Je(this,bt,x);let{fileName:R,filePath:W,minSize:X,maxSize:Pe}=await w(this,de).ipc.diskStorage.outputFilesInit(w(this,me),y,d,m??"mp4"),ve=0,pe=0,h=Number.isInteger(Pe)?Pe*1048576:null,ut=()=>{w(this,de).ibc.send(Jt.WINDOW_MAIN,"ibc-target:video:info",[w(this,me),{fileName:"\u{1F3A5} ".concat(R),rec:!0,total:pe}])},se=(Re=null)=>{Je(this,bt,!1),w(this,de).ibc.send(Jt.WINDOW_MAIN,"ibc-target:video:info",[w(this,me),{fileName:"\u{1F3A5} ".concat(R),rec:!1,total:pe}]),w(this,de).ibc.send(Jt.WINDOW_MAIN,"ibc-target:download:info",[w(this,me),x,{fileName:"\u{1F3A5} ".concat(R),totalBytes:ve,progress:"100",done:!0,error:Re}]),Re!==null&&w(this,de).ipc.diskStorage.outputFilesDelete(w(this,me),y,R)};try{if(w(this,Ue).signal.aborted)throw new Error("Video recording cancelled");let Re=1e3/v,{width:he,height:H}=await w(this,de).ipc.target.getBounds(w(this,me)),xe=he-he%2,tr=H-H%2,ne={av1:"av1",h264:"avc"},oe=new Nh({codec:ne[I]??"av1",bitrate:Oh,sizeChangeBehavior:"fill"}),Me=new zh({format:new Rh({fastStart:"in-memory"}),target:new Dh(new WritableStream({start:async()=>{this._fileHandle=await Uh.open(W,"w")},write:async Fe=>{await this._fileHandle.write(Fe.data,0,Fe.data.byteLength,Fe.position),ve+=Fe.data.byteLength,h!==null&&ve>=h&&Je(this,bt,!1)},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}}),{chunked:!0,chunkSize:262144})});Me.addVideoTrack(oe),Me.setMetadataTags({title:R,artist:"oglama.com",date:new Date,comment:"Generated by Oglama",raw:{"\xA9cpy":"\xA9 ".concat(new Date().getFullYear()," https://oglama.com/")}}),(async()=>{ut();try{await Me.start();let{imgData:Fe}=await w(this,de).ipc.target.getScreenshotData(w(this,me),xe,tr);await oe.add(new dc(Fe,{timestamp:0,duration:1/v,format:"BGRA",codedWidth:xe,codedHeight:tr,rotation:0}));let rr=Math.floor(performance.now()/1e3),tt=1;for(;w(this,bt)===x&&!w(this,Ue).signal.aborted;){let ir=performance.now(),{imgData:Vt,imgSize:Vr}=await w(this,de).ipc.target.getScreenshotData(w(this,me));await oe.add(new dc(Vt,{timestamp:tt*Re/1e3,duration:1/v,format:"BGRA",codedWidth:Vr.width,codedHeight:Vr.height,rotation:0})),tt++;let At=performance.now()-ir;At<Re&&await new Promise(di=>setTimeout(di,Re-At));let Wr=Math.floor(performance.now()/1e3)-rr;Wr>pe&&(pe=Wr,ut())}se()}catch(Fe){se("".concat(Fe.message??Fe))}await Me.finalize();do{if(ve<=0){se('Failed to record video as "'.concat(R,'"'));break}if(Number.isInteger(X)&&ve<X*1048576){se('Minimum file size not met for "'.concat(R,'" (').concat((ve/1048576).toFixed(3),"MB)"));break}}while(!1)})()}catch(Re){return se("".concat(Re.message??Re)),null}return W});P(this,"videoStop",async(y,d)=>{"".concat(y,"-").concat(d)===w(this,bt)&&Je(this,bt,!1)});Je(this,me,y),Je(this,de,new Fh(Jt.getTargetChannelName(y),!1).getSdk());for(let d of Object.getOwnPropertyNames(this))typeof this[d]=="function"&&w(this,de).ibc.handle(d,this[d])}},me=new WeakMap,de=new WeakMap,mr=new WeakMap,Ur=new WeakMap,Be=new WeakMap,bt=new WeakMap,Ue=new WeakMap,K=new WeakMap,pr=new WeakMap,Se=new WeakMap,$i=new WeakMap,oi=new WeakMap,lt=new WeakMap,Lr=new WeakMap,Et=new WeakMap,qi=new WeakMap,ci=new WeakMap,li=new WeakMap,yt=new WeakMap,gr=new WeakMap,ui=new WeakMap,hc)});var Lh=mc(),pc=process.argv.filter(J=>J.indexOf("--agent-id=")>=0).shift();if(typeof pc=="string"){let J=pc.split("=")[1];J.length&&new Lh(J)}
