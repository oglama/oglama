/*!
 * @architect Mark Jivko <mark@oglama.com>
 * @copyright Â© 2024-2025 Oglama (https://oglama.com)
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Kd=Object.defineProperty;var ko=Y=>{throw TypeError(Y)};var Gd=(Y,x,k)=>x in Y?Kd(Y,x,{enumerable:!0,configurable:!0,writable:!0,value:k}):Y[x]=k;var Re=(Y,x)=>()=>(x||Y((x={exports:{}}).exports,x),x.exports);var _=(Y,x,k)=>Gd(Y,typeof x!="symbol"?x+"":x,k),yo=(Y,x,k)=>x.has(Y)||ko("Cannot "+k);var W=(Y,x,k)=>(yo(Y,x,"read from private field"),k?k.call(Y):x.get(Y)),Ke=(Y,x,k)=>x.has(Y)?ko("Cannot add the same private member more than once"):x instanceof WeakSet?x.add(Y):x.set(Y,k),sr=(Y,x,k,S)=>(yo(Y,x,"write to private field"),S?S.call(Y,k):x.set(Y,k),k);var xi=Re((Ah,To)=>{var ct;To.exports=(ct=class{static getSourceChannelName(x){return"".concat(ct.WINDOW_SOURCE,"/").concat(x)}static getTargetChannelName(x){return"".concat(ct.WINDOW_TARGET,"/").concat(x)}static generateKey(){return"".concat(Date.now().toString(36)).concat(Math.random().toString(36).substring(2,13))}},_(ct,"WINDOW_MAIN_LOGIN","@main/login"),_(ct,"WINDOW_MAIN","@main"),_(ct,"WINDOW_SOURCE","@source"),_(ct,"WINDOW_TARGET","@target"),ct)});var wt=Re((Fh,vo)=>{var{ipcRenderer:Xd}=require("electron"),ar,So;vo.exports=(So=class{constructor(){Ke(this,ar,{})}_register(x){if(typeof x=="string")for(let k of Object.getOwnPropertyNames(this))["_","#"].includes(k[0])||typeof this[k]!="function"||(W(this,ar)[k]="ipc:".concat(x,":").concat(k))}_runner(x,...k){let S=function(C,N,X){this.run=async function(){let me=null;if(typeof W(C,ar)[N]=="string"&&(me=await Xd.invoke(W(C,ar)[N],...X)),me instanceof Error)throw new Error("".concat(W(C,ar)[N]," ").concat(me.message??me));return me}};return new S(this,x,k)}async _promise(x,...k){return await this._runner(x,...k).run()}},ar=new WeakMap,So)});var Co=Re((Dh,_o)=>{var Yd=wt();_o.exports=class extends Yd{constructor(){super();_(this,"openAgentFiles",k=>this._promise("openAgentFiles",k));_(this,"purge",k=>this._promise("purge",k));_(this,"runInit",(k,S=null,C=null,N=null)=>this._promise("runInit",k,S,C,N));_(this,"runDelete",(k,S)=>this._promise("runDelete",k,S));_(this,"envGet",k=>this._promise("envGet",k));_(this,"envSet",(k,S)=>this._promise("envSet",k,S));_(this,"sourceGet",k=>this._promise("sourceGet",k));_(this,"sourceSet",(k,S)=>this._promise("sourceSet",k,S));_(this,"inputsGet",(k,S="session",C=null)=>this._promise("inputsGet",k,S,C));_(this,"inputScalarsSet",(k,S,C=null)=>this._promise("inputScalarsSet",k,S,C));_(this,"inputFilesAdd",(k,S,C,N=null)=>this._promise("inputFilesAdd",k,S,C,N));_(this,"inputFilesDelete",(k,S,C,N=null)=>this._promise("inputFilesDelete",k,S,C,N));_(this,"inputTableQuery",(k,S,C=1,N=5e3,X=null)=>this._promise("inputTableQuery",k,S,C,N,X));_(this,"inputTableAdd",(k,S,C=[],N=null)=>this._promise("inputTableAdd",k,S,C,N));_(this,"inputTableGet",(k,S,C,N="session",X=null)=>this._promise("inputTableGet",k,S,C,N,X));_(this,"inputTableUpdate",(k,S,C,N,X=null)=>this._promise("inputTableUpdate",k,S,C,N,X));_(this,"inputTableDelete",(k,S,C=null,N=null)=>this._promise("inputTableDelete",k,S,C,N));_(this,"outputTableQuery",(k,S,C,N=1,X=5e3)=>this._promise("outputTableQuery",k,S,C,N,X));_(this,"outputTableAdd",(k,S,C,N)=>this._promise("outputTableAdd",k,S,C,N));_(this,"outputsGet",(k,S)=>this._promise("outputsGet",k,S));_(this,"outputsQuery",(k,S,C=null,N=null,X=null)=>this._promise("outputsQuery",k,S,C,N,X));_(this,"outputScalarSet",async(k,S,C,N)=>this._promise("outputScalarSet",k,S,C,N));_(this,"outputFilesInit",async(k,S,C,N=null)=>this._promise("outputFilesInit",k,S,C,N));_(this,"outputFilesAppend",async(k,S,C,N,X=null)=>this._promise("outputFilesAppend",k,S,C,N,X));_(this,"outputFilesDelete",async(k,S,C)=>this._promise("outputFilesDelete",k,S,C));this._register("diskStorage")}}});var Po=Re((Uh,xo)=>{var Zd=wt();xo.exports=class extends Zd{constructor(){super();_(this,"getAt",(k,S)=>this._promise("getAt",k,S));_(this,"create",(k,S,C)=>this._promise("create",k,S,C));_(this,"readAll",(k,S)=>this._promise("readAll",k,S));_(this,"read",(k,S)=>this._promise("read",k,S));_(this,"updateName",(k,S,C)=>this._promise("updateName",k,S,C));_(this,"updateInfo",(k,S,C)=>this._promise("updateInfo",k,S,C));_(this,"updateReady",(k,S,C)=>this._promise("updateReady",k,S,C));_(this,"updateEnabled",(k,S,C)=>this._promise("updateEnabled",k,S,C));_(this,"delete",(k,S=null,C=null)=>this._promise("delete",k,S,C));this._register("session")}}});var Eo=Re((Wh,Io)=>{var Jd=wt();Io.exports=class extends Jd{constructor(){super();_(this,"install",()=>this._promise("install"));_(this,"check",()=>this._promise("check"));this._register("updater")}}});var Bo=Re(($h,Ao)=>{var eh=wt();Ao.exports=class extends eh{constructor(){super();_(this,"getOS",()=>this._promise("getOS"));_(this,"getName",()=>this._promise("getName"));_(this,"getUUID",()=>this._promise("getUUID"));_(this,"getSerialNumber",()=>this._promise("getSerialNumber"));_(this,"getRam",()=>this._promise("getRam"));_(this,"getCpuArch",()=>this._promise("getCpuArch"));_(this,"getCpuName",()=>this._promise("getCpuName"));_(this,"setPostAuth",k=>this._promise("setPostAuth",!!k));_(this,"getPostAuth",()=>this._promise("getPostAuth"));_(this,"showFileInFolder",k=>this._promise("showFileInFolder",k));_(this,"request",(k,S="GET",C={},N={},X=!0,me=60,Oe=!0)=>this._promise("request",k,S,C,N,X,me,Oe));this._register("device")}}});var Fo=Re((Kh,Mo)=>{var th=wt();Mo.exports=class extends th{constructor(){super();_(this,"list",()=>this._promise("list"));_(this,"closeAll",()=>this._promise("closeAll"));_(this,"open",k=>this._promise("open",k));_(this,"close",k=>this._promise("close",k));_(this,"webContents",(k,S,C)=>this._promise("webContents",k,S,C));this._register("source")}}});var Ro=Re((Yh,zo)=>{var rh=wt();zo.exports=class extends rh{constructor(){super();_(this,"list",()=>this._promise("list"));_(this,"removeAll",()=>this._promise("removeAll"));_(this,"add",(k,S,C=!1)=>this._promise("add",k,S,C));_(this,"remove",k=>this._promise("remove",k));_(this,"select",k=>this._promise("select",k));_(this,"getSelected",()=>this._promise("getSelected"));_(this,"setControlled",(k,S=!0)=>this._promise("setControlled",k,S));_(this,"openDevTools",(k,S=null)=>this._promise("openDevTools",k,S));_(this,"getBounds",k=>this._promise("getBounds",k));_(this,"mouse",(k,S,C,N=null,X=!1,me=[])=>this._promise("mouse",k,S,C,N,X,me));_(this,"typeAt",(k,S,C,N,X=!1,me=5)=>this._promise("typeAt",k,S,C,N,X,me));_(this,"loadUrl",(k,S)=>this._promise("loadUrl",k,S));_(this,"getUrl",k=>this._promise("getUrl",k));_(this,"getTitle",k=>this._promise("getTitle",k));_(this,"reload",(k,S=!1)=>this._promise("reload",k,S));_(this,"goHome",k=>this._promise("goHome",k));_(this,"goBack",k=>this._promise("goBack",k));_(this,"goForward",k=>this._promise("goForward",k));_(this,"setFileInput",(k,S,C)=>this._promise("setFileInput",k,S,C));_(this,"openInNewWindow",(k,S)=>this._promise("openInNewWindow",k,S));_(this,"waitForDomReady",(k,S=30)=>this._promise("waitForDomReady",k,S));_(this,"saveDownload",(k,S,C,N=600,X=null)=>this._promise("saveDownload",k,S,C,N,X));_(this,"saveScreenshot",(k,S,C,N=null)=>this._promise("saveScreenshot",k,S,C,N));_(this,"getScreenshotData",(k,S=null,C=null,N=!1)=>this._promise("getScreenshotData",k,S,C,N));_(this,"smoothScroll",(k,S,C=100,N=!0)=>this._promise("smoothScroll",k,S,C,N));_(this,"webContents",(k,S,C=[],N=null,X=[])=>this._promise("webContents",k,S,C,N,X));_(this,"sendKeys",(k,S,C={})=>this._promise("sendKeys",k,S,C));this._register("target")}}});var Oo=Re((ef,Do)=>{var ih=wt();Do.exports=class extends ih{constructor(){super();_(this,"openExternal",k=>this._promise("openExternal","".concat(k)));this._register("main/login")}}});var Uo=Re((sf,No)=>{var sh=wt(),ah=Oo();No.exports=class extends sh{constructor(){super();_(this,"login",null);_(this,"focus",()=>this._promise("focus"));_(this,"setOnTop",(k=!0)=>this._promise("setOnTop",!!k));_(this,"getOnTop",()=>this._promise("getOnTop"));_(this,"setDarkMode",k=>this._promise("setDarkMode",!!k));_(this,"getDarkMode",()=>this._promise("getDarkMode"));_(this,"getProcessVersions",()=>this._promise("getProcessVersions"));_(this,"quit",()=>this._promise("quit"));_(this,"openExternal",k=>this._promise("openExternal","".concat(k)));_(this,"showOpenDialog",(k,S=[],C=!1)=>this._promise("showOpenDialog",k,S,C));this._register("main"),this.login=new ah}}});var Vo=Re((of,Lo)=>{var nh=wt();Lo.exports=class extends nh{constructor(){super();_(this,"install",k=>this._promise("install",k));_(this,"getPort",()=>this._promise("getPort"));this._register("llm")}}});var Xs=Re((uf,Ho)=>{var{ipcRenderer:Pi,contextBridge:oh}=require("electron"),ch=Co(),lh=Po(),uh=Eo(),dh=Bo(),hh=Fo(),fh=Ro(),mh=Uo(),ph=Vo(),Bt=xi(),Ze,xr,He,Pr,Wo;Ho.exports=(Wo=class{constructor(x,k=!0){Ke(this,Ze,"");Ke(this,xr,{});Ke(this,He,{});Ke(this,Pr,{});_(this,"source",{send:(x,k,S)=>{this.send(Bt.getSourceChannelName(x),k,S)},invoke:async(x,k,S,C=0)=>await this.invoke(Bt.getSourceChannelName(x),k,S,C)});_(this,"target",{send:(x,k,S)=>{(async()=>this.send(Bt.getTargetChannelName(x),k,S))()},invoke:async(x,k,S,C=0)=>await this.invoke(Bt.getTargetChannelName(x),k,S,C)});let S=this;sr(this,Ze,x),sr(this,Pr,{ibc:{handle:(...C)=>this.handle.call(this,...C),send:(...C)=>this.send.call(this,...C),invoke:async(...C)=>await this.invoke.call(this,...C),source:{send:(...C)=>this.source.send.call(this,...C),invoke:async(...C)=>await this.source.invoke.call(this,...C)},target:{send:(...C)=>this.target.send.call(this,...C),invoke:async(...C)=>await this.target.invoke.call(this,...C)},winName:W(this,Ze)},ipc:{diskStorage:new ch,session:new lh,updater:new uh,device:new dh,source:new hh,target:new fh,main:new mh,llm:new ph},devMode:!1}),Pi.on(W(this,Ze),(C,N)=>{if(N[0]==="ibc-target:cancel-promises"&&typeof N[1]=="string"){for(let ye of Object.keys(W(this,He)))if(W(this,He)[ye].toWinName===Bt.getTargetChannelName(N[1])){try{typeof N[2]=="string"?W(this,He)[ye].reject(new Error(N[2])):W(this,He)[ye].resolve(null)}catch{}delete W(S,He)[ye]}return}if(N.length<3)return;let[X,me,Oe]=N,{type:qe,fromWin:Mt,promiseId:Be}=Oe??{};if(qe==="req")(async()=>{let ye=null;try{if(typeof X!="string"||typeof W(S,xr)[X]!="function")throw new Error('Inter-Browser Communication: handle "'.concat(X,'" not declared yet'));Array.isArray(me)||(me=[]),ye=await W(S,xr)[X](...me)}catch(d){let kt=W(S,Ze).indexOf(Bt.WINDOW_TARGET)===0?"ibc.target.invoke":W(S,Ze).indexOf(Bt.WINDOW_SOURCE)===0?"ibc.source.invoke":W(S,Ze);ye=new Error("".concat(kt,"(").concat(JSON.stringify(X),") ").concat(d.message??d)),W(S,Ze).indexOf(Bt.WINDOW_TARGET)===0&&console.warn("".concat(X,"() ").concat(d.message??d))}typeof Mt=="string"&&typeof Be=="string"&&Pi.send(Mt,X,ye,{type:"res",promiseId:Be})})();else{let ye=typeof Be=="string"?"".concat(X,":").concat(Be):null;if(ye!==null){let d=W(S,He)[ye]??null;d!==null&&(me instanceof Error?d.reject(me):d.resolve(me),delete W(S,He)[ye])}}}),k&&oh.exposeInMainWorld("sdk",W(this,Pr))}getSdk(){return W(this,Pr)}handle(x,k){typeof x=="string"&&typeof k=="function"&&(W(this,xr)[x]=k)}send(x,k,S){do{if(typeof x!="string"||typeof k!="string")break;Array.isArray(S)||(S=[]),Pi.send(x,k,S,{type:"req",fromWin:W(this,Ze)})}while(!1)}async invoke(x,k,S,C=0){let N=this;if(typeof x!="string"||typeof k!="string")return null;Array.isArray(S)||(S=[]),C=parseInt(C,10),(!Number.isInteger(C)||C<0)&&(C=0);let X=Bt.generateKey(),me=new Promise((Oe,qe)=>{W(this,He)["".concat(k,":").concat(X)]={resolve:Oe,reject:qe,toWinName:x}});return C>0&&setTimeout(()=>{let Oe=typeof X=="string"?"".concat(k,":").concat(X):null;if(typeof W(N,He)[Oe]<"u"){try{W(N,He)[Oe].reject(new Error("".concat(k,"() timed out")))}catch{}delete W(N,He)[Oe]}},C*1e3),Pi.send(x,k,S,{type:"req",fromWin:W(this,Ze),promiseId:X}),me}},Ze=new WeakMap,xr=new WeakMap,He=new WeakMap,Pr=new WeakMap,Wo)});var jo=Re((ff,$o)=>{var gh=xi(),wh=Xs(),$r,qo;$o.exports=(qo=class{constructor(){Ke(this,$r);sr(this,$r,new wh(gh.WINDOW_MAIN_LOGIN).getSdk());for(let x of Object.getOwnPropertyNames(this))typeof this[x]=="function"&&W(this,$r).ibc.handle(x,this[x])}},$r=new WeakMap,qo)});var Go=Re((pf,Ii)=>{"use strict";var bh=(()=>{var Y=Object.create,x=Object.defineProperty,k=Object.getOwnPropertyDescriptor,S=Object.getOwnPropertyNames,C=Object.getPrototypeOf,N=Object.prototype.hasOwnProperty,X=(e,t)=>function(){return t||(0,e[S(e)[0]])((t={exports:{}}).exports,t),t.exports},me=(e,t)=>{for(var r in t)x(e,r,{get:t[r],enumerable:!0})},Oe=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of S(t))!N.call(e,s)&&s!==r&&x(e,s,{get:()=>t[s],enumerable:!(i=k(t,s))||i.enumerable});return e},qe=(e,t,r)=>(r=e!=null?Y(C(e)):{},Oe(t||!e||!e.__esModule?x(r,"default",{value:e,enumerable:!0}):r,e)),Mt=e=>Oe(x({},"__esModule",{value:!0}),e),Be=X({"(disabled):src/node"(){}}),ye={};me(ye,{ADTS:()=>In,ALL_FORMATS:()=>Bl,ALL_TRACK_TYPES:()=>mo,AUDIO_CODECS:()=>Ne,AdtsInputFormat:()=>yn,AdtsOutputFormat:()=>_d,AttachedFile:()=>ti,AudioBufferSink:()=>Kc,AudioBufferSource:()=>Od,AudioSample:()=>dt,AudioSampleSink:()=>ui,AudioSampleSource:()=>Ls,AudioSource:()=>_r,BaseMediaSampleSink:()=>ji,BlobSource:()=>zl,BufferSource:()=>Fl,BufferTarget:()=>eo,CanvasSink:()=>Da,CanvasSource:()=>Rd,Conversion:()=>qd,CustomAudioDecoder:()=>Ma,CustomAudioEncoder:()=>za,CustomVideoDecoder:()=>Ba,CustomVideoEncoder:()=>Fa,EncodedAudioPacketSource:()=>fo,EncodedPacket:()=>pe,EncodedPacketSink:()=>fr,EncodedVideoPacketSource:()=>ho,FLAC:()=>En,FilePathSource:()=>Ol,FilePathTarget:()=>od,FlacInputFormat:()=>kn,FlacOutputFormat:()=>Cd,Input:()=>Fn,InputAudioTrack:()=>rt,InputDisposedError:()=>Ue,InputFormat:()=>xt,InputTrack:()=>di,InputVideoTrack:()=>mr,IsobmffInputFormat:()=>hs,IsobmffOutputFormat:()=>Ps,MATROSKA:()=>vn,MP3:()=>Cn,MP4:()=>Tn,MatroskaInputFormat:()=>fs,MediaSource:()=>Ci,MediaStreamAudioTrackSource:()=>Nd,MediaStreamVideoTrackSource:()=>Dd,MkvOutputFormat:()=>As,MovOutputFormat:()=>Es,Mp3InputFormat:()=>gn,Mp3OutputFormat:()=>Td,Mp4InputFormat:()=>fn,Mp4OutputFormat:()=>Is,NON_PCM_AUDIO_CODECS:()=>Xt,NullTarget:()=>ro,OGG:()=>Pn,OggInputFormat:()=>bn,OggOutputFormat:()=>vd,Output:()=>$s,OutputFormat:()=>It,PCM_AUDIO_CODECS:()=>Te,QTFF:()=>Sn,QUALITY_HIGH:()=>Ds,QUALITY_LOW:()=>Pd,QUALITY_MEDIUM:()=>Id,QUALITY_VERY_HIGH:()=>Ed,QUALITY_VERY_LOW:()=>xd,Quality:()=>Ve,QuickTimeInputFormat:()=>mn,ReadableStreamSource:()=>Nl,RichImageData:()=>Gt,SUBTITLE_CODECS:()=>lt,Source:()=>Lt,StreamSource:()=>Mn,StreamTarget:()=>to,SubtitleSource:()=>Hs,Target:()=>Sr,TextSubtitleSource:()=>Hd,UrlSource:()=>Dl,VIDEO_CODECS:()=>Fe,VideoSample:()=>je,VideoSampleSink:()=>li,VideoSampleSource:()=>Ns,VideoSource:()=>vr,WAVE:()=>xn,WEBM:()=>_n,WavOutputFormat:()=>Sd,WaveInputFormat:()=>wn,WebMInputFormat:()=>pn,WebMOutputFormat:()=>Bs,canEncode:()=>Ad,canEncodeAudio:()=>Si,canEncodeSubtitles:()=>vi,canEncodeVideo:()=>Ti,getEncodableAudioCodecs:()=>_i,getEncodableCodecs:()=>Bd,getEncodableSubtitleCodecs:()=>lo,getEncodableVideoCodecs:()=>co,getFirstEncodableAudioCodec:()=>Md,getFirstEncodableSubtitleCodec:()=>Fd,getFirstEncodableVideoCodec:()=>uo,registerDecoder:()=>Dc,registerEncoder:()=>Oc});function d(e){if(!e)throw new Error("Assertion failed.")}var kt=e=>{let t=(e%360+360)%360;if(t===0||t===90||t===180||t===270)return t;throw new Error("Invalid rotation ".concat(e,"."))},ce=e=>e&&e[e.length-1],Je=e=>e>=0&&e<2**32,ne=class Qo{constructor(t){this.bytes=t,this.pos=0}seekToByte(t){this.pos=8*t}readBit(){let t=Math.floor(this.pos/8),r=this.bytes[t]??0,i=7-(this.pos&7),s=(r&1<<i)>>i;return this.pos++,s}readBits(t){if(t===1)return this.readBit();let r=0;for(let i=0;i<t;i++)r<<=1,r|=this.readBit();return r}writeBits(t,r){let i=this.pos+t;for(let s=this.pos;s<i;s++){let a=Math.floor(s/8),n=this.bytes[a],o=7-(s&7);n&=~(1<<o),n|=(r&1<<i-s-1)>>i-s-1<<o,this.bytes[a]=n}this.pos=i}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let t=this.pos/8,r=this.bytes[t]??0;return this.pos+=8,r}skipBits(t){this.pos+=t}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let t=new Qo(this.bytes);return t.pos=this.pos,t}},U=e=>{let t=0;for(;e.readBits(1)===0&&t<32;)t++;if(t>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<t)-1+e.readBits(t)},jt=e=>{let t=U(e);return(t&1)===0?-(t>>1):t+1>>1},Kr=(e,t,r,i)=>{for(let s=t;s<r;s++){let a=Math.floor(s/8),n=e[a],o=7-(s&7);n&=~(1<<o),n|=(i&1<<r-s-1)>>r-s-1<<o,e[a]=n}},le=e=>e.constructor===Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength),ee=e=>e.constructor===DataView?e:e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),Se=new TextDecoder,fe=new TextEncoder,xe=e=>{for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0},nr=e=>Object.fromEntries(Object.entries(e).map(([t,r])=>[r,t])),yt={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},Gr=nr(yt),et={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},Ir=nr(et),tt={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Xr=nr(tt),Qt=e=>!!e&&!!e.primaries&&!!e.transfer&&!!e.matrix&&e.fullRange!==void 0,Kt=e=>e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e),Tt=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e,t=new Promise(i=>{e=i}),r=this.currentPromise;return this.currentPromise=t,await r,e}},Ft=e=>[...e].map(t=>t.toString(16).padStart(2,"0")).join(""),Js=e=>(e=e>>1&1431655765|(e&1431655765)<<1,e=e>>2&858993459|(e&858993459)<<2,e=e>>4&252645135|(e&252645135)<<4,e=e>>8&16711935|(e&16711935)<<8,e=e>>16&65535|(e&65535)<<16,e>>>0),Ai=(e,t,r)=>{let i=0,s=e.length-1,a=-1;for(;i<=s;){let n=i+s>>1,o=r(e[n]);o===t?(a=n,s=n-1):o<t?i=n+1:s=n-1}return a},oe=(e,t,r)=>{let i=0,s=e.length-1,a=-1;for(;i<=s;){let n=i+(s-i+1)/2|0;r(e[n])<=t?(a=n,i=n+1):s=n-1}return a},ea=(e,t,r)=>{let i=oe(e,r(t),r);e.splice(i+1,0,t)},we=()=>{let e,t;return{promise:new Promise((i,s)=>{e=i,t=s}),resolve:e,reject:t}},ta=(e,t)=>{for(let r=e.length-1;r>=0;r--)if(t(e[r]))return e[r]},ra=(e,t)=>{for(let r=e.length-1;r>=0;r--)if(t(e[r]))return r;return-1},ec=async function*(e){Symbol.iterator in e?yield*e[Symbol.iterator]():yield*e[Symbol.asyncIterator]()},tc=e=>{if(!(Symbol.iterator in e)&&!(Symbol.asyncIterator in e))throw new TypeError("Argument must be an iterable or async iterable.")},Me=e=>{throw new Error("Unexpected value: ".concat(e))},Yr=(e,t,r)=>{let i=e.getUint8(t),s=e.getUint8(t+1),a=e.getUint8(t+2);return r?i|s<<8|a<<16:i<<16|s<<8|a},rc=(e,t,r)=>Yr(e,t,r)<<8>>8,ia=(e,t,r,i)=>{r=r>>>0,r=r&16777215,i?(e.setUint8(t,r&255),e.setUint8(t+1,r>>>8&255),e.setUint8(t+2,r>>>16&255)):(e.setUint8(t,r>>>16&255),e.setUint8(t+1,r>>>8&255),e.setUint8(t+2,r&255))},ic=(e,t,r,i)=>{r=_e(r,-8388608,8388607),r<0&&(r=r+16777216&16777215),ia(e,t,r,i)},sc=(e,t,r,i)=>{i?(e.setUint32(t+0,r,!0),e.setInt32(t+4,Math.floor(r/2**32),!0)):(e.setInt32(t+0,Math.floor(r/2**32),!0),e.setUint32(t+4,r,!0))},Zr=(e,t)=>({async next(){let r=await e.next();return r.done?{value:void 0,done:!0}:{value:t(r.value),done:!1}},return(){return e.return()},throw(r){return e.throw(r)},[Symbol.asyncIterator](){return this}}),_e=(e,t,r)=>Math.max(t,Math.min(r,e)),$e="und",Jr=(e,t)=>{let r=10**t;return Math.round(e*r)/r},Bi=(e,t)=>Math.round(e/t)*t,ac=e=>{let t=0;for(;e;)t++,e>>=1;return t},nc=/^[a-z]{3}$/,Er=e=>nc.test(e),zt=1e6*(1+Number.EPSILON),sa=(e,t)=>{let r={...e,...t};if(e.headers||t.headers){let i=e.headers?aa(e.headers):{},s=t.headers?aa(t.headers):{},a={...i};Object.entries(s).forEach(([n,o])=>{let c=Object.keys(a).find(l=>l.toLowerCase()===n.toLowerCase());c&&delete a[c],a[n]=o}),r.headers=a}return r},aa=e=>{if(e instanceof Headers){let t={};return e.forEach((r,i)=>{t[i]=r}),t}if(Array.isArray(e)){let t={};return e.forEach(([r,i])=>{t[r]=i}),t}return e},na=async(e,t,r,i)=>{let s=0;for(;;)try{return await e(t,r)}catch(a){s++;let n=i(s,a,t);if(n===null)throw a;if(console.error("Retrying failed fetch. Error:",a),!Number.isFinite(n)||n<0)throw new TypeError("Retry delay must be a non-negative finite number.");n>0&&await new Promise(o=>setTimeout(o,1e3*n))}},oc=(e,t)=>{let r=e<0?-1:1;e=Math.abs(e);let i=0,s=1,a=1,n=0,o=e;for(;;){let c=Math.floor(o),l=c*a+i,u=c*n+s;if(u>t)return{numerator:r*a,denominator:n};if(i=a,s=n,a=l,n=u,o=1/(o-c),!isFinite(o))break}return{numerator:r*a,denominator:n}},ei=class{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}},Mi=null,Fi=()=>{if(Mi!==null)return Mi;let e=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return Mi=e,e},zi=null,Ar=()=>zi!==null?zi:zi=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox"),or=(e,t)=>e!==-1?e:t,Ri=(e,t,r,i)=>e<=i&&r<=t,cr=function*(e){for(let t in e){let r=e[t];r!==void 0&&(yield{key:t,value:r})}},cc=e=>{switch(e.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},lc=e=>{let t=atob(e),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r},uc=e=>{let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)},dc=(e,t)=>{if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0},oa=()=>{Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose"))},lr=e=>typeof e=="number"&&!Number.isNaN(e),Gt=class{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof t!="string")throw new TypeError("mimeType must be a string.")}},ti=class{constructor(e,t,r,i){if(this.data=e,this.mimeType=t,this.name=r,this.description=i,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!==void 0&&typeof t!="string")throw new TypeError("mimeType, when provided, must be a string.");if(r!==void 0&&typeof r!="string")throw new TypeError("name, when provided, must be a string.");if(i!==void 0&&typeof i!="string")throw new TypeError("description, when provided, must be a string.")}},Di=e=>{if(!e||typeof e!="object")throw new TypeError("tags must be an object.");if(e.title!==void 0&&typeof e.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(e.description!==void 0&&typeof e.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(e.artist!==void 0&&typeof e.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(e.album!==void 0&&typeof e.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(e.albumArtist!==void 0&&typeof e.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(e.trackNumber!==void 0&&(!Number.isInteger(e.trackNumber)||e.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(e.tracksTotal!==void 0&&(!Number.isInteger(e.tracksTotal)||e.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(e.discNumber!==void 0&&(!Number.isInteger(e.discNumber)||e.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(e.discsTotal!==void 0&&(!Number.isInteger(e.discsTotal)||e.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(e.genre!==void 0&&typeof e.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(e.date!==void 0&&(!(e.date instanceof Date)||Number.isNaN(e.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(e.lyrics!==void 0&&typeof e.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(e.images!==void 0){if(!Array.isArray(e.images))throw new TypeError("tags.images, when provided, must be an array.");for(let t of e.images){if(!t||typeof t!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(t.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof t.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(t.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(e.comment!==void 0&&typeof e.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(e.raw!==void 0){if(!e.raw||typeof e.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(let t of Object.values(e.raw))if(t!==null&&typeof t!="string"&&!(t instanceof Uint8Array)&&!(t instanceof Gt)&&!(t instanceof ti))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}},ri=e=>e.title===void 0&&e.description===void 0&&e.artist===void 0&&e.album===void 0&&e.albumArtist===void 0&&e.trackNumber===void 0&&e.tracksTotal===void 0&&e.discNumber===void 0&&e.discsTotal===void 0&&e.genre===void 0&&e.date===void 0&&e.lyrics===void 0&&(!e.images||e.images.length===0)&&e.comment===void 0&&(e.raw===void 0||Object.keys(e.raw).length===0),Fe=["avc","hevc","vp9","av1","vp8"],Te=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],Xt=["aac","opus","mp3","vorbis","flac"],Ne=[...Xt,...Te],lt=["webvtt"],ca=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],la=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Rt=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],ua=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],da=".01.01.01.01.00",ha=".0.110.01.01.01.0",hc=(e,t,r,i)=>{if(e==="avc"){let a=Math.ceil(t/16)*Math.ceil(r/16),n=ca.find(h=>a<=h.maxMacroblocks&&i<=h.maxBitrate)??ce(ca),o=n?n.level:0,c="64".padStart(2,"0"),l="00",u=o.toString(16).padStart(2,"0");return"avc1.".concat(c).concat(l).concat(u)}else if(e==="hevc"){let o=t*r,c=la.find(u=>o<=u.maxPictureSize&&i<=u.maxBitrate)??ce(la);return"hev1.1.6.".concat(c.tier).concat(c.level,".").concat("B0")}else{if(e==="vp8")return"vp8";if(e==="vp9"){let a=t*r,n=Rt.find(c=>a<=c.maxPictureSize&&i<=c.maxBitrate)??ce(Rt);return"vp09.00.".concat(n.level.toString().padStart(2,"0"),".").concat("08")}else if(e==="av1"){let a=t*r,n=ua.find(l=>a<=l.maxPictureSize&&i<=l.maxBitrate)??ce(ua),o=n.level.toString().padStart(2,"0");return"av01.0.".concat(o).concat(n.tier,".").concat("08")}}throw new TypeError("Unhandled codec '".concat(e,"'."))},fc=e=>{let t=e.split("."),r=Number(t[1]),i=Number(t[2]),s=Number(t[3]),a=t[4]?Number(t[4]):1;return[1,1,r,2,1,i,3,1,s,4,1,a]},fa=e=>{let t=e.split("."),s=(1<<7)+1,a=Number(t[1]),n=t[2],o=Number(n.slice(0,-1)),c=(a<<5)+o,l=n.slice(-1)==="H"?1:0,h=Number(t[3])===8?0:1,f=0,g=t[4]?Number(t[4]):0,w=t[5]?Number(t[5][0]):1,p=t[5]?Number(t[5][1]):1,y=t[5]?Number(t[5][2]):0,b=(l<<7)+(h<<6)+(f<<5)+(g<<4)+(w<<3)+(p<<2)+y;return[s,c,b,0]},ma=e=>{let{codec:t,codecDescription:r,colorSpace:i,avcCodecInfo:s,hevcCodecInfo:a,vp9CodecInfo:n,av1CodecInfo:o}=e;if(t==="avc"){if(s){let c=new Uint8Array([s.avcProfileIndication,s.profileCompatibility,s.avcLevelIndication]);return"avc1.".concat(Ft(c))}if(!r||r.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return"avc1.".concat(Ft(r.subarray(1,4)))}else if(t==="hevc"){let c,l,u,h,f,g;if(a)c=a.generalProfileSpace,l=a.generalProfileIdc,u=Js(a.generalProfileCompatibilityFlags),h=a.generalTierFlag,f=a.generalLevelIdc,g=[...a.generalConstraintIndicatorFlags];else{if(!r||r.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let p=ee(r),y=p.getUint8(1);c=y>>6&3,l=y&31,u=Js(p.getUint32(2)),h=y>>5&1,f=p.getUint8(12),g=[];for(let b=0;b<6;b++)g.push(p.getUint8(6+b))}let w="hev1.";for(w+=["","A","B","C"][c]+l,w+=".",w+=u.toString(16).toUpperCase(),w+=".",w+=h===0?"L":"H",w+=f;g.length>0&&g[g.length-1]===0;)g.pop();return g.length>0&&(w+=".",w+=g.map(p=>p.toString(16).toUpperCase()).join(".")),w}else{if(t==="vp8")return"vp8";if(t==="vp9"){if(!n){let b=e.width*e.height,T=ce(Rt).level;for(let v of Rt)if(b<=v.maxPictureSize){T=v.level;break}return"vp09.00.".concat(T.toString().padStart(2,"0"),".08")}let c=n.profile.toString().padStart(2,"0"),l=n.level.toString().padStart(2,"0"),u=n.bitDepth.toString().padStart(2,"0"),h=n.chromaSubsampling.toString().padStart(2,"0"),f=n.colourPrimaries.toString().padStart(2,"0"),g=n.transferCharacteristics.toString().padStart(2,"0"),w=n.matrixCoefficients.toString().padStart(2,"0"),p=n.videoFullRangeFlag.toString().padStart(2,"0"),y="vp09.".concat(c,".").concat(l,".").concat(u,".").concat(h);return y+=".".concat(f,".").concat(g,".").concat(w,".").concat(p),y.endsWith(da)&&(y=y.slice(0,-da.length)),y}else if(t==="av1"){if(!o){let v=e.width*e.height,P=ce(Rt).level;for(let A of Rt)if(v<=A.maxPictureSize){P=A.level;break}return"av01.0.".concat(P.toString().padStart(2,"0"),"M.08")}let c=o.profile,l=o.level.toString().padStart(2,"0"),u=o.tier?"H":"M",h=o.bitDepth.toString().padStart(2,"0"),f=o.monochrome?"1":"0",g=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),w=i?.primaries?yt[i.primaries]:1,p=i?.transfer?et[i.transfer]:1,y=i?.matrix?tt[i.matrix]:1,b=i?.fullRange?1:0,T="av01.".concat(c,".").concat(l).concat(u,".").concat(h);return T+=".".concat(f,".").concat(g.toString().padStart(3,"0")),T+=".".concat(w.toString().padStart(2,"0")),T+=".".concat(p.toString().padStart(2,"0")),T+=".".concat(y.toString().padStart(2,"0")),T+=".".concat(b),T.endsWith(ha)&&(T=T.slice(0,-ha.length)),T}}throw new TypeError("Unhandled codec '".concat(t,"'."))},mc=(e,t,r)=>{if(e==="aac")return t>=2&&r<=24e3?"mp4a.40.29":r<=24e3?"mp4a.40.5":"mp4a.40.2";if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(Te.includes(e))return e;throw new TypeError("Unhandled codec '".concat(e,"'."))},pa=e=>{let{codec:t,codecDescription:r,aacCodecInfo:i}=e;if(t==="aac"){if(!i)throw new TypeError("AAC codec info must be provided.");if(i.isMpeg2)return"mp4a.67";{let s=Oi(r);return"mp4a.40.".concat(s.objectType)}}else{if(t==="mp3")return"mp3";if(t==="opus")return"opus";if(t==="vorbis")return"vorbis";if(t==="flac")return"flac";if(t&&Te.includes(t))return t}throw new TypeError("Unhandled codec '".concat(t,"'."))},ii=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],ga=[-1,1,2,3,4,5,6,8],Oi=e=>{if(!e||e.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let t=new ne(e),r=t.readBits(5);r===31&&(r=32+t.readBits(6));let i=t.readBits(4),s=null;i===15?s=t.readBits(24):i<ii.length&&(s=ii[i]);let a=t.readBits(4),n=null;return a>=1&&a<=7&&(n=ga[a]),{objectType:r,frequencyIndex:i,sampleRate:s,channelConfiguration:a,numberOfChannels:n}},ur=48e3,wa=/^pcm-([usf])(\d+)+(be)?$/,ut=e=>{if(d(Te.includes(e)),e==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(e==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let t=wa.exec(e);d(t);let r;t[1]==="u"?r="unsigned":t[1]==="s"?r="signed":r="float";let i=Number(t[2])/8,s=t[3]!=="be",a=e==="pcm-u8"?2**7:0;return{dataType:r,sampleSize:i,littleEndian:s,silentValue:a}},ba=e=>e.startsWith("avc1")||e.startsWith("avc3")?"avc":e.startsWith("hev1")||e.startsWith("hvc1")?"hevc":e==="vp8"?"vp8":e.startsWith("vp09")?"vp9":e.startsWith("av01")?"av1":e.startsWith("mp4a.40")||e==="mp4a.67"?"aac":e==="mp3"||e==="mp4a.69"||e==="mp4a.6B"||e==="mp4a.6b"?"mp3":e==="opus"?"opus":e==="vorbis"?"vorbis":e==="flac"?"flac":e==="ulaw"?"ulaw":e==="alaw"?"alaw":wa.test(e)?e:e==="webvtt"?"webvtt":null,pc=e=>e==="avc"?{avc:{format:"avc"}}:e==="hevc"?{hevc:{format:"hevc"}}:{},gc=e=>e==="aac"?{aac:{format:"aac"}}:e==="opus"?{opus:{format:"opus"}}:{},wc=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],bc=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,kc=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,yc=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Tc=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,ka=e=>{if(!e)throw new TypeError("Video chunk metadata must be provided.");if(typeof e!="object")throw new TypeError("Video chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof e.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof e.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!wc.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.codedWidth)||e.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(e.decoderConfig.codedHeight)||e.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(e.decoderConfig.description!==void 0&&!Kt(e.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.colorSpace!==void 0){let{colorSpace:t}=e.decoderConfig;if(typeof t!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let r=Object.keys(yt);if(t.primaries!=null&&!r.includes(t.primaries))throw new TypeError("Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ".concat(r.join(", "),"."));let i=Object.keys(et);if(t.transfer!=null&&!i.includes(t.transfer))throw new TypeError("Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ".concat(i.join(", "),"."));let s=Object.keys(tt);if(t.matrix!=null&&!s.includes(t.matrix))throw new TypeError("Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ".concat(s.join(", "),"."));if(t.fullRange!=null&&typeof t.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(e.decoderConfig.codec.startsWith("avc1")||e.decoderConfig.codec.startsWith("avc3")){if(!bc.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(e.decoderConfig.codec.startsWith("hev1")||e.decoderConfig.codec.startsWith("hvc1")){if(!kc.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(e.decoderConfig.codec.startsWith("vp8")){if(e.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(e.decoderConfig.codec.startsWith("vp09")){if(!yc.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(e.decoderConfig.codec.startsWith("av01")&&!Tc.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},Sc=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],dr=e=>{if(!e)throw new TypeError("Audio chunk metadata must be provided.");if(typeof e!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof e.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof e.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!Sc.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.sampleRate)||e.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(e.decoderConfig.numberOfChannels)||e.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(e.decoderConfig.description!==void 0&&!Kt(e.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.codec.startsWith("mp4a")&&e.decoderConfig.codec!=="mp4a.69"&&e.decoderConfig.codec!=="mp4a.6B"&&e.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(e.decoderConfig.codec.startsWith("mp3")||e.decoderConfig.codec.startsWith("mp4a")){if(e.decoderConfig.codec!=="mp3"&&e.decoderConfig.codec!=="mp4a.69"&&e.decoderConfig.codec!=="mp4a.6B"&&e.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(e.decoderConfig.codec.startsWith("opus")){if(e.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(e.decoderConfig.description&&e.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(e.decoderConfig.codec.startsWith("vorbis")){if(e.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(e.decoderConfig.codec.startsWith("flac")){if(e.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!e.decoderConfig.description||e.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((e.decoderConfig.codec.startsWith("pcm")||e.decoderConfig.codec.startsWith("ulaw")||e.decoderConfig.codec.startsWith("alaw"))&&!Te.includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (".concat(Te.join(", "),")."))},ya=e=>{if(!e)throw new TypeError("Subtitle metadata must be provided.");if(typeof e!="object")throw new TypeError("Subtitle metadata must be an object.");if(!e.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof e.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof e.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")},Yt=class{constructor(e){this.mutex=new Tt,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,r){t+=e.source._timestampOffset;let i=this.trackTimestampInfo.get(e);if(!i){if(!r)throw new Error("First frame must be a key frame.");i={maxTimestamp:t,maxTimestampBeforeLastKeyFrame:t},this.trackTimestampInfo.set(e,i)}if(t<0)throw new Error("Timestamps must be non-negative (got ".concat(t,"s)."));if(r&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),t<i.maxTimestampBeforeLastKeyFrame)throw new Error("Timestamps cannot be smaller than the highest timestamp of the previous GOP (a GOP begins with a key frame and ends right before the next key frame). Got ".concat(t,"s, but highest timestamp is ").concat(i.maxTimestampBeforeLastKeyFrame,"s."));return i.maxTimestamp=Math.max(i.maxTimestamp,t),t}},vc=class extends Yt{constructor(e,t){super(e),this.header=new Uint8Array(7),this.headerBitstream=new ne(this.header),this.audioSpecificConfig=null,this.format=t,this.writer=e._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),!this.audioSpecificConfig){dr(r);let n=r?.decoderConfig?.description;d(n),this.audioSpecificConfig=Oi(le(n));let{objectType:o,frequencyIndex:c,channelConfiguration:l}=this.audioSpecificConfig,u=o-1;this.headerBitstream.writeBits(12,4095),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(2,0),this.headerBitstream.writeBits(1,1),this.headerBitstream.writeBits(2,u),this.headerBitstream.writeBits(4,c),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(3,l),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.skipBits(13),this.headerBitstream.writeBits(11,2047),this.headerBitstream.writeBits(2,0)}let s=t.data.byteLength+this.header.byteLength;this.headerBitstream.pos=30,this.headerBitstream.writeBits(13,s);let a=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(t.data),this.format._options.onFrame){let n=new Uint8Array(s);n.set(this.header,0),n.set(t.data,this.header.byteLength),this.format._options.onFrame(n,a)}await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}},Br=e=>{let t=[],r=0;for(;r<e.length;){let i=-1,s=0;for(let a=r;a<e.length-3;a++){if(e[a]===0&&e[a+1]===0&&e[a+2]===1){i=a,s=3;break}if(a<e.length-4&&e[a]===0&&e[a+1]===0&&e[a+2]===0&&e[a+3]===1){i=a,s=4;break}}if(i===-1)break;if(r>0&&i>r){let a=e.subarray(r,i);a.length>0&&t.push(a)}r=i+s}if(r<e.length){let i=e.subarray(r);i.length>0&&t.push(i)}return t},Ta=(e,t)=>{let r=[],i=0,s=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;i+t<=e.length;){let a;t===1?a=s.getUint8(i):t===2?a=s.getUint16(i,!1):t===3?a=Yr(s,i,!1):t===4?a=s.getUint32(i,!1):(Me(t),d(!1)),i+=t;let n=e.subarray(i,i+a);r.push(n),i+=a}return r},Ni=e=>{let t=[],r=e.length;for(let i=0;i<r;i++)i+2<r&&e[i]===0&&e[i+1]===0&&e[i+2]===3?(t.push(0,0),i+=2):t.push(e[i]);return new Uint8Array(t)},_c=e=>{let r=Br(e);if(r.length===0)return null;let i=0;for(let o of r)i+=4+o.byteLength;let s=new Uint8Array(i),a=new DataView(s.buffer),n=0;for(let o of r){let c=o.byteLength;a.setUint32(n,c,!1),n+=4,s.set(o,n),n+=o.byteLength}return s},Cc=(e,t)=>{if(t.description){let s=(le(t.description)[4]&3)+1;return Ta(e,s)}else return Br(e)},si=e=>e[0]&31,Sa=e=>{try{let t=Br(e),r=t.filter(f=>si(f)===7),i=t.filter(f=>si(f)===8),s=t.filter(f=>si(f)===13);if(r.length===0||i.length===0)return null;let a=r[0],n=new ne(Ni(a));if(n.skipBits(1),n.skipBits(2),n.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;let c=n.readAlignedByte(),l=n.readAlignedByte(),u=n.readAlignedByte(),h={configurationVersion:1,avcProfileIndication:c,profileCompatibility:l,avcLevelIndication:u,lengthSizeMinusOne:3,sequenceParameterSets:r,pictureParameterSets:i,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){U(n);let f=U(n);f===3&&n.skipBits(1);let g=U(n),w=U(n);h.chromaFormat=f,h.bitDepthLumaMinus8=g,h.bitDepthChromaMinus8=w,h.sequenceParameterSetExt=s}return h}catch(t){return console.error("Error building AVC Decoder Configuration Record:",t),null}},xc=e=>{let t=[];t.push(e.configurationVersion),t.push(e.avcProfileIndication),t.push(e.profileCompatibility),t.push(e.avcLevelIndication),t.push(252|e.lengthSizeMinusOne&3),t.push(224|e.sequenceParameterSets.length&31);for(let r of e.sequenceParameterSets){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}t.push(e.pictureParameterSets.length);for(let r of e.pictureParameterSets){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}if(e.avcProfileIndication===100||e.avcProfileIndication===110||e.avcProfileIndication===122||e.avcProfileIndication===144){d(e.chromaFormat!==null),d(e.bitDepthLumaMinus8!==null),d(e.bitDepthChromaMinus8!==null),d(e.sequenceParameterSetExt!==null),t.push(252|e.chromaFormat&3),t.push(248|e.bitDepthLumaMinus8&7),t.push(248|e.bitDepthChromaMinus8&7),t.push(e.sequenceParameterSetExt.length);for(let r of e.sequenceParameterSetExt){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}}return new Uint8Array(t)},va=(e,t)=>{if(t.description){let s=(le(t.description)[21]&3)+1;return Ta(e,s)}else return Br(e)},Dt=e=>e[0]>>1&63,_a=e=>{try{let t=Br(e),r=t.filter(K=>Dt(K)===32),i=t.filter(K=>Dt(K)===33),s=t.filter(K=>Dt(K)===34),a=t.filter(K=>Dt(K)===39||Dt(K)===40);if(i.length===0||s.length===0)return null;let n=i[0],o=new ne(Ni(n));o.skipBits(16),o.readBits(4);let c=o.readBits(3),l=o.readBits(1),{general_profile_space:u,general_tier_flag:h,general_profile_idc:f,general_profile_compatibility_flags:g,general_constraint_indicator_flags:w,general_level_idc:p}=Pc(o,c);U(o);let y=U(o);y===3&&o.skipBits(1),U(o),U(o),o.readBits(1)&&(U(o),U(o),U(o),U(o));let b=U(o),T=U(o);U(o);let P=o.readBits(1)?0:c;for(let K=P;K<=c;K++)U(o),U(o),U(o);U(o),U(o),U(o),U(o),U(o),U(o),o.readBits(1)&&o.readBits(1)&&Ic(o),o.skipBits(1),o.skipBits(1),o.readBits(1)&&(o.skipBits(4),o.skipBits(4),U(o),U(o),o.skipBits(1));let A=U(o);if(Ec(o,A),o.readBits(1)){let K=U(o);for(let V=0;V<K;V++)U(o),o.skipBits(1)}o.skipBits(1),o.skipBits(1);let I=0;o.readBits(1)&&(I=Bc(o,c));let M=0;if(s.length>0){let K=s[0],V=new ne(Ni(K));V.skipBits(16),U(V),U(V),V.skipBits(1),V.skipBits(1),V.skipBits(3),V.skipBits(1),V.skipBits(1),U(V),U(V),jt(V),V.skipBits(1),V.skipBits(1),V.readBits(1)&&U(V),jt(V),jt(V),V.skipBits(1),V.skipBits(1),V.skipBits(1),V.skipBits(1);let J=V.readBits(1),de=V.readBits(1);!J&&!de?M=0:J&&!de?M=2:!J&&de?M=3:M=0}let L=[...r.length?[{arrayCompleteness:1,nalUnitType:32,nalUnits:r}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:33,nalUnits:i}]:[],...s.length?[{arrayCompleteness:1,nalUnitType:34,nalUnits:s}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:Dt(a[0]),nalUnits:a}]:[]];return{configurationVersion:1,generalProfileSpace:u,generalTierFlag:h,generalProfileIdc:f,generalProfileCompatibilityFlags:g,generalConstraintIndicatorFlags:w,generalLevelIdc:p,minSpatialSegmentationIdc:I,parallelismType:M,chromaFormatIdc:y,bitDepthLumaMinus8:b,bitDepthChromaMinus8:T,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:l,lengthSizeMinusOne:3,arrays:L}}catch(t){return console.error("Error building HEVC Decoder Configuration Record:",t),null}},Pc=(e,t)=>{let r=e.readBits(2),i=e.readBits(1),s=e.readBits(5),a=0;for(let u=0;u<32;u++)a=a<<1|e.readBits(1);let n=new Uint8Array(6);for(let u=0;u<6;u++)n[u]=e.readBits(8);let o=e.readBits(8),c=[],l=[];for(let u=0;u<t;u++)c.push(e.readBits(1)),l.push(e.readBits(1));if(t>0)for(let u=t;u<8;u++)e.skipBits(2);for(let u=0;u<t;u++)c[u]&&e.skipBits(88),l[u]&&e.skipBits(8);return{general_profile_space:r,general_tier_flag:i,general_profile_idc:s,general_profile_compatibility_flags:a,general_constraint_indicator_flags:n,general_level_idc:o}},Ic=e=>{for(let t=0;t<4;t++)for(let r=0;r<(t===3?2:6);r++)if(!e.readBits(1))U(e);else{let s=Math.min(64,1<<4+(t<<1));t>1&&jt(e);for(let a=0;a<s;a++)jt(e)}},Ec=(e,t)=>{let r=[];for(let i=0;i<t;i++)r[i]=Ac(e,i,t,r)},Ac=(e,t,r,i)=>{let s=0,a=0,n=0;if(t!==0&&(a=e.readBits(1)),a){if(t===r){let c=U(e);n=t-(c+1)}else n=t-1;e.readBits(1),U(e);let o=i[n]??0;for(let c=0;c<=o;c++)e.readBits(1)||e.readBits(1);s=i[n]}else{let o=U(e),c=U(e);for(let l=0;l<o;l++)U(e),e.readBits(1);for(let l=0;l<c;l++)U(e),e.readBits(1);s=o+c}return s},Bc=(e,t)=>{if(e.readBits(1)&&e.readBits(8)===255&&(e.readBits(16),e.readBits(16)),e.readBits(1)&&e.readBits(1),e.readBits(1)&&(e.readBits(3),e.readBits(1),e.readBits(1)&&(e.readBits(8),e.readBits(8),e.readBits(8))),e.readBits(1)&&(U(e),U(e)),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1)&&(U(e),U(e),U(e),U(e)),e.readBits(1)&&(e.readBits(32),e.readBits(32),e.readBits(1)&&U(e),e.readBits(1)&&Mc(e,!0,t)),e.readBits(1)){e.readBits(1),e.readBits(1),e.readBits(1);let r=U(e);return U(e),U(e),U(e),U(e),r}return 0},Mc=(e,t,r)=>{let i=!1,s=!1,a=!1;t&&(i=e.readBits(1)===1,s=e.readBits(1)===1,(i||s)&&(a=e.readBits(1)===1,a&&(e.readBits(8),e.readBits(5),e.readBits(1),e.readBits(5)),e.readBits(4),e.readBits(4),a&&e.readBits(4),e.readBits(5),e.readBits(5),e.readBits(5)));for(let n=0;n<=r;n++){let o=e.readBits(1)===1,c=!0;o||(c=e.readBits(1)===1);let l=!1;c?U(e):l=e.readBits(1)===1;let u=1;l||(u=U(e)+1),i&&Ca(e,u,a),s&&Ca(e,u,a)}},Ca=(e,t,r)=>{for(let i=0;i<t;i++)U(e),U(e),r&&(U(e),U(e)),e.readBits(1)},Fc=e=>{let t=[];t.push(e.configurationVersion),t.push((e.generalProfileSpace&3)<<6|(e.generalTierFlag&1)<<5|e.generalProfileIdc&31),t.push(e.generalProfileCompatibilityFlags>>>24&255),t.push(e.generalProfileCompatibilityFlags>>>16&255),t.push(e.generalProfileCompatibilityFlags>>>8&255),t.push(e.generalProfileCompatibilityFlags&255),t.push(...e.generalConstraintIndicatorFlags),t.push(e.generalLevelIdc&255),t.push(240|e.minSpatialSegmentationIdc>>8&15),t.push(e.minSpatialSegmentationIdc&255),t.push(252|e.parallelismType&3),t.push(252|e.chromaFormatIdc&3),t.push(248|e.bitDepthLumaMinus8&7),t.push(248|e.bitDepthChromaMinus8&7),t.push(e.avgFrameRate>>8&255),t.push(e.avgFrameRate&255),t.push((e.constantFrameRate&3)<<6|(e.numTemporalLayers&7)<<3|(e.temporalIdNested&1)<<2|e.lengthSizeMinusOne&3),t.push(e.arrays.length&255);for(let r of e.arrays){t.push((r.arrayCompleteness&1)<<7|0|r.nalUnitType&63),t.push(r.nalUnits.length>>8&255),t.push(r.nalUnits.length&255);for(let i of r.nalUnits){t.push(i.length>>8&255),t.push(i.length&255);for(let s=0;s<i.length;s++)t.push(i[s])}}return new Uint8Array(t)},xa=e=>{let t=new ne(e);if(t.readBits(2)!==2)return null;let i=t.readBits(1),a=(t.readBits(1)<<1)+i;if(a===3&&t.skipBits(1),t.readBits(1)===1||t.readBits(1)!==0||(t.skipBits(2),t.readBits(24)!==4817730))return null;let l=8;a>=2&&(l=t.readBits(1)?12:10);let u=t.readBits(3),h=0,f=0;if(u!==7)if(f=t.readBits(1),a===1||a===3){let M=t.readBits(1),L=t.readBits(1);h=!M&&!L?3:M&&!L?2:1,t.skipBits(1)}else h=1;else h=3,f=1;let g=t.readBits(16),w=t.readBits(16),p=g+1,y=w+1,b=p*y,T=ce(Rt).level;for(let I of Rt)if(b<=I.maxPictureSize){T=I.level;break}return{profile:a,level:T,bitDepth:l,chromaSubsampling:h,videoFullRangeFlag:f,colourPrimaries:u===2?1:u===1?6:2,transferCharacteristics:u===2?1:u===1?6:2,matrixCoefficients:u===7?0:u===2?1:u===1?6:2}},Pa=function*(e){let t=new ne(e),r=()=>{let i=0;for(let s=0;s<8;s++){let a=t.readAlignedByte();if(i|=(a&127)<<s*7,!(a&128))break;if(s===7&&a&128)return null}return i>=2**32-1?null:i};for(;t.getBitsLeft()>=8;){t.skipBits(1);let i=t.readBits(4),s=t.readBits(1),a=t.readBits(1);t.skipBits(1),s&&t.skipBits(8);let n;if(a){let o=r();if(o===null)return;n=o}else n=Math.floor(t.getBitsLeft()/8);d(t.pos%8===0),yield{type:i,data:e.subarray(t.pos/8,t.pos/8+n)},t.skipBits(n*8)}},Ia=e=>{for(let{type:t,data:r}of Pa(e)){if(t!==1)continue;let i=new ne(r),s=i.readBits(3),a=i.readBits(1),n=i.readBits(1),o=0,c=0,l=0;if(n)o=i.readBits(5);else{if(i.readBits(1)&&(i.skipBits(32),i.skipBits(32),i.readBits(1)))return null;let b=i.readBits(1);b&&(l=i.readBits(5),i.skipBits(32),i.skipBits(5),i.skipBits(5));let T=i.readBits(5);for(let v=0;v<=T;v++){i.skipBits(12);let P=i.readBits(5);if(v===0&&(o=P),P>7){let I=i.readBits(1);v===0&&(c=I)}if(b&&i.readBits(1)){let M=l+1;i.skipBits(M),i.skipBits(M),i.skipBits(1)}i.readBits(1)&&i.skipBits(4)}}let u=i.readBits(1),h=8;s===2&&u?h=i.readBits(1)?12:10:s<=2&&(h=u?10:8);let f=0;s!==1&&(f=i.readBits(1));let g=1,w=1,p=0;return f||(s===0?(g=1,w=1):s===1?(g=0,w=0):h===12&&(g=i.readBits(1),g&&(w=i.readBits(1))),g&&w&&(p=i.readBits(2))),{profile:s,level:o,tier:c,bitDepth:h,monochrome:f,chromaSubsamplingX:g,chromaSubsamplingY:w,chromaSamplePosition:p}}return null},ai=e=>{let t=ee(e),r=t.getUint8(9),i=t.getUint16(10,!0),s=t.getUint32(12,!0),a=t.getInt16(16,!0),n=t.getUint8(18),o=null;return n&&(o=e.subarray(19,21+r)),{outputChannelCount:r,preSkip:i,inputSampleRate:s,outputGain:a,channelMappingFamily:n,channelMappingTable:o}},zc=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],Rc=e=>{let t=e[0]>>3;return{durationInSamples:zc[t]}},Ea=e=>{if(e.length<7)throw new Error("Setup header is too short.");if(e[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...e.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let r=e.length,i=new Uint8Array(r);for(let h=0;h<r;h++)i[h]=e[r-1-h];let s=new ne(i),a=0;for(;s.getBitsLeft()>97;)if(s.readBits(1)===1){a=s.pos;break}if(a===0)throw new Error("Invalid Setup header: framing bit not found.");let n=0,o=!1,c=0;for(;s.getBitsLeft()>=97;){let h=s.pos,f=s.readBits(8),g=s.readBits(16),w=s.readBits(16);if(f>63||g!==0||w!==0){s.pos=h;break}if(s.skipBits(1),n++,n>64)break;s.clone().readBits(6)+1===n&&(o=!0,c=n)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error("Unsupported mode count: ".concat(c,"."));let l=c;s.pos=0,s.skipBits(a);let u=Array(l).fill(0);for(let h=l-1;h>=0;h--)s.skipBits(40),u[h]=s.readBits(1);return{modeBlockflags:u}},Aa=(e,t,r)=>{switch(e){case"avc":return Cc(r,t).some(a=>si(a)===5)?"key":"delta";case"hevc":return va(r,t).some(a=>{let n=Dt(a);return 16<=n&&n<=23})?"key":"delta";case"vp8":return(r[0]&1)===0?"key":"delta";case"vp9":{let i=new ne(r);if(i.readBits(2)!==2)return null;let s=i.readBits(1);return(i.readBits(1)<<1)+s===3&&i.skipBits(1),i.readBits(1)?null:i.readBits(1)===0?"key":"delta"}case"av1":{let i=!1;for(let{type:s,data:a}of Pa(r))if(s===1){let n=new ne(a);n.skipBits(4),i=!!n.readBits(1)}else if(s===3||s===6||s===7){if(i)return"key";let n=new ne(a);return n.readBits(1)?null:n.readBits(2)===0?"key":"delta"}return null}default:Me(e),d(!1)}},Ui=(e,t)=>{var o,c;let r=ee(e),i=0,s=r.getUint32(i,!0);i+=4;let a=Se.decode(e.subarray(i,i+s));i+=s,s>0&&(t.raw??(t.raw={}),(o=t.raw).vendor??(o.vendor=a));let n=r.getUint32(i,!0);i+=4;for(let l=0;l<n;l++){let u=r.getUint32(i,!0);i+=4;let h=Se.decode(e.subarray(i,i+u));i+=u;let f=h.indexOf("=");if(f===-1)continue;let g=h.slice(0,f).toUpperCase(),w=h.slice(f+1);switch(t.raw??(t.raw={}),(c=t.raw)[g]??(c[g]=w),g){case"TITLE":t.title??(t.title=w);break;case"DESCRIPTION":t.description??(t.description=w);break;case"ARTIST":t.artist??(t.artist=w);break;case"ALBUM":t.album??(t.album=w);break;case"ALBUMARTIST":t.albumArtist??(t.albumArtist=w);break;case"COMMENT":t.comment??(t.comment=w);break;case"LYRICS":t.lyrics??(t.lyrics=w);break;case"TRACKNUMBER":{let p=w.split("/"),y=Number.parseInt(p[0],10),b=p[1]&&Number.parseInt(p[1],10);Number.isInteger(y)&&y>0&&(t.trackNumber??(t.trackNumber=y)),b&&Number.isInteger(b)&&b>0&&(t.tracksTotal??(t.tracksTotal=b))}break;case"TRACKTOTAL":{let p=Number.parseInt(w,10);Number.isInteger(p)&&p>0&&(t.tracksTotal??(t.tracksTotal=p))}break;case"DISCNUMBER":{let p=w.split("/"),y=Number.parseInt(p[0],10),b=p[1]&&Number.parseInt(p[1],10);Number.isInteger(y)&&y>0&&(t.discNumber??(t.discNumber=y)),b&&Number.isInteger(b)&&b>0&&(t.discsTotal??(t.discsTotal=b))}break;case"DISCTOTAL":{let p=Number.parseInt(w,10);Number.isInteger(p)&&p>0&&(t.discsTotal??(t.discsTotal=p))}break;case"DATE":{let p=new Date(w);Number.isNaN(p.getTime())||(t.date??(t.date=p))}break;case"GENRE":t.genre??(t.genre=w);break;case"METADATA_BLOCK_PICTURE":{let p=lc(w),y=ee(p),b=y.getUint32(0,!1),T=y.getUint32(4,!1),v=String.fromCharCode(...p.subarray(8,8+T)),P=y.getUint32(8+T,!1),A=Se.decode(p.subarray(12+T,12+T+P)),I=y.getUint32(T+P+28),M=p.subarray(T+P+32,T+P+32+I);t.images??(t.images=[]),t.images.push({data:M,mimeType:v,kind:b===3?"coverFront":b===4?"coverBack":"unknown",name:void 0,description:A||void 0})}break}}},Li=(e,t,r)=>{let i=[e],a=fe.encode("Mediabunny"),n=new Uint8Array(4+a.length),o=new DataView(n.buffer);o.setUint32(0,a.length,!0),n.set(a,4),i.push(n);let c=new Set,l=(w,p)=>{let y="".concat(w,"=").concat(p),b=fe.encode(y);n=new Uint8Array(4+b.length),o=new DataView(n.buffer),o.setUint32(0,b.length,!0),n.set(b,4),i.push(n),c.add(w)};for(let{key:w,value:p}of cr(t))switch(w){case"title":l("TITLE",p);break;case"description":l("DESCRIPTION",p);break;case"artist":l("ARTIST",p);break;case"album":l("ALBUM",p);break;case"albumArtist":l("ALBUMARTIST",p);break;case"genre":l("GENRE",p);break;case"date":{let y=t.raw?.DATE??t.raw?.date;y&&typeof y=="string"?l("DATE",y):l("DATE",p.toISOString().slice(0,10))}break;case"comment":l("COMMENT",p);break;case"lyrics":l("LYRICS",p);break;case"trackNumber":l("TRACKNUMBER",p.toString());break;case"tracksTotal":l("TRACKTOTAL",p.toString());break;case"discNumber":l("DISCNUMBER",p.toString());break;case"discsTotal":l("DISCTOTAL",p.toString());break;case"images":{if(!r)break;for(let y of p){let b=y.kind==="coverFront"?3:y.kind==="coverBack"?4:0,T=new Uint8Array(y.mimeType.length);for(let M=0;M<y.mimeType.length;M++)T[M]=y.mimeType.charCodeAt(M);let v=fe.encode(y.description??""),P=new Uint8Array(8+T.length+4+v.length+16+4+y.data.length),A=ee(P);A.setUint32(0,b,!1),A.setUint32(4,T.length,!1),P.set(T,8),A.setUint32(8+T.length,v.length,!1),P.set(v,12+T.length),A.setUint32(28+T.length+v.length,y.data.length,!1),P.set(y.data,32+T.length+v.length);let I=uc(P);l("METADATA_BLOCK_PICTURE",I)}}break;case"raw":break;default:Me(w)}if(t.raw)for(let w in t.raw){let p=t.raw[w]??t.raw[w.toLowerCase()];w==="vendor"||p==null||c.has(w)||typeof p=="string"&&l(w,p)}let u=new Uint8Array(4);ee(u).setUint32(0,c.size,!0),i.splice(2,0,u);let h=i.reduce((w,p)=>w+p.length,0),f=new Uint8Array(h),g=0;for(let w of i)f.set(w,g),g+=w.length;return f},Zt=class{constructor(e){this.input=e}},Ba=class{static supports(e,t){return!1}},Ma=class{static supports(e,t){return!1}},Fa=class{static supports(e,t){return!1}},za=class{static supports(e,t){return!1}},ni=[],oi=[],Mr=[],Fr=[],Dc=e=>{if(e.prototype instanceof Ba){let t=e;if(ni.includes(t)){console.warn("Video decoder already registered.");return}ni.push(t)}else if(e.prototype instanceof Ma){let t=e;if(oi.includes(t)){console.warn("Audio decoder already registered.");return}oi.push(t)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Oc=e=>{if(e.prototype instanceof Fa){let t=e;if(Mr.includes(t)){console.warn("Video encoder already registered.");return}Mr.push(t)}else if(e.prototype instanceof za){let t=e;if(Fr.includes(t)){console.warn("Audio encoder already registered.");return}Fr.push(t)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")},Ge=new Uint8Array(0),pe=class Ys{constructor(t,r,i,s,a=-1,n,o){if(this.data=t,this.type=r,this.timestamp=i,this.duration=s,this.sequenceNumber=a,t===Ge&&n===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(n===void 0&&(n=t.byteLength),!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(r!=="key"&&r!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(i))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(s)||s<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(n)||n<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=n,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===Ge}get microsecondTimestamp(){return Math.trunc(zt*this.timestamp)}get microsecondDuration(){return Math.trunc(zt*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(t=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:t,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(t,r){if(!(t instanceof EncodedVideoChunk||t instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let i=new Uint8Array(t.byteLength);return t.copyTo(i),new Ys(i,t.type,t.timestamp/1e6,(t.duration??0)/1e6,void 0,void 0,r)}clone(t){if(t!==void 0&&(typeof t!="object"||t===null))throw new TypeError("options, when provided, must be an object.");if(t?.timestamp!==void 0&&!Number.isFinite(t.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&!Number.isFinite(t.duration))throw new TypeError("options.duration, when provided, must be a number.");return new Ys(this.data,this.type,t?.timestamp??this.timestamp,t?.duration??this.duration,this.sequenceNumber,this.byteLength)}},Nc=e=>{let i=e,s=4096,a=0,n=12,o=0;for(i<0&&(i=-i,a=128),i+=33,i>8191&&(i=8191);(i&s)!==s&&n>=5;)s>>=1,n--;return o=i>>n-4&15,~(a|n-5<<4|o)&255},Uc=e=>{let r=0,i=0,s=~e;s&128&&(s&=-129,r=-1),i=((s&240)>>4)+5;let a=(1<<i|(s&15)<<i-4|1<<i-5)-33;return r===0?a:-a},Lc=e=>{let r=2048,i=0,s=11,a=0,n=e;for(n<0&&(n=-n,i=128),n>4095&&(n=4095);(n&r)!==r&&s>=5;)r>>=1,s--;return a=n>>(s===4?1:s-4)&15,(i|s-4<<4|a)^85},Vc=e=>{let t=0,r=0,i=e^85;i&128&&(i&=-129,t=-1),r=((i&240)>>4)+4;let s=0;return r!==4?s=1<<r|(i&15)<<r-4|1<<r-5:s=i<<1|1,t===0?s:-s};oa();var je=class jr{constructor(t,r){if(this._closed=!1,t instanceof ArrayBuffer||ArrayBuffer.isView(t)){if(!r||typeof r!="object")throw new TypeError("init must be an object.");if(!("format"in r)||typeof r.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(r.codedWidth)||r.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(r.codedHeight)||r.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(r.timestamp))throw new TypeError("init.timestamp must be a number.");if(r.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=le(t).slice(),this.format=r.format,this.codedWidth=r.codedWidth,this.codedHeight=r.codedHeight,this.rotation=r.rotation??0,this.timestamp=r.timestamp,this.duration=r.duration??0,this.colorSpace=new VideoColorSpace(r.colorSpace)}else if(typeof VideoFrame<"u"&&t instanceof VideoFrame){if(r?.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(r?.timestamp!==void 0&&!Number.isFinite(r?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(r?.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=t,this.format=t.format,this.codedWidth=t.displayWidth,this.codedHeight=t.displayHeight,this.rotation=r?.rotation??0,this.timestamp=r?.timestamp??t.timestamp/1e6,this.duration=r?.duration??(t.duration??0)/1e6,this.colorSpace=t.colorSpace}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof SVGImageElement<"u"&&t instanceof SVGImageElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas){if(!r||typeof r!="object")throw new TypeError("init must be an object.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(r.timestamp))throw new TypeError("init.timestamp must be a number.");if(r.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new jr(new VideoFrame(t,{timestamp:Math.trunc(r.timestamp*zt),duration:Math.trunc((r.duration??0)*zt)||void 0}),r);let i=0,s=0;if("naturalWidth"in t?(i=t.naturalWidth,s=t.naturalHeight):"videoWidth"in t?(i=t.videoWidth,s=t.videoHeight):"width"in t&&(i=Number(t.width),s=Number(t.height)),!i||!s)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(i,s),n=a.getContext("2d",{alpha:Ar(),willReadFrequently:!0});d(n),n.drawImage(t,0,0),this._data=a,this.format="RGBX",this.codedWidth=i,this.codedHeight=s,this.rotation=r.rotation??0,this.timestamp=r.timestamp,this.duration=r.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(zt*this.timestamp)}get microsecondDuration(){return Math.trunc(zt*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}clone(){if(this._closed)throw new Error("VideoSample is closed.");return d(this._data!==null),zr(this._data)?new jr(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new jr(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new jr(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(zr(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return d(this._data!==null),zr(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(t){if(!Kt(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(d(this._data!==null),zr(this._data))await this._data.copyTo(t);else if(this._data instanceof Uint8Array)le(t).set(this._data);else{let i=this._data.getContext("2d");d(i);let s=i.getImageData(0,0,this.codedWidth,this.codedHeight);le(t).set(s.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return d(this._data!==null),zr(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(t,r,i,s,a,n,o,c,l){let u=0,h=0,f=this.displayWidth,g=this.displayHeight,w=0,p=0,y=this.displayWidth,b=this.displayHeight;if(n!==void 0?(u=r,h=i,f=s,g=a,w=n,p=o,c!==void 0?(y=c,b=l):(y=f,b=g)):(w=r,p=i,s!==void 0&&(y=s,b=a)),!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(u))throw new TypeError("sx must be a number.");if(!Number.isFinite(h))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(g)||g<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(w))throw new TypeError("dx must be a number.");if(!Number.isFinite(p))throw new TypeError("dy must be a number.");if(!Number.isFinite(y)||y<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(b)||b<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:u,sy:h,sWidth:f,sHeight:g}=this._rotateSourceRegion(u,h,f,g,this.rotation));let T=this.toCanvasImageSource();t.save();let v=w+y/2,P=p+b/2;t.translate(v,P),t.rotate(this.rotation*Math.PI/180);let A=this.rotation%180===0?1:y/b;t.scale(1/A,A),t.drawImage(T,u,h,f,g,-y/2,-b/2,y,b),t.restore()}drawWithFit(t,r){if(!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(r.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");r.crop!==void 0&&Wi(r.crop,"options.");let i=t.canvas.width,s=t.canvas.height,a=r.rotation??this.rotation,[n,o]=a%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];r.crop&&Vi(r.crop,n,o);let c,l,u,h,{sx:f,sy:g,sWidth:w,sHeight:p}=this._rotateSourceRegion(r.crop?.left??0,r.crop?.top??0,r.crop?.width??n,r.crop?.height??o,a);if(r.fit==="fill")c=0,l=0,u=i,h=s;else{let[b,T]=r.crop?[r.crop.width,r.crop.height]:[n,o],v=r.fit==="contain"?Math.min(i/b,s/T):Math.max(i/b,s/T);u=b*v,h=T*v,c=(i-u)/2,l=(s-h)/2}let y=a%180===0?1:u/h;t.translate(i/2,s/2),t.rotate(a*Math.PI/180),t.scale(1/y,y),t.translate(-i/2,-s/2),t.drawImage(this.toCanvasImageSource(),f,g,w,p,c,l,u,h)}_rotateSourceRegion(t,r,i,s,a){return a===90?[t,r,i,s]=[r,this.codedHeight-t-i,s,i]:a===180?[t,r]=[this.codedWidth-t-i,this.codedHeight-r-s]:a===270&&([t,r,i,s]=[this.codedWidth-r-s,t,s,i]),{sx:t,sy:r,sWidth:i,sHeight:s}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(d(this._data!==null),this._data instanceof Uint8Array){let t=this.toVideoFrame();return queueMicrotask(()=>t.close()),t}else return this._data}setRotation(t){if(![0,90,180,270].includes(t))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}setDuration(t){if(!Number.isFinite(t)||t<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=t}[Symbol.dispose](){this.close()}},zr=e=>typeof VideoFrame<"u"&&e instanceof VideoFrame,Vi=(e,t,r)=>{e.left=Math.min(e.left,t),e.top=Math.min(e.top,r),e.width=Math.min(e.width,t-e.left),e.height=Math.min(e.height,r-e.top),d(e.width>=0),d(e.height>=0)},Wi=(e,t)=>{if(!e||typeof e!="object")throw new TypeError(t+"crop, when provided, must be an object.");if(!Number.isInteger(e.left)||e.left<0)throw new TypeError(t+"crop.left must be a non-negative integer.");if(!Number.isInteger(e.top)||e.top<0)throw new TypeError(t+"crop.top must be a non-negative integer.");if(!Number.isInteger(e.width)||e.width<0)throw new TypeError(t+"crop.width must be a non-negative integer.");if(!Number.isInteger(e.height)||e.height<0)throw new TypeError(t+"crop.height must be a non-negative integer.")},Hi=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),dt=class Qr{constructor(t){if(this._closed=!1,Dr(t)){if(t.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=t,this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=t.numberOfFrames,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp/1e6,this.duration=t.numberOfFrames/t.sampleRate}else{if(!t||typeof t!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!Hi.has(t.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(t.sampleRate)||t.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(t.numberOfChannels)||t.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp must be a number.");let r=t.data.byteLength/(Rr(t.format)*t.numberOfChannels);if(!Number.isInteger(r))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=r,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp,this.duration=r/t.sampleRate;let i;if(t.data instanceof ArrayBuffer)i=new Uint8Array(t.data);else if(ArrayBuffer.isView(t.data))i=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let s=this.numberOfFrames*this.numberOfChannels*Rr(this.format);if(i.byteLength<s)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=i}}get microsecondTimestamp(){return Math.trunc(zt*this.timestamp)}get microsecondDuration(){return Math.trunc(zt*this.duration)}allocationSize(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!Hi.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let r=t.format??this.format,i=t.frameOffset??0;if(i>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let s=t.frameCount!==void 0?t.frameCount:this.numberOfFrames-i;if(s>this.numberOfFrames-i)throw new RangeError("frameCount out of range");let a=Rr(r),n=ci(r);if(n&&t.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!n&&t.planeIndex!==0)throw new RangeError("planeIndex out of range");return(n?s:s*this.numberOfChannels)*a}copyTo(t,r){if(!Kt(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(r.planeIndex)||r.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(r.format!==void 0&&!Hi.has(r.format))throw new TypeError("Invalid format.");if(r.frameOffset!==void 0&&(!Number.isInteger(r.frameOffset)||r.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(r.frameCount!==void 0&&(!Number.isInteger(r.frameCount)||r.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:i,format:s,frameCount:a,frameOffset:n}=r,o=s??this.format;if(!o)throw new Error("Destination format not determined");let c=this.numberOfFrames,l=this.numberOfChannels,u=n??0;if(u>=c)throw new RangeError("frameOffset out of range");let h=a!==void 0?a:c-u;if(h>c-u)throw new RangeError("frameCount out of range");let f=Rr(o),g=ci(o);if(g&&i>=l)throw new RangeError("planeIndex out of range");if(!g&&i!==0)throw new RangeError("planeIndex out of range");let p=(g?h:h*l)*f;if(t.byteLength<p)throw new RangeError("Destination buffer is too small");let y=ee(t),b=Hc(o);if(Dr(this._data))if(g)if(o==="f32-planar")this._data.copyTo(t,{planeIndex:i,frameOffset:u,frameCount:h,format:"f32-planar"});else{let T=new ArrayBuffer(h*4),v=new Float32Array(T);this._data.copyTo(v,{planeIndex:i,frameOffset:u,frameCount:h,format:"f32-planar"});let P=new DataView(T);for(let A=0;A<h;A++){let I=A*f,M=P.getFloat32(A*4,!0);b(y,I,M)}}else{let T=l,v=new Float32Array(h);for(let P=0;P<T;P++){this._data.copyTo(v,{planeIndex:P,frameOffset:u,frameCount:h,format:"f32-planar"});for(let A=0;A<h;A++){let M=(A*T+P)*f;b(y,M,v[A])}}}else{let T=this._data,v=new DataView(T.buffer,T.byteOffset,T.byteLength),P=this.format,A=Wc(P),I=Rr(P),M=ci(P);for(let L=0;L<h;L++)if(g){let ue=L*f,K;M?K=(i*c+(L+u))*I:K=((L+u)*l+i)*I;let V=A(v,K);b(y,ue,V)}else for(let ue=0;ue<l;ue++){let V=(L*l+ue)*f,J;M?J=(ue*c+(L+u))*I:J=((L+u)*l+ue)*I;let de=A(v,J);b(y,V,de)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(Dr(this._data)){let t=new Qr(this._data.clone());return t.setTimestamp(this.timestamp),t}else return new Qr({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(Dr(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(Dr(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(ci(this.format)){let t=this.allocationSize({planeIndex:0,format:this.format}),r=new ArrayBuffer(t*this.numberOfChannels);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(new Uint8Array(r,i*t,t),{planeIndex:i,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:r})}else{let t=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(t,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let t=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),r=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(r,{planeIndex:i,format:"f32-planar"}),t.copyToChannel(r,i);return t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}[Symbol.dispose](){this.close()}static*_fromAudioBuffer(t,r){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let i=48e3*5,s=t.numberOfChannels,a=t.sampleRate,n=t.length,o=Math.floor(i/s),c=0,l=n;for(;l>0;){let u=Math.min(o,l),h=new Float32Array(s*u);for(let f=0;f<s;f++)t.copyFromChannel(h.subarray(f*u,(f+1)*u),f,c);yield new Qr({format:"f32-planar",sampleRate:a,numberOfFrames:u,numberOfChannels:s,timestamp:r+c/a,data:h}),c+=u,l-=u}}static fromAudioBuffer(t,r){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let i=48e3*5,s=t.numberOfChannels,a=t.sampleRate,n=t.length,o=Math.floor(i/s),c=0,l=n,u=[];for(;l>0;){let h=Math.min(o,l),f=new Float32Array(s*h);for(let w=0;w<s;w++)t.copyFromChannel(f.subarray(w*h,(w+1)*h),w,c);let g=new Qr({format:"f32-planar",sampleRate:a,numberOfFrames:h,numberOfChannels:s,timestamp:r+c/a,data:f});u.push(g),c+=h,l-=h}return u}},Rr=e=>{switch(e){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},ci=e=>{switch(e){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},Wc=e=>{switch(e){case"u8":case"u8-planar":return(t,r)=>(t.getUint8(r)-128)/128;case"s16":case"s16-planar":return(t,r)=>t.getInt16(r,!0)/32768;case"s32":case"s32-planar":return(t,r)=>t.getInt32(r,!0)/2147483648;case"f32":case"f32-planar":return(t,r)=>t.getFloat32(r,!0)}},Hc=e=>{switch(e){case"u8":case"u8-planar":return(t,r,i)=>t.setUint8(r,_e((i+1)*127.5,0,255));case"s16":case"s16-planar":return(t,r,i)=>t.setInt16(r,_e(Math.round(i*32767),-32768,32767),!0);case"s32":case"s32-planar":return(t,r,i)=>t.setInt32(r,_e(Math.round(i*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(t,r,i)=>t.setFloat32(r,i,!0)}},Dr=e=>typeof AudioData<"u"&&e instanceof AudioData,hr=e=>{if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.metadataOnly!==void 0&&typeof e.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(e.verifyKeyPackets!==void 0&&typeof e.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(e.verifyKeyPackets&&e.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},St=e=>{if(!lr(e))throw new TypeError("timestamp must be a number.")},qi=(e,t,r)=>r.verifyKeyPackets?t.then(async i=>{if(!i||i.type==="delta")return i;let s=await e.determinePacketType(i);return s&&(i.type=s),i}):t,fr=class{constructor(e){if(!(e instanceof di))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){if(hr(e),this._track.input._disposed)throw new Ue;return qi(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){if(St(e),hr(t),this._track.input._disposed)throw new Ue;return qi(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof pe))throw new TypeError("packet must be an EncodedPacket.");if(hr(t),this._track.input._disposed)throw new Ue;return qi(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(St(e),hr(t),this._track.input._disposed)throw new Ue;if(!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);let r=await this._track._backing.getKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,t):r}async getNextKeyPacket(e,t={}){if(!(e instanceof pe))throw new TypeError("packet must be an EncodedPacket.");if(hr(t),this._track.input._disposed)throw new Ue;if(!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);let r=await this._track._backing.getNextKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,t):r}packets(e,t,r={}){if(e!==void 0&&!(e instanceof pe))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof pe))throw new TypeError("endPacket must be an EncodedPacket.");if(hr(r),this._track.input._disposed)throw new Ue;let i=[],{promise:s,resolve:a}=we(),{promise:n,resolve:o}=we(),c=!1,l=!1,u=null,h=[],f=()=>Math.max(2,h.length);(async()=>{let w=e??await this.getFirstPacket(r);for(;w&&!l&&!this._track.input._disposed&&!(t&&w.sequenceNumber>=t?.sequenceNumber);){if(i.length>f()){({promise:n,resolve:o}=we()),await n;continue}i.push(w),a(),{promise:s,resolve:a}=we(),w=await this.getNextPacket(w,r)}c=!0,a()})().catch(w=>{u||(u=w,a())});let g=this._track;return{async next(){for(;;){if(g.input._disposed)throw new Ue;if(l)return{value:void 0,done:!0};if(u)throw u;if(i.length>0){let w=i.shift(),p=performance.now();for(h.push(p);h.length>0&&p-h[0]>=1e3;)h.shift();return o(),{value:w,done:!1}}else{if(c)return{value:void 0,done:!0};await s}}},async return(){return l=!0,o(),a(),{value:void 0,done:!0}},async throw(w){throw w},[Symbol.asyncIterator](){return this}}}},$i=class{constructor(e,t){this.onSample=e,this.onError=t}},ji=class{mediaSamplesInRange(e=0,t=1/0){St(e),St(t);let r=[],i=!1,s=null,{promise:a,resolve:n}=we(),{promise:o,resolve:c}=we(),l=!1,u=!1,h=!1,f=null;(async()=>{let p=new Error,y=await this._createDecoder(I=>{if(c(),I.timestamp>=t&&(u=!0),u){I.close();return}s&&(I.timestamp>e?(r.push(s),i=!0):s.close()),I.timestamp>=e&&(r.push(I),i=!0),s=i?null:I,r.length>0&&(n(),{promise:a,resolve:n}=we())},I=>{f||(I.stack=p.stack,f=I,n())}),b=this._createPacketSink(),T=await b.getKeyPacket(e,{verifyKeyPackets:!0})??await b.getFirstPacket();if(!T)return;let v=T,P;if(t<1/0){let I=await b.getPacket(t),M=I?I.type==="key"&&I.timestamp===t?I:await b.getNextKeyPacket(I,{verifyKeyPackets:!0}):null;M&&(P=M)}let A=b.packets(T,P);for(await A.next();v&&!u&&!this._track.input._disposed;){let I=Ra(r.length);if(r.length+y.getDecodeQueueSize()>I){({promise:o,resolve:c}=we()),await o;continue}y.decode(v);let M=await A.next();if(M.done)break;v=M.value}await A.return(),!h&&!this._track.input._disposed&&await y.flush(),y.close(),!i&&s&&r.push(s),l=!0,n()})().catch(p=>{f||(f=p,n())});let g=this._track,w=()=>{s?.close();for(let p of r)p.close()};return{async next(){for(;;){if(g.input._disposed)throw w(),new Ue;if(h)return{value:void 0,done:!0};if(f)throw w(),f;if(r.length>0){let p=r.shift();return c(),{value:p,done:!1}}else if(!l)await a;else return{value:void 0,done:!0}}},async return(){return h=!0,u=!0,c(),n(),w(),{value:void 0,done:!0}},async throw(p){throw p},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){tc(e);let t=ec(e),r=[],i=[],{promise:s,resolve:a}=we(),{promise:n,resolve:o}=we(),c=!1,l=!1,u=null,h=w=>{i.push(w),a(),{promise:s,resolve:a}=we()};(async()=>{let w=new Error,p=await this._createDecoder(I=>{if(o(),l){I.close();return}let M=0;for(;r.length>0&&I.timestamp-r[0]>-1e-10;)M++,r.shift();if(M>0)for(let L=0;L<M;L++)h(L<M-1?I.clone():I);else I.close()},I=>{u||(I.stack=w.stack,u=I,a())}),y=this._createPacketSink(),b=null,T=null,v=-1,P=async()=>{d(T);let I=T;for(p.decode(I);I.sequenceNumber<v;){let M=Ra(i.length);for(;i.length+p.getDecodeQueueSize()>M&&!l;)({promise:n,resolve:o}=we()),await n;if(l)break;let L=await y.getNextPacket(I);d(L),p.decode(L),I=L}v=-1},A=async()=>{await p.flush();for(let I=0;I<r.length;I++)h(null);r.length=0};for await(let I of t){if(St(I),l||this._track.input._disposed)break;let M=await y.getPacket(I),L=M&&await y.getKeyPacket(I,{verifyKeyPackets:!0});if(!L){v!==-1&&(await P(),await A()),h(null),b=null;continue}b&&(L.sequenceNumber!==T.sequenceNumber||M.timestamp<b.timestamp)&&(await P(),await A()),r.push(M.timestamp),v=Math.max(M.sequenceNumber,v),b=M,T=L}!l&&!this._track.input._disposed&&(v!==-1&&await P(),await A()),p.close(),c=!0,a()})().catch(w=>{u||(u=w,a())});let f=this._track,g=()=>{for(let w of i)w?.close()};return{async next(){for(;;){if(f.input._disposed)throw g(),new Ue;if(l)return{value:void 0,done:!0};if(u)throw g(),u;if(i.length>0){let w=i.shift();return d(w!==void 0),o(),{value:w,done:!1}}else if(!c)await s;else return{value:void 0,done:!0}}},async return(){return l=!0,o(),a(),g(),{value:void 0,done:!0}},async throw(w){throw w},[Symbol.asyncIterator](){return this}}}},Ra=e=>e===0?40:8,qc=class extends $i{constructor(e,t,r,i,s,a){super(e,t),this.codec=r,this.decoderConfig=i,this.rotation=s,this.timeResolution=a,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new ei,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[],this.currentPacketIndex=0,this.raslSkipped=!1,this.alphaDecoder=null,this.alphaHadKeyframe=!1,this.colorQueue=[],this.alphaQueue=[],this.merger=null,this.mergerCreationFailed=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue=[],this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1;let n=ni.find(o=>o.supports(r,i));if(n)this.customDecoder=new n,this.customDecoder.codec=r,this.customDecoder.config=i,this.customDecoder.onSample=o=>{if(!(o instanceof je))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(o)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let o=c=>{if(this.alphaQueue.length>0){let l=this.alphaQueue.shift();d(l!==void 0),this.mergeAlpha(c,l)}else this.colorQueue.push(c)};this.decoder=new VideoDecoder({output:c=>{try{o(c)}catch(l){this.onError(l)}},error:t}),this.decoder.configure(i)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(d(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}this.currentPacketIndex++,this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(d(this.decoder),Fi()||ea(this.inputTimestamps,e.timestamp,t=>t),this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e))}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new $c}catch(r){console.error("Due to an error, only color data will be decoded.",r),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){let r=i=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){let s=this.colorQueue.shift();d(s!==void 0),this.mergeAlpha(s,i)}else this.alphaQueue.push(i);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){let s=this.colorQueue.shift();d(s!==void 0),this.mergeAlpha(s,null)}else this.alphaQueue.push(null)};this.alphaDecoder=new VideoDecoder({output:i=>{try{r(i)}catch(s){this.onError(s)}},error:this.onError}),this.alphaDecoder.configure(this.decoderConfig)}let t=Aa(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=t==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(t??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){return va(e,this.decoderConfig).some(r=>{let i=Dt(r);return i===8||i===9})}sampleHandler(e){if(Fi()){if(this.sampleQueue.length>0&&e.timestamp>=ce(this.sampleQueue).timestamp){for(let t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}ea(this.sampleQueue,e,t=>t.timestamp)}else{let t=this.inputTimestamps.shift();d(t!==void 0),e.setTimestamp(t),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,t){if(!t){let s=new je(e);this.sampleHandler(s);return}d(this.merger),this.merger.update(e,t),e.close(),t.close();let r=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),i=new je(r);this.sampleHandler(i)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(d(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),Fi()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(d(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(let e of this.sampleQueue)e.close();this.sampleQueue.length=0}},$c=class{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");let e=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=e,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){let e=this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n			in vec2 a_position;\n			in vec2 a_texCoord;\n			out vec2 v_texCoord;\n			\n			void main() {\n				gl_Position = vec4(a_position, 0.0, 1.0);\n				v_texCoord = a_texCoord;\n			}\n		"),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_colorTexture;\n			uniform sampler2D u_alphaTexture;\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n			\n			void main() {\n				vec3 color = texture(u_colorTexture, v_texCoord).rgb;\n				float alpha = texture(u_alphaTexture, v_texCoord).r;\n				fragColor = vec4(color, alpha);\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.program,"a_position"),s=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}update(e,t){(e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},li=class extends ji{constructor(e){if(!(e instanceof mr))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,i=this._track.rotation,s=await this._track.getDecoderConfig(),a=this._track.timeResolution;return d(r&&s),new qc(e,t,r,s,i,a)}_createPacketSink(){return new fr(this._track)}async getSample(e){St(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},Da=class{constructor(e,t={}){if(this._nextCanvasIndex=0,!(e instanceof mr))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.alpha!==void 0&&typeof t.alpha!="boolean")throw new TypeError("options.alpha, when provided, must be a boolean.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.crop!==void 0&&Wi(t.crop,"options."),t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=t.rotation??e.rotation,[i,s]=r%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],a=t.crop;a&&Vi(a,i,s);let[n,o]=a?[a.width,a.height]:[i,s],c=n/o;t.width!==void 0&&t.height===void 0?(n=t.width,o=Math.round(n/c)):t.width===void 0&&t.height!==void 0?(o=t.height,n=Math.round(o*c)):t.width!==void 0&&t.height!==void 0&&(n=t.width,o=t.height),this._videoTrack=e,this._alpha=t.alpha??!1,this._width=n,this._height=o,this._rotation=r,this._crop=a,this._fit=t.fit??"fill",this._videoSampleSink=new li(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex],r=!1;t||(typeof document<"u"?(t=document.createElement("canvas"),t.width=this._width,t.height=this._height):t=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let i=t.getContext("2d",{alpha:this._alpha||Ar()});d(i),i.resetTransform(),r||(!this._alpha&&Ar()?(i.fillStyle="black",i.fillRect(0,0,this._width,this._height)):i.clearRect(0,0,this._width,this._height)),e.drawWithFit(i,{fit:this._fit,rotation:this._rotation,crop:this._crop});let s={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),s}async getCanvas(e){St(e);let t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return Zr(this._videoSampleSink.samples(e,t),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(e){return Zr(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}},jc=class extends $i{constructor(e,t,r,i){super(e,t),this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new ei,this.customDecoderQueueSize=0,this.currentTimestamp=null;let s=n=>{(this.currentTimestamp===null||Math.abs(n.timestamp-this.currentTimestamp)>=n.duration)&&(this.currentTimestamp=n.timestamp);let o=this.currentTimestamp;if(this.currentTimestamp+=n.duration,n.numberOfFrames===0){n.close();return}let c=i.sampleRate;n.setTimestamp(Math.round(o*c)/c),e(n)},a=oi.find(n=>n.supports(r,i));a?(this.customDecoder=new a,this.customDecoder.codec=r,this.customDecoder.config=i,this.customDecoder.onSample=n=>{if(!(n instanceof dt))throw new TypeError("The argument passed to onSample must be an AudioSample.");s(n)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:n=>{try{s(new dt(n))}catch(o){this.onError(o)}},error:t}),this.decoder.configure(i))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(d(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(d(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(d(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(d(this.decoder),this.decoder.close())}},Qc=class extends $i{constructor(e,t,r){super(e,t),this.decoderConfig=r,this.currentTimestamp=null,d(Te.includes(r.codec)),this.codec=r.codec;let{dataType:i,sampleSize:s,littleEndian:a}=ut(this.codec);switch(this.inputSampleSize=s,s){case 1:i==="unsigned"?this.readInputValue=(n,o)=>n.getUint8(o)-2**7:i==="signed"?this.readInputValue=(n,o)=>n.getInt8(o):i==="ulaw"?this.readInputValue=(n,o)=>Uc(n.getUint8(o)):i==="alaw"?this.readInputValue=(n,o)=>Vc(n.getUint8(o)):d(!1);break;case 2:i==="unsigned"?this.readInputValue=(n,o)=>n.getUint16(o,a)-2**15:i==="signed"?this.readInputValue=(n,o)=>n.getInt16(o,a):d(!1);break;case 3:i==="unsigned"?this.readInputValue=(n,o)=>Yr(n,o,a)-2**23:i==="signed"?this.readInputValue=(n,o)=>rc(n,o,a):d(!1);break;case 4:i==="unsigned"?this.readInputValue=(n,o)=>n.getUint32(o,a)-2**31:i==="signed"?this.readInputValue=(n,o)=>n.getInt32(o,a):i==="float"?this.readInputValue=(n,o)=>n.getFloat32(o,a):d(!1);break;case 8:i==="float"?this.readInputValue=(n,o)=>n.getFloat64(o,a):d(!1);break;default:Me(s),d(!1)}switch(s){case 1:i==="ulaw"||i==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(n,o,c)=>n.setInt16(o,c,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(n,o,c)=>n.setUint8(o,c+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(n,o,c)=>n.setInt16(o,c,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(n,o,c)=>n.setInt32(o,c<<8,!0);break;case 4:this.outputSampleSize=4,i==="float"?(this.outputFormat="f32",this.writeOutputValue=(n,o,c)=>n.setFloat32(o,c,!0)):(this.outputFormat="s32",this.writeOutputValue=(n,o,c)=>n.setInt32(o,c,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(n,o,c)=>n.setFloat32(o,c,!0);break;default:Me(s),d(!1)}}getDecodeQueueSize(){return 0}decode(e){let t=ee(e.data),r=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,i=r*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(i),a=new DataView(s);for(let l=0;l<r*this.decoderConfig.numberOfChannels;l++){let u=l*this.inputSampleSize,h=l*this.outputSampleSize,f=this.readInputValue(t,u);this.writeOutputValue(a,h,f)}let n=r/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=n)&&(this.currentTimestamp=e.timestamp);let o=this.currentTimestamp;this.currentTimestamp+=n;let c=new dt({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:r,timestamp:o});this.onSample(c)}async flush(){}close(){}},ui=class extends ji{constructor(e){if(!(e instanceof rt))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,i=await this._track.getDecoderConfig();return d(r&&i),Te.includes(i.codec)?new Qc(e,t,i):new jc(e,t,r,i)}_createPacketSink(){return new fr(this._track)}async getSample(e){St(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},Kc=class{constructor(e){if(!(e instanceof rt))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new ui(e)}_audioSampleToWrappedArrayBuffer(e){return{buffer:e.toAudioBuffer(),timestamp:e.timestamp,duration:e.duration}}async getBuffer(e){St(e);let t=await this._audioSampleSink.getSample(e);return t&&this._audioSampleToWrappedArrayBuffer(t)}buffers(e=0,t=1/0){return Zr(this._audioSampleSink.samples(e,t),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(e){return Zr(this._audioSampleSink.samplesAtTimestamps(e),t=>t&&this._audioSampleToWrappedArrayBuffer(t))}},di=class{constructor(e,t){this.input=e,this._backing=t}isVideoTrack(){return this instanceof mr}isAudioTrack(){return this instanceof rt}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){let t=new fr(this),r=1/0,i=-1/0,s=0,a=0;for await(let n of t.packets(void 0,void 0,{metadataOnly:!0})){if(s>=e&&n.timestamp>=i)break;r=Math.min(r,n.timestamp),i=Math.max(i,n.timestamp+n.duration),s++,a+=n.byteLength}return{packetCount:s,averagePacketRate:s?Number((s/(i-r)).toPrecision(16)):0,averageBitrate:s?Number((8*a/(i-r)).toPrecision(16)):0}}},mr=class extends di{constructor(e,t){super(e,t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return d(t!==null),ni.some(i=>i.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof pe))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;let t=await this.getDecoderConfig();return d(t),Aa(this.codec,t,e.data)}},rt=class extends di{constructor(e,t){super(e,t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return d(t!==null),oi.some(r=>r.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof pe))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}},Oa=e=>{let r=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isQuickTime?"quicktime":"mp4");if(e.codecStrings.length>0){let i=[...new Set(e.codecStrings)];r+='; codecs="'.concat(i.join(", "),'"')}return r},vt=8,Jt=16,Ot=e=>{let t=D(e),r=Ce(e,4),i=8;t===1&&(t=at(e),i=16);let a=t-i;return a<0?null:{name:r,totalSize:t,headerSize:i,contentSize:a}},er=e=>rr(e)/65536,Qi=e=>rr(e)/1073741824,Ki=e=>{let t=0;for(let r=0;r<4;r++){t<<=7;let i=H(e);if(t|=i&127,(i&128)===0)break}return t},ht=e=>{let t=Pe(e);return e.skip(2),t=Math.min(t,e.remainingLength),Se.decode(Q(e,t))},Gc=e=>{let t=Ot(e);if(!t||t.name!=="data"||e.remainingLength<8)return null;let r=D(e);e.skip(4);let i=Q(e,t.contentSize-8);switch(r){case 1:return Se.decode(i);case 2:return new TextDecoder("utf-16be").decode(i);case 13:return new Gt(i,"image/jpeg");case 14:return new Gt(i,"image/png");case 27:return new Gt(i,"image/bmp");default:return i}},Xc=class extends Zt{constructor(e){super(e),this.moovSlice=null,this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.metadataTags={},this.currentMetadataKeys=null,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.currentFragment=null,this.lastReadFragment=null,this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(t=>t.inputTrack.getCodecParameterString()));return Oa({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(t=>t.info?.type==="video"),hasAudio:this.tracks.some(t=>t.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,vt,Jt);if(t instanceof Promise&&(t=await t),!t)break;let r=e,i=Ot(t);if(!i)break;if(i.name==="ftyp"){let s=Ce(t,4);this.isQuickTime=s==="qt  "}else if(i.name==="moov"){let s=this.reader.requestSlice(t.filePos,i.contentSize);if(s instanceof Promise&&(s=await s),!s)break;this.moovSlice=s,this.readContiguousBoxes(this.moovSlice);for(let a of this.tracks){let n=a.editListPreviousSegmentDurations/this.movieTimescale;a.editListOffset-=Math.round(n*a.timescale)}break}e=r+i.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let t=this.reader.requestSlice(this.reader.fileSize-4,4);t instanceof Promise&&(t=await t),d(t);let r=D(t),i=this.reader.fileSize-r;if(i>=0&&i<=this.reader.fileSize-Jt){let s=this.reader.requestSliceRange(i,vt,Jt);if(s instanceof Promise&&(s=await s),s){let a=Ot(s);if(a&&a.name==="mfra"){let n=this.reader.requestSlice(s.filePos,a.contentSize);n instanceof Promise&&(n=await n),n&&this.readContiguousBoxes(n)}}}}})())}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=t,d(this.moovSlice);let r=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(r),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&Te.includes(e.info.codec)&&t.sampleCompositionTimeOffsets.length===0){d(e.info?.type==="audio");let s=ut(e.info.codec),a=[],n=[];for(let o=0;o<t.sampleToChunk.length;o++){let c=t.sampleToChunk[o],l=t.sampleToChunk[o+1],u=(l?l.startChunkIndex:t.chunkOffsets.length)-c.startChunkIndex;for(let h=0;h<u;h++){let f=c.startSampleIndex+h*c.samplesPerChunk,g=f+c.samplesPerChunk,w=oe(t.sampleTimingEntries,f,M=>M.startIndex),p=t.sampleTimingEntries[w],y=oe(t.sampleTimingEntries,g,M=>M.startIndex),b=t.sampleTimingEntries[y],T=p.startDecodeTimestamp+(f-p.startIndex)*p.delta,P=b.startDecodeTimestamp+(g-b.startIndex)*b.delta-T,A=ce(a);A&&A.delta===P?A.count++:a.push({startIndex:c.startChunkIndex+h,startDecodeTimestamp:T,count:1,delta:P});let I=c.samplesPerChunk*s.sampleSize*e.info.numberOfChannels;n.push(I)}c.startSampleIndex=c.startChunkIndex,c.samplesPerChunk=1}t.sampleTimingEntries=a,t.sampleSizes=n}if(t.sampleCompositionTimeOffsets.length>0){t.presentationTimestamps=[];for(let s of t.sampleTimingEntries)for(let a=0;a<s.count;a++)t.presentationTimestamps.push({presentationTimestamp:s.startDecodeTimestamp+a*s.delta,sampleIndex:s.startIndex+a});for(let s of t.sampleCompositionTimeOffsets)for(let a=0;a<s.count;a++){let n=s.startIndex+a,o=t.presentationTimestamps[n];o&&(o.presentationTimestamp+=s.offset)}t.presentationTimestamps.sort((s,a)=>s.presentationTimestamp-a.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let s=0;s<t.presentationTimestamps.length;s++)t.presentationTimestampIndexMap[t.presentationTimestamps[s].sampleIndex]=s}return t}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let t=this.reader.requestSliceRange(e,vt,Jt);t instanceof Promise&&(t=await t),d(t);let r=Ot(t);d(r?.name==="moof");let i=this.reader.requestSlice(e,r.totalSize);i instanceof Promise&&(i=await i),d(i),this.traverseBox(i);let s=this.lastReadFragment;d(s&&s.moofOffset===e);for(let[,a]of s.trackData){let n=a.track,{fragmentPositionCache:o}=n;if(!a.startTimestampIsFinal){let l=n.fragmentLookupTable.find(u=>u.moofOffset===s.moofOffset);if(l)Gi(a,l.timestamp);else{let u=oe(o,s.moofOffset-1,h=>h.moofOffset);if(u!==-1){let h=o[u];Gi(a,h.endTimestamp)}}a.startTimestampIsFinal=!0}let c=oe(o,a.startTimestamp,l=>l.startTimestamp);(c===-1||o[c].moofOffset!==s.moofOffset)&&o.splice(c+1,0,{moofOffset:s.moofOffset,startTimestamp:a.startTimestamp,endTimestamp:a.endTimestamp})}return s}readContiguousBoxes(e){let t=e.filePos;for(;e.filePos-t<=e.length-vt&&this.traverseBox(e););}*iterateContiguousBoxes(e){let t=e.filePos;for(;e.filePos-t<=e.length-vt;){let r=e.filePos,i=Ot(e);if(!i)break;yield{boxInfo:i,slice:e},e.filePos=r+i.totalSize}}traverseBox(e){var a,n,o,c,l,u,h,f,g,w,p,y,b,T,v,P,A,I,M,L,ue,K,V,J,de,We,Et,Ee,Ae,ze,At,gt,qr;let t=e.filePos,r=Ot(e);if(!r)return!1;let i=e.filePos,s=t+r.totalSize;switch(r.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"mvhd":{let m=H(e);e.skip(3),m===1?(e.skip(16),this.movieTimescale=D(e),this.movieDurationInTimescale=at(e)):(e.skip(8),this.movieTimescale=D(e),this.movieDurationInTimescale=D(e))}break;case"trak":{let m={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:$e,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=m,this.readContiguousBoxes(e.slice(i,r.contentSize)),m.id!==-1&&m.timescale!==-1&&m.info!==null){if(m.info.type==="video"&&m.info.width!==-1){let F=m;m.inputTrack=new mr(this.input,new Yc(F)),this.tracks.push(m)}else if(m.info.type==="audio"&&m.info.numberOfChannels!==-1){let F=m;m.inputTrack=new rt(this.input,new Zc(F)),this.tracks.push(m)}}this.currentTrack=null}break;case"tkhd":{let m=this.currentTrack;if(!m)break;let F=H(e);if(!((yr(e)&1)!==0))break;if(F===0)e.skip(8),m.id=D(e),e.skip(4),m.durationInMovieTimescale=D(e);else if(F===1)e.skip(16),m.id=D(e),e.skip(4),m.durationInMovieTimescale=at(e);else throw new Error("Incorrect track header version ".concat(F,"."));e.skip(16);let j=[er(e),er(e),Qi(e),er(e),er(e),Qi(e),er(e),er(e),Qi(e)],R=kt(Bi(rl(j),90));d(R===0||R===90||R===180||R===270),m.rotation=R}break;case"elst":{let m=this.currentTrack;if(!m)break;let F=H(e);e.skip(3);let B=!1,E=0,j=D(e);for(let R=0;R<j;R++){let O=F===1?at(e):D(e),te=F===1?Vl(e):rr(e),Z=er(e);if(O!==0){if(B){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(te===-1){E+=O;continue}if(Z!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}m.editListPreviousSegmentDurations=E,m.editListOffset=te,B=!0}}}break;case"mdhd":{let m=this.currentTrack;if(!m)break;let F=H(e);e.skip(3),F===0?(e.skip(8),m.timescale=D(e),m.durationInMediaTimescale=D(e)):F===1&&(e.skip(16),m.timescale=D(e),m.durationInMediaTimescale=at(e));let B=Pe(e);if(B>0){m.languageCode="";for(let E=0;E<3;E++)m.languageCode=String.fromCharCode(96+(B&31))+m.languageCode,B>>=5;Er(m.languageCode)||(m.languageCode=$e)}}break;case"hdlr":{let m=this.currentTrack;if(!m)break;e.skip(8);let F=Ce(e,4);F==="vide"?m.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:F==="soun"&&(m.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let m=this.currentTrack;if(!m)break;m.sampleTableByteOffset=t,this.readContiguousBoxes(e.slice(i,r.contentSize))}break;case"stsd":{let m=this.currentTrack;if(!m||m.info===null||m.sampleTable)break;let F=H(e);e.skip(3);let B=D(e);for(let E=0;E<B;E++){let j=e.filePos,R=Ot(e);if(!R)break;m.internalCodecId=R.name;let O=R.name.toLowerCase();if(m.info.type==="video")O==="avc1"?m.info.codec="avc":O==="hvc1"||O==="hev1"?m.info.codec="hevc":O==="vp08"?m.info.codec="vp8":O==="vp09"?m.info.codec="vp9":O==="av01"?m.info.codec="av1":console.warn("Unsupported video codec (sample entry type '".concat(R.name,"').")),e.skip(24),m.info.width=Pe(e),m.info.height=Pe(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,j+R.totalSize-e.filePos));else{O==="mp4a"||(O==="opus"?m.info.codec="opus":O==="flac"?m.info.codec="flac":O==="twos"||O==="sowt"||O==="raw "||O==="in24"||O==="in32"||O==="fl32"||O==="fl64"||O==="lpcm"||O==="ipcm"||O==="fpcm"||(O==="ulaw"?m.info.codec="ulaw":O==="alaw"?m.info.codec="alaw":console.warn("Unsupported audio codec (sample entry type '".concat(R.name,"').")))),e.skip(8);let te=Pe(e);e.skip(6);let Z=Pe(e),G=Pe(e);e.skip(4);let be=D(e)/65536;if(F===0&&te>0){if(te===1)e.skip(4),G=8*D(e),e.skip(8);else if(te===2){e.skip(4),be=Rn(e),Z=D(e),e.skip(4),G=D(e);let ke=D(e);if(e.skip(8),O==="lpcm"){let ie=G+7>>3,Ye=!!(ke&1),he=!!(ke&2),Ks=ke&4?-1:0;G>0&&G<=64&&(Ye?G===32&&(m.info.codec=he?"pcm-f32be":"pcm-f32"):Ks&1<<ie-1?ie===1?m.info.codec="pcm-s8":ie===2?m.info.codec=he?"pcm-s16be":"pcm-s16":ie===3?m.info.codec=he?"pcm-s24be":"pcm-s24":ie===4&&(m.info.codec=he?"pcm-s32be":"pcm-s32"):ie===1&&(m.info.codec="pcm-u8")),m.info.codec===null&&console.warn("Unsupported PCM format.")}}}m.info.codec==="opus"&&(be=ur),m.info.numberOfChannels=Z,m.info.sampleRate=be,O==="twos"?G===8?m.info.codec="pcm-s8":G===16?m.info.codec="pcm-s16be":(console.warn("Unsupported sample size ".concat(G," for codec 'twos'.")),m.info.codec=null):O==="sowt"?G===8?m.info.codec="pcm-s8":G===16?m.info.codec="pcm-s16":(console.warn("Unsupported sample size ".concat(G," for codec 'sowt'.")),m.info.codec=null):O==="raw "?m.info.codec="pcm-u8":O==="in24"?m.info.codec="pcm-s24be":O==="in32"?m.info.codec="pcm-s32be":O==="fl32"?m.info.codec="pcm-f32be":O==="fl64"?m.info.codec="pcm-f64be":O==="ipcm"?m.info.codec="pcm-s16be":O==="fpcm"&&(m.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,j+R.totalSize-e.filePos))}}}break;case"avcC":{let m=this.currentTrack;if(!m)break;d(m.info),m.info.codecDescription=Q(e,r.contentSize)}break;case"hvcC":{let m=this.currentTrack;if(!m)break;d(m.info),m.info.codecDescription=Q(e,r.contentSize)}break;case"vpcC":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="video"),e.skip(4);let F=H(e),B=H(e),E=H(e),j=E>>4,R=E>>1&7,O=E&1,te=H(e),Z=H(e),G=H(e);m.info.vp9CodecInfo={profile:F,level:B,bitDepth:j,chromaSubsampling:R,videoFullRangeFlag:O,colourPrimaries:te,transferCharacteristics:Z,matrixCoefficients:G}}break;case"av1C":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="video"),e.skip(1);let F=H(e),B=F>>5,E=F&31,j=H(e),R=j>>7,O=j>>6&1,te=j>>5&1,Z=j>>4&1,G=j>>3&1,be=j>>2&1,ke=j&3,ie=B===2&&O?te?12:10:O?10:8;m.info.av1CodecInfo={profile:B,level:E,tier:R,bitDepth:ie,monochrome:Z,chromaSubsamplingX:G,chromaSubsamplingY:be,chromaSamplePosition:ke}}break;case"colr":{let m=this.currentTrack;if(!m||(d(m.info?.type==="video"),Ce(e,4)!=="nclx"))break;let B=Pe(e),E=Pe(e),j=Pe(e),R=!!(H(e)&128);m.info.colorSpace={primaries:Gr[B],transfer:Ir[E],matrix:Xr[j],fullRange:R}}break;case"wave":this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"esds":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(4);let F=H(e);d(F===3),Ki(e),e.skip(2);let B=H(e),E=(B&128)!==0,j=(B&64)!==0,R=(B&32)!==0;if(E&&e.skip(2),j){let be=H(e);e.skip(be)}R&&e.skip(2);let O=H(e);d(O===4);let te=Ki(e),Z=e.filePos,G=H(e);if(G===64||G===103?(m.info.codec="aac",m.info.aacCodecInfo={isMpeg2:G===103}):G===105||G===107?m.info.codec="mp3":G===221?m.info.codec="vorbis":console.warn("Unsupported audio codec (objectTypeIndication ".concat(G,") - discarding track.")),e.skip(12),te>e.filePos-Z){let be=H(e);d(be===5);let ke=Ki(e);if(m.info.codecDescription=Q(e,ke),m.info.codec==="aac"){let ie=Oi(m.info.codecDescription);ie.numberOfChannels!==null&&(m.info.numberOfChannels=ie.numberOfChannels),ie.sampleRate!==null&&(m.info.sampleRate=ie.sampleRate)}}}break;case"enda":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),Pe(e)&255&&(m.info.codec==="pcm-s16be"?m.info.codec="pcm-s16":m.info.codec==="pcm-s24be"?m.info.codec="pcm-s24":m.info.codec==="pcm-s32be"?m.info.codec="pcm-s32":m.info.codec==="pcm-f32be"?m.info.codec="pcm-f32":m.info.codec==="pcm-f64be"&&(m.info.codec="pcm-f64"))}break;case"pcmC":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(4);let B=!!(H(e)&1),E=H(e);m.info.codec==="pcm-s16be"?B?E===16?m.info.codec="pcm-s16":E===24?m.info.codec="pcm-s24":E===32?m.info.codec="pcm-s32":(console.warn("Invalid ipcm sample size ".concat(E,".")),m.info.codec=null):E===16?m.info.codec="pcm-s16be":E===24?m.info.codec="pcm-s24be":E===32?m.info.codec="pcm-s32be":(console.warn("Invalid ipcm sample size ".concat(E,".")),m.info.codec=null):m.info.codec==="pcm-f32be"&&(B?E===32?m.info.codec="pcm-f32":E===64?m.info.codec="pcm-f64":(console.warn("Invalid fpcm sample size ".concat(E,".")),m.info.codec=null):E===32?m.info.codec="pcm-f32be":E===64?m.info.codec="pcm-f64be":(console.warn("Invalid fpcm sample size ".concat(E,".")),m.info.codec=null));break}case"dOps":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(1);let F=H(e),B=Pe(e),E=D(e),j=gs(e),R=H(e),O;R!==0?O=Q(e,2+F):O=new Uint8Array(0);let te=new Uint8Array(19+O.byteLength),Z=new DataView(te.buffer);Z.setUint32(0,1332770163,!1),Z.setUint32(4,1214603620,!1),Z.setUint8(8,1),Z.setUint8(9,F),Z.setUint16(10,B,!0),Z.setUint32(12,E,!0),Z.setInt16(16,j,!0),Z.setUint8(18,R),te.set(O,19),m.info.codecDescription=te,m.info.numberOfChannels=F}break;case"dfLa":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(4);let F=127,B=128,E=e.filePos;for(;e.filePos<s;){let Z=H(e),G=yr(e);if((Z&F)===0){e.skip(10);let ke=D(e),ie=ke>>>12,Ye=(ke>>9&7)+1;m.info.sampleRate=ie,m.info.numberOfChannels=Ye,e.skip(20)}else e.skip(G);if(Z&B)break}let j=e.filePos;e.filePos=E;let R=Q(e,j-E),O=new Uint8Array(4+R.byteLength);new DataView(O.buffer).setUint32(0,1716281667,!1),O.set(R,4),m.info.codecDescription=O}break;case"stts":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let F=D(e),B=0,E=0;for(let j=0;j<F;j++){let R=D(e),O=D(e);m.sampleTable.sampleTimingEntries.push({startIndex:B,startDecodeTimestamp:E,count:R,delta:O}),B+=R,E+=R*O}}break;case"ctts":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let F=D(e),B=0;for(let E=0;E<F;E++){let j=D(e),R=rr(e);m.sampleTable.sampleCompositionTimeOffsets.push({startIndex:B,count:j,offset:R}),B+=j}}break;case"stsz":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let F=D(e),B=D(e);if(F===0)for(let E=0;E<B;E++){let j=D(e);m.sampleTable.sampleSizes.push(j)}else m.sampleTable.sampleSizes.push(F)}break;case"stz2":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4),e.skip(3);let F=H(e),B=D(e),E=Q(e,Math.ceil(B*F/8)),j=new ne(E);for(let R=0;R<B;R++){let O=j.readBits(F);m.sampleTable.sampleSizes.push(O)}}break;case"stss":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4),m.sampleTable.keySampleIndices=[];let F=D(e);for(let B=0;B<F;B++){let E=D(e)-1;m.sampleTable.keySampleIndices.push(E)}m.sampleTable.keySampleIndices[0]!==0&&m.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let F=D(e);for(let E=0;E<F;E++){let j=D(e)-1,R=D(e),O=D(e);m.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:j,samplesPerChunk:R,sampleDescriptionIndex:O})}let B=0;for(let E=0;E<m.sampleTable.sampleToChunk.length;E++)if(m.sampleTable.sampleToChunk[E].startSampleIndex=B,E<m.sampleTable.sampleToChunk.length-1){let R=m.sampleTable.sampleToChunk[E+1].startChunkIndex-m.sampleTable.sampleToChunk[E].startChunkIndex;B+=R*m.sampleTable.sampleToChunk[E].samplesPerChunk}}break;case"stco":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let F=D(e);for(let B=0;B<F;B++){let E=D(e);m.sampleTable.chunkOffsets.push(E)}}break;case"co64":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let F=D(e);for(let B=0;B<F;B++){let E=at(e);m.sampleTable.chunkOffsets.push(E)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"mehd":{let m=H(e);e.skip(3);let F=m===1?at(e):D(e);this.movieDurationInTimescale=F}break;case"trex":{e.skip(4);let m=D(e),F=D(e),B=D(e),E=D(e),j=D(e);this.fragmentTrackDefaults.push({trackId:m,defaultSampleDescriptionIndex:F,defaultSampleDuration:B,defaultSampleSize:E,defaultSampleFlags:j})}break;case"tfra":{let m=H(e);e.skip(3);let F=D(e),B=this.tracks.find(ie=>ie.id===F);if(!B)break;let E=D(e),j=(E&48)>>4,R=(E&12)>>2,O=E&3,te=[H,Pe,yr,D],Z=te[j],G=te[R],be=te[O],ke=D(e);for(let ie=0;ie<ke;ie++){let Ye=m===1?at(e):D(e),he=m===1?at(e):D(e);Z(e),G(e),be(e),B.fragmentLookupTable.push({timestamp:Ye,moofOffset:he})}B.fragmentLookupTable.sort((ie,Ye)=>ie.timestamp-Ye.timestamp);for(let ie=0;ie<B.fragmentLookupTable.length-1;ie++){let Ye=B.fragmentLookupTable[ie],he=B.fragmentLookupTable[ie+1];Ye.timestamp===he.timestamp&&(B.fragmentLookupTable.splice(ie+1,1),ie--)}}break;case"moof":this.currentFragment={moofOffset:t,moofSize:r.totalSize,implicitBaseDataOffset:t,trackData:new Map},this.readContiguousBoxes(e.slice(i,r.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(d(this.currentFragment),this.readContiguousBoxes(e.slice(i,r.contentSize)),this.currentTrack){let m=this.currentFragment.trackData.get(this.currentTrack.id);if(m){let{currentFragmentState:F}=this.currentTrack;d(F),F.startTimestamp!==null&&(Gi(m,F.startTimestamp),m.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{d(this.currentFragment),e.skip(1);let m=yr(e),F=!!(m&1),B=!!(m&2),E=!!(m&8),j=!!(m&16),R=!!(m&32),O=!!(m&65536),te=!!(m&131072),Z=D(e),G=this.tracks.find(ke=>ke.id===Z);if(!G)break;let be=this.fragmentTrackDefaults.find(ke=>ke.trackId===Z);this.currentTrack=G,G.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:be?.defaultSampleDescriptionIndex??null,defaultSampleDuration:be?.defaultSampleDuration??null,defaultSampleSize:be?.defaultSampleSize??null,defaultSampleFlags:be?.defaultSampleFlags??null,startTimestamp:null},F?G.currentFragmentState.baseDataOffset=at(e):te&&(G.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),B&&(G.currentFragmentState.sampleDescriptionIndex=D(e)),E&&(G.currentFragmentState.defaultSampleDuration=D(e)),j&&(G.currentFragmentState.defaultSampleSize=D(e)),R&&(G.currentFragmentState.defaultSampleFlags=D(e)),O&&(G.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let m=this.currentTrack;if(!m)break;d(m.currentFragmentState);let F=H(e);e.skip(3);let B=F===0?D(e):at(e);m.currentFragmentState.startTimestamp=B}break;case"trun":{let m=this.currentTrack;if(!m)break;if(d(this.currentFragment),d(m.currentFragmentState),this.currentFragment.trackData.has(m.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let F=H(e),B=yr(e),E=!!(B&1),j=!!(B&4),R=!!(B&256),O=!!(B&512),te=!!(B&1024),Z=!!(B&2048),G=D(e),be=m.currentFragmentState.baseDataOffset;E&&(be+=rr(e));let ke=null;j&&(ke=D(e));let ie=be;if(G===0){this.currentFragment.implicitBaseDataOffset=ie;break}let Ye=0,he={track:m,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(m.id,he);for(let Qe=0;Qe<G;Qe++){let ot;R?ot=D(e):(d(m.currentFragmentState.defaultSampleDuration!==null),ot=m.currentFragmentState.defaultSampleDuration);let qt;O?qt=D(e):(d(m.currentFragmentState.defaultSampleSize!==null),qt=m.currentFragmentState.defaultSampleSize);let Cr;te?Cr=D(e):(d(m.currentFragmentState.defaultSampleFlags!==null),Cr=m.currentFragmentState.defaultSampleFlags),Qe===0&&ke!==null&&(Cr=ke);let Gs=0;Z&&(F===0?Gs=D(e):Gs=rr(e));let Qd=!(Cr&65536);he.samples.push({presentationTimestamp:Ye+Gs,duration:ot,byteOffset:ie,byteSize:qt,isKeyFrame:Qd}),ie+=qt,Ye+=ot}he.presentationTimestamps=he.samples.map((Qe,ot)=>({presentationTimestamp:Qe.presentationTimestamp,sampleIndex:ot})).sort((Qe,ot)=>Qe.presentationTimestamp-ot.presentationTimestamp);for(let Qe=0;Qe<he.presentationTimestamps.length;Qe++){let ot=he.presentationTimestamps[Qe],qt=he.samples[ot.sampleIndex];if(he.firstKeyFrameTimestamp===null&&qt.isKeyFrame&&(he.firstKeyFrameTimestamp=qt.presentationTimestamp),Qe<he.presentationTimestamps.length-1){let Cr=he.presentationTimestamps[Qe+1];qt.duration=Cr.presentationTimestamp-ot.presentationTimestamp}}let Ks=he.samples[he.presentationTimestamps[0].sampleIndex],bo=he.samples[ce(he.presentationTimestamps).sampleIndex];he.startTimestamp=Ks.presentationTimestamp,he.endTimestamp=bo.presentationTimestamp+bo.duration,this.currentFragment.implicitBaseDataOffset=ie}break;case"udta":{let m=this.iterateContiguousBoxes(e.slice(i,r.contentSize));for(let{boxInfo:F,slice:B}of m){if(F.name!=="meta"&&!this.currentTrack){let E=B.filePos;(a=this.metadataTags).raw??(a.raw={}),F.name[0]==="\xA9"?(n=this.metadataTags.raw)[o=F.name]??(n[o]=ht(B)):(c=this.metadataTags.raw)[l=F.name]??(c[l]=Q(B,F.contentSize)),B.filePos=E}switch(F.name){case"meta":B.skip(-F.headerSize),this.traverseBox(B);break;case"\xA9nam":case"name":this.currentTrack?this.currentTrack.name=Se.decode(Q(B,F.contentSize)):(u=this.metadataTags).title??(u.title=ht(B));break;case"\xA9des":this.currentTrack||((h=this.metadataTags).description??(h.description=ht(B)));break;case"\xA9ART":this.currentTrack||((f=this.metadataTags).artist??(f.artist=ht(B)));break;case"\xA9alb":this.currentTrack||((g=this.metadataTags).album??(g.album=ht(B)));break;case"albr":this.currentTrack||((w=this.metadataTags).albumArtist??(w.albumArtist=ht(B)));break;case"\xA9gen":this.currentTrack||((p=this.metadataTags).genre??(p.genre=ht(B)));break;case"\xA9day":if(!this.currentTrack){let E=new Date(ht(B));Number.isNaN(E.getTime())||((y=this.metadataTags).date??(y.date=E))}break;case"\xA9cmt":this.currentTrack||((b=this.metadataTags).comment??(b.comment=ht(B)));break;case"\xA9lyr":this.currentTrack||((T=this.metadataTags).lyrics??(T.lyrics=ht(B)));break}}}break;case"meta":{if(this.currentTrack)break;let F=D(e)!==0;this.currentMetadataKeys=new Map,F?this.readContiguousBoxes(e.slice(i,r.contentSize)):this.readContiguousBoxes(e.slice(i+4,r.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);let m=D(e);for(let F=0;F<m;F++){let B=D(e);e.skip(4);let E=Se.decode(Q(e,B-8));this.currentMetadataKeys.set(F+1,E)}}break;case"ilst":{if(!this.currentMetadataKeys)break;let m=this.iterateContiguousBoxes(e.slice(i,r.contentSize));for(let{boxInfo:F,slice:B}of m){let E=F.name,j=(E.charCodeAt(0)<<24)+(E.charCodeAt(1)<<16)+(E.charCodeAt(2)<<8)+E.charCodeAt(3);this.currentMetadataKeys.has(j)&&(E=this.currentMetadataKeys.get(j));let R=Gc(B);switch((v=this.metadataTags).raw??(v.raw={}),(P=this.metadataTags.raw)[E]??(P[E]=R),E){case"\xA9nam":case"titl":case"com.apple.quicktime.title":case"title":typeof R=="string"&&((A=this.metadataTags).title??(A.title=R));break;case"\xA9des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof R=="string"&&((I=this.metadataTags).description??(I.description=R));break;case"\xA9ART":case"com.apple.quicktime.artist":case"artist":typeof R=="string"&&((M=this.metadataTags).artist??(M.artist=R));break;case"\xA9alb":case"albm":case"com.apple.quicktime.album":case"album":typeof R=="string"&&((L=this.metadataTags).album??(L.album=R));break;case"aART":case"album_artist":typeof R=="string"&&((ue=this.metadataTags).albumArtist??(ue.albumArtist=R));break;case"\xA9cmt":case"com.apple.quicktime.comment":case"comment":typeof R=="string"&&((K=this.metadataTags).comment??(K.comment=R));break;case"\xA9gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof R=="string"&&((V=this.metadataTags).genre??(V.genre=R));break;case"\xA9lyr":case"lyrics":typeof R=="string"&&((J=this.metadataTags).lyrics??(J.lyrics=R));break;case"\xA9day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof R=="string"){let O=new Date(R);Number.isNaN(O.getTime())||((de=this.metadataTags).date??(de.date=O))}break;case"covr":case"com.apple.quicktime.artwork":R instanceof Gt?((We=this.metadataTags).images??(We.images=[]),this.metadataTags.images.push({data:R.data,kind:"coverFront",mimeType:R.mimeType})):R instanceof Uint8Array&&((Et=this.metadataTags).images??(Et.images=[]),this.metadataTags.images.push({data:R,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof R=="string"){let O=R.split("/"),te=Number.parseInt(O[0],10),Z=O[1]&&Number.parseInt(O[1],10);Number.isInteger(te)&&te>0&&((Ee=this.metadataTags).trackNumber??(Ee.trackNumber=te)),Z&&Number.isInteger(Z)&&Z>0&&((Ae=this.metadataTags).tracksTotal??(Ae.tracksTotal=Z))}break;case"trkn":if(R instanceof Uint8Array&&R.length>=6){let O=ee(R),te=O.getUint16(2,!1),Z=O.getUint16(4,!1);te>0&&((ze=this.metadataTags).trackNumber??(ze.trackNumber=te)),Z>0&&((At=this.metadataTags).tracksTotal??(At.tracksTotal=Z))}break;case"disc":case"disk":if(R instanceof Uint8Array&&R.length>=6){let O=ee(R),te=O.getUint16(2,!1),Z=O.getUint16(4,!1);te>0&&((gt=this.metadataTags).discNumber??(gt.discNumber=te)),Z>0&&((qr=this.metadataTags).discsTotal??(qr.discsTotal=Z))}break}}}break}return e.filePos=s,!0}},Na=class{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){let t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(null,r=>r.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return Jr(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){let r=this.mapTimestampIntoTimescale(e),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=Ua(i,r),a=await this.fetchPacketForSampleIndex(s,t);return!La(i)||!this.internalTrack.demuxer.isFragmented?a:this.performFragmentedLookup(null,n=>{let o=n.trackData.get(this.internalTrack.id);if(!o)return{sampleIndex:-1,correctSampleFound:!1};let c=oe(o.presentationTimestamps,r,h=>h.presentationTimestamp),l=c!==-1?o.presentationTimestamps[c].sampleIndex:-1,u=c!==-1&&r<o.endTimestamp;return{sampleIndex:l,correctSampleFound:u}},r,r,t)}async getNextPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,t);let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(i.fragment,s=>{if(s===i.fragment){let a=s.trackData.get(this.internalTrack.id);if(i.sampleIndex+1<a.samples.length)return{sampleIndex:i.sampleIndex+1,correctSampleFound:!0}}else if(s.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.mapTimestampIntoTimescale(e),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=Ua(i,r),a=s===-1?-1:el(i,s),n=await this.fetchPacketForSampleIndex(a,t);return!La(i)||!this.internalTrack.demuxer.isFragmented?n:this.performFragmentedLookup(null,o=>{let c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};let l=ra(c.presentationTimestamps,f=>c.samples[f.sampleIndex].isKeyFrame&&f.presentationTimestamp<=r),u=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,h=l!==-1&&r<c.endTimestamp;return{sampleIndex:u,correctSampleFound:h}},r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0){let s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=tl(s,r);return this.fetchPacketForSampleIndex(a,t)}let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(i.fragment,s=>{if(s===i.fragment){let n=s.trackData.get(this.internalTrack.id).samples.findIndex((o,c)=>o.isKeyFrame&&c>i.sampleIndex);if(n!==-1)return{sampleIndex:n,correctSampleFound:!0}}else{let a=s.trackData.get(this.internalTrack.id);if(a&&a.firstKeyFrameTimestamp!==null){let n=a.samples.findIndex(o=>o.isKeyFrame);return d(n!==-1),{sampleIndex:n,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=Jc(r,e);if(!i)return null;let s;if(t.metadataOnly)s=Ge;else{let c=this.internalTrack.demuxer.reader.requestSlice(i.sampleOffset,i.sampleSize);c instanceof Promise&&(c=await c),d(c),s=Q(c,i.sampleSize)}let a=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,n=i.duration/this.internalTrack.timescale,o=new pe(s,i.isKeyFrame?"key":"delta",a,n,e,i.sampleSize);return this.packetToSampleIndex.set(o,e),o}async fetchPacketInFragment(e,t,r){if(t===-1)return null;let s=e.trackData.get(this.internalTrack.id).samples[t];d(s);let a;if(r.metadataOnly)a=Ge;else{let l=this.internalTrack.demuxer.reader.requestSlice(s.byteOffset,s.byteSize);l instanceof Promise&&(l=await l),d(l),a=Q(l,s.byteSize)}let n=(s.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=s.duration/this.internalTrack.timescale,c=new pe(a,s.isKeyFrame?"key":"delta",n,o,e.moofOffset+t,s.byteSize);return this.packetToFragmentLocation.set(c,{fragment:e,sampleIndex:t}),c}async performFragmentedLookup(e,t,r,i,s){let a=this.internalTrack.demuxer,n=null,o=null,c=-1;if(e){let{sampleIndex:p,correctSampleFound:y}=t(e);if(y)return this.fetchPacketInFragment(e,p,s);p!==-1&&(o=e,c=p)}let l=oe(this.internalTrack.fragmentLookupTable,r,p=>p.timestamp),u=l!==-1?this.internalTrack.fragmentLookupTable[l]:null,h=oe(this.internalTrack.fragmentPositionCache,r,p=>p.startTimestamp),f=h!==-1?this.internalTrack.fragmentPositionCache[h]:null,g=Math.max(u?.moofOffset??0,f?.moofOffset??0)||null,w;for(e?g===null||e.moofOffset>=g?(w=e.moofOffset+e.moofSize,n=e):w=g:w=g??0;;){if(n){let T=n.trackData.get(this.internalTrack.id);if(T&&T.startTimestamp>i)break}let p=a.reader.requestSliceRange(w,vt,Jt);if(p instanceof Promise&&(p=await p),!p)break;let y=w,b=Ot(p);if(!b)break;if(b.name==="moof"){n=await a.readFragment(y);let{sampleIndex:T,correctSampleFound:v}=t(n);if(v)return this.fetchPacketInFragment(n,T,s);T!==-1&&(o=n,c=T)}w=y+b.totalSize}if(u&&(!o||o.moofOffset<u.moofOffset)){let p=this.internalTrack.fragmentLookupTable[l-1];d(!p||p.timestamp<u.timestamp);let y=p?.timestamp??-1/0;return this.performFragmentedLookup(null,t,y,i,s)}return o?this.fetchPacketInFragment(o,c,s):null}},Yc=class extends Na{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??(this.decoderConfigPromise=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&xa(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&Ia(e.data)}return{codec:ma(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})()):null}},Zc=class extends Na{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??(this.decoderConfig={codec:pa(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}):null}},Ua=(e,t)=>{if(e.presentationTimestamps){let r=oe(e.presentationTimestamps,t,i=>i.presentationTimestamp);return r===-1?-1:e.presentationTimestamps[r].sampleIndex}else{let r=oe(e.sampleTimingEntries,t,s=>s.startDecodeTimestamp);if(r===-1)return-1;let i=e.sampleTimingEntries[r];return i.startIndex+Math.min(Math.floor((t-i.startDecodeTimestamp)/i.delta),i.count-1)}},Jc=(e,t)=>{let r=oe(e.sampleTimingEntries,t,b=>b.startIndex),i=e.sampleTimingEntries[r];if(!i||i.startIndex+i.count<=t)return null;let a=i.startDecodeTimestamp+(t-i.startIndex)*i.delta,n=oe(e.sampleCompositionTimeOffsets,t,b=>b.startIndex),o=e.sampleCompositionTimeOffsets[n];o&&t-o.startIndex<o.count&&(a+=o.offset);let c=e.sampleSizes[Math.min(t,e.sampleSizes.length-1)],l=oe(e.sampleToChunk,t,b=>b.startSampleIndex),u=e.sampleToChunk[l];d(u);let h=u.startChunkIndex+Math.floor((t-u.startSampleIndex)/u.samplesPerChunk),f=e.chunkOffsets[h],g=u.startSampleIndex+(h-u.startChunkIndex)*u.samplesPerChunk,w=0,p=f;if(e.sampleSizes.length===1)p+=c*(t-g),w+=c*u.samplesPerChunk;else for(let b=g;b<g+u.samplesPerChunk;b++){let T=e.sampleSizes[b];b<t&&(p+=T),w+=T}let y=i.delta;if(e.presentationTimestamps){let b=e.presentationTimestampIndexMap[t];d(b!==void 0),b<e.presentationTimestamps.length-1&&(y=e.presentationTimestamps[b+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:y,sampleOffset:p,sampleSize:c,chunkOffset:f,chunkSize:w,isKeyFrame:e.keySampleIndices?Ai(e.keySampleIndices,t,b=>b)!==-1:!0}},el=(e,t)=>{if(!e.keySampleIndices)return t;let r=oe(e.keySampleIndices,t,i=>i);return e.keySampleIndices[r]??-1},tl=(e,t)=>{if(!e.keySampleIndices)return t+1;let r=oe(e.keySampleIndices,t,i=>i);return e.keySampleIndices[r+1]??-1},Gi=(e,t)=>{e.startTimestamp+=t,e.endTimestamp+=t;for(let r of e.samples)r.presentationTimestamp+=t;for(let r of e.presentationTimestamps)r.presentationTimestamp+=t},rl=e=>{let[t,,,r]=e,i=Math.hypot(t,r),s=t/i,a=r/i,n=-Math.atan2(a,s)*(180/Math.PI);return Number.isFinite(n)?n:0},La=e=>e.sampleSizes.length===0,Xi=class{constructor(e){this.value=e}},Yi=class{constructor(e){this.value=e}},Va=class{constructor(e){this.value=e}},Nt=class{constructor(e){this.value=e}},il=[440786851,408125543],Or=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],hi=[...il,...Or],Wa=e=>e<256?1:e<65536?2:e<1<<24?3:e<2**32?4:e<2**40?5:6,Ha=e=>e<1n<<8n?1:e<1n<<16n?2:e<1n<<24n?3:e<1n<<32n?4:e<1n<<40n?5:e<1n<<48n?6:e<1n<<56n?7:8,qa=e=>e>=-64&&e<64?1:e>=-8192&&e<8192?2:e>=-(1<<20)&&e<1<<20?3:e>=-(1<<27)&&e<1<<27?4:e>=-(2**34)&&e<2**34?5:6,sl=e=>{if(e<127)return 1;if(e<16383)return 2;if(e<(1<<21)-1)return 3;if(e<(1<<28)-1)return 4;if(e<2**35-1)return 5;if(e<2**42-1)return 6;throw new Error("EBML varint size not supported "+e)},al=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=Wa(e)){let r=0;switch(t){case 6:this.helperView.setUint8(r++,e/2**40|0);case 5:this.helperView.setUint8(r++,e/2**32|0);case 4:this.helperView.setUint8(r++,e>>24);case 3:this.helperView.setUint8(r++,e>>16);case 2:this.helperView.setUint8(r++,e>>8);case 1:this.helperView.setUint8(r++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,r))}writeUnsignedBigInt(e,t=Ha(e)){let r=0;for(let i=t-1;i>=0;i--)this.helperView.setUint8(r++,Number(e>>BigInt(i*8)&0xffn));this.writer.write(this.helper.subarray(0,r))}writeSignedInt(e,t=qa(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=sl(e)){let r=0;switch(t){case 1:this.helperView.setUint8(r++,128|e);break;case 2:this.helperView.setUint8(r++,64|e>>8),this.helperView.setUint8(r++,e);break;case 3:this.helperView.setUint8(r++,32|e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 4:this.helperView.setUint8(r++,16|e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 5:this.helperView.setUint8(r++,8|e/2**32&7),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 6:this.helperView.setUint8(r++,4|e/2**40&3),this.helperView.setUint8(r++,e/2**32|0),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let t=this.writer.getPos(),r=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let i=this.writer.getPos();if(this.dataOffsets.set(e,i),this.writeEBML(e.data),e.size!==-1){let s=this.writer.getPos()-i,a=this.writer.getPos();this.writer.seek(t),this.writeVarInt(s,r),this.writer.seek(a)}}else if(typeof e.data=="number"){let t=e.size??Wa(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="bigint"){let t=e.size??Ha(e.data);this.writeVarInt(t),this.writeUnsignedBigInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof Xi)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof Yi)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof Va){let t=e.size??qa(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof Nt){let t=fe.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else Me(e.data)}},Zi=8,it=2,_t=2*Zi,$a=e=>{let t=H(e);if(e.skip(-1),t===0)return null;let r=1,i=128;for(;(t&i)===0;)r++,i>>=1;return r},Nr=e=>{let t=H(e);if(t===0)return null;let r=1,i=128;for(;(t&i)===0;)r++,i>>=1;let s=t&i-1;for(let a=1;a<r;a++)s*=256,s+=H(e);return s},se=(e,t)=>{if(t<1||t>8)throw new Error("Bad unsigned int size "+t);let r=0;for(let i=0;i<t;i++)r*=256,r+=H(e);return r},nl=(e,t)=>{if(t<1)throw new Error("Bad unsigned int size "+t);let r=0n;for(let i=0;i<t;i++)r<<=8n,r+=BigInt(H(e));return r},ol=(e,t)=>{let r=se(e,t);return r&1<<t*8-1&&(r-=2**(t*8)),r},Ji=e=>{let t=$a(e);return t===null?null:se(e,t)},ja=e=>{let t=H(e);return t===255?t=null:(e.skip(-1),t=Nr(e),t===72057594037927940&&(t=null)),t},Ct=e=>{let t=Ji(e);if(t===null)return null;let r=ja(e);return{id:t,size:r}},pr=(e,t)=>{let r=Q(e,t),i=0;for(;i<t&&r[i]!==0;)i+=1;return String.fromCharCode(...r.subarray(0,i))},Ur=(e,t)=>{let r=Q(e,t),i=0;for(;i<t&&r[i]!==0;)i+=1;return Se.decode(r.subarray(0,i))},es=(e,t)=>{if(t===0)return 0;if(t!==4&&t!==8)throw new Error("Bad float size "+t);return t===4?Hl(e):Rn(e)},ts=async(e,t,r,i)=>{let s=new Set(r),a=t;for(;i===null||a<i;){let n=e.requestSliceRange(a,it,_t);if(n instanceof Promise&&(n=await n),!n)break;let o=Ct(n);if(!o)break;if(s.has(o.id))return{pos:a,found:!0};Ut(o.size),a=n.filePos+o.size}return{pos:i!==null&&i>a?i:a,found:!1}},Qa=async(e,t,r,i)=>{let a=new Set(r),n=t;for(;n<i;){let o=e.requestSliceRange(n,0,Math.min(65536,i-n));if(o instanceof Promise&&(o=await o),!o||o.length<Zi)break;for(let c=0;c<o.length-Zi;c++){o.filePos=n;let l=Ji(o);if(l!==null&&a.has(l))return n;n++}}return null},st={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function Ut(e){if(e===null)throw new Error("Undefined element size is used in a place where it is not supported.")}var Ka=e=>{let r=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isWebM?"webm":"x-matroska");if(e.codecStrings.length>0){let i=[...new Set(e.codecStrings.filter(Boolean))];r+='; codecs="'.concat(i.join(", "),'"')}return r},rs=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],Ga=10*2**20,cl=class extends Zt{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentBlockAdditional=null,this.currentCueTime=null,this.currentDecodingInstruction=null,this.currentTagTargetIsMovie=!0,this.currentSimpleTagName=null,this.currentAttachedFile=null,this.isWebM=!1,this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(t=>t.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.getCodecParameterString()));return Ka({isWebM:this.isWebM,hasVideo:this.segments.some(r=>r.tracks.some(i=>i.info?.type==="video")),hasAudio:this.segments.some(r=>r.tracks.some(i=>i.info?.type==="audio")),codecStrings:t.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(let t of this.segments)t.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(t),t.metadataTagsCollected=!0);let e={};for(let t of this.segments)e={...e,...t.metadataTags};return e}readMetadata(){return this.readMetadataPromise??(this.readMetadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,it,_t);if(t instanceof Promise&&(t=await t),!t)break;let r=Ct(t);if(!r)break;let i=r.id,s=r.size,a=t.filePos;if(i===440786851){Ut(s);let n=this.reader.requestSlice(a,s);if(n instanceof Promise&&(n=await n),!n)break;this.readContiguousElements(n)}else if(i===408125543){if(await this.readSegment(a,s),s===null||this.reader.fileSize===null)break}else if(i===524531317){if(this.reader.fileSize===null)break;s===null&&(s=(await ts(this.reader,a,hi,this.reader.fileSize)).pos-a);let n=ce(this.segments);n&&(n.elementEndPos=a+s)}Ut(s),e=a+s}})())}async readSegment(e,t){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:t===null?null:e+t,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let r=e;for(;this.currentSegment.elementEndPos===null||r<this.currentSegment.elementEndPos;){let n=this.reader.requestSliceRange(r,it,_t);if(n instanceof Promise&&(n=await n),!n)break;let o=r,c=Ct(n);if(!c||!Or.includes(c.id)&&c.id!==236){let g=await Qa(this.reader,o,Or,Math.min(this.currentSegment.elementEndPos??1/0,o+Ga));if(g){r=g;continue}else break}let{id:l,size:u}=c,h=n.filePos,f=rs.findIndex(g=>g.id===l);if(f!==-1){let g=rs[f].flag;this.currentSegment[g]=!0,Ut(u);let w=this.reader.requestSlice(h,u);w instanceof Promise&&(w=await w),w&&this.readContiguousElements(w)}else if(l===307544935||l===423732329){l===307544935?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,Ut(u);let g=this.reader.requestSlice(h,u);g instanceof Promise&&(g=await g),g&&this.readContiguousElements(g)}else if(l===524531317){this.currentSegment.clusterSeekStartPos=o;break}if(u===null)break;r=h+u}if(this.currentSegment.seekEntries.sort((n,o)=>n.segmentPosition-o.segmentPosition),this.reader.fileSize!==null)for(let n of this.currentSegment.seekEntries){let o=rs.find(g=>g.id===n.id);if(!o||this.currentSegment[o.flag])continue;let c=this.reader.requestSliceRange(e+n.segmentPosition,it,_t);if(c instanceof Promise&&(c=await c),!c)continue;let l=Ct(c);if(!l)continue;let{id:u,size:h}=l;if(u!==o.id)continue;Ut(h),this.currentSegment[o.flag]=!0;let f=this.reader.requestSlice(c.filePos,h);f instanceof Promise&&(f=await f),f&&this.readContiguousElements(f)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((n,o)=>Number(o.isDefault)-Number(n.isDefault));let i=new Map(this.currentSegment.tracks.map(n=>[n.id,n]));for(let n of this.currentSegment.cuePoints){let o=i.get(n.trackId);o&&o.cuePoints.push(n)}for(let n of this.currentSegment.tracks){n.cuePoints.sort((o,c)=>o.time-c.time);for(let o=0;o<n.cuePoints.length-1;o++){let c=n.cuePoints[o],l=n.cuePoints[o+1];c.time===l.time&&(n.cuePoints.splice(o+1,1),o--)}}let s=null,a=-1/0;for(let n of this.currentSegment.tracks)n.cuePoints.length>a&&(a=n.cuePoints.length,s=n);for(let n of this.currentSegment.tracks)n.cuePoints.length===0&&(n.cuePoints=s.cuePoints);this.currentSegment=null}async readCluster(e,t){if(t.lastReadCluster?.elementStartPos===e)return t.lastReadCluster;let r=this.reader.requestSliceRange(e,it,_t);r instanceof Promise&&(r=await r),d(r);let i=e,s=Ct(r);d(s);let a=s.id;d(a===524531317);let n=s.size,o=r.filePos;n===null&&(n=(await ts(this.reader,o,hi,t.elementEndPos)).pos-o);let c=this.reader.requestSlice(o,n);c instanceof Promise&&(c=await c);let l={segment:t,elementStartPos:i,elementEndPos:o+n,dataStartPos:o,timestamp:-1,trackData:new Map};if(this.currentCluster=l,c){let u=this.readContiguousElements(c,hi);l.elementEndPos=u}for(let[,u]of l.trackData){let h=u.track;d(u.blocks.length>0);let f=!1,g=!1;for(let b=0;b<u.blocks.length;b++){let T=u.blocks[b];T.timestamp+=l.timestamp,f||(f=T.referencedTimestamps.length>0),g||(g=T.lacing!==0)}f&&(u.blocks=dl(u.blocks)),u.presentationTimestamps=u.blocks.map((b,T)=>({timestamp:b.timestamp,blockIndex:T})).sort((b,T)=>b.timestamp-T.timestamp);for(let b=0;b<u.presentationTimestamps.length;b++){let T=u.presentationTimestamps[b],v=u.blocks[T.blockIndex];if(u.firstKeyFrameTimestamp===null&&v.isKeyFrame&&(u.firstKeyFrameTimestamp=v.timestamp),b<u.presentationTimestamps.length-1){let P=u.presentationTimestamps[b+1];v.duration=P.timestamp-v.timestamp}else v.duration===0&&h.defaultDuration!=null&&v.lacing===0&&(v.duration=h.defaultDuration)}g&&(this.expandLacedBlocks(u.blocks,h),u.presentationTimestamps=u.blocks.map((b,T)=>({timestamp:b.timestamp,blockIndex:T})).sort((b,T)=>b.timestamp-T.timestamp));let w=u.blocks[u.presentationTimestamps[0].blockIndex],p=u.blocks[ce(u.presentationTimestamps).blockIndex];u.startTimestamp=w.timestamp,u.endTimestamp=p.timestamp+p.duration;let y=oe(h.clusterPositionCache,u.startTimestamp,b=>b.startTimestamp);(y===-1||h.clusterPositionCache[y].elementStartPos!==i)&&h.clusterPositionCache.splice(y+1,0,{elementStartPos:l.elementStartPos,startTimestamp:u.startTimestamp})}return t.lastReadCluster=l,l}getTrackDataInCluster(e,t){let r=e.trackData.get(t);if(!r){let i=e.segment.tracks.find(s=>s.id===t);if(!i)return null;r={track:i,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,r)}return r}expandLacedBlocks(e,t){for(let r=0;r<e.length;r++){let i=e[r];if(i.lacing===0)continue;i.decoded||(i.data=this.decodeBlockData(t,i.data),i.decoded=!0);let s=bi.tempFromBytes(i.data),a=[],n=H(s)+1;switch(i.lacing){case 1:{let o=0;for(let c=0;c<n-1;c++){let l=0;for(;s.bufferPos<s.length;){let u=H(s);if(l+=u,u<255){a.push(l),o+=l;break}}}a.push(s.length-(s.bufferPos+o))}break;case 2:{let o=s.length-1,c=Math.floor(o/n);for(let l=0;l<n;l++)a.push(c)}break;case 3:{let o=Nr(s);d(o!==null);let c=o;a.push(c);let l=c;for(let u=1;u<n-1;u++){let h=s.bufferPos,f=Nr(s);d(f!==null);let g=f,p=(1<<(s.bufferPos-h)*7-1)-1,y=g-p;c+=y,a.push(c),l+=c}a.push(s.length-(s.bufferPos+l))}break;default:d(!1)}d(a.length===n),e.splice(r,1);for(let o=0;o<n;o++){let c=a[o],l=Q(s,c),u=i.duration||n*(t.defaultDuration??0),h=i.timestamp+u*o/n,f=u/n;e.splice(r+o,0,{timestamp:h,duration:f,isKeyFrame:i.isKeyFrame,referencedTimestamps:i.referencedTimestamps,data:l,lacing:0,decoded:!0,mainAdditional:i.mainAdditional})}r+=n,r--}}async loadSegmentMetadata(e){for(let t of e.seekEntries){if(!(t.id===307544935&&!e.tagsSeen)){if(!(t.id===423732329&&!e.attachmentsSeen))continue}let r=this.reader.requestSliceRange(e.dataStartPos+t.segmentPosition,it,_t);if(r instanceof Promise&&(r=await r),!r)continue;let i=Ct(r);if(!i||i.id!==t.id)continue;let{size:s}=i;Ut(s),d(!this.currentSegment),this.currentSegment=e;let a=this.reader.requestSlice(r.filePos,s);a instanceof Promise&&(a=await a),a&&this.readContiguousElements(a),this.currentSegment=null,t.id===307544935?e.tagsSeen=!0:t.id===423732329&&(e.attachmentsSeen=!0)}}readContiguousElements(e,t){let r=e.filePos;for(;e.filePos-r<=e.length-it;){let i=e.filePos;if(!this.traverseElement(e,t))return i}return e.filePos}traverseElement(e,t){let r=Ct(e);if(!r||t&&t.includes(r.id))return!1;let{id:i,size:s}=r,a=e.filePos;switch(Ut(s),i){case 17026:this.isWebM=pr(e,s)==="webm";break;case 19899:{if(!this.currentSegment)break;let n={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(n),this.readContiguousElements(e.slice(a,s)),(n.id===-1||n.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let n=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!n)break;n.id=se(e,s)}break;case 21420:{let n=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!n)break;n.segmentPosition=se(e,s)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=se(e,s),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=es(e,s)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:$e,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(a,s)),this.currentTrack.decodingInstructions.some(n=>n.data?.type!=="decompress"||n.scope!==1||n.data.algorithm!==3)&&(console.warn("Track #".concat(this.currentTrack.id," has an unsupported content encoding; dropping.")),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let n=this.currentTrack.codecId.indexOf("/"),o=n===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,n);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===st.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===st.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):o===st.vp8?this.currentTrack.info.codec="vp8":o===st.vp9?this.currentTrack.info.codec="vp9":o===st.av1&&(this.currentTrack.info.codec="av1");let c=this.currentTrack,l=new mr(this.input,new ll(c));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){o===st.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===st.mp3?this.currentTrack.info.codec="mp3":o===st.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=ur):o===st.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):o===st.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let c=this.currentTrack,l=new rt(this.input,new ul(c));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=se(e,s)}break;case 131:{if(!this.currentTrack)break;let n=se(e,s);n===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:n===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;se(e,s)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!se(e,s)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=pr(e,s)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=Q(e,s)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*se(e,s)/1e9}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=Ur(e,s)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==$e)break;this.currentTrack.languageCode=pr(e,s),Er(this.currentTrack.languageCode)||(this.currentTrack.languageCode=$e)}break;case 2274717:{if(!this.currentTrack)break;let o=pr(e,s).split("-")[0];o?this.currentTrack.languageCode=o:this.currentTrack.languageCode=$e}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(a,s))}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=se(e,s)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=se(e,s)}break;case 21440:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=se(e,s)===1}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(a,s))}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let n=se(e,s),o=Xr[n]??null;this.currentTrack.info.colorSpace.matrix=o}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=se(e,s)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let n=se(e,s),o=Ir[n]??null;this.currentTrack.info.colorSpace.transfer=o}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let n=se(e,s),o=Gr[n]??null;this.currentTrack.info.colorSpace.primaries=o}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(a,s))}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let o=-es(e,s);try{this.currentTrack.info.rotation=kt(o)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(a,s))}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=es(e,s)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=se(e,s)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=se(e,s)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(a,s)),this.currentCueTime=null}break;case 179:this.currentCueTime=se(e,s);break;case 183:{if(this.currentCueTime===null)break;d(this.currentSegment);let n={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(n),this.readContiguousElements(e.slice(a,s)),(n.trackId===-1||n.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let n=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!n)break;n.trackId=se(e,s)}break;case 241:{let n=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!n)break;d(this.currentSegment),n.clusterPosition=this.currentSegment.dataStartPos+se(e,s)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=se(e,s)}break;case 163:{if(!this.currentCluster)break;let n=Nr(e);if(n===null)break;let o=this.getTrackDataInCluster(this.currentCluster,n);if(!o)break;let c=gs(e),l=H(e),u=!!(l&128),h=l>>1&3,f=Q(e,s-(e.filePos-a)),g=o.track.decodingInstructions.length>0;o.blocks.push({timestamp:c,duration:0,isKeyFrame:u,referencedTimestamps:[],data:f,lacing:h,decoded:!g,mainAdditional:null})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(e.slice(a,s)),this.currentBlock){for(let n=0;n<this.currentBlock.referencedTimestamps.length;n++)this.currentBlock.referencedTimestamps[n]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let n=Nr(e);if(n===null)break;let o=this.getTrackDataInCluster(this.currentCluster,n);if(!o)break;let c=gs(e),u=H(e)>>1&3,h=Q(e,s-(e.filePos-a)),f=o.track.decodingInstructions.length>0;this.currentBlock={timestamp:c,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:h,lacing:u,decoded:!f,mainAdditional:null},o.blocks.push(this.currentBlock)}break;case 30113:this.readContiguousElements(e.slice(a,s));break;case 166:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(a,s)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case 165:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=Q(e,s)}break;case 238:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=se(e,s)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=se(e,s)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let n=ol(e,s);this.currentBlock.referencedTimestamps.push(n)}break;case 29555:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(a,s));break;case 25536:this.readContiguousElements(e.slice(a,s));break;case 26826:se(e,s)!==50&&(this.currentTagTargetIsMovie=!1);break;case 25541:case 25545:case 25540:case 25542:this.currentTagTargetIsMovie=!1;break;case 26568:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(a,s))}break;case 17827:this.currentSimpleTagName=Ur(e,s);break;case 17543:{if(!this.currentSimpleTagName)break;let n=Ur(e,s);this.processTagValue(this.currentSimpleTagName,n)}break;case 17541:{if(!this.currentSimpleTagName)break;let n=Q(e,s);this.processTagValue(this.currentSimpleTagName,n)}break;case 24999:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(a,s));let n=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(n.raw??(n.raw={}),n.raw[this.currentAttachedFile.fileUid.toString()]=new ti(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){let o=this.currentAttachedFile.fileName,c="unknown";if(o){let l=o.toLowerCase();l.startsWith("cover.")?c="coverFront":l.startsWith("back.")&&(c="coverBack")}n.images??(n.images=[]),n.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:c,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case 18094:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=nl(e,s)}break;case 18030:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=Ur(e,s)}break;case 18016:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=pr(e,s)}break;case 18012:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=Q(e,s)}break;case 18046:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=Ur(e,s)}break;case 28032:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(a,s)),this.currentTrack.decodingInstructions.sort((n,o)=>o.order-n.order)}break;case 25152:this.currentDecodingInstruction={order:0,scope:1,data:null},this.readContiguousElements(e.slice(a,s)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case 20529:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=se(e,s)}break;case 20530:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=se(e,s)}break;case 20532:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:0,settings:null},this.readContiguousElements(e.slice(a,s))}break;case 16980:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=se(e,s)}break;case 16981:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=Q(e,s)}break;case 20533:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=a+s,!0}decodeBlockData(e,t){d(e.decodingInstructions.length>0);let r=t;for(let i of e.decodingInstructions)switch(d(i.data),i.data.type){case"decompress":switch(i.data.algorithm){case 3:if(i.data.settings&&i.data.settings.length>0){let s=i.data.settings,a=new Uint8Array(s.length+r.length);a.set(s,0),a.set(r,s.length),r=a}break;default:}break;default:}return r}processTagValue(e,t){var i;if(!this.currentSegment?.metadataTags)return;let r=this.currentSegment.metadataTags;if(r.raw??(r.raw={}),(i=r.raw)[e]??(i[e]=t),typeof t=="string")switch(e.toLowerCase()){case"title":r.title??(r.title=t);break;case"description":r.description??(r.description=t);break;case"artist":r.artist??(r.artist=t);break;case"album":r.album??(r.album=t);break;case"album_artist":r.albumArtist??(r.albumArtist=t);break;case"genre":r.genre??(r.genre=t);break;case"comment":r.comment??(r.comment=t);break;case"lyrics":r.lyrics??(r.lyrics=t);break;case"date":{let s=new Date(t);Number.isNaN(s.getTime())||(r.date??(r.date=s))}break;case"track_number":case"part_number":{let s=t.split("/"),a=Number.parseInt(s[0],10),n=s[1]&&Number.parseInt(s[1],10);Number.isInteger(a)&&a>0&&(r.trackNumber??(r.trackNumber=a)),n&&Number.isInteger(n)&&n>0&&(r.tracksTotal??(r.tracksTotal=n))}break;case"disc_number":case"disc":{let s=t.split("/"),a=Number.parseInt(s[0],10),n=s[1]&&Number.parseInt(s[1],10);Number.isInteger(a)&&a>0&&(r.discNumber??(r.discNumber=a)),n&&Number.isInteger(n)&&n>0&&(r.discsTotal??(r.discsTotal=n))}break}}},Xa=class{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(null,t=>t.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,e)}intoTimescale(e){return Jr(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(null,i=>{let s=i.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};let a=oe(s.presentationTimestamps,r,c=>c.timestamp),n=a!==-1?s.presentationTimestamps[a].blockIndex:-1,o=a!==-1&&r<s.endTimestamp;return{blockIndex:n,correctBlockFound:o}},r,r,t)}async getNextPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,i=>{if(i===r.cluster){let s=i.trackData.get(this.internalTrack.id);if(r.blockIndex+1<s.blocks.length)return{blockIndex:r.blockIndex+1,correctBlockFound:!0}}else if(i.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(null,i=>{let s=i.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};let a=ra(s.presentationTimestamps,c=>s.blocks[c.blockIndex].isKeyFrame&&c.timestamp<=r),n=a!==-1?s.presentationTimestamps[a].blockIndex:-1,o=a!==-1&&r<s.endTimestamp;return{blockIndex:n,correctBlockFound:o}},r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,i=>{if(i===r.cluster){let a=i.trackData.get(this.internalTrack.id).blocks.findIndex((n,o)=>n.isKeyFrame&&o>r.blockIndex);if(a!==-1)return{blockIndex:a,correctBlockFound:!0}}else{let s=i.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){let a=s.blocks.findIndex(n=>n.isKeyFrame);return d(a!==-1),{blockIndex:a,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,r){if(t===-1)return null;let s=e.trackData.get(this.internalTrack.id).blocks[t];d(s),s.decoded||(s.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,s.data),s.decoded=!0);let a=r.metadataOnly?Ge:s.data,n=s.timestamp/this.internalTrack.segment.timestampFactor,o=s.duration/this.internalTrack.segment.timestampFactor,c={};s.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(c.alpha=r.metadataOnly?Ge:s.mainAdditional,c.alphaByteLength=s.mainAdditional.byteLength);let l=new pe(a,s.isKeyFrame?"key":"delta",n,o,e.dataStartPos+t,s.data.byteLength,c);return this.packetToClusterLocation.set(l,{cluster:e,blockIndex:t}),l}async performClusterLookup(e,t,r,i,s){let{demuxer:a,segment:n}=this.internalTrack,o=null,c=null,l=-1;if(e){let{blockIndex:y,correctBlockFound:b}=t(e);if(b)return this.fetchPacketInCluster(e,y,s);y!==-1&&(c=e,l=y)}let u=oe(this.internalTrack.cuePoints,r,y=>y.time),h=u!==-1?this.internalTrack.cuePoints[u]:null,f=oe(this.internalTrack.clusterPositionCache,r,y=>y.startTimestamp),g=f!==-1?this.internalTrack.clusterPositionCache[f]:null,w=Math.max(h?.clusterPosition??0,g?.elementStartPos??0)||null,p;for(e?w===null||e.elementStartPos>=w?(p=e.elementEndPos,o=e):p=w:p=w??n.clusterSeekStartPos;n.elementEndPos===null||p<=n.elementEndPos-it;){if(o){let M=o.trackData.get(this.internalTrack.id);if(M&&M.startTimestamp>i)break}let y=a.reader.requestSliceRange(p,it,_t);if(y instanceof Promise&&(y=await y),!y)break;let b=p,T=Ct(y);if(!T||!Or.includes(T.id)&&T.id!==236){let M=await Qa(a.reader,b,Or,Math.min(n.elementEndPos??1/0,b+Ga));if(M){p=M;continue}else break}let v=T.id,P=T.size,A=y.filePos;if(v===524531317){o=await a.readCluster(b,n),P=o.elementEndPos-A;let{blockIndex:M,correctBlockFound:L}=t(o);if(L)return this.fetchPacketInCluster(o,M,s);M!==-1&&(c=o,l=M)}P===null&&(d(v!==524531317),P=(await ts(a.reader,A,hi,n.elementEndPos)).pos-A);let I=A+P;if(n.elementEndPos===null){let M=a.reader.requestSliceRange(I,it,_t);if(M instanceof Promise&&(M=await M),!M)break;if(Ji(M)===408125543){n.elementEndPos=I;break}}p=I}if(h&&(!c||c.elementStartPos<h.clusterPosition)){let y=this.internalTrack.cuePoints[u-1];d(!y||y.time<h.time);let b=y?.time??-1/0;return this.performClusterLookup(null,t,b,i,s)}return c?this.fetchPacketInCluster(c,l,s):null}},ll=class extends Xa{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??(this.decoderConfigPromise=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:ma({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Sa(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?_a(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?xa(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?Ia(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})()):null}},ul=class extends Xa{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??(this.decoderConfig={codec:pa({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}):null}},dl=e=>{let t=new Map;for(let a=0;a<e.length;a++){let n=e[a];t.set(n.timestamp,n)}let r=new Set,i=[],s=a=>{if(!r.has(a)){r.add(a);for(let n=0;n<a.referencedTimestamps.length;n++){let o=a.referencedTimestamps[n],c=t.get(o);c&&s(c)}i.push(a)}};for(let a=0;a<e.length;a++)s(e[a]);return i},Ya=4,hl=[44100,48e3,32e3],is=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],ss=1483304551,Za=1231971951,as=(e,t,r,i,s)=>t===0?0:t===1?Math.floor(144*r/(i<<e))+s:t===2?Math.floor(144*r/i)+s:(Math.floor(12*r/i)+s)*4,ns=(e,t)=>e===3?t===3?21:36:t===3?13:21,Ja=(e,t)=>{let r=e>>>24,i=e>>>16&255,s=e>>>8&255,a=e&255;if(r!==255&&i!==255&&s!==255&&a!==255)return{header:null,bytesAdvanced:4};if(r!==255)return{header:null,bytesAdvanced:1};if((i&224)!==224)return{header:null,bytesAdvanced:1};let n=0,o=0;i&16?n=i&8?0:1:(n=1,o=1);let c=i>>3&3,l=i>>1&3,u=s>>4&15,h=(s>>2&3)%3,f=s>>1&1,g=a>>6&3,w=a>>4&3,p=a>>3&1,y=a>>2&1,b=a&3,T=is[n*16*4+l*16+u];if(T===-1)return{header:null,bytesAdvanced:1};let v=T*1e3,P=hl[h]>>n+o,A=as(n,l,v,P,f);if(t!==null&&t<A)return{header:null,bytesAdvanced:1};let I;return c===3?I=l===3?384:1152:l===3?I=384:l===2?I=1152:I=576,{header:{totalSize:A,mpegVersionId:c,layer:l,bitrate:v,frequencyIndex:h,sampleRate:P,channel:g,modeExtension:w,copyright:p,original:y,emphasis:b,audioSamplesInFrame:I},bytesAdvanced:1}},fl=e=>{let t=127,r=0,i=e;for(;(t^2147483647)!==0;)r=i&~t,r<<=1,r|=i&t,t=(t+1<<8)-1,i=r;return r},os=e=>{let t=2130706432,r=0;for(;t!==0;)r>>=1,r|=e&t,t>>=8;return r},fi=128,mi=10,gr=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],ml=(e,t)=>{var h;let r=e.filePos;t.raw??(t.raw={}),(h=t.raw).TAG??(h.TAG=Q(e,fi-3)),e.filePos=r;let i=wr(e,30);i&&(t.title??(t.title=i));let s=wr(e,30);s&&(t.artist??(t.artist=s));let a=wr(e,30);a&&(t.album??(t.album=a));let n=wr(e,4),o=Number.parseInt(n,10);Number.isInteger(o)&&o>0&&(t.date??(t.date=new Date(o,0,1)));let c=Q(e,30),l;if(c[28]===0&&c[29]!==0){let f=c[29];f>0&&(t.trackNumber??(t.trackNumber=f)),e.skip(-30),l=wr(e,28),e.skip(2)}else e.skip(-30),l=wr(e,30);l&&(t.comment??(t.comment=l));let u=H(e);u<gr.length&&(t.genre??(t.genre=gr[u]))},wr=(e,t)=>{let r=Q(e,t),i=or(r.indexOf(0),r.length),s=r.subarray(0,i),a="";for(let n=0;n<s.length;n++)a+=String.fromCharCode(s[n]);return a.trimEnd()},pi=e=>{let t=e.filePos,r=Ce(e,3),i=H(e),s=H(e),a=H(e),n=D(e);if(r!=="ID3"||i===255||s===255||(n&2155905152)!==0)return e.filePos=t,null;let o=os(n);return{majorVersion:i,revision:s,flags:a,size:o}},en=(e,t,r)=>{var a,n,o,c;if(![2,3,4].includes(t.majorVersion)){console.warn("Unsupported ID3v2 major version: ".concat(t.majorVersion));return}let i=Q(e,t.size),s=new pl(t,i);if(t.flags&16&&s.removeFooter(),t.flags&128&&t.majorVersion===3&&s.ununsynchronizeAll(),t.flags&64){let l=s.readU32();t.majorVersion===3?s.pos+=l:s.pos+=l-4}for(;s.pos<=s.bytes.length-s.frameHeaderSize();){let l=s.readId3V2Frame();if(!l)break;let u=s.pos,h=s.pos+l.size,f=!1,g=!1,w=!1;if(t.majorVersion===3?(f=!!(l.flags&64),g=!!(l.flags&128)):t.majorVersion===4&&(f=!!(l.flags&4),g=!!(l.flags&8),w=!!(l.flags&2)||!!(t.flags&128)),f){console.warn("Skipping encrypted ID3v2 frame ".concat(l.id)),s.pos=h;continue}if(g){console.warn("Skipping compressed ID3v2 frame ".concat(l.id)),s.pos=h;continue}switch(w&&s.ununsynchronizeRegion(s.pos,h),r.raw??(r.raw={}),l.id[0]==="T"?(a=r.raw)[n=l.id]??(a[n]=s.readId3V2EncodingAndText(h)):(o=r.raw)[c=l.id]??(o[c]=s.readBytes(l.size)),s.pos=u,l.id){case"TIT2":case"TT2":r.title??(r.title=s.readId3V2EncodingAndText(h));break;case"TIT3":case"TT3":r.description??(r.description=s.readId3V2EncodingAndText(h));break;case"TPE1":case"TP1":r.artist??(r.artist=s.readId3V2EncodingAndText(h));break;case"TALB":case"TAL":r.album??(r.album=s.readId3V2EncodingAndText(h));break;case"TPE2":case"TP2":r.albumArtist??(r.albumArtist=s.readId3V2EncodingAndText(h));break;case"TRCK":case"TRK":{let y=s.readId3V2EncodingAndText(h).split("/"),b=Number.parseInt(y[0],10),T=y[1]&&Number.parseInt(y[1],10);Number.isInteger(b)&&b>0&&(r.trackNumber??(r.trackNumber=b)),T&&Number.isInteger(T)&&T>0&&(r.tracksTotal??(r.tracksTotal=T))}break;case"TPOS":case"TPA":{let y=s.readId3V2EncodingAndText(h).split("/"),b=Number.parseInt(y[0],10),T=y[1]&&Number.parseInt(y[1],10);Number.isInteger(b)&&b>0&&(r.discNumber??(r.discNumber=b)),T&&Number.isInteger(T)&&T>0&&(r.discsTotal??(r.discsTotal=T))}break;case"TCON":case"TCO":{let p=s.readId3V2EncodingAndText(h),y=/^\((\d+)\)/.exec(p);if(y){let b=Number.parseInt(y[1]);if(gr[b]!==void 0){r.genre??(r.genre=gr[b]);break}}if(y=/^\d+$/.exec(p),y){let b=Number.parseInt(y[0]);if(gr[b]!==void 0){r.genre??(r.genre=gr[b]);break}}r.genre??(r.genre=p)}break;case"TDRC":case"TDAT":{let p=s.readId3V2EncodingAndText(h),y=new Date(p);Number.isNaN(y.getTime())||(r.date??(r.date=y))}break;case"TYER":case"TYE":{let p=s.readId3V2EncodingAndText(h),y=Number.parseInt(p,10);Number.isInteger(y)&&(r.date??(r.date=new Date(y,0,1)))}break;case"USLT":case"ULT":{let p=s.readU8();s.pos+=3,s.readId3V2Text(p,h),r.lyrics??(r.lyrics=s.readId3V2Text(p,h))}break;case"COMM":case"COM":{let p=s.readU8();s.pos+=3,s.readId3V2Text(p,h),r.comment??(r.comment=s.readId3V2Text(p,h))}break;case"APIC":case"PIC":{let p=s.readId3V2TextEncoding(),y;if(t.majorVersion===2){let P=s.readAscii(3);y=P==="PNG"?"image/png":P==="JPG"?"image/jpeg":"image/*"}else y=s.readId3V2Text(p,h);let b=s.readU8(),T=s.readId3V2Text(p,h).trimEnd(),v=h-s.pos;if(v>=0){let P=s.readBytes(v);r.images||(r.images=[]),r.images.push({data:P,mimeType:y,kind:b===3?"coverFront":b===4?"coverBack":"unknown",description:T})}}break;default:s.pos+=l.size;break}s.pos=h}},pl=class{constructor(e,t){this.header=e,this.bytes=t,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){let e=[];for(let t=0;t<this.bytes.length;t++){let r=this.bytes[t];e.push(r),r===255&&t!==this.bytes.length-1&&this.bytes[t]===0&&t++}this.bytes=new Uint8Array(e),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(e,t){let r=[];for(let a=e;a<t;a++){let n=this.bytes[a];r.push(n),n===255&&a!==t-1&&this.bytes[a+1]===0&&a++}let i=this.bytes.subarray(0,e),s=this.bytes.subarray(t);this.bytes=new Uint8Array(i.length+r.length+s.length),this.bytes.set(i,0),this.bytes.set(r,i.length),this.bytes.set(s,i.length+r.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-mi),this.view=new DataView(this.bytes.buffer)}readBytes(e){let t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t}readU8(){let e=this.view.getUint8(this.pos);return this.pos+=1,e}readU16(){let e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}readU24(){let e=this.view.getUint16(this.pos,!1),t=this.view.getUint8(this.pos+1);return this.pos+=3,e*256+t}readU32(){let e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}readAscii(e){let t="";for(let r=0;r<e;r++)t+=String.fromCharCode(this.view.getUint8(this.pos+r));return this.pos+=e,t}readId3V2Frame(){if(this.header.majorVersion===2){let e=this.readAscii(3);if(e==="\0\0\0")return null;let t=this.readU24();return{id:e,size:t,flags:0}}else{let e=this.readAscii(4);if(e==="\0\0\0\0")return null;let t=this.readU32(),r=this.header.majorVersion===4?os(t):t,i=this.readU16(),s=this.pos,a=n=>{let o=this.pos+n;if(o>this.bytes.length)return!1;if(o<=this.bytes.length-this.frameHeaderSize()){this.pos+=n;let c=this.readAscii(4);if(c!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(c))return!1}return!0};if(!a(r)){let n=this.header.majorVersion===4?t:os(t);a(n)&&(r=n)}return this.pos=s,{id:e,size:r,flags:i}}}readId3V2TextEncoding(){let e=this.readU8();if(e>3)throw new Error("Unsupported text encoding: ".concat(e));return e}readId3V2Text(e,t){let r=this.pos,i=this.readBytes(t-this.pos);switch(e){case 0:{let s="";for(let a=0;a<i.length;a++){let n=i[a];if(n===0){this.pos=r+a+1;break}s+=String.fromCharCode(n)}return s}case 1:if(i[0]===255&&i[1]===254){let s=new TextDecoder("utf-16le"),a=or(i.findIndex((n,o)=>n===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(a+2,i.length),s.decode(i.subarray(2,a))}else if(i[0]===254&&i[1]===255){let s=new TextDecoder("utf-16be"),a=or(i.findIndex((n,o)=>n===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(a+2,i.length),s.decode(i.subarray(2,a))}else{let s=or(i.findIndex(a=>a===0),i.length);return this.pos=r+Math.min(s+1,i.length),Se.decode(i.subarray(0,s))}case 2:{let s=new TextDecoder("utf-16be"),a=or(i.findIndex((n,o)=>n===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(a+2,i.length),s.decode(i.subarray(0,a))}case 3:{let s=or(i.findIndex(a=>a===0),i.length);return this.pos=r+Math.min(s+1,i.length),Se.decode(i.subarray(0,s))}}}readId3V2EncodingAndText(e){if(this.pos>=e)return"";let t=this.readId3V2TextEncoding();return this.readId3V2Text(t,e)}},tn=class{constructor(e){this.helper=new Uint8Array(8),this.helperView=ee(this.helper),this.writer=e}writeId3V2Tag(e){let t=this.writer.getPos();this.writeAscii("ID3"),this.writeU8(4),this.writeU8(0),this.writeU8(0),this.writeSynchsafeU32(0);let r=this.writer.getPos(),i=new Set;for(let{key:n,value:o}of cr(e))switch(n){case"title":this.writeId3V2TextFrame("TIT2",o),i.add("TIT2");break;case"description":this.writeId3V2TextFrame("TIT3",o),i.add("TIT3");break;case"artist":this.writeId3V2TextFrame("TPE1",o),i.add("TPE1");break;case"album":this.writeId3V2TextFrame("TALB",o),i.add("TALB");break;case"albumArtist":this.writeId3V2TextFrame("TPE2",o),i.add("TPE2");break;case"trackNumber":{let c=e.tracksTotal!==void 0?"".concat(o,"/").concat(e.tracksTotal):o.toString();this.writeId3V2TextFrame("TRCK",c),i.add("TRCK")}break;case"discNumber":{let c=e.discsTotal!==void 0?"".concat(o,"/").concat(e.discsTotal):o.toString();this.writeId3V2TextFrame("TPOS",c),i.add("TPOS")}break;case"genre":this.writeId3V2TextFrame("TCON",o),i.add("TCON");break;case"date":this.writeId3V2TextFrame("TDRC",o.toISOString().slice(0,10)),i.add("TDRC");break;case"lyrics":this.writeId3V2LyricsFrame(o),i.add("USLT");break;case"comment":this.writeId3V2CommentFrame(o),i.add("COMM");break;case"images":{let c={coverFront:3,coverBack:4,unknown:0};for(let l of o){let u=c[l.kind]??0,h=l.description??"";this.writeId3V2ApicFrame(l.mimeType,u,h,l.data)}}break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Me(n)}if(e.raw)for(let n in e.raw){let o=e.raw[n];if(o==null||n.length!==4||i.has(n))continue;let c;if(typeof o=="string"){let l=fe.encode(o);c=new Uint8Array(l.byteLength+2),c[0]=3,c.set(l,1)}else if(o instanceof Uint8Array)c=o;else continue;this.writeAscii(n),this.writeSynchsafeU32(c.byteLength),this.writeU16(0),this.writer.write(c)}let s=this.writer.getPos(),a=s-r;return this.writer.seek(t+6),this.writeSynchsafeU32(a),this.writer.seek(s),a+10}writeU8(e){this.helper[0]=e,this.writer.write(this.helper.subarray(0,1))}writeU16(e){this.helperView.setUint16(0,e,!1),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeAscii(e){for(let t=0;t<e.length;t++)this.helper[t]=e.charCodeAt(t);this.writer.write(this.helper.subarray(0,e.length))}writeSynchsafeU32(e){this.writeU32(fl(e))}writeIsoString(e){let t=new Uint8Array(e.length+1);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);t[e.length]=0,this.writer.write(t)}writeUtf8String(e){let t=fe.encode(e);this.writer.write(t),this.writeU8(0)}writeId3V2TextFrame(e,t){let r=xe(t),s=1+(r?t.length:fe.encode(t).byteLength)+1;this.writeAscii(e),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(r?0:3),r?this.writeIsoString(t):this.writeUtf8String(t)}writeId3V2LyricsFrame(e){let t=xe(e),r="",i=4+r.length+1+e.length+1;this.writeAscii("USLT"),this.writeSynchsafeU32(i),this.writeU16(0),this.writeU8(t?0:3),this.writeAscii("und"),t?(this.writeIsoString(r),this.writeIsoString(e)):(this.writeUtf8String(r),this.writeUtf8String(e))}writeId3V2CommentFrame(e){let t=xe(e),r=t?e.length:fe.encode(e).byteLength,i="",s=4+i.length+1+r+1;this.writeAscii("COMM"),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(t?0:3),this.writeU8(117),this.writeU8(110),this.writeU8(100),t?(this.writeIsoString(i),this.writeIsoString(e)):(this.writeUtf8String(i),this.writeUtf8String(e))}writeId3V2ApicFrame(e,t,r,i){let s=xe(e)&&xe(r),a=s?r.length:fe.encode(r).byteLength,n=1+e.length+1+1+a+1+i.byteLength;this.writeAscii("APIC"),this.writeSynchsafeU32(n),this.writeU16(0),this.writeU8(s?0:3),s?this.writeIsoString(e):this.writeUtf8String(e),this.writeU8(t),s?this.writeIsoString(r):this.writeUtf8String(r),this.writer.write(i)}},cs=async(e,t,r)=>{let i=t;for(;r===null||i<r;){let s=e.requestSlice(i,Ya);if(s instanceof Promise&&(s=await s),!s)break;let a=D(s),n=Ja(a,e.fileSize!==null?e.fileSize-i:null);if(n.header)return{header:n.header,startPos:i};i+=n.bytesAdvanced}return null},gl=class extends Zt{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.metadataTags=null,this.tracks=[],this.readingMutex=new Tt,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new rt(this.input,new wl(this))]})())}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let n=this.reader.requestSlice(this.lastLoadedPos,mi);if(n instanceof Promise&&(n=await n),!n){this.lastSampleLoaded=!0;return}let o=pi(n);if(!o)break;this.lastLoadedPos=n.filePos+o.size}let e=await cs(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}let t=e.header;this.lastLoadedPos=e.startPos+t.totalSize-1;let r=ns(t.mpegVersionId,t.channel),i=this.reader.requestSlice(e.startPos+r,4);if(i instanceof Promise&&(i=await i),i){let n=D(i);if(n===ss||n===Za)return}this.firstFrameHeader||(this.firstFrameHeader=t),t.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn("MP3 changed sample rate mid-file: ".concat(this.firstFrameHeader.sampleRate," Hz to ").concat(t.sampleRate," Hz. Might be a bug, so please report this file."));let s=t.audioSamplesInFrame/this.firstFrameHeader.sampleRate,a={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:s,dataStart:e.startPos,dataSize:t.totalSize};this.loadedSamples.push(a),this.nextTimestampInSamples+=t.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return d(e),e.computeDuration()}async getMetadataTags(){let e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let t=0,r=!1;for(;;){let i=this.reader.requestSlice(t,mi);if(i instanceof Promise&&(i=await i),!i)break;let s=pi(i);if(!s)break;r=!0;let a=this.reader.requestSlice(i.filePos,s.size);if(a instanceof Promise&&(a=await a),!a)break;en(a,s,this.metadataTags),t=i.filePos+s.size}if(!r&&this.reader.fileSize!==null&&this.reader.fileSize>=fi){let i=this.reader.requestSlice(this.reader.fileSize-fi,fi);i instanceof Promise&&(i=await i),d(i),Ce(i,3)==="TAG"&&ml(i,this.metadataTags)}return this.metadataTags}finally{e()}}},wl=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return $e}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return d(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=Ge;else{let s=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;i=Q(s,r.dataSize)}return new pe(i,"key",r.timestamp,r.duration,e,r.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=Ai(this.demuxer.loadedSamples,e.timestamp,a=>a.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let s=i+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=oe(this.demuxer.loadedSamples,e,s=>s.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,t);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,t);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},ls=1399285583,bl=79764919,rn=new Uint32Array(256);for(let e=0;e<256;e++){let t=e<<24;for(let r=0;r<8;r++)t=t&2147483648?t<<1^bl:t<<1;rn[e]=t>>>0&4294967295}var sn=e=>{let t=ee(e),r=t.getUint32(22,!0);t.setUint32(22,0,!0);let i=0;for(let s=0;s<e.length;s++){let a=e[s];i=(i<<8^rn[i>>>24^a])>>>0}return t.setUint32(22,r,!0),i},an=(e,t,r)=>{let i=0,s=null;if(e.length>0)if(t.codec==="vorbis"){d(t.vorbisInfo);let a=t.vorbisInfo.modeBlockflags.length,o=(1<<ac(a-1))-1<<1,c=(e[0]&o)>>1;if(c>=t.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let l=r,u=t.vorbisInfo.modeBlockflags[c];if(s=t.vorbisInfo.blocksizes[u],u===1){let h=(o|1)+1,f=e[0]&h?1:0;l=t.vorbisInfo.blocksizes[f]}i=l!==null?l+s>>2:0}else t.codec==="opus"&&(i=Rc(e).durationInSamples);return{durationInSamples:i,vorbisBlockSize:s}},nn=e=>{let t="audio/ogg";if(e.codecStrings){let r=[...new Set(e.codecStrings)];t+='; codecs="'.concat(r.join(", "),'"')}return t},tr=27,br=282,on=br+65025,Lr=e=>{let t=e.filePos;if(Tr(e)!==ls)return null;e.skip(1);let i=H(e),s=Wl(e),a=Tr(e),n=Tr(e),o=Tr(e),c=H(e),l=new Uint8Array(c);for(let g=0;g<c;g++)l[g]=H(e);let u=27+c,h=l.reduce((g,w)=>g+w,0),f=u+h;return{headerStartPos:t,totalSize:f,dataStartPos:t+u,dataSize:h,headerType:i,granulePosition:s,serialNumber:a,sequenceNumber:n,checksum:o,lacingValues:l}},kl=(e,t)=>{for(;e.filePos<t-3;){let r=Tr(e),i=r&255,s=r>>>8&255,a=r>>>16&255,n=r>>>24&255,o=79;if(!(i!==o&&s!==o&&a!==o&&n!==o)){if(e.skip(-4),r===ls)return!0;e.skip(1)}}return!1},yl=class extends Zt{constructor(e){super(e),this.metadataPromise=null,this.bitstreams=[],this.tracks=[],this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,tr,br);if(t instanceof Promise&&(t=await t),!t)break;let r=Lr(t);if(!r||!!!(r.headerType&2))break;this.bitstreams.push({serialNumber:r.serialNumber,bosPage:r,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=r.headerStartPos+r.totalSize}for(let t of this.bitstreams){let r=await this.readPacket(t.bosPage,0);r&&(r.data.byteLength>=7&&r.data[0]===1&&r.data[1]===118&&r.data[2]===111&&r.data[3]===114&&r.data[4]===98&&r.data[5]===105&&r.data[6]===115?await this.readVorbisMetadata(r,t):r.data.byteLength>=8&&r.data[0]===79&&r.data[1]===112&&r.data[2]===117&&r.data[3]===115&&r.data[4]===72&&r.data[5]===101&&r.data[6]===97&&r.data[7]===100&&await this.readOpusMetadata(r,t),t.codecInfo.codec!==null&&this.tracks.push(new rt(this.input,new Tl(t,this))))}})())}async readVorbisMetadata(e,t){let r=await this.findNextPacketStart(e);if(!r)return;let i=await this.readPacket(r.startPage,r.startSegmentIndex);if(!i||(r=await this.findNextPacketStart(i),!r))return;let s=await this.readPacket(r.startPage,r.startSegmentIndex);if(!s||i.data[0]!==3||s.data[0]!==5)return;let a=[],n=u=>{for(;a.push(Math.min(255,u)),!(u<255);)u-=255};n(e.data.length),n(i.data.length);let o=new Uint8Array(1+a.length+e.data.length+i.data.length+s.data.length);o[0]=2,o.set(a,1),o.set(e.data,1+a.length),o.set(i.data,1+a.length+e.data.length),o.set(s.data,1+a.length+e.data.length+i.data.length),t.codecInfo.codec="vorbis",t.description=o,t.lastMetadataPacket=s;let c=ee(e.data);t.numberOfChannels=c.getUint8(11),t.sampleRate=c.getUint32(12,!0);let l=c.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:Ea(s.data).modeBlockflags},Ui(i.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,t){let r=await this.findNextPacketStart(e);if(!r)return;let i=await this.readPacket(r.startPage,r.startSegmentIndex);if(!i)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=i;let s=ai(e.data);t.numberOfChannels=s.outputChannelCount,t.sampleRate=ur,t.codecInfo.opusInfo={preSkip:s.preSkip},Ui(i.data.subarray(8),this.metadataTags)}async readPacket(e,t){d(t<e.lacingValues.length);let r=0;for(let u=0;u<t;u++)r+=e.lacingValues[u];let i=e,s=r,a=t,n=[];e:for(;;){let u=this.reader.requestSlice(i.dataStartPos,i.dataSize);u instanceof Promise&&(u=await u),d(u);let h=Q(u,i.dataSize);for(;;){if(a===i.lacingValues.length){n.push(h.subarray(r,s));break}let g=i.lacingValues[a];if(s+=g,g<255){n.push(h.subarray(r,s));break e}a++}let f=i.headerStartPos+i.totalSize;for(;;){let g=this.reader.requestSliceRange(f,tr,br);if(g instanceof Promise&&(g=await g),!g)return null;let w=Lr(g);if(!w)return null;if(i=w,i.serialNumber===e.serialNumber)break;f=i.headerStartPos+i.totalSize}r=0,s=0,a=0}let o=n.reduce((u,h)=>u+h.length,0),c=new Uint8Array(o),l=0;for(let u=0;u<n.length;u++){let h=n[u];c.set(h,l),l+=h.length}return{data:c,endPage:i,endSegmentIndex:a}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let r=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let i=this.reader.requestSliceRange(r,tr,br);if(i instanceof Promise&&(i=await i),!i)return null;let s=Lr(i);if(!s)return null;if(s.serialNumber===e.endPage.serialNumber)return{startPage:s,startSegmentIndex:0};r=s.headerStartPos+s.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(t=>t.getCodecParameterString()));return nn({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Tl=class{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.sequentialScanCache=[],this.sequentialScanMutex=new Tt,this.internalSampleRate=e.codecInfo.codec==="opus"?ur:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return d(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return $e}async getFirstTimestamp(){return 0}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(d(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,r){if(!e)return null;let{durationInSamples:i,vorbisBlockSize:s}=an(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),a=new pe(r.metadataOnly?Ge:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,i/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(a,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:i,vorbisLastBlockSize:t.vorbisLastBlocksize,vorbisBlockSize:s}),a}async getFirstPacket(e){d(this.bitstream.lastMetadataPacket);let t=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!t)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(d(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let i=await this.demuxer.readPacket(t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:r,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){let r=this.encodedPacketToMetadata.get(e);if(!r)throw new Error("Packet was not created from this track.");let i=await this.demuxer.findNextPacketStart(r.packet);if(!i)return null;let s=r.timestampInSamples+r.durationInSamples,a=await this.demuxer.readPacket(i.startPage,i.startSegmentIndex);return this.createEncodedPacketFromOggPacket(a,{timestampInSamples:s,vorbisLastBlocksize:r.vorbisBlockSize},t)}async getPacket(e,t){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(e,t);let r=Jr(e*this.internalSampleRate,14);if(r===0)return this.getFirstPacket(t);if(r<0)return null;d(this.bitstream.lastMetadataPacket);let i=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!i)return null;let s=i.startPage,a=this.demuxer.reader.fileSize,n=[s];e:for(;s.headerStartPos+s.totalSize<a;){let b=s.headerStartPos,T=Math.floor((b+a)/2),v=T;for(;;){let P=Math.min(v+on,a-tr),A=this.demuxer.reader.requestSlice(v,P-v);if(A instanceof Promise&&(A=await A),d(A),!kl(A,P)){a=T+tr;continue e}let M=this.demuxer.reader.requestSliceRange(A.filePos,tr,br);M instanceof Promise&&(M=await M),d(M);let L=Lr(M);d(L);let ue=!1;if(L.serialNumber===this.bitstream.serialNumber)ue=!0;else{let V=this.demuxer.reader.requestSlice(L.headerStartPos,L.totalSize);V instanceof Promise&&(V=await V),d(V);let J=Q(V,L.totalSize);ue=sn(J)===L.checksum}if(!ue){v=L.headerStartPos+4;continue}if(ue&&L.serialNumber!==this.bitstream.serialNumber){v=L.headerStartPos+L.totalSize;continue}if(L.granulePosition===-1){v=L.headerStartPos+L.totalSize;continue}this.granulePositionToTimestampInSamples(L.granulePosition)>r?a=L.headerStartPos:(s=L,n.push(L));continue e}}let o=i.startPage;for(let b of n){if(b.granulePosition===s.granulePosition)break;(!o||b.headerStartPos>o.headerStartPos)&&(o=b)}let c=o,l=[c];for(;!(c.serialNumber===this.bitstream.serialNumber&&c.granulePosition===s.granulePosition);){let b=c.headerStartPos+c.totalSize,T=this.demuxer.reader.requestSliceRange(b,tr,br);T instanceof Promise&&(T=await T),d(T);let v=Lr(T);d(v),c=v,c.serialNumber===this.bitstream.serialNumber&&l.push(c)}d(c.granulePosition!==-1);let u=null,h,f,g=c,w=0;if(c.headerStartPos===i.startPage.headerStartPos)h=this.granulePositionToTimestampInSamples(0),f=!0,u=0;else{h=0,f=!1;for(let v=c.lacingValues.length-1;v>=0;v--)if(c.lacingValues[v]<255){u=v+1;break}if(u===null)throw new Error("Invalid page with granule position: no packets end on this page.");w=u-1;let b={data:Ge,endPage:g,endSegmentIndex:w};if(await this.demuxer.findNextPacketStart(b)){let v=ln(l,c,u);d(v);let P=cn(l,v.page,v.segmentIndex);P&&(c=P.page,u=P.segmentIndex)}else for(;;){let v=ln(l,c,u);if(!v)break;let P=cn(l,v.page,v.segmentIndex);if(!P)break;if(c=P.page,u=P.segmentIndex,v.page.headerStartPos!==g.headerStartPos){g=v.page,w=v.segmentIndex;break}}}let p=null,y=null;for(;c!==null;){d(u!==null);let b=await this.demuxer.readPacket(c,u);if(!b)break;if(!(c.headerStartPos===i.startPage.headerStartPos&&u<i.startSegmentIndex)){let P=this.createEncodedPacketFromOggPacket(b,{timestampInSamples:h,vorbisLastBlocksize:y?.vorbisBlockSize??null},t);d(P);let A=this.encodedPacketToMetadata.get(P);if(d(A),!f&&b.endPage.headerStartPos===g.headerStartPos&&b.endSegmentIndex===w?(h=this.granulePositionToTimestampInSamples(c.granulePosition),f=!0,P=this.createEncodedPacketFromOggPacket(b,{timestampInSamples:h-A.durationInSamples,vorbisLastBlocksize:y?.vorbisBlockSize??null},t),d(P),A=this.encodedPacketToMetadata.get(P),d(A)):h+=A.durationInSamples,p=P,y=A,f&&(Math.max(h,0)>r||Math.max(A.timestampInSamples,0)===r))break}let v=await this.demuxer.findNextPacketStart(b);if(!v)break;c=v.startPage,u=v.startSegmentIndex}return p}async getPacketSequential(e,t){let r=await this.sequentialScanMutex.acquire();try{let i=Jr(e*this.internalSampleRate,14);e=i/this.internalSampleRate;let s=oe(this.sequentialScanCache,i,o=>o.timestampInSamples),a;if(s!==-1){let o=this.sequentialScanCache[s];a=this.createEncodedPacketFromOggPacket(o.packet,{timestampInSamples:o.timestampInSamples,vorbisLastBlocksize:o.vorbisLastBlockSize},t)}else a=await this.getFirstPacket(t);let n=0;for(;a&&a.timestamp<e;){let o=await this.getNextPacket(a,t);if(!o||o.timestamp>e)break;if(a=o,n++,n===100){n=0;let c=this.encodedPacketToMetadata.get(a);d(c),this.sequentialScanCache.length>0&&d(ce(this.sequentialScanCache).timestampInSamples<=c.timestampInSamples),this.sequentialScanCache.push(c)}}return a}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},cn=(e,t,r)=>{let i=t,s=r;e:for(;;){for(s--,s;s>=0;s--)if(i.lacingValues[s]<255){s++;break e}if(d(s===-1),!(i.headerType&1)){s=0;break}let n=ta(e,o=>o.headerStartPos<i.headerStartPos);if(!n)return null;i=n,s=i.lacingValues.length}if(d(s!==-1),s===i.lacingValues.length){let a=e[e.indexOf(i)+1];d(a),i=a,s=0}return{page:i,segmentIndex:s}},ln=(e,t,r)=>{if(r>0)return{page:t,segmentIndex:r-1};let i=ta(e,s=>s.headerStartPos<t.headerStartPos);return i?{page:i,segmentIndex:i.lacingValues.length-1}:null},Sl=class extends Zt{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.lastKnownPacketIndex=0,this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),d(e);let t=Ce(e,4),r=t!=="RIFX",i=t==="RF64",s=Vt(e,r),a=i?this.reader.fileSize:Math.min(s+8,this.reader.fileSize??1/0);if(Ce(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let o=0,c=null,l=e.filePos;for(;a===null||l<a;){let h=this.reader.requestSlice(l,8);if(h instanceof Promise&&(h=await h),!h)break;let f=Ce(h,4),g=Vt(h,r),w=h.filePos;if(i&&o===0&&f!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(f==="fmt ")await this.parseFmtChunk(w,g,r);else if(f==="data"){if(c??(c=g),this.dataStart=h.filePos,this.dataSize=Math.min(c,(a??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(f==="ds64"){let p=this.reader.requestSlice(w,g);if(p instanceof Promise&&(p=await p),!p)break;let y=zn(p,r);c=zn(p,r),a=Math.min(y+8,this.reader.fileSize??1/0)}else f==="LIST"?await this.parseListChunk(w,g,r):(f==="ID3 "||f==="id3 ")&&await this.parseId3Chunk(w,g);l=w+g+(g&1),o++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let u=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/u)*u,this.tracks.push(new rt(this.input,new vl(this)))})())}async parseFmtChunk(e,t,r){let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;let s=Vr(i,r),a=Vr(i,r),n=Vt(i,r);i.skip(4);let o=Vr(i,r),c;if(t===14?c=8:c=Vr(i,r),t>=18&&s!==357){let l=Vr(i,r),u=t-18;if(Math.min(u,l)>=22&&s===65534){i.skip(6);let f=Q(i,16);s=f[0]|f[1]<<8}}(s===7||s===6)&&(c=8),this.audioInfo={format:s,numberOfChannels:a,sampleRate:n,sampleSizeInBytes:Math.ceil(c/8),blockSizeInBytes:o}}async parseListChunk(e,t,r){var n,o,c,l,u,h,f,g,w,p,y;let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;let s=Ce(i,4);if(s!=="INFO"&&s!=="INF0")return;let a=i.filePos;for(;a<=e+t-8;){i.filePos=a;let b=Ce(i,4),T=Vt(i,r),v=Q(i,T),P=0;for(let I=0;I<v.length&&v[I]!==0;I++)P++;let A=String.fromCharCode(...v.subarray(0,P));switch((n=this.metadataTags).raw??(n.raw={}),this.metadataTags.raw[b]=A,b){case"INAM":case"TITL":(o=this.metadataTags).title??(o.title=A);break;case"TIT3":(c=this.metadataTags).description??(c.description=A);break;case"IART":(l=this.metadataTags).artist??(l.artist=A);break;case"IPRD":(u=this.metadataTags).album??(u.album=A);break;case"IPRT":case"ITRK":case"TRCK":{let I=A.split("/"),M=Number.parseInt(I[0],10),L=I[1]&&Number.parseInt(I[1],10);Number.isInteger(M)&&M>0&&((h=this.metadataTags).trackNumber??(h.trackNumber=M)),L&&Number.isInteger(L)&&L>0&&((f=this.metadataTags).tracksTotal??(f.tracksTotal=L))}break;case"ICRD":case"IDIT":{let I=new Date(A);Number.isNaN(I.getTime())||((g=this.metadataTags).date??(g.date=I))}break;case"YEAR":{let I=Number.parseInt(A,10);Number.isInteger(I)&&I>0&&((w=this.metadataTags).date??(w.date=new Date(I,0,1)))}break;case"IGNR":case"GENR":(p=this.metadataTags).genre??(p.genre=A);break;case"ICMT":case"CMNT":case"COMM":(y=this.metadataTags).comment??(y.comment=A);break}a+=8+T+(T&1)}}async parseId3Chunk(e,t){let r=this.reader.requestSlice(e,t);if(r instanceof Promise&&(r=await r),!r)return;let i=pi(r);if(i){let s=r.slice(e+10,i.size);en(s,i,this.metadataTags)}}getCodec(){if(d(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return d(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},kr=2048,vl=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let e=this.demuxer.getCodec();return e?(d(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getNumberOfChannels(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return $e}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){d(this.demuxer.audioInfo);let r=e*kr*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(kr*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(this.demuxer.reader.fileSize===null){let o=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);if(o instanceof Promise&&(o=await o),!o)return null}let s;if(t.metadataOnly)s=Ge;else{let o=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);o instanceof Promise&&(o=await o),d(o),s=Q(o,i)}let a=e*kr/this.demuxer.audioInfo.sampleRate,n=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(e,a),new pe(s,"key",a,n,e,i)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getPacket(e,t){d(this.demuxer.audioInfo);let r=Math.floor(Math.min(e*this.demuxer.audioInfo.sampleRate/kr,(this.demuxer.dataSize-1)/(kr*this.demuxer.audioInfo.blockSizeInBytes))),i=await this.getPacketAtIndex(r,t);if(i)return i;if(r===0)return null;d(this.demuxer.reader.fileSize===null);let s=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,t);for(;s;){let a=await this.getNextPacket(s,t);if(!a)break;s=a}return s}getNextPacket(e,t){d(this.demuxer.audioInfo);let r=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/kr);return this.getPacketAtIndex(r+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},gi=7,wi=9,us=e=>{let t=e.filePos,r=Q(e,9),i=new ne(r);if(i.readBits(12)!==4095||(i.skipBits(1),i.readBits(2)!==0))return null;let n=i.readBits(1),o=i.readBits(2)+1,c=i.readBits(4);if(c===15)return null;i.skipBits(1);let l=i.readBits(3);if(l===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);let u=i.readBits(13);i.skipBits(11);let h=i.readBits(2)+1;if(h!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return n===1?e.filePos-=2:f=i.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:l,frameLength:u,numberOfAacFrames:h,crcCheck:f,startPos:t}},ds=1024,_l=class extends Zt{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.readingMutex=new Tt,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();d(this.firstFrameHeader),this.tracks=[new rt(this.input,new Cl(this))]})())}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,gi,wi);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}let t=us(e);if(!t){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&t.startPos+t.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=t);let r=ii[t.samplingFrequencyIndex];d(r!==void 0);let i=ds/r,s=t.crcCheck?wi:gi,a={timestamp:this.nextTimestampInSamples/r,duration:i,dataStart:t.startPos+s,dataSize:t.frameLength-s};this.loadedSamples.push(a),this.nextTimestampInSamples+=ds,this.lastLoadedPos=t.startPos+t.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return d(e),e.computeDuration()}async getMetadataTags(){return{}}},Cl=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/ds}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return $e}getCodec(){return"aac"}getInternalCodecId(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){d(this.demuxer.firstFrameHeader);let e=ga[this.demuxer.firstFrameHeader.channelConfiguration];return d(e!==void 0),e}getSampleRate(){d(this.demuxer.firstFrameHeader);let e=ii[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return d(e!==void 0),e}async getDecoderConfig(){d(this.demuxer.firstFrameHeader);let e=new Uint8Array(3),t=new ne(e),{objectType:r,samplingFrequencyIndex:i,channelConfiguration:s}=this.demuxer.firstFrameHeader;return r>31?(t.writeBits(5,31),t.writeBits(6,r-32)):t.writeBits(5,r),t.writeBits(4,i),t.writeBits(4,s),{codec:"mp4a.40.".concat(this.demuxer.firstFrameHeader.objectType),numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:e.subarray(0,Math.ceil((t.pos-1)/8))}}async getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=Ge;else{let s=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;i=Q(s,r.dataSize)}return new pe(i,"key",r.timestamp,r.duration,e,r.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=Ai(this.demuxer.loadedSamples,e.timestamp,a=>a.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let s=i+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=oe(this.demuxer.loadedSamples,e,s=>s.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,t);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,t);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},un=e=>e===0?null:e===1?192:e>=2&&e<=5?144*2**e:e===6?"uncommon-u8":e===7?"uncommon-u16":e>=8&&e<=15?2**e:null,xl=(e,t)=>{switch(e){case 0:return t;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},dn=e=>{let t=0,r=new ne(Q(e,1));for(;r.readBits(1)===1;)t++;if(t===0)return r.readBits(7);let i=[],s=t-1,a=new ne(Q(e,s)),n=8-t-1;for(let c=0;c<n;c++)i.unshift(r.readBits(1));for(let c=0;c<s;c++)for(let l=0;l<8;l++){let u=a.readBits(1);l<2||i.unshift(u)}return i.reduce((c,l,u)=>c|l<<u,0)},hn=(e,t)=>{if(t==="uncommon-u16")return Pe(e)+1;if(t==="uncommon-u8")return H(e)+1;if(typeof t=="number")return t;Me(t),d(!1)},Pl=(e,t)=>t==="uncommon-u16"?Pe(e):t==="uncommon-u16-10"?Pe(e)*10:t==="uncommon-u8"?H(e):typeof t=="number"?t:null,Il=e=>{let r=0;for(let i of e){r^=i;for(let s=0;s<8;s++)(r&128)!==0?r=r<<1^7:r<<=1,r&=255}return r},El=class extends Zt{constructor(e){super(e),this.loadedSamples=[],this.metadataPromise=null,this.track=null,this.metadataTags={},this.audioInfo=null,this.lastLoadedPos=null,this.blockingBit=null,this.readingMutex=new Tt,this.lastSampleLoaded=!1,this.reader=e._reader}async computeDuration(){return await this.readMetadata(),d(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),d(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??(this.metadataPromise=(async()=>{var t;for(;this.reader.fileSize===null||e<this.reader.fileSize;){let r=this.reader.requestSlice(e,4);if(r instanceof Promise&&(r=await r),e+=4,r===null)throw new Error("Metadata block at position ".concat(e," is too small! Corrupted file."));d(r);let i=H(r),s=yr(r),a=(i&128)!==0;switch(i&127){case 0:{let o=this.reader.requestSlice(e,s);if(o instanceof Promise&&(o=await o),d(o),o===null)throw new Error("StreamInfo block at position ".concat(e," is too small! Corrupted file."));let c=Q(o,34),l=new ne(c),u=l.readBits(16),h=l.readBits(16),f=l.readBits(24),g=l.readBits(24),w=l.readBits(20),p=l.readBits(3)+1;l.readBits(5);let y=l.readBits(36);l.skipBits(128);let b=new Uint8Array(42);b.set(new Uint8Array([102,76,97,67]),0),b.set(new Uint8Array([128,0,0,34]),4),b.set(c,8),this.audioInfo={numberOfChannels:p,sampleRate:w,totalSamples:y,minimumBlockSize:u,maximumBlockSize:h,minimumFrameSize:f,maximumFrameSize:g,description:b},this.track=new rt(this.input,new Al(this));break}case 4:{let o=this.reader.requestSlice(e,s);o instanceof Promise&&(o=await o),d(o),Ui(Q(o,s),this.metadataTags);break}case 6:{let o=this.reader.requestSlice(e,s);o instanceof Promise&&(o=await o),d(o);let c=D(o),l=D(o),u=Se.decode(Q(o,l)),h=D(o),f=Se.decode(Q(o,h));o.skip(16);let g=D(o),w=Q(o,g);(t=this.metadataTags).images??(t.images=[]),this.metadataTags.images.push({data:w,mimeType:u,kind:c===3?"coverFront":c===4?"coverBack":"unknown",description:f});break}default:break}if(e+=s,a){this.lastLoadedPos=e;break}}})())}async readNextFlacFrame({startPos:e,isFirstPacket:t}){d(this.audioInfo);let r=6,s=this.audioInfo.maximumFrameSize+16,a=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,s);if(!a)return null;let n=this.readFlacFrameHeader({slice:a,isFirstPacket:t});if(!n)return null;for(a.filePos=e+this.audioInfo.minimumFrameSize;;){if(a.filePos>a.end-r)return{num:n.num,blockSize:n.blockSize,sampleRate:n.sampleRate,size:a.end-e,isLastFrame:!0};if(H(a)===255){let c=H(a),l=this.blockingBit===1?249:248;if(c!==l){a.skip(-1);continue}a.skip(-2);let u=a.filePos-e;if(!this.readFlacFrameHeader({slice:a,isFirstPacket:!1})){a.skip(-1);continue}return{num:n.num,blockSize:n.blockSize,sampleRate:n.sampleRate,size:u,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:t}){let r=e.filePos,i=Q(e,4),s=new ne(i);if(s.readBits(15)!==32764)return null;if(this.blockingBit===null){d(t);let p=s.readBits(1);this.blockingBit=p}else if(this.blockingBit===1){if(d(!t),s.readBits(1)!==1)return null}else if(this.blockingBit===0){if(d(!t),s.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");let n=un(s.readBits(4));if(!n)return null;d(this.audioInfo);let o=xl(s.readBits(4),this.audioInfo.sampleRate);if(!o||(s.readBits(4),s.readBits(3),s.readBits(1)!==0))return null;let l=dn(e),u=hn(e,n),h=Pl(e,o);if(h===null)return null;let f=e.filePos-r,g=H(e);e.skip(-f),e.skip(-1);let w=Il(Q(e,f));return g!==w?null:{num:l,blockSize:u,sampleRate:h}}async advanceReader(){await this.readMetadata(),d(this.lastLoadedPos!==null),d(this.audioInfo);let e=this.lastLoadedPos,t=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!t){this.lastSampleLoaded=!0;return}let r=this.loadedSamples[this.loadedSamples.length-1],s={blockOffset:r?r.blockOffset+r.blockSize:0,blockSize:t.blockSize,byteOffset:e,byteSize:t.size};if(this.lastLoadedPos=this.lastLoadedPos+t.size,this.loadedSamples.push(s),t.isLastFrame){this.lastSampleLoaded=!0;return}}},Al=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getSampleRate(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return $e}getTimeResolution(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}async getFirstTimestamp(){return 0}async getDecoderConfig(){return d(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(e,t){if(d(this.demuxer.audioInfo),e<0)throw new Error("Timestamp cannot be negative");let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=oe(this.demuxer.loadedSamples,e,o=>o.blockOffset/this.demuxer.audioInfo.sampleRate);if(i===-1){await this.demuxer.advanceReader();continue}let s=this.demuxer.loadedSamples[i],a=s.blockOffset/this.demuxer.audioInfo.sampleRate,n=s.blockSize/this.demuxer.audioInfo.sampleRate;if(a+n<=e){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,t);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(i,t)}}finally{r()}}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=e.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&i>=this.demuxer.loadedSamples.length)return null;for(;i>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(i,t)}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}async getPacketAtIndex(e,t){let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=Ge;else{let n=this.demuxer.reader.requestSlice(r.byteOffset,r.byteSize);if(n instanceof Promise&&(n=await n),!n)return null;i=Q(n,r.byteSize)}d(this.demuxer.audioInfo);let s=r.blockOffset/this.demuxer.audioInfo.sampleRate,a=r.blockSize/this.demuxer.audioInfo.sampleRate;return new pe(i,"key",s,a,e,r.byteSize)}async getFirstPacket(e){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,e)}},xt=class{},hs=class extends xt{async _getMajorBrand(e){let t=e._reader.requestSlice(0,12);return t instanceof Promise&&(t=await t),!t||(t.skip(4),Ce(t,4)!=="ftyp")?null:Ce(t,4)}_createDemuxer(e){return new Xc(e)}},fn=class extends hs{async _canReadInput(e){let t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},mn=class extends hs{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},fs=class extends xt{async isSupportedEBMLOfDocType(e,t){let r=e._reader.requestSlice(0,_t);if(r instanceof Promise&&(r=await r),!r)return!1;let i=$a(r);if(i===null||i<1||i>8||se(r,i)!==440786851)return!1;let a=ja(r);if(a===null)return!1;let n=e._reader.requestSlice(r.filePos,a);if(n instanceof Promise&&(n=await n),!n)return!1;let o=r.filePos;for(;n.filePos<=o+a-it;){let c=Ct(n);if(!c)break;let{id:l,size:u}=c,h=n.filePos;if(u===null)return!1;switch(l){case 17030:if(se(n,u)!==1)return!1;break;case 17143:if(se(n,u)!==1)return!1;break;case 17026:if(pr(n,u)!==t)return!1;break;case 17031:if(se(n,u)>4)return!1;break}n.filePos=h+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new cl(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},pn=class extends fs{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},gn=class extends xt{async _canReadInput(e){let t=e._reader.requestSlice(0,10);if(t instanceof Promise&&(t=await t),!t)return!1;let r=0,i=!1;for(;;){let c=e._reader.requestSlice(r,mi);if(c instanceof Promise&&(c=await c),!c)break;let l=pi(c);if(!l)break;i=!0,r=c.filePos+l.size}let s=await cs(e._reader,r,r+4096);if(!s)return!1;if(i)return!0;r=s.startPos+s.header.totalSize;let a=await cs(e._reader,r,r+Ya);if(!a)return!1;let n=s.header,o=a.header;return!(n.channel!==o.channel||n.sampleRate!==o.sampleRate)}_createDemuxer(e){return new gl(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},wn=class extends xt{async _canReadInput(e){let t=e._reader.requestSlice(0,12);if(t instanceof Promise&&(t=await t),!t)return!1;let r=Ce(t,4);return r!=="RIFF"&&r!=="RIFX"&&r!=="RF64"?!1:(t.skip(4),Ce(t,4)==="WAVE")}_createDemuxer(e){return new Sl(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},bn=class extends xt{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Ce(t,4)==="OggS":!1}_createDemuxer(e){return new yl(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},kn=class extends xt{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Ce(t,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(e){return new El(e)}},yn=class extends xt{async _canReadInput(e){let t=e._reader.requestSliceRange(0,gi,wi);if(t instanceof Promise&&(t=await t),!t)return!1;let r=us(t);if(!r||(t=e._reader.requestSliceRange(r.frameLength,gi,wi),t instanceof Promise&&(t=await t),!t))return!1;let i=us(t);return i?r.objectType===i.objectType&&r.samplingFrequencyIndex===i.samplingFrequencyIndex&&r.channelConfiguration===i.channelConfiguration:!1}_createDemuxer(e){return new _l(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},Tn=new fn,Sn=new mn,vn=new fs,_n=new pn,Cn=new gn,xn=new wn,Pn=new bn,In=new yn,En=new kn,Bl=[Tn,Sn,vn,_n,xn,Pn,En,Cn,In],An=qe(Be(),1),Ml=typeof An<"u"?An:void 0,Lt=class{constructor(){this._disposed=!1,this._sizePromise=null,this.onread=null}async getSizeOrNull(){if(this._disposed)throw new Ue;return this._sizePromise??(this._sizePromise=Promise.resolve(this._retrieveSize()))}async getSize(){if(this._disposed)throw new Ue;let e=await this.getSizeOrNull();if(e===null)throw new Error("Cannot determine the size of an unsized source.");return e}},Fl=class extends Lt{constructor(e){if(!(e instanceof ArrayBuffer)&&!ArrayBuffer.isView(e))throw new TypeError("buffer must be an ArrayBuffer or ArrayBufferView.");super(),this._onreadCalled=!1,this._bytes=le(e),this._view=ee(e)}_retrieveSize(){return this._bytes.byteLength}_read(){return this._onreadCalled||(this.onread?.(0,this._bytes.byteLength),this._onreadCalled=!0),{bytes:this._bytes,view:this._view,offset:0}}_dispose(){}},zl=class extends Lt{constructor(e,t={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!lr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._readers=new WeakMap,this._blob=e,this._orchestrator=new ps({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:ms.fileSystem})}_retrieveSize(){let e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){let t=this._readers.get(e);for(t===void 0&&("stream"in this._blob?t=this._blob.slice(e.currentPos).stream().getReader():t=null,this._readers.set(e,t));e.currentPos<e.targetPos&&!e.aborted;)if(t){let{done:r,value:i}=await t.read();if(r){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Blob reader stopped unexpectedly before all requested data was read.");break}this.onread?.(e.currentPos,e.currentPos+i.length),this._orchestrator.supplyWorkerData(e,i)}else{let r=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();this.onread?.(e.currentPos,e.currentPos+r.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(r))}e.running=!1}_dispose(){this._orchestrator.dispose()}},Bn=.5*2**20,Rl=(e,t,r)=>{if(t instanceof Error&&(t.message.includes("Failed to fetch")||t.message.includes("Load failed")||t.message.includes("NetworkError when attempting to fetch resource"))){let s=null;try{typeof window<"u"&&typeof window.location<"u"&&(s=new URL(r instanceof Request?r.url:r,window.location.href).origin)}catch{}if((typeof navigator<"u"&&typeof navigator.onLine=="boolean"?navigator.onLine:!0)&&s!==null&&s!==window.location.origin)return null}return Math.min(2**(e-2),16)},Dl=class extends Lt{constructor(e,t={}){if(typeof e!="string"&&!(e instanceof URL)&&!(typeof Request<"u"&&e instanceof Request))throw new TypeError("url must be a string, URL or Request.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.requestInit!==void 0&&(!t.requestInit||typeof t.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(t.getRetryDelay!==void 0&&typeof t.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");if(t.maxCacheSize!==void 0&&(!lr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(t.fetchFn!==void 0&&typeof t.fetchFn!="function")throw new TypeError("options.fetchFn, when provided, must be a function.");super(),this._existingResponses=new WeakMap,this._url=e,this._options=t,this._getRetryDelay=t.getRetryDelay??Rl,this._orchestrator=new ps({maxCacheSize:t.maxCacheSize??64*2**20,maxWorkerCount:2,runWorker:this._runWorker.bind(this),prefetchProfile:ms.network})}async _retrieveSize(){let e=new AbortController,t=await na(this._options.fetchFn??fetch,this._url,sa(this._options.requestInit??{},{headers:{Range:"bytes=0-"},signal:e.signal}),this._getRetryDelay);if(!t.ok)throw new Error("Error fetching ".concat(String(this._url),": ").concat(t.status," ").concat(t.statusText));let r,i;if(t.status===206)i=this._getPartialLengthFromRangeResponse(t),r=this._orchestrator.createWorker(0,Math.min(i,Bn));else{let s=t.headers.get("Content-Length");if(s)i=Number(s),r=this._orchestrator.createWorker(0,i),this._orchestrator.options.maxCacheSize=1/0,console.warn("HTTP server did not respond with 206 Partial Content, meaning the entire remote resource now has to be downloaded. For efficient media file streaming across a network, please make sure your server supports range requests.");else throw new Error("HTTP response (status ".concat(t.status,") must surface Content-Length header."))}return this._orchestrator.fileSize=i,this._existingResponses.set(r,{response:t,abortController:e}),this._orchestrator.runWorker(r),i}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){for(;!e.aborted;){let t=this._existingResponses.get(e);this._existingResponses.delete(e);let r=t?.abortController,i=t?.response;if(r||(r=new AbortController,i=await na(this._options.fetchFn??fetch,this._url,sa(this._options.requestInit??{},{headers:{Range:"bytes=".concat(e.currentPos,"-")},signal:r.signal}),this._getRetryDelay)),d(i),!i.ok)throw new Error("Error fetching ".concat(String(this._url),": ").concat(i.status," ").concat(i.statusText));if(e.currentPos>0&&i.status!==206)throw new Error("HTTP server did not respond with 206 Partial Content to a range request. To enable efficient media file streaming across a network, please make sure your server supports range requests.");let s=this._getPartialLengthFromRangeResponse(i),a=e.targetPos-e.currentPos;if(s<a)throw new Error("HTTP response unexpectedly too short: Needed at least ".concat(a," bytes, got only ").concat(s,"."));if(!i.body)throw new Error("Missing HTTP response body stream. The used fetch function must provide the response body as a ReadableStream.");let n=i.body.getReader();for(;;){if(e.currentPos>=e.targetPos||e.aborted){r.abort(),e.running=!1;return}let o;try{o=await n.read()}catch(u){let h=this._getRetryDelay(1,u,this._url);if(h!==null){console.error("Error while reading response stream. Attempting to resume.",u),await new Promise(f=>setTimeout(f,1e3*h));break}else throw u}let{done:c,value:l}=o;if(c){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Response stream reader stopped unexpectedly before all requested data was read.");e.running=!1;return}this.onread?.(e.currentPos,e.currentPos+l.length),this._orchestrator.supplyWorkerData(e,l)}}e.running=!1}_getPartialLengthFromRangeResponse(e){let t=e.headers.get("Content-Range");if(t){let r=/\/(\d+)/.exec(t);if(r)return Number(r[1]);throw new Error("Invalid Content-Range header: ".concat(t))}else{let r=e.headers.get("Content-Length");if(r)return Number(r);throw new Error("Partial HTTP response (status 206) must surface either Content-Range or Content-Length header.")}}_dispose(){this._orchestrator.dispose()}},Ol=class extends Lt{constructor(e,t={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!lr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._fileHandle=null,this._streamSource=new Mn({getSize:async()=>(this._fileHandle=await Ml.fs.open(e,"r"),(await this._fileHandle.stat()).size),read:async(r,i)=>{d(this._fileHandle);let s=new Uint8Array(i-r);return await this._fileHandle.read(s,0,i-r,r),s},maxCacheSize:t.maxCacheSize,prefetchProfile:"fileSystem"})}_read(e,t){return this._streamSource._read(e,t)}_retrieveSize(){return this._streamSource._retrieveSize()}_dispose(){this._streamSource._dispose(),this._fileHandle?.close(),this._fileHandle=null}},Mn=class extends Lt{constructor(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(typeof e.getSize!="function")throw new TypeError("options.getSize must be a function.");if(typeof e.read!="function")throw new TypeError("options.read must be a function.");if(e.dispose!==void 0&&typeof e.dispose!="function")throw new TypeError("options.dispose, when provided, must be a function.");if(e.maxCacheSize!==void 0&&(!lr(e.maxCacheSize)||e.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(e.prefetchProfile&&!["none","fileSystem","network"].includes(e.prefetchProfile))throw new TypeError("options.prefetchProfile, when provided, must be one of 'none', 'fileSystem' or 'network'.");super(),this._options=e,this._orchestrator=new ps({maxCacheSize:e.maxCacheSize??8*2**20,maxWorkerCount:2,prefetchProfile:ms[e.prefetchProfile??"none"],runWorker:this._runWorker.bind(this)})}_retrieveSize(){let e=this._options.getSize();if(e instanceof Promise)return e.then(t=>{if(!Number.isInteger(t)||t<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=t,t});if(!Number.isInteger(e)||e<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){for(;e.currentPos<e.targetPos&&!e.aborted;){let t=e.currentPos,r=e.targetPos,i=this._options.read(e.currentPos,r);if(i instanceof Promise&&(i=await i),i instanceof Uint8Array){if(i=le(i),i.length!==r-e.currentPos)throw new Error("options.read returned a Uint8Array with unexpected length: Requested ".concat(r-e.currentPos," bytes, but got ").concat(i.length,"."));this.onread?.(e.currentPos,e.currentPos+i.length),this._orchestrator.supplyWorkerData(e,i)}else if(i instanceof ReadableStream){let s=i.getReader();for(;e.currentPos<r&&!e.aborted;){let{done:a,value:n}=await s.read();if(a){if(e.currentPos<r)throw new Error("ReadableStream returned by options.read ended before supplying enough data. Requested ".concat(r-t," bytes, but got ").concat(e.currentPos-t));break}if(!(n instanceof Uint8Array))throw new TypeError("ReadableStream returned by options.read must yield Uint8Array chunks.");let o=le(n);this.onread?.(e.currentPos,e.currentPos+o.length),this._orchestrator.supplyWorkerData(e,o)}}else throw new TypeError("options.read must return or resolve to a Uint8Array or a ReadableStream.")}e.running=!1}_dispose(){this._orchestrator.dispose(),this._options.dispose?.()}},Nl=class extends Lt{constructor(e,t={}){if(!(e instanceof ReadableStream))throw new TypeError("stream must be a ReadableStream.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!lr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._reader=null,this._cache=[],this._pendingSlices=[],this._currentIndex=0,this._targetIndex=0,this._maxRequestedIndex=0,this._endIndex=null,this._pulling=!1,this._stream=e,this._maxCacheSize=t.maxCacheSize??16*2**20}_retrieveSize(){return this._endIndex}_read(e,t){if(this._endIndex!==null&&t>this._endIndex)return null;this._maxRequestedIndex=Math.max(this._maxRequestedIndex,t);let r=oe(this._cache,e,l=>l.start),i=r!==-1?this._cache[r]:null;if(i&&i.start<=e&&t<=i.end)return{bytes:i.bytes,view:i.view,offset:i.start};let s=e,a=new Uint8Array(t-e);if(r!==-1)for(let l=r;l<this._cache.length;l++){let u=this._cache[l];if(u.start>=t)break;let h=Math.max(e,u.start);h>s&&this._throwDueToCacheMiss();let f=Math.min(t,u.end);h<f&&(a.set(u.bytes.subarray(h-u.start,f-u.start),h-e),s=f)}if(s===t)return{bytes:a,view:ee(a),offset:e};this._currentIndex>s&&this._throwDueToCacheMiss();let{promise:n,resolve:o,reject:c}=we();return this._pendingSlices.push({start:e,end:t,bytes:a,resolve:o,reject:c}),this._targetIndex=Math.max(this._targetIndex,t),this._pulling||(this._pulling=!0,this._pull().catch(l=>{if(this._pulling=!1,this._pendingSlices.length>0)this._pendingSlices.forEach(u=>u.reject(l)),this._pendingSlices.length=0;else throw l})),n}_throwDueToCacheMiss(){throw new Error("Read is before the cached region. With ReadableStreamSource, you must access the data more sequentially or increase the size of its cache.")}async _pull(){for(this._reader??(this._reader=this._stream.getReader());this._currentIndex<this._targetIndex&&!this._disposed;){let{done:e,value:t}=await this._reader.read();if(e){for(let s of this._pendingSlices)s.resolve(null);this._pendingSlices.length=0,this._endIndex=this._currentIndex;break}let r=this._currentIndex,i=this._currentIndex+t.byteLength;for(let s=0;s<this._pendingSlices.length;s++){let a=this._pendingSlices[s],n=Math.max(r,a.start),o=Math.min(i,a.end);n<o&&(a.bytes.set(t.subarray(n-r,o-r),n-a.start),o===a.end&&(a.resolve({bytes:a.bytes,view:ee(a.bytes),offset:a.start}),this._pendingSlices.splice(s,1),s--))}for(this._cache.push({start:r,end:i,bytes:t,view:ee(t),age:0});this._cache.length>0;){let s=this._cache[0];if(this._maxRequestedIndex-s.end<=this._maxCacheSize)break;this._cache.shift()}this._currentIndex+=t.byteLength}this._pulling=!1}_dispose(){this._pendingSlices.length=0,this._cache.length=0}},ms={none:(e,t)=>({start:e,end:t}),fileSystem:(e,t)=>(e=Math.floor((e-65536)/65536)*65536,t=Math.ceil((t+65536)/65536)*65536,{start:e,end:t}),network:(e,t,r)=>{e=Math.max(0,Math.floor((e-65536)/65536)*65536);for(let s of r){let n=Math.max((s.startPos+s.targetPos)/2,s.targetPos-8388608);if(Ri(e,t,n,s.targetPos)){let o=s.targetPos-s.startPos,c=Math.ceil((o+1)/8388608)*8388608,l=2**Math.ceil(Math.log2(o+1)),u=Math.min(l,c);t=Math.max(t,s.startPos+u)}}return t=Math.max(t,e+Bn),{start:e,end:t}}},ps=class{constructor(e){this.options=e,this.fileSize=null,this.nextAge=0,this.workers=[],this.cache=[],this.currentCacheSize=0,this.disposed=!1}read(e,t){d(this.fileSize!==null);let r=this.options.prefetchProfile(e,t,this.workers),i=Math.max(r.start,0),s=Math.min(r.end,this.fileSize);d(i<=e&&t<=s);let a=null,n=oe(this.cache,e,b=>b.start),o=n!==-1?this.cache[n]:null;o&&o.start<=e&&t<=o.end&&(o.age=this.nextAge++,a={bytes:o.bytes,view:o.view,offset:o.start});let c=oe(this.cache,i,b=>b.start),l=a?null:new Uint8Array(t-e),u=0,h=i,f=[];if(c!==-1){for(let b=c;b<this.cache.length;b++){let T=this.cache[b];if(T.start>=s)break;if(T.end<=i)continue;let v=Math.max(i,T.start),P=Math.min(s,T.end);if(d(v<=P),h<v&&f.push({start:h,end:v}),h=P,l){let A=Math.max(e,T.start),I=Math.min(t,T.end);if(A<I){let M=A-e;l.set(T.bytes.subarray(A-T.start,I-T.start),M),M===u&&(u=I-e)}}T.age=this.nextAge++}h<s&&f.push({start:h,end:s})}else f.push({start:i,end:s});if(l&&u>=l.length&&(a={bytes:l,view:ee(l),offset:e}),f.length===0)return d(a),a;let{promise:g,resolve:w,reject:p}=we(),y=[];for(let b of f){let T=Math.max(e,b.start),v=Math.min(t,b.end);T===b.start&&v===b.end?y.push(b):T<v&&y.push({start:T,end:v})}for(let b of f){let T=l&&{start:e,bytes:l,holes:y,resolve:w,reject:p},v=!1;for(let P of this.workers)if(Ri(b.start-131072,b.start,P.currentPos,P.targetPos)){P.targetPos=Math.max(P.targetPos,b.end),v=!0,T&&!P.pendingSlices.includes(T)&&P.pendingSlices.push(T),P.running||this.runWorker(P);break}if(!v){let P=this.createWorker(b.start,b.end);T&&(P.pendingSlices=[T]),this.runWorker(P)}}return a||(d(l),a=g.then(b=>({bytes:b,view:ee(b),offset:e}))),a}createWorker(e,t){let r={startPos:e,currentPos:e,targetPos:t,running:!1,aborted:!1,pendingSlices:[],age:this.nextAge++};for(this.workers.push(r);this.workers.length>this.options.maxWorkerCount;){let i=0,s=this.workers[0];for(let a=1;a<this.workers.length;a++){let n=this.workers[a];n.age<s.age&&(i=a,s=n)}if(s.running&&s.pendingSlices.length>0)break;s.aborted=!0,this.workers.splice(i,1)}return r}runWorker(e){d(!e.running),d(e.currentPos<e.targetPos),e.running=!0,e.age=this.nextAge++,this.options.runWorker(e).catch(t=>{if(e.running=!1,e.pendingSlices.length>0)e.pendingSlices.forEach(r=>r.reject(t)),e.pendingSlices.length=0;else throw t})}supplyWorkerData(e,t){if(this.disposed)return;let r=e.currentPos,i=r+t.length;this.insertIntoCache({start:r,end:i,bytes:t,view:ee(t),age:this.nextAge++}),e.currentPos+=t.length,e.targetPos=Math.max(e.targetPos,e.currentPos);for(let s=0;s<e.pendingSlices.length;s++){let a=e.pendingSlices[s],n=Math.max(r,a.start),o=Math.min(i,a.start+a.bytes.length);n<o&&a.bytes.set(t.subarray(n-r,o-r),n-a.start);for(let c=0;c<a.holes.length;c++){let l=a.holes[c];r<=l.start&&i>l.start&&(l.start=i),l.end<=l.start&&(a.holes.splice(c,1),c--)}a.holes.length===0&&(a.resolve(a.bytes),e.pendingSlices.splice(s,1),s--)}for(let s=0;s<this.workers.length;s++){let a=this.workers[s];e===a||a.running||Ri(r,i,a.currentPos,a.targetPos)&&(this.workers.splice(s,1),s--)}}forgetWorker(e){let t=this.workers.indexOf(e);d(t!==-1),this.workers.splice(t,1)}insertIntoCache(e){if(this.options.maxCacheSize===0)return;let t=oe(this.cache,e.start,r=>r.start)+1;if(t>0){let r=this.cache[t-1];if(r.end>=e.end)return;if(r.end>e.start){let i=new Uint8Array(e.end-r.start);i.set(r.bytes,0),i.set(e.bytes,e.start-r.start),this.currentCacheSize+=e.end-r.end,r.bytes=i,r.view=ee(i),r.end=e.end,t--,e=r}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length;for(let r=t+1;r<this.cache.length;r++){let i=this.cache[r];if(e.end<=i.start)break;if(e.end>=i.end){this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length,r--;continue}let s=new Uint8Array(i.end-e.start);s.set(e.bytes,0),s.set(i.bytes,i.start-e.start),this.currentCacheSize-=e.end-i.start,e.bytes=s,e.view=ee(s),e.end=i.end,this.cache.splice(r,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let r=0,i=this.cache[0];for(let s=1;s<this.cache.length;s++){let a=this.cache[s];a.age<i.age&&(r=s,i=a)}if(this.currentCacheSize-i.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length}}dispose(){for(let e of this.workers)e.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}};oa();var Fn=class{constructor(e){if(this._demuxerPromise=null,this._format=null,this._disposed=!1,!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof xt)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof Lt))throw new TypeError("options.source must be a Source.");if(e.source._disposed)throw new Error("options.source must not be disposed.");this._formats=e.formats,this._source=e.source,this._reader=new Ul(e.source)}get disposed(){return this._disposed}_getDemuxer(){return this._demuxerPromise??(this._demuxerPromise=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(let e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})())}get source(){return this._source}async getFormat(){return await this._getDemuxer(),d(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}},Ue=class extends Error{constructor(e="Input has been disposed."){super(e),this.name="InputDisposedError"}},Ul=class{constructor(e){this.source=e}requestSlice(e,t){if(this.source._disposed)throw new Ue;if(this.fileSize!==null&&e+t>this.fileSize)return null;let r=e+t,i=this.source._read(e,r);return i instanceof Promise?i.then(s=>s?new bi(s.bytes,s.view,s.offset,e,r):null):i?new bi(i.bytes,i.view,i.offset,e,r):null}requestSliceRange(e,t,r){if(this.source._disposed)throw new Ue;if(this.fileSize!==null)return this.requestSlice(e,_e(this.fileSize-e,t,r));{let i=this.requestSlice(e,r),s=a=>{if(a)return a;let n=c=>(d(c!==null),this.requestSlice(e,_e(c-e,t,r))),o=this.source._retrieveSize();return o instanceof Promise?o.then(n):n(o)};return i instanceof Promise?i.then(s):s(i)}}},bi=class Zs{constructor(t,r,i,s,a){this.bytes=t,this.view=r,this.offset=i,this.start=s,this.end=a,this.bufferPos=s-i}static tempFromBytes(t){return new Zs(t,ee(t),0,0,t.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(t){this.bufferPos=t-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(t){this.bufferPos+=t}slice(t,r=this.end-t){if(t<this.start||t+r>this.end)throw new RangeError("Slicing outside of original slice.");return new Zs(this.bytes,this.view,this.offset,t,t+r)}},Le=(e,t)=>{if(e.filePos<e.start||e.filePos+t>e.end)throw new RangeError("Tried reading [".concat(e.filePos,", ").concat(e.filePos+t,"), but slice is [").concat(e.start,", ").concat(e.end,"). This is likely an internal error, please report it alongside the file that caused it."))},Q=(e,t)=>{Le(e,t);let r=e.bytes.subarray(e.bufferPos,e.bufferPos+t);return e.bufferPos+=t,r},H=e=>(Le(e,1),e.view.getUint8(e.bufferPos++)),Vr=(e,t)=>{Le(e,2);let r=e.view.getUint16(e.bufferPos,t);return e.bufferPos+=2,r},Pe=e=>{Le(e,2);let t=e.view.getUint16(e.bufferPos,!1);return e.bufferPos+=2,t},yr=e=>{Le(e,3);let t=Yr(e.view,e.bufferPos,!1);return e.bufferPos+=3,t},gs=e=>{Le(e,2);let t=e.view.getInt16(e.bufferPos,!1);return e.bufferPos+=2,t},Vt=(e,t)=>{Le(e,4);let r=e.view.getUint32(e.bufferPos,t);return e.bufferPos+=4,r},D=e=>{Le(e,4);let t=e.view.getUint32(e.bufferPos,!1);return e.bufferPos+=4,t},Tr=e=>{Le(e,4);let t=e.view.getUint32(e.bufferPos,!0);return e.bufferPos+=4,t},rr=e=>{Le(e,4);let t=e.view.getInt32(e.bufferPos,!1);return e.bufferPos+=4,t},Ll=e=>{Le(e,4);let t=e.view.getInt32(e.bufferPos,!0);return e.bufferPos+=4,t},zn=(e,t)=>{let r,i;return t?(r=Vt(e,!0),i=Vt(e,!0)):(i=Vt(e,!1),r=Vt(e,!1)),i*4294967296+r},at=e=>{let t=D(e),r=D(e);return t*4294967296+r},Vl=e=>{let t=rr(e),r=D(e);return t*4294967296+r},Wl=e=>{let t=Tr(e);return Ll(e)*4294967296+t},Hl=e=>{Le(e,4);let t=e.view.getFloat32(e.bufferPos,!1);return e.bufferPos+=4,t},Rn=e=>{Le(e,8);let t=e.view.getFloat64(e.bufferPos,!1);return e.bufferPos+=8,t},Ce=(e,t)=>{Le(e,t);let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(e.bytes[e.bufferPos++]);return r},Dn=new Uint8Array([102,76,97,67]),ql=38,$l=34,jl=class extends Yt{constructor(e,t){super(e),this.metadataWritten=!1,this.blockSizes=[],this.frameSizes=[],this.sampleRate=null,this.channels=null,this.bitsPerSample=null,this.writer=e._writer,this.format=t}async start(){this.writer.write(Dn)}writeHeader({bitsPerSample:e,minimumBlockSize:t,maximumBlockSize:r,minimumFrameSize:i,maximumFrameSize:s,sampleRate:a,channels:n,totalSamples:o}){d(this.writer.getPos()===4);let c=!ri(this.output._metadataTags),l=new ne(new Uint8Array(4));l.writeBits(1,+!c),l.writeBits(7,0),l.writeBits(24,$l),this.writer.write(l.bytes);let u=new ne(new Uint8Array(18));if(u.writeBits(16,t),u.writeBits(16,r),u.writeBits(24,i),u.writeBits(24,s),u.writeBits(20,a),u.writeBits(3,n-1),u.writeBits(5,e-1),o>=2**32)throw new Error("This muxer only supports writing up to 2 ** 32 samples");u.writeBits(4,0),u.writeBits(32,o),this.writer.write(u.bytes),this.writer.write(new Uint8Array(16))}writePictureBlock(e){let t=32+e.mimeType.length+(e.description?.length??0)+e.data.length,r=new Uint8Array(t),i=0,s=ee(r);s.setUint32(i,e.kind==="coverFront"?3:e.kind==="coverBack"?4:0),i+=4,s.setUint32(i,e.mimeType.length),i+=4,r.set(fe.encode(e.mimeType),8),i+=e.mimeType.length,s.setUint32(i,e.description?.length??0),i+=4,r.set(fe.encode(e.description??""),i),i+=e.description?.length??0,i+=16,s.setUint32(i,e.data.length),i+=4,r.set(e.data,i),i+=e.data.length,d(i===t);let a=new ne(new Uint8Array(4));a.writeBits(1,0),a.writeBits(7,6),a.writeBits(24,t),this.writer.write(a.bytes),this.writer.write(r)}writeVorbisCommentAndPictureBlock(){if(this.writer.seek(ql+Dn.byteLength),ri(this.output._metadataTags)){this.metadataWritten=!0;return}let e=this.output._metadataTags.images??[];for(let i of e)this.writePictureBlock(i);let t=Li(new Uint8Array(0),this.output._metadataTags,!1),r=new ne(new Uint8Array(4));r.writeBits(1,1),r.writeBits(7,4),r.writeBits(24,t.length),this.writer.write(r.bytes),this.writer.write(t),this.metadataWritten=!0}async getMimeType(){return"audio/flac"}async addEncodedVideoPacket(){throw new Error("FLAC does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();dr(r),d(r),d(r.decoderConfig),d(r.decoderConfig.description);try{if(this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),this.sampleRate===null&&(this.sampleRate=r.decoderConfig.sampleRate),this.channels===null&&(this.channels=r.decoderConfig.numberOfChannels),this.bitsPerSample===null){let u=new ne(le(r.decoderConfig.description));u.skipBits(167);let h=u.readBits(5)+1;this.bitsPerSample=h}this.metadataWritten||this.writeVorbisCommentAndPictureBlock();let s=bi.tempFromBytes(t.data);Q(s,2);let a=Q(s,2),n=new ne(a),o=un(n.readBits(4));if(o===null)throw new Error("Invalid FLAC frame: Invalid block size.");dn(s);let c=hn(s,o);this.blockSizes.push(c),this.frameSizes.push(t.data.length);let l=this.writer.getPos();this.writer.write(t.data),this.format._options.onFrame&&this.format._options.onFrame(t.data,l),await this.writer.flush()}finally{i()}}addSubtitleCue(){throw new Error("FLAC does not support subtitles.")}async finalize(){let e=await this.mutex.acquire(),t=1/0,r=0,i=1/0,s=0,a=0;for(let n=0;n<this.blockSizes.length;n++)i=Math.min(i,this.frameSizes[n]),s=Math.max(s,this.frameSizes[n]),r=Math.max(r,this.blockSizes[n]),a+=this.blockSizes[n],n!==this.blockSizes.length-1&&(t=Math.min(t,this.blockSizes[n]));d(this.sampleRate!==null),d(this.channels!==null),d(this.bitsPerSample!==null),this.writer.seek(4),this.writeHeader({minimumBlockSize:t,maximumBlockSize:r,minimumFrameSize:i,maximumFrameSize:s,sampleRate:this.sampleRate,channels:this.channels,bitsPerSample:this.bitsPerSample,totalSamples:a}),e()}},Wr=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,Ql=/^WEBVTT(.|\n)*?\n{2}/,ki=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Kl=class{constructor(e){this.preambleText=null,this.preambleEmitted=!1,this.options=e}parse(e){e=e.replaceAll("\r\n","\n").replaceAll("\r","\n"),Wr.lastIndex=0;let t;if(!this.preambleText){if(!Ql.test(e))throw new Error("WebVTT preamble incorrect.");t=Wr.exec(e);let r=e.slice(0,t?.index??e.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,t&&(e=e.slice(t.index),Wr.lastIndex=0)}for(;t=Wr.exec(e);){let r=e.slice(0,t.index),i=t[1],s=t.index+t[0].length,a=e.indexOf("\n",s)+1,n=e.slice(s,a).trim(),o=e.indexOf("\n\n",s);o===-1&&(o=e.length);let c=ws(t[2]),u=ws(t[3])-c,h=e.slice(a,o).trim();e=e.slice(o).trimStart(),Wr.lastIndex=0;let f={timestamp:c/1e3,duration:u/1e3,text:h,identifier:i,settings:n,notes:r},g={};this.preambleEmitted||(g.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(f,g)}}},Gl=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,ws=e=>{let t=Gl.exec(e);if(!t)throw new Error("Expected match.");return 3600*1e3*Number(t[1]||"0")+60*1e3*Number(t[2])+1e3*Number(t[3])+Number(t[4])},On=e=>{let t=Math.floor(e/36e5),r=Math.floor(e%(3600*1e3)/(60*1e3)),i=Math.floor(e%(60*1e3)/1e3),s=e%1e3;return t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+s.toString().padStart(3,"0")},Nn=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let s of e.children)s&&this.writeBox(s);let r=this.writer.getPos(),i=e.size??r-t;this.writer.seek(t),this.writeBoxHeader(e,i),this.writer.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.offsets.get(e);d(t!==void 0);let r=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(r)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let r of e.children)r&&(t+=this.measureBox(r));return t}}},re=new Uint8Array(8),ft=new DataView(re.buffer),ge=e=>[(e%256+256)%256],q=e=>(ft.setUint16(0,e,!1),[re[0],re[1]]),Un=e=>(ft.setInt16(0,e,!1),[re[0],re[1]]),Ln=e=>(ft.setUint32(0,e,!1),[re[1],re[2],re[3]]),z=e=>(ft.setUint32(0,e,!1),[re[0],re[1],re[2],re[3]]),Wt=e=>(ft.setInt32(0,e,!1),[re[0],re[1],re[2],re[3]]),ir=e=>(ft.setUint32(0,Math.floor(e/2**32),!1),ft.setUint32(4,e,!1),[re[0],re[1],re[2],re[3],re[4],re[5],re[6],re[7]]),Vn=e=>(ft.setInt16(0,2**8*e,!1),[re[0],re[1]]),Pt=e=>(ft.setInt32(0,2**16*e,!1),[re[0],re[1],re[2],re[3]]),bs=e=>(ft.setInt32(0,2**30*e,!1),[re[0],re[1],re[2],re[3]]),ks=(e,t)=>{let r=[],i=e;do{let s=i&127;i>>=7,r.length>0&&(s|=128),r.push(s),t!==void 0&&t--}while(i>0||t);return r.reverse()},Ie=(e,t=!1)=>{let r=Array(e.length).fill(null).map((i,s)=>e.charCodeAt(s));return t&&r.push(0),r},ys=e=>{let t=null;for(let r of e)(!t||r.timestamp>t.timestamp)&&(t=r);return t},Wn=e=>{let t=e*(Math.PI/180),r=Math.round(Math.cos(t)),i=Math.round(Math.sin(t));return[r,i,0,-i,r,0,0,0,1]},Hn=Wn(0),qn=e=>[Pt(e[0]),Pt(e[1]),bs(e[2]),Pt(e[3]),Pt(e[4]),bs(e[5]),Pt(e[6]),Pt(e[7]),bs(e[8])],$=(e,t,r)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:r}),ae=(e,t,r,i,s)=>$(e,[ge(t),Ln(r),i??[]],s),Xl=e=>e.isQuickTime?$("ftyp",[Ie("qt  "),z(512),Ie("qt  ")]):e.fragmented?$("ftyp",[Ie("iso5"),z(512),Ie("iso5"),Ie("iso6"),Ie("mp41")]):$("ftyp",[Ie("isom"),z(512),Ie("isom"),e.holdsAvc?Ie("avc1"):[],Ie("mp41")]),yi=e=>({type:"mdat",largeSize:e}),Yl=e=>({type:"free",size:e}),Hr=e=>$("moov",void 0,[Zl(e.creationTime,e.trackDatas),...e.trackDatas.map(t=>Jl(t,e.creationTime)),e.isFragmented?zu(e.trackDatas):null,Qu(e)]),Zl=(e,t)=>{let r=ve(Math.max(0,...t.filter(n=>n.samples.length>0).map(n=>{let o=ys(n.samples);return o.timestamp+o.duration})),xs),i=Math.max(0,...t.map(n=>n.track.id))+1,s=!Je(e)||!Je(r),a=s?ir:z;return ae("mvhd",+s,0,[a(e),a(e),z(xs),a(r),Pt(1),Vn(1),Array(10).fill(0),qn(Hn),Array(24).fill(0),z(i)])},Jl=(e,t)=>{let r=ld(e);return $("trak",void 0,[eu(e,t),tu(e,t),r.name!==void 0?$("udta",void 0,[$("name",[...fe.encode(r.name)])]):null])},eu=(e,t)=>{let r=ys(e.samples),i=ve(r?r.timestamp+r.duration:0,xs),s=!Je(t)||!Je(i),a=s?ir:z,n;if(e.type==="video"){let o=e.track.metadata.rotation;n=Wn(o??0)}else n=Hn;return ae("tkhd",+s,3,[a(t),a(t),z(e.track.id),z(0),a(i),Array(8).fill(0),q(0),q(e.track.id),Vn(e.type==="audio"?1:0),q(0),qn(n),Pt(e.type==="video"?e.info.width:0),Pt(e.type==="video"?e.info.height:0)])},tu=(e,t)=>$("mdia",void 0,[ru(e,t),Ts(!0,iu[e.type],su[e.type]),au(e)]),ru=(e,t)=>{let r=ys(e.samples),i=ve(r?r.timestamp+r.duration:0,e.timescale),s=!Je(t)||!Je(i),a=s?ir:z;return ae("mdhd",+s,0,[a(t),a(t),z(e.timescale),a(i),q(Yn(e.track.metadata.languageCode??$e)),q(0)])},iu={video:"vide",audio:"soun",subtitle:"text"},su={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Ts=(e,t,r,i="\0\0\0\0")=>ae("hdlr",0,0,[e?Ie("mhlr"):z(0),Ie(t),Ie(i),z(0),z(0),Ie(r,!0)]),au=e=>$("minf",void 0,[lu[e.type](),uu(),fu(e)]),nu=()=>ae("vmhd",0,1,[q(0),q(0),q(0),q(0)]),ou=()=>ae("smhd",0,0,[q(0),q(0)]),cu=()=>ae("nmhd",0,0),lu={video:nu,audio:ou,subtitle:cu},uu=()=>$("dinf",void 0,[du()]),du=()=>ae("dref",0,0,[z(1)],[hu()]),hu=()=>ae("url ",0,1),fu=e=>{let t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some(r=>r.sampleCompositionTimeOffset!==0);return $("stbl",void 0,[mu(e),Pu(e),t?Mu(e):null,t?Fu(e):null,Eu(e),Au(e),Bu(e),Iu(e)])},mu=e=>{let t;if(e.type==="video")t=pu(Yu[e.track.source._codec],e);else if(e.type==="audio"){let r=Xn(e.track.source._codec,e.muxer.isQuickTime);d(r),t=yu(r,e)}else e.type==="subtitle"&&(t=Cu(ed[e.track.source._codec],e));return d(t),ae("stsd",0,0,[z(1)],[t])},pu=(e,t)=>$(e,[Array(6).fill(0),q(1),q(0),q(0),Array(12).fill(0),q(t.info.width),q(t.info.height),z(4718592),z(4718592),z(0),q(1),Array(32).fill(0),q(24),Un(65535)],[Zu[t.track.source._codec](t),Qt(t.info.decoderConfig.colorSpace)?gu(t):null]),gu=e=>$("colr",[Ie("nclx"),q(yt[e.info.decoderConfig.colorSpace.primaries]),q(et[e.info.decoderConfig.colorSpace.transfer]),q(tt[e.info.decoderConfig.colorSpace.matrix]),ge((e.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),wu=e=>e.info.decoderConfig&&$("avcC",[...le(e.info.decoderConfig.description)]),bu=e=>e.info.decoderConfig&&$("hvcC",[...le(e.info.decoderConfig.description)]),$n=e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig,r=t.codec.split("."),i=Number(r[1]),s=Number(r[2]),a=Number(r[3]),n=r[4]?Number(r[4]):1,o=r[8]?Number(r[8]):Number(t.colorSpace?.fullRange??0),c=(a<<4)+(n<<1)+o,l=r[5]?Number(r[5]):t.colorSpace?.primaries?yt[t.colorSpace.primaries]:2,u=r[6]?Number(r[6]):t.colorSpace?.transfer?et[t.colorSpace.transfer]:2,h=r[7]?Number(r[7]):t.colorSpace?.matrix?tt[t.colorSpace.matrix]:2;return ae("vpcC",1,0,[ge(i),ge(s),ge(c),ge(l),ge(u),ge(h),q(0)])},ku=e=>$("av1C",fa(e.info.decoderConfig.codec)),yu=(e,t)=>{let r=0,i,s=16;if(Te.includes(t.track.source._codec)){let a=t.track.source._codec,{sampleSize:n}=ut(a);s=8*n,s>16&&(r=1)}return r===0?i=[Array(6).fill(0),q(1),q(r),q(0),z(0),q(t.info.numberOfChannels),q(s),q(0),q(0),q(t.info.sampleRate<2**16?t.info.sampleRate:0),q(0)]:i=[Array(6).fill(0),q(1),q(r),q(0),z(0),q(t.info.numberOfChannels),q(Math.min(s,16)),q(0),q(0),q(t.info.sampleRate<2**16?t.info.sampleRate:0),q(0),z(1),z(s/8),z(t.info.numberOfChannels*s/8),z(2)],$(e,i,[Ju(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},Ss=e=>{let t;switch(e.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw new Error("Unhandled audio codec: ".concat(e.track.source._codec))}let r=[...ge(t),...ge(21),...Ln(0),...z(0),...z(0)];if(e.info.decoderConfig.description){let i=le(e.info.decoderConfig.description);r=[...r,...ge(5),...ks(i.byteLength),...i]}return r=[...q(1),...ge(0),...ge(4),...ks(r.length),...r,...ge(6),...ge(1),...ge(2)],r=[...ge(3),...ks(r.length),...r],ae("esds",0,0,r)},Ht=e=>$("wave",void 0,[Tu(e),Su(e),$("\0\0\0\0")]),Tu=e=>$("frma",[Ie(Xn(e.track.source._codec,e.muxer.isQuickTime))]),Su=e=>{let{littleEndian:t}=ut(e.track.source._codec);return $("enda",[q(+t)])},vu=e=>{let t=e.info.numberOfChannels,r=3840,i=e.info.sampleRate,s=0,a=0,n=new Uint8Array(0),o=e.info.decoderConfig?.description;if(o){d(o.byteLength>=18);let c=le(o),l=ai(c);t=l.outputChannelCount,r=l.preSkip,i=l.inputSampleRate,s=l.outputGain,a=l.channelMappingFamily,l.channelMappingTable&&(n=l.channelMappingTable)}return $("dOps",[ge(0),ge(t),q(r),z(i),Un(s),ge(a),...n])},_u=e=>{let t=e.info.decoderConfig?.description;d(t);let r=le(t);return ae("dfLa",0,0,[...r.subarray(4)])},mt=e=>{let{littleEndian:t,sampleSize:r}=ut(e.track.source._codec),i=+t;return ae("pcmC",0,0,[ge(i),ge(8*r)])},Cu=(e,t)=>$(e,[Array(6).fill(0),q(1)],[td[t.track.source._codec](t)]),xu=e=>$("vttC",[...fe.encode(e.info.config.description)]),Pu=e=>ae("stts",0,0,[z(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[z(t.sampleCount),z(t.sampleDelta)])]),Iu=e=>{if(e.samples.every(r=>r.type==="key"))return null;let t=[...e.samples.entries()].filter(([,r])=>r.type==="key");return ae("stss",0,0,[z(t.length),t.map(([r])=>z(r+1))])},Eu=e=>ae("stsc",0,0,[z(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[z(t.firstChunk),z(t.samplesPerChunk),z(1)])]),Au=e=>{if(e.type==="audio"&&e.info.requiresPcmTransformation){let{sampleSize:t}=ut(e.track.source._codec);return ae("stsz",0,0,[z(t*e.info.numberOfChannels),z(e.samples.reduce((r,i)=>r+ve(i.duration,e.timescale),0))])}return ae("stsz",0,0,[z(0),z(e.samples.length),e.samples.map(t=>z(t.size))])},Bu=e=>e.finalizedChunks.length>0&&ce(e.finalizedChunks).offset>=2**32?ae("co64",0,0,[z(e.finalizedChunks.length),e.finalizedChunks.map(t=>ir(t.offset))]):ae("stco",0,0,[z(e.finalizedChunks.length),e.finalizedChunks.map(t=>z(t.offset))]),Mu=e=>ae("ctts",1,0,[z(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map(t=>[z(t.sampleCount),Wt(t.sampleCompositionTimeOffset)])]),Fu=e=>{let t=1/0,r=-1/0,i=1/0,s=-1/0;d(e.compositionTimeOffsetTable.length>0),d(e.samples.length>0);for(let n=0;n<e.compositionTimeOffsetTable.length;n++){let o=e.compositionTimeOffsetTable[n];t=Math.min(t,o.sampleCompositionTimeOffset),r=Math.max(r,o.sampleCompositionTimeOffset)}for(let n=0;n<e.samples.length;n++){let o=e.samples[n];i=Math.min(i,ve(o.timestamp,e.timescale)),s=Math.max(s,ve(o.timestamp+o.duration,e.timescale))}let a=Math.max(-t,0);return s>=2**31?null:ae("cslg",0,0,[Wt(a),Wt(t),Wt(r),Wt(i),Wt(s)])},zu=e=>$("mvex",void 0,e.map(Ru)),Ru=e=>ae("trex",0,0,[z(e.track.id),z(1),z(0),z(0),z(0)]),jn=(e,t)=>$("moof",void 0,[Du(e),...t.map(Ou)]),Du=e=>ae("mfhd",0,0,[z(e)]),Qn=e=>{let t=0,r=0,i=0,s=0,a=e.type==="delta";return r|=+a,a?t|=1:t|=2,t<<24|r<<16|i<<8|s},Ou=e=>$("traf",void 0,[Nu(e),Uu(e),Lu(e)]),Nu=e=>{d(e.currentChunk);let t=0;t|=8,t|=16,t|=32,t|=131072;let r=e.currentChunk.samples[1]??e.currentChunk.samples[0],i={duration:r.timescaleUnitsToNextSample,size:r.size,flags:Qn(r)};return ae("tfhd",0,t,[z(e.track.id),z(i.duration),z(i.size),z(i.flags)])},Uu=e=>(d(e.currentChunk),ae("tfdt",1,0,[ir(ve(e.currentChunk.startTimestamp,e.timescale))])),Lu=e=>{d(e.currentChunk);let t=e.currentChunk.samples.map(p=>p.timescaleUnitsToNextSample),r=e.currentChunk.samples.map(p=>p.size),i=e.currentChunk.samples.map(Qn),s=e.currentChunk.samples.map(p=>ve(p.timestamp-p.decodeTimestamp,e.timescale)),a=new Set(t),n=new Set(r),o=new Set(i),c=new Set(s),l=o.size===2&&i[0]!==i[1],u=a.size>1,h=n.size>1,f=!l&&o.size>1,g=c.size>1||[...c].some(p=>p!==0),w=0;return w|=1,w|=4*+l,w|=256*+u,w|=512*+h,w|=1024*+f,w|=2048*+g,ae("trun",1,w,[z(e.currentChunk.samples.length),z(e.currentChunk.offset-e.currentChunk.moofOffset||0),l?z(i[0]):[],e.currentChunk.samples.map((p,y)=>[u?z(t[y]):[],h?z(r[y]):[],f?z(i[y]):[],g?Wt(s[y]):[]])])},Vu=e=>$("mfra",void 0,[...e.map(Wu),Hu()]),Wu=(e,t)=>ae("tfra",1,0,[z(e.track.id),z(63),z(e.finalizedChunks.length),e.finalizedChunks.map(i=>[ir(ve(i.samples[0].timestamp,e.timescale)),ir(i.moofOffset),z(t+1),z(1),z(1)])]),Hu=()=>ae("mfro",0,0,[z(0)]),qu=()=>$("vtte"),$u=(e,t,r,i,s)=>$("vttc",void 0,[s!==null?$("vsid",[Wt(s)]):null,r!==null?$("iden",[...fe.encode(r)]):null,t!==null?$("ctim",[...fe.encode(On(t))]):null,i!==null?$("sttg",[...fe.encode(i)]):null,$("payl",[...fe.encode(e)])]),ju=e=>$("vtta",[...fe.encode(e)]),Qu=e=>{let t=[],r=e.format._options.metadataFormat??"auto",i=e.output._metadataTags;if(r==="mdir"||r==="auto"&&!e.isQuickTime){let s=Gu(i);s&&t.push(s)}else if(r==="mdta"){let s=Xu(i);s&&t.push(s)}else(r==="udta"||r==="auto"&&e.isQuickTime)&&Ku(t,e.output._metadataTags);return t.length===0?null:$("udta",void 0,t)},Ku=(e,t)=>{for(let{key:r,value:i}of cr(t))switch(r){case"title":e.push(pt("\xA9nam",i));break;case"description":e.push(pt("\xA9des",i));break;case"artist":e.push(pt("\xA9ART",i));break;case"album":e.push(pt("\xA9alb",i));break;case"albumArtist":e.push(pt("albr",i));break;case"genre":e.push(pt("\xA9gen",i));break;case"date":e.push(pt("\xA9day",i.toISOString().slice(0,10)));break;case"comment":e.push(pt("\xA9cmt",i));break;case"lyrics":e.push(pt("\xA9lyr",i));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:Me(r)}if(t.raw)for(let r in t.raw){let i=t.raw[r];i==null||r.length!==4||e.some(s=>s.type===r)||(typeof i=="string"?e.push(pt(r,i)):i instanceof Uint8Array&&e.push($(r,Array.from(i))))}},pt=(e,t)=>{let r=fe.encode(t);return $(e,[q(r.length),q(Yn("und")),Array.from(r)])},Kn={"image/jpeg":13,"image/png":14,"image/bmp":27},Gn=(e,t)=>{let r=[];for(let{key:i,value:s}of cr(e))switch(i){case"title":r.push({key:t?"title":"\xA9nam",value:nt(s)});break;case"description":r.push({key:t?"description":"\xA9des",value:nt(s)});break;case"artist":r.push({key:t?"artist":"\xA9ART",value:nt(s)});break;case"album":r.push({key:t?"album":"\xA9alb",value:nt(s)});break;case"albumArtist":r.push({key:t?"album_artist":"aART",value:nt(s)});break;case"comment":r.push({key:t?"comment":"\xA9cmt",value:nt(s)});break;case"genre":r.push({key:t?"genre":"\xA9gen",value:nt(s)});break;case"lyrics":r.push({key:t?"lyrics":"\xA9lyr",value:nt(s)});break;case"date":r.push({key:t?"date":"\xA9day",value:nt(s.toISOString().slice(0,10))});break;case"images":for(let a of s)a.kind==="coverFront"&&r.push({key:"covr",value:$("data",[z(Kn[a.mimeType]??0),z(0),Array.from(a.data)])});break;case"trackNumber":if(t){let a=e.tracksTotal!==void 0?"".concat(s,"/").concat(e.tracksTotal):s.toString();r.push({key:"track",value:nt(a)})}else r.push({key:"trkn",value:$("data",[z(0),z(0),q(0),q(s),q(e.tracksTotal??0),q(0)])});break;case"discNumber":t||r.push({key:"disc",value:$("data",[z(0),z(0),q(0),q(s),q(e.discsTotal??0),q(0)])});break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Me(i)}if(e.raw)for(let i in e.raw){let s=e.raw[i];s==null||!t&&i.length!==4||r.some(a=>a.key===i)||(typeof s=="string"?r.push({key:i,value:nt(s)}):s instanceof Uint8Array?r.push({key:i,value:$("data",[z(0),z(0),Array.from(s)])}):s instanceof Gt&&r.push({key:i,value:$("data",[z(Kn[s.mimeType]??0),z(0),Array.from(s.data)])}))}return r},Gu=e=>{let t=Gn(e,!1);return t.length===0?null:ae("meta",0,0,void 0,[Ts(!1,"mdir","","appl"),$("ilst",void 0,t.map(r=>$(r.key,void 0,[r.value])))])},Xu=e=>{let t=Gn(e,!0);return t.length===0?null:$("meta",void 0,[Ts(!1,"mdta",""),ae("keys",0,0,[z(t.length)],t.map(r=>$("mdta",[...fe.encode(r.key)]))),$("ilst",void 0,t.map((r,i)=>{let s=String.fromCharCode(...z(i+1));return $(s,void 0,[r.value])}))])},nt=e=>$("data",[z(1),z(0),...fe.encode(e)]),Yu={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},Zu={avc:wu,hevc:bu,vp8:$n,vp9:$n,av1:ku},Xn=(e,t)=>{switch(e){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(e){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(e){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},Ju=(e,t)=>{switch(e){case"aac":return Ss;case"mp3":return Ss;case"opus":return vu;case"vorbis":return Ss;case"flac":return _u}if(t)switch(e){case"pcm-s24":return Ht;case"pcm-s24be":return Ht;case"pcm-s32":return Ht;case"pcm-s32be":return Ht;case"pcm-f32":return Ht;case"pcm-f32be":return Ht;case"pcm-f64":return Ht;case"pcm-f64be":return Ht}else switch(e){case"pcm-s16":return mt;case"pcm-s16be":return mt;case"pcm-s24":return mt;case"pcm-s24be":return mt;case"pcm-s32":return mt;case"pcm-s32be":return mt;case"pcm-f32":return mt;case"pcm-f32be":return mt;case"pcm-f64":return mt;case"pcm-f64be":return mt}return null},ed={webvtt:"wvtt"},td={webvtt:xu},Yn=e=>{d(e.length===3);let t=0;for(let r=0;r<3;r++)t<<=5,t+=e.charCodeAt(r)-96;return t},vs=class{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}let r=t+e.byteLength-this.trackedStart,i=this.trackedWrites.byteLength;for(;i<r;)i*=2;if(i!==this.trackedWrites.byteLength){let s=new Uint8Array(i);s.set(this.trackedWrites,0),this.trackedWrites=s}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let t={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,t}},_s=2**16,Cs=2**32,Zn=class extends vs{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(_s,{maxByteLength:Cs})}catch{this.buffer=new ArrayBuffer(_s),this.supportsResize=!1}else this.buffer=new ArrayBuffer(_s);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>Cs)throw new Error("ArrayBuffer exceeded maximum size of ".concat(Cs," bytes. Please consider using another target."));if(this.supportsResize)this.buffer.resize(t);else{let r=new ArrayBuffer(t),i=new Uint8Array(r);i.set(this.bytes,0),this.buffer=r,this.bytes=i}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}},rd=2**24,id=2,sd=class extends vs{constructor(e){super(),this.pos=0,this.sections=[],this.lastWriteEnd=0,this.lastFlushEnd=0,this.writer=null,this.chunks=[],this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??rd}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let t=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(t))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}if(d(this.writer),this.sections.length===0)return;let e=[],t=[...this.sections].sort((r,i)=>r.start-i.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let r=1;r<t.length;r++){let i=e[e.length-1],s=t[r];s.start<=i.start+i.size?i.size=Math.max(i.size,s.start+s.data.byteLength-i.start):e.push({start:s.start,size:s.data.byteLength})}for(let r of e){r.data=new Uint8Array(r.size);for(let i of this.sections)r.start<=i.start&&i.start<r.start+r.size&&r.data.set(i.data,i.start-r.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(r.data,r.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&r.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data,position:r.start}),this.lastFlushEnd=r.start+r.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,t){let r=this.chunks.findIndex(o=>o.start<=t&&t<o.start+this.chunkSize);r===-1&&(r=this.createChunk(t));let i=this.chunks[r],s=t-i.start,a=e.subarray(0,Math.min(this.chunkSize-s,e.byteLength));i.data.set(a,s);let n={start:s,end:s+a.byteLength};if(this.insertSectionIntoChunk(i,n),i.written[0].start===0&&i.written[0].end===this.chunkSize&&(i.shouldFlush=!0),this.chunks.length>id){for(let o=0;o<this.chunks.length-1;o++)this.chunks[o].shouldFlush=!0;this.tryToFlushChunks()}a.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(a.byteLength),t+a.byteLength)}insertSectionIntoChunk(e,t){let r=0,i=e.written.length-1,s=-1;for(;r<=i;){let a=Math.floor(r+(i-r+1)/2);e.written[a].start<=t.start?(r=a+1,s=a):i=a-1}for(e.written.splice(s+1,0,t),(s===-1||e.written[s].end<t.start)&&s++;s<e.written.length-1&&e.written[s].end>=e.written[s+1].start;)e.written[s].end=Math.max(e.written[s].end,e.written[s+1].end),e.written.splice(s+1,1)}createChunk(e){let r={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((i,s)=>i.start-s.start),this.chunks.indexOf(r)}tryToFlushChunks(e=!1){d(this.writer);for(let t=0;t<this.chunks.length;t++){let r=this.chunks[t];if(!(!r.shouldFlush&&!e)){for(let i of r.written){let s=r.start+i.start;if(this.ensureMonotonicity&&s!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data.subarray(i.start,i.end),position:s}),this.lastFlushEnd=r.start+i.end}this.chunks.splice(t--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),d(this.writer),this.writer.close()}async close(){return this.writer?.close()}},ad=class extends vs{constructor(e){super(),this.target=e,this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}},Jn=qe(Be(),1),nd=typeof Jn<"u"?Jn:void 0,Sr=class{constructor(){this._output=null,this.onwrite=null}},eo=class extends Sr{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new Zn(this)}},to=class extends Sr{constructor(e,t={}){if(super(),!(e instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(t!=null&&typeof t!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(t.chunked!==void 0&&typeof t.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(t.chunkSize!==void 0&&(!Number.isInteger(t.chunkSize)||t.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=e,this._options=t}_createWriter(){return new sd(this)}},od=class extends Sr{constructor(e,t={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");super(),this._fileHandle=null;let r=new WritableStream({start:async()=>{this._fileHandle=await nd.fs.open(e,"w")},write:async i=>{d(this._fileHandle),await this._fileHandle.write(i.data,0,i.data.byteLength,i.position)},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}});this._streamTarget=new to(r,{chunked:!0,...t}),this._streamTarget._output=this._output}_createWriter(){return this._streamTarget._createWriter()}},ro=class extends Sr{_createWriter(){return new ad(this)}},xs=1e3,cd=2082844800,ld=e=>{let t={},r=e.track;return r.metadata.name!==void 0&&(t.name=r.metadata.name),t},ve=(e,t,r=!0)=>{let i=e*t;return r?Math.round(i):i},ud=class extends Yt{constructor(e,t){super(e),this.auxTarget=new eo,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new Nn(this.auxWriter),this.mdat=null,this.ftypSize=null,this.trackDatas=[],this.allTracksKnown=we(),this.creationTime=Math.floor(Date.now()/1e3)+cd,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new Nn(this.writer),this.isQuickTime=t instanceof Es;let r=this.writer instanceof Zn?"in-memory":!1;this.fastStart=t._options.fastStart??r,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),t=this.output._tracks.some(r=>r.type==="video"&&r.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(Xl({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onFtyp(r,i)}if(this.ftypSize=this.writer.getPos(),this.fastStart!=="in-memory")if(this.fastStart==="reserve"){for(let r of this.output._tracks)if(r.metadata.maximumPacketCount===void 0)throw new Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=yi(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Oa({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,r){let i=this.trackDatas.find(c=>c.track===e);if(i)return i;ka(r),d(r),d(r.decoderConfig);let s={...r.decoderConfig};d(s.codedWidth!==void 0),d(s.codedHeight!==void 0);let a=!1;if(e.source._codec==="avc"&&!s.description){let c=Sa(t.data);if(!c)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");s.description=xc(c),a=!0}else if(e.source._codec==="hevc"&&!s.description){let c=_a(t.data);if(!c)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");s.description=Fc(c),a=!0}let n=oc(1/(e.metadata.frameRate??57600),1e6).denominator,o={muxer:this,track:e,type:"video",info:{width:s.codedWidth,height:s.codedHeight,decoderConfig:s,requiresAnnexBTransformation:a},timescale:n,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(o),this.trackDatas.sort((c,l)=>c.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}getAudioTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;dr(t),d(t),d(t.decoderConfig);let i={muxer:this,track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig,requiresPcmTransformation:!this.isFragmented&&Te.includes(e.source._codec)},timescale:t.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;ya(t),d(t),d(t.config);let i={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,t,r),a=t.data;if(s.info.requiresAnnexBTransformation){let c=_c(a);if(!c)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");a=c}let n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),o=this.createSampleForTrack(s,a,n,t.duration,t.type);await this.registerSample(s,o)}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r),a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),n=this.createSampleForTrack(s,t.data,a,t.duration,t.type);s.info.requiresPcmTransformation&&await this.maybePadWithSilence(s,a),await this.registerSample(s,n)}finally{i()}}async maybePadWithSilence(e,t){let r=ce(e.samples),i=r?r.timestamp+r.duration:0,s=t-i,a=ve(s,e.timescale);if(a>0){let{sampleSize:n,silentValue:o}=ut(e.info.decoderConfig.codec),c=a*e.info.numberOfChannels,l=new Uint8Array(n*c).fill(o),u=this.createSampleForTrack(e,new Uint8Array(l.buffer),i,s,"key");await this.registerSample(e,u)}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,r);this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),e.source._codec==="webvtt"&&(s.cueQueue.push(t),await this.processWebVTTCues(s,t.timestamp))}finally{i()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){let r=new Set([]);for(let c of e.cueQueue)d(c.timestamp<=t),d(e.lastCueEndTimestamp<=c.timestamp+c.duration),r.add(Math.max(c.timestamp,e.lastCueEndTimestamp)),r.add(c.timestamp+c.duration);let i=[...r].sort((c,l)=>c-l),s=i[0],a=i[1]??s;if(t<a)break;if(e.lastCueEndTimestamp<s){this.auxWriter.seek(0);let c=qu();this.auxBoxWriter.writeBox(c);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,l,e.lastCueEndTimestamp,s-e.lastCueEndTimestamp,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let c=0;c<e.cueQueue.length;c++){let l=e.cueQueue[c];if(l.timestamp>=a)break;ki.lastIndex=0;let u=ki.test(l.text),h=l.timestamp+l.duration,f=e.cueToSourceId.get(l);if(f===void 0&&a<h&&(f=e.nextSourceId++,e.cueToSourceId.set(l,f)),l.notes){let w=ju(l.notes);this.auxBoxWriter.writeBox(w)}let g=$u(l.text,u?s:null,l.identifier??null,l.settings??null,f??null);this.auxBoxWriter.writeBox(g),h===a&&e.cueQueue.splice(c--,1)}let n=this.auxWriter.getSlice(0,this.auxWriter.getPos()),o=this.createSampleForTrack(e,n,s,a-s,"key");await this.registerSample(e,o),e.lastCueEndTimestamp=a}}createSampleForTrack(e,t,r,i,s){return{timestamp:r,decodeTimestamp:r,duration:i,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:ve(i,e.timescale)}}processTimestamps(e,t){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let i=0;for(let s=0;s<e.timestampProcessingQueue.length;s++){let a=e.timestampProcessingQueue[s],n=ve(a.duration,e.timescale);i+=n}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:i,sampleDelta:1});else{let s=ce(e.timeToSampleTable);s.sampleCount+=i}e.timestampProcessingQueue.length=0;return}let r=e.timestampProcessingQueue.map(i=>i.timestamp).sort((i,s)=>i-s);for(let i=0;i<e.timestampProcessingQueue.length;i++){let s=e.timestampProcessingQueue[i];s.decodeTimestamp=r[i],!this.isFragmented&&e.lastTimescaleUnits===null&&(s.decodeTimestamp=0);let a=ve(s.timestamp-s.decodeTimestamp,e.timescale),n=ve(s.duration,e.timescale);if(e.lastTimescaleUnits!==null){d(e.lastSample);let o=ve(s.decodeTimestamp,e.timescale,!1),c=Math.round(o-e.lastTimescaleUnits);if(d(c>=0),e.lastTimescaleUnits+=c,e.lastSample.timescaleUnitsToNextSample=c,!this.isFragmented){let l=ce(e.timeToSampleTable);if(d(l),l.sampleCount===1){l.sampleDelta=c;let h=e.timeToSampleTable[e.timeToSampleTable.length-2];h&&h.sampleDelta===c&&(h.sampleCount++,e.timeToSampleTable.pop(),l=h)}else l.sampleDelta!==c&&(l.sampleCount--,e.timeToSampleTable.push(l={sampleCount:1,sampleDelta:c}));l.sampleDelta===n?l.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:n});let u=ce(e.compositionTimeOffsetTable);d(u),u.sampleCompositionTimeOffset===a?u.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:a})}}else e.lastTimescaleUnits=ve(s.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:n}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:a}));e.lastSample=s}if(e.timestampProcessingQueue.length=0,d(e.lastSample),d(e.lastTimescaleUnits!==null),t!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){d(t.type==="key");let i=ve(t.timestamp,e.timescale,!1),s=Math.round(i-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=s}}async registerSample(e,t){t.type==="key"&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):this.fastStart==="reserve"?await this.registerSampleFastStartReserve(e,t):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){if(!this.isFragmented&&(e.samples.push(t),this.fastStart==="reserve")){let i=e.track.metadata.maximumPacketCount;if(d(i!==void 0),e.samples.length>i)throw new Error("Track #".concat(e.track.id," has already reached the maximum packet count (").concat(i,"). Either add less packets or increase the maximum packet count."))}let r=!1;if(!e.currentChunk)r=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);let i=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let s=this.trackDatas.every(a=>{if(e===a)return t.type==="key";let n=a.sampleQueue[0];return n?n.type==="key":a.track.source._closed});i>=this.minimumFragmentDuration&&s&&t.timestamp>this.maxWrittenTimestamp&&(r=!0,await this.finalizeFragment())}else r=i>=.5}r&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),d(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if(d(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((r,i)=>r+ve(i.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||ce(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(let r of e.currentChunk.samples)d(r.data),this.writer.write(r.data),r.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(d(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let t=null,r=1/0;for(let s of this.trackDatas){if(!e&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<r&&(t=s,r=s.sampleQueue[0].timestamp)}if(!t)break;let i=t.sampleQueue.shift();await this.addSampleToTrack(t,i)}}async finalizeFragment(e=!0){d(this.isFragmented);let t=this.nextFragmentNumber++;if(t===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let f=Hr(this);if(this.boxWriter.writeBox(f),this.format._options.onMoov){let{data:g,start:w}=this.writer.stopTrackingWrites();this.format._options.onMoov(g,w)}}let r=this.trackDatas.filter(f=>f.currentChunk),i=jn(t,r),s=this.writer.getPos(),a=s+this.boxWriter.measureBox(i),n=a+vt,o=1/0;for(let f of r){f.currentChunk.offset=n,f.currentChunk.moofOffset=s;for(let g of f.currentChunk.samples)n+=g.size;o=Math.min(o,f.currentChunk.startTimestamp)}let c=n-a,l=c>=2**32;if(l)for(let f of r)f.currentChunk.offset+=Jt-vt;this.format._options.onMoof&&this.writer.startTrackingWrites();let u=jn(t,r);if(this.boxWriter.writeBox(u),this.format._options.onMoof){let{data:f,start:g}=this.writer.stopTrackingWrites();this.format._options.onMoof(f,g,o)}d(this.writer.getPos()===a),this.format._options.onMdat&&this.writer.startTrackingWrites();let h=yi(l);h.size=c,this.boxWriter.writeBox(h),this.writer.seek(a+(l?Jt:vt));for(let f of r)for(let g of f.currentChunk.samples)this.writer.write(g.data),g.data=null;if(this.format._options.onMdat){let{data:f,start:g}=this.writer.stopTrackingWrites();this.format._options.onMdat(f,g)}for(let f of r)f.finalizedChunks.push(f.currentChunk),this.finalizedChunks.push(f.currentChunk),f.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,t){if(this.allTracksAreKnown()){if(!this.mdat){let r=Hr(this),s=this.boxWriter.measureBox(r)+this.computeSampleTableSizeUpperBound()+4096;d(this.ftypSize!==null),this.writer.seek(this.ftypSize+s),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=yi(!0),this.boxWriter.writeBox(this.mdat);for(let a of this.trackDatas){for(let n of a.sampleQueue)await this.addSampleToTrack(a,n);a.sampleQueue.length=0}}await this.addSampleToTrack(e,t)}else e.sampleQueue.push(t)}computeSampleTableSizeUpperBound(){d(this.fastStart==="reserve");let e=0;for(let t of this.trackDatas){let r=t.track.metadata.maximumPacketCount;d(r!==void 0),e+=8*Math.ceil(2/3*r),e+=4*r,e+=8*Math.ceil(2/3*r),e+=12*Math.ceil(2/3*r),e+=4*r,e+=8*r}return e}async onTrackClose(e){let t=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){let r=this.trackDatas.find(i=>i.track===e);r&&await this.processWebVTTCues(r,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve();for(let t of this.trackDatas)t.type==="subtitle"&&t.track.source._codec==="webvtt"&&await this.processWebVTTCues(t,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let t of this.trackDatas)this.processTimestamps(t);await this.finalizeFragment(!1)}else for(let t of this.trackDatas)this.processTimestamps(t),await this.finalizeCurrentChunk(t);if(this.fastStart==="in-memory"){this.mdat=yi(!1);let t;for(let i=0;i<2;i++){let s=Hr(this),a=this.boxWriter.measureBox(s);t=this.boxWriter.measureBox(this.mdat);let n=this.writer.getPos()+a+t;for(let o of this.finalizedChunks){o.offset=n;for(let{data:c}of o.samples)d(c),n+=c.byteLength,t+=c.byteLength}if(n<2**32)break;t>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let r=Hr(this);if(this.boxWriter.writeBox(r),this.format._options.onMoov){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(i,s)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=t,this.boxWriter.writeBox(this.mdat);for(let i of this.finalizedChunks)for(let s of i.samples)d(s.data),this.writer.write(s.data),s.data=null;if(this.format._options.onMdat){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(i,s)}}else if(this.isFragmented){let t=this.writer.getPos(),r=Vu(this.trackDatas);this.boxWriter.writeBox(r);let i=this.writer.getPos()-t;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(i)}else{d(this.mdat);let t=this.boxWriter.offsets.get(this.mdat);d(t!==void 0);let r=this.writer.getPos()-t;if(this.mdat.size=r,this.mdat.largeSize=r>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:s,start:a}=this.writer.stopTrackingWrites();this.format._options.onMdat(s,a)}let i=Hr(this);if(this.fastStart==="reserve"){d(this.ftypSize!==null),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(i);let s=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(Yl(s))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(i);if(this.format._options.onMoov){let{data:s,start:a}=this.writer.stopTrackingWrites();this.format._options.onMoov(s,a)}}e()}},dd=-(2**15),hd=2**15-1,io="Mediabunny",so=6,ao=5,fd={video:1,audio:2,subtitle:17},md=class extends Yt{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=we(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new al(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof Bs?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:t,start:r}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(t,r)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;let t=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),s=new Uint8Array([25,65,164,105]),a=new Uint8Array([18,84,195,103]),n={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:19899,data:[{id:21419,data:a},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=n}createSegmentInfo(){let e={id:17545,data:new Yi(0)};this.segmentDuration=e;let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:io},{id:22337,data:io},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){let e={id:374648427,data:[]};this.tracksElement=e;for(let t of this.trackDatas){let r=st[t.track.source._codec];d(r);let i=0;if(t.type==="audio"&&t.track.source._codec==="opus"){i=1e6*80;let s=t.info.decoderConfig.description;if(s){let a=le(s),n=ai(a);i=Math.round(1e9*(n.preSkip/ur))}}e.data.push({id:174,data:[{id:215,data:t.track.id},{id:29637,data:t.track.id},{id:131,data:fd[t.type]},{id:156,data:0},{id:2274716,data:t.track.metadata.languageCode??$e},{id:134,data:r},{id:22186,data:0},{id:22203,data:i},t.track.metadata.name!==void 0?{id:21358,data:new Nt(t.track.metadata.name)}:null,t.type==="video"?this.videoSpecificTrackInfo(t):null,t.type==="audio"?this.audioSpecificTrackInfo(t):null,t.type==="subtitle"?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){let{frameRate:t,rotation:r}=e.track.metadata,i=[e.info.decoderConfig.description?{id:25506,data:le(e.info.decoderConfig.description)}:null,t?{id:2352003,data:1e9/t}:null],s=r?kt(-r):0,a=e.info.decoderConfig.colorSpace,n={id:224,data:[{id:176,data:e.info.width},{id:186,data:e.info.height},e.info.alphaMode?{id:21440,data:1}:null,Qt(a)?{id:21936,data:[{id:21937,data:tt[a.matrix]},{id:21946,data:et[a.transfer]},{id:21947,data:yt[a.primaries]},{id:21945,data:a.fullRange?2:1}]}:null,s?{id:30320,data:[{id:30321,data:0},{id:30325,data:new Xi((s+180)%360-180)}]}:null]};return i.push(n),i}audioSpecificTrackInfo(e){let t=Te.includes(e.track.source._codec)?ut(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:25506,data:le(e.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new Xi(e.info.sampleRate)},{id:159,data:e.info.numberOfChannels},t?{id:25188,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:25506,data:fe.encode(e.info.config.description)}]}maybeCreateTags(){let e=[],t=(s,a)=>{e.push({id:26568,data:[{id:17827,data:new Nt(s)},typeof a=="string"?{id:17543,data:new Nt(a)}:{id:17541,data:a}]})},r=this.output._metadataTags,i=new Set;for(let{key:s,value:a}of cr(r))switch(s){case"title":t("TITLE",a),i.add("TITLE");break;case"description":t("DESCRIPTION",a),i.add("DESCRIPTION");break;case"artist":t("ARTIST",a),i.add("ARTIST");break;case"album":t("ALBUM",a),i.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",a),i.add("ALBUM_ARTIST");break;case"genre":t("GENRE",a),i.add("GENRE");break;case"comment":t("COMMENT",a),i.add("COMMENT");break;case"lyrics":t("LYRICS",a),i.add("LYRICS");break;case"date":t("DATE",a.toISOString().slice(0,10)),i.add("DATE");break;case"trackNumber":{let n=r.tracksTotal!==void 0?"".concat(a,"/").concat(r.tracksTotal):a.toString();t("PART_NUMBER",n),i.add("PART_NUMBER")}break;case"discNumber":{let n=r.discsTotal!==void 0?"".concat(a,"/").concat(r.discsTotal):a.toString();t("DISC",n),i.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:Me(s)}if(r.raw)for(let s in r.raw){let a=r.raw[s];a==null||i.has(s)||(typeof a=="string"||a instanceof Uint8Array)&&t(s,a)}e.length!==0&&(this.tagsElement={id:307544935,data:[{id:29555,data:[{id:25536,data:[{id:26826,data:50},{id:25546,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){let e=this.output._metadataTags,t=[],r=new Set,i=e.images??[];for(let s of i){let a=s.name;a===void 0&&(a=(s.kind==="coverFront"?"cover":s.kind==="coverBack"?"back":"image")+(cc(s.mimeType)??""));let n;for(;;){n=0n;for(let o=0;o<8;o++)n<<=8n,n|=BigInt(Math.floor(Math.random()*256));if(n!==0n&&!r.has(n))break}r.add(n),t.push({id:24999,data:[s.description!==void 0?{id:18046,data:new Nt(s.description)}:null,{id:18030,data:new Nt(a)},{id:18016,data:s.mimeType},{id:18012,data:s.data},{id:18094,data:n}]})}for(let[s,a]of Object.entries(e.raw??{}))!(a instanceof ti)||!/^\d+$/.test(s)||i.find(o=>o.mimeType===a.mimeType&&dc(o.data,a.data))||t.push({id:24999,data:[a.description!==void 0?{id:18046,data:new Nt(a.description)}:null,{id:18030,data:new Nt(a.name??"")},{id:18016,data:a.mimeType??""},{id:18012,data:a.data},{id:18094,data:BigInt(s)}]});t.length!==0&&(this.attachmentsElement={id:423732329,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);let e={id:408125543,size:this.format._options.appendOnly?-1:so,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:t,start:r}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(t,r)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return d(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Ka({isWebM:this.format instanceof Bs,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,r){let i=this.trackDatas.find(a=>a.track===e);if(i)return i;ka(r),d(r),d(r.decoderConfig),d(r.decoderConfig.codedWidth!==void 0),d(r.decoderConfig.codedHeight!==void 0);let s={track:e,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(fc(s.info.decoderConfig.codec))}:e.source._codec==="av1"&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(fa(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((a,n)=>a.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;dr(t),d(t),d(t.decoderConfig);let i={track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;ya(t),d(t),d(t.config);let i={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,t,r),a=t.type==="key",n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,a),o=t.duration;e.metadata.frameRate!==void 0&&(n=Bi(n,1/e.metadata.frameRate),o=Bi(o,1/e.metadata.frameRate));let c=s.info.alphaMode?t.sideData.alpha??null:null,l=this.createInternalChunk(t.data,n,o,t.type,c);e.source._codec==="vp9"&&this.fixVP9ColorSpace(s,l),s.chunkQueue.push(l),await this.interleaveChunks()}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r),a=t.type==="key",n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,a),o=this.createInternalChunk(t.data,n,t.duration,t.type);s.chunkQueue.push(o),await this.interleaveChunks()}finally{i()}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,r),a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),n=t.text,o=Math.round(a*1e3);ki.lastIndex=0,n=n.replace(ki,h=>{let g=ws(h.slice(1,-1))-o;return"<".concat(On(g),">")});let c=fe.encode(n),l="".concat(t.settings??"","\n").concat(t.identifier??"","\n").concat(t.notes??""),u=this.createInternalChunk(c,a,t.duration,"key",l.trim()?fe.encode(l):null);s.chunkQueue.push(u),await this.interleaveChunks()}finally{i()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let t=null,r=1/0;for(let s of this.trackDatas){if(!e&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<r&&(t=s,r=s.chunkQueue[0].timestamp)}if(!t)break;let i=t.chunkQueue.shift();this.writeBlock(t,i)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if(t.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let r=new ne(t.data);r.skipBits(2);let i=r.readBits(1),a=(r.readBits(1)<<1)+i;if(a===3&&r.skipBits(1),r.readBits(1)||r.readBits(1)!==0||(r.skipBits(2),r.readBits(24)!==4817730))return;a>=2&&r.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];Kr(t.data,r.pos,r.pos+3,l)}createInternalChunk(e,t,r,i,s=null){return{data:e,type:i,timestamp:t,duration:r,additions:s}}writeBlock(e,t){this.segment||this.createSegment();let r=Math.round(1e3*t.timestamp),i=this.trackDatas.every(l=>{if(e===l)return t.type==="key";let u=l.chunkQueue[0];return u?u.type==="key":l.track.source._closed}),s=!1;if(!this.currentCluster)s=!0;else{d(this.currentClusterStartMsTimestamp!==null),d(this.currentClusterMaxMsTimestamp!==null);let l=r-this.currentClusterStartMsTimestamp;s=i&&r>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>hd}s&&this.createNewCluster(r);let a=r-this.currentClusterStartMsTimestamp;if(a<dd)return;let n=new Uint8Array(4),o=new DataView(n.buffer);o.setUint8(0,128|e.track.id),o.setInt16(1,a,!1);let c=Math.round(1e3*t.duration);if(t.additions){let l={id:160,data:[{id:161,data:[n,t.data]},t.type==="delta"?{id:251,data:new Va(e.lastWrittenMsTimestamp-r)}:null,t.additions?{id:30113,data:[{id:166,data:[{id:238,data:1},{id:165,data:t.additions}]}]}:null,c>0?{id:155,data:c}:null]};this.ebmlWriter.writeEBML(l)}else{o.setUint8(3,+(t.type==="key")<<7);let l={id:163,data:[n,t.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,r+c),e.lastWrittenMsTimestamp=r,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:r}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,r)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:ao,data:[{id:231,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(d(this.currentCluster),!this.format._options.appendOnly){let i=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),s=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(i,ao),this.writer.seek(s)}if(this.format._options.onCluster){d(this.currentClusterStartMsTimestamp!==null);let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onCluster(i,s,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(let[i,{firstMsTimestamp:s}]of this.trackDatasInCurrentCluster)t.has(s)||t.set(s,[]),t.get(s).push(i);let r=[...t.entries()].sort((i,s)=>i[0]-s[0]);for(let[i,s]of r)d(this.cues),this.cues.data.push({id:187,data:[{id:179,data:i},...s.map(a=>({id:183,data:[{id:247,data:a.track.id},{id:241,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),d(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let t=this.writer.getPos(),r=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(r,so),this.segmentDuration.data=new Yi(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),d(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(t)}e()}},pd=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer)}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(e){let t=this.writer.getPos(),r=255,i=224|e.mpegVersionId<<3|e.layer<<1,s;e.mpegVersionId&2?s=e.mpegVersionId&1?0:1:s=1;let a=0,n=155,o=-1,c=s*16*4+e.layer*16;for(let p=0;p<16;p++){let y=is[c+p];if(as(s,e.layer,1e3*y,e.sampleRate,a)>=n){o=p;break}}if(o===-1)throw new Error("No suitable bitrate found.");let l=o<<4|e.frequencyIndex<<2|a<<1,u=e.channel<<6|e.modeExtension<<4|e.copyright<<3|e.original<<2|e.emphasis;this.helper[0]=r,this.helper[1]=i,this.helper[2]=l,this.helper[3]=u,this.writer.write(this.helper.subarray(0,4));let h=ns(e.mpegVersionId,e.channel);this.writer.seek(t+h),this.writeU32(ss);let f=0;e.frameCount!==null&&(f|=1),e.fileSize!==null&&(f|=2),e.toc!==null&&(f|=4),this.writeU32(f),this.writeU32(e.frameCount??0),this.writeU32(e.fileSize??0),this.writer.write(e.toc??new Uint8Array(100));let g=is[c+o],w=as(s,e.layer,1e3*g,e.sampleRate,a);this.writer.seek(t+w)}},gd=class extends Yt{constructor(e,t){super(e),this.xingFrameData=null,this.frameCount=0,this.framePositions=[],this.xingFramePos=null,this.format=t,this.writer=e._writer,this.mp3Writer=new pd(e._writer)}async start(){ri(this.output._metadataTags)||new tn(this.writer).writeId3V2Tag(this.output._metadataTags)}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(e,t){let r=await this.mutex.acquire();try{let i=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&i){let s=ee(t.data);if(s.byteLength<4)throw new Error("Invalid MP3 header in sample.");let a=s.getUint32(0,!1),n=Ja(a,null).header;if(!n)throw new Error("Invalid MP3 header in sample.");let o=ns(n.mpegVersionId,n.channel);if(s.byteLength>=o+4){let c=s.getUint32(o,!1);if(c===ss||c===Za)return}this.xingFrameData={mpegVersionId:n.mpegVersionId,layer:n.layer,frequencyIndex:n.frequencyIndex,sampleRate:n.sampleRate,channel:n.channel,modeExtension:n.modeExtension,copyright:n.copyright,original:n.original,emphasis:n.emphasis,frameCount:null,fileSize:null,toc:null},this.xingFramePos=this.writer.getPos(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),this.writer.write(t.data),this.frameCount++,await this.writer.flush(),i&&this.framePositions.push(this.writer.getPos())}finally{r()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData||this.xingFramePos===null)return;let e=await this.mutex.acquire(),t=this.writer.getPos();this.writer.seek(this.xingFramePos);let r=new Uint8Array(100);for(let i=0;i<100;i++){let s=Math.floor(this.framePositions.length*(i/100));d(s!==-1&&s<this.framePositions.length);let a=this.framePositions[s];r[i]=256*(a/t)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=t,this.xingFrameData.toc=r,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(i,s)}this.writer.seek(t),e()}},wd=8192,bd=class extends Yt{constructor(e,t){super(e),this.trackDatas=[],this.bosPagesWritten=!1,this.allTracksKnown=we(),this.pageBytes=new Uint8Array(on),this.pageView=new DataView(this.pageBytes.buffer),this.format=t,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,nn({codecStrings:this.trackDatas.map(e=>e.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(e,t){let r=this.trackDatas.find(a=>a.track===e);if(r)return r;let i;do i=Math.floor(2**32*Math.random());while(this.trackDatas.some(a=>a.serialNumber===i));d(e.source._codec==="vorbis"||e.source._codec==="opus"),dr(t),d(t),d(t.decoderConfig);let s={track:e,serialNumber:i,internalSampleRate:e.source._codec==="opus"?ur:t.decoderConfig.sampleRate,codecInfo:{codec:e.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(s,t),this.trackDatas.push(s),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}queueHeaderPackets(e,t){if(d(t.decoderConfig),e.track.source._codec==="vorbis"){d(t.decoderConfig.description);let r=le(t.decoderConfig.description);if(r[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let i=1,s=()=>{let w=0;for(;;){let p=r[i++];if(p===void 0)throw new TypeError("Vorbis decoder description is too short.");if(w+=p,p<255)return w}},a=s(),n=s();if(r.length-i<=0)throw new TypeError("Vorbis decoder description is too short.");let c=r.subarray(i,i+=a);i+=n;let l=r.subarray(i),u=new Uint8Array(7);u[0]=3,u[1]=118,u[2]=111,u[3]=114,u[4]=98,u[5]=105,u[6]=115;let h=Li(u,this.output._metadataTags,!0);e.packetQueue.push({data:c,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:h,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let g=ee(c).getUint8(28);e.codecInfo.vorbisInfo={blocksizes:[1<<(g&15),1<<(g>>4)],modeBlockflags:Ea(l).modeBlockflags}}else if(e.track.source._codec==="opus"){if(!t.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let r=le(t.decoderConfig.description),i=new Uint8Array(8),s=ee(i);s.setUint32(0,1332770163,!1),s.setUint32(4,1415669619,!1);let a=Li(i,this.output._metadataTags,!0);e.packetQueue.push({data:r,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:a,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),e.codecInfo.opusInfo={preSkip:ai(r).preSkip}}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getTrackData(e,r);this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key");let a=s.currentTimestampInSamples,{durationInSamples:n,vorbisBlockSize:o}=an(t.data,s.codecInfo,s.vorbisLastBlocksize);s.currentTimestampInSamples+=n,s.vorbisLastBlocksize=o,s.packetQueue.push({data:t.data,endGranulePosition:s.currentTimestampInSamples,timestamp:a/s.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{i()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async interleavePages(e=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown())return;for(let t of this.trackDatas)for(;t.packetQueue.length>0;){let r=t.packetQueue.shift();if(this.writePacket(t,r,!1),r.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let t=null,r=1/0;for(let a of this.trackDatas){if(!e&&a.packetQueue.length<=1&&!a.track.source._closed)break e;a.packetQueue.length>0&&a.packetQueue[0].timestamp<r&&(t=a,r=a.packetQueue[0].timestamp)}if(!t)break;let i=t.packetQueue.shift(),s=t.packetQueue.length===0;this.writePacket(t,i,s)}e||await this.writer.flush()}writePacket(e,t,r){let i=t.data.length,s=0,a=0;for(;;){e.currentLacingValues.length===0&&s>0&&(e.currentPageStartsWithFreshPacket=!1);let o=Math.min(255,i);e.currentLacingValues.push(o),e.currentPageSize++,a+=o;let c=i<255;if(e.currentLacingValues.length===255){let l=t.data.subarray(s,a);if(s=a,e.currentPageData.push(l),e.currentPageSize+=l.length,this.writePage(e,r&&c),c)return}if(c)break;i-=255}let n=t.data.subarray(s);e.currentPageData.push(n),e.currentPageSize+=n.length,e.currentGranulePosition=t.endGranulePosition,(e.currentPageSize>=wd||t.forcePageFlush)&&this.writePage(e,r)}writePage(e,t){this.pageView.setUint32(0,ls,!0),this.pageView.setUint8(4,0);let r=0;e.currentPageStartsWithFreshPacket||(r|=1),e.pagesWritten===0&&(r|=2),t&&(r|=4),this.pageView.setUint8(5,r);let i=e.currentLacingValues.every(o=>o===255)?-1:e.currentGranulePosition;sc(this.pageView,6,i,!0),this.pageView.setUint32(14,e.serialNumber,!0),this.pageView.setUint32(18,e.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,e.currentLacingValues.length),this.pageBytes.set(e.currentLacingValues,27);let s=27+e.currentLacingValues.length;for(let o of e.currentPageData)this.pageBytes.set(o,s),s+=o.length;let a=this.pageBytes.subarray(0,s),n=sn(a);if(this.pageView.setUint32(22,n,!0),e.pagesWritten++,e.currentLacingValues.length=0,e.currentPageData.length=0,e.currentPageSize=27,e.currentPageStartsWithFreshPacket=!0,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(a),this.format._options.onPage){let{data:o,start:c}=this.writer.stopTrackingWrites();this.format._options.onPage(o,c,e.track.source)}}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let t of this.trackDatas)t.currentLacingValues.length>0&&this.writePage(t,!0);e()}},kd=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer)}writeU16(e){this.helperView.setUint16(0,e,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,e,!0),this.helperView.setUint32(4,Math.floor(e/2**32),!0),this.writer.write(this.helper)}writeAscii(e){this.writer.write(new TextEncoder().encode(e))}},yd=class extends Yt{constructor(e,t){super(e),this.headerWritten=!1,this.dataSize=0,this.sampleRate=null,this.sampleCount=0,this.riffSizePos=null,this.dataSizePos=null,this.ds64RiffSizePos=null,this.ds64DataSizePos=null,this.ds64SampleCountPos=null,this.format=t,this.writer=e._writer,this.riffWriter=new kd(e._writer),this.isRf64=!!t._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{if(this.headerWritten||(dr(r),d(r),d(r.decoderConfig),this.writeHeader(e,r.decoderConfig),this.sampleRate=r.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),!this.isRf64&&this.writer.getPos()+t.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(t.data),this.dataSize+=t.data.byteLength,this.sampleCount+=Math.round(t.duration*this.sampleRate),await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(e,t){this.format._options.onHeader&&this.writer.startTrackingWrites();let r,i=e.source._codec,s=ut(i);s.dataType==="ulaw"?r=7:s.dataType==="alaw"?r=6:s.dataType==="float"?r=3:r=1;let a=t.numberOfChannels,n=t.sampleRate,o=s.sampleSize*a;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.riffSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.ds64RiffSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64DataSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64SampleCountPos=this.writer.getPos(),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(r),this.riffWriter.writeU16(a),this.riffWriter.writeU32(n),this.riffWriter.writeU32(n*o),this.riffWriter.writeU16(o),this.riffWriter.writeU16(8*s.sampleSize),!ri(this.output._metadataTags)){let c=this.format._options.metadataFormat??"info";c==="info"?this.writeInfoChunk(this.output._metadataTags):c==="id3"?this.writeId3Chunk(this.output._metadataTags):Me(c)}if(this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.dataSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.format._options.onHeader){let{data:c,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(c,l)}}writeInfoChunk(e){let t=this.writer.getPos();this.riffWriter.writeAscii("LIST"),this.riffWriter.writeU32(0),this.riffWriter.writeAscii("INFO");let r=new Set,i=(n,o)=>{if(!xe(o)){console.warn("Didn't write tag '".concat(n,"' because '").concat(o,"' is not ISO 8859-1-compatible."));return}let c=o.length+1,l=new Uint8Array(c);for(let u=0;u<o.length;u++)l[u]=o.charCodeAt(u);this.riffWriter.writeAscii(n),this.riffWriter.writeU32(c),this.writer.write(l),c&1&&this.writer.write(new Uint8Array(1)),r.add(n)};for(let{key:n,value:o}of cr(e))switch(n){case"title":i("INAM",o),r.add("INAM");break;case"artist":i("IART",o),r.add("IART");break;case"album":i("IPRD",o),r.add("IPRD");break;case"trackNumber":{let c=e.tracksTotal!==void 0?"".concat(o,"/").concat(e.tracksTotal):o.toString();i("ITRK",c),r.add("ITRK")}break;case"genre":i("IGNR",o),r.add("IGNR");break;case"date":i("ICRD",o.toISOString().slice(0,10)),r.add("ICRD");break;case"comment":i("ICMT",o),r.add("ICMT");break;case"albumArtist":case"discNumber":case"tracksTotal":case"discsTotal":case"description":case"lyrics":case"images":break;case"raw":break;default:Me(n)}if(e.raw)for(let n in e.raw){let o=e.raw[n];o==null||n.length!==4||r.has(n)||typeof o=="string"&&i(n,o)}let s=this.writer.getPos(),a=s-t-8;this.writer.seek(t+4),this.riffWriter.writeU32(a),this.writer.seek(s),a&1&&this.writer.write(new Uint8Array(1))}writeId3Chunk(e){let t=this.writer.getPos();this.riffWriter.writeAscii("ID3 "),this.riffWriter.writeU32(0);let i=new tn(this.writer).writeId3V2Tag(e),s=this.writer.getPos();this.writer.seek(t+4),this.riffWriter.writeU32(i),this.writer.seek(s),i&1&&this.writer.write(new Uint8Array(1))}async finalize(){let e=await this.mutex.acquire(),t=this.writer.getPos();this.isRf64?(d(this.ds64RiffSizePos!==null),this.writer.seek(this.ds64RiffSizePos),this.riffWriter.writeU64(t-8),d(this.ds64DataSizePos!==null),this.writer.seek(this.ds64DataSizePos),this.riffWriter.writeU64(this.dataSize),d(this.ds64SampleCountPos!==null),this.writer.seek(this.ds64SampleCountPos),this.riffWriter.writeU64(this.sampleCount)):(d(this.riffSizePos!==null),this.writer.seek(this.riffSizePos),this.riffWriter.writeU32(t-8),d(this.dataSizePos!==null),this.writer.seek(this.dataSizePos),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(t),e()}},It=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>Fe.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>Ne.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>lt.includes(e))}_codecUnsupportedHint(e){return""}},Ps=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","reserve","fragmented"].includes(e.fastStart))throw new TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(e.minimumFragmentDuration!==void 0&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(e.onFtyp!==void 0&&typeof e.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(e.onMoov!==void 0&&typeof e.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(e.onMdat!==void 0&&typeof e.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(e.onMoof!==void 0&&typeof e.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");if(e.metadataFormat!==void 0&&!["mdir","mdta","udta","auto"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new ud(e,this)}},Is=class extends Ps{constructor(e){super(e)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...Fe,...Xt,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...lt]}_codecUnsupportedHint(e){return new Es().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}},Es=class extends Ps{constructor(e){super(e)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...Fe,...Ne]}_codecUnsupportedHint(e){return new Is().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}},As=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.appendOnly!==void 0&&typeof e.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(e.minimumClusterDuration!==void 0&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(e.onEbmlHeader!==void 0&&typeof e.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(e.onSegmentHeader!==void 0&&typeof e.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(e.onCluster!==void 0&&typeof e.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new md(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...Fe,...Xt,...Te.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...lt]}get supportsVideoRotationMetadata(){return!1}},Bs=class extends As{constructor(e){super(e)}getSupportedCodecs(){return[...Fe.filter(e=>["vp8","vp9","av1"].includes(e)),...Ne.filter(e=>["opus","vorbis"].includes(e)),...lt]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new As().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}},Td=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.xingHeader!==void 0&&typeof e.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(e.onXingFrame!==void 0&&typeof e.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new gd(e,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},Sd=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.large!==void 0&&typeof e.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(e.metadataFormat!==void 0&&!["info","id3"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'info' or 'id3'.");if(e.onHeader!==void 0&&typeof e.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new yd(e,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...Te.filter(e=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},vd=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onPage!==void 0&&typeof e.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new bd(e,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...Ne.filter(e=>["vorbis","opus"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},_d=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onFrame!==void 0&&typeof e.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new vc(e,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}},Cd=class extends It{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");super(),this._options=e}_createMuxer(e){return new jl(e,this)}get _name(){return"FLAC"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".flac"}get mimeType(){return"audio/flac"}getSupportedCodecs(){return["flac"]}get supportsVideoRotationMetadata(){return!1}},Ms=e=>{if(!e||typeof e!="object")throw new TypeError("Encoding config must be an object.");if(!Fe.includes(e.codec))throw new TypeError("Invalid video codec '".concat(e.codec,"'. Must be one of: ").concat(Fe.join(", "),"."));if(!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(e.keyFrameInterval!==void 0&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(e.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(e.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(e.onEncodedPacket!==void 0&&typeof e.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(e.onEncoderConfig!==void 0&&typeof e.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");no(e.codec,e)},no=(e,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.alpha!==void 0&&!["discard","keep"].includes(t.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.latencyMode!==void 0&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&ba(t.fullCodecString)!==e)throw new TypeError("fullCodecString, when provided, must be a string that matches the specified codec (".concat(e,")."));if(t.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(t.scalabilityMode!==void 0&&typeof t.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(t.contentHint!==void 0&&typeof t.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},Fs=e=>{let t=e.bitrate instanceof Ve?e.bitrate._toVideoBitrate(e.codec,e.width,e.height):e.bitrate;return{codec:e.fullCodecString??hc(e.codec,e.width,e.height,t),width:e.width,height:e.height,bitrate:t,bitrateMode:e.bitrateMode,alpha:e.alpha??"discard",framerate:e.framerate,latencyMode:e.latencyMode,hardwareAcceleration:e.hardwareAcceleration,scalabilityMode:e.scalabilityMode,contentHint:e.contentHint,...pc(e.codec)}},zs=e=>{if(!e||typeof e!="object")throw new TypeError("Encoding config must be an object.");if(!Ne.includes(e.codec))throw new TypeError("Invalid audio codec '".concat(e.codec,"'. Must be one of: ").concat(Ne.join(", "),"."));if(e.bitrate===void 0&&(!Te.includes(e.codec)||e.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(e.bitrate!==void 0&&!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(e.onEncodedPacket!==void 0&&typeof e.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(e.onEncoderConfig!==void 0&&typeof e.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");oo(e.codec,e)},oo=(e,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&ba(t.fullCodecString)!==e)throw new TypeError("fullCodecString, when provided, must be a string that matches the specified codec (".concat(e,")."))},Rs=e=>{let t=e.bitrate instanceof Ve?e.bitrate._toAudioBitrate(e.codec):e.bitrate;return{codec:e.fullCodecString??mc(e.codec,e.numberOfChannels,e.sampleRate),numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,bitrate:t,bitrateMode:e.bitrateMode,...gc(e.codec)}},Ve=class{constructor(e){this._factor=e}_toVideoBitrate(e,t,r){let i=t*r,s={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},a=1920*1080,n=3e6,o=Math.pow(i/a,.95),u=n*o*s[e]*this._factor;return Math.ceil(u/1e3)*1e3}_toAudioBitrate(e){if(Te.includes(e)||e==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!r)throw new Error("Unhandled codec: ".concat(e));let i=r*this._factor;return e==="aac"?i=[96e3,128e3,16e4,192e3].reduce((a,n)=>Math.abs(n-i)<Math.abs(a-i)?n:a):e==="opus"||e==="vorbis"?i=Math.max(6e3,i):e==="mp3"&&(i=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((a,n)=>Math.abs(n-i)<Math.abs(a-i)?n:a)),Math.round(i/1e3)*1e3}},xd=new Ve(.3),Pd=new Ve(.6),Id=new Ve(1),Ds=new Ve(2),Ed=new Ve(4),Ad=e=>{if(Fe.includes(e))return Ti(e);if(Ne.includes(e))return Si(e);if(lt.includes(e))return vi(e);throw new TypeError("Unknown codec '".concat(e,"'."))},Ti=async(e,t={})=>{let{width:r=1280,height:i=720,bitrate:s=1e6,...a}=t;if(!Fe.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("height must be a positive integer.");if(!(s instanceof Ve)&&(!Number.isInteger(s)||s<=0))throw new TypeError("bitrate must be a positive integer or a quality.");no(e,a);let n=null;return Mr.length>0&&(n??(n=Fs({codec:e,width:r,height:i,bitrate:s,framerate:void 0,...a})),Mr.some(l=>l.supports(e,n)))?!0:typeof VideoEncoder>"u"||(r%2===1||i%2===1)&&(e==="avc"||e==="hevc")?!1:(n??(n=Fs({codec:e,width:r,height:i,bitrate:s,framerate:void 0,...a,alpha:"discard"})),(await VideoEncoder.isConfigSupported(n)).supported===!0)},Si=async(e,t={})=>{let{numberOfChannels:r=2,sampleRate:i=48e3,bitrate:s=128e3,...a}=t;if(!Ne.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(s instanceof Ve)&&(!Number.isInteger(s)||s<=0))throw new TypeError("bitrate must be a positive integer.");oo(e,a);let n=null;return Fr.length>0&&(n??(n=Rs({codec:e,numberOfChannels:r,sampleRate:i,bitrate:s,...a})),Fr.some(c=>c.supports(e,n)))||Te.includes(e)?!0:typeof AudioEncoder>"u"?!1:(n??(n=Rs({codec:e,numberOfChannels:r,sampleRate:i,bitrate:s,...a})),(await AudioEncoder.isConfigSupported(n)).supported===!0)},vi=async e=>!!lt.includes(e),Bd=async()=>{let[e,t,r]=await Promise.all([co(),_i(),lo()]);return[...e,...t,...r]},co=async(e=Fe,t)=>{let r=await Promise.all(e.map(i=>Ti(i,t)));return e.filter((i,s)=>r[s])},_i=async(e=Ne,t)=>{let r=await Promise.all(e.map(i=>Si(i,t)));return e.filter((i,s)=>r[s])},lo=async(e=lt)=>{let t=await Promise.all(e.map(vi));return e.filter((r,i)=>t[i])},uo=async(e,t)=>{for(let r of e)if(await Ti(r,t))return r;return null},Md=async(e,t)=>{for(let r of e)if(await Si(r,t))return r;return null},Fd=async e=>{for(let t of e)if(await vi(t))return t;return null},Ci=class{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;let e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise?this._closingPromise:this._flushAndClose(e)}},vr=class extends Ci{constructor(e){if(super(),this._connectedTrack=null,!Fe.includes(e))throw new TypeError("Invalid video codec '".concat(e,"'. Must be one of: ").concat(Fe.join(", "),"."));this._codec=e}},ho=class extends vr{constructor(e){super(e)}add(e,t){if(!(e instanceof pe))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}},Os=class{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new ei,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){let n=this.encodingConfig.sizeChangeBehavior??"deny";if(n!=="passThrough"){if(n==="deny")throw new Error("Video sample size must remain constant. Expected ".concat(this.codedWidth,"x").concat(this.codedHeight,", got ").concat(e.codedWidth,"x").concat(e.codedHeight,". To allow the sample size to change over time, set `sizeChangeBehavior` to a value other than 'strict' in the encoding options."));{let o=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),o=!0);let c=this.resizeCanvas.getContext("2d",{alpha:Ar()});d(c),o||(Ar()?(c.fillStyle="black",c.fillRect(0,0,this.codedWidth,this.codedHeight)):c.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(c,{fit:n}),t&&e.close(),e=new je(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),d(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,s=Math.floor(e.timestamp/i),a={...r,keyFrame:r?.keyFrame||i===0||s!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=s,this.customEncoder){this.customEncoderQueueSize++;let n=e.clone(),o=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(n,a)).then(()=>this.customEncoderQueueSize--).catch(c=>this.error??(this.error=c)).finally(()=>{n.close()});this.customEncoderQueueSize>=4&&await o}else{d(this.encoder);let n=e.toVideoFrame();if(!this.alphaEncoder)this.encoder.encode(n,a),n.close();else if(!!n.format&&!n.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(n,a),n.close();else{let c=n.displayWidth,l=n.displayHeight;if(!this.splitter)try{this.splitter=new zd(c,l)}catch(u){console.error("Due to an error, only color data will be encoded.",u),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(n,a),n.close()}if(this.splitter){let u=this.splitter.extractColor(n),h=this.splitter.extractAlpha(n);this.alphaFrameQueue.push(h),this.encoder.encode(u,a),u.close(),n.close()}}t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(o=>this.encoder.addEventListener("dequeue",o,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){let t=new Error;this.ensureEncoderPromise=(async()=>{let r=Fs({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let i=Mr.find(s=>s.supports(this.encodingConfig.codec,r));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(s,a)=>{if(!(s instanceof pe))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(a!==void 0&&(!a||typeof a!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,a),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,s,a).catch(n=>{this.error??(this.error=n),this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(r.alpha="discard",this.encodingConfig.alpha==="keep"&&(r.latencyMode="quality"),(r.width%2===1||r.height%2===1)&&(this.encodingConfig.codec==="avc"||this.encodingConfig.codec==="hevc"))throw new Error("The dimensions ".concat(r.width,"x").concat(r.height," are not supported for codec '").concat(this.encodingConfig.codec,"'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number."));if(!(await VideoEncoder.isConfigSupported(r)).supported)throw new Error("This specific encoder configuration (".concat(r.codec,", ").concat(r.bitrate," bps, ").concat(r.width,"x").concat(r.height,", hardware acceleration: ").concat(r.hardwareAcceleration??"no-preference",") is not supported by this browser. Consider using another codec or changing your video parameters."));let n=[],o=[],c=0,l=0,u=(h,f,g)=>{let w={};if(f){let y=new Uint8Array(f.byteLength);f.copyTo(y),w.alpha=y}let p=pe.fromEncodedChunk(h,w);this.encodingConfig.onEncodedPacket?.(p,g),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,p,g).catch(y=>{this.error??(this.error=y),this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(h,f)=>{if(!this.alphaEncoder){u(h,null,f);return}let g=this.alphaFrameQueue.shift();d(g!==void 0),g?(this.alphaEncoder.encode(g,{keyFrame:h.type==="key"}),l++,g.close(),n.push({chunk:h,meta:f})):l===0?u(h,null,f):(o.push(c+l),n.push({chunk:h,meta:f}))},error:h=>{h.stack=t.stack,this.error??(this.error=h)}}),this.encoder.configure(r),this.encodingConfig.alpha==="keep"&&(this.alphaEncoder=new VideoEncoder({output:(h,f)=>{l--;let g=n.shift();for(d(g!==void 0),u(g.chunk,h,g.meta),c++;o.length>0&&o[0]===c;){o.shift();let w=n.shift();d(w!==void 0),u(w.chunk,null,w.meta)}},error:h=>{h.stack=t.stack,this.error??(this.error=h)}}),this.alphaEncoder.configure(r))}d(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await this.alphaEncoder?.flush()),this.encoder.state!=="closed"&&this.encoder.close(),this.alphaEncoder&&this.alphaEncoder.state!=="closed"&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(t=>t?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},zd=class{constructor(e,t){this.lastFrame=null,typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);let r=this.canvas.getContext("webgl2",{alpha:!0});if(!r)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=r,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n			in vec2 a_position;\n			in vec2 a_texCoord;\n			out vec2 v_texCoord;\n			\n			void main() {\n				gl_Position = vec4(a_position, 0.0, 1.0);\n				v_texCoord = a_texCoord;\n			}\n		")}createColorProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_sourceTexture;\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n			\n			void main() {\n				vec4 source = texture(u_sourceTexture, v_texCoord);\n				fragColor = vec4(source.rgb, 1.0);\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createAlphaProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_sourceTexture;\n			uniform vec2 u_resolution; // The width and height of the canvas\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n\n			// This function determines the value for a single byte in the YUV stream\n			float getByteValue(float byteOffset) {\n				float width = u_resolution.x;\n				float height = u_resolution.y;\n\n				float yPlaneSize = width * height;\n\n				if (byteOffset < yPlaneSize) {\n					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from\n					float y = floor(byteOffset / width);\n					float x = mod(byteOffset, width);\n					\n					// Add 0.5 to sample the center of the texel\n					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;\n					\n					// The luma value is the alpha from the source texture\n					return texture(u_sourceTexture, sampleCoord).a;\n				} else {\n					// Write a fixed value for chroma and beyond\n					return 128.0 / 255.0;\n				}\n			}\n			\n			void main() {\n				// Each fragment writes 4 bytes (R, G, B, A)\n				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);\n				float baseByteOffset = pixelIndex * 4.0;\n\n				vec4 result;\n				for (int i = 0; i < 4; i++) {\n					float currentByteOffset = baseByteOffset + float(i);\n					result[i] = getByteValue(currentByteOffset);\n				}\n				\n				fragColor = result;\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(r)),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.colorProgram,"a_position"),s=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&((e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);let{width:t,height:r}=this.canvas,i=Math.ceil(t/2)*Math.ceil(r/2),s=t*r+i*2,a=Math.ceil(s/(t*4)),n=new Uint8Array(4*t*a);this.gl.readPixels(0,0,t,a,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n),n=n.subarray(0,s),d(n[t*r]===128),d(n[n.length-1]===128);let o={format:"I420",codedWidth:t,codedHeight:r,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[n.buffer]};return new VideoFrame(n,o)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},Ns=class extends vr{constructor(e){Ms(e),super(e.codec),this._encoder=new Os(this,e)}add(e,t){if(!(e instanceof je))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Rd=class extends vr{constructor(e,t){if(!(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");Ms(t),super(t.codec),this._encoder=new Os(this,t),this._canvas=e}add(e,t=0,r){if(!Number.isFinite(e)||e<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(t)||t<0)throw new TypeError("duration must be a non-negative number.");let i=new je(this._canvas,{timestamp:e,duration:t});return this._encoder.add(i,!0,r)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Dd=class extends vr{constructor(e,t){if(!(e instanceof MediaStreamTrack)||e.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");Ms(t),t={...t,latencyMode:"realtime"},super(t.codec),this._abortController=null,this._workerTrackId=null,this._workerListener=null,this._promiseWithResolvers=we(),this._errorPromiseAccessed=!1,this._encoder=new Os(this,t),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,t=!1,r=i=>{if(t){i.close();return}if(e===null){e=i.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new je(i),!0).catch(s=>{t=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(s),this._workerTrackId!==null&&Ws({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let i=new MediaStreamTrackProcessor({track:this._track}),s=new WritableStream({write:r});i.readable.pipeTo(s,{signal:this._abortController.signal}).catch(a=>{a instanceof DOMException&&a.name==="AbortError"||this._promiseWithResolvers.reject(a)})}else if(await Wd())this._workerTrackId=Ld++,Ws({type:"videoTrack",trackId:this._workerTrackId,track:this._track},[this._track]),this._workerListener=s=>{let a=s.data;a.type==="videoFrame"&&a.trackId===this._workerTrackId?r(a.videoFrame):a.type==="error"&&a.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(a.error)},Xe.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(d(this._workerListener),Ws({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(t=>{let r=i=>{let s=i.data;s.type==="trackStopped"&&s.trackId===this._workerTrackId&&(d(this._workerListener),Xe.removeEventListener("message",this._workerListener),Xe.removeEventListener("message",r),t())};Xe.addEventListener("message",r)})),await this._encoder.flushAndClose(e)}},_r=class extends Ci{constructor(e){if(super(),this._connectedTrack=null,!Ne.includes(e))throw new TypeError("Invalid audio codec '".concat(e,"'. Must be one of: ").concat(Ne.join(", "),"."));this._codec=e}},fo=class extends _r{constructor(e){super(e)}add(e,t){if(!(e instanceof pe))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}},Us=class{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new ei,this.customEncoderQueueSize=0,this.error=null,this.errorNeedsNewStack=!0}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error("Audio parameters must remain constant. Expected ".concat(this.lastNumberOfChannels," channels at ").concat(this.lastSampleRate," Hz, got ").concat(e.numberOfChannels," channels at ").concat(e.sampleRate," Hz."))}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),d(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let r=e.clone(),i=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(s=>this.error??(this.error=s)).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await i,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{d(this.encoder);let r=e.toAudioData();this.encoder.encode(r),r.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(i=>this.encoder.addEventListener("dequeue",i,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){d(this.outputSampleSize),d(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:s,timestamp:a}=e,n=2048,o=[];for(let h=0;h<i;h+=n){let f=Math.min(n,e.numberOfFrames-h),g=f*r*this.outputSampleSize,w=new ArrayBuffer(g),p=new DataView(w);o.push({frameCount:f,view:p})}let c=e.allocationSize({planeIndex:0,format:"f32-planar"}),l=new Float32Array(c/Float32Array.BYTES_PER_ELEMENT);for(let h=0;h<r;h++){e.copyTo(l,{planeIndex:h,format:"f32-planar"});for(let f=0;f<o.length;f++){let{frameCount:g,view:w}=o[f];for(let p=0;p<g;p++)this.writeOutputValue(w,(p*r+h)*this.outputSampleSize,l[f*n+p])}}t&&e.close();let u={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:s}};for(let h=0;h<o.length;h++){let{frameCount:f,view:g}=o[h],w=g.buffer,p=h*n,y=new pe(new Uint8Array(w),"key",a+p/s,f/s);this.encodingConfig.onEncodedPacket?.(y,u),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,y,u)}}ensureEncoder(e){let t=new Error;this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:i}=e,s=Rs({numberOfChannels:r,sampleRate:i,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(s);let a=Fr.find(n=>n.supports(this.encodingConfig.codec,s));if(a)this.customEncoder=new a,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=s,this.customEncoder.onPacket=(n,o)=>{if(!(n instanceof pe))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(o!==void 0&&(!o||typeof o!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(n,o),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,n,o).catch(c=>{this.error??(this.error=c),this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(Te.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(s)).supported)throw new Error("This specific encoder configuration (".concat(s.codec,", ").concat(s.bitrate," bps, ").concat(s.numberOfChannels," channels, ").concat(s.sampleRate," Hz) is not supported by this browser. Consider using another codec or changing your audio parameters."));this.encoder=new AudioEncoder({output:(o,c)=>{let l=pe.fromEncodedChunk(o);this.encodingConfig.onEncodedPacket?.(l,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,l,c).catch(u=>{this.error??(this.error=u),this.errorNeedsNewStack=!1})},error:o=>{o.stack=t.stack,this.error??(this.error=o)}}),this.encoder.configure(s)}d(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:r,littleEndian:i}=ut(e);switch(this.outputSampleSize=r,r){case 1:t==="unsigned"?this.writeOutputValue=(s,a,n)=>s.setUint8(a,_e((n+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(s,a,n)=>{s.setInt8(a,_e(Math.round(n*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(s,a,n)=>{let o=_e(Math.floor(n*32767),-32768,32767);s.setUint8(a,Nc(o))}:t==="alaw"?this.writeOutputValue=(s,a,n)=>{let o=_e(Math.floor(n*32767),-32768,32767);s.setUint8(a,Lc(o))}:d(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(s,a,n)=>s.setUint16(a,_e((n+1)*32767.5,0,65535),i):t==="signed"?this.writeOutputValue=(s,a,n)=>s.setInt16(a,_e(Math.round(n*32767),-32768,32767),i):d(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(s,a,n)=>ia(s,a,_e((n+1)*83886075e-1,0,16777215),i):t==="signed"?this.writeOutputValue=(s,a,n)=>ic(s,a,_e(Math.round(n*8388607),-8388608,8388607),i):d(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(s,a,n)=>s.setUint32(a,_e((n+1)*21474836475e-1,0,4294967295),i):t==="signed"?this.writeOutputValue=(s,a,n)=>s.setInt32(a,_e(Math.round(n*2147483647),-2147483648,2147483647),i):t==="float"?this.writeOutputValue=(s,a,n)=>s.setFloat32(a,n,i):d(!1);break;case 8:t==="float"?this.writeOutputValue=(s,a,n)=>s.setFloat64(a,n,i):d(!1);break;default:Me(r),d(!1)}}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},Ls=class extends _r{constructor(e){zs(e),super(e.codec),this._encoder=new Us(this,e)}add(e){if(!(e instanceof dt))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Od=class extends _r{constructor(e){zs(e),super(e.codec),this._accumulatedTime=0,this._encoder=new Us(this,e)}async add(e){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let t=dt._fromAudioBuffer(e,this._accumulatedTime);this._accumulatedTime+=e.duration;for(let r of t)await this._encoder.add(r,!0)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Nd=class extends _r{constructor(e,t){if(!(e instanceof MediaStreamTrack)||e.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");zs(t),super(t.codec),this._abortController=null,this._audioContext=null,this._scriptProcessorNode=null,this._promiseWithResolvers=we(),this._errorPromiseAccessed=!1,this._encoder=new Us(this,t),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){if(this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController,typeof MediaStreamTrackProcessor<"u"){let e=null,t=new MediaStreamTrackProcessor({track:this._track}),r=new WritableStream({write:i=>{if(e===null){e=i.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new dt(i),!0).catch(s=>{this._abortController?.abort(),this._promiseWithResolvers.reject(s)})}});t.readable.pipeTo(r,{signal:this._abortController.signal}).catch(i=>{i instanceof DOMException&&i.name==="AbortError"||this._promiseWithResolvers.reject(i)})}else{let e=window.AudioContext||window.webkitAudioContext;this._audioContext=new e({sampleRate:this._track.getSettings().sampleRate});let t=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),t.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let r=!1,i=0;this._scriptProcessorNode.onaudioprocess=s=>{let a=dt._fromAudioBuffer(s.inputBuffer,i);i+=s.inputBuffer.duration;for(let n of a){if(!r){r=!0;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?o.firstMediaStreamTimestamp=performance.now()/1e3:this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp}if(this._encoder.getQueueSize()>=4){n.close();continue}this._encoder.add(n,!0).catch(o=>{this._audioContext.suspend(),this._promiseWithResolvers.reject(o)})}}}}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(d(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(e)}},Ud=()=>{let e=(i,s)=>{s?self.postMessage(i,{transfer:s}):self.postMessage(i)};e({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let t=new Map,r=new Set;self.addEventListener("message",i=>{let s=i.data;switch(s.type){case"videoTrack":{let a=new MediaStreamTrackProcessor({track:s.track}),n=new WritableStream({write:c=>{if(r.has(s.trackId)){c.close();return}e({type:"videoFrame",trackId:s.trackId,videoFrame:c},[c])}}),o=new AbortController;t.set(s.trackId,o),a.readable.pipeTo(n,{signal:o.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||e({type:"error",trackId:s.trackId,error:c})})}break;case"stopTrack":{let a=t.get(s.trackId);a&&(a.abort(),t.delete(s.trackId)),r.add(s.trackId),e({type:"trackStopped",trackId:s.trackId})}break;default:Me(s)}})},Ld=0,Xe=null,Vd=()=>{let e=new Blob(["(".concat(Ud.toString(),")()")],{type:"application/javascript"}),t=URL.createObjectURL(e);Xe=new Worker(t)},Vs=null,Wd=async()=>Vs!==null?Vs:(Xe||Vd(),new Promise(e=>{d(Xe);let t=r=>{let i=r.data;i.type==="support"&&(Vs=i.supported,Xe.removeEventListener("message",t),e(i.supported))};Xe.addEventListener("message",t)})),Ws=(e,t)=>{d(Xe),t?Xe.postMessage(e,t):Xe.postMessage(e)},Hs=class extends Ci{constructor(e){if(super(),this._connectedTrack=null,!lt.includes(e))throw new TypeError("Invalid subtitle codec '".concat(e,"'. Must be one of: ").concat(lt.join(", "),"."));this._codec=e}},Hd=class extends Hs{constructor(e){super(e),this._error=null,this._parser=new Kl({codec:e,output:(t,r)=>{this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,t,r).catch(i=>{this._error??(this._error=i)})}})}add(e){if(typeof e!="string")throw new TypeError("text must be a string.");return this._checkForError(),this._ensureValidAdd(),this._parser.parse(e),this._connectedTrack.output._muxer.mutex.currentPromise}_checkForError(){if(this._error)throw this._error}async _flushAndClose(e){e||this._checkForError()}},mo=["video","audio","subtitle"],qs=e=>{if(!e||typeof e!="object")throw new TypeError("metadata must be an object.");if(e.languageCode!==void 0&&!Er(e.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(e.name!==void 0&&typeof e.name!="string")throw new TypeError("metadata.name, when provided, must be a string.");if(e.maximumPacketCount!==void 0&&(!Number.isInteger(e.maximumPacketCount)||e.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")},$s=class{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new Tt,this._metadataTags={},!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof It))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof Sr))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof vr))throw new TypeError("source must be a VideoSource.");if(qs(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("Invalid video rotation: ".concat(t.rotation,". Has to be 0, 90, 180 or 270."));if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error("".concat(this.format._name," does not support video rotation metadata."));if(t.frameRate!==void 0&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError("Invalid video frame rate: ".concat(t.frameRate,". Must be a positive number."));this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof _r))throw new TypeError("source must be an AudioSource.");qs(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof Hs))throw new TypeError("source must be a SubtitleSource.");qs(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if(Di(e),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),s=this._tracks.reduce((c,l)=>c+(l.type===e?1:0),0),a=i[e].max;if(s===a)throw new Error(a===0?"".concat(this.format._name," does not support ").concat(e," tracks."):"".concat(this.format._name," does not support more than ").concat(a," ").concat(e," track").concat(a===1?"":"s","."));let n=i.total.max;if(this._tracks.length===n)throw new Error("".concat(this.format._name," does not support more than ").concat(n," tracks").concat(n===1?"":"s"," in total."));let o={id:this._tracks.length+1,output:this,type:e,source:t,metadata:r};if(o.type==="video"){let c=this.format.getSupportedVideoCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support video tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported video codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}else if(o.type==="audio"){let c=this.format.getSupportedAudioCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support audio tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported audio codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}else if(o.type==="subtitle"){let c=this.format.getSupportedSubtitleCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support subtitle tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported subtitle codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}this._tracks.push(o),t._connectedTrack=o}async start(){let e=this.format.getSupportedTrackCounts();for(let r of mo){let i=this._tracks.reduce((a,n)=>a+(n.type===r?1:0),0),s=e[r].min;if(i<s)throw new Error(s===e[r].max?"".concat(this.format._name," requires exactly ").concat(s," ").concat(r," track").concat(s===1?"":"s","."):"".concat(this.format._name," requires at least ").concat(s," ").concat(r," track").concat(s===1?"":"s","."))}let t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?"".concat(this.format._name," requires exactly ").concat(t," track").concat(t===1?"":"s","."):"".concat(this.format._name," requires at least ").concat(t," track").concat(t===1?"":"s","."));if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let i=this._tracks.map(s=>s.source._start());await Promise.all(i),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}},po=e=>{if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("options.video, when provided, must be an object.");if(e?.discard!==void 0&&typeof e.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(e?.forceTranscode!==void 0&&typeof e.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(e?.codec!==void 0&&!Fe.includes(e.codec))throw new TypeError("options.video.codec, when provided, must be one of: ".concat(Fe.join(", "),"."));if(e?.bitrate!==void 0&&!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(e?.width!==void 0&&(!Number.isInteger(e.width)||e.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(e?.height!==void 0&&(!Number.isInteger(e.height)||e.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(e?.fit!==void 0&&!["fill","contain","cover"].includes(e.fit))throw new TypeError("options.video.fit, when provided, must be one of 'fill', 'contain', or 'cover'.");if(e?.width!==void 0&&e.height!==void 0&&e.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(e?.rotate!==void 0&&![0,90,180,270].includes(e.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(e?.crop!==void 0&&Wi(e.crop,"options.video."),e?.frameRate!==void 0&&(!Number.isFinite(e.frameRate)||e.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.");if(e?.alpha!==void 0&&!["discard","keep"].includes(e.alpha))throw new TypeError("options.video.alpha, when provided, must be either 'discard' or 'keep'.");if(e?.keyFrameInterval!==void 0&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("options.video.keyFrameInterval, when provided, must be a non-negative number.");if(e?.process!==void 0&&typeof e.process!="function")throw new TypeError("options.video.process, when provided, must be a function.");if(e?.processedWidth!==void 0&&(!Number.isInteger(e.processedWidth)||e.processedWidth<=0))throw new TypeError("options.video.processedWidth, when provided, must be a positive integer.");if(e?.processedHeight!==void 0&&(!Number.isInteger(e.processedHeight)||e.processedHeight<=0))throw new TypeError("options.video.processedHeight, when provided, must be a positive integer.")},go=e=>{if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(e?.discard!==void 0&&typeof e.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(e?.forceTranscode!==void 0&&typeof e.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(e?.codec!==void 0&&!Ne.includes(e.codec))throw new TypeError("options.audio.codec, when provided, must be one of: ".concat(Ne.join(", "),"."));if(e?.bitrate!==void 0&&!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(e?.numberOfChannels!==void 0&&(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(e?.sampleRate!==void 0&&(!Number.isInteger(e.sampleRate)||e.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(e?.process!==void 0&&typeof e.process!="function")throw new TypeError("options.audio.process, when provided, must be a function.");if(e?.processedNumberOfChannels!==void 0&&(!Number.isInteger(e.processedNumberOfChannels)||e.processedNumberOfChannels<=0))throw new TypeError("options.audio.processedNumberOfChannels, when provided, must be a positive integer.");if(e?.processedSampleRate!==void 0&&(!Number.isInteger(e.processedSampleRate)||e.processedSampleRate<=0))throw new TypeError("options.audio.processedSampleRate, when provided, must be a positive integer.")},js=2,Qs=48e3,qd=class Ko{constructor(t){if(this._addedCounts={video:0,audio:0,subtitle:0},this._totalTrackCount=0,this._trackPromises=[],this._executed=!1,this._synchronizer=new $d,this._totalDuration=null,this._maxTimestamps=new Map,this._canceled=!1,this.onProgress=void 0,this._computeProgress=!1,this._lastProgress=0,this.isValid=!1,this.utilizedTracks=[],this.discardedTracks=[],!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.input instanceof Fn))throw new TypeError("options.input must be an Input.");if(!(t.output instanceof $s))throw new TypeError("options.output must be an Output.");if(t.output._tracks.length>0||Object.keys(t.output._metadataTags).length>0||t.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks or metadata tags added and not started.");if(typeof t.video!="function"&&po(t.video),typeof t.audio!="function"&&go(t.audio),t.trim!==void 0&&(!t.trim||typeof t.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(t.trim?.start!==void 0&&(!Number.isFinite(t.trim.start)||t.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(t.trim?.end!==void 0&&(!Number.isFinite(t.trim.end)||t.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(t.trim?.start!==void 0&&t.trim.end!==void 0&&t.trim.start>=t.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(t.tags!==void 0&&(typeof t.tags!="object"||!t.tags)&&typeof t.tags!="function")throw new TypeError("options.tags, when provided, must be an object or a function.");if(typeof t.tags=="object"&&Di(t.tags),t.showWarnings!==void 0&&typeof t.showWarnings!="boolean")throw new TypeError("options.showWarnings, when provided, must be a boolean.");this._options=t,this.input=t.input,this.output=t.output,this._startTimestamp=t.trim?.start??0,this._endTimestamp=t.trim?.end??1/0;let{promise:r,resolve:i}=we();this._started=r,this._start=i}static async init(t){let r=new Ko(t);return await r._init(),r}async _init(){let t=await this.input.getTracks(),r=this.output.format.getSupportedTrackCounts(),i=1,s=1;for(let l of t){let u;if(l.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(u=await this._options.video(l,i),po(u),i++):u=this._options.video):l.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(u=await this._options.audio(l,s),go(u),s++):u=this._options.audio):d(!1),u?.discard){this.discardedTracks.push({track:l,reason:"discarded_by_user"});continue}if(this._totalTrackCount===r.total.max){this.discardedTracks.push({track:l,reason:"max_track_count_reached"});continue}if(this._addedCounts[l.type]===r[l.type].max){this.discardedTracks.push({track:l,reason:"max_track_count_of_type_reached"});continue}l.isVideoTrack()?await this._processVideoTrack(l,u??{}):l.isAudioTrack()&&await this._processAudioTrack(l,u??{})}let a=await this.input.getMetadataTags(),n;if(this._options.tags){let l=typeof this._options.tags=="function"?await this._options.tags(a):this._options.tags;Di(l),n=l}else n=a;let o=(await this.input.getFormat()).mimeType===this.output.format.mimeType,c=a.raw===n.raw;if(a.raw&&c&&!o&&delete n.raw,this.output.setMetadataTags(n),this.isValid=this._totalTrackCount>=r.total.min&&this._addedCounts.video>=r.video.min&&this._addedCounts.audio>=r.audio.min&&this._addedCounts.subtitle>=r.subtitle.min,this._options.showWarnings??!0){let l=[],u=this.discardedTracks.filter(h=>h.reason!=="discarded_by_user");u.length>0&&l.push("Some tracks had to be discarded from the conversion:",u),this.isValid||l.push("\n\n"+this._getInvalidityExplanation().join("")),l.length>0&&console.warn(...l)}}_getInvalidityExplanation(){let t=[];if(this.discardedTracks.length===0)t.push("Due to missing tracks, this conversion cannot be executed.");else{let r=this.discardedTracks.every(i=>i.reason==="discarded_by_user"||i.reason==="no_encodable_target_codec");if(t.push("Due to discarded tracks, this conversion cannot be executed."),r){let i=this.discardedTracks.flatMap(s=>s.reason==="discarded_by_user"?[]:s.track.type==="video"?this.output.format.getSupportedVideoCodecs():s.track.type==="audio"?this.output.format.getSupportedAudioCodecs():this.output.format.getSupportedSubtitleCodecs());i.length===1?t.push("\nTracks were discarded because your environment is not able to encode '".concat(i[0],"'.")):t.push("\nTracks were discarded because your environment is not able to encode any of the following codecs: ".concat(i.map(s=>"'".concat(s,"'")).join(", "),".")),i.includes("mp3")&&t.push("\nThe @mediabunny/mp3-encoder extension package provides support for encoding MP3.")}else t.push("\nCheck the discardedTracks field for more info.")}return t}async execute(){if(!this.isValid)throw new Error("Cannot execute this conversion because its output configuration is invalid. Make sure to always check the isValid field before executing a conversion.\n"+this._getInvalidityExplanation().join(""));if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(let t of this.utilizedTracks)this._maxTimestamps.set(t.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(t){throw this._canceled||this.cancel(),t}this._canceled&&await new Promise(()=>{}),await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(t,r){let i=t.codec;if(!i){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let s,a=kt(t.rotation+(r.rotate??0)),n=this.output.format.supportsVideoRotationMetadata,[o,c]=a%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],l=r.crop;l&&Vi(l,o,c);let[u,h]=l?[l.width,l.height]:[o,c],f=u,g=h,w=f/g,p=A=>Math.ceil(A/2)*2;r.width!==void 0&&r.height===void 0?(f=p(r.width),g=p(Math.round(f/w))):r.width===void 0&&r.height!==void 0?(g=p(r.height),f=p(Math.round(g*w))):r.width!==void 0&&r.height!==void 0&&(f=p(r.width),g=p(r.height));let y=await t.getFirstTimestamp(),b=!!r.forceTranscode||this._startTimestamp>0||y<0||!!r.frameRate||r.keyFrameInterval!==void 0||r.process!==void 0,T=f!==u||g!==h||a!==0&&!n||!!l,v=r.alpha??"discard",P=this.output.format.getSupportedVideoCodecs();if(!b&&!r.bitrate&&!T&&P.includes(i)&&(!r.codec||r.codec===i)){let A=new ho(i);s=A,this._trackPromises.push((async()=>{await this._started;let I=new fr(t),L={decoderConfig:await t.getDecoderConfig()??void 0},ue=Number.isFinite(this._endTimestamp)?await I.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let K of I.packets(void 0,ue,{verifyKeyPackets:!0})){if(this._canceled)return;v==="discard"&&(delete K.sideData.alpha,delete K.sideData.alphaByteLength),this._reportProgress(t.id,K.timestamp),await A.add(K,L),this._synchronizer.shouldWait(t.id,K.timestamp)&&await this._synchronizer.wait(K.timestamp)}A.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}r.codec&&(P=P.filter(K=>K===r.codec));let I=r.bitrate??Ds,M=await uo(P,{width:r.process&&r.processedWidth?r.processedWidth:f,height:r.process&&r.processedHeight?r.processedHeight:g,bitrate:I});if(!M){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}let L={codec:M,bitrate:I,keyFrameInterval:r.keyFrameInterval,sizeChangeBehavior:r.fit??"passThrough",alpha:v},ue=new Ns(L);if(s=ue,!T){let K=new $s({format:new Is,target:new ro}),V=new Ns(L);K.addVideoTrack(V),await K.start();let de=await new li(t).getSample(y);if(de)try{await V.add(de),de.close(),await K.finalize()}catch(We){console.info("Error when probing encoder support. Falling back to rerender path.",We),T=!0,K.cancel()}else await K.cancel()}T?this._trackPromises.push((async()=>{await this._started;let V=new Da(t,{width:f,height:g,fit:r.fit??"fill",rotation:a,crop:r.crop,poolSize:1,alpha:v==="keep"}).canvases(this._startTimestamp,this._endTimestamp),J=r.frameRate,de=null,We=null,Et=null,Ee=async Ae=>{d(de),d(J!==void 0);let ze=Math.round((Ae-We)*J);for(let At=1;At<ze;At++){let gt=new je(de,{timestamp:We+At/J,duration:1/J});await this._registerVideoSample(t,r,ue,gt)}};for await(let{canvas:Ae,timestamp:ze,duration:At}of V){if(this._canceled)return;let gt=Math.max(ze-this._startTimestamp,0);if(Et=gt+At,J!==void 0){let m=Math.floor(gt*J)/J;if(de!==null)if(m<=We){de=Ae,We=m;continue}else await Ee(m);gt=m}let qr=new je(Ae,{timestamp:gt,duration:J!==void 0?1/J:At});await this._registerVideoSample(t,r,ue,qr),J!==void 0?(de=Ae,We=gt):qr.close()}de&&(d(Et!==null),d(J!==void 0),await Ee(Math.floor(Et*J)/J)),ue.close(),this._synchronizer.closeTrack(t.id)})()):this._trackPromises.push((async()=>{await this._started;let K=new li(t),V=r.frameRate,J=null,de=null,We=null,Et=async Ee=>{d(J),d(V!==void 0);let Ae=Math.round((Ee-de)*V);for(let ze=1;ze<Ae;ze++)J.setTimestamp(de+ze/V),J.setDuration(1/V),await this._registerVideoSample(t,r,ue,J);J.close()};for await(let Ee of K.samples(this._startTimestamp,this._endTimestamp)){if(this._canceled){J?.close();return}let Ae=Math.max(Ee.timestamp-this._startTimestamp,0);if(We=Ae+Ee.duration,V!==void 0){let ze=Math.floor(Ae*V)/V;if(J!==null)if(ze<=de){J.close(),J=Ee,de=ze;continue}else await Et(ze);Ae=ze,Ee.setDuration(1/V)}Ee.setTimestamp(Ae),await this._registerVideoSample(t,r,ue,Ee),V!==void 0?(J=Ee,de=Ae):Ee.close()}J&&(d(We!==null),d(V!==void 0),await Et(Math.floor(We*V)/V)),ue.close(),this._synchronizer.closeTrack(t.id)})())}this.output.addVideoTrack(s,{frameRate:r.frameRate,languageCode:Er(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,rotation:T?0:a}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerVideoSample(t,r,i,s){if(this._canceled)return;this._reportProgress(t.id,s.timestamp);let a;if(!r.process)a=[s];else{let n=r.process(s);n instanceof Promise&&(n=await n),Array.isArray(n)||(n=n===null?[]:[n]),a=n.map(o=>o instanceof je?o:typeof VideoFrame<"u"&&o instanceof VideoFrame?new je(o):new je(o,{timestamp:s.timestamp,duration:s.duration}))}for(let n of a){if(this._canceled)break;await i.add(n),this._synchronizer.shouldWait(t.id,n.timestamp)&&await this._synchronizer.wait(n.timestamp)}for(let n of a)n!==s&&n.close()}async _processAudioTrack(t,r){let i=t.codec;if(!i){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let s,a=t.numberOfChannels,n=t.sampleRate,o=await t.getFirstTimestamp(),c=r.numberOfChannels??a,l=r.sampleRate??n,u=c!==a||l!==n||this._startTimestamp>0||o<0,h=this.output.format.getSupportedAudioCodecs();if(!r.forceTranscode&&!r.bitrate&&!u&&h.includes(i)&&(!r.codec||r.codec===i)&&!r.process){let f=new fo(i);s=f,this._trackPromises.push((async()=>{await this._started;let g=new fr(t),p={decoderConfig:await t.getDecoderConfig()??void 0},y=Number.isFinite(this._endTimestamp)?await g.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let b of g.packets(void 0,y)){if(this._canceled)return;this._reportProgress(t.id,b.timestamp),await f.add(b,p),this._synchronizer.shouldWait(t.id,b.timestamp)&&await this._synchronizer.wait(b.timestamp)}f.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}let g=null;r.codec&&(h=h.filter(y=>y===r.codec));let w=r.bitrate??Ds,p=await _i(h,{numberOfChannels:r.process&&r.processedNumberOfChannels?r.processedNumberOfChannels:c,sampleRate:r.process&&r.processedSampleRate?r.processedSampleRate:l,bitrate:w});if(!p.some(y=>Xt.includes(y))&&h.some(y=>Xt.includes(y))&&(c!==js||l!==Qs)){let b=(await _i(h,{numberOfChannels:js,sampleRate:Qs,bitrate:w})).find(T=>Xt.includes(T));b&&(u=!0,g=b,c=js,l=Qs)}else g=p[0]??null;if(g===null){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}if(u)s=this._resampleAudio(t,r,g,c,l,w);else{let y=new Ls({codec:g,bitrate:w});s=y,this._trackPromises.push((async()=>{await this._started;let b=new ui(t);for await(let T of b.samples(void 0,this._endTimestamp)){if(this._canceled)return;await this._registerAudioSample(t,r,y,T),T.close()}y.close(),this._synchronizer.closeTrack(t.id)})())}}this.output.addAudioTrack(s,{languageCode:Er(t.languageCode)?t.languageCode:void 0,name:t.name??void 0}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerAudioSample(t,r,i,s){if(this._canceled)return;this._reportProgress(t.id,s.timestamp);let a;if(!r.process)a=[s];else{let n=r.process(s);if(n instanceof Promise&&(n=await n),Array.isArray(n)||(n=n===null?[]:[n]),!n.every(o=>o instanceof dt))throw new TypeError("The audio process function must return an AudioSample, null, or an array of AudioSamples.");a=n}for(let n of a){if(this._canceled)break;await i.add(n),this._synchronizer.shouldWait(t.id,n.timestamp)&&await this._synchronizer.wait(n.timestamp)}for(let n of a)n!==s&&n.close()}_resampleAudio(t,r,i,s,a,n){let o=new Ls({codec:i,bitrate:n});return this._trackPromises.push((async()=>{await this._started;let c=new jd({targetNumberOfChannels:s,targetSampleRate:a,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:h=>this._registerAudioSample(t,r,o,h)}),u=new ui(t).samples(this._startTimestamp,this._endTimestamp);for await(let h of u){if(this._canceled)return;await c.add(h)}await c.finalize(),o.close(),this._synchronizer.closeTrack(t.id)})()),o}_reportProgress(t,r){if(!this._computeProgress)return;d(this._totalDuration!==null),this._maxTimestamps.set(t,Math.max(r,this._maxTimestamps.get(t)));let i=Math.min(...this._maxTimestamps.values()),s=_e(i/this._totalDuration,0,1);s!==this._lastProgress&&(this._lastProgress=s,this.onProgress?.(s))}},wo=5,$d=class{constructor(){this.maxTimestamps=new Map,this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(let[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){let r=this.resolvers[t];r.timestamp-e<wo&&(r.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));let r=this.computeMinAndMaybeResolve();return t-r>=wo}wait(e){let{promise:t,resolve:r}=we();return this.resolvers.push({timestamp:e,resolve:r}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}},jd=class{constructor(e){this.sourceSampleRate=null,this.sourceNumberOfChannels=null,this.targetSampleRate=e.targetSampleRate,this.targetNumberOfChannels=e.targetNumberOfChannels,this.startTime=e.startTime,this.endTime=e.endTime,this.onSample=e.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){d(this.sourceNumberOfChannels!==null);let e=this.sourceNumberOfChannels,t=this.targetNumberOfChannels;e===1&&t===2?this.channelMixer=(r,i)=>r[i*e]:e===1&&t===4?this.channelMixer=(r,i,s)=>r[i*e]*+(s<2):e===1&&t===6?this.channelMixer=(r,i,s)=>r[i*e]*+(s===2):e===2&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return .5*(r[s]+r[s+1])}:e===2&&t===4?this.channelMixer=(r,i,s)=>r[i*e+s]*+(s<2):e===2&&t===6?this.channelMixer=(r,i,s)=>r[i*e+s]*+(s<2):e===4&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return .25*(r[s]+r[s+1]+r[s+2]+r[s+3])}:e===4&&t===2?this.channelMixer=(r,i,s)=>{let a=i*e;return .5*(r[a+s]+r[a+s+2])}:e===4&&t===6?this.channelMixer=(r,i,s)=>{let a=i*e;return s<2?r[a+s]:s===2||s===3?0:r[a+s-2]}:e===6&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return Math.SQRT1_2*(r[s]+r[s+1])+r[s+2]+.5*(r[s+4]+r[s+5])}:e===6&&t===2?this.channelMixer=(r,i,s)=>{let a=i*e;return r[a+s]+Math.SQRT1_2*(r[a+2]+r[a+s+4])}:e===6&&t===4?this.channelMixer=(r,i,s)=>{let a=i*e;return s<2?r[a+s]+Math.SQRT1_2*r[a+2]:r[a+s+2]}:this.channelMixer=(r,i,s)=>s<e?r[i*e+s]:0}ensureTempBufferSize(e){let t=this.tempSourceBuffer.length;for(;t<e;)t*=2;if(t!==this.tempSourceBuffer.length){let r=new Float32Array(t);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(e){this.sourceSampleRate===null&&(this.sourceSampleRate=e.sampleRate,this.sourceNumberOfChannels=e.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());let t=e.numberOfFrames*e.numberOfChannels;this.ensureTempBufferSize(t);let r=e.allocationSize({planeIndex:0,format:"f32"}),i=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);e.copyTo(i,{planeIndex:0,format:"f32"});let s=e.timestamp-this.startTime,a=e.numberOfFrames/this.sourceSampleRate,n=Math.min(s+a,this.endTime-this.startTime),o=Math.floor(s*this.targetSampleRate),c=Math.ceil(n*this.targetSampleRate);for(let l=o;l<c;l++){if(l<this.bufferStartFrame)continue;for(;l>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let u=l-this.bufferStartFrame;d(u<this.bufferSizeInFrames);let g=(l/this.targetSampleRate-s)*this.sourceSampleRate,w=Math.floor(g),p=Math.ceil(g),y=g-w;for(let b=0;b<this.targetNumberOfChannels;b++){let T=0,v=0;w>=0&&w<e.numberOfFrames&&(T=this.channelMixer(i,w,b)),p>=0&&p<e.numberOfFrames&&(v=this.channelMixer(i,p,b));let P=T+y*(v-T),A=u*this.targetNumberOfChannels+b;this.outputBuffer[A]+=P}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,u)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let e=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,t=new Float32Array(e);t.set(this.outputBuffer.subarray(0,e));let r=this.bufferStartFrame/this.targetSampleRate,i=new dt({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:t});await this.onSample(i),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};return Mt(ye)})();typeof Ii=="object"&&typeof Ii.exports=="object"&&Object.assign(Ii.exports,bh)});var Jo=Re((Bp,Zo)=>{var Ei=xi(),kh=Xs(),{Output:yh,Mp4OutputFormat:Th,StreamTarget:Sh,VideoSampleSource:vh,VideoSample:Xo,QUALITY_HIGH:_h}=Go(),Ch=require("fs/promises"),De,$t,bt,Yo;Zo.exports=(Yo=class{constructor(){Ke(this,De);Ke(this,$t,{});Ke(this,bt,{});_(this,"getOnTop",async()=>await W(this,De).ipc.main.getOnTop());_(this,"setOnTop",async(x=!0)=>await W(this,De).ipc.main.setOnTop(x));_(this,"setStatus",(x,k)=>{typeof x=="string"&&[-1,0,1].includes(k)&&(W(this,$t)[x]=k)});_(this,"videoStart",async(x,k,S,C=null,N=20,X="av1",me=!1,Oe=!1)=>{let qe="".concat(k,"-").concat(S),Mt=W(this,bt)[x]??null;if(Mt!==null){if(qe===Mt.recKey)return Mt.filePath;throw new Error("Cannot record more than one video per agent")}let{fileName:Be,filePath:ye,minSize:d,maxSize:kt}=await W(this,De).ipc.diskStorage.outputFilesInit(x,k,S,C??"mp4");W(this,bt)[x]={recKey:qe,filePath:ye};let ce=0,Je=0,ne=Number.isInteger(kt)?kt*1048576:null,U=1e3/N,jt={av1:"av1",h264:"avc"},Kr=()=>{W(this,De).ibc.send(Ei.WINDOW_MAIN,"ibc-target:video:info",[x,{fileName:"\u{1F3A5} ".concat(Be),rec:!0,total:Je}])},le=(ee=null)=>{W(this,$t)[x]===1&&W(this,De).ibc.send(Ei.WINDOW_MAIN,"ibc-target:download:info",[x,qe,{fileName:"\u{1F3A5} ".concat(Be),totalBytes:ce,progress:"100",done:!0,error:ee}]),delete W(this,bt)[x],W(this,De).ibc.send(Ei.WINDOW_MAIN,"ibc-target:video:info",[x,{fileName:"\u{1F3A5} ".concat(Be),rec:!1,total:Je}]),ee!==null&&W(this,De).ipc.diskStorage.outputFilesDelete(x,k,Be)};try{if(W(this,bt)[x]?.recKey!==qe||![1,0].includes(W(this,$t)[x]))throw new Error("Video recording cancelled");let ee=new vh({codec:jt[X]??"av1",bitrate:_h,sizeChangeBehavior:"fill",alpha:"discard"}),Se=new yh({format:new Th({fastStart:!1}),target:new Sh(new WritableStream({start:async()=>{this._fileHandle=await Ch.open(ye,"w")},write:async xe=>{await this._fileHandle.write(xe.data,0,xe.data.byteLength,xe.position),ce+=xe.data.byteLength,ne!==null&&ce>=ne&&delete W(this,bt)[x]},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}}),{chunked:!0,chunkSize:262144})});Se.addVideoTrack(ee),Se.setMetadataTags({title:Be,artist:"oglama.com",date:new Date,comment:"Generated by Oglama",raw:{"\xA9cpy":"\xA9 ".concat(new Date().getFullYear()," https://oglama.com/")}}),(async()=>{Kr();try{let xe=Math.floor(performance.now()/1e3);await Se.start();let nr=null,yt=null;if(!me){let tt=await W(this,De).ipc.target.getBounds(x);nr=tt.width,yt=tt.height}let{imgData:Gr,imgSize:et}=await W(this,De).ipc.target.getScreenshotData(x,nr,yt,!0);if(!et?.width||!et?.height)throw new Error("Cannot record video");await ee.add(new Xo(Gr,{timestamp:0,duration:1/N,format:"BGRA",codedWidth:et.width,codedHeight:et.height,rotation:0}));let Ir=1;for(;W(this,bt)[x]?.recKey===qe&&[1,0].includes(W(this,$t)[x]);){if(W(this,$t)[x]===0&&!Oe){await new Promise(Ft=>setTimeout(Ft,250));continue}let tt=performance.now(),{imgData:Xr,imgSize:Qt}=await W(this,De).ipc.target.getScreenshotData(x);if(!Qt?.width||!Qt?.height){await new Promise(Ft=>setTimeout(Ft,250));continue}await ee.add(new Xo(Xr,{timestamp:Ir*U/1e3,duration:1/N,format:"BGRA",codedWidth:Qt.width,codedHeight:Qt.height,rotation:0})),Ir++;let Kt=Math.floor(performance.now()/1e3)-xe;Kt>Je&&(Je=Kt,Kr());let Tt=performance.now()-tt;Tt<U&&await new Promise(Ft=>setTimeout(Ft,U-Tt))}le(),await Se.finalize()}catch(xe){await Se.finalize(),le("".concat(xe.message??xe))}do{if(ce<=0){le('Failed to record video as "'.concat(Be,'"'));break}if(Number.isInteger(d)&&ce<d*1048576){le('Minimum file size not met for "'.concat(Be,'" (').concat((ce/1048576).toFixed(3),"MB)"));break}}while(!1)})()}catch(ee){return le("".concat(ee.message??ee)),null}return ye});_(this,"videoStop",async x=>{typeof x=="string"&&delete W(this,bt)[x]});sr(this,De,new kh(Ei.WINDOW_MAIN).getSdk());for(let x of Object.getOwnPropertyNames(this))typeof this[x]=="function"&&W(this,De).ibc.handle(x,this[x])}},De=new WeakMap,$t=new WeakMap,bt=new WeakMap,Yo)});var xh=jo(),Ph=Jo(),Ih=process.argv.filter(Y=>Y.indexOf("--win-type=")>=0).shift();switch("".concat(Ih).split("=")[1]){case"main/login":new xh;break;default:new Ph}
