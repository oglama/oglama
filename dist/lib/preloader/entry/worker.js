/*!
 * @architect Mark Jivko <mark@oglama.com>
 * @copyright © 2024-2026 Oglama™ (https://oglama.com)
 * 
 * Licensed under the Oglama™ Source-Available License, Version 1.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *     https://github.com/oglama/oglama/blob/main/LICENSE.txt
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
var Zd=Object.defineProperty;var _o=Y=>{throw TypeError(Y)};var Jd=(Y,A,g)=>A in Y?Zd(Y,A,{enumerable:!0,configurable:!0,writable:!0,value:g}):Y[A]=g;var He=(Y,A)=>()=>(A||Y((A={exports:{}}).exports,A),A.exports);var v=(Y,A,g)=>Jd(Y,typeof A!="symbol"?A+"":A,g),Co=(Y,A,g)=>A.has(Y)||_o("Cannot "+g);var P=(Y,A,g)=>(Co(Y,A,"read from private field"),g?g.call(Y):A.get(Y)),Pe=(Y,A,g)=>A.has(Y)?_o("Cannot add the same private member more than once"):A instanceof WeakSet?A.add(Y):A.set(Y,g),ft=(Y,A,g,S)=>(Co(Y,A,"write to private field"),S?S.call(Y,g):A.set(Y,g),g);var ra=He((Ah,xo)=>{var Ge;xo.exports=(Ge=class{static getSourceChannelName(A){return"".concat(Ge.WINDOW_SOURCE,"/").concat(A)}static getTargetChannelName(A){return"".concat(Ge.WINDOW_TARGET,"/").concat(A)}static getWorkerChannelName(A){return"".concat(Ge.WINDOW_WORKER,"/").concat(A)}static generateKey(){return"".concat(Date.now().toString(36)).concat(Math.random().toString(36).substring(2,13))}},v(Ge,"WINDOW_MAIN_LOGIN","@main/login"),v(Ge,"WINDOW_MAIN","@main"),v(Ge,"WINDOW_SOURCE","@source"),v(Ge,"WINDOW_TARGET","@target"),v(Ge,"WINDOW_WORKER","@worker"),Ge)});var mt=He((Fh,Po)=>{var cr,Gt,Zr,lr;Po.exports=(cr=class{constructor(){Pe(this,Gt,{});Pe(this,Zr,!1);Pe(this,lr,null)}_useRPC(A){ft(this,Zr,Number.isInteger(A)&&A>0?A:!1)}_register(A){if(typeof A=="string")for(let g of Object.getOwnPropertyNames(this))["_","#"].includes(g[0])||typeof this[g]!="function"||(P(this,Gt)[g]="ipc:".concat(A,":").concat(g))}_runner(A,...g){let S=P(this,Zr),C=function(U,Q,pe){this.run=async function(){let oe=null;if(typeof P(U,Gt)[Q]=="string")if(S)try{let Se=await fetch("http://0.0.0.0:".concat(S,"/ipc"),{method:"POST",headers:{"content-type":"application/json"},body:JSON.stringify({channel:P(U,Gt)[Q],args:pe})});oe=Se.ok?await Se.json():new Error(await Se.json())}catch(Se){oe=new Error("".concat(Se.message??Se))}else{if(P(U,lr)===null)try{ft(U,lr,require("electron").ipcRenderer)}catch{}oe=typeof P(U,lr)?.invoke=="function"?await P(U,lr).invoke(P(U,Gt)[Q],...pe):null}if(oe instanceof Error)throw new Error("".concat(cr.devMode?"".concat(S?"rpc:":"").concat(P(U,Gt)[Q]," "):"").concat(oe.message??oe));return oe}};return new C(this,A,g)}async _promise(A,...g){return await this._runner(A,...g).run()}},Gt=new WeakMap,Zr=new WeakMap,lr=new WeakMap,v(cr,"devMode",!1),cr)});var Eo=He((Rh,Io)=>{var eh=mt();Io.exports=class extends eh{constructor(){super();v(this,"openAgentFiles",g=>this._promise("openAgentFiles",g));v(this,"purge",g=>this._promise("purge",g));v(this,"runInit",(g,S=null,C=null,U=null)=>this._promise("runInit",g,S,C,U));v(this,"runDelete",(g,S)=>this._promise("runDelete",g,S));v(this,"envGet",g=>this._promise("envGet",g));v(this,"envSet",(g,S)=>this._promise("envSet",g,S));v(this,"sourceGet",g=>this._promise("sourceGet",g));v(this,"sourceSet",(g,S)=>this._promise("sourceSet",g,S));v(this,"inputsGet",(g,S="session",C=null)=>this._promise("inputsGet",g,S,C));v(this,"inputScalarsSet",(g,S,C=null)=>this._promise("inputScalarsSet",g,S,C));v(this,"inputFilesAdd",(g,S,C,U=null)=>this._promise("inputFilesAdd",g,S,C,U));v(this,"inputFilesDelete",(g,S,C,U=null)=>this._promise("inputFilesDelete",g,S,C,U));v(this,"inputTableQuery",(g,S,C=1,U=5e3,Q=null)=>this._promise("inputTableQuery",g,S,C,U,Q));v(this,"inputTableAdd",(g,S,C=[],U=null)=>this._promise("inputTableAdd",g,S,C,U));v(this,"inputTableGet",(g,S,C,U="session",Q=null)=>this._promise("inputTableGet",g,S,C,U,Q));v(this,"inputTableUpdate",(g,S,C,U,Q=null)=>this._promise("inputTableUpdate",g,S,C,U,Q));v(this,"inputTableDelete",(g,S,C=null,U=null)=>this._promise("inputTableDelete",g,S,C,U));v(this,"outputTableQuery",(g,S,C,U=1,Q=5e3)=>this._promise("outputTableQuery",g,S,C,U,Q));v(this,"outputTableAdd",(g,S,C,U)=>this._promise("outputTableAdd",g,S,C,U));v(this,"outputsGet",(g,S)=>this._promise("outputsGet",g,S));v(this,"outputsQuery",(g,S,C=null,U=null,Q=null)=>this._promise("outputsQuery",g,S,C,U,Q));v(this,"outputScalarSet",async(g,S,C,U)=>this._promise("outputScalarSet",g,S,C,U));v(this,"outputFilesInit",async(g,S,C,U=null)=>this._promise("outputFilesInit",g,S,C,U));v(this,"outputFilesAppend",async(g,S,C,U,Q=null)=>this._promise("outputFilesAppend",g,S,C,U,Q));v(this,"outputFilesDelete",async(g,S,C)=>this._promise("outputFilesDelete",g,S,C));this._register("diskStorage")}}});var Bo=He((Nh,Ao)=>{var th=mt();Ao.exports=class extends th{constructor(){super();v(this,"getAt",(g,S)=>this._promise("getAt",g,S));v(this,"create",(g,S,C)=>this._promise("create",g,S,C));v(this,"readAll",(g,S)=>this._promise("readAll",g,S));v(this,"read",(g,S)=>this._promise("read",g,S));v(this,"updateName",(g,S,C)=>this._promise("updateName",g,S,C));v(this,"updateInfo",(g,S,C)=>this._promise("updateInfo",g,S,C));v(this,"updateReady",(g,S,C)=>this._promise("updateReady",g,S,C));v(this,"updateEnabled",(g,S,C)=>this._promise("updateEnabled",g,S,C));v(this,"delete",(g,S=null,C=null)=>this._promise("delete",g,S,C));this._register("session")}}});var Mo=He((Vh,Fo)=>{var rh=mt();Fo.exports=class extends rh{constructor(){super();v(this,"install",()=>this._promise("install"));v(this,"check",()=>this._promise("check"));this._register("updater")}}});var Ro=He((qh,zo)=>{var ih=mt();zo.exports=class extends ih{constructor(){super();v(this,"getOS",()=>this._promise("getOS"));v(this,"getName",()=>this._promise("getName"));v(this,"getUUID",()=>this._promise("getUUID"));v(this,"getSerialNumber",()=>this._promise("getSerialNumber"));v(this,"getRam",()=>this._promise("getRam"));v(this,"getCpuArch",()=>this._promise("getCpuArch"));v(this,"getCpuName",()=>this._promise("getCpuName"));v(this,"getFileSize",g=>this._promise("getFileSize",g));v(this,"setPostAuth",g=>this._promise("setPostAuth",!!g));v(this,"getPostAuth",()=>this._promise("getPostAuth"));v(this,"errorLog",(g,S="")=>this._promise("errorLog",g,S));v(this,"showFileInFolder",g=>this._promise("showFileInFolder",g));v(this,"request",(g,S="GET",C={},U={},Q=!0,pe=60,oe=!0)=>this._promise("request",g,S,C,U,Q,pe,oe));this._register("device")}}});var Oo=He((Qh,Do)=>{var sh=mt();Do.exports=class extends sh{constructor(){super();v(this,"list",()=>this._promise("list"));v(this,"closeAll",()=>this._promise("closeAll"));v(this,"open",g=>this._promise("open",g));v(this,"close",g=>this._promise("close",g));v(this,"webContents",(g,S,C)=>this._promise("webContents",g,S,C));this._register("source")}}});var Uo=He((Xh,No)=>{var ah=mt();No.exports=class extends ah{constructor(){super();v(this,"list",()=>this._promise("list"));v(this,"removeAll",()=>this._promise("removeAll"));v(this,"add",(g,S,C=!1)=>this._promise("add",g,S,C));v(this,"initWorker",g=>this._promise("initWorker",g));v(this,"remove",g=>this._promise("remove",g));v(this,"select",g=>this._promise("select",g));v(this,"getSelected",()=>this._promise("getSelected"));v(this,"setControlled",(g,S=!0)=>this._promise("setControlled",g,S));v(this,"openDevTools",(g,S=null)=>this._promise("openDevTools",g,S));v(this,"setDevToolsTitle",(g,S=null)=>this._promise("setDevToolsTitle",g,S));v(this,"getBounds",g=>this._promise("getBounds",g));v(this,"getMouse",g=>this._promise("getMouse",g));v(this,"moveMouse",(g,S,C,U=null,Q=!1,pe=[])=>this._promise("moveMouse",g,S,C,U,Q,pe));v(this,"jiggleMouse",(g,S=50,C=[])=>this._promise("jiggleMouse",g,S,C));v(this,"typeAt",(g,S,C,U,Q=!1,pe=5,oe=250)=>this._promise("typeAt",g,S,C,U,Q,pe,oe));v(this,"loadUrl",(g,S,C=60)=>this._promise("loadUrl",g,S,C));v(this,"getUrl",g=>this._promise("getUrl",g));v(this,"getTitle",g=>this._promise("getTitle",g));v(this,"reload",(g,S=!1,C=60)=>this._promise("reload",g,S,C));v(this,"goHome",g=>this._promise("goHome",g));v(this,"goBack",(g,S=60)=>this._promise("goBack",g,S));v(this,"goForward",(g,S=60)=>this._promise("goForward",g,S));v(this,"setFileInput",(g,S,C)=>this._promise("setFileInput",g,S,C));v(this,"openInNewWindow",(g,S)=>this._promise("openInNewWindow",g,S));v(this,"waitForDomReady",(g,S=60)=>this._promise("waitForDomReady",g,S));v(this,"saveDownload",(g,S,C,U=600,Q=null)=>this._promise("saveDownload",g,S,C,U,Q));v(this,"saveScreenshot",async(g,S,C,U="png",Q=null,pe=!1,oe=100)=>this._promise("saveScreenshot",g,S,C,U,Q,pe,oe));v(this,"captureFrame",(g,S=null,C=null,U=!1,Q=null)=>this._promise("captureFrame",g,S,C,U,Q));v(this,"getPreview",g=>this._promise("getPreview",g));v(this,"smoothScroll",(g,S,C=100,U=!0)=>this._promise("smoothScroll",g,S,C,U));v(this,"webContents",(g,S,C=[],U=null,Q=[])=>this._promise("webContents",g,S,C,U,Q));v(this,"sendKeys",(g,S,C={})=>this._promise("sendKeys",g,S,C));this._register("target")}}});var Vo=He((Jh,Lo)=>{var nh=mt();Lo.exports=class extends nh{constructor(){super();v(this,"openExternal",g=>this._promise("openExternal","".concat(g)));this._register("main/login")}}});var qo=He((rf,Ho)=>{var oh=mt(),ch=Vo(),Br,Wo;Ho.exports=(Wo=class extends oh{constructor(g=!0){super();v(this,"login",null);Pe(this,Br,null);v(this,"focus",()=>this._promise("focus"));v(this,"setOnTop",(g=!0)=>this._promise("setOnTop",!!g));v(this,"getOnTop",()=>this._promise("getOnTop"));v(this,"setDarkMode",g=>this._promise("setDarkMode",!!g));v(this,"getDarkMode",()=>this._promise("getDarkMode"));v(this,"getProcessVersions",()=>this._promise("getProcessVersions"));v(this,"getPathForFile",g=>{if(P(this,Br)===null)try{ft(this,Br,require("electron").webUtils)}catch{}return P(this,Br)?.getPathForFile(g)||""});v(this,"quit",()=>this._promise("quit"));v(this,"openExternal",g=>this._promise("openExternal","".concat(g)));v(this,"showOpenDialog",(g,S=[],C=!1)=>this._promise("showOpenDialog",g,S,C));this._register("main"),g&&(this.login=new ch)}},Br=new WeakMap,Wo)});var jo=He((nf,$o)=>{var lh=mt();$o.exports=class extends lh{constructor(){super();v(this,"init",g=>this._promise("init",g));v(this,"getPort",()=>this._promise("getPort"));this._register("llm")}}});var Go=He((lf,Ko)=>{var{ipcRenderer:Mi,contextBridge:uh}=require("electron"),dh=Eo(),hh=Bo(),fh=Mo(),mh=Ro(),ph=Oo(),gh=Uo(),wh=qo(),bh=jo(),kh=mt(),Xe=ra(),qe,Fr,$e,Mr,Qo;Ko.exports=(Qo=class{constructor(A,g=!0){Pe(this,qe,"");Pe(this,Fr,{});Pe(this,$e,{});Pe(this,Mr,{});v(this,"source",{send:(A,g,S)=>{this.send(Xe.getSourceChannelName(A),g,S)},invoke:async(A,g,S,C=0)=>await this.invoke(Xe.getSourceChannelName(A),g,S,C)});v(this,"target",{send:(A,g,S)=>{(async()=>this.send(Xe.getTargetChannelName(A),g,S))()},invoke:async(A,g,S,C=0)=>await this.invoke(Xe.getTargetChannelName(A),g,S,C)});v(this,"worker",{send:(A,g,S)=>{(async()=>this.send(Xe.getWorkerChannelName(A),g,S))()},invoke:async(A,g,S,C=0)=>await this.invoke(Xe.getWorkerChannelName(A),g,S,C)});let S=this;ft(this,qe,A),kh.devMode=!1,ft(this,Mr,{irc:{handle:(...C)=>this.handle.call(this,...C),send:(...C)=>this.send.call(this,...C),invoke:async(...C)=>await this.invoke.call(this,...C),source:{send:(...C)=>this.source.send.call(this,...C),invoke:async(...C)=>await this.source.invoke.call(this,...C)},target:{send:(...C)=>this.target.send.call(this,...C),invoke:async(...C)=>await this.target.invoke.call(this,...C)},worker:{send:(...C)=>this.worker.send.call(this,...C),invoke:async(...C)=>await this.worker.invoke.call(this,...C)},winName:P(this,qe)},ipc:{diskStorage:new dh,session:new hh,updater:new fh,device:new mh,source:new ph,target:new gh,main:new wh,llm:new bh},devMode:!1}),Mi.on(P(this,qe),(C,U)=>{if(U[0]==="irc-target:cancel-promises"&&typeof U[1]=="string"){for(let _e of Object.keys(P(this,$e)))if(P(this,$e)[_e].toWinName===Xe.getTargetChannelName(U[1])){try{typeof U[2]=="string"?P(this,$e)[_e].reject(new Error(U[2])):P(this,$e)[_e].resolve(null)}catch{}delete P(S,$e)[_e]}return}if(U.length<3)return;let[Q,pe,oe]=U,{type:Se,fromWin:Ze,promiseId:Je}=oe??{};if(Se==="req")(async()=>{let _e=null;try{if(typeof Q!="string"||typeof P(S,Fr)[Q]!="function")throw new Error('Inter-Renderer Communication: handle "'.concat(Q,'" not declared yet'));Array.isArray(pe)||(pe=[]),_e=await P(S,Fr)[Q](...pe)}catch(d){let pt=P(S,qe).indexOf(Xe.WINDOW_TARGET)===0?"irc.target.invoke":P(S,qe).indexOf(Xe.WINDOW_WORKER)===0?"irc.worker.invoke":P(S,qe).indexOf(Xe.WINDOW_SOURCE)===0?"irc.source.invoke":P(S,qe);_e=new Error("".concat(pt,"(").concat(JSON.stringify(Q),") ").concat(d.message??d)),P(S,qe).indexOf(Xe.WINDOW_TARGET)===0||P(S,qe).indexOf(Xe.WINDOW_WORKER)}typeof Ze=="string"&&typeof Je=="string"&&Mi.send(Ze,Q,_e,{type:"res",promiseId:Je})})();else{let _e=typeof Je=="string"?"".concat(Q,":").concat(Je):null;if(_e!==null){let d=P(S,$e)[_e]??null;d!==null&&(pe instanceof Error?d.reject(pe):d.resolve(pe),delete P(S,$e)[_e])}}}),g&&uh.exposeInMainWorld("sdk",P(this,Mr))}getSdk(){return P(this,Mr)}handle(A,g){typeof A=="string"&&typeof g=="function"&&(P(this,Fr)[A]=g)}send(A,g,S){do{if(typeof A!="string"||typeof g!="string")break;Array.isArray(S)||(S=[]),Mi.send(A,g,S,{type:"req",fromWin:P(this,qe)})}while(!1)}async invoke(A,g,S,C=0){let U=this;if(typeof A!="string"||typeof g!="string")return null;Array.isArray(S)||(S=[]),C=parseInt(C,10),(!Number.isInteger(C)||C<0)&&(C=0);let Q=Xe.generateKey(),pe=new Promise((oe,Se)=>{P(this,$e)["".concat(g,":").concat(Q)]={resolve:oe,reject:Se,toWinName:A}});return C>0&&setTimeout(()=>{let oe=typeof Q=="string"?"".concat(g,":").concat(Q):null;if(typeof P(U,$e)[oe]<"u"){try{P(U,$e)[oe].reject(new Error("".concat(g,"() timed out")))}catch{}delete P(U,$e)[oe]}},C*1e3),Mi.send(A,g,S,{type:"req",fromWin:P(this,qe),promiseId:Q}),pe}},qe=new WeakMap,Fr=new WeakMap,$e=new WeakMap,Mr=new WeakMap,Qo)});var Zo=He((df,zi)=>{"use strict";var yh=(()=>{var Y=Object.create,A=Object.defineProperty,g=Object.getOwnPropertyDescriptor,S=Object.getOwnPropertyNames,C=Object.getPrototypeOf,U=Object.prototype.hasOwnProperty,Q=(e,t)=>function(){return t||(0,e[S(e)[0]])((t={exports:{}}).exports,t),t.exports},pe=(e,t)=>{for(var r in t)A(e,r,{get:t[r],enumerable:!0})},oe=(e,t,r,i)=>{if(t&&typeof t=="object"||typeof t=="function")for(let s of S(t))!U.call(e,s)&&s!==r&&A(e,s,{get:()=>t[s],enumerable:!(i=g(t,s))||i.enumerable});return e},Se=(e,t,r)=>(r=e!=null?Y(C(e)):{},oe(t||!e||!e.__esModule?A(r,"default",{value:e,enumerable:!0}):r,e)),Ze=e=>oe(A({},"__esModule",{value:!0}),e),Je=Q({"(disabled):src/node"(){}}),_e={};pe(_e,{ADTS:()=>Mn,ALL_FORMATS:()=>Rl,ALL_TRACK_TYPES:()=>ko,AUDIO_CODECS:()=>Ne,AdtsInputFormat:()=>Cn,AdtsOutputFormat:()=>Id,AttachedFile:()=>ci,AudioBufferSink:()=>Zc,AudioBufferSource:()=>Vd,AudioSample:()=>bt,AudioSampleSink:()=>wi,AudioSampleSource:()=>js,AudioSource:()=>Er,BaseMediaSampleSink:()=>Zi,BlobSource:()=>Nl,BufferSource:()=>Ol,BufferTarget:()=>ao,CanvasSink:()=>Va,CanvasSource:()=>Ud,Conversion:()=>Kd,CustomAudioDecoder:()=>Oa,CustomAudioEncoder:()=>Ua,CustomVideoDecoder:()=>Da,CustomVideoEncoder:()=>Na,EncodedAudioPacketSource:()=>bo,EncodedPacket:()=>we,EncodedPacketSink:()=>br,EncodedVideoPacketSource:()=>wo,FLAC:()=>zn,FilePathSource:()=>Vl,FilePathTarget:()=>dd,FlacInputFormat:()=>_n,FlacOutputFormat:()=>Ed,Input:()=>Nn,InputAudioTrack:()=>ot,InputDisposedError:()=>Ue,InputFormat:()=>Bt,InputTrack:()=>bi,InputVideoTrack:()=>kr,IsobmffInputFormat:()=>bs,IsobmffOutputFormat:()=>Ms,MATROSKA:()=>In,MP3:()=>An,MP4:()=>xn,MatroskaInputFormat:()=>ks,MediaSource:()=>Fi,MediaStreamAudioTrackSource:()=>Wd,MediaStreamVideoTrackSource:()=>Ld,MkvOutputFormat:()=>Ds,MovOutputFormat:()=>Rs,Mp3InputFormat:()=>Tn,Mp3OutputFormat:()=>Cd,Mp4InputFormat:()=>bn,Mp4OutputFormat:()=>zs,NON_PCM_AUDIO_CODECS:()=>er,NullTarget:()=>oo,OGG:()=>Fn,OggInputFormat:()=>vn,OggOutputFormat:()=>Pd,Output:()=>Ys,OutputFormat:()=>Mt,PCM_AUDIO_CODECS:()=>ve,QTFF:()=>Pn,QUALITY_HIGH:()=>Ws,QUALITY_LOW:()=>Bd,QUALITY_MEDIUM:()=>Fd,QUALITY_VERY_HIGH:()=>Md,QUALITY_VERY_LOW:()=>Ad,Quality:()=>Ve,QuickTimeInputFormat:()=>kn,ReadableStreamSource:()=>Wl,RichImageData:()=>Jt,SUBTITLE_CODECS:()=>gt,Source:()=>qt,StreamSource:()=>On,StreamTarget:()=>no,SubtitleSource:()=>Gs,Target:()=>Pr,TextSubtitleSource:()=>Qd,UrlSource:()=>Ll,VIDEO_CODECS:()=>De,VideoSample:()=>Qe,VideoSampleSink:()=>gi,VideoSampleSource:()=>qs,VideoSource:()=>Ir,WAVE:()=>Bn,WEBM:()=>En,WavOutputFormat:()=>xd,WaveInputFormat:()=>Sn,WebMInputFormat:()=>yn,WebMOutputFormat:()=>Os,canEncode:()=>zd,canEncodeAudio:()=>Ei,canEncodeSubtitles:()=>Ai,canEncodeVideo:()=>Ii,getEncodableAudioCodecs:()=>Bi,getEncodableCodecs:()=>Rd,getEncodableSubtitleCodecs:()=>po,getEncodableVideoCodecs:()=>mo,getFirstEncodableAudioCodec:()=>Dd,getFirstEncodableSubtitleCodec:()=>Od,getFirstEncodableVideoCodec:()=>go,registerDecoder:()=>Lc,registerEncoder:()=>Vc});function d(e){if(!e)throw new Error("Assertion failed.")}var pt=e=>{let t=(e%360+360)%360;if(t===0||t===90||t===180||t===270)return t;throw new Error("Invalid rotation ".concat(e,"."))},de=e=>e&&e[e.length-1],at=e=>e>=0&&e<2**32,ce=class Xo{constructor(t){this.bytes=t,this.pos=0}seekToByte(t){this.pos=8*t}readBit(){let t=Math.floor(this.pos/8),r=this.bytes[t]??0,i=7-(this.pos&7),s=(r&1<<i)>>i;return this.pos++,s}readBits(t){if(t===1)return this.readBit();let r=0;for(let i=0;i<t;i++)r<<=1,r|=this.readBit();return r}writeBits(t,r){let i=this.pos+t;for(let s=this.pos;s<i;s++){let a=Math.floor(s/8),n=this.bytes[a],o=7-(s&7);n&=~(1<<o),n|=(r&1<<i-s-1)>>i-s-1<<o,this.bytes[a]=n}this.pos=i}readAlignedByte(){if(this.pos%8!==0)throw new Error("Bitstream is not byte-aligned.");let t=this.pos/8,r=this.bytes[t]??0;return this.pos+=8,r}skipBits(t){this.pos+=t}getBitsLeft(){return this.bytes.length*8-this.pos}clone(){let t=new Xo(this.bytes);return t.pos=this.pos,t}},L=e=>{let t=0;for(;e.readBits(1)===0&&t<32;)t++;if(t>=32)throw new Error("Invalid exponential-Golomb code.");return(1<<t)-1+e.readBits(t)},Dt=e=>{let t=L(e);return(t&1)===0?-(t>>1):t+1>>1},dr=(e,t,r,i)=>{for(let s=t;s<r;s++){let a=Math.floor(s/8),n=e[a],o=7-(s&7);n&=~(1<<o),n|=(i&1<<r-s-1)>>r-s-1<<o,e[a]=n}},ge=e=>e.constructor===Uint8Array?e:e instanceof ArrayBuffer?new Uint8Array(e):new Uint8Array(e.buffer,e.byteOffset,e.byteLength),le=e=>e.constructor===DataView?e:e instanceof ArrayBuffer?new DataView(e):new DataView(e.buffer,e.byteOffset,e.byteLength),Ce=new TextDecoder,J=new TextEncoder,et=e=>{for(let t=0;t<e.length;t++)if(e.charCodeAt(t)>255)return!1;return!0},ti=e=>Object.fromEntries(Object.entries(e).map(([t,r])=>[r,t])),Ae={bt709:1,bt470bg:5,smpte170m:6,bt2020:9,smpte432:12},zr=ti(Ae),_t={bt709:1,smpte170m:6,linear:8,"iec61966-2-1":13,pq:16,hlg:18},ri=ti(_t),nt={rgb:0,bt709:1,bt470bg:5,smpte170m:6,"bt2020-ncl":9},Zt=ti(nt),ii=e=>!!e&&!!e.primaries&&!!e.transfer&&!!e.matrix&&e.fullRange!==void 0,Ct=e=>e instanceof ArrayBuffer||typeof SharedArrayBuffer<"u"&&e instanceof SharedArrayBuffer||ArrayBuffer.isView(e),xt=class{constructor(){this.currentPromise=Promise.resolve()}async acquire(){let e,t=new Promise(i=>{e=i}),r=this.currentPromise;return this.currentPromise=t,await r,e}},Rr=e=>[...e].map(t=>t.toString(16).padStart(2,"0")).join(""),Ot=e=>(e=e>>1&1431655765|(e&1431655765)<<1,e=e>>2&858993459|(e&858993459)<<2,e=e>>4&252645135|(e&252645135)<<4,e=e>>8&16711935|(e&16711935)<<8,e=e>>16&65535|(e&65535)<<16,e>>>0),Di=(e,t,r)=>{let i=0,s=e.length-1,a=-1;for(;i<=s;){let n=i+s>>1,o=r(e[n]);o===t?(a=n,s=n-1):o<t?i=n+1:s=n-1}return a},ue=(e,t,r)=>{let i=0,s=e.length-1,a=-1;for(;i<=s;){let n=i+(s-i+1)/2|0;r(e[n])<=t?(a=n,i=n+1):s=n-1}return a},aa=(e,t,r)=>{let i=ue(e,r(t),r);e.splice(i+1,0,t)},ke=()=>{let e,t;return{promise:new Promise((i,s)=>{e=i,t=s}),resolve:e,reject:t}},na=(e,t)=>{for(let r=e.length-1;r>=0;r--)if(t(e[r]))return e[r]},oa=(e,t)=>{for(let r=e.length-1;r>=0;r--)if(t(e[r]))return r;return-1},sc=async function*(e){Symbol.iterator in e?yield*e[Symbol.iterator]():yield*e[Symbol.asyncIterator]()},ac=e=>{if(!(Symbol.iterator in e)&&!(Symbol.asyncIterator in e))throw new TypeError("Argument must be an iterable or async iterable.")},Re=e=>{throw new Error("Unexpected value: ".concat(e))},si=(e,t,r)=>{let i=e.getUint8(t),s=e.getUint8(t+1),a=e.getUint8(t+2);return r?i|s<<8|a<<16:i<<16|s<<8|a},nc=(e,t,r)=>si(e,t,r)<<8>>8,ca=(e,t,r,i)=>{r=r>>>0,r=r&16777215,i?(e.setUint8(t,r&255),e.setUint8(t+1,r>>>8&255),e.setUint8(t+2,r>>>16&255)):(e.setUint8(t,r>>>16&255),e.setUint8(t+1,r>>>8&255),e.setUint8(t+2,r&255))},oc=(e,t,r,i)=>{r=Ie(r,-8388608,8388607),r<0&&(r=r+16777216&16777215),ca(e,t,r,i)},cc=(e,t,r,i)=>{i?(e.setUint32(t+0,r,!0),e.setInt32(t+4,Math.floor(r/2**32),!0)):(e.setInt32(t+0,Math.floor(r/2**32),!0),e.setUint32(t+4,r,!0))},ai=(e,t)=>({async next(){let r=await e.next();return r.done?{value:void 0,done:!0}:{value:t(r.value),done:!1}},return(){return e.return()},throw(r){return e.throw(r)},[Symbol.asyncIterator](){return this}}),Ie=(e,t,r)=>Math.max(t,Math.min(r,e)),je="und",ni=(e,t)=>{let r=10**t;return Math.round(e*r)/r},Oi=(e,t)=>Math.round(e/t)*t,lc=e=>{let t=0;for(;e;)t++,e>>=1;return t},uc=/^[a-z]{3}$/,Dr=e=>uc.test(e),Nt=1e6*(1+Number.EPSILON),la=(e,t)=>{let r={...e,...t};if(e.headers||t.headers){let i=e.headers?ua(e.headers):{},s=t.headers?ua(t.headers):{},a={...i};Object.entries(s).forEach(([n,o])=>{let c=Object.keys(a).find(l=>l.toLowerCase()===n.toLowerCase());c&&delete a[c],a[n]=o}),r.headers=a}return r},ua=e=>{if(e instanceof Headers){let t={};return e.forEach((r,i)=>{t[i]=r}),t}if(Array.isArray(e)){let t={};return e.forEach(([r,i])=>{t[r]=i}),t}return e},da=async(e,t,r,i)=>{let s=0;for(;;)try{return await e(t,r)}catch(a){s++;let n=i(s,a,t);if(n===null)throw a;if(console.error("Retrying failed fetch. Error:",a),!Number.isFinite(n)||n<0)throw new TypeError("Retry delay must be a non-negative finite number.");n>0&&await new Promise(o=>setTimeout(o,1e3*n))}},dc=(e,t)=>{let r=e<0?-1:1;e=Math.abs(e);let i=0,s=1,a=1,n=0,o=e;for(;;){let c=Math.floor(o),l=c*a+i,u=c*n+s;if(u>t)return{numerator:r*a,denominator:n};if(i=a,s=n,a=l,n=u,o=1/(o-c),!isFinite(o))break}return{numerator:r*a,denominator:n}},oi=class{constructor(){this.currentPromise=Promise.resolve()}call(e){return this.currentPromise=this.currentPromise.then(e)}},Ni=null,Ui=()=>{if(Ni!==null)return Ni;let e=!!(typeof navigator<"u"&&navigator.vendor?.match(/apple/i)&&!navigator.userAgent?.match(/crios/i)&&!navigator.userAgent?.match(/fxios/i)&&!navigator.userAgent?.match(/Opera|OPT\//));return Ni=e,e},Li=null,Or=()=>Li!==null?Li:Li=typeof navigator<"u"&&navigator.userAgent?.includes("Firefox"),hr=(e,t)=>e!==-1?e:t,Vi=(e,t,r,i)=>e<=i&&r<=t,fr=function*(e){for(let t in e){let r=e[t];r!==void 0&&(yield{key:t,value:r})}},hc=e=>{switch(e.toLowerCase()){case"image/jpeg":case"image/jpg":return".jpg";case"image/png":return".png";case"image/gif":return".gif";case"image/webp":return".webp";case"image/bmp":return".bmp";case"image/svg+xml":return".svg";case"image/tiff":return".tiff";case"image/avif":return".avif";case"image/x-icon":case"image/vnd.microsoft.icon":return".ico";default:return null}},fc=e=>{let t=atob(e),r=new Uint8Array(t.length);for(let i=0;i<t.length;i++)r[i]=t.charCodeAt(i);return r},mc=e=>{let t="";for(let r=0;r<e.length;r++)t+=String.fromCharCode(e[r]);return btoa(t)},pc=(e,t)=>{if(e.length!==t.length)return!1;for(let r=0;r<e.length;r++)if(e[r]!==t[r])return!1;return!0},ha=()=>{Symbol.dispose??(Symbol.dispose=Symbol("Symbol.dispose"))},mr=e=>typeof e=="number"&&!Number.isNaN(e),Jt=class{constructor(e,t){if(this.data=e,this.mimeType=t,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(typeof t!="string")throw new TypeError("mimeType must be a string.")}},ci=class{constructor(e,t,r,i){if(this.data=e,this.mimeType=t,this.name=r,this.description=i,!(e instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(t!==void 0&&typeof t!="string")throw new TypeError("mimeType, when provided, must be a string.");if(r!==void 0&&typeof r!="string")throw new TypeError("name, when provided, must be a string.");if(i!==void 0&&typeof i!="string")throw new TypeError("description, when provided, must be a string.")}},Wi=e=>{if(!e||typeof e!="object")throw new TypeError("tags must be an object.");if(e.title!==void 0&&typeof e.title!="string")throw new TypeError("tags.title, when provided, must be a string.");if(e.description!==void 0&&typeof e.description!="string")throw new TypeError("tags.description, when provided, must be a string.");if(e.artist!==void 0&&typeof e.artist!="string")throw new TypeError("tags.artist, when provided, must be a string.");if(e.album!==void 0&&typeof e.album!="string")throw new TypeError("tags.album, when provided, must be a string.");if(e.albumArtist!==void 0&&typeof e.albumArtist!="string")throw new TypeError("tags.albumArtist, when provided, must be a string.");if(e.trackNumber!==void 0&&(!Number.isInteger(e.trackNumber)||e.trackNumber<=0))throw new TypeError("tags.trackNumber, when provided, must be a positive integer.");if(e.tracksTotal!==void 0&&(!Number.isInteger(e.tracksTotal)||e.tracksTotal<=0))throw new TypeError("tags.tracksTotal, when provided, must be a positive integer.");if(e.discNumber!==void 0&&(!Number.isInteger(e.discNumber)||e.discNumber<=0))throw new TypeError("tags.discNumber, when provided, must be a positive integer.");if(e.discsTotal!==void 0&&(!Number.isInteger(e.discsTotal)||e.discsTotal<=0))throw new TypeError("tags.discsTotal, when provided, must be a positive integer.");if(e.genre!==void 0&&typeof e.genre!="string")throw new TypeError("tags.genre, when provided, must be a string.");if(e.date!==void 0&&(!(e.date instanceof Date)||Number.isNaN(e.date.getTime())))throw new TypeError("tags.date, when provided, must be a valid Date.");if(e.lyrics!==void 0&&typeof e.lyrics!="string")throw new TypeError("tags.lyrics, when provided, must be a string.");if(e.images!==void 0){if(!Array.isArray(e.images))throw new TypeError("tags.images, when provided, must be an array.");for(let t of e.images){if(!t||typeof t!="object")throw new TypeError("Each image in tags.images must be an object.");if(!(t.data instanceof Uint8Array))throw new TypeError("Each image.data must be a Uint8Array.");if(typeof t.mimeType!="string")throw new TypeError("Each image.mimeType must be a string.");if(!["coverFront","coverBack","unknown"].includes(t.kind))throw new TypeError("Each image.kind must be 'coverFront', 'coverBack', or 'unknown'.")}}if(e.comment!==void 0&&typeof e.comment!="string")throw new TypeError("tags.comment, when provided, must be a string.");if(e.raw!==void 0){if(!e.raw||typeof e.raw!="object")throw new TypeError("tags.raw, when provided, must be an object.");for(let t of Object.values(e.raw))if(t!==null&&typeof t!="string"&&!(t instanceof Uint8Array)&&!(t instanceof Jt)&&!(t instanceof ci))throw new TypeError("Each value in tags.raw must be a string, Uint8Array, RichImageData, AttachedFile, or null.")}},li=e=>e.title===void 0&&e.description===void 0&&e.artist===void 0&&e.album===void 0&&e.albumArtist===void 0&&e.trackNumber===void 0&&e.tracksTotal===void 0&&e.discNumber===void 0&&e.discsTotal===void 0&&e.genre===void 0&&e.date===void 0&&e.lyrics===void 0&&(!e.images||e.images.length===0)&&e.comment===void 0&&(e.raw===void 0||Object.keys(e.raw).length===0),De=["avc","hevc","vp9","av1","vp8"],ve=["pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be","pcm-u8","pcm-s8","ulaw","alaw"],er=["aac","opus","mp3","vorbis","flac"],Ne=[...er,...ve],gt=["webvtt"],fa=[{maxMacroblocks:99,maxBitrate:64e3,level:10},{maxMacroblocks:396,maxBitrate:192e3,level:11},{maxMacroblocks:396,maxBitrate:384e3,level:12},{maxMacroblocks:396,maxBitrate:768e3,level:13},{maxMacroblocks:396,maxBitrate:2e6,level:20},{maxMacroblocks:792,maxBitrate:4e6,level:21},{maxMacroblocks:1620,maxBitrate:4e6,level:22},{maxMacroblocks:1620,maxBitrate:1e7,level:30},{maxMacroblocks:3600,maxBitrate:14e6,level:31},{maxMacroblocks:5120,maxBitrate:2e7,level:32},{maxMacroblocks:8192,maxBitrate:2e7,level:40},{maxMacroblocks:8192,maxBitrate:5e7,level:41},{maxMacroblocks:8704,maxBitrate:5e7,level:42},{maxMacroblocks:22080,maxBitrate:135e6,level:50},{maxMacroblocks:36864,maxBitrate:24e7,level:51},{maxMacroblocks:36864,maxBitrate:24e7,level:52},{maxMacroblocks:139264,maxBitrate:24e7,level:60},{maxMacroblocks:139264,maxBitrate:48e7,level:61},{maxMacroblocks:139264,maxBitrate:8e8,level:62}],ma=[{maxPictureSize:36864,maxBitrate:128e3,tier:"L",level:30},{maxPictureSize:122880,maxBitrate:15e5,tier:"L",level:60},{maxPictureSize:245760,maxBitrate:3e6,tier:"L",level:63},{maxPictureSize:552960,maxBitrate:6e6,tier:"L",level:90},{maxPictureSize:983040,maxBitrate:1e7,tier:"L",level:93},{maxPictureSize:2228224,maxBitrate:12e6,tier:"L",level:120},{maxPictureSize:2228224,maxBitrate:3e7,tier:"H",level:120},{maxPictureSize:2228224,maxBitrate:2e7,tier:"L",level:123},{maxPictureSize:2228224,maxBitrate:5e7,tier:"H",level:123},{maxPictureSize:8912896,maxBitrate:25e6,tier:"L",level:150},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:150},{maxPictureSize:8912896,maxBitrate:4e7,tier:"L",level:153},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:153},{maxPictureSize:8912896,maxBitrate:6e7,tier:"L",level:156},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:156},{maxPictureSize:35651584,maxBitrate:6e7,tier:"L",level:180},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:180},{maxPictureSize:35651584,maxBitrate:12e7,tier:"L",level:183},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:183},{maxPictureSize:35651584,maxBitrate:24e7,tier:"L",level:186},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:186}],Ut=[{maxPictureSize:36864,maxBitrate:2e5,level:10},{maxPictureSize:73728,maxBitrate:8e5,level:11},{maxPictureSize:122880,maxBitrate:18e5,level:20},{maxPictureSize:245760,maxBitrate:36e5,level:21},{maxPictureSize:552960,maxBitrate:72e5,level:30},{maxPictureSize:983040,maxBitrate:12e6,level:31},{maxPictureSize:2228224,maxBitrate:18e6,level:40},{maxPictureSize:2228224,maxBitrate:3e7,level:41},{maxPictureSize:8912896,maxBitrate:6e7,level:50},{maxPictureSize:8912896,maxBitrate:12e7,level:51},{maxPictureSize:8912896,maxBitrate:18e7,level:52},{maxPictureSize:35651584,maxBitrate:18e7,level:60},{maxPictureSize:35651584,maxBitrate:24e7,level:61},{maxPictureSize:35651584,maxBitrate:48e7,level:62}],pa=[{maxPictureSize:147456,maxBitrate:15e5,tier:"M",level:0},{maxPictureSize:278784,maxBitrate:3e6,tier:"M",level:1},{maxPictureSize:665856,maxBitrate:6e6,tier:"M",level:4},{maxPictureSize:1065024,maxBitrate:1e7,tier:"M",level:5},{maxPictureSize:2359296,maxBitrate:12e6,tier:"M",level:8},{maxPictureSize:2359296,maxBitrate:3e7,tier:"H",level:8},{maxPictureSize:2359296,maxBitrate:2e7,tier:"M",level:9},{maxPictureSize:2359296,maxBitrate:5e7,tier:"H",level:9},{maxPictureSize:8912896,maxBitrate:3e7,tier:"M",level:12},{maxPictureSize:8912896,maxBitrate:1e8,tier:"H",level:12},{maxPictureSize:8912896,maxBitrate:4e7,tier:"M",level:13},{maxPictureSize:8912896,maxBitrate:16e7,tier:"H",level:13},{maxPictureSize:8912896,maxBitrate:6e7,tier:"M",level:14},{maxPictureSize:8912896,maxBitrate:24e7,tier:"H",level:14},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:15},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:15},{maxPictureSize:35651584,maxBitrate:6e7,tier:"M",level:16},{maxPictureSize:35651584,maxBitrate:24e7,tier:"H",level:16},{maxPictureSize:35651584,maxBitrate:1e8,tier:"M",level:17},{maxPictureSize:35651584,maxBitrate:48e7,tier:"H",level:17},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:18},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:18},{maxPictureSize:35651584,maxBitrate:16e7,tier:"M",level:19},{maxPictureSize:35651584,maxBitrate:8e8,tier:"H",level:19}],ga=".01.01.01.01.00",wa=".0.110.01.01.01.0",gc=(e,t,r,i)=>{if(e==="avc"){let a=Math.ceil(t/16)*Math.ceil(r/16),n=fa.find(h=>a<=h.maxMacroblocks&&i<=h.maxBitrate)??de(fa),o=n?n.level:0,c="64".padStart(2,"0"),l="00",u=o.toString(16).padStart(2,"0");return"avc1.".concat(c).concat(l).concat(u)}else if(e==="hevc"){let o=t*r,c=ma.find(u=>o<=u.maxPictureSize&&i<=u.maxBitrate)??de(ma);return"hev1.1.6.".concat(c.tier).concat(c.level,".").concat("B0")}else{if(e==="vp8")return"vp8";if(e==="vp9"){let a=t*r,n=Ut.find(c=>a<=c.maxPictureSize&&i<=c.maxBitrate)??de(Ut);return"vp09.00.".concat(n.level.toString().padStart(2,"0"),".").concat("08")}else if(e==="av1"){let a=t*r,n=pa.find(l=>a<=l.maxPictureSize&&i<=l.maxBitrate)??de(pa),o=n.level.toString().padStart(2,"0");return"av01.0.".concat(o).concat(n.tier,".").concat("08")}}throw new TypeError("Unhandled codec '".concat(e,"'."))},wc=e=>{let t=e.split("."),r=Number(t[1]),i=Number(t[2]),s=Number(t[3]),a=t[4]?Number(t[4]):1;return[1,1,r,2,1,i,3,1,s,4,1,a]},ba=e=>{let t=e.split("."),s=(1<<7)+1,a=Number(t[1]),n=t[2],o=Number(n.slice(0,-1)),c=(a<<5)+o,l=n.slice(-1)==="H"?1:0,h=Number(t[3])===8?0:1,f=0,w=t[4]?Number(t[4]):0,b=t[5]?Number(t[5][0]):1,p=t[5]?Number(t[5][1]):1,y=t[5]?Number(t[5][2]):0,k=(l<<7)+(h<<6)+(f<<5)+(w<<4)+(b<<3)+(p<<2)+y;return[s,c,k,0]},ka=e=>{let{codec:t,codecDescription:r,colorSpace:i,avcCodecInfo:s,hevcCodecInfo:a,vp9CodecInfo:n,av1CodecInfo:o}=e;if(t==="avc"){if(s){let c=new Uint8Array([s.avcProfileIndication,s.profileCompatibility,s.avcLevelIndication]);return"avc1.".concat(Rr(c))}if(!r||r.byteLength<4)throw new TypeError("AVC decoder description is not provided or is not at least 4 bytes long.");return"avc1.".concat(Rr(r.subarray(1,4)))}else if(t==="hevc"){let c,l,u,h,f,w;if(a)c=a.generalProfileSpace,l=a.generalProfileIdc,u=Ot(a.generalProfileCompatibilityFlags),h=a.generalTierFlag,f=a.generalLevelIdc,w=[...a.generalConstraintIndicatorFlags];else{if(!r||r.byteLength<23)throw new TypeError("HEVC decoder description is not provided or is not at least 23 bytes long.");let p=le(r),y=p.getUint8(1);c=y>>6&3,l=y&31,u=Ot(p.getUint32(2)),h=y>>5&1,f=p.getUint8(12),w=[];for(let k=0;k<6;k++)w.push(p.getUint8(6+k))}let b="hev1.";for(b+=["","A","B","C"][c]+l,b+=".",b+=u.toString(16).toUpperCase(),b+=".",b+=h===0?"L":"H",b+=f;w.length>0&&w[w.length-1]===0;)w.pop();return w.length>0&&(b+=".",b+=w.map(p=>p.toString(16).toUpperCase()).join(".")),b}else{if(t==="vp8")return"vp8";if(t==="vp9"){if(!n){let k=e.width*e.height,T=de(Ut).level;for(let _ of Ut)if(k<=_.maxPictureSize){T=_.level;break}return"vp09.00.".concat(T.toString().padStart(2,"0"),".08")}let c=n.profile.toString().padStart(2,"0"),l=n.level.toString().padStart(2,"0"),u=n.bitDepth.toString().padStart(2,"0"),h=n.chromaSubsampling.toString().padStart(2,"0"),f=n.colourPrimaries.toString().padStart(2,"0"),w=n.transferCharacteristics.toString().padStart(2,"0"),b=n.matrixCoefficients.toString().padStart(2,"0"),p=n.videoFullRangeFlag.toString().padStart(2,"0"),y="vp09.".concat(c,".").concat(l,".").concat(u,".").concat(h);return y+=".".concat(f,".").concat(w,".").concat(b,".").concat(p),y.endsWith(ga)&&(y=y.slice(0,-ga.length)),y}else if(t==="av1"){if(!o){let _=e.width*e.height,x=de(Ut).level;for(let B of Ut)if(_<=B.maxPictureSize){x=B.level;break}return"av01.0.".concat(x.toString().padStart(2,"0"),"M.08")}let c=o.profile,l=o.level.toString().padStart(2,"0"),u=o.tier?"H":"M",h=o.bitDepth.toString().padStart(2,"0"),f=o.monochrome?"1":"0",w=100*o.chromaSubsamplingX+10*o.chromaSubsamplingY+1*(o.chromaSubsamplingX&&o.chromaSubsamplingY?o.chromaSamplePosition:0),b=i?.primaries?Ae[i.primaries]:1,p=i?.transfer?_t[i.transfer]:1,y=i?.matrix?nt[i.matrix]:1,k=i?.fullRange?1:0,T="av01.".concat(c,".").concat(l).concat(u,".").concat(h);return T+=".".concat(f,".").concat(w.toString().padStart(3,"0")),T+=".".concat(b.toString().padStart(2,"0")),T+=".".concat(p.toString().padStart(2,"0")),T+=".".concat(y.toString().padStart(2,"0")),T+=".".concat(k),T.endsWith(wa)&&(T=T.slice(0,-wa.length)),T}}throw new TypeError("Unhandled codec '".concat(t,"'."))},bc=(e,t,r)=>{if(e==="aac")return t>=2&&r<=24e3?"mp4a.40.29":r<=24e3?"mp4a.40.5":"mp4a.40.2";if(e==="mp3")return"mp3";if(e==="opus")return"opus";if(e==="vorbis")return"vorbis";if(e==="flac")return"flac";if(ve.includes(e))return e;throw new TypeError("Unhandled codec '".concat(e,"'."))},ya=e=>{let{codec:t,codecDescription:r,aacCodecInfo:i}=e;if(t==="aac"){if(!i)throw new TypeError("AAC codec info must be provided.");if(i.isMpeg2)return"mp4a.67";{let s=Hi(r);return"mp4a.40.".concat(s.objectType)}}else{if(t==="mp3")return"mp3";if(t==="opus")return"opus";if(t==="vorbis")return"vorbis";if(t==="flac")return"flac";if(t&&ve.includes(t))return t}throw new TypeError("Unhandled codec '".concat(t,"'."))},ui=[96e3,88200,64e3,48e3,44100,32e3,24e3,22050,16e3,12e3,11025,8e3,7350],Ta=[-1,1,2,3,4,5,6,8],Hi=e=>{if(!e||e.byteLength<2)throw new TypeError("AAC description must be at least 2 bytes long.");let t=new ce(e),r=t.readBits(5);r===31&&(r=32+t.readBits(6));let i=t.readBits(4),s=null;i===15?s=t.readBits(24):i<ui.length&&(s=ui[i]);let a=t.readBits(4),n=null;return a>=1&&a<=7&&(n=Ta[a]),{objectType:r,frequencyIndex:i,sampleRate:s,channelConfiguration:a,numberOfChannels:n}},pr=48e3,Sa=/^pcm-([usf])(\d+)+(be)?$/,wt=e=>{if(d(ve.includes(e)),e==="ulaw")return{dataType:"ulaw",sampleSize:1,littleEndian:!0,silentValue:255};if(e==="alaw")return{dataType:"alaw",sampleSize:1,littleEndian:!0,silentValue:213};let t=Sa.exec(e);d(t);let r;t[1]==="u"?r="unsigned":t[1]==="s"?r="signed":r="float";let i=Number(t[2])/8,s=t[3]!=="be",a=e==="pcm-u8"?2**7:0;return{dataType:r,sampleSize:i,littleEndian:s,silentValue:a}},va=e=>e.startsWith("avc1")||e.startsWith("avc3")?"avc":e.startsWith("hev1")||e.startsWith("hvc1")?"hevc":e==="vp8"?"vp8":e.startsWith("vp09")?"vp9":e.startsWith("av01")?"av1":e.startsWith("mp4a.40")||e==="mp4a.67"?"aac":e==="mp3"||e==="mp4a.69"||e==="mp4a.6B"||e==="mp4a.6b"?"mp3":e==="opus"?"opus":e==="vorbis"?"vorbis":e==="flac"?"flac":e==="ulaw"?"ulaw":e==="alaw"?"alaw":Sa.test(e)?e:e==="webvtt"?"webvtt":null,kc=e=>e==="avc"?{avc:{format:"avc"}}:e==="hevc"?{hevc:{format:"hevc"}}:{},yc=e=>e==="aac"?{aac:{format:"aac"}}:e==="opus"?{opus:{format:"opus"}}:{},Tc=["avc1","avc3","hev1","hvc1","vp8","vp09","av01"],Sc=/^(avc1|avc3)\.[0-9a-fA-F]{6}$/,vc=/^(hev1|hvc1)\.(?:[ABC]?\d+)\.[0-9a-fA-F]{1,8}\.[LH]\d+(?:\.[0-9a-fA-F]{1,2}){0,6}$/,_c=/^vp09(?:\.\d{2}){3}(?:(?:\.\d{2}){5})?$/,Cc=/^av01\.\d\.\d{2}[MH]\.\d{2}(?:\.\d\.\d{3}\.\d{2}\.\d{2}\.\d{2}\.\d)?$/,_a=e=>{if(!e)throw new TypeError("Video chunk metadata must be provided.");if(typeof e!="object")throw new TypeError("Video chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Video chunk metadata must include a decoder configuration.");if(typeof e.decoderConfig!="object")throw new TypeError("Video chunk metadata decoder configuration must be an object.");if(typeof e.decoderConfig.codec!="string")throw new TypeError("Video chunk metadata decoder configuration must specify a codec string.");if(!Tc.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Video chunk metadata decoder configuration codec string must be a valid video codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.codedWidth)||e.decoderConfig.codedWidth<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedWidth (positive integer).");if(!Number.isInteger(e.decoderConfig.codedHeight)||e.decoderConfig.codedHeight<=0)throw new TypeError("Video chunk metadata decoder configuration must specify a valid codedHeight (positive integer).");if(e.decoderConfig.description!==void 0&&!Ct(e.decoderConfig.description))throw new TypeError("Video chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.colorSpace!==void 0){let{colorSpace:t}=e.decoderConfig;if(typeof t!="object")throw new TypeError("Video chunk metadata decoder configuration colorSpace, when provided, must be an object.");let r=Object.keys(Ae);if(t.primaries!=null&&!r.includes(t.primaries))throw new TypeError("Video chunk metadata decoder configuration colorSpace primaries, when defined, must be one of ".concat(r.join(", "),"."));let i=Object.keys(_t);if(t.transfer!=null&&!i.includes(t.transfer))throw new TypeError("Video chunk metadata decoder configuration colorSpace transfer, when defined, must be one of ".concat(i.join(", "),"."));let s=Object.keys(nt);if(t.matrix!=null&&!s.includes(t.matrix))throw new TypeError("Video chunk metadata decoder configuration colorSpace matrix, when defined, must be one of ".concat(s.join(", "),"."));if(t.fullRange!=null&&typeof t.fullRange!="boolean")throw new TypeError("Video chunk metadata decoder configuration colorSpace fullRange, when defined, must be a boolean.")}if(e.decoderConfig.codec.startsWith("avc1")||e.decoderConfig.codec.startsWith("avc3")){if(!Sc.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for AVC must be a valid AVC codec string as specified in Section 3.4 of RFC 6381.")}else if(e.decoderConfig.codec.startsWith("hev1")||e.decoderConfig.codec.startsWith("hvc1")){if(!vc.test(e.decoderConfig.codec))throw new TypeError("Video chunk metadata decoder configuration codec string for HEVC must be a valid HEVC codec string as specified in Section E.3 of ISO 14496-15.")}else if(e.decoderConfig.codec.startsWith("vp8")){if(e.decoderConfig.codec!=="vp8")throw new TypeError('Video chunk metadata decoder configuration codec string for VP8 must be "vp8".')}else if(e.decoderConfig.codec.startsWith("vp09")){if(!_c.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for VP9 must be a valid VP9 codec string as specified in Section "Codecs Parameter String" of https://www.webmproject.org/vp9/mp4/.')}else if(e.decoderConfig.codec.startsWith("av01")&&!Cc.test(e.decoderConfig.codec))throw new TypeError('Video chunk metadata decoder configuration codec string for AV1 must be a valid AV1 codec string as specified in Section "Codecs Parameter String" of https://aomediacodec.github.io/av1-isobmff/.')},xc=["mp4a","mp3","opus","vorbis","flac","ulaw","alaw","pcm"],gr=e=>{if(!e)throw new TypeError("Audio chunk metadata must be provided.");if(typeof e!="object")throw new TypeError("Audio chunk metadata must be an object.");if(!e.decoderConfig)throw new TypeError("Audio chunk metadata must include a decoder configuration.");if(typeof e.decoderConfig!="object")throw new TypeError("Audio chunk metadata decoder configuration must be an object.");if(typeof e.decoderConfig.codec!="string")throw new TypeError("Audio chunk metadata decoder configuration must specify a codec string.");if(!xc.some(t=>e.decoderConfig.codec.startsWith(t)))throw new TypeError("Audio chunk metadata decoder configuration codec string must be a valid audio codec string as specified in the WebCodecs Codec Registry.");if(!Number.isInteger(e.decoderConfig.sampleRate)||e.decoderConfig.sampleRate<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid sampleRate (positive integer).");if(!Number.isInteger(e.decoderConfig.numberOfChannels)||e.decoderConfig.numberOfChannels<=0)throw new TypeError("Audio chunk metadata decoder configuration must specify a valid numberOfChannels (positive integer).");if(e.decoderConfig.description!==void 0&&!Ct(e.decoderConfig.description))throw new TypeError("Audio chunk metadata decoder configuration description, when defined, must be an ArrayBuffer or an ArrayBuffer view.");if(e.decoderConfig.codec.startsWith("mp4a")&&e.decoderConfig.codec!=="mp4a.69"&&e.decoderConfig.codec!=="mp4a.6B"&&e.decoderConfig.codec!=="mp4a.6b"){if(!["mp4a.40.2","mp4a.40.02","mp4a.40.5","mp4a.40.05","mp4a.40.29","mp4a.67"].includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for AAC must be a valid AAC codec string as specified in https://www.w3.org/TR/webcodecs-aac-codec-registration/.");if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for AAC must include a description, which is expected to be an AudioSpecificConfig as specified in ISO 14496-3.")}else if(e.decoderConfig.codec.startsWith("mp3")||e.decoderConfig.codec.startsWith("mp4a")){if(e.decoderConfig.codec!=="mp3"&&e.decoderConfig.codec!=="mp4a.69"&&e.decoderConfig.codec!=="mp4a.6B"&&e.decoderConfig.codec!=="mp4a.6b")throw new TypeError('Audio chunk metadata decoder configuration codec string for MP3 must be "mp3", "mp4a.69" or "mp4a.6B".')}else if(e.decoderConfig.codec.startsWith("opus")){if(e.decoderConfig.codec!=="opus")throw new TypeError('Audio chunk metadata decoder configuration codec string for Opus must be "opus".');if(e.decoderConfig.description&&e.decoderConfig.description.byteLength<18)throw new TypeError("Audio chunk metadata decoder configuration description, when specified, is expected to be an Identification Header as specified in Section 5.1 of RFC 7845.")}else if(e.decoderConfig.codec.startsWith("vorbis")){if(e.decoderConfig.codec!=="vorbis")throw new TypeError('Audio chunk metadata decoder configuration codec string for Vorbis must be "vorbis".');if(!e.decoderConfig.description)throw new TypeError("Audio chunk metadata decoder configuration for Vorbis must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-vorbis-codec-registration/.")}else if(e.decoderConfig.codec.startsWith("flac")){if(e.decoderConfig.codec!=="flac")throw new TypeError('Audio chunk metadata decoder configuration codec string for FLAC must be "flac".');if(!e.decoderConfig.description||e.decoderConfig.description.byteLength<42)throw new TypeError("Audio chunk metadata decoder configuration for FLAC must include a description, which is expected to adhere to the format described in https://www.w3.org/TR/webcodecs-flac-codec-registration/.")}else if((e.decoderConfig.codec.startsWith("pcm")||e.decoderConfig.codec.startsWith("ulaw")||e.decoderConfig.codec.startsWith("alaw"))&&!ve.includes(e.decoderConfig.codec))throw new TypeError("Audio chunk metadata decoder configuration codec string for PCM must be one of the supported PCM codecs (".concat(ve.join(", "),")."))},Ca=e=>{if(!e)throw new TypeError("Subtitle metadata must be provided.");if(typeof e!="object")throw new TypeError("Subtitle metadata must be an object.");if(!e.config)throw new TypeError("Subtitle metadata must include a config object.");if(typeof e.config!="object")throw new TypeError("Subtitle metadata config must be an object.");if(typeof e.config.description!="string")throw new TypeError("Subtitle metadata config description must be a string.")},tr=class{constructor(e){this.mutex=new xt,this.firstMediaStreamTimestamp=null,this.trackTimestampInfo=new WeakMap,this.output=e}onTrackClose(e){}validateAndNormalizeTimestamp(e,t,r){t+=e.source._timestampOffset;let i=this.trackTimestampInfo.get(e);if(!i){if(!r)throw new Error("First frame must be a key frame.");i={maxTimestamp:t,maxTimestampBeforeLastKeyFrame:t},this.trackTimestampInfo.set(e,i)}if(t<0)throw new Error("Timestamps must be non-negative (got ".concat(t,"s)."));if(r&&(i.maxTimestampBeforeLastKeyFrame=i.maxTimestamp),t<i.maxTimestampBeforeLastKeyFrame)throw new Error("Timestamps cannot be smaller than the highest timestamp of the previous GOP (a GOP begins with a key frame and ends right before the next key frame). Got ".concat(t,"s, but highest timestamp is ").concat(i.maxTimestampBeforeLastKeyFrame,"s."));return i.maxTimestamp=Math.max(i.maxTimestamp,t),t}},Pc=class extends tr{constructor(e,t){super(e),this.header=new Uint8Array(7),this.headerBitstream=new ce(this.header),this.audioSpecificConfig=null,this.format=t,this.writer=e._writer}async start(){}async getMimeType(){return"audio/aac"}async addEncodedVideoPacket(){throw new Error("ADTS does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{if(this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),!this.audioSpecificConfig){gr(r);let n=r?.decoderConfig?.description;d(n),this.audioSpecificConfig=Hi(ge(n));let{objectType:o,frequencyIndex:c,channelConfiguration:l}=this.audioSpecificConfig,u=o-1;this.headerBitstream.writeBits(12,4095),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(2,0),this.headerBitstream.writeBits(1,1),this.headerBitstream.writeBits(2,u),this.headerBitstream.writeBits(4,c),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(3,l),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.writeBits(1,0),this.headerBitstream.skipBits(13),this.headerBitstream.writeBits(11,2047),this.headerBitstream.writeBits(2,0)}let s=t.data.byteLength+this.header.byteLength;this.headerBitstream.pos=30,this.headerBitstream.writeBits(13,s);let a=this.writer.getPos();if(this.writer.write(this.header),this.writer.write(t.data),this.format._options.onFrame){let n=new Uint8Array(s);n.set(this.header,0),n.set(t.data,this.header.byteLength),this.format._options.onFrame(n,a)}await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("ADTS does not support subtitles.")}async finalize(){}},Nr=e=>{let t=[],r=0;for(;r<e.length;){let i=-1,s=0;for(let a=r;a<e.length-3;a++){if(e[a]===0&&e[a+1]===0&&e[a+2]===1){i=a,s=3;break}if(a<e.length-4&&e[a]===0&&e[a+1]===0&&e[a+2]===0&&e[a+3]===1){i=a,s=4;break}}if(i===-1)break;if(r>0&&i>r){let a=e.subarray(r,i);a.length>0&&t.push(a)}r=i+s}if(r<e.length){let i=e.subarray(r);i.length>0&&t.push(i)}return t},xa=(e,t)=>{let r=[],i=0,s=new DataView(e.buffer,e.byteOffset,e.byteLength);for(;i+t<=e.length;){let a;t===1?a=s.getUint8(i):t===2?a=s.getUint16(i,!1):t===3?a=si(s,i,!1):t===4?a=s.getUint32(i,!1):(Re(t),d(!1)),i+=t;let n=e.subarray(i,i+a);r.push(n),i+=a}return r},qi=e=>{let t=[],r=e.length;for(let i=0;i<r;i++)i+2<r&&e[i]===0&&e[i+1]===0&&e[i+2]===3?(t.push(0,0),i+=2):t.push(e[i]);return new Uint8Array(t)},Ic=e=>{let r=Nr(e);if(r.length===0)return null;let i=0;for(let o of r)i+=4+o.byteLength;let s=new Uint8Array(i),a=new DataView(s.buffer),n=0;for(let o of r){let c=o.byteLength;a.setUint32(n,c,!1),n+=4,s.set(o,n),n+=o.byteLength}return s},Ec=(e,t)=>{if(t.description){let s=(ge(t.description)[4]&3)+1;return xa(e,s)}else return Nr(e)},di=e=>e[0]&31,Pa=e=>{try{let t=Nr(e),r=t.filter(f=>di(f)===7),i=t.filter(f=>di(f)===8),s=t.filter(f=>di(f)===13);if(r.length===0||i.length===0)return null;let a=r[0],n=new ce(qi(a));if(n.skipBits(1),n.skipBits(2),n.readBits(5)!==7)return console.error("Invalid SPS NAL unit type"),null;let c=n.readAlignedByte(),l=n.readAlignedByte(),u=n.readAlignedByte(),h={configurationVersion:1,avcProfileIndication:c,profileCompatibility:l,avcLevelIndication:u,lengthSizeMinusOne:3,sequenceParameterSets:r,pictureParameterSets:i,chromaFormat:null,bitDepthLumaMinus8:null,bitDepthChromaMinus8:null,sequenceParameterSetExt:null};if(c===100||c===110||c===122||c===144){L(n);let f=L(n);f===3&&n.skipBits(1);let w=L(n),b=L(n);h.chromaFormat=f,h.bitDepthLumaMinus8=w,h.bitDepthChromaMinus8=b,h.sequenceParameterSetExt=s}return h}catch(t){return console.error("Error building AVC Decoder Configuration Record:",t),null}},Ac=e=>{let t=[];t.push(e.configurationVersion),t.push(e.avcProfileIndication),t.push(e.profileCompatibility),t.push(e.avcLevelIndication),t.push(252|e.lengthSizeMinusOne&3),t.push(224|e.sequenceParameterSets.length&31);for(let r of e.sequenceParameterSets){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}t.push(e.pictureParameterSets.length);for(let r of e.pictureParameterSets){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}if(e.avcProfileIndication===100||e.avcProfileIndication===110||e.avcProfileIndication===122||e.avcProfileIndication===144){d(e.chromaFormat!==null),d(e.bitDepthLumaMinus8!==null),d(e.bitDepthChromaMinus8!==null),d(e.sequenceParameterSetExt!==null),t.push(252|e.chromaFormat&3),t.push(248|e.bitDepthLumaMinus8&7),t.push(248|e.bitDepthChromaMinus8&7),t.push(e.sequenceParameterSetExt.length);for(let r of e.sequenceParameterSetExt){let i=r.byteLength;t.push(i>>8),t.push(i&255);for(let s=0;s<i;s++)t.push(r[s])}}return new Uint8Array(t)},Ia=(e,t)=>{if(t.description){let s=(ge(t.description)[21]&3)+1;return xa(e,s)}else return Nr(e)},Lt=e=>e[0]>>1&63,Ea=e=>{try{let t=Nr(e),r=t.filter(G=>Lt(G)===32),i=t.filter(G=>Lt(G)===33),s=t.filter(G=>Lt(G)===34),a=t.filter(G=>Lt(G)===39||Lt(G)===40);if(i.length===0||s.length===0)return null;let n=i[0],o=new ce(qi(n));o.skipBits(16),o.readBits(4);let c=o.readBits(3),l=o.readBits(1),{general_profile_space:u,general_tier_flag:h,general_profile_idc:f,general_profile_compatibility_flags:w,general_constraint_indicator_flags:b,general_level_idc:p}=Bc(o,c);L(o);let y=L(o);y===3&&o.skipBits(1),L(o),L(o),o.readBits(1)&&(L(o),L(o),L(o),L(o));let k=L(o),T=L(o);L(o);let x=o.readBits(1)?0:c;for(let G=x;G<=c;G++)L(o),L(o),L(o);L(o),L(o),L(o),L(o),L(o),L(o),o.readBits(1)&&o.readBits(1)&&Fc(o),o.skipBits(1),o.skipBits(1),o.readBits(1)&&(o.skipBits(4),o.skipBits(4),L(o),L(o),o.skipBits(1));let B=L(o);if(Mc(o,B),o.readBits(1)){let G=L(o);for(let W=0;W<G;W++)L(o),o.skipBits(1)}o.skipBits(1),o.skipBits(1);let I=0;o.readBits(1)&&(I=Rc(o,c));let M=0;if(s.length>0){let G=s[0],W=new ce(qi(G));W.skipBits(16),L(W),L(W),W.skipBits(1),W.skipBits(1),W.skipBits(3),W.skipBits(1),W.skipBits(1),L(W),L(W),Dt(W),W.skipBits(1),W.skipBits(1),W.readBits(1)&&L(W),Dt(W),Dt(W),W.skipBits(1),W.skipBits(1),W.skipBits(1),W.skipBits(1);let ee=W.readBits(1),fe=W.readBits(1);!ee&&!fe?M=0:ee&&!fe?M=2:!ee&&fe?M=3:M=0}let V=[...r.length?[{arrayCompleteness:1,nalUnitType:32,nalUnits:r}]:[],...i.length?[{arrayCompleteness:1,nalUnitType:33,nalUnits:i}]:[],...s.length?[{arrayCompleteness:1,nalUnitType:34,nalUnits:s}]:[],...a.length?[{arrayCompleteness:1,nalUnitType:Lt(a[0]),nalUnits:a}]:[]];return{configurationVersion:1,generalProfileSpace:u,generalTierFlag:h,generalProfileIdc:f,generalProfileCompatibilityFlags:w,generalConstraintIndicatorFlags:b,generalLevelIdc:p,minSpatialSegmentationIdc:I,parallelismType:M,chromaFormatIdc:y,bitDepthLumaMinus8:k,bitDepthChromaMinus8:T,avgFrameRate:0,constantFrameRate:0,numTemporalLayers:c+1,temporalIdNested:l,lengthSizeMinusOne:3,arrays:V}}catch(t){return console.error("Error building HEVC Decoder Configuration Record:",t),null}},Bc=(e,t)=>{let r=e.readBits(2),i=e.readBits(1),s=e.readBits(5),a=0;for(let u=0;u<32;u++)a=a<<1|e.readBits(1);let n=new Uint8Array(6);for(let u=0;u<6;u++)n[u]=e.readBits(8);let o=e.readBits(8),c=[],l=[];for(let u=0;u<t;u++)c.push(e.readBits(1)),l.push(e.readBits(1));if(t>0)for(let u=t;u<8;u++)e.skipBits(2);for(let u=0;u<t;u++)c[u]&&e.skipBits(88),l[u]&&e.skipBits(8);return{general_profile_space:r,general_tier_flag:i,general_profile_idc:s,general_profile_compatibility_flags:a,general_constraint_indicator_flags:n,general_level_idc:o}},Fc=e=>{for(let t=0;t<4;t++)for(let r=0;r<(t===3?2:6);r++)if(!e.readBits(1))L(e);else{let s=Math.min(64,1<<4+(t<<1));t>1&&Dt(e);for(let a=0;a<s;a++)Dt(e)}},Mc=(e,t)=>{let r=[];for(let i=0;i<t;i++)r[i]=zc(e,i,t,r)},zc=(e,t,r,i)=>{let s=0,a=0,n=0;if(t!==0&&(a=e.readBits(1)),a){if(t===r){let c=L(e);n=t-(c+1)}else n=t-1;e.readBits(1),L(e);let o=i[n]??0;for(let c=0;c<=o;c++)e.readBits(1)||e.readBits(1);s=i[n]}else{let o=L(e),c=L(e);for(let l=0;l<o;l++)L(e),e.readBits(1);for(let l=0;l<c;l++)L(e),e.readBits(1);s=o+c}return s},Rc=(e,t)=>{if(e.readBits(1)&&e.readBits(8)===255&&(e.readBits(16),e.readBits(16)),e.readBits(1)&&e.readBits(1),e.readBits(1)&&(e.readBits(3),e.readBits(1),e.readBits(1)&&(e.readBits(8),e.readBits(8),e.readBits(8))),e.readBits(1)&&(L(e),L(e)),e.readBits(1),e.readBits(1),e.readBits(1),e.readBits(1)&&(L(e),L(e),L(e),L(e)),e.readBits(1)&&(e.readBits(32),e.readBits(32),e.readBits(1)&&L(e),e.readBits(1)&&Dc(e,!0,t)),e.readBits(1)){e.readBits(1),e.readBits(1),e.readBits(1);let r=L(e);return L(e),L(e),L(e),L(e),r}return 0},Dc=(e,t,r)=>{let i=!1,s=!1,a=!1;t&&(i=e.readBits(1)===1,s=e.readBits(1)===1,(i||s)&&(a=e.readBits(1)===1,a&&(e.readBits(8),e.readBits(5),e.readBits(1),e.readBits(5)),e.readBits(4),e.readBits(4),a&&e.readBits(4),e.readBits(5),e.readBits(5),e.readBits(5)));for(let n=0;n<=r;n++){let o=e.readBits(1)===1,c=!0;o||(c=e.readBits(1)===1);let l=!1;c?L(e):l=e.readBits(1)===1;let u=1;l||(u=L(e)+1),i&&Aa(e,u,a),s&&Aa(e,u,a)}},Aa=(e,t,r)=>{for(let i=0;i<t;i++)L(e),L(e),r&&(L(e),L(e)),e.readBits(1)},Oc=e=>{let t=[];t.push(e.configurationVersion),t.push((e.generalProfileSpace&3)<<6|(e.generalTierFlag&1)<<5|e.generalProfileIdc&31),t.push(e.generalProfileCompatibilityFlags>>>24&255),t.push(e.generalProfileCompatibilityFlags>>>16&255),t.push(e.generalProfileCompatibilityFlags>>>8&255),t.push(e.generalProfileCompatibilityFlags&255),t.push(...e.generalConstraintIndicatorFlags),t.push(e.generalLevelIdc&255),t.push(240|e.minSpatialSegmentationIdc>>8&15),t.push(e.minSpatialSegmentationIdc&255),t.push(252|e.parallelismType&3),t.push(252|e.chromaFormatIdc&3),t.push(248|e.bitDepthLumaMinus8&7),t.push(248|e.bitDepthChromaMinus8&7),t.push(e.avgFrameRate>>8&255),t.push(e.avgFrameRate&255),t.push((e.constantFrameRate&3)<<6|(e.numTemporalLayers&7)<<3|(e.temporalIdNested&1)<<2|e.lengthSizeMinusOne&3),t.push(e.arrays.length&255);for(let r of e.arrays){t.push((r.arrayCompleteness&1)<<7|0|r.nalUnitType&63),t.push(r.nalUnits.length>>8&255),t.push(r.nalUnits.length&255);for(let i of r.nalUnits){t.push(i.length>>8&255),t.push(i.length&255);for(let s=0;s<i.length;s++)t.push(i[s])}}return new Uint8Array(t)},Ba=e=>{let t=new ce(e);if(t.readBits(2)!==2)return null;let i=t.readBits(1),a=(t.readBits(1)<<1)+i;if(a===3&&t.skipBits(1),t.readBits(1)===1||t.readBits(1)!==0||(t.skipBits(2),t.readBits(24)!==4817730))return null;let l=8;a>=2&&(l=t.readBits(1)?12:10);let u=t.readBits(3),h=0,f=0;if(u!==7)if(f=t.readBits(1),a===1||a===3){let M=t.readBits(1),V=t.readBits(1);h=!M&&!V?3:M&&!V?2:1,t.skipBits(1)}else h=1;else h=3,f=1;let w=t.readBits(16),b=t.readBits(16),p=w+1,y=b+1,k=p*y,T=de(Ut).level;for(let I of Ut)if(k<=I.maxPictureSize){T=I.level;break}return{profile:a,level:T,bitDepth:l,chromaSubsampling:h,videoFullRangeFlag:f,colourPrimaries:u===2?1:u===1?6:2,transferCharacteristics:u===2?1:u===1?6:2,matrixCoefficients:u===7?0:u===2?1:u===1?6:2}},Fa=function*(e){let t=new ce(e),r=()=>{let i=0;for(let s=0;s<8;s++){let a=t.readAlignedByte();if(i|=(a&127)<<s*7,!(a&128))break;if(s===7&&a&128)return null}return i>=2**32-1?null:i};for(;t.getBitsLeft()>=8;){t.skipBits(1);let i=t.readBits(4),s=t.readBits(1),a=t.readBits(1);t.skipBits(1),s&&t.skipBits(8);let n;if(a){let o=r();if(o===null)return;n=o}else n=Math.floor(t.getBitsLeft()/8);d(t.pos%8===0),yield{type:i,data:e.subarray(t.pos/8,t.pos/8+n)},t.skipBits(n*8)}},Ma=e=>{for(let{type:t,data:r}of Fa(e)){if(t!==1)continue;let i=new ce(r),s=i.readBits(3),a=i.readBits(1),n=i.readBits(1),o=0,c=0,l=0;if(n)o=i.readBits(5);else{if(i.readBits(1)&&(i.skipBits(32),i.skipBits(32),i.readBits(1)))return null;let k=i.readBits(1);k&&(l=i.readBits(5),i.skipBits(32),i.skipBits(5),i.skipBits(5));let T=i.readBits(5);for(let _=0;_<=T;_++){i.skipBits(12);let x=i.readBits(5);if(_===0&&(o=x),x>7){let I=i.readBits(1);_===0&&(c=I)}if(k&&i.readBits(1)){let M=l+1;i.skipBits(M),i.skipBits(M),i.skipBits(1)}i.readBits(1)&&i.skipBits(4)}}let u=i.readBits(1),h=8;s===2&&u?h=i.readBits(1)?12:10:s<=2&&(h=u?10:8);let f=0;s!==1&&(f=i.readBits(1));let w=1,b=1,p=0;return f||(s===0?(w=1,b=1):s===1?(w=0,b=0):h===12&&(w=i.readBits(1),w&&(b=i.readBits(1))),w&&b&&(p=i.readBits(2))),{profile:s,level:o,tier:c,bitDepth:h,monochrome:f,chromaSubsamplingX:w,chromaSubsamplingY:b,chromaSamplePosition:p}}return null},hi=e=>{let t=le(e),r=t.getUint8(9),i=t.getUint16(10,!0),s=t.getUint32(12,!0),a=t.getInt16(16,!0),n=t.getUint8(18),o=null;return n&&(o=e.subarray(19,21+r)),{outputChannelCount:r,preSkip:i,inputSampleRate:s,outputGain:a,channelMappingFamily:n,channelMappingTable:o}},Nc=[480,960,1920,2880,480,960,1920,2880,480,960,1920,2880,480,960,480,960,120,240,480,960,120,240,480,960,120,240,480,960,120,240,480,960],Uc=e=>{let t=e[0]>>3;return{durationInSamples:Nc[t]}},za=e=>{if(e.length<7)throw new Error("Setup header is too short.");if(e[0]!==5)throw new Error("Wrong packet type in Setup header.");if(String.fromCharCode(...e.slice(1,7))!=="vorbis")throw new Error("Invalid packet signature in Setup header.");let r=e.length,i=new Uint8Array(r);for(let h=0;h<r;h++)i[h]=e[r-1-h];let s=new ce(i),a=0;for(;s.getBitsLeft()>97;)if(s.readBits(1)===1){a=s.pos;break}if(a===0)throw new Error("Invalid Setup header: framing bit not found.");let n=0,o=!1,c=0;for(;s.getBitsLeft()>=97;){let h=s.pos,f=s.readBits(8),w=s.readBits(16),b=s.readBits(16);if(f>63||w!==0||b!==0){s.pos=h;break}if(s.skipBits(1),n++,n>64)break;s.clone().readBits(6)+1===n&&(o=!0,c=n)}if(!o)throw new Error("Invalid Setup header: mode header not found.");if(c>63)throw new Error("Unsupported mode count: ".concat(c,"."));let l=c;s.pos=0,s.skipBits(a);let u=Array(l).fill(0);for(let h=l-1;h>=0;h--)s.skipBits(40),u[h]=s.readBits(1);return{modeBlockflags:u}},Ra=(e,t,r)=>{switch(e){case"avc":return Ec(r,t).some(a=>di(a)===5)?"key":"delta";case"hevc":return Ia(r,t).some(a=>{let n=Lt(a);return 16<=n&&n<=23})?"key":"delta";case"vp8":return(r[0]&1)===0?"key":"delta";case"vp9":{let i=new ce(r);if(i.readBits(2)!==2)return null;let s=i.readBits(1);return(i.readBits(1)<<1)+s===3&&i.skipBits(1),i.readBits(1)?null:i.readBits(1)===0?"key":"delta"}case"av1":{let i=!1;for(let{type:s,data:a}of Fa(r))if(s===1){let n=new ce(a);n.skipBits(4),i=!!n.readBits(1)}else if(s===3||s===6||s===7){if(i)return"key";let n=new ce(a);return n.readBits(1)?null:n.readBits(2)===0?"key":"delta"}return null}default:Re(e),d(!1)}},$i=(e,t)=>{var o,c;let r=le(e),i=0,s=r.getUint32(i,!0);i+=4;let a=Ce.decode(e.subarray(i,i+s));i+=s,s>0&&(t.raw??(t.raw={}),(o=t.raw).vendor??(o.vendor=a));let n=r.getUint32(i,!0);i+=4;for(let l=0;l<n;l++){let u=r.getUint32(i,!0);i+=4;let h=Ce.decode(e.subarray(i,i+u));i+=u;let f=h.indexOf("=");if(f===-1)continue;let w=h.slice(0,f).toUpperCase(),b=h.slice(f+1);switch(t.raw??(t.raw={}),(c=t.raw)[w]??(c[w]=b),w){case"TITLE":t.title??(t.title=b);break;case"DESCRIPTION":t.description??(t.description=b);break;case"ARTIST":t.artist??(t.artist=b);break;case"ALBUM":t.album??(t.album=b);break;case"ALBUMARTIST":t.albumArtist??(t.albumArtist=b);break;case"COMMENT":t.comment??(t.comment=b);break;case"LYRICS":t.lyrics??(t.lyrics=b);break;case"TRACKNUMBER":{let p=b.split("/"),y=Number.parseInt(p[0],10),k=p[1]&&Number.parseInt(p[1],10);Number.isInteger(y)&&y>0&&(t.trackNumber??(t.trackNumber=y)),k&&Number.isInteger(k)&&k>0&&(t.tracksTotal??(t.tracksTotal=k))}break;case"TRACKTOTAL":{let p=Number.parseInt(b,10);Number.isInteger(p)&&p>0&&(t.tracksTotal??(t.tracksTotal=p))}break;case"DISCNUMBER":{let p=b.split("/"),y=Number.parseInt(p[0],10),k=p[1]&&Number.parseInt(p[1],10);Number.isInteger(y)&&y>0&&(t.discNumber??(t.discNumber=y)),k&&Number.isInteger(k)&&k>0&&(t.discsTotal??(t.discsTotal=k))}break;case"DISCTOTAL":{let p=Number.parseInt(b,10);Number.isInteger(p)&&p>0&&(t.discsTotal??(t.discsTotal=p))}break;case"DATE":{let p=new Date(b);Number.isNaN(p.getTime())||(t.date??(t.date=p))}break;case"GENRE":t.genre??(t.genre=b);break;case"METADATA_BLOCK_PICTURE":{let p=fc(b),y=le(p),k=y.getUint32(0,!1),T=y.getUint32(4,!1),_=String.fromCharCode(...p.subarray(8,8+T)),x=y.getUint32(8+T,!1),B=Ce.decode(p.subarray(12+T,12+T+x)),I=y.getUint32(T+x+28),M=p.subarray(T+x+32,T+x+32+I);t.images??(t.images=[]),t.images.push({data:M,mimeType:_,kind:k===3?"coverFront":k===4?"coverBack":"unknown",name:void 0,description:B||void 0})}break}}},ji=(e,t,r)=>{let i=[e],a=J.encode("Mediabunny"),n=new Uint8Array(4+a.length),o=new DataView(n.buffer);o.setUint32(0,a.length,!0),n.set(a,4),i.push(n);let c=new Set,l=(b,p)=>{let y="".concat(b,"=").concat(p),k=J.encode(y);n=new Uint8Array(4+k.length),o=new DataView(n.buffer),o.setUint32(0,k.length,!0),n.set(k,4),i.push(n),c.add(b)};for(let{key:b,value:p}of fr(t))switch(b){case"title":l("TITLE",p);break;case"description":l("DESCRIPTION",p);break;case"artist":l("ARTIST",p);break;case"album":l("ALBUM",p);break;case"albumArtist":l("ALBUMARTIST",p);break;case"genre":l("GENRE",p);break;case"date":{let y=t.raw?.DATE??t.raw?.date;y&&typeof y=="string"?l("DATE",y):l("DATE",p.toISOString().slice(0,10))}break;case"comment":l("COMMENT",p);break;case"lyrics":l("LYRICS",p);break;case"trackNumber":l("TRACKNUMBER",p.toString());break;case"tracksTotal":l("TRACKTOTAL",p.toString());break;case"discNumber":l("DISCNUMBER",p.toString());break;case"discsTotal":l("DISCTOTAL",p.toString());break;case"images":{if(!r)break;for(let y of p){let k=y.kind==="coverFront"?3:y.kind==="coverBack"?4:0,T=new Uint8Array(y.mimeType.length);for(let M=0;M<y.mimeType.length;M++)T[M]=y.mimeType.charCodeAt(M);let _=J.encode(y.description??""),x=new Uint8Array(8+T.length+4+_.length+16+4+y.data.length),B=le(x);B.setUint32(0,k,!1),B.setUint32(4,T.length,!1),x.set(T,8),B.setUint32(8+T.length,_.length,!1),x.set(_,12+T.length),B.setUint32(28+T.length+_.length,y.data.length,!1),x.set(y.data,32+T.length+_.length);let I=mc(x);l("METADATA_BLOCK_PICTURE",I)}}break;case"raw":break;default:Re(b)}if(t.raw)for(let b in t.raw){let p=t.raw[b]??t.raw[b.toLowerCase()];b==="vendor"||p==null||c.has(b)||typeof p=="string"&&l(b,p)}let u=new Uint8Array(4);le(u).setUint32(0,c.size,!0),i.splice(2,0,u);let h=i.reduce((b,p)=>b+p.length,0),f=new Uint8Array(h),w=0;for(let b of i)f.set(b,w),w+=b.length;return f},rr=class{constructor(e){this.input=e}},Da=class{static supports(e,t){return!1}},Oa=class{static supports(e,t){return!1}},Na=class{static supports(e,t){return!1}},Ua=class{static supports(e,t){return!1}},fi=[],mi=[],Ur=[],Lr=[],Lc=e=>{if(e.prototype instanceof Da){let t=e;if(fi.includes(t)){console.warn("Video decoder already registered.");return}fi.push(t)}else if(e.prototype instanceof Oa){let t=e;if(mi.includes(t)){console.warn("Audio decoder already registered.");return}mi.push(t)}else throw new TypeError("Decoder must be a CustomVideoDecoder or CustomAudioDecoder.")},Vc=e=>{if(e.prototype instanceof Na){let t=e;if(Ur.includes(t)){console.warn("Video encoder already registered.");return}Ur.push(t)}else if(e.prototype instanceof Ua){let t=e;if(Lr.includes(t)){console.warn("Audio encoder already registered.");return}Lr.push(t)}else throw new TypeError("Encoder must be a CustomVideoEncoder or CustomAudioEncoder.")},tt=new Uint8Array(0),we=class ia{constructor(t,r,i,s,a=-1,n,o){if(this.data=t,this.type=r,this.timestamp=i,this.duration=s,this.sequenceNumber=a,t===tt&&n===void 0)throw new Error("Internal error: byteLength must be explicitly provided when constructing metadata-only packets.");if(n===void 0&&(n=t.byteLength),!(t instanceof Uint8Array))throw new TypeError("data must be a Uint8Array.");if(r!=="key"&&r!=="delta")throw new TypeError('type must be either "key" or "delta".');if(!Number.isFinite(i))throw new TypeError("timestamp must be a number.");if(!Number.isFinite(s)||s<0)throw new TypeError("duration must be a non-negative number.");if(!Number.isFinite(a))throw new TypeError("sequenceNumber must be a number.");if(!Number.isInteger(n)||n<0)throw new TypeError("byteLength must be a non-negative integer.");if(o!==void 0&&(typeof o!="object"||!o))throw new TypeError("sideData, when provided, must be an object.");if(o?.alpha!==void 0&&!(o.alpha instanceof Uint8Array))throw new TypeError("sideData.alpha, when provided, must be a Uint8Array.");if(o?.alphaByteLength!==void 0&&(!Number.isInteger(o.alphaByteLength)||o.alphaByteLength<0))throw new TypeError("sideData.alphaByteLength, when provided, must be a non-negative integer.");this.byteLength=n,this.sideData=o??{},this.sideData.alpha&&this.sideData.alphaByteLength===void 0&&(this.sideData.alphaByteLength=this.sideData.alpha.byteLength)}get isMetadataOnly(){return this.data===tt}get microsecondTimestamp(){return Math.trunc(Nt*this.timestamp)}get microsecondDuration(){return Math.trunc(Nt*this.duration)}toEncodedVideoChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}alphaToEncodedVideoChunk(t=this.type){if(!this.sideData.alpha)throw new TypeError("This packet does not contain alpha side data.");if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to a video chunk.");if(typeof EncodedVideoChunk>"u")throw new Error("Your browser does not support EncodedVideoChunk.");return new EncodedVideoChunk({data:this.sideData.alpha,type:t,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}toEncodedAudioChunk(){if(this.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be converted to an audio chunk.");if(typeof EncodedAudioChunk>"u")throw new Error("Your browser does not support EncodedAudioChunk.");return new EncodedAudioChunk({data:this.data,type:this.type,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration})}static fromEncodedChunk(t,r){if(!(t instanceof EncodedVideoChunk||t instanceof EncodedAudioChunk))throw new TypeError("chunk must be an EncodedVideoChunk or EncodedAudioChunk.");let i=new Uint8Array(t.byteLength);return t.copyTo(i),new ia(i,t.type,t.timestamp/1e6,(t.duration??0)/1e6,void 0,void 0,r)}clone(t){if(t!==void 0&&(typeof t!="object"||t===null))throw new TypeError("options, when provided, must be an object.");if(t?.timestamp!==void 0&&!Number.isFinite(t.timestamp))throw new TypeError("options.timestamp, when provided, must be a number.");if(t?.duration!==void 0&&!Number.isFinite(t.duration))throw new TypeError("options.duration, when provided, must be a number.");return new ia(this.data,this.type,t?.timestamp??this.timestamp,t?.duration??this.duration,this.sequenceNumber,this.byteLength)}},Wc=e=>{let i=e,s=4096,a=0,n=12,o=0;for(i<0&&(i=-i,a=128),i+=33,i>8191&&(i=8191);(i&s)!==s&&n>=5;)s>>=1,n--;return o=i>>n-4&15,~(a|n-5<<4|o)&255},Hc=e=>{let r=0,i=0,s=~e;s&128&&(s&=-129,r=-1),i=((s&240)>>4)+5;let a=(1<<i|(s&15)<<i-4|1<<i-5)-33;return r===0?a:-a},qc=e=>{let r=2048,i=0,s=11,a=0,n=e;for(n<0&&(n=-n,i=128),n>4095&&(n=4095);(n&r)!==r&&s>=5;)r>>=1,s--;return a=n>>(s===4?1:s-4)&15,(i|s-4<<4|a)^85},$c=e=>{let t=0,r=0,i=e^85;i&128&&(i&=-129,t=-1),r=((i&240)>>4)+4;let s=0;return r!==4?s=1<<r|(i&15)<<r-4|1<<r-5:s=i<<1|1,t===0?s:-s};ha();var Qe=class Jr{constructor(t,r){if(this._closed=!1,t instanceof ArrayBuffer||ArrayBuffer.isView(t)){if(!r||typeof r!="object")throw new TypeError("init must be an object.");if(!("format"in r)||typeof r.format!="string")throw new TypeError("init.format must be a string.");if(!Number.isInteger(r.codedWidth)||r.codedWidth<=0)throw new TypeError("init.codedWidth must be a positive integer.");if(!Number.isInteger(r.codedHeight)||r.codedHeight<=0)throw new TypeError("init.codedHeight must be a positive integer.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(r.timestamp))throw new TypeError("init.timestamp must be a number.");if(r.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=ge(t).slice(),this.format=r.format,this.codedWidth=r.codedWidth,this.codedHeight=r.codedHeight,this.rotation=r.rotation??0,this.timestamp=r.timestamp,this.duration=r.duration??0,this.colorSpace=new VideoColorSpace(r.colorSpace)}else if(typeof VideoFrame<"u"&&t instanceof VideoFrame){if(r?.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(r?.timestamp!==void 0&&!Number.isFinite(r?.timestamp))throw new TypeError("init.timestamp, when provided, must be a number.");if(r?.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");this._data=t,this.format=t.format,this.codedWidth=t.displayWidth,this.codedHeight=t.displayHeight,this.rotation=r?.rotation??0,this.timestamp=r?.timestamp??t.timestamp/1e6,this.duration=r?.duration??(t.duration??0)/1e6,this.colorSpace=t.colorSpace}else if(typeof HTMLImageElement<"u"&&t instanceof HTMLImageElement||typeof SVGImageElement<"u"&&t instanceof SVGImageElement||typeof ImageBitmap<"u"&&t instanceof ImageBitmap||typeof HTMLVideoElement<"u"&&t instanceof HTMLVideoElement||typeof HTMLCanvasElement<"u"&&t instanceof HTMLCanvasElement||typeof OffscreenCanvas<"u"&&t instanceof OffscreenCanvas){if(!r||typeof r!="object")throw new TypeError("init must be an object.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("init.rotation, when provided, must be 0, 90, 180, or 270.");if(!Number.isFinite(r.timestamp))throw new TypeError("init.timestamp must be a number.");if(r.duration!==void 0&&(!Number.isFinite(r.duration)||r.duration<0))throw new TypeError("init.duration, when provided, must be a non-negative number.");if(typeof VideoFrame<"u")return new Jr(new VideoFrame(t,{timestamp:Math.trunc(r.timestamp*Nt),duration:Math.trunc((r.duration??0)*Nt)||void 0}),r);let i=0,s=0;if("naturalWidth"in t?(i=t.naturalWidth,s=t.naturalHeight):"videoWidth"in t?(i=t.videoWidth,s=t.videoHeight):"width"in t&&(i=Number(t.width),s=Number(t.height)),!i||!s)throw new TypeError("Could not determine dimensions.");let a=new OffscreenCanvas(i,s),n=a.getContext("2d",{alpha:Or(),willReadFrequently:!0});d(n),n.drawImage(t,0,0),this._data=a,this.format="RGBX",this.codedWidth=i,this.codedHeight=s,this.rotation=r.rotation??0,this.timestamp=r.timestamp,this.duration=r.duration??0,this.colorSpace=new VideoColorSpace({matrix:"rgb",primaries:"bt709",transfer:"iec61966-2-1",fullRange:!0})}else throw new TypeError("Invalid data type: Must be a BufferSource or CanvasImageSource.")}get displayWidth(){return this.rotation%180===0?this.codedWidth:this.codedHeight}get displayHeight(){return this.rotation%180===0?this.codedHeight:this.codedWidth}get microsecondTimestamp(){return Math.trunc(Nt*this.timestamp)}get microsecondDuration(){return Math.trunc(Nt*this.duration)}get hasAlpha(){return this.format&&this.format.includes("A")}clone(){if(this._closed)throw new Error("VideoSample is closed.");return d(this._data!==null),Vr(this._data)?new Jr(this._data.clone(),{timestamp:this.timestamp,duration:this.duration,rotation:this.rotation}):this._data instanceof Uint8Array?new Jr(this._data.slice(),{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation}):new Jr(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.timestamp,duration:this.duration,colorSpace:this.colorSpace,rotation:this.rotation})}close(){this._closed||(Vr(this._data)?this._data.close():this._data=null,this._closed=!0)}allocationSize(){if(this._closed)throw new Error("VideoSample is closed.");return d(this._data!==null),Vr(this._data)?this._data.allocationSize():this._data instanceof Uint8Array?this._data.byteLength:this.codedWidth*this.codedHeight*4}async copyTo(t){if(!Ct(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(this._closed)throw new Error("VideoSample is closed.");if(d(this._data!==null),Vr(this._data))await this._data.copyTo(t);else if(this._data instanceof Uint8Array)ge(t).set(this._data);else{let i=this._data.getContext("2d");d(i);let s=i.getImageData(0,0,this.codedWidth,this.codedHeight);ge(t).set(s.data)}}toVideoFrame(){if(this._closed)throw new Error("VideoSample is closed.");return d(this._data!==null),Vr(this._data)?new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0}):this._data instanceof Uint8Array?new VideoFrame(this._data,{format:this.format,codedWidth:this.codedWidth,codedHeight:this.codedHeight,timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0,colorSpace:this.colorSpace}):new VideoFrame(this._data,{timestamp:this.microsecondTimestamp,duration:this.microsecondDuration||void 0})}draw(t,r,i,s,a,n,o,c,l){let u=0,h=0,f=this.displayWidth,w=this.displayHeight,b=0,p=0,y=this.displayWidth,k=this.displayHeight;if(n!==void 0?(u=r,h=i,f=s,w=a,b=n,p=o,c!==void 0?(y=c,k=l):(y=f,k=w)):(b=r,p=i,s!==void 0&&(y=s,k=a)),!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!Number.isFinite(u))throw new TypeError("sx must be a number.");if(!Number.isFinite(h))throw new TypeError("sy must be a number.");if(!Number.isFinite(f)||f<0)throw new TypeError("sWidth must be a non-negative number.");if(!Number.isFinite(w)||w<0)throw new TypeError("sHeight must be a non-negative number.");if(!Number.isFinite(b))throw new TypeError("dx must be a number.");if(!Number.isFinite(p))throw new TypeError("dy must be a number.");if(!Number.isFinite(y)||y<0)throw new TypeError("dWidth must be a non-negative number.");if(!Number.isFinite(k)||k<0)throw new TypeError("dHeight must be a non-negative number.");if(this._closed)throw new Error("VideoSample is closed.");({sx:u,sy:h,sWidth:f,sHeight:w}=this._rotateSourceRegion(u,h,f,w,this.rotation));let T=this.toCanvasImageSource();t.save();let _=b+y/2,x=p+k/2;t.translate(_,x),t.rotate(this.rotation*Math.PI/180);let B=this.rotation%180===0?1:y/k;t.scale(1/B,B),t.drawImage(T,u,h,f,w,-y/2,-k/2,y,k),t.restore()}drawWithFit(t,r){if(!(typeof CanvasRenderingContext2D<"u"&&t instanceof CanvasRenderingContext2D||typeof OffscreenCanvasRenderingContext2D<"u"&&t instanceof OffscreenCanvasRenderingContext2D))throw new TypeError("context must be a CanvasRenderingContext2D or OffscreenCanvasRenderingContext2D.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(!["fill","contain","cover"].includes(r.fit))throw new TypeError("options.fit must be 'fill', 'contain', or 'cover'.");if(r.rotation!==void 0&&![0,90,180,270].includes(r.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180, or 270.");r.crop!==void 0&&Ki(r.crop,"options.");let i=t.canvas.width,s=t.canvas.height,a=r.rotation??this.rotation,[n,o]=a%180===0?[this.codedWidth,this.codedHeight]:[this.codedHeight,this.codedWidth];r.crop&&Qi(r.crop,n,o);let c,l,u,h,{sx:f,sy:w,sWidth:b,sHeight:p}=this._rotateSourceRegion(r.crop?.left??0,r.crop?.top??0,r.crop?.width??n,r.crop?.height??o,a);if(r.fit==="fill")c=0,l=0,u=i,h=s;else{let[k,T]=r.crop?[r.crop.width,r.crop.height]:[n,o],_=r.fit==="contain"?Math.min(i/k,s/T):Math.max(i/k,s/T);u=k*_,h=T*_,c=(i-u)/2,l=(s-h)/2}let y=a%180===0?1:u/h;t.translate(i/2,s/2),t.rotate(a*Math.PI/180),t.scale(1/y,y),t.translate(-i/2,-s/2),t.drawImage(this.toCanvasImageSource(),f,w,b,p,c,l,u,h)}_rotateSourceRegion(t,r,i,s,a){return a===90?[t,r,i,s]=[r,this.codedHeight-t-i,s,i]:a===180?[t,r]=[this.codedWidth-t-i,this.codedHeight-r-s]:a===270&&([t,r,i,s]=[this.codedWidth-r-s,t,s,i]),{sx:t,sy:r,sWidth:i,sHeight:s}}toCanvasImageSource(){if(this._closed)throw new Error("VideoSample is closed.");if(d(this._data!==null),this._data instanceof Uint8Array){let t=this.toVideoFrame();return queueMicrotask(()=>t.close()),t}else return this._data}setRotation(t){if(![0,90,180,270].includes(t))throw new TypeError("newRotation must be 0, 90, 180, or 270.");this.rotation=t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}setDuration(t){if(!Number.isFinite(t)||t<0)throw new TypeError("newDuration must be a non-negative number.");this.duration=t}[Symbol.dispose](){this.close()}},Vr=e=>typeof VideoFrame<"u"&&e instanceof VideoFrame,Qi=(e,t,r)=>{e.left=Math.min(e.left,t),e.top=Math.min(e.top,r),e.width=Math.min(e.width,t-e.left),e.height=Math.min(e.height,r-e.top),d(e.width>=0),d(e.height>=0)},Ki=(e,t)=>{if(!e||typeof e!="object")throw new TypeError(t+"crop, when provided, must be an object.");if(!Number.isInteger(e.left)||e.left<0)throw new TypeError(t+"crop.left must be a non-negative integer.");if(!Number.isInteger(e.top)||e.top<0)throw new TypeError(t+"crop.top must be a non-negative integer.");if(!Number.isInteger(e.width)||e.width<0)throw new TypeError(t+"crop.width must be a non-negative integer.");if(!Number.isInteger(e.height)||e.height<0)throw new TypeError(t+"crop.height must be a non-negative integer.")},Gi=new Set(["f32","f32-planar","s16","s16-planar","s32","s32-planar","u8","u8-planar"]),bt=class ei{constructor(t){if(this._closed=!1,Hr(t)){if(t.format===null)throw new TypeError("AudioData with null format is not supported.");this._data=t,this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=t.numberOfFrames,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp/1e6,this.duration=t.numberOfFrames/t.sampleRate}else{if(!t||typeof t!="object")throw new TypeError("Invalid AudioDataInit: must be an object.");if(!Gi.has(t.format))throw new TypeError("Invalid AudioDataInit: invalid format.");if(!Number.isFinite(t.sampleRate)||t.sampleRate<=0)throw new TypeError("Invalid AudioDataInit: sampleRate must be > 0.");if(!Number.isInteger(t.numberOfChannels)||t.numberOfChannels===0)throw new TypeError("Invalid AudioDataInit: numberOfChannels must be an integer > 0.");if(!Number.isFinite(t?.timestamp))throw new TypeError("init.timestamp must be a number.");let r=t.data.byteLength/(Wr(t.format)*t.numberOfChannels);if(!Number.isInteger(r))throw new TypeError("Invalid AudioDataInit: data size is not a multiple of frame size.");this.format=t.format,this.sampleRate=t.sampleRate,this.numberOfFrames=r,this.numberOfChannels=t.numberOfChannels,this.timestamp=t.timestamp,this.duration=r/t.sampleRate;let i;if(t.data instanceof ArrayBuffer)i=new Uint8Array(t.data);else if(ArrayBuffer.isView(t.data))i=new Uint8Array(t.data.buffer,t.data.byteOffset,t.data.byteLength);else throw new TypeError("Invalid AudioDataInit: data is not a BufferSource.");let s=this.numberOfFrames*this.numberOfChannels*Wr(this.format);if(i.byteLength<s)throw new TypeError("Invalid AudioDataInit: insufficient data size.");this._data=i}}get microsecondTimestamp(){return Math.trunc(Nt*this.timestamp)}get microsecondDuration(){return Math.trunc(Nt*this.duration)}allocationSize(t){if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(t.planeIndex)||t.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(t.format!==void 0&&!Gi.has(t.format))throw new TypeError("Invalid format.");if(t.frameOffset!==void 0&&(!Number.isInteger(t.frameOffset)||t.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(t.frameCount!==void 0&&(!Number.isInteger(t.frameCount)||t.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let r=t.format??this.format,i=t.frameOffset??0;if(i>=this.numberOfFrames)throw new RangeError("frameOffset out of range");let s=t.frameCount!==void 0?t.frameCount:this.numberOfFrames-i;if(s>this.numberOfFrames-i)throw new RangeError("frameCount out of range");let a=Wr(r),n=pi(r);if(n&&t.planeIndex>=this.numberOfChannels)throw new RangeError("planeIndex out of range");if(!n&&t.planeIndex!==0)throw new RangeError("planeIndex out of range");return(n?s:s*this.numberOfChannels)*a}copyTo(t,r){if(!Ct(t))throw new TypeError("destination must be an ArrayBuffer or an ArrayBuffer view.");if(!r||typeof r!="object")throw new TypeError("options must be an object.");if(!Number.isInteger(r.planeIndex)||r.planeIndex<0)throw new TypeError("planeIndex must be a non-negative integer.");if(r.format!==void 0&&!Gi.has(r.format))throw new TypeError("Invalid format.");if(r.frameOffset!==void 0&&(!Number.isInteger(r.frameOffset)||r.frameOffset<0))throw new TypeError("frameOffset must be a non-negative integer.");if(r.frameCount!==void 0&&(!Number.isInteger(r.frameCount)||r.frameCount<0))throw new TypeError("frameCount must be a non-negative integer.");if(this._closed)throw new Error("AudioSample is closed.");let{planeIndex:i,format:s,frameCount:a,frameOffset:n}=r,o=s??this.format;if(!o)throw new Error("Destination format not determined");let c=this.numberOfFrames,l=this.numberOfChannels,u=n??0;if(u>=c)throw new RangeError("frameOffset out of range");let h=a!==void 0?a:c-u;if(h>c-u)throw new RangeError("frameCount out of range");let f=Wr(o),w=pi(o);if(w&&i>=l)throw new RangeError("planeIndex out of range");if(!w&&i!==0)throw new RangeError("planeIndex out of range");let p=(w?h:h*l)*f;if(t.byteLength<p)throw new RangeError("Destination buffer is too small");let y=le(t),k=Qc(o);if(Hr(this._data))if(w)if(o==="f32-planar")this._data.copyTo(t,{planeIndex:i,frameOffset:u,frameCount:h,format:"f32-planar"});else{let T=new ArrayBuffer(h*4),_=new Float32Array(T);this._data.copyTo(_,{planeIndex:i,frameOffset:u,frameCount:h,format:"f32-planar"});let x=new DataView(T);for(let B=0;B<h;B++){let I=B*f,M=x.getFloat32(B*4,!0);k(y,I,M)}}else{let T=l,_=new Float32Array(h);for(let x=0;x<T;x++){this._data.copyTo(_,{planeIndex:x,frameOffset:u,frameCount:h,format:"f32-planar"});for(let B=0;B<h;B++){let M=(B*T+x)*f;k(y,M,_[B])}}}else{let T=this._data,_=new DataView(T.buffer,T.byteOffset,T.byteLength),x=this.format,B=jc(x),I=Wr(x),M=pi(x);for(let V=0;V<h;V++)if(w){let he=V*f,G;M?G=(i*c+(V+u))*I:G=((V+u)*l+i)*I;let W=B(_,G);k(y,he,W)}else for(let he=0;he<l;he++){let W=(V*l+he)*f,ee;M?ee=(he*c+(V+u))*I:ee=((V+u)*l+he)*I;let fe=B(_,ee);k(y,W,fe)}}}clone(){if(this._closed)throw new Error("AudioSample is closed.");if(Hr(this._data)){let t=new ei(this._data.clone());return t.setTimestamp(this.timestamp),t}else return new ei({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.timestamp,data:this._data})}close(){this._closed||(Hr(this._data)?this._data.close():this._data=new Uint8Array(0),this._closed=!0)}toAudioData(){if(this._closed)throw new Error("AudioSample is closed.");if(Hr(this._data)){if(this._data.timestamp===this.microsecondTimestamp)return this._data.clone();if(pi(this.format)){let t=this.allocationSize({planeIndex:0,format:this.format}),r=new ArrayBuffer(t*this.numberOfChannels);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(new Uint8Array(r,i*t,t),{planeIndex:i,format:this.format});return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:r})}else{let t=new ArrayBuffer(this.allocationSize({planeIndex:0,format:this.format}));return this.copyTo(t,{planeIndex:0,format:this.format}),new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:t})}}else return new AudioData({format:this.format,sampleRate:this.sampleRate,numberOfFrames:this.numberOfFrames,numberOfChannels:this.numberOfChannels,timestamp:this.microsecondTimestamp,data:this._data})}toAudioBuffer(){if(this._closed)throw new Error("AudioSample is closed.");let t=new AudioBuffer({numberOfChannels:this.numberOfChannels,length:this.numberOfFrames,sampleRate:this.sampleRate}),r=new Float32Array(this.allocationSize({planeIndex:0,format:"f32-planar"})/4);for(let i=0;i<this.numberOfChannels;i++)this.copyTo(r,{planeIndex:i,format:"f32-planar"}),t.copyToChannel(r,i);return t}setTimestamp(t){if(!Number.isFinite(t))throw new TypeError("newTimestamp must be a number.");this.timestamp=t}[Symbol.dispose](){this.close()}static*_fromAudioBuffer(t,r){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let i=48e3*5,s=t.numberOfChannels,a=t.sampleRate,n=t.length,o=Math.floor(i/s),c=0,l=n;for(;l>0;){let u=Math.min(o,l),h=new Float32Array(s*u);for(let f=0;f<s;f++)t.copyFromChannel(h.subarray(f*u,(f+1)*u),f,c);yield new ei({format:"f32-planar",sampleRate:a,numberOfFrames:u,numberOfChannels:s,timestamp:r+c/a,data:h}),c+=u,l-=u}}static fromAudioBuffer(t,r){if(!(t instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let i=48e3*5,s=t.numberOfChannels,a=t.sampleRate,n=t.length,o=Math.floor(i/s),c=0,l=n,u=[];for(;l>0;){let h=Math.min(o,l),f=new Float32Array(s*h);for(let b=0;b<s;b++)t.copyFromChannel(f.subarray(b*h,(b+1)*h),b,c);let w=new ei({format:"f32-planar",sampleRate:a,numberOfFrames:h,numberOfChannels:s,timestamp:r+c/a,data:f});u.push(w),c+=h,l-=h}return u}},Wr=e=>{switch(e){case"u8":case"u8-planar":return 1;case"s16":case"s16-planar":return 2;case"s32":case"s32-planar":return 4;case"f32":case"f32-planar":return 4;default:throw new Error("Unknown AudioSampleFormat")}},pi=e=>{switch(e){case"u8-planar":case"s16-planar":case"s32-planar":case"f32-planar":return!0;default:return!1}},jc=e=>{switch(e){case"u8":case"u8-planar":return(t,r)=>(t.getUint8(r)-128)/128;case"s16":case"s16-planar":return(t,r)=>t.getInt16(r,!0)/32768;case"s32":case"s32-planar":return(t,r)=>t.getInt32(r,!0)/2147483648;case"f32":case"f32-planar":return(t,r)=>t.getFloat32(r,!0)}},Qc=e=>{switch(e){case"u8":case"u8-planar":return(t,r,i)=>t.setUint8(r,Ie((i+1)*127.5,0,255));case"s16":case"s16-planar":return(t,r,i)=>t.setInt16(r,Ie(Math.round(i*32767),-32768,32767),!0);case"s32":case"s32-planar":return(t,r,i)=>t.setInt32(r,Ie(Math.round(i*2147483647),-2147483648,2147483647),!0);case"f32":case"f32-planar":return(t,r,i)=>t.setFloat32(r,i,!0)}},Hr=e=>typeof AudioData<"u"&&e instanceof AudioData,wr=e=>{if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.metadataOnly!==void 0&&typeof e.metadataOnly!="boolean")throw new TypeError("options.metadataOnly, when defined, must be a boolean.");if(e.verifyKeyPackets!==void 0&&typeof e.verifyKeyPackets!="boolean")throw new TypeError("options.verifyKeyPackets, when defined, must be a boolean.");if(e.verifyKeyPackets&&e.metadataOnly)throw new TypeError("options.verifyKeyPackets and options.metadataOnly cannot be enabled together.")},Pt=e=>{if(!mr(e))throw new TypeError("timestamp must be a number.")},Xi=(e,t,r)=>r.verifyKeyPackets?t.then(async i=>{if(!i||i.type==="delta")return i;let s=await e.determinePacketType(i);return s&&(i.type=s),i}):t,br=class{constructor(e){if(!(e instanceof bi))throw new TypeError("track must be an InputTrack.");this._track=e}getFirstPacket(e={}){if(wr(e),this._track.input._disposed)throw new Ue;return Xi(this._track,this._track._backing.getFirstPacket(e),e)}getPacket(e,t={}){if(Pt(e),wr(t),this._track.input._disposed)throw new Ue;return Xi(this._track,this._track._backing.getPacket(e,t),t)}getNextPacket(e,t={}){if(!(e instanceof we))throw new TypeError("packet must be an EncodedPacket.");if(wr(t),this._track.input._disposed)throw new Ue;return Xi(this._track,this._track._backing.getNextPacket(e,t),t)}async getKeyPacket(e,t={}){if(Pt(e),wr(t),this._track.input._disposed)throw new Ue;if(!t.verifyKeyPackets)return this._track._backing.getKeyPacket(e,t);let r=await this._track._backing.getKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getKeyPacket(r.timestamp-1/this._track.timeResolution,t):r}async getNextKeyPacket(e,t={}){if(!(e instanceof we))throw new TypeError("packet must be an EncodedPacket.");if(wr(t),this._track.input._disposed)throw new Ue;if(!t.verifyKeyPackets)return this._track._backing.getNextKeyPacket(e,t);let r=await this._track._backing.getNextKeyPacket(e,t);return!r||r.type==="delta"?r:await this._track.determinePacketType(r)==="delta"?this.getNextKeyPacket(r,t):r}packets(e,t,r={}){if(e!==void 0&&!(e instanceof we))throw new TypeError("startPacket must be an EncodedPacket.");if(e!==void 0&&e.isMetadataOnly&&!r?.metadataOnly)throw new TypeError("startPacket can only be metadata-only if options.metadataOnly is enabled.");if(t!==void 0&&!(t instanceof we))throw new TypeError("endPacket must be an EncodedPacket.");if(wr(r),this._track.input._disposed)throw new Ue;let i=[],{promise:s,resolve:a}=ke(),{promise:n,resolve:o}=ke(),c=!1,l=!1,u=null,h=[],f=()=>Math.max(2,h.length);(async()=>{let b=e??await this.getFirstPacket(r);for(;b&&!l&&!this._track.input._disposed&&!(t&&b.sequenceNumber>=t?.sequenceNumber);){if(i.length>f()){({promise:n,resolve:o}=ke()),await n;continue}i.push(b),a(),{promise:s,resolve:a}=ke(),b=await this.getNextPacket(b,r)}c=!0,a()})().catch(b=>{u||(u=b,a())});let w=this._track;return{async next(){for(;;){if(w.input._disposed)throw new Ue;if(l)return{value:void 0,done:!0};if(u)throw u;if(i.length>0){let b=i.shift(),p=performance.now();for(h.push(p);h.length>0&&p-h[0]>=1e3;)h.shift();return o(),{value:b,done:!1}}else{if(c)return{value:void 0,done:!0};await s}}},async return(){return l=!0,o(),a(),{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}},Yi=class{constructor(e,t){this.onSample=e,this.onError=t}},Zi=class{mediaSamplesInRange(e=0,t=1/0){Pt(e),Pt(t);let r=[],i=!1,s=null,{promise:a,resolve:n}=ke(),{promise:o,resolve:c}=ke(),l=!1,u=!1,h=!1,f=null;(async()=>{let p=new Error,y=await this._createDecoder(I=>{if(c(),I.timestamp>=t&&(u=!0),u){I.close();return}s&&(I.timestamp>e?(r.push(s),i=!0):s.close()),I.timestamp>=e&&(r.push(I),i=!0),s=i?null:I,r.length>0&&(n(),{promise:a,resolve:n}=ke())},I=>{f||(I.stack=p.stack,f=I,n())}),k=this._createPacketSink(),T=await k.getKeyPacket(e,{verifyKeyPackets:!0})??await k.getFirstPacket();if(!T)return;let _=T,x;if(t<1/0){let I=await k.getPacket(t),M=I?I.type==="key"&&I.timestamp===t?I:await k.getNextKeyPacket(I,{verifyKeyPackets:!0}):null;M&&(x=M)}let B=k.packets(T,x);for(await B.next();_&&!u&&!this._track.input._disposed;){let I=La(r.length);if(r.length+y.getDecodeQueueSize()>I){({promise:o,resolve:c}=ke()),await o;continue}y.decode(_);let M=await B.next();if(M.done)break;_=M.value}await B.return(),!h&&!this._track.input._disposed&&await y.flush(),y.close(),!i&&s&&r.push(s),l=!0,n()})().catch(p=>{f||(f=p,n())});let w=this._track,b=()=>{s?.close();for(let p of r)p.close()};return{async next(){for(;;){if(w.input._disposed)throw b(),new Ue;if(h)return{value:void 0,done:!0};if(f)throw b(),f;if(r.length>0){let p=r.shift();return c(),{value:p,done:!1}}else if(!l)await a;else return{value:void 0,done:!0}}},async return(){return h=!0,u=!0,c(),n(),b(),{value:void 0,done:!0}},async throw(p){throw p},[Symbol.asyncIterator](){return this}}}mediaSamplesAtTimestamps(e){ac(e);let t=sc(e),r=[],i=[],{promise:s,resolve:a}=ke(),{promise:n,resolve:o}=ke(),c=!1,l=!1,u=null,h=b=>{i.push(b),a(),{promise:s,resolve:a}=ke()};(async()=>{let b=new Error,p=await this._createDecoder(I=>{if(o(),l){I.close();return}let M=0;for(;r.length>0&&I.timestamp-r[0]>-1e-10;)M++,r.shift();if(M>0)for(let V=0;V<M;V++)h(V<M-1?I.clone():I);else I.close()},I=>{u||(I.stack=b.stack,u=I,a())}),y=this._createPacketSink(),k=null,T=null,_=-1,x=async()=>{d(T);let I=T;for(p.decode(I);I.sequenceNumber<_;){let M=La(i.length);for(;i.length+p.getDecodeQueueSize()>M&&!l;)({promise:n,resolve:o}=ke()),await n;if(l)break;let V=await y.getNextPacket(I);d(V),p.decode(V),I=V}_=-1},B=async()=>{await p.flush();for(let I=0;I<r.length;I++)h(null);r.length=0};for await(let I of t){if(Pt(I),l||this._track.input._disposed)break;let M=await y.getPacket(I),V=M&&await y.getKeyPacket(I,{verifyKeyPackets:!0});if(!V){_!==-1&&(await x(),await B()),h(null),k=null;continue}k&&(V.sequenceNumber!==T.sequenceNumber||M.timestamp<k.timestamp)&&(await x(),await B()),r.push(M.timestamp),_=Math.max(M.sequenceNumber,_),k=M,T=V}!l&&!this._track.input._disposed&&(_!==-1&&await x(),await B()),p.close(),c=!0,a()})().catch(b=>{u||(u=b,a())});let f=this._track,w=()=>{for(let b of i)b?.close()};return{async next(){for(;;){if(f.input._disposed)throw w(),new Ue;if(l)return{value:void 0,done:!0};if(u)throw w(),u;if(i.length>0){let b=i.shift();return d(b!==void 0),o(),{value:b,done:!1}}else if(!c)await s;else return{value:void 0,done:!0}}},async return(){return l=!0,o(),a(),w(),{value:void 0,done:!0}},async throw(b){throw b},[Symbol.asyncIterator](){return this}}}},La=e=>e===0?40:8,Kc=class extends Yi{constructor(e,t,r,i,s,a){super(e,t),this.codec=r,this.decoderConfig=i,this.rotation=s,this.timeResolution=a,this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new oi,this.customDecoderQueueSize=0,this.inputTimestamps=[],this.sampleQueue=[],this.currentPacketIndex=0,this.raslSkipped=!1,this.alphaDecoder=null,this.alphaHadKeyframe=!1,this.colorQueue=[],this.alphaQueue=[],this.merger=null,this.mergerCreationFailed=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue=[],this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1;let n=fi.find(o=>o.supports(r,i));if(n)this.customDecoder=new n,this.customDecoder.codec=r,this.customDecoder.config=i,this.customDecoder.onSample=o=>{if(!(o instanceof Qe))throw new TypeError("The argument passed to onSample must be a VideoSample.");this.finalizeAndEmitSample(o)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init());else{let o=c=>{if(this.alphaQueue.length>0){let l=this.alphaQueue.shift();d(l!==void 0),this.mergeAlpha(c,l)}else this.colorQueue.push(c)};this.decoder=new VideoDecoder({output:c=>{try{o(c)}catch(l){this.onError(l)}},error:t}),this.decoder.configure(i)}}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(d(this.decoder),Math.max(this.decoder.decodeQueueSize,this.alphaDecoder?.decodeQueueSize??0))}decode(e){if(this.codec==="hevc"&&this.currentPacketIndex>0&&!this.raslSkipped){if(this.hasHevcRaslPicture(e.data))return;this.raslSkipped=!0}this.currentPacketIndex++,this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(d(this.decoder),Ui()||aa(this.inputTimestamps,e.timestamp,t=>t),this.decoder.decode(e.toEncodedVideoChunk()),this.decodeAlphaData(e))}decodeAlphaData(e){if(!e.sideData.alpha||this.mergerCreationFailed){this.pushNullAlphaFrame();return}if(!this.merger)try{this.merger=new Gc}catch(r){console.error("Due to an error, only color data will be decoded.",r),this.mergerCreationFailed=!0,this.decodeAlphaData(e);return}if(!this.alphaDecoder){let r=i=>{if(this.alphaDecoderQueueSize--,this.colorQueue.length>0){let s=this.colorQueue.shift();d(s!==void 0),this.mergeAlpha(s,i)}else this.alphaQueue.push(i);for(this.decodedAlphaChunkCount++;this.nullAlphaFrameQueue.length>0&&this.nullAlphaFrameQueue[0]===this.decodedAlphaChunkCount;)if(this.nullAlphaFrameQueue.shift(),this.colorQueue.length>0){let s=this.colorQueue.shift();d(s!==void 0),this.mergeAlpha(s,null)}else this.alphaQueue.push(null)};this.alphaDecoder=new VideoDecoder({output:i=>{try{r(i)}catch(s){this.onError(s)}},error:this.onError}),this.alphaDecoder.configure(this.decoderConfig)}let t=Ra(this.codec,this.decoderConfig,e.sideData.alpha);if(this.alphaHadKeyframe||(this.alphaHadKeyframe=t==="key"),this.alphaHadKeyframe){if(this.codec==="hevc"&&this.currentAlphaPacketIndex>0&&!this.alphaRaslSkipped){if(this.hasHevcRaslPicture(e.sideData.alpha)){this.pushNullAlphaFrame();return}this.alphaRaslSkipped=!0}this.currentAlphaPacketIndex++,this.alphaDecoder.decode(e.alphaToEncodedVideoChunk(t??e.type)),this.alphaDecoderQueueSize++}else this.pushNullAlphaFrame()}pushNullAlphaFrame(){this.alphaDecoderQueueSize===0?this.alphaQueue.push(null):this.nullAlphaFrameQueue.push(this.decodedAlphaChunkCount+this.alphaDecoderQueueSize)}hasHevcRaslPicture(e){return Ia(e,this.decoderConfig).some(r=>{let i=Lt(r);return i===8||i===9})}sampleHandler(e){if(Ui()){if(this.sampleQueue.length>0&&e.timestamp>=de(this.sampleQueue).timestamp){for(let t of this.sampleQueue)this.finalizeAndEmitSample(t);this.sampleQueue.length=0}aa(this.sampleQueue,e,t=>t.timestamp)}else{let t=this.inputTimestamps.shift();d(t!==void 0),e.setTimestamp(t),this.finalizeAndEmitSample(e)}}finalizeAndEmitSample(e){e.setTimestamp(Math.round(e.timestamp*this.timeResolution)/this.timeResolution),e.setDuration(Math.round(e.duration*this.timeResolution)/this.timeResolution),e.setRotation(this.rotation),this.onSample(e)}mergeAlpha(e,t){if(!t){let s=new Qe(e);this.sampleHandler(s);return}d(this.merger),this.merger.update(e,t),e.close(),t.close();let r=new VideoFrame(this.merger.canvas,{timestamp:e.timestamp,duration:e.duration??void 0}),i=new Qe(r);this.sampleHandler(i)}async flush(){if(this.customDecoder?await this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(d(this.decoder),await Promise.all([this.decoder.flush(),this.alphaDecoder?.flush()]),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.alphaHadKeyframe=!1,this.decodedAlphaChunkCount=0,this.alphaDecoderQueueSize=0,this.nullAlphaFrameQueue.length=0,this.currentAlphaPacketIndex=0,this.alphaRaslSkipped=!1),Ui()){for(let e of this.sampleQueue)this.finalizeAndEmitSample(e);this.sampleQueue.length=0}this.currentPacketIndex=0,this.raslSkipped=!1}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(d(this.decoder),this.decoder.close(),this.alphaDecoder?.close(),this.colorQueue.forEach(e=>e.close()),this.colorQueue.length=0,this.alphaQueue.forEach(e=>e?.close()),this.alphaQueue.length=0,this.merger?.close());for(let e of this.sampleQueue)e.close();this.sampleQueue.length=0}},Gc=class{constructor(){typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(300,150):this.canvas=document.createElement("canvas");let e=this.canvas.getContext("webgl2",{premultipliedAlpha:!1});if(!e)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=e,this.program=this.createProgram(),this.vao=this.createVAO(),this.colorTexture=this.createTexture(),this.alphaTexture=this.createTexture(),this.gl.useProgram(this.program),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_colorTexture"),0),this.gl.uniform1i(this.gl.getUniformLocation(this.program,"u_alphaTexture"),1)}createProgram(){let e=this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n			in vec2 a_position;\n			in vec2 a_texCoord;\n			out vec2 v_texCoord;\n			\n			void main() {\n				gl_Position = vec4(a_position, 0.0, 1.0);\n				v_texCoord = a_texCoord;\n			}\n		"),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_colorTexture;\n			uniform sampler2D u_alphaTexture;\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n			\n			void main() {\n				vec3 color = texture(u_colorTexture, v_texCoord).rgb;\n				float alpha = texture(u_alphaTexture, v_texCoord).r;\n				fragColor = vec4(color, alpha);\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.program,"a_position"),s=this.gl.getAttribLocation(this.program,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}update(e,t){(e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.colorTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.gl.activeTexture(this.gl.TEXTURE1),this.gl.bindTexture(this.gl.TEXTURE_2D,this.alphaTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,t),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},gi=class extends Zi{constructor(e){if(!(e instanceof kr))throw new TypeError("videoTrack must be an InputVideoTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This video track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,i=this._track.rotation,s=await this._track.getDecoderConfig(),a=this._track.timeResolution;return d(r&&s),new Kc(e,t,r,s,i,a)}_createPacketSink(){return new br(this._track)}async getSample(e){Pt(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},Va=class{constructor(e,t={}){if(this._nextCanvasIndex=0,!(e instanceof kr))throw new TypeError("videoTrack must be an InputVideoTrack.");if(t&&typeof t!="object")throw new TypeError("options must be an object.");if(t.alpha!==void 0&&typeof t.alpha!="boolean")throw new TypeError("options.alpha, when provided, must be a boolean.");if(t.width!==void 0&&(!Number.isInteger(t.width)||t.width<=0))throw new TypeError("options.width, when defined, must be a positive integer.");if(t.height!==void 0&&(!Number.isInteger(t.height)||t.height<=0))throw new TypeError("options.height, when defined, must be a positive integer.");if(t.fit!==void 0&&!["fill","contain","cover"].includes(t.fit))throw new TypeError('options.fit, when provided, must be one of "fill", "contain", or "cover".');if(t.width!==void 0&&t.height!==void 0&&t.fit===void 0)throw new TypeError("When both options.width and options.height are provided, options.fit must also be provided.");if(t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("options.rotation, when provided, must be 0, 90, 180 or 270.");if(t.crop!==void 0&&Ki(t.crop,"options."),t.poolSize!==void 0&&(typeof t.poolSize!="number"||!Number.isInteger(t.poolSize)||t.poolSize<0))throw new TypeError("poolSize must be a non-negative integer.");let r=t.rotation??e.rotation,[i,s]=r%180===0?[e.codedWidth,e.codedHeight]:[e.codedHeight,e.codedWidth],a=t.crop;a&&Qi(a,i,s);let[n,o]=a?[a.width,a.height]:[i,s],c=n/o;t.width!==void 0&&t.height===void 0?(n=t.width,o=Math.round(n/c)):t.width===void 0&&t.height!==void 0?(o=t.height,n=Math.round(o*c)):t.width!==void 0&&t.height!==void 0&&(n=t.width,o=t.height),this._videoTrack=e,this._alpha=t.alpha??!1,this._width=n,this._height=o,this._rotation=r,this._crop=a,this._fit=t.fit??"fill",this._videoSampleSink=new gi(e),this._canvasPool=Array.from({length:t.poolSize??0},()=>null)}_videoSampleToWrappedCanvas(e){let t=this._canvasPool[this._nextCanvasIndex],r=!1;t||(typeof document<"u"?(t=document.createElement("canvas"),t.width=this._width,t.height=this._height):t=new OffscreenCanvas(this._width,this._height),this._canvasPool.length>0&&(this._canvasPool[this._nextCanvasIndex]=t),r=!0),this._canvasPool.length>0&&(this._nextCanvasIndex=(this._nextCanvasIndex+1)%this._canvasPool.length);let i=t.getContext("2d",{alpha:this._alpha||Or()});d(i),i.resetTransform(),r||(!this._alpha&&Or()?(i.fillStyle="black",i.fillRect(0,0,this._width,this._height)):i.clearRect(0,0,this._width,this._height)),e.drawWithFit(i,{fit:this._fit,rotation:this._rotation,crop:this._crop});let s={canvas:t,timestamp:e.timestamp,duration:e.duration};return e.close(),s}async getCanvas(e){Pt(e);let t=await this._videoSampleSink.getSample(e);return t&&this._videoSampleToWrappedCanvas(t)}canvases(e=0,t=1/0){return ai(this._videoSampleSink.samples(e,t),r=>this._videoSampleToWrappedCanvas(r))}canvasesAtTimestamps(e){return ai(this._videoSampleSink.samplesAtTimestamps(e),t=>t&&this._videoSampleToWrappedCanvas(t))}},Xc=class extends Yi{constructor(e,t,r,i){super(e,t),this.decoder=null,this.customDecoder=null,this.customDecoderCallSerializer=new oi,this.customDecoderQueueSize=0,this.currentTimestamp=null;let s=n=>{(this.currentTimestamp===null||Math.abs(n.timestamp-this.currentTimestamp)>=n.duration)&&(this.currentTimestamp=n.timestamp);let o=this.currentTimestamp;if(this.currentTimestamp+=n.duration,n.numberOfFrames===0){n.close();return}let c=i.sampleRate;n.setTimestamp(Math.round(o*c)/c),e(n)},a=mi.find(n=>n.supports(r,i));a?(this.customDecoder=new a,this.customDecoder.codec=r,this.customDecoder.config=i,this.customDecoder.onSample=n=>{if(!(n instanceof bt))throw new TypeError("The argument passed to onSample must be an AudioSample.");s(n)},this.customDecoderCallSerializer.call(()=>this.customDecoder.init())):(this.decoder=new AudioDecoder({output:n=>{try{s(new bt(n))}catch(o){this.onError(o)}},error:t}),this.decoder.configure(i))}getDecodeQueueSize(){return this.customDecoder?this.customDecoderQueueSize:(d(this.decoder),this.decoder.decodeQueueSize)}decode(e){this.customDecoder?(this.customDecoderQueueSize++,this.customDecoderCallSerializer.call(()=>this.customDecoder.decode(e)).then(()=>this.customDecoderQueueSize--)):(d(this.decoder),this.decoder.decode(e.toEncodedAudioChunk()))}flush(){return this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.flush()):(d(this.decoder),this.decoder.flush())}close(){this.customDecoder?this.customDecoderCallSerializer.call(()=>this.customDecoder.close()):(d(this.decoder),this.decoder.close())}},Yc=class extends Yi{constructor(e,t,r){super(e,t),this.decoderConfig=r,this.currentTimestamp=null,d(ve.includes(r.codec)),this.codec=r.codec;let{dataType:i,sampleSize:s,littleEndian:a}=wt(this.codec);switch(this.inputSampleSize=s,s){case 1:i==="unsigned"?this.readInputValue=(n,o)=>n.getUint8(o)-2**7:i==="signed"?this.readInputValue=(n,o)=>n.getInt8(o):i==="ulaw"?this.readInputValue=(n,o)=>Hc(n.getUint8(o)):i==="alaw"?this.readInputValue=(n,o)=>$c(n.getUint8(o)):d(!1);break;case 2:i==="unsigned"?this.readInputValue=(n,o)=>n.getUint16(o,a)-2**15:i==="signed"?this.readInputValue=(n,o)=>n.getInt16(o,a):d(!1);break;case 3:i==="unsigned"?this.readInputValue=(n,o)=>si(n,o,a)-2**23:i==="signed"?this.readInputValue=(n,o)=>nc(n,o,a):d(!1);break;case 4:i==="unsigned"?this.readInputValue=(n,o)=>n.getUint32(o,a)-2**31:i==="signed"?this.readInputValue=(n,o)=>n.getInt32(o,a):i==="float"?this.readInputValue=(n,o)=>n.getFloat32(o,a):d(!1);break;case 8:i==="float"?this.readInputValue=(n,o)=>n.getFloat64(o,a):d(!1);break;default:Re(s),d(!1)}switch(s){case 1:i==="ulaw"||i==="alaw"?(this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(n,o,c)=>n.setInt16(o,c,!0)):(this.outputSampleSize=1,this.outputFormat="u8",this.writeOutputValue=(n,o,c)=>n.setUint8(o,c+2**7));break;case 2:this.outputSampleSize=2,this.outputFormat="s16",this.writeOutputValue=(n,o,c)=>n.setInt16(o,c,!0);break;case 3:this.outputSampleSize=4,this.outputFormat="s32",this.writeOutputValue=(n,o,c)=>n.setInt32(o,c<<8,!0);break;case 4:this.outputSampleSize=4,i==="float"?(this.outputFormat="f32",this.writeOutputValue=(n,o,c)=>n.setFloat32(o,c,!0)):(this.outputFormat="s32",this.writeOutputValue=(n,o,c)=>n.setInt32(o,c,!0));break;case 8:this.outputSampleSize=4,this.outputFormat="f32",this.writeOutputValue=(n,o,c)=>n.setFloat32(o,c,!0);break;default:Re(s),d(!1)}}getDecodeQueueSize(){return 0}decode(e){let t=le(e.data),r=e.byteLength/this.decoderConfig.numberOfChannels/this.inputSampleSize,i=r*this.decoderConfig.numberOfChannels*this.outputSampleSize,s=new ArrayBuffer(i),a=new DataView(s);for(let l=0;l<r*this.decoderConfig.numberOfChannels;l++){let u=l*this.inputSampleSize,h=l*this.outputSampleSize,f=this.readInputValue(t,u);this.writeOutputValue(a,h,f)}let n=r/this.decoderConfig.sampleRate;(this.currentTimestamp===null||Math.abs(e.timestamp-this.currentTimestamp)>=n)&&(this.currentTimestamp=e.timestamp);let o=this.currentTimestamp;this.currentTimestamp+=n;let c=new bt({format:this.outputFormat,data:s,numberOfChannels:this.decoderConfig.numberOfChannels,sampleRate:this.decoderConfig.sampleRate,numberOfFrames:r,timestamp:o});this.onSample(c)}async flush(){}close(){}},wi=class extends Zi{constructor(e){if(!(e instanceof ot))throw new TypeError("audioTrack must be an InputAudioTrack.");super(),this._track=e}async _createDecoder(e,t){if(!await this._track.canDecode())throw new Error("This audio track cannot be decoded by this browser. Make sure to check decodability before using a track.");let r=this._track.codec,i=await this._track.getDecoderConfig();return d(r&&i),ve.includes(i.codec)?new Yc(e,t,i):new Xc(e,t,r,i)}_createPacketSink(){return new br(this._track)}async getSample(e){Pt(e);for await(let t of this.mediaSamplesAtTimestamps([e]))return t;throw new Error("Internal error: Iterator returned nothing.")}samples(e=0,t=1/0){return this.mediaSamplesInRange(e,t)}samplesAtTimestamps(e){return this.mediaSamplesAtTimestamps(e)}},Zc=class{constructor(e){if(!(e instanceof ot))throw new TypeError("audioTrack must be an InputAudioTrack.");this._audioSampleSink=new wi(e)}_audioSampleToWrappedArrayBuffer(e){return{buffer:e.toAudioBuffer(),timestamp:e.timestamp,duration:e.duration}}async getBuffer(e){Pt(e);let t=await this._audioSampleSink.getSample(e);return t&&this._audioSampleToWrappedArrayBuffer(t)}buffers(e=0,t=1/0){return ai(this._audioSampleSink.samples(e,t),r=>this._audioSampleToWrappedArrayBuffer(r))}buffersAtTimestamps(e){return ai(this._audioSampleSink.samplesAtTimestamps(e),t=>t&&this._audioSampleToWrappedArrayBuffer(t))}},bi=class{constructor(e,t){this.input=e,this._backing=t}isVideoTrack(){return this instanceof kr}isAudioTrack(){return this instanceof ot}get id(){return this._backing.getId()}get internalCodecId(){return this._backing.getInternalCodecId()}get languageCode(){return this._backing.getLanguageCode()}get name(){return this._backing.getName()}get timeResolution(){return this._backing.getTimeResolution()}getFirstTimestamp(){return this._backing.getFirstTimestamp()}computeDuration(){return this._backing.computeDuration()}async computePacketStats(e=1/0){let t=new br(this),r=1/0,i=-1/0,s=0,a=0;for await(let n of t.packets(void 0,void 0,{metadataOnly:!0})){if(s>=e&&n.timestamp>=i)break;r=Math.min(r,n.timestamp),i=Math.max(i,n.timestamp+n.duration),s++,a+=n.byteLength}return{packetCount:s,averagePacketRate:s?Number((s/(i-r)).toPrecision(16)):0,averageBitrate:s?Number((8*a/(i-r)).toPrecision(16)):0}}},kr=class extends bi{constructor(e,t){super(e,t),this._backing=t}get type(){return"video"}get codec(){return this._backing.getCodec()}get codedWidth(){return this._backing.getCodedWidth()}get codedHeight(){return this._backing.getCodedHeight()}get rotation(){return this._backing.getRotation()}get displayWidth(){return this._backing.getRotation()%180===0?this._backing.getCodedWidth():this._backing.getCodedHeight()}get displayHeight(){return this._backing.getRotation()%180===0?this._backing.getCodedHeight():this._backing.getCodedWidth()}getColorSpace(){return this._backing.getColorSpace()}async hasHighDynamicRange(){let e=await this._backing.getColorSpace();return e.primaries==="bt2020"||e.primaries==="smpte432"||e.transfer==="pg"||e.transfer==="hlg"||e.matrix==="bt2020-ncl"}canBeTransparent(){return this._backing.canBeTransparent()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return d(t!==null),fi.some(i=>i.supports(t,e))?!0:typeof VideoDecoder>"u"?!1:(await VideoDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof we))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("packet must not be metadata-only to determine its type.");if(this.codec===null)return null;let t=await this.getDecoderConfig();return d(t),Ra(this.codec,t,e.data)}},ot=class extends bi{constructor(e,t){super(e,t),this._backing=t}get type(){return"audio"}get codec(){return this._backing.getCodec()}get numberOfChannels(){return this._backing.getNumberOfChannels()}get sampleRate(){return this._backing.getSampleRate()}getDecoderConfig(){return this._backing.getDecoderConfig()}async getCodecParameterString(){return(await this._backing.getDecoderConfig())?.codec??null}async canDecode(){try{let e=await this._backing.getDecoderConfig();if(!e)return!1;let t=this._backing.getCodec();return d(t!==null),mi.some(r=>r.supports(t,e))||e.codec.startsWith("pcm-")?!0:typeof AudioDecoder>"u"?!1:(await AudioDecoder.isConfigSupported(e)).supported===!0}catch(e){return console.error("Error during decodability check:",e),!1}}async determinePacketType(e){if(!(e instanceof we))throw new TypeError("packet must be an EncodedPacket.");return this.codec===null?null:"key"}},Wa=e=>{let r=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isQuickTime?"quicktime":"mp4");if(e.codecStrings.length>0){let i=[...new Set(e.codecStrings)];r+='; codecs="'.concat(i.join(", "),'"')}return r},It=8,ir=16,Vt=e=>{let t=O(e),r=Ee(e,4),i=8;t===1&&(t=ut(e),i=16);let a=t-i;return a<0?null:{name:r,totalSize:t,headerSize:i,contentSize:a}},sr=e=>nr(e)/65536,Ji=e=>nr(e)/1073741824,es=e=>{let t=0;for(let r=0;r<4;r++){t<<=7;let i=H(e);if(t|=i&127,(i&128)===0)break}return t},kt=e=>{let t=Be(e);return e.skip(2),t=Math.min(t,e.remainingLength),Ce.decode(K(e,t))},Jc=e=>{let t=Vt(e);if(!t||t.name!=="data"||e.remainingLength<8)return null;let r=O(e);e.skip(4);let i=K(e,t.contentSize-8);switch(r){case 1:return Ce.decode(i);case 2:return new TextDecoder("utf-16be").decode(i);case 13:return new Jt(i,"image/jpeg");case 14:return new Jt(i,"image/png");case 27:return new Jt(i,"image/bmp");default:return i}},el=class extends rr{constructor(e){super(e),this.moovSlice=null,this.currentTrack=null,this.tracks=[],this.metadataPromise=null,this.movieTimescale=-1,this.movieDurationInTimescale=-1,this.isQuickTime=!1,this.metadataTags={},this.currentMetadataKeys=null,this.isFragmented=!1,this.fragmentTrackDefaults=[],this.currentFragment=null,this.lastReadFragment=null,this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.tracks.map(e=>e.inputTrack)}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(t=>t.inputTrack.getCodecParameterString()));return Wa({isQuickTime:this.isQuickTime,hasVideo:this.tracks.some(t=>t.info?.type==="video"),hasAudio:this.tracks.some(t=>t.info?.type==="audio"),codecStrings:e.filter(Boolean)})}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,It,ir);if(t instanceof Promise&&(t=await t),!t)break;let r=e,i=Vt(t);if(!i)break;if(i.name==="ftyp"){let s=Ee(t,4);this.isQuickTime=s==="qt  "}else if(i.name==="moov"){let s=this.reader.requestSlice(t.filePos,i.contentSize);if(s instanceof Promise&&(s=await s),!s)break;this.moovSlice=s,this.readContiguousBoxes(this.moovSlice);for(let a of this.tracks){let n=a.editListPreviousSegmentDurations/this.movieTimescale;a.editListOffset-=Math.round(n*a.timescale)}break}e=r+i.totalSize}if(this.isFragmented&&this.reader.fileSize!==null){let t=this.reader.requestSlice(this.reader.fileSize-4,4);t instanceof Promise&&(t=await t),d(t);let r=O(t),i=this.reader.fileSize-r;if(i>=0&&i<=this.reader.fileSize-ir){let s=this.reader.requestSliceRange(i,It,ir);if(s instanceof Promise&&(s=await s),s){let a=Vt(s);if(a&&a.name==="mfra"){let n=this.reader.requestSlice(s.filePos,a.contentSize);n instanceof Promise&&(n=await n),n&&this.readContiguousBoxes(n)}}}}})())}getSampleTableForTrack(e){if(e.sampleTable)return e.sampleTable;let t={sampleTimingEntries:[],sampleCompositionTimeOffsets:[],sampleSizes:[],keySampleIndices:null,chunkOffsets:[],sampleToChunk:[],presentationTimestamps:null,presentationTimestampIndexMap:null};e.sampleTable=t,d(this.moovSlice);let r=this.moovSlice.slice(e.sampleTableByteOffset);if(this.currentTrack=e,this.traverseBox(r),this.currentTrack=null,e.info?.type==="audio"&&e.info.codec&&ve.includes(e.info.codec)&&t.sampleCompositionTimeOffsets.length===0){d(e.info?.type==="audio");let s=wt(e.info.codec),a=[],n=[];for(let o=0;o<t.sampleToChunk.length;o++){let c=t.sampleToChunk[o],l=t.sampleToChunk[o+1],u=(l?l.startChunkIndex:t.chunkOffsets.length)-c.startChunkIndex;for(let h=0;h<u;h++){let f=c.startSampleIndex+h*c.samplesPerChunk,w=f+c.samplesPerChunk,b=ue(t.sampleTimingEntries,f,M=>M.startIndex),p=t.sampleTimingEntries[b],y=ue(t.sampleTimingEntries,w,M=>M.startIndex),k=t.sampleTimingEntries[y],T=p.startDecodeTimestamp+(f-p.startIndex)*p.delta,x=k.startDecodeTimestamp+(w-k.startIndex)*k.delta-T,B=de(a);B&&B.delta===x?B.count++:a.push({startIndex:c.startChunkIndex+h,startDecodeTimestamp:T,count:1,delta:x});let I=c.samplesPerChunk*s.sampleSize*e.info.numberOfChannels;n.push(I)}c.startSampleIndex=c.startChunkIndex,c.samplesPerChunk=1}t.sampleTimingEntries=a,t.sampleSizes=n}if(t.sampleCompositionTimeOffsets.length>0){t.presentationTimestamps=[];for(let s of t.sampleTimingEntries)for(let a=0;a<s.count;a++)t.presentationTimestamps.push({presentationTimestamp:s.startDecodeTimestamp+a*s.delta,sampleIndex:s.startIndex+a});for(let s of t.sampleCompositionTimeOffsets)for(let a=0;a<s.count;a++){let n=s.startIndex+a,o=t.presentationTimestamps[n];o&&(o.presentationTimestamp+=s.offset)}t.presentationTimestamps.sort((s,a)=>s.presentationTimestamp-a.presentationTimestamp),t.presentationTimestampIndexMap=Array(t.presentationTimestamps.length).fill(-1);for(let s=0;s<t.presentationTimestamps.length;s++)t.presentationTimestampIndexMap[t.presentationTimestamps[s].sampleIndex]=s}return t}async readFragment(e){if(this.lastReadFragment?.moofOffset===e)return this.lastReadFragment;let t=this.reader.requestSliceRange(e,It,ir);t instanceof Promise&&(t=await t),d(t);let r=Vt(t);d(r?.name==="moof");let i=this.reader.requestSlice(e,r.totalSize);i instanceof Promise&&(i=await i),d(i),this.traverseBox(i);let s=this.lastReadFragment;d(s&&s.moofOffset===e);for(let[,a]of s.trackData){let n=a.track,{fragmentPositionCache:o}=n;if(!a.startTimestampIsFinal){let l=n.fragmentLookupTable.find(u=>u.moofOffset===s.moofOffset);if(l)ts(a,l.timestamp);else{let u=ue(o,s.moofOffset-1,h=>h.moofOffset);if(u!==-1){let h=o[u];ts(a,h.endTimestamp)}}a.startTimestampIsFinal=!0}let c=ue(o,a.startTimestamp,l=>l.startTimestamp);(c===-1||o[c].moofOffset!==s.moofOffset)&&o.splice(c+1,0,{moofOffset:s.moofOffset,startTimestamp:a.startTimestamp,endTimestamp:a.endTimestamp})}return s}readContiguousBoxes(e){let t=e.filePos;for(;e.filePos-t<=e.length-It&&this.traverseBox(e););}*iterateContiguousBoxes(e){let t=e.filePos;for(;e.filePos-t<=e.length-It;){let r=e.filePos,i=Vt(e);if(!i)break;yield{boxInfo:i,slice:e},e.filePos=r+i.totalSize}}traverseBox(e){var a,n,o,c,l,u,h,f,w,b,p,y,k,T,_,x,B,I,M,V,he,G,W,ee,fe,We,zt,Me,ze,Oe,Rt,vt,Yr;let t=e.filePos,r=Vt(e);if(!r)return!1;let i=e.filePos,s=t+r.totalSize;switch(r.name){case"mdia":case"minf":case"dinf":case"mfra":case"edts":this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"mvhd":{let m=H(e);e.skip(3),m===1?(e.skip(16),this.movieTimescale=O(e),this.movieDurationInTimescale=ut(e)):(e.skip(8),this.movieTimescale=O(e),this.movieDurationInTimescale=O(e))}break;case"trak":{let m={id:-1,demuxer:this,inputTrack:null,info:null,timescale:-1,durationInMovieTimescale:-1,durationInMediaTimescale:-1,rotation:0,internalCodecId:null,name:null,languageCode:je,sampleTableByteOffset:-1,sampleTable:null,fragmentLookupTable:[],currentFragmentState:null,fragmentPositionCache:[],editListPreviousSegmentDurations:0,editListOffset:0};if(this.currentTrack=m,this.readContiguousBoxes(e.slice(i,r.contentSize)),m.id!==-1&&m.timescale!==-1&&m.info!==null){if(m.info.type==="video"&&m.info.width!==-1){let z=m;m.inputTrack=new kr(this.input,new tl(z)),this.tracks.push(m)}else if(m.info.type==="audio"&&m.info.numberOfChannels!==-1){let z=m;m.inputTrack=new ot(this.input,new rl(z)),this.tracks.push(m)}}this.currentTrack=null}break;case"tkhd":{let m=this.currentTrack;if(!m)break;let z=H(e);if(!((Cr(e)&1)!==0))break;if(z===0)e.skip(8),m.id=O(e),e.skip(4),m.durationInMovieTimescale=O(e);else if(z===1)e.skip(16),m.id=O(e),e.skip(4),m.durationInMovieTimescale=ut(e);else throw new Error("Incorrect track header version ".concat(z,"."));e.skip(16);let j=[sr(e),sr(e),Ji(e),sr(e),sr(e),Ji(e),sr(e),sr(e),Ji(e)],D=pt(Oi(nl(j),90));d(D===0||D===90||D===180||D===270),m.rotation=D}break;case"elst":{let m=this.currentTrack;if(!m)break;let z=H(e);e.skip(3);let F=!1,E=0,j=O(e);for(let D=0;D<j;D++){let N=z===1?ut(e):O(e),te=z===1?$l(e):nr(e),Z=sr(e);if(N!==0){if(F){console.warn("Unsupported edit list: multiple edits are not currently supported. Only using first edit.");break}if(te===-1){E+=N;continue}if(Z!==1){console.warn("Unsupported edit list entry: media rate must be 1.");break}m.editListPreviousSegmentDurations=E,m.editListOffset=te,F=!0}}}break;case"mdhd":{let m=this.currentTrack;if(!m)break;let z=H(e);e.skip(3),z===0?(e.skip(8),m.timescale=O(e),m.durationInMediaTimescale=O(e)):z===1&&(e.skip(16),m.timescale=O(e),m.durationInMediaTimescale=ut(e));let F=Be(e);if(F>0){m.languageCode="";for(let E=0;E<3;E++)m.languageCode=String.fromCharCode(96+(F&31))+m.languageCode,F>>=5;Dr(m.languageCode)||(m.languageCode=je)}}break;case"hdlr":{let m=this.currentTrack;if(!m)break;e.skip(8);let z=Ee(e,4);z==="vide"?m.info={type:"video",width:-1,height:-1,codec:null,codecDescription:null,colorSpace:null,avcCodecInfo:null,hevcCodecInfo:null,vp9CodecInfo:null,av1CodecInfo:null}:z==="soun"&&(m.info={type:"audio",numberOfChannels:-1,sampleRate:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case"stbl":{let m=this.currentTrack;if(!m)break;m.sampleTableByteOffset=t,this.readContiguousBoxes(e.slice(i,r.contentSize))}break;case"stsd":{let m=this.currentTrack;if(!m||m.info===null||m.sampleTable)break;let z=H(e);e.skip(3);let F=O(e);for(let E=0;E<F;E++){let j=e.filePos,D=Vt(e);if(!D)break;m.internalCodecId=D.name;let N=D.name.toLowerCase();if(m.info.type==="video")N==="avc1"?m.info.codec="avc":N==="hvc1"||N==="hev1"?m.info.codec="hevc":N==="vp08"?m.info.codec="vp8":N==="vp09"?m.info.codec="vp9":N==="av01"?m.info.codec="av1":console.warn("Unsupported video codec (sample entry type '".concat(D.name,"').")),e.skip(24),m.info.width=Be(e),m.info.height=Be(e),e.skip(50),this.readContiguousBoxes(e.slice(e.filePos,j+D.totalSize-e.filePos));else{N==="mp4a"||(N==="opus"?m.info.codec="opus":N==="flac"?m.info.codec="flac":N==="twos"||N==="sowt"||N==="raw "||N==="in24"||N==="in32"||N==="fl32"||N==="fl64"||N==="lpcm"||N==="ipcm"||N==="fpcm"||(N==="ulaw"?m.info.codec="ulaw":N==="alaw"?m.info.codec="alaw":console.warn("Unsupported audio codec (sample entry type '".concat(D.name,"').")))),e.skip(8);let te=Be(e);e.skip(6);let Z=Be(e),X=Be(e);e.skip(4);let ye=O(e)/65536;if(z===0&&te>0){if(te===1)e.skip(4),X=8*O(e),e.skip(8);else if(te===2){e.skip(4),ye=Ln(e),Z=O(e),e.skip(4),X=O(e);let Te=O(e);if(e.skip(8),N==="lpcm"){let se=X+7>>3,it=!!(Te&1),me=!!(Te&2),ea=Te&4?-1:0;X>0&&X<=64&&(it?X===32&&(m.info.codec=me?"pcm-f32be":"pcm-f32"):ea&1<<se-1?se===1?m.info.codec="pcm-s8":se===2?m.info.codec=me?"pcm-s16be":"pcm-s16":se===3?m.info.codec=me?"pcm-s24be":"pcm-s24":se===4&&(m.info.codec=me?"pcm-s32be":"pcm-s32"):se===1&&(m.info.codec="pcm-u8")),m.info.codec===null&&console.warn("Unsupported PCM format.")}}}m.info.codec==="opus"&&(ye=pr),m.info.numberOfChannels=Z,m.info.sampleRate=ye,N==="twos"?X===8?m.info.codec="pcm-s8":X===16?m.info.codec="pcm-s16be":(console.warn("Unsupported sample size ".concat(X," for codec 'twos'.")),m.info.codec=null):N==="sowt"?X===8?m.info.codec="pcm-s8":X===16?m.info.codec="pcm-s16":(console.warn("Unsupported sample size ".concat(X," for codec 'sowt'.")),m.info.codec=null):N==="raw "?m.info.codec="pcm-u8":N==="in24"?m.info.codec="pcm-s24be":N==="in32"?m.info.codec="pcm-s32be":N==="fl32"?m.info.codec="pcm-f32be":N==="fl64"?m.info.codec="pcm-f64be":N==="ipcm"?m.info.codec="pcm-s16be":N==="fpcm"&&(m.info.codec="pcm-f32be"),this.readContiguousBoxes(e.slice(e.filePos,j+D.totalSize-e.filePos))}}}break;case"avcC":{let m=this.currentTrack;if(!m)break;d(m.info),m.info.codecDescription=K(e,r.contentSize)}break;case"hvcC":{let m=this.currentTrack;if(!m)break;d(m.info),m.info.codecDescription=K(e,r.contentSize)}break;case"vpcC":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="video"),e.skip(4);let z=H(e),F=H(e),E=H(e),j=E>>4,D=E>>1&7,N=E&1,te=H(e),Z=H(e),X=H(e);m.info.vp9CodecInfo={profile:z,level:F,bitDepth:j,chromaSubsampling:D,videoFullRangeFlag:N,colourPrimaries:te,transferCharacteristics:Z,matrixCoefficients:X}}break;case"av1C":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="video"),e.skip(1);let z=H(e),F=z>>5,E=z&31,j=H(e),D=j>>7,N=j>>6&1,te=j>>5&1,Z=j>>4&1,X=j>>3&1,ye=j>>2&1,Te=j&3,se=F===2&&N?te?12:10:N?10:8;m.info.av1CodecInfo={profile:F,level:E,tier:D,bitDepth:se,monochrome:Z,chromaSubsamplingX:X,chromaSubsamplingY:ye,chromaSamplePosition:Te}}break;case"colr":{let m=this.currentTrack;if(!m||(d(m.info?.type==="video"),Ee(e,4)!=="nclx"))break;let F=Be(e),E=Be(e),j=Be(e),D=!!(H(e)&128);m.info.colorSpace={primaries:zr[F],transfer:ri[E],matrix:Zt[j],fullRange:D}}break;case"wave":this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"esds":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(4);let z=H(e);d(z===3),es(e),e.skip(2);let F=H(e),E=(F&128)!==0,j=(F&64)!==0,D=(F&32)!==0;if(E&&e.skip(2),j){let ye=H(e);e.skip(ye)}D&&e.skip(2);let N=H(e);d(N===4);let te=es(e),Z=e.filePos,X=H(e);if(X===64||X===103?(m.info.codec="aac",m.info.aacCodecInfo={isMpeg2:X===103}):X===105||X===107?m.info.codec="mp3":X===221?m.info.codec="vorbis":console.warn("Unsupported audio codec (objectTypeIndication ".concat(X,") - discarding track.")),e.skip(12),te>e.filePos-Z){let ye=H(e);d(ye===5);let Te=es(e);if(m.info.codecDescription=K(e,Te),m.info.codec==="aac"){let se=Hi(m.info.codecDescription);se.numberOfChannels!==null&&(m.info.numberOfChannels=se.numberOfChannels),se.sampleRate!==null&&(m.info.sampleRate=se.sampleRate)}}}break;case"enda":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),Be(e)&255&&(m.info.codec==="pcm-s16be"?m.info.codec="pcm-s16":m.info.codec==="pcm-s24be"?m.info.codec="pcm-s24":m.info.codec==="pcm-s32be"?m.info.codec="pcm-s32":m.info.codec==="pcm-f32be"?m.info.codec="pcm-f32":m.info.codec==="pcm-f64be"&&(m.info.codec="pcm-f64"))}break;case"pcmC":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(4);let F=!!(H(e)&1),E=H(e);m.info.codec==="pcm-s16be"?F?E===16?m.info.codec="pcm-s16":E===24?m.info.codec="pcm-s24":E===32?m.info.codec="pcm-s32":(console.warn("Invalid ipcm sample size ".concat(E,".")),m.info.codec=null):E===16?m.info.codec="pcm-s16be":E===24?m.info.codec="pcm-s24be":E===32?m.info.codec="pcm-s32be":(console.warn("Invalid ipcm sample size ".concat(E,".")),m.info.codec=null):m.info.codec==="pcm-f32be"&&(F?E===32?m.info.codec="pcm-f32":E===64?m.info.codec="pcm-f64":(console.warn("Invalid fpcm sample size ".concat(E,".")),m.info.codec=null):E===32?m.info.codec="pcm-f32be":E===64?m.info.codec="pcm-f64be":(console.warn("Invalid fpcm sample size ".concat(E,".")),m.info.codec=null));break}case"dOps":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(1);let z=H(e),F=Be(e),E=O(e),j=Ss(e),D=H(e),N;D!==0?N=K(e,2+z):N=new Uint8Array(0);let te=new Uint8Array(19+N.byteLength),Z=new DataView(te.buffer);Z.setUint32(0,1332770163,!1),Z.setUint32(4,1214603620,!1),Z.setUint8(8,1),Z.setUint8(9,z),Z.setUint16(10,F,!0),Z.setUint32(12,E,!0),Z.setInt16(16,j,!0),Z.setUint8(18,D),te.set(N,19),m.info.codecDescription=te,m.info.numberOfChannels=z}break;case"dfLa":{let m=this.currentTrack;if(!m)break;d(m.info?.type==="audio"),e.skip(4);let z=127,F=128,E=e.filePos;for(;e.filePos<s;){let Z=H(e),X=Cr(e);if((Z&z)===0){e.skip(10);let Te=O(e),se=Te>>>12,it=(Te>>9&7)+1;m.info.sampleRate=se,m.info.numberOfChannels=it,e.skip(20)}else e.skip(X);if(Z&F)break}let j=e.filePos;e.filePos=E;let D=K(e,j-E),N=new Uint8Array(4+D.byteLength);new DataView(N.buffer).setUint32(0,1716281667,!1),N.set(D,4),m.info.codecDescription=N}break;case"stts":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let z=O(e),F=0,E=0;for(let j=0;j<z;j++){let D=O(e),N=O(e);m.sampleTable.sampleTimingEntries.push({startIndex:F,startDecodeTimestamp:E,count:D,delta:N}),F+=D,E+=D*N}}break;case"ctts":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let z=O(e),F=0;for(let E=0;E<z;E++){let j=O(e),D=nr(e);m.sampleTable.sampleCompositionTimeOffsets.push({startIndex:F,count:j,offset:D}),F+=j}}break;case"stsz":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let z=O(e),F=O(e);if(z===0)for(let E=0;E<F;E++){let j=O(e);m.sampleTable.sampleSizes.push(j)}else m.sampleTable.sampleSizes.push(z)}break;case"stz2":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4),e.skip(3);let z=H(e),F=O(e),E=K(e,Math.ceil(F*z/8)),j=new ce(E);for(let D=0;D<F;D++){let N=j.readBits(z);m.sampleTable.sampleSizes.push(N)}}break;case"stss":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4),m.sampleTable.keySampleIndices=[];let z=O(e);for(let F=0;F<z;F++){let E=O(e)-1;m.sampleTable.keySampleIndices.push(E)}m.sampleTable.keySampleIndices[0]!==0&&m.sampleTable.keySampleIndices.unshift(0)}break;case"stsc":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let z=O(e);for(let E=0;E<z;E++){let j=O(e)-1,D=O(e),N=O(e);m.sampleTable.sampleToChunk.push({startSampleIndex:-1,startChunkIndex:j,samplesPerChunk:D,sampleDescriptionIndex:N})}let F=0;for(let E=0;E<m.sampleTable.sampleToChunk.length;E++)if(m.sampleTable.sampleToChunk[E].startSampleIndex=F,E<m.sampleTable.sampleToChunk.length-1){let D=m.sampleTable.sampleToChunk[E+1].startChunkIndex-m.sampleTable.sampleToChunk[E].startChunkIndex;F+=D*m.sampleTable.sampleToChunk[E].samplesPerChunk}}break;case"stco":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let z=O(e);for(let F=0;F<z;F++){let E=O(e);m.sampleTable.chunkOffsets.push(E)}}break;case"co64":{let m=this.currentTrack;if(!m||!m.sampleTable)break;e.skip(4);let z=O(e);for(let F=0;F<z;F++){let E=ut(e);m.sampleTable.chunkOffsets.push(E)}}break;case"mvex":this.isFragmented=!0,this.readContiguousBoxes(e.slice(i,r.contentSize));break;case"mehd":{let m=H(e);e.skip(3);let z=m===1?ut(e):O(e);this.movieDurationInTimescale=z}break;case"trex":{e.skip(4);let m=O(e),z=O(e),F=O(e),E=O(e),j=O(e);this.fragmentTrackDefaults.push({trackId:m,defaultSampleDescriptionIndex:z,defaultSampleDuration:F,defaultSampleSize:E,defaultSampleFlags:j})}break;case"tfra":{let m=H(e);e.skip(3);let z=O(e),F=this.tracks.find(se=>se.id===z);if(!F)break;let E=O(e),j=(E&48)>>4,D=(E&12)>>2,N=E&3,te=[H,Be,Cr,O],Z=te[j],X=te[D],ye=te[N],Te=O(e);for(let se=0;se<Te;se++){let it=m===1?ut(e):O(e),me=m===1?ut(e):O(e);Z(e),X(e),ye(e),F.fragmentLookupTable.push({timestamp:it,moofOffset:me})}F.fragmentLookupTable.sort((se,it)=>se.timestamp-it.timestamp);for(let se=0;se<F.fragmentLookupTable.length-1;se++){let it=F.fragmentLookupTable[se],me=F.fragmentLookupTable[se+1];it.timestamp===me.timestamp&&(F.fragmentLookupTable.splice(se+1,1),se--)}}break;case"moof":this.currentFragment={moofOffset:t,moofSize:r.totalSize,implicitBaseDataOffset:t,trackData:new Map},this.readContiguousBoxes(e.slice(i,r.contentSize)),this.lastReadFragment=this.currentFragment,this.currentFragment=null;break;case"traf":if(d(this.currentFragment),this.readContiguousBoxes(e.slice(i,r.contentSize)),this.currentTrack){let m=this.currentFragment.trackData.get(this.currentTrack.id);if(m){let{currentFragmentState:z}=this.currentTrack;d(z),z.startTimestamp!==null&&(ts(m,z.startTimestamp),m.startTimestampIsFinal=!0)}this.currentTrack.currentFragmentState=null,this.currentTrack=null}break;case"tfhd":{d(this.currentFragment),e.skip(1);let m=Cr(e),z=!!(m&1),F=!!(m&2),E=!!(m&8),j=!!(m&16),D=!!(m&32),N=!!(m&65536),te=!!(m&131072),Z=O(e),X=this.tracks.find(Te=>Te.id===Z);if(!X)break;let ye=this.fragmentTrackDefaults.find(Te=>Te.trackId===Z);this.currentTrack=X,X.currentFragmentState={baseDataOffset:this.currentFragment.implicitBaseDataOffset,sampleDescriptionIndex:ye?.defaultSampleDescriptionIndex??null,defaultSampleDuration:ye?.defaultSampleDuration??null,defaultSampleSize:ye?.defaultSampleSize??null,defaultSampleFlags:ye?.defaultSampleFlags??null,startTimestamp:null},z?X.currentFragmentState.baseDataOffset=ut(e):te&&(X.currentFragmentState.baseDataOffset=this.currentFragment.moofOffset),F&&(X.currentFragmentState.sampleDescriptionIndex=O(e)),E&&(X.currentFragmentState.defaultSampleDuration=O(e)),j&&(X.currentFragmentState.defaultSampleSize=O(e)),D&&(X.currentFragmentState.defaultSampleFlags=O(e)),N&&(X.currentFragmentState.defaultSampleDuration=0)}break;case"tfdt":{let m=this.currentTrack;if(!m)break;d(m.currentFragmentState);let z=H(e);e.skip(3);let F=z===0?O(e):ut(e);m.currentFragmentState.startTimestamp=F}break;case"trun":{let m=this.currentTrack;if(!m)break;if(d(this.currentFragment),d(m.currentFragmentState),this.currentFragment.trackData.has(m.id)){console.warn("Can't have two trun boxes for the same track in one fragment. Ignoring...");break}let z=H(e),F=Cr(e),E=!!(F&1),j=!!(F&4),D=!!(F&256),N=!!(F&512),te=!!(F&1024),Z=!!(F&2048),X=O(e),ye=m.currentFragmentState.baseDataOffset;E&&(ye+=nr(e));let Te=null;j&&(Te=O(e));let se=ye;if(X===0){this.currentFragment.implicitBaseDataOffset=se;break}let it=0,me={track:m,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,samples:[],presentationTimestamps:[],startTimestampIsFinal:!1};this.currentFragment.trackData.set(m.id,me);for(let Ke=0;Ke<X;Ke++){let ht;D?ht=O(e):(d(m.currentFragmentState.defaultSampleDuration!==null),ht=m.currentFragmentState.defaultSampleDuration);let Kt;N?Kt=O(e):(d(m.currentFragmentState.defaultSampleSize!==null),Kt=m.currentFragmentState.defaultSampleSize);let Ar;te?Ar=O(e):(d(m.currentFragmentState.defaultSampleFlags!==null),Ar=m.currentFragmentState.defaultSampleFlags),Ke===0&&Te!==null&&(Ar=Te);let ta=0;Z&&(z===0?ta=O(e):ta=nr(e));let Yd=!(Ar&65536);me.samples.push({presentationTimestamp:it+ta,duration:ht,byteOffset:se,byteSize:Kt,isKeyFrame:Yd}),se+=Kt,it+=ht}me.presentationTimestamps=me.samples.map((Ke,ht)=>({presentationTimestamp:Ke.presentationTimestamp,sampleIndex:ht})).sort((Ke,ht)=>Ke.presentationTimestamp-ht.presentationTimestamp);for(let Ke=0;Ke<me.presentationTimestamps.length;Ke++){let ht=me.presentationTimestamps[Ke],Kt=me.samples[ht.sampleIndex];if(me.firstKeyFrameTimestamp===null&&Kt.isKeyFrame&&(me.firstKeyFrameTimestamp=Kt.presentationTimestamp),Ke<me.presentationTimestamps.length-1){let Ar=me.presentationTimestamps[Ke+1];Kt.duration=Ar.presentationTimestamp-ht.presentationTimestamp}}let ea=me.samples[me.presentationTimestamps[0].sampleIndex],vo=me.samples[de(me.presentationTimestamps).sampleIndex];me.startTimestamp=ea.presentationTimestamp,me.endTimestamp=vo.presentationTimestamp+vo.duration,this.currentFragment.implicitBaseDataOffset=se}break;case"udta":{let m=this.iterateContiguousBoxes(e.slice(i,r.contentSize));for(let{boxInfo:z,slice:F}of m){if(z.name!=="meta"&&!this.currentTrack){let E=F.filePos;(a=this.metadataTags).raw??(a.raw={}),z.name[0]==="\xA9"?(n=this.metadataTags.raw)[o=z.name]??(n[o]=kt(F)):(c=this.metadataTags.raw)[l=z.name]??(c[l]=K(F,z.contentSize)),F.filePos=E}switch(z.name){case"meta":F.skip(-z.headerSize),this.traverseBox(F);break;case"\xA9nam":case"name":this.currentTrack?this.currentTrack.name=Ce.decode(K(F,z.contentSize)):(u=this.metadataTags).title??(u.title=kt(F));break;case"\xA9des":this.currentTrack||((h=this.metadataTags).description??(h.description=kt(F)));break;case"\xA9ART":this.currentTrack||((f=this.metadataTags).artist??(f.artist=kt(F)));break;case"\xA9alb":this.currentTrack||((w=this.metadataTags).album??(w.album=kt(F)));break;case"albr":this.currentTrack||((b=this.metadataTags).albumArtist??(b.albumArtist=kt(F)));break;case"\xA9gen":this.currentTrack||((p=this.metadataTags).genre??(p.genre=kt(F)));break;case"\xA9day":if(!this.currentTrack){let E=new Date(kt(F));Number.isNaN(E.getTime())||((y=this.metadataTags).date??(y.date=E))}break;case"\xA9cmt":this.currentTrack||((k=this.metadataTags).comment??(k.comment=kt(F)));break;case"\xA9lyr":this.currentTrack||((T=this.metadataTags).lyrics??(T.lyrics=kt(F)));break}}}break;case"meta":{if(this.currentTrack)break;let z=O(e)!==0;this.currentMetadataKeys=new Map,z?this.readContiguousBoxes(e.slice(i,r.contentSize)):this.readContiguousBoxes(e.slice(i+4,r.contentSize-4)),this.currentMetadataKeys=null}break;case"keys":{if(!this.currentMetadataKeys)break;e.skip(4);let m=O(e);for(let z=0;z<m;z++){let F=O(e);e.skip(4);let E=Ce.decode(K(e,F-8));this.currentMetadataKeys.set(z+1,E)}}break;case"ilst":{if(!this.currentMetadataKeys)break;let m=this.iterateContiguousBoxes(e.slice(i,r.contentSize));for(let{boxInfo:z,slice:F}of m){let E=z.name,j=(E.charCodeAt(0)<<24)+(E.charCodeAt(1)<<16)+(E.charCodeAt(2)<<8)+E.charCodeAt(3);this.currentMetadataKeys.has(j)&&(E=this.currentMetadataKeys.get(j));let D=Jc(F);switch((_=this.metadataTags).raw??(_.raw={}),(x=this.metadataTags.raw)[E]??(x[E]=D),E){case"\xA9nam":case"titl":case"com.apple.quicktime.title":case"title":typeof D=="string"&&((B=this.metadataTags).title??(B.title=D));break;case"\xA9des":case"desc":case"dscp":case"com.apple.quicktime.description":case"description":typeof D=="string"&&((I=this.metadataTags).description??(I.description=D));break;case"\xA9ART":case"com.apple.quicktime.artist":case"artist":typeof D=="string"&&((M=this.metadataTags).artist??(M.artist=D));break;case"\xA9alb":case"albm":case"com.apple.quicktime.album":case"album":typeof D=="string"&&((V=this.metadataTags).album??(V.album=D));break;case"aART":case"album_artist":typeof D=="string"&&((he=this.metadataTags).albumArtist??(he.albumArtist=D));break;case"\xA9cmt":case"com.apple.quicktime.comment":case"comment":typeof D=="string"&&((G=this.metadataTags).comment??(G.comment=D));break;case"\xA9gen":case"gnre":case"com.apple.quicktime.genre":case"genre":typeof D=="string"&&((W=this.metadataTags).genre??(W.genre=D));break;case"\xA9lyr":case"lyrics":typeof D=="string"&&((ee=this.metadataTags).lyrics??(ee.lyrics=D));break;case"\xA9day":case"rldt":case"com.apple.quicktime.creationdate":case"date":if(typeof D=="string"){let N=new Date(D);Number.isNaN(N.getTime())||((fe=this.metadataTags).date??(fe.date=N))}break;case"covr":case"com.apple.quicktime.artwork":D instanceof Jt?((We=this.metadataTags).images??(We.images=[]),this.metadataTags.images.push({data:D.data,kind:"coverFront",mimeType:D.mimeType})):D instanceof Uint8Array&&((zt=this.metadataTags).images??(zt.images=[]),this.metadataTags.images.push({data:D,kind:"coverFront",mimeType:"image/*"}));break;case"track":if(typeof D=="string"){let N=D.split("/"),te=Number.parseInt(N[0],10),Z=N[1]&&Number.parseInt(N[1],10);Number.isInteger(te)&&te>0&&((Me=this.metadataTags).trackNumber??(Me.trackNumber=te)),Z&&Number.isInteger(Z)&&Z>0&&((ze=this.metadataTags).tracksTotal??(ze.tracksTotal=Z))}break;case"trkn":if(D instanceof Uint8Array&&D.length>=6){let N=le(D),te=N.getUint16(2,!1),Z=N.getUint16(4,!1);te>0&&((Oe=this.metadataTags).trackNumber??(Oe.trackNumber=te)),Z>0&&((Rt=this.metadataTags).tracksTotal??(Rt.tracksTotal=Z))}break;case"disc":case"disk":if(D instanceof Uint8Array&&D.length>=6){let N=le(D),te=N.getUint16(2,!1),Z=N.getUint16(4,!1);te>0&&((vt=this.metadataTags).discNumber??(vt.discNumber=te)),Z>0&&((Yr=this.metadataTags).discsTotal??(Yr.discsTotal=Z))}break}}}break}return e.filePos=s,!0}},Ha=class{constructor(e){this.internalTrack=e,this.packetToSampleIndex=new WeakMap,this.packetToFragmentLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.internalCodecId}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}getTimeResolution(){return this.internalTrack.timescale}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}async getFirstPacket(e){let t=await this.fetchPacketForSampleIndex(0,e);return t||!this.internalTrack.demuxer.isFragmented?t:this.performFragmentedLookup(null,r=>r.trackData.get(this.internalTrack.id)?{sampleIndex:0,correctSampleFound:!0}:{sampleIndex:-1,correctSampleFound:!1},-1/0,1/0,e)}mapTimestampIntoTimescale(e){return ni(e*this.internalTrack.timescale,14)+this.internalTrack.editListOffset}async getPacket(e,t){let r=this.mapTimestampIntoTimescale(e),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=qa(i,r),a=await this.fetchPacketForSampleIndex(s,t);return!$a(i)||!this.internalTrack.demuxer.isFragmented?a:this.performFragmentedLookup(null,n=>{let o=n.trackData.get(this.internalTrack.id);if(!o)return{sampleIndex:-1,correctSampleFound:!1};let c=ue(o.presentationTimestamps,r,h=>h.presentationTimestamp),l=c!==-1?o.presentationTimestamps[c].sampleIndex:-1,u=c!==-1&&r<o.endTimestamp;return{sampleIndex:l,correctSampleFound:u}},r,r,t)}async getNextPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0)return this.fetchPacketForSampleIndex(r+1,t);let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(i.fragment,s=>{if(s===i.fragment){let a=s.trackData.get(this.internalTrack.id);if(i.sampleIndex+1<a.samples.length)return{sampleIndex:i.sampleIndex+1,correctSampleFound:!0}}else if(s.trackData.get(this.internalTrack.id))return{sampleIndex:0,correctSampleFound:!0};return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.mapTimestampIntoTimescale(e),i=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),s=qa(i,r),a=s===-1?-1:sl(i,s),n=await this.fetchPacketForSampleIndex(a,t);return!$a(i)||!this.internalTrack.demuxer.isFragmented?n:this.performFragmentedLookup(null,o=>{let c=o.trackData.get(this.internalTrack.id);if(!c)return{sampleIndex:-1,correctSampleFound:!1};let l=oa(c.presentationTimestamps,f=>c.samples[f.sampleIndex].isKeyFrame&&f.presentationTimestamp<=r),u=l!==-1?c.presentationTimestamps[l].sampleIndex:-1,h=l!==-1&&r<c.endTimestamp;return{sampleIndex:u,correctSampleFound:h}},r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToSampleIndex.get(e);if(r!==void 0){let s=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),a=al(s,r);return this.fetchPacketForSampleIndex(a,t)}let i=this.packetToFragmentLocation.get(e);if(i===void 0)throw new Error("Packet was not created from this track.");return this.performFragmentedLookup(i.fragment,s=>{if(s===i.fragment){let n=s.trackData.get(this.internalTrack.id).samples.findIndex((o,c)=>o.isKeyFrame&&c>i.sampleIndex);if(n!==-1)return{sampleIndex:n,correctSampleFound:!0}}else{let a=s.trackData.get(this.internalTrack.id);if(a&&a.firstKeyFrameTimestamp!==null){let n=a.samples.findIndex(o=>o.isKeyFrame);return d(n!==-1),{sampleIndex:n,correctSampleFound:!0}}}return{sampleIndex:-1,correctSampleFound:!1}},-1/0,1/0,t)}async fetchPacketForSampleIndex(e,t){if(e===-1)return null;let r=this.internalTrack.demuxer.getSampleTableForTrack(this.internalTrack),i=il(r,e);if(!i)return null;let s;if(t.metadataOnly)s=tt;else{let c=this.internalTrack.demuxer.reader.requestSlice(i.sampleOffset,i.sampleSize);c instanceof Promise&&(c=await c),d(c),s=K(c,i.sampleSize)}let a=(i.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,n=i.duration/this.internalTrack.timescale,o=new we(s,i.isKeyFrame?"key":"delta",a,n,e,i.sampleSize);return this.packetToSampleIndex.set(o,e),o}async fetchPacketInFragment(e,t,r){if(t===-1)return null;let s=e.trackData.get(this.internalTrack.id).samples[t];d(s);let a;if(r.metadataOnly)a=tt;else{let l=this.internalTrack.demuxer.reader.requestSlice(s.byteOffset,s.byteSize);l instanceof Promise&&(l=await l),d(l),a=K(l,s.byteSize)}let n=(s.presentationTimestamp-this.internalTrack.editListOffset)/this.internalTrack.timescale,o=s.duration/this.internalTrack.timescale,c=new we(a,s.isKeyFrame?"key":"delta",n,o,e.moofOffset+t,s.byteSize);return this.packetToFragmentLocation.set(c,{fragment:e,sampleIndex:t}),c}async performFragmentedLookup(e,t,r,i,s){let a=this.internalTrack.demuxer,n=null,o=null,c=-1;if(e){let{sampleIndex:p,correctSampleFound:y}=t(e);if(y)return this.fetchPacketInFragment(e,p,s);p!==-1&&(o=e,c=p)}let l=ue(this.internalTrack.fragmentLookupTable,r,p=>p.timestamp),u=l!==-1?this.internalTrack.fragmentLookupTable[l]:null,h=ue(this.internalTrack.fragmentPositionCache,r,p=>p.startTimestamp),f=h!==-1?this.internalTrack.fragmentPositionCache[h]:null,w=Math.max(u?.moofOffset??0,f?.moofOffset??0)||null,b;for(e?w===null||e.moofOffset>=w?(b=e.moofOffset+e.moofSize,n=e):b=w:b=w??0;;){if(n){let T=n.trackData.get(this.internalTrack.id);if(T&&T.startTimestamp>i)break}let p=a.reader.requestSliceRange(b,It,ir);if(p instanceof Promise&&(p=await p),!p)break;let y=b,k=Vt(p);if(!k)break;if(k.name==="moof"){n=await a.readFragment(y);let{sampleIndex:T,correctSampleFound:_}=t(n);if(_)return this.fetchPacketInFragment(n,T,s);T!==-1&&(o=n,c=T)}b=y+k.totalSize}if(u&&(!o||o.moofOffset<u.moofOffset)){let p=this.internalTrack.fragmentLookupTable[l-1];d(!p||p.timestamp<u.timestamp);let y=p?.timestamp??-1/0;return this.performFragmentedLookup(null,t,y,i,s)}return o?this.fetchPacketInFragment(o,c,s):null}},tl=class extends Ha{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return!1}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??(this.decoderConfigPromise=(async()=>{if(this.internalTrack.info.codec==="vp9"&&!this.internalTrack.info.vp9CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.vp9CodecInfo=e&&Ba(e.data)}else if(this.internalTrack.info.codec==="av1"&&!this.internalTrack.info.av1CodecInfo){let e=await this.getFirstPacket({});this.internalTrack.info.av1CodecInfo=e&&Ma(e.data)}return{codec:ka(this.internalTrack.info),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})()):null}},rl=class extends Ha{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??(this.decoderConfig={codec:ya(this.internalTrack.info),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}):null}},qa=(e,t)=>{if(e.presentationTimestamps){let r=ue(e.presentationTimestamps,t,i=>i.presentationTimestamp);return r===-1?-1:e.presentationTimestamps[r].sampleIndex}else{let r=ue(e.sampleTimingEntries,t,s=>s.startDecodeTimestamp);if(r===-1)return-1;let i=e.sampleTimingEntries[r];return i.startIndex+Math.min(Math.floor((t-i.startDecodeTimestamp)/i.delta),i.count-1)}},il=(e,t)=>{let r=ue(e.sampleTimingEntries,t,k=>k.startIndex),i=e.sampleTimingEntries[r];if(!i||i.startIndex+i.count<=t)return null;let a=i.startDecodeTimestamp+(t-i.startIndex)*i.delta,n=ue(e.sampleCompositionTimeOffsets,t,k=>k.startIndex),o=e.sampleCompositionTimeOffsets[n];o&&t-o.startIndex<o.count&&(a+=o.offset);let c=e.sampleSizes[Math.min(t,e.sampleSizes.length-1)],l=ue(e.sampleToChunk,t,k=>k.startSampleIndex),u=e.sampleToChunk[l];d(u);let h=u.startChunkIndex+Math.floor((t-u.startSampleIndex)/u.samplesPerChunk),f=e.chunkOffsets[h],w=u.startSampleIndex+(h-u.startChunkIndex)*u.samplesPerChunk,b=0,p=f;if(e.sampleSizes.length===1)p+=c*(t-w),b+=c*u.samplesPerChunk;else for(let k=w;k<w+u.samplesPerChunk;k++){let T=e.sampleSizes[k];k<t&&(p+=T),b+=T}let y=i.delta;if(e.presentationTimestamps){let k=e.presentationTimestampIndexMap[t];d(k!==void 0),k<e.presentationTimestamps.length-1&&(y=e.presentationTimestamps[k+1].presentationTimestamp-a)}return{presentationTimestamp:a,duration:y,sampleOffset:p,sampleSize:c,chunkOffset:f,chunkSize:b,isKeyFrame:e.keySampleIndices?Di(e.keySampleIndices,t,k=>k)!==-1:!0}},sl=(e,t)=>{if(!e.keySampleIndices)return t;let r=ue(e.keySampleIndices,t,i=>i);return e.keySampleIndices[r]??-1},al=(e,t)=>{if(!e.keySampleIndices)return t+1;let r=ue(e.keySampleIndices,t,i=>i);return e.keySampleIndices[r+1]??-1},ts=(e,t)=>{e.startTimestamp+=t,e.endTimestamp+=t;for(let r of e.samples)r.presentationTimestamp+=t;for(let r of e.presentationTimestamps)r.presentationTimestamp+=t},nl=e=>{let[t,,,r]=e,i=Math.hypot(t,r),s=t/i,a=r/i,n=-Math.atan2(a,s)*(180/Math.PI);return Number.isFinite(n)?n:0},$a=e=>e.sampleSizes.length===0,rs=class{constructor(e){this.value=e}},is=class{constructor(e){this.value=e}},ja=class{constructor(e){this.value=e}},Wt=class{constructor(e){this.value=e}},ol=[440786851,408125543],qr=[290298740,357149030,524531317,374648427,475249515,423732329,272869232,307544935],ki=[...ol,...qr],Qa=e=>e<256?1:e<65536?2:e<1<<24?3:e<2**32?4:e<2**40?5:6,Ka=e=>e<1n<<8n?1:e<1n<<16n?2:e<1n<<24n?3:e<1n<<32n?4:e<1n<<40n?5:e<1n<<48n?6:e<1n<<56n?7:8,Ga=e=>e>=-64&&e<64?1:e>=-8192&&e<8192?2:e>=-(1<<20)&&e<1<<20?3:e>=-(1<<27)&&e<1<<27?4:e>=-(2**34)&&e<2**34?5:6,cl=e=>{if(e<127)return 1;if(e<16383)return 2;if(e<(1<<21)-1)return 3;if(e<(1<<28)-1)return 4;if(e<2**35-1)return 5;if(e<2**42-1)return 6;throw new Error("EBML varint size not supported "+e)},ll=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap,this.dataOffsets=new WeakMap}writeByte(e){this.helperView.setUint8(0,e),this.writer.write(this.helper.subarray(0,1))}writeFloat32(e){this.helperView.setFloat32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeFloat64(e){this.helperView.setFloat64(0,e,!1),this.writer.write(this.helper)}writeUnsignedInt(e,t=Qa(e)){let r=0;switch(t){case 6:this.helperView.setUint8(r++,e/2**40|0);case 5:this.helperView.setUint8(r++,e/2**32|0);case 4:this.helperView.setUint8(r++,e>>24);case 3:this.helperView.setUint8(r++,e>>16);case 2:this.helperView.setUint8(r++,e>>8);case 1:this.helperView.setUint8(r++,e);break;default:throw new Error("Bad unsigned int size "+t)}this.writer.write(this.helper.subarray(0,r))}writeUnsignedBigInt(e,t=Ka(e)){let r=0;for(let i=t-1;i>=0;i--)this.helperView.setUint8(r++,Number(e>>BigInt(i*8)&0xffn));this.writer.write(this.helper.subarray(0,r))}writeSignedInt(e,t=Ga(e)){e<0&&(e+=2**(t*8)),this.writeUnsignedInt(e,t)}writeVarInt(e,t=cl(e)){let r=0;switch(t){case 1:this.helperView.setUint8(r++,128|e);break;case 2:this.helperView.setUint8(r++,64|e>>8),this.helperView.setUint8(r++,e);break;case 3:this.helperView.setUint8(r++,32|e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 4:this.helperView.setUint8(r++,16|e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 5:this.helperView.setUint8(r++,8|e/2**32&7),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;case 6:this.helperView.setUint8(r++,4|e/2**40&3),this.helperView.setUint8(r++,e/2**32|0),this.helperView.setUint8(r++,e>>24),this.helperView.setUint8(r++,e>>16),this.helperView.setUint8(r++,e>>8),this.helperView.setUint8(r++,e);break;default:throw new Error("Bad EBML varint size "+t)}this.writer.write(this.helper.subarray(0,r))}writeAsciiString(e){this.writer.write(new Uint8Array(e.split("").map(t=>t.charCodeAt(0))))}writeEBML(e){if(e!==null)if(e instanceof Uint8Array)this.writer.write(e);else if(Array.isArray(e))for(let t of e)this.writeEBML(t);else if(this.offsets.set(e,this.writer.getPos()),this.writeUnsignedInt(e.id),Array.isArray(e.data)){let t=this.writer.getPos(),r=e.size===-1?1:e.size??4;e.size===-1?this.writeByte(255):this.writer.seek(this.writer.getPos()+r);let i=this.writer.getPos();if(this.dataOffsets.set(e,i),this.writeEBML(e.data),e.size!==-1){let s=this.writer.getPos()-i,a=this.writer.getPos();this.writer.seek(t),this.writeVarInt(s,r),this.writer.seek(a)}}else if(typeof e.data=="number"){let t=e.size??Qa(e.data);this.writeVarInt(t),this.writeUnsignedInt(e.data,t)}else if(typeof e.data=="bigint"){let t=e.size??Ka(e.data);this.writeVarInt(t),this.writeUnsignedBigInt(e.data,t)}else if(typeof e.data=="string")this.writeVarInt(e.data.length),this.writeAsciiString(e.data);else if(e.data instanceof Uint8Array)this.writeVarInt(e.data.byteLength,e.size),this.writer.write(e.data);else if(e.data instanceof rs)this.writeVarInt(4),this.writeFloat32(e.data.value);else if(e.data instanceof is)this.writeVarInt(8),this.writeFloat64(e.data.value);else if(e.data instanceof ja){let t=e.size??Ga(e.data.value);this.writeVarInt(t),this.writeSignedInt(e.data.value,t)}else if(e.data instanceof Wt){let t=J.encode(e.data.value);this.writeVarInt(t.length),this.writer.write(t)}else Re(e.data)}},ss=8,ct=2,Et=2*ss,Xa=e=>{let t=H(e);if(e.skip(-1),t===0)return null;let r=1,i=128;for(;(t&i)===0;)r++,i>>=1;return r},$r=e=>{let t=H(e);if(t===0)return null;let r=1,i=128;for(;(t&i)===0;)r++,i>>=1;let s=t&i-1;for(let a=1;a<r;a++)s*=256,s+=H(e);return s},ae=(e,t)=>{if(t<1||t>8)throw new Error("Bad unsigned int size "+t);let r=0;for(let i=0;i<t;i++)r*=256,r+=H(e);return r},ul=(e,t)=>{if(t<1)throw new Error("Bad unsigned int size "+t);let r=0n;for(let i=0;i<t;i++)r<<=8n,r+=BigInt(H(e));return r},dl=(e,t)=>{let r=ae(e,t);return r&1<<t*8-1&&(r-=2**(t*8)),r},as=e=>{let t=Xa(e);return t===null?null:ae(e,t)},Ya=e=>{let t=H(e);return t===255?t=null:(e.skip(-1),t=$r(e),t===72057594037927940&&(t=null)),t},At=e=>{let t=as(e);if(t===null)return null;let r=Ya(e);return{id:t,size:r}},yr=(e,t)=>{let r=K(e,t),i=0;for(;i<t&&r[i]!==0;)i+=1;return String.fromCharCode(...r.subarray(0,i))},jr=(e,t)=>{let r=K(e,t),i=0;for(;i<t&&r[i]!==0;)i+=1;return Ce.decode(r.subarray(0,i))},ns=(e,t)=>{if(t===0)return 0;if(t!==4&&t!==8)throw new Error("Bad float size "+t);return t===4?Ql(e):Ln(e)},os=async(e,t,r,i)=>{let s=new Set(r),a=t;for(;i===null||a<i;){let n=e.requestSliceRange(a,ct,Et);if(n instanceof Promise&&(n=await n),!n)break;let o=At(n);if(!o)break;if(s.has(o.id))return{pos:a,found:!0};Ht(o.size),a=n.filePos+o.size}return{pos:i!==null&&i>a?i:a,found:!1}},Za=async(e,t,r,i)=>{let a=new Set(r),n=t;for(;n<i;){let o=e.requestSliceRange(n,0,Math.min(65536,i-n));if(o instanceof Promise&&(o=await o),!o||o.length<ss)break;for(let c=0;c<o.length-ss;c++){o.filePos=n;let l=as(o);if(l!==null&&a.has(l))return n;n++}}return null},lt={avc:"V_MPEG4/ISO/AVC",hevc:"V_MPEGH/ISO/HEVC",vp8:"V_VP8",vp9:"V_VP9",av1:"V_AV1",aac:"A_AAC",mp3:"A_MPEG/L3",opus:"A_OPUS",vorbis:"A_VORBIS",flac:"A_FLAC","pcm-u8":"A_PCM/INT/LIT","pcm-s16":"A_PCM/INT/LIT","pcm-s16be":"A_PCM/INT/BIG","pcm-s24":"A_PCM/INT/LIT","pcm-s24be":"A_PCM/INT/BIG","pcm-s32":"A_PCM/INT/LIT","pcm-s32be":"A_PCM/INT/BIG","pcm-f32":"A_PCM/FLOAT/IEEE","pcm-f64":"A_PCM/FLOAT/IEEE",webvtt:"S_TEXT/WEBVTT"};function Ht(e){if(e===null)throw new Error("Undefined element size is used in a place where it is not supported.")}var Ja=e=>{let r=(e.hasVideo?"video/":e.hasAudio?"audio/":"application/")+(e.isWebM?"webm":"x-matroska");if(e.codecStrings.length>0){let i=[...new Set(e.codecStrings.filter(Boolean))];r+='; codecs="'.concat(i.join(", "),'"')}return r},cs=[{id:290298740,flag:"seekHeadSeen"},{id:357149030,flag:"infoSeen"},{id:374648427,flag:"tracksSeen"},{id:475249515,flag:"cuesSeen"}],en=10*2**20,hl=class extends rr{constructor(e){super(e),this.readMetadataPromise=null,this.segments=[],this.currentSegment=null,this.currentTrack=null,this.currentCluster=null,this.currentBlock=null,this.currentBlockAdditional=null,this.currentCueTime=null,this.currentDecodingInstruction=null,this.currentTagTargetIsMovie=!0,this.currentSimpleTagName=null,this.currentAttachedFile=null,this.isWebM=!1,this.reader=e._reader}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getTracks(){return await this.readMetadata(),this.segments.flatMap(e=>e.tracks.map(t=>t.inputTrack))}async getMimeType(){await this.readMetadata();let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.getCodecParameterString()));return Ja({isWebM:this.isWebM,hasVideo:this.segments.some(r=>r.tracks.some(i=>i.info?.type==="video")),hasAudio:this.segments.some(r=>r.tracks.some(i=>i.info?.type==="audio")),codecStrings:t.filter(Boolean)})}async getMetadataTags(){await this.readMetadata();for(let t of this.segments)t.metadataTagsCollected||(this.reader.fileSize!==null&&await this.loadSegmentMetadata(t),t.metadataTagsCollected=!0);let e={};for(let t of this.segments)e={...e,...t.metadataTags};return e}readMetadata(){return this.readMetadataPromise??(this.readMetadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,ct,Et);if(t instanceof Promise&&(t=await t),!t)break;let r=At(t);if(!r)break;let i=r.id,s=r.size,a=t.filePos;if(i===440786851){Ht(s);let n=this.reader.requestSlice(a,s);if(n instanceof Promise&&(n=await n),!n)break;this.readContiguousElements(n)}else if(i===408125543){if(await this.readSegment(a,s),s===null||this.reader.fileSize===null)break}else if(i===524531317){if(this.reader.fileSize===null)break;s===null&&(s=(await os(this.reader,a,ki,this.reader.fileSize)).pos-a);let n=de(this.segments);n&&(n.elementEndPos=a+s)}Ht(s),e=a+s}})())}async readSegment(e,t){this.currentSegment={seekHeadSeen:!1,infoSeen:!1,tracksSeen:!1,cuesSeen:!1,tagsSeen:!1,attachmentsSeen:!1,timestampScale:-1,timestampFactor:-1,duration:-1,seekEntries:[],tracks:[],cuePoints:[],dataStartPos:e,elementEndPos:t===null?null:e+t,clusterSeekStartPos:e,lastReadCluster:null,metadataTags:{},metadataTagsCollected:!1},this.segments.push(this.currentSegment);let r=e;for(;this.currentSegment.elementEndPos===null||r<this.currentSegment.elementEndPos;){let n=this.reader.requestSliceRange(r,ct,Et);if(n instanceof Promise&&(n=await n),!n)break;let o=r,c=At(n);if(!c||!qr.includes(c.id)&&c.id!==236){let w=await Za(this.reader,o,qr,Math.min(this.currentSegment.elementEndPos??1/0,o+en));if(w){r=w;continue}else break}let{id:l,size:u}=c,h=n.filePos,f=cs.findIndex(w=>w.id===l);if(f!==-1){let w=cs[f].flag;this.currentSegment[w]=!0,Ht(u);let b=this.reader.requestSlice(h,u);b instanceof Promise&&(b=await b),b&&this.readContiguousElements(b)}else if(l===307544935||l===423732329){l===307544935?this.currentSegment.tagsSeen=!0:this.currentSegment.attachmentsSeen=!0,Ht(u);let w=this.reader.requestSlice(h,u);w instanceof Promise&&(w=await w),w&&this.readContiguousElements(w)}else if(l===524531317){this.currentSegment.clusterSeekStartPos=o;break}if(u===null)break;r=h+u}if(this.currentSegment.seekEntries.sort((n,o)=>n.segmentPosition-o.segmentPosition),this.reader.fileSize!==null)for(let n of this.currentSegment.seekEntries){let o=cs.find(w=>w.id===n.id);if(!o||this.currentSegment[o.flag])continue;let c=this.reader.requestSliceRange(e+n.segmentPosition,ct,Et);if(c instanceof Promise&&(c=await c),!c)continue;let l=At(c);if(!l)continue;let{id:u,size:h}=l;if(u!==o.id)continue;Ht(h),this.currentSegment[o.flag]=!0;let f=this.reader.requestSlice(c.filePos,h);f instanceof Promise&&(f=await f),f&&this.readContiguousElements(f)}this.currentSegment.timestampScale===-1&&(this.currentSegment.timestampScale=1e6,this.currentSegment.timestampFactor=1e9/1e6),this.currentSegment.tracks.sort((n,o)=>Number(o.isDefault)-Number(n.isDefault));let i=new Map(this.currentSegment.tracks.map(n=>[n.id,n]));for(let n of this.currentSegment.cuePoints){let o=i.get(n.trackId);o&&o.cuePoints.push(n)}for(let n of this.currentSegment.tracks){n.cuePoints.sort((o,c)=>o.time-c.time);for(let o=0;o<n.cuePoints.length-1;o++){let c=n.cuePoints[o],l=n.cuePoints[o+1];c.time===l.time&&(n.cuePoints.splice(o+1,1),o--)}}let s=null,a=-1/0;for(let n of this.currentSegment.tracks)n.cuePoints.length>a&&(a=n.cuePoints.length,s=n);for(let n of this.currentSegment.tracks)n.cuePoints.length===0&&(n.cuePoints=s.cuePoints);this.currentSegment=null}async readCluster(e,t){if(t.lastReadCluster?.elementStartPos===e)return t.lastReadCluster;let r=this.reader.requestSliceRange(e,ct,Et);r instanceof Promise&&(r=await r),d(r);let i=e,s=At(r);d(s);let a=s.id;d(a===524531317);let n=s.size,o=r.filePos;n===null&&(n=(await os(this.reader,o,ki,t.elementEndPos)).pos-o);let c=this.reader.requestSlice(o,n);c instanceof Promise&&(c=await c);let l={segment:t,elementStartPos:i,elementEndPos:o+n,dataStartPos:o,timestamp:-1,trackData:new Map};if(this.currentCluster=l,c){let u=this.readContiguousElements(c,ki);l.elementEndPos=u}for(let[,u]of l.trackData){let h=u.track;d(u.blocks.length>0);let f=!1,w=!1;for(let k=0;k<u.blocks.length;k++){let T=u.blocks[k];T.timestamp+=l.timestamp,f||(f=T.referencedTimestamps.length>0),w||(w=T.lacing!==0)}f&&(u.blocks=pl(u.blocks)),u.presentationTimestamps=u.blocks.map((k,T)=>({timestamp:k.timestamp,blockIndex:T})).sort((k,T)=>k.timestamp-T.timestamp);for(let k=0;k<u.presentationTimestamps.length;k++){let T=u.presentationTimestamps[k],_=u.blocks[T.blockIndex];if(u.firstKeyFrameTimestamp===null&&_.isKeyFrame&&(u.firstKeyFrameTimestamp=_.timestamp),k<u.presentationTimestamps.length-1){let x=u.presentationTimestamps[k+1];_.duration=x.timestamp-_.timestamp}else _.duration===0&&h.defaultDuration!=null&&_.lacing===0&&(_.duration=h.defaultDuration)}w&&(this.expandLacedBlocks(u.blocks,h),u.presentationTimestamps=u.blocks.map((k,T)=>({timestamp:k.timestamp,blockIndex:T})).sort((k,T)=>k.timestamp-T.timestamp));let b=u.blocks[u.presentationTimestamps[0].blockIndex],p=u.blocks[de(u.presentationTimestamps).blockIndex];u.startTimestamp=b.timestamp,u.endTimestamp=p.timestamp+p.duration;let y=ue(h.clusterPositionCache,u.startTimestamp,k=>k.startTimestamp);(y===-1||h.clusterPositionCache[y].elementStartPos!==i)&&h.clusterPositionCache.splice(y+1,0,{elementStartPos:l.elementStartPos,startTimestamp:u.startTimestamp})}return t.lastReadCluster=l,l}getTrackDataInCluster(e,t){let r=e.trackData.get(t);if(!r){let i=e.segment.tracks.find(s=>s.id===t);if(!i)return null;r={track:i,startTimestamp:0,endTimestamp:0,firstKeyFrameTimestamp:null,blocks:[],presentationTimestamps:[]},e.trackData.set(t,r)}return r}expandLacedBlocks(e,t){for(let r=0;r<e.length;r++){let i=e[r];if(i.lacing===0)continue;i.decoded||(i.data=this.decodeBlockData(t,i.data),i.decoded=!0);let s=Ci.tempFromBytes(i.data),a=[],n=H(s)+1;switch(i.lacing){case 1:{let o=0;for(let c=0;c<n-1;c++){let l=0;for(;s.bufferPos<s.length;){let u=H(s);if(l+=u,u<255){a.push(l),o+=l;break}}}a.push(s.length-(s.bufferPos+o))}break;case 2:{let o=s.length-1,c=Math.floor(o/n);for(let l=0;l<n;l++)a.push(c)}break;case 3:{let o=$r(s);d(o!==null);let c=o;a.push(c);let l=c;for(let u=1;u<n-1;u++){let h=s.bufferPos,f=$r(s);d(f!==null);let w=f,p=(1<<(s.bufferPos-h)*7-1)-1,y=w-p;c+=y,a.push(c),l+=c}a.push(s.length-(s.bufferPos+l))}break;default:d(!1)}d(a.length===n),e.splice(r,1);for(let o=0;o<n;o++){let c=a[o],l=K(s,c),u=i.duration||n*(t.defaultDuration??0),h=i.timestamp+u*o/n,f=u/n;e.splice(r+o,0,{timestamp:h,duration:f,isKeyFrame:i.isKeyFrame,referencedTimestamps:i.referencedTimestamps,data:l,lacing:0,decoded:!0,mainAdditional:i.mainAdditional})}r+=n,r--}}async loadSegmentMetadata(e){for(let t of e.seekEntries){if(!(t.id===307544935&&!e.tagsSeen)){if(!(t.id===423732329&&!e.attachmentsSeen))continue}let r=this.reader.requestSliceRange(e.dataStartPos+t.segmentPosition,ct,Et);if(r instanceof Promise&&(r=await r),!r)continue;let i=At(r);if(!i||i.id!==t.id)continue;let{size:s}=i;Ht(s),d(!this.currentSegment),this.currentSegment=e;let a=this.reader.requestSlice(r.filePos,s);a instanceof Promise&&(a=await a),a&&this.readContiguousElements(a),this.currentSegment=null,t.id===307544935?e.tagsSeen=!0:t.id===423732329&&(e.attachmentsSeen=!0)}}readContiguousElements(e,t){let r=e.filePos;for(;e.filePos-r<=e.length-ct;){let i=e.filePos;if(!this.traverseElement(e,t))return i}return e.filePos}traverseElement(e,t){let r=At(e);if(!r||t&&t.includes(r.id))return!1;let{id:i,size:s}=r,a=e.filePos;switch(Ht(s),i){case 17026:this.isWebM=yr(e,s)==="webm";break;case 19899:{if(!this.currentSegment)break;let n={id:-1,segmentPosition:-1};this.currentSegment.seekEntries.push(n),this.readContiguousElements(e.slice(a,s)),(n.id===-1||n.segmentPosition===-1)&&this.currentSegment.seekEntries.pop()}break;case 21419:{let n=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!n)break;n.id=ae(e,s)}break;case 21420:{let n=this.currentSegment?.seekEntries[this.currentSegment.seekEntries.length-1];if(!n)break;n.segmentPosition=ae(e,s)}break;case 2807729:{if(!this.currentSegment)break;this.currentSegment.timestampScale=ae(e,s),this.currentSegment.timestampFactor=1e9/this.currentSegment.timestampScale}break;case 17545:{if(!this.currentSegment)break;this.currentSegment.duration=ns(e,s)}break;case 174:{if(!this.currentSegment)break;if(this.currentTrack={id:-1,segment:this.currentSegment,demuxer:this,clusterPositionCache:[],cuePoints:[],isDefault:!1,inputTrack:null,codecId:null,codecPrivate:null,defaultDuration:null,name:null,languageCode:je,decodingInstructions:[],info:null},this.readContiguousElements(e.slice(a,s)),this.currentTrack.decodingInstructions.some(n=>n.data?.type!=="decompress"||n.scope!==1||n.data.algorithm!==3)&&(console.warn("Track #".concat(this.currentTrack.id," has an unsupported content encoding; dropping.")),this.currentTrack=null),this.currentTrack&&this.currentTrack.id!==-1&&this.currentTrack.codecId&&this.currentTrack.info){let n=this.currentTrack.codecId.indexOf("/"),o=n===-1?this.currentTrack.codecId:this.currentTrack.codecId.slice(0,n);if(this.currentTrack.info.type==="video"&&this.currentTrack.info.width!==-1&&this.currentTrack.info.height!==-1){this.currentTrack.codecId===lt.avc?(this.currentTrack.info.codec="avc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===lt.hevc?(this.currentTrack.info.codec="hevc",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):o===lt.vp8?this.currentTrack.info.codec="vp8":o===lt.vp9?this.currentTrack.info.codec="vp9":o===lt.av1&&(this.currentTrack.info.codec="av1");let c=this.currentTrack,l=new kr(this.input,new fl(c));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}else if(this.currentTrack.info.type==="audio"&&this.currentTrack.info.numberOfChannels!==-1&&this.currentTrack.info.sampleRate!==-1){o===lt.aac?(this.currentTrack.info.codec="aac",this.currentTrack.info.aacCodecInfo={isMpeg2:this.currentTrack.codecId.includes("MPEG2")},this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId===lt.mp3?this.currentTrack.info.codec="mp3":o===lt.opus?(this.currentTrack.info.codec="opus",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate,this.currentTrack.info.sampleRate=pr):o===lt.vorbis?(this.currentTrack.info.codec="vorbis",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):o===lt.flac?(this.currentTrack.info.codec="flac",this.currentTrack.info.codecDescription=this.currentTrack.codecPrivate):this.currentTrack.codecId==="A_PCM/INT/LIT"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32"):this.currentTrack.codecId==="A_PCM/INT/BIG"?this.currentTrack.info.bitDepth===8?this.currentTrack.info.codec="pcm-u8":this.currentTrack.info.bitDepth===16?this.currentTrack.info.codec="pcm-s16be":this.currentTrack.info.bitDepth===24?this.currentTrack.info.codec="pcm-s24be":this.currentTrack.info.bitDepth===32&&(this.currentTrack.info.codec="pcm-s32be"):this.currentTrack.codecId==="A_PCM/FLOAT/IEEE"&&(this.currentTrack.info.bitDepth===32?this.currentTrack.info.codec="pcm-f32":this.currentTrack.info.bitDepth===64&&(this.currentTrack.info.codec="pcm-f64"));let c=this.currentTrack,l=new ot(this.input,new ml(c));this.currentTrack.inputTrack=l,this.currentSegment.tracks.push(this.currentTrack)}}this.currentTrack=null}break;case 215:{if(!this.currentTrack)break;this.currentTrack.id=ae(e,s)}break;case 131:{if(!this.currentTrack)break;let n=ae(e,s);n===1?this.currentTrack.info={type:"video",width:-1,height:-1,rotation:0,codec:null,codecDescription:null,colorSpace:null,alphaMode:!1}:n===2&&(this.currentTrack.info={type:"audio",numberOfChannels:-1,sampleRate:-1,bitDepth:-1,codec:null,codecDescription:null,aacCodecInfo:null})}break;case 185:{if(!this.currentTrack)break;ae(e,s)||(this.currentSegment.tracks.pop(),this.currentTrack=null)}break;case 136:{if(!this.currentTrack)break;this.currentTrack.isDefault=!!ae(e,s)}break;case 134:{if(!this.currentTrack)break;this.currentTrack.codecId=yr(e,s)}break;case 25506:{if(!this.currentTrack)break;this.currentTrack.codecPrivate=K(e,s)}break;case 2352003:{if(!this.currentTrack)break;this.currentTrack.defaultDuration=this.currentTrack.segment.timestampFactor*ae(e,s)/1e9}break;case 21358:{if(!this.currentTrack)break;this.currentTrack.name=jr(e,s)}break;case 2274716:{if(!this.currentTrack||this.currentTrack.languageCode!==je)break;this.currentTrack.languageCode=yr(e,s),Dr(this.currentTrack.languageCode)||(this.currentTrack.languageCode=je)}break;case 2274717:{if(!this.currentTrack)break;let o=yr(e,s).split("-")[0];o?this.currentTrack.languageCode=o:this.currentTrack.languageCode=je}break;case 224:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(a,s))}break;case 176:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.width=ae(e,s)}break;case 186:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.height=ae(e,s)}break;case 21440:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.alphaMode=ae(e,s)===1}break;case 21936:{if(this.currentTrack?.info?.type!=="video")break;this.currentTrack.info.colorSpace={},this.readContiguousElements(e.slice(a,s))}break;case 21937:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let n=ae(e,s),o=Zt[n]??null;this.currentTrack.info.colorSpace.matrix=o}break;case 21945:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;this.currentTrack.info.colorSpace.fullRange=ae(e,s)===2}break;case 21946:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let n=ae(e,s),o=ri[n]??null;this.currentTrack.info.colorSpace.transfer=o}break;case 21947:{if(this.currentTrack?.info?.type!=="video"||!this.currentTrack.info.colorSpace)break;let n=ae(e,s),o=zr[n]??null;this.currentTrack.info.colorSpace.primaries=o}break;case 30320:{if(this.currentTrack?.info?.type!=="video")break;this.readContiguousElements(e.slice(a,s))}break;case 30325:{if(this.currentTrack?.info?.type!=="video")break;let o=-ns(e,s);try{this.currentTrack.info.rotation=pt(o)}catch{}}break;case 225:{if(this.currentTrack?.info?.type!=="audio")break;this.readContiguousElements(e.slice(a,s))}break;case 181:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.sampleRate=ns(e,s)}break;case 159:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.numberOfChannels=ae(e,s)}break;case 25188:{if(this.currentTrack?.info?.type!=="audio")break;this.currentTrack.info.bitDepth=ae(e,s)}break;case 187:{if(!this.currentSegment)break;this.readContiguousElements(e.slice(a,s)),this.currentCueTime=null}break;case 179:this.currentCueTime=ae(e,s);break;case 183:{if(this.currentCueTime===null)break;d(this.currentSegment);let n={time:this.currentCueTime,trackId:-1,clusterPosition:-1};this.currentSegment.cuePoints.push(n),this.readContiguousElements(e.slice(a,s)),(n.trackId===-1||n.clusterPosition===-1)&&this.currentSegment.cuePoints.pop()}break;case 247:{let n=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!n)break;n.trackId=ae(e,s)}break;case 241:{let n=this.currentSegment?.cuePoints[this.currentSegment.cuePoints.length-1];if(!n)break;d(this.currentSegment),n.clusterPosition=this.currentSegment.dataStartPos+ae(e,s)}break;case 231:{if(!this.currentCluster)break;this.currentCluster.timestamp=ae(e,s)}break;case 163:{if(!this.currentCluster)break;let n=$r(e);if(n===null)break;let o=this.getTrackDataInCluster(this.currentCluster,n);if(!o)break;let c=Ss(e),l=H(e),u=!!(l&128),h=l>>1&3,f=K(e,s-(e.filePos-a)),w=o.track.decodingInstructions.length>0;o.blocks.push({timestamp:c,duration:0,isKeyFrame:u,referencedTimestamps:[],data:f,lacing:h,decoded:!w,mainAdditional:null})}break;case 160:{if(!this.currentCluster)break;if(this.readContiguousElements(e.slice(a,s)),this.currentBlock){for(let n=0;n<this.currentBlock.referencedTimestamps.length;n++)this.currentBlock.referencedTimestamps[n]+=this.currentBlock.timestamp;this.currentBlock=null}}break;case 161:{if(!this.currentCluster)break;let n=$r(e);if(n===null)break;let o=this.getTrackDataInCluster(this.currentCluster,n);if(!o)break;let c=Ss(e),u=H(e)>>1&3,h=K(e,s-(e.filePos-a)),f=o.track.decodingInstructions.length>0;this.currentBlock={timestamp:c,duration:0,isKeyFrame:!0,referencedTimestamps:[],data:h,lacing:u,decoded:!f,mainAdditional:null},o.blocks.push(this.currentBlock)}break;case 30113:this.readContiguousElements(e.slice(a,s));break;case 166:{if(!this.currentBlock)break;this.currentBlockAdditional={addId:1,data:null},this.readContiguousElements(e.slice(a,s)),this.currentBlockAdditional.data&&this.currentBlockAdditional.addId===1&&(this.currentBlock.mainAdditional=this.currentBlockAdditional.data),this.currentBlockAdditional=null}break;case 165:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.data=K(e,s)}break;case 238:{if(!this.currentBlockAdditional)break;this.currentBlockAdditional.addId=ae(e,s)}break;case 155:{if(!this.currentBlock)break;this.currentBlock.duration=ae(e,s)}break;case 251:{if(!this.currentBlock)break;this.currentBlock.isKeyFrame=!1;let n=dl(e,s);this.currentBlock.referencedTimestamps.push(n)}break;case 29555:this.currentTagTargetIsMovie=!0,this.readContiguousElements(e.slice(a,s));break;case 25536:this.readContiguousElements(e.slice(a,s));break;case 26826:ae(e,s)!==50&&(this.currentTagTargetIsMovie=!1);break;case 25541:case 25545:case 25540:case 25542:this.currentTagTargetIsMovie=!1;break;case 26568:{if(!this.currentTagTargetIsMovie)break;this.currentSimpleTagName=null,this.readContiguousElements(e.slice(a,s))}break;case 17827:this.currentSimpleTagName=jr(e,s);break;case 17543:{if(!this.currentSimpleTagName)break;let n=jr(e,s);this.processTagValue(this.currentSimpleTagName,n)}break;case 17541:{if(!this.currentSimpleTagName)break;let n=K(e,s);this.processTagValue(this.currentSimpleTagName,n)}break;case 24999:{if(!this.currentSegment)break;this.currentAttachedFile={fileUid:null,fileName:null,fileMediaType:null,fileData:null,fileDescription:null},this.readContiguousElements(e.slice(a,s));let n=this.currentSegment.metadataTags;if(this.currentAttachedFile.fileUid&&this.currentAttachedFile.fileData&&(n.raw??(n.raw={}),n.raw[this.currentAttachedFile.fileUid.toString()]=new ci(this.currentAttachedFile.fileData,this.currentAttachedFile.fileMediaType??void 0,this.currentAttachedFile.fileName??void 0,this.currentAttachedFile.fileDescription??void 0)),this.currentAttachedFile.fileMediaType?.startsWith("image/")&&this.currentAttachedFile.fileData){let o=this.currentAttachedFile.fileName,c="unknown";if(o){let l=o.toLowerCase();l.startsWith("cover.")?c="coverFront":l.startsWith("back.")&&(c="coverBack")}n.images??(n.images=[]),n.images.push({data:this.currentAttachedFile.fileData,mimeType:this.currentAttachedFile.fileMediaType,kind:c,name:this.currentAttachedFile.fileName??void 0,description:this.currentAttachedFile.fileDescription??void 0})}this.currentAttachedFile=null}break;case 18094:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileUid=ul(e,s)}break;case 18030:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileName=jr(e,s)}break;case 18016:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileMediaType=yr(e,s)}break;case 18012:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileData=K(e,s)}break;case 18046:{if(!this.currentAttachedFile)break;this.currentAttachedFile.fileDescription=jr(e,s)}break;case 28032:{if(!this.currentTrack)break;this.readContiguousElements(e.slice(a,s)),this.currentTrack.decodingInstructions.sort((n,o)=>o.order-n.order)}break;case 25152:this.currentDecodingInstruction={order:0,scope:1,data:null},this.readContiguousElements(e.slice(a,s)),this.currentDecodingInstruction.data&&this.currentTrack.decodingInstructions.push(this.currentDecodingInstruction),this.currentDecodingInstruction=null;break;case 20529:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.order=ae(e,s)}break;case 20530:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.scope=ae(e,s)}break;case 20532:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decompress",algorithm:0,settings:null},this.readContiguousElements(e.slice(a,s))}break;case 16980:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.algorithm=ae(e,s)}break;case 16981:{if(this.currentDecodingInstruction?.data?.type!=="decompress")break;this.currentDecodingInstruction.data.settings=K(e,s)}break;case 20533:{if(!this.currentDecodingInstruction)break;this.currentDecodingInstruction.data={type:"decrypt"}}break}return e.filePos=a+s,!0}decodeBlockData(e,t){d(e.decodingInstructions.length>0);let r=t;for(let i of e.decodingInstructions)switch(d(i.data),i.data.type){case"decompress":switch(i.data.algorithm){case 3:if(i.data.settings&&i.data.settings.length>0){let s=i.data.settings,a=new Uint8Array(s.length+r.length);a.set(s,0),a.set(r,s.length),r=a}break;default:}break;default:}return r}processTagValue(e,t){var i;if(!this.currentSegment?.metadataTags)return;let r=this.currentSegment.metadataTags;if(r.raw??(r.raw={}),(i=r.raw)[e]??(i[e]=t),typeof t=="string")switch(e.toLowerCase()){case"title":r.title??(r.title=t);break;case"description":r.description??(r.description=t);break;case"artist":r.artist??(r.artist=t);break;case"album":r.album??(r.album=t);break;case"album_artist":r.albumArtist??(r.albumArtist=t);break;case"genre":r.genre??(r.genre=t);break;case"comment":r.comment??(r.comment=t);break;case"lyrics":r.lyrics??(r.lyrics=t);break;case"date":{let s=new Date(t);Number.isNaN(s.getTime())||(r.date??(r.date=s))}break;case"track_number":case"part_number":{let s=t.split("/"),a=Number.parseInt(s[0],10),n=s[1]&&Number.parseInt(s[1],10);Number.isInteger(a)&&a>0&&(r.trackNumber??(r.trackNumber=a)),n&&Number.isInteger(n)&&n>0&&(r.tracksTotal??(r.tracksTotal=n))}break;case"disc_number":case"disc":{let s=t.split("/"),a=Number.parseInt(s[0],10),n=s[1]&&Number.parseInt(s[1],10);Number.isInteger(a)&&a>0&&(r.discNumber??(r.discNumber=a)),n&&Number.isInteger(n)&&n>0&&(r.discsTotal??(r.discsTotal=n))}break}}},tn=class{constructor(e){this.internalTrack=e,this.packetToClusterLocation=new WeakMap}getId(){return this.internalTrack.id}getCodec(){throw new Error("Not implemented on base class.")}getInternalCodecId(){return this.internalTrack.codecId}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return this.internalTrack.name}getLanguageCode(){return this.internalTrack.languageCode}async getFirstTimestamp(){return(await this.getFirstPacket({metadataOnly:!0}))?.timestamp??0}getTimeResolution(){return this.internalTrack.segment.timestampFactor}async getFirstPacket(e){return this.performClusterLookup(null,t=>t.trackData.get(this.internalTrack.id)?{blockIndex:0,correctBlockFound:!0}:{blockIndex:-1,correctBlockFound:!1},-1/0,1/0,e)}intoTimescale(e){return ni(e*this.internalTrack.segment.timestampFactor,14)}async getPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(null,i=>{let s=i.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};let a=ue(s.presentationTimestamps,r,c=>c.timestamp),n=a!==-1?s.presentationTimestamps[a].blockIndex:-1,o=a!==-1&&r<s.endTimestamp;return{blockIndex:n,correctBlockFound:o}},r,r,t)}async getNextPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,i=>{if(i===r.cluster){let s=i.trackData.get(this.internalTrack.id);if(r.blockIndex+1<s.blocks.length)return{blockIndex:r.blockIndex+1,correctBlockFound:!0}}else if(i.trackData.get(this.internalTrack.id))return{blockIndex:0,correctBlockFound:!0};return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async getKeyPacket(e,t){let r=this.intoTimescale(e);return this.performClusterLookup(null,i=>{let s=i.trackData.get(this.internalTrack.id);if(!s)return{blockIndex:-1,correctBlockFound:!1};let a=oa(s.presentationTimestamps,c=>s.blocks[c.blockIndex].isKeyFrame&&c.timestamp<=r),n=a!==-1?s.presentationTimestamps[a].blockIndex:-1,o=a!==-1&&r<s.endTimestamp;return{blockIndex:n,correctBlockFound:o}},r,r,t)}async getNextKeyPacket(e,t){let r=this.packetToClusterLocation.get(e);if(r===void 0)throw new Error("Packet was not created from this track.");return this.performClusterLookup(r.cluster,i=>{if(i===r.cluster){let a=i.trackData.get(this.internalTrack.id).blocks.findIndex((n,o)=>n.isKeyFrame&&o>r.blockIndex);if(a!==-1)return{blockIndex:a,correctBlockFound:!0}}else{let s=i.trackData.get(this.internalTrack.id);if(s&&s.firstKeyFrameTimestamp!==null){let a=s.blocks.findIndex(n=>n.isKeyFrame);return d(a!==-1),{blockIndex:a,correctBlockFound:!0}}}return{blockIndex:-1,correctBlockFound:!1}},-1/0,1/0,t)}async fetchPacketInCluster(e,t,r){if(t===-1)return null;let s=e.trackData.get(this.internalTrack.id).blocks[t];d(s),s.decoded||(s.data=this.internalTrack.demuxer.decodeBlockData(this.internalTrack,s.data),s.decoded=!0);let a=r.metadataOnly?tt:s.data,n=s.timestamp/this.internalTrack.segment.timestampFactor,o=s.duration/this.internalTrack.segment.timestampFactor,c={};s.mainAdditional&&this.internalTrack.info?.type==="video"&&this.internalTrack.info.alphaMode&&(c.alpha=r.metadataOnly?tt:s.mainAdditional,c.alphaByteLength=s.mainAdditional.byteLength);let l=new we(a,s.isKeyFrame?"key":"delta",n,o,e.dataStartPos+t,s.data.byteLength,c);return this.packetToClusterLocation.set(l,{cluster:e,blockIndex:t}),l}async performClusterLookup(e,t,r,i,s){let{demuxer:a,segment:n}=this.internalTrack,o=null,c=null,l=-1;if(e){let{blockIndex:y,correctBlockFound:k}=t(e);if(k)return this.fetchPacketInCluster(e,y,s);y!==-1&&(c=e,l=y)}let u=ue(this.internalTrack.cuePoints,r,y=>y.time),h=u!==-1?this.internalTrack.cuePoints[u]:null,f=ue(this.internalTrack.clusterPositionCache,r,y=>y.startTimestamp),w=f!==-1?this.internalTrack.clusterPositionCache[f]:null,b=Math.max(h?.clusterPosition??0,w?.elementStartPos??0)||null,p;for(e?b===null||e.elementStartPos>=b?(p=e.elementEndPos,o=e):p=b:p=b??n.clusterSeekStartPos;n.elementEndPos===null||p<=n.elementEndPos-ct;){if(o){let M=o.trackData.get(this.internalTrack.id);if(M&&M.startTimestamp>i)break}let y=a.reader.requestSliceRange(p,ct,Et);if(y instanceof Promise&&(y=await y),!y)break;let k=p,T=At(y);if(!T||!qr.includes(T.id)&&T.id!==236){let M=await Za(a.reader,k,qr,Math.min(n.elementEndPos??1/0,k+en));if(M){p=M;continue}else break}let _=T.id,x=T.size,B=y.filePos;if(_===524531317){o=await a.readCluster(k,n),x=o.elementEndPos-B;let{blockIndex:M,correctBlockFound:V}=t(o);if(V)return this.fetchPacketInCluster(o,M,s);M!==-1&&(c=o,l=M)}x===null&&(d(_!==524531317),x=(await os(a.reader,B,ki,n.elementEndPos)).pos-B);let I=B+x;if(n.elementEndPos===null){let M=a.reader.requestSliceRange(I,ct,Et);if(M instanceof Promise&&(M=await M),!M)break;if(as(M)===408125543){n.elementEndPos=I;break}}p=I}if(h&&(!c||c.elementStartPos<h.clusterPosition)){let y=this.internalTrack.cuePoints[u-1];d(!y||y.time<h.time);let k=y?.time??-1/0;return this.performClusterLookup(null,t,k,i,s)}return c?this.fetchPacketInCluster(c,l,s):null}},fl=class extends tn{constructor(e){super(e),this.decoderConfigPromise=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getCodedWidth(){return this.internalTrack.info.width}getCodedHeight(){return this.internalTrack.info.height}getRotation(){return this.internalTrack.info.rotation}async getColorSpace(){return{primaries:this.internalTrack.info.colorSpace?.primaries,transfer:this.internalTrack.info.colorSpace?.transfer,matrix:this.internalTrack.info.colorSpace?.matrix,fullRange:this.internalTrack.info.colorSpace?.fullRange}}async canBeTransparent(){return this.internalTrack.info.alphaMode}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfigPromise??(this.decoderConfigPromise=(async()=>{let e=null;return(this.internalTrack.info.codec==="vp9"||this.internalTrack.info.codec==="av1"||this.internalTrack.info.codec==="avc"&&!this.internalTrack.info.codecDescription||this.internalTrack.info.codec==="hevc"&&!this.internalTrack.info.codecDescription)&&(e=await this.getFirstPacket({})),{codec:ka({width:this.internalTrack.info.width,height:this.internalTrack.info.height,codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,colorSpace:this.internalTrack.info.colorSpace,avcCodecInfo:this.internalTrack.info.codec==="avc"&&e?Pa(e.data):null,hevcCodecInfo:this.internalTrack.info.codec==="hevc"&&e?Ea(e.data):null,vp9CodecInfo:this.internalTrack.info.codec==="vp9"&&e?Ba(e.data):null,av1CodecInfo:this.internalTrack.info.codec==="av1"&&e?Ma(e.data):null}),codedWidth:this.internalTrack.info.width,codedHeight:this.internalTrack.info.height,description:this.internalTrack.info.codecDescription??void 0,colorSpace:this.internalTrack.info.colorSpace??void 0}})()):null}},ml=class extends tn{constructor(e){super(e),this.decoderConfig=null,this.internalTrack=e}getCodec(){return this.internalTrack.info.codec}getNumberOfChannels(){return this.internalTrack.info.numberOfChannels}getSampleRate(){return this.internalTrack.info.sampleRate}async getDecoderConfig(){return this.internalTrack.info.codec?this.decoderConfig??(this.decoderConfig={codec:ya({codec:this.internalTrack.info.codec,codecDescription:this.internalTrack.info.codecDescription,aacCodecInfo:this.internalTrack.info.aacCodecInfo}),numberOfChannels:this.internalTrack.info.numberOfChannels,sampleRate:this.internalTrack.info.sampleRate,description:this.internalTrack.info.codecDescription??void 0}):null}},pl=e=>{let t=new Map;for(let a=0;a<e.length;a++){let n=e[a];t.set(n.timestamp,n)}let r=new Set,i=[],s=a=>{if(!r.has(a)){r.add(a);for(let n=0;n<a.referencedTimestamps.length;n++){let o=a.referencedTimestamps[n],c=t.get(o);c&&s(c)}i.push(a)}};for(let a=0;a<e.length;a++)s(e[a]);return i},rn=4,gl=[44100,48e3,32e3],ls=[-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,32,40,48,56,64,80,96,112,128,160,192,224,256,320,-1,-1,32,48,56,64,80,96,112,128,160,192,224,256,320,384,-1,-1,32,64,96,128,160,192,224,256,288,320,352,384,416,448,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,8,16,24,32,40,48,56,64,80,96,112,128,144,160,-1,-1,32,48,56,64,80,96,112,128,144,160,176,192,224,256,-1],us=1483304551,sn=1231971951,ds=(e,t,r,i,s)=>t===0?0:t===1?Math.floor(144*r/(i<<e))+s:t===2?Math.floor(144*r/i)+s:(Math.floor(12*r/i)+s)*4,hs=(e,t)=>e===3?t===3?21:36:t===3?13:21,an=(e,t)=>{let r=e>>>24,i=e>>>16&255,s=e>>>8&255,a=e&255;if(r!==255&&i!==255&&s!==255&&a!==255)return{header:null,bytesAdvanced:4};if(r!==255)return{header:null,bytesAdvanced:1};if((i&224)!==224)return{header:null,bytesAdvanced:1};let n=0,o=0;i&16?n=i&8?0:1:(n=1,o=1);let c=i>>3&3,l=i>>1&3,u=s>>4&15,h=(s>>2&3)%3,f=s>>1&1,w=a>>6&3,b=a>>4&3,p=a>>3&1,y=a>>2&1,k=a&3,T=ls[n*16*4+l*16+u];if(T===-1)return{header:null,bytesAdvanced:1};let _=T*1e3,x=gl[h]>>n+o,B=ds(n,l,_,x,f);if(t!==null&&t<B)return{header:null,bytesAdvanced:1};let I;return c===3?I=l===3?384:1152:l===3?I=384:l===2?I=1152:I=576,{header:{totalSize:B,mpegVersionId:c,layer:l,bitrate:_,frequencyIndex:h,sampleRate:x,channel:w,modeExtension:b,copyright:p,original:y,emphasis:k,audioSamplesInFrame:I},bytesAdvanced:1}},wl=e=>{let t=127,r=0,i=e;for(;(t^2147483647)!==0;)r=i&~t,r<<=1,r|=i&t,t=(t+1<<8)-1,i=r;return r},fs=e=>{let t=2130706432,r=0;for(;t!==0;)r>>=1,r|=e&t,t>>=8;return r},yi=128,Ti=10,Tr=["Blues","Classic rock","Country","Dance","Disco","Funk","Grunge","Hip-hop","Jazz","Metal","New age","Oldies","Other","Pop","Rhythm and blues","Rap","Reggae","Rock","Techno","Industrial","Alternative","Ska","Death metal","Pranks","Soundtrack","Euro-techno","Ambient","Trip-hop","Vocal","Jazz & funk","Fusion","Trance","Classical","Instrumental","Acid","House","Game","Sound clip","Gospel","Noise","Alternative rock","Bass","Soul","Punk","Space","Meditative","Instrumental pop","Instrumental rock","Ethnic","Gothic","Darkwave","Techno-industrial","Electronic","Pop-folk","Eurodance","Dream","Southern rock","Comedy","Cult","Gangsta","Top 40","Christian rap","Pop/funk","Jungle music","Native US","Cabaret","New wave","Psychedelic","Rave","Showtunes","Trailer","Lo-fi","Tribal","Acid punk","Acid jazz","Polka","Retro","Musical","Rock 'n' roll","Hard rock","Folk","Folk rock","National folk","Swing","Fast fusion","Bebop","Latin","Revival","Celtic","Bluegrass","Avantgarde","Gothic rock","Progressive rock","Psychedelic rock","Symphonic rock","Slow rock","Big band","Chorus","Easy listening","Acoustic","Humour","Speech","Chanson","Opera","Chamber music","Sonata","Symphony","Booty bass","Primus","Porn groove","Satire","Slow jam","Club","Tango","Samba","Folklore","Ballad","Power ballad","Rhythmic Soul","Freestyle","Duet","Punk rock","Drum solo","A cappella","Euro-house","Dance hall","Goa music","Drum & bass","Club-house","Hardcore techno","Terror","Indie","Britpop","Negerpunk","Polsk punk","Beat","Christian gangsta rap","Heavy metal","Black metal","Crossover","Contemporary Christian","Christian rock","Merengue","Salsa","Thrash metal","Anime","Jpop","Synthpop","Christmas","Art rock","Baroque","Bhangra","Big beat","Breakbeat","Chillout","Downtempo","Dub","EBM","Eclectic","Electro","Electroclash","Emo","Experimental","Garage","Global","IDM","Illbient","Industro-Goth","Jam Band","Krautrock","Leftfield","Lounge","Math rock","New romantic","Nu-breakz","Post-punk","Post-rock","Psytrance","Shoegaze","Space rock","Trop rock","World music","Neoclassical","Audiobook","Audio theatre","Neue Deutsche Welle","Podcast","Indie rock","G-Funk","Dubstep","Garage rock","Psybient"],bl=(e,t)=>{var h;let r=e.filePos;t.raw??(t.raw={}),(h=t.raw).TAG??(h.TAG=K(e,yi-3)),e.filePos=r;let i=Sr(e,30);i&&(t.title??(t.title=i));let s=Sr(e,30);s&&(t.artist??(t.artist=s));let a=Sr(e,30);a&&(t.album??(t.album=a));let n=Sr(e,4),o=Number.parseInt(n,10);Number.isInteger(o)&&o>0&&(t.date??(t.date=new Date(o,0,1)));let c=K(e,30),l;if(c[28]===0&&c[29]!==0){let f=c[29];f>0&&(t.trackNumber??(t.trackNumber=f)),e.skip(-30),l=Sr(e,28),e.skip(2)}else e.skip(-30),l=Sr(e,30);l&&(t.comment??(t.comment=l));let u=H(e);u<Tr.length&&(t.genre??(t.genre=Tr[u]))},Sr=(e,t)=>{let r=K(e,t),i=hr(r.indexOf(0),r.length),s=r.subarray(0,i),a="";for(let n=0;n<s.length;n++)a+=String.fromCharCode(s[n]);return a.trimEnd()},Si=e=>{let t=e.filePos,r=Ee(e,3),i=H(e),s=H(e),a=H(e),n=O(e);if(r!=="ID3"||i===255||s===255||(n&2155905152)!==0)return e.filePos=t,null;let o=fs(n);return{majorVersion:i,revision:s,flags:a,size:o}},nn=(e,t,r)=>{var a,n,o,c;if(![2,3,4].includes(t.majorVersion)){console.warn("Unsupported ID3v2 major version: ".concat(t.majorVersion));return}let i=K(e,t.size),s=new kl(t,i);if(t.flags&16&&s.removeFooter(),t.flags&128&&t.majorVersion===3&&s.ununsynchronizeAll(),t.flags&64){let l=s.readU32();t.majorVersion===3?s.pos+=l:s.pos+=l-4}for(;s.pos<=s.bytes.length-s.frameHeaderSize();){let l=s.readId3V2Frame();if(!l)break;let u=s.pos,h=s.pos+l.size,f=!1,w=!1,b=!1;if(t.majorVersion===3?(f=!!(l.flags&64),w=!!(l.flags&128)):t.majorVersion===4&&(f=!!(l.flags&4),w=!!(l.flags&8),b=!!(l.flags&2)||!!(t.flags&128)),f){console.warn("Skipping encrypted ID3v2 frame ".concat(l.id)),s.pos=h;continue}if(w){console.warn("Skipping compressed ID3v2 frame ".concat(l.id)),s.pos=h;continue}switch(b&&s.ununsynchronizeRegion(s.pos,h),r.raw??(r.raw={}),l.id[0]==="T"?(a=r.raw)[n=l.id]??(a[n]=s.readId3V2EncodingAndText(h)):(o=r.raw)[c=l.id]??(o[c]=s.readBytes(l.size)),s.pos=u,l.id){case"TIT2":case"TT2":r.title??(r.title=s.readId3V2EncodingAndText(h));break;case"TIT3":case"TT3":r.description??(r.description=s.readId3V2EncodingAndText(h));break;case"TPE1":case"TP1":r.artist??(r.artist=s.readId3V2EncodingAndText(h));break;case"TALB":case"TAL":r.album??(r.album=s.readId3V2EncodingAndText(h));break;case"TPE2":case"TP2":r.albumArtist??(r.albumArtist=s.readId3V2EncodingAndText(h));break;case"TRCK":case"TRK":{let y=s.readId3V2EncodingAndText(h).split("/"),k=Number.parseInt(y[0],10),T=y[1]&&Number.parseInt(y[1],10);Number.isInteger(k)&&k>0&&(r.trackNumber??(r.trackNumber=k)),T&&Number.isInteger(T)&&T>0&&(r.tracksTotal??(r.tracksTotal=T))}break;case"TPOS":case"TPA":{let y=s.readId3V2EncodingAndText(h).split("/"),k=Number.parseInt(y[0],10),T=y[1]&&Number.parseInt(y[1],10);Number.isInteger(k)&&k>0&&(r.discNumber??(r.discNumber=k)),T&&Number.isInteger(T)&&T>0&&(r.discsTotal??(r.discsTotal=T))}break;case"TCON":case"TCO":{let p=s.readId3V2EncodingAndText(h),y=/^\((\d+)\)/.exec(p);if(y){let k=Number.parseInt(y[1]);if(Tr[k]!==void 0){r.genre??(r.genre=Tr[k]);break}}if(y=/^\d+$/.exec(p),y){let k=Number.parseInt(y[0]);if(Tr[k]!==void 0){r.genre??(r.genre=Tr[k]);break}}r.genre??(r.genre=p)}break;case"TDRC":case"TDAT":{let p=s.readId3V2EncodingAndText(h),y=new Date(p);Number.isNaN(y.getTime())||(r.date??(r.date=y))}break;case"TYER":case"TYE":{let p=s.readId3V2EncodingAndText(h),y=Number.parseInt(p,10);Number.isInteger(y)&&(r.date??(r.date=new Date(y,0,1)))}break;case"USLT":case"ULT":{let p=s.readU8();s.pos+=3,s.readId3V2Text(p,h),r.lyrics??(r.lyrics=s.readId3V2Text(p,h))}break;case"COMM":case"COM":{let p=s.readU8();s.pos+=3,s.readId3V2Text(p,h),r.comment??(r.comment=s.readId3V2Text(p,h))}break;case"APIC":case"PIC":{let p=s.readId3V2TextEncoding(),y;if(t.majorVersion===2){let x=s.readAscii(3);y=x==="PNG"?"image/png":x==="JPG"?"image/jpeg":"image/*"}else y=s.readId3V2Text(p,h);let k=s.readU8(),T=s.readId3V2Text(p,h).trimEnd(),_=h-s.pos;if(_>=0){let x=s.readBytes(_);r.images||(r.images=[]),r.images.push({data:x,mimeType:y,kind:k===3?"coverFront":k===4?"coverBack":"unknown",description:T})}}break;default:s.pos+=l.size;break}s.pos=h}},kl=class{constructor(e,t){this.header=e,this.bytes=t,this.pos=0,this.view=new DataView(t.buffer,t.byteOffset,t.byteLength)}frameHeaderSize(){return this.header.majorVersion===2?6:10}ununsynchronizeAll(){let e=[];for(let t=0;t<this.bytes.length;t++){let r=this.bytes[t];e.push(r),r===255&&t!==this.bytes.length-1&&this.bytes[t]===0&&t++}this.bytes=new Uint8Array(e),this.view=new DataView(this.bytes.buffer)}ununsynchronizeRegion(e,t){let r=[];for(let a=e;a<t;a++){let n=this.bytes[a];r.push(n),n===255&&a!==t-1&&this.bytes[a+1]===0&&a++}let i=this.bytes.subarray(0,e),s=this.bytes.subarray(t);this.bytes=new Uint8Array(i.length+r.length+s.length),this.bytes.set(i,0),this.bytes.set(r,i.length),this.bytes.set(s,i.length+r.length),this.view=new DataView(this.bytes.buffer)}removeFooter(){this.bytes=this.bytes.subarray(0,this.bytes.length-Ti),this.view=new DataView(this.bytes.buffer)}readBytes(e){let t=this.bytes.subarray(this.pos,this.pos+e);return this.pos+=e,t}readU8(){let e=this.view.getUint8(this.pos);return this.pos+=1,e}readU16(){let e=this.view.getUint16(this.pos,!1);return this.pos+=2,e}readU24(){let e=this.view.getUint16(this.pos,!1),t=this.view.getUint8(this.pos+1);return this.pos+=3,e*256+t}readU32(){let e=this.view.getUint32(this.pos,!1);return this.pos+=4,e}readAscii(e){let t="";for(let r=0;r<e;r++)t+=String.fromCharCode(this.view.getUint8(this.pos+r));return this.pos+=e,t}readId3V2Frame(){if(this.header.majorVersion===2){let e=this.readAscii(3);if(e==="\0\0\0")return null;let t=this.readU24();return{id:e,size:t,flags:0}}else{let e=this.readAscii(4);if(e==="\0\0\0\0")return null;let t=this.readU32(),r=this.header.majorVersion===4?fs(t):t,i=this.readU16(),s=this.pos,a=n=>{let o=this.pos+n;if(o>this.bytes.length)return!1;if(o<=this.bytes.length-this.frameHeaderSize()){this.pos+=n;let c=this.readAscii(4);if(c!=="\0\0\0\0"&&!/[0-9A-Z]{4}/.test(c))return!1}return!0};if(!a(r)){let n=this.header.majorVersion===4?t:fs(t);a(n)&&(r=n)}return this.pos=s,{id:e,size:r,flags:i}}}readId3V2TextEncoding(){let e=this.readU8();if(e>3)throw new Error("Unsupported text encoding: ".concat(e));return e}readId3V2Text(e,t){let r=this.pos,i=this.readBytes(t-this.pos);switch(e){case 0:{let s="";for(let a=0;a<i.length;a++){let n=i[a];if(n===0){this.pos=r+a+1;break}s+=String.fromCharCode(n)}return s}case 1:if(i[0]===255&&i[1]===254){let s=new TextDecoder("utf-16le"),a=hr(i.findIndex((n,o)=>n===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(a+2,i.length),s.decode(i.subarray(2,a))}else if(i[0]===254&&i[1]===255){let s=new TextDecoder("utf-16be"),a=hr(i.findIndex((n,o)=>n===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(a+2,i.length),s.decode(i.subarray(2,a))}else{let s=hr(i.findIndex(a=>a===0),i.length);return this.pos=r+Math.min(s+1,i.length),Ce.decode(i.subarray(0,s))}case 2:{let s=new TextDecoder("utf-16be"),a=hr(i.findIndex((n,o)=>n===0&&i[o+1]===0&&o%2===0),i.length);return this.pos=r+Math.min(a+2,i.length),s.decode(i.subarray(0,a))}case 3:{let s=hr(i.findIndex(a=>a===0),i.length);return this.pos=r+Math.min(s+1,i.length),Ce.decode(i.subarray(0,s))}}}readId3V2EncodingAndText(e){if(this.pos>=e)return"";let t=this.readId3V2TextEncoding();return this.readId3V2Text(t,e)}},on=class{constructor(e){this.helper=new Uint8Array(8),this.helperView=le(this.helper),this.writer=e}writeId3V2Tag(e){let t=this.writer.getPos();this.writeAscii("ID3"),this.writeU8(4),this.writeU8(0),this.writeU8(0),this.writeSynchsafeU32(0);let r=this.writer.getPos(),i=new Set;for(let{key:n,value:o}of fr(e))switch(n){case"title":this.writeId3V2TextFrame("TIT2",o),i.add("TIT2");break;case"description":this.writeId3V2TextFrame("TIT3",o),i.add("TIT3");break;case"artist":this.writeId3V2TextFrame("TPE1",o),i.add("TPE1");break;case"album":this.writeId3V2TextFrame("TALB",o),i.add("TALB");break;case"albumArtist":this.writeId3V2TextFrame("TPE2",o),i.add("TPE2");break;case"trackNumber":{let c=e.tracksTotal!==void 0?"".concat(o,"/").concat(e.tracksTotal):o.toString();this.writeId3V2TextFrame("TRCK",c),i.add("TRCK")}break;case"discNumber":{let c=e.discsTotal!==void 0?"".concat(o,"/").concat(e.discsTotal):o.toString();this.writeId3V2TextFrame("TPOS",c),i.add("TPOS")}break;case"genre":this.writeId3V2TextFrame("TCON",o),i.add("TCON");break;case"date":this.writeId3V2TextFrame("TDRC",o.toISOString().slice(0,10)),i.add("TDRC");break;case"lyrics":this.writeId3V2LyricsFrame(o),i.add("USLT");break;case"comment":this.writeId3V2CommentFrame(o),i.add("COMM");break;case"images":{let c={coverFront:3,coverBack:4,unknown:0};for(let l of o){let u=c[l.kind]??0,h=l.description??"";this.writeId3V2ApicFrame(l.mimeType,u,h,l.data)}}break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Re(n)}if(e.raw)for(let n in e.raw){let o=e.raw[n];if(o==null||n.length!==4||i.has(n))continue;let c;if(typeof o=="string"){let l=J.encode(o);c=new Uint8Array(l.byteLength+2),c[0]=3,c.set(l,1)}else if(o instanceof Uint8Array)c=o;else continue;this.writeAscii(n),this.writeSynchsafeU32(c.byteLength),this.writeU16(0),this.writer.write(c)}let s=this.writer.getPos(),a=s-r;return this.writer.seek(t+6),this.writeSynchsafeU32(a),this.writer.seek(s),a+10}writeU8(e){this.helper[0]=e,this.writer.write(this.helper.subarray(0,1))}writeU16(e){this.helperView.setUint16(0,e,!1),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeAscii(e){for(let t=0;t<e.length;t++)this.helper[t]=e.charCodeAt(t);this.writer.write(this.helper.subarray(0,e.length))}writeSynchsafeU32(e){this.writeU32(wl(e))}writeIsoString(e){let t=new Uint8Array(e.length+1);for(let r=0;r<e.length;r++)t[r]=e.charCodeAt(r);t[e.length]=0,this.writer.write(t)}writeUtf8String(e){let t=J.encode(e);this.writer.write(t),this.writeU8(0)}writeId3V2TextFrame(e,t){let r=et(t),s=1+(r?t.length:J.encode(t).byteLength)+1;this.writeAscii(e),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(r?0:3),r?this.writeIsoString(t):this.writeUtf8String(t)}writeId3V2LyricsFrame(e){let t=et(e),r="",i=4+r.length+1+e.length+1;this.writeAscii("USLT"),this.writeSynchsafeU32(i),this.writeU16(0),this.writeU8(t?0:3),this.writeAscii("und"),t?(this.writeIsoString(r),this.writeIsoString(e)):(this.writeUtf8String(r),this.writeUtf8String(e))}writeId3V2CommentFrame(e){let t=et(e),r=t?e.length:J.encode(e).byteLength,i="",s=4+i.length+1+r+1;this.writeAscii("COMM"),this.writeSynchsafeU32(s),this.writeU16(0),this.writeU8(t?0:3),this.writeU8(117),this.writeU8(110),this.writeU8(100),t?(this.writeIsoString(i),this.writeIsoString(e)):(this.writeUtf8String(i),this.writeUtf8String(e))}writeId3V2ApicFrame(e,t,r,i){let s=et(e)&&et(r),a=s?r.length:J.encode(r).byteLength,n=1+e.length+1+1+a+1+i.byteLength;this.writeAscii("APIC"),this.writeSynchsafeU32(n),this.writeU16(0),this.writeU8(s?0:3),s?this.writeIsoString(e):this.writeUtf8String(e),this.writeU8(t),s?this.writeIsoString(r):this.writeUtf8String(r),this.writer.write(i)}},ms=async(e,t,r)=>{let i=t;for(;r===null||i<r;){let s=e.requestSlice(i,rn);if(s instanceof Promise&&(s=await s),!s)break;let a=O(s),n=an(a,e.fileSize!==null?e.fileSize-i:null);if(n.header)return{header:n.header,startPos:i};i+=n.bytesAdvanced}return null},yl=class extends rr{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.metadataTags=null,this.tracks=[],this.readingMutex=new xt,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();if(!this.firstFrameHeader)throw new Error("No valid MP3 frame found.");this.tracks=[new ot(this.input,new Tl(this))]})())}async advanceReader(){if(this.lastLoadedPos===0)for(;;){let n=this.reader.requestSlice(this.lastLoadedPos,Ti);if(n instanceof Promise&&(n=await n),!n){this.lastSampleLoaded=!0;return}let o=Si(n);if(!o)break;this.lastLoadedPos=n.filePos+o.size}let e=await ms(this.reader,this.lastLoadedPos,this.reader.fileSize);if(!e){this.lastSampleLoaded=!0;return}let t=e.header;this.lastLoadedPos=e.startPos+t.totalSize-1;let r=hs(t.mpegVersionId,t.channel),i=this.reader.requestSlice(e.startPos+r,4);if(i instanceof Promise&&(i=await i),i){let n=O(i);if(n===us||n===sn)return}this.firstFrameHeader||(this.firstFrameHeader=t),t.sampleRate!==this.firstFrameHeader.sampleRate&&console.warn("MP3 changed sample rate mid-file: ".concat(this.firstFrameHeader.sampleRate," Hz to ").concat(t.sampleRate," Hz. Might be a bug, so please report this file."));let s=t.audioSamplesInFrame/this.firstFrameHeader.sampleRate,a={timestamp:this.nextTimestampInSamples/this.firstFrameHeader.sampleRate,duration:s,dataStart:e.startPos,dataSize:t.totalSize};this.loadedSamples.push(a),this.nextTimestampInSamples+=t.audioSamplesInFrame}async getMimeType(){return"audio/mpeg"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return d(e),e.computeDuration()}async getMetadataTags(){let e=await this.readingMutex.acquire();try{if(await this.readMetadata(),this.metadataTags)return this.metadataTags;this.metadataTags={};let t=0,r=!1;for(;;){let i=this.reader.requestSlice(t,Ti);if(i instanceof Promise&&(i=await i),!i)break;let s=Si(i);if(!s)break;r=!0;let a=this.reader.requestSlice(i.filePos,s.size);if(a instanceof Promise&&(a=await a),!a)break;nn(a,s,this.metadataTags),t=i.filePos+s.size}if(!r&&this.reader.fileSize!==null&&this.reader.fileSize>=yi){let i=this.reader.requestSlice(this.reader.fileSize-yi,yi);i instanceof Promise&&(i=await i),d(i),Ee(i,3)==="TAG"&&bl(i,this.metadataTags)}return this.metadataTags}finally{e()}}},Tl=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate/this.demuxer.firstFrameHeader.audioSamplesInFrame}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return je}getCodec(){return"mp3"}getInternalCodecId(){return null}getNumberOfChannels(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.channel===3?1:2}getSampleRate(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.sampleRate}async getDecoderConfig(){return d(this.demuxer.firstFrameHeader),{codec:"mp3",numberOfChannels:this.demuxer.firstFrameHeader.channel===3?1:2,sampleRate:this.demuxer.firstFrameHeader.sampleRate}}async getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=tt;else{let s=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;i=K(s,r.dataSize)}return new we(i,"key",r.timestamp,r.duration,e,r.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=Di(this.demuxer.loadedSamples,e.timestamp,a=>a.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let s=i+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=ue(this.demuxer.loadedSamples,e,s=>s.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,t);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,t);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},ps=1399285583,Sl=79764919,cn=new Uint32Array(256);for(let e=0;e<256;e++){let t=e<<24;for(let r=0;r<8;r++)t=t&2147483648?t<<1^Sl:t<<1;cn[e]=t>>>0&4294967295}var ln=e=>{let t=le(e),r=t.getUint32(22,!0);t.setUint32(22,0,!0);let i=0;for(let s=0;s<e.length;s++){let a=e[s];i=(i<<8^cn[i>>>24^a])>>>0}return t.setUint32(22,r,!0),i},un=(e,t,r)=>{let i=0,s=null;if(e.length>0)if(t.codec==="vorbis"){d(t.vorbisInfo);let a=t.vorbisInfo.modeBlockflags.length,o=(1<<lc(a-1))-1<<1,c=(e[0]&o)>>1;if(c>=t.vorbisInfo.modeBlockflags.length)throw new Error("Invalid mode number.");let l=r,u=t.vorbisInfo.modeBlockflags[c];if(s=t.vorbisInfo.blocksizes[u],u===1){let h=(o|1)+1,f=e[0]&h?1:0;l=t.vorbisInfo.blocksizes[f]}i=l!==null?l+s>>2:0}else t.codec==="opus"&&(i=Uc(e).durationInSamples);return{durationInSamples:i,vorbisBlockSize:s}},dn=e=>{let t="audio/ogg";if(e.codecStrings){let r=[...new Set(e.codecStrings)];t+='; codecs="'.concat(r.join(", "),'"')}return t},ar=27,vr=282,hn=vr+65025,Qr=e=>{let t=e.filePos;if(xr(e)!==ps)return null;e.skip(1);let i=H(e),s=jl(e),a=xr(e),n=xr(e),o=xr(e),c=H(e),l=new Uint8Array(c);for(let w=0;w<c;w++)l[w]=H(e);let u=27+c,h=l.reduce((w,b)=>w+b,0),f=u+h;return{headerStartPos:t,totalSize:f,dataStartPos:t+u,dataSize:h,headerType:i,granulePosition:s,serialNumber:a,sequenceNumber:n,checksum:o,lacingValues:l}},vl=(e,t)=>{for(;e.filePos<t-3;){let r=xr(e),i=r&255,s=r>>>8&255,a=r>>>16&255,n=r>>>24&255,o=79;if(!(i!==o&&s!==o&&a!==o&&n!==o)){if(e.skip(-4),r===ps)return!0;e.skip(1)}}return!1},_l=class extends rr{constructor(e){super(e),this.metadataPromise=null,this.bitstreams=[],this.tracks=[],this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=0;for(;;){let t=this.reader.requestSliceRange(e,ar,vr);if(t instanceof Promise&&(t=await t),!t)break;let r=Qr(t);if(!r||!!!(r.headerType&2))break;this.bitstreams.push({serialNumber:r.serialNumber,bosPage:r,description:null,numberOfChannels:-1,sampleRate:-1,codecInfo:{codec:null,vorbisInfo:null,opusInfo:null},lastMetadataPacket:null}),e=r.headerStartPos+r.totalSize}for(let t of this.bitstreams){let r=await this.readPacket(t.bosPage,0);r&&(r.data.byteLength>=7&&r.data[0]===1&&r.data[1]===118&&r.data[2]===111&&r.data[3]===114&&r.data[4]===98&&r.data[5]===105&&r.data[6]===115?await this.readVorbisMetadata(r,t):r.data.byteLength>=8&&r.data[0]===79&&r.data[1]===112&&r.data[2]===117&&r.data[3]===115&&r.data[4]===72&&r.data[5]===101&&r.data[6]===97&&r.data[7]===100&&await this.readOpusMetadata(r,t),t.codecInfo.codec!==null&&this.tracks.push(new ot(this.input,new Cl(t,this))))}})())}async readVorbisMetadata(e,t){let r=await this.findNextPacketStart(e);if(!r)return;let i=await this.readPacket(r.startPage,r.startSegmentIndex);if(!i||(r=await this.findNextPacketStart(i),!r))return;let s=await this.readPacket(r.startPage,r.startSegmentIndex);if(!s||i.data[0]!==3||s.data[0]!==5)return;let a=[],n=u=>{for(;a.push(Math.min(255,u)),!(u<255);)u-=255};n(e.data.length),n(i.data.length);let o=new Uint8Array(1+a.length+e.data.length+i.data.length+s.data.length);o[0]=2,o.set(a,1),o.set(e.data,1+a.length),o.set(i.data,1+a.length+e.data.length),o.set(s.data,1+a.length+e.data.length+i.data.length),t.codecInfo.codec="vorbis",t.description=o,t.lastMetadataPacket=s;let c=le(e.data);t.numberOfChannels=c.getUint8(11),t.sampleRate=c.getUint32(12,!0);let l=c.getUint8(28);t.codecInfo.vorbisInfo={blocksizes:[1<<(l&15),1<<(l>>4)],modeBlockflags:za(s.data).modeBlockflags},$i(i.data.subarray(7),this.metadataTags)}async readOpusMetadata(e,t){let r=await this.findNextPacketStart(e);if(!r)return;let i=await this.readPacket(r.startPage,r.startSegmentIndex);if(!i)return;t.codecInfo.codec="opus",t.description=e.data,t.lastMetadataPacket=i;let s=hi(e.data);t.numberOfChannels=s.outputChannelCount,t.sampleRate=pr,t.codecInfo.opusInfo={preSkip:s.preSkip},$i(i.data.subarray(8),this.metadataTags)}async readPacket(e,t){d(t<e.lacingValues.length);let r=0;for(let u=0;u<t;u++)r+=e.lacingValues[u];let i=e,s=r,a=t,n=[];e:for(;;){let u=this.reader.requestSlice(i.dataStartPos,i.dataSize);u instanceof Promise&&(u=await u),d(u);let h=K(u,i.dataSize);for(;;){if(a===i.lacingValues.length){n.push(h.subarray(r,s));break}let w=i.lacingValues[a];if(s+=w,w<255){n.push(h.subarray(r,s));break e}a++}let f=i.headerStartPos+i.totalSize;for(;;){let w=this.reader.requestSliceRange(f,ar,vr);if(w instanceof Promise&&(w=await w),!w)return null;let b=Qr(w);if(!b)return null;if(i=b,i.serialNumber===e.serialNumber)break;f=i.headerStartPos+i.totalSize}r=0,s=0,a=0}let o=n.reduce((u,h)=>u+h.length,0),c=new Uint8Array(o),l=0;for(let u=0;u<n.length;u++){let h=n[u];c.set(h,l),l+=h.length}return{data:c,endPage:i,endSegmentIndex:a}}async findNextPacketStart(e){if(e.endSegmentIndex<e.endPage.lacingValues.length-1)return{startPage:e.endPage,startSegmentIndex:e.endSegmentIndex+1};if(!!(e.endPage.headerType&4))return null;let r=e.endPage.headerStartPos+e.endPage.totalSize;for(;;){let i=this.reader.requestSliceRange(r,ar,vr);if(i instanceof Promise&&(i=await i),!i)return null;let s=Qr(i);if(!s)return null;if(s.serialNumber===e.endPage.serialNumber)return{startPage:s,startSegmentIndex:0};r=s.headerStartPos+s.totalSize}}async getMimeType(){await this.readMetadata();let e=await Promise.all(this.tracks.map(t=>t.getCodecParameterString()));return dn({codecStrings:e.filter(Boolean)})}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){let e=await this.getTracks(),t=await Promise.all(e.map(r=>r.computeDuration()));return Math.max(0,...t)}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},Cl=class{constructor(e,t){this.bitstream=e,this.demuxer=t,this.encodedPacketToMetadata=new WeakMap,this.sequentialScanCache=[],this.sequentialScanMutex=new xt,this.internalSampleRate=e.codecInfo.codec==="opus"?pr:e.sampleRate}getId(){return this.bitstream.serialNumber}getNumberOfChannels(){return this.bitstream.numberOfChannels}getSampleRate(){return this.bitstream.sampleRate}getTimeResolution(){return this.bitstream.sampleRate}getCodec(){return this.bitstream.codecInfo.codec}getInternalCodecId(){return null}async getDecoderConfig(){return d(this.bitstream.codecInfo.codec),{codec:this.bitstream.codecInfo.codec,numberOfChannels:this.bitstream.numberOfChannels,sampleRate:this.bitstream.sampleRate,description:this.bitstream.description??void 0}}getName(){return null}getLanguageCode(){return je}async getFirstTimestamp(){return 0}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}granulePositionToTimestampInSamples(e){return this.bitstream.codecInfo.codec==="opus"?(d(this.bitstream.codecInfo.opusInfo),e-this.bitstream.codecInfo.opusInfo.preSkip):e}createEncodedPacketFromOggPacket(e,t,r){if(!e)return null;let{durationInSamples:i,vorbisBlockSize:s}=un(e.data,this.bitstream.codecInfo,t.vorbisLastBlocksize),a=new we(r.metadataOnly?tt:e.data,"key",Math.max(0,t.timestampInSamples)/this.internalSampleRate,i/this.internalSampleRate,e.endPage.headerStartPos+e.endSegmentIndex,e.data.byteLength);return this.encodedPacketToMetadata.set(a,{packet:e,timestampInSamples:t.timestampInSamples,durationInSamples:i,vorbisLastBlockSize:t.vorbisLastBlocksize,vorbisBlockSize:s}),a}async getFirstPacket(e){d(this.bitstream.lastMetadataPacket);let t=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!t)return null;let r=0;this.bitstream.codecInfo.codec==="opus"&&(d(this.bitstream.codecInfo.opusInfo),r-=this.bitstream.codecInfo.opusInfo.preSkip);let i=await this.demuxer.readPacket(t.startPage,t.startSegmentIndex);return this.createEncodedPacketFromOggPacket(i,{timestampInSamples:r,vorbisLastBlocksize:null},e)}async getNextPacket(e,t){let r=this.encodedPacketToMetadata.get(e);if(!r)throw new Error("Packet was not created from this track.");let i=await this.demuxer.findNextPacketStart(r.packet);if(!i)return null;let s=r.timestampInSamples+r.durationInSamples,a=await this.demuxer.readPacket(i.startPage,i.startSegmentIndex);return this.createEncodedPacketFromOggPacket(a,{timestampInSamples:s,vorbisLastBlocksize:r.vorbisBlockSize},t)}async getPacket(e,t){if(this.demuxer.reader.fileSize===null)return this.getPacketSequential(e,t);let r=ni(e*this.internalSampleRate,14);if(r===0)return this.getFirstPacket(t);if(r<0)return null;d(this.bitstream.lastMetadataPacket);let i=await this.demuxer.findNextPacketStart(this.bitstream.lastMetadataPacket);if(!i)return null;let s=i.startPage,a=this.demuxer.reader.fileSize,n=[s];e:for(;s.headerStartPos+s.totalSize<a;){let k=s.headerStartPos,T=Math.floor((k+a)/2),_=T;for(;;){let x=Math.min(_+hn,a-ar),B=this.demuxer.reader.requestSlice(_,x-_);if(B instanceof Promise&&(B=await B),d(B),!vl(B,x)){a=T+ar;continue e}let M=this.demuxer.reader.requestSliceRange(B.filePos,ar,vr);M instanceof Promise&&(M=await M),d(M);let V=Qr(M);d(V);let he=!1;if(V.serialNumber===this.bitstream.serialNumber)he=!0;else{let W=this.demuxer.reader.requestSlice(V.headerStartPos,V.totalSize);W instanceof Promise&&(W=await W),d(W);let ee=K(W,V.totalSize);he=ln(ee)===V.checksum}if(!he){_=V.headerStartPos+4;continue}if(he&&V.serialNumber!==this.bitstream.serialNumber){_=V.headerStartPos+V.totalSize;continue}if(V.granulePosition===-1){_=V.headerStartPos+V.totalSize;continue}this.granulePositionToTimestampInSamples(V.granulePosition)>r?a=V.headerStartPos:(s=V,n.push(V));continue e}}let o=i.startPage;for(let k of n){if(k.granulePosition===s.granulePosition)break;(!o||k.headerStartPos>o.headerStartPos)&&(o=k)}let c=o,l=[c];for(;!(c.serialNumber===this.bitstream.serialNumber&&c.granulePosition===s.granulePosition);){let k=c.headerStartPos+c.totalSize,T=this.demuxer.reader.requestSliceRange(k,ar,vr);T instanceof Promise&&(T=await T),d(T);let _=Qr(T);d(_),c=_,c.serialNumber===this.bitstream.serialNumber&&l.push(c)}d(c.granulePosition!==-1);let u=null,h,f,w=c,b=0;if(c.headerStartPos===i.startPage.headerStartPos)h=this.granulePositionToTimestampInSamples(0),f=!0,u=0;else{h=0,f=!1;for(let _=c.lacingValues.length-1;_>=0;_--)if(c.lacingValues[_]<255){u=_+1;break}if(u===null)throw new Error("Invalid page with granule position: no packets end on this page.");b=u-1;let k={data:tt,endPage:w,endSegmentIndex:b};if(await this.demuxer.findNextPacketStart(k)){let _=mn(l,c,u);d(_);let x=fn(l,_.page,_.segmentIndex);x&&(c=x.page,u=x.segmentIndex)}else for(;;){let _=mn(l,c,u);if(!_)break;let x=fn(l,_.page,_.segmentIndex);if(!x)break;if(c=x.page,u=x.segmentIndex,_.page.headerStartPos!==w.headerStartPos){w=_.page,b=_.segmentIndex;break}}}let p=null,y=null;for(;c!==null;){d(u!==null);let k=await this.demuxer.readPacket(c,u);if(!k)break;if(!(c.headerStartPos===i.startPage.headerStartPos&&u<i.startSegmentIndex)){let x=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:h,vorbisLastBlocksize:y?.vorbisBlockSize??null},t);d(x);let B=this.encodedPacketToMetadata.get(x);if(d(B),!f&&k.endPage.headerStartPos===w.headerStartPos&&k.endSegmentIndex===b?(h=this.granulePositionToTimestampInSamples(c.granulePosition),f=!0,x=this.createEncodedPacketFromOggPacket(k,{timestampInSamples:h-B.durationInSamples,vorbisLastBlocksize:y?.vorbisBlockSize??null},t),d(x),B=this.encodedPacketToMetadata.get(x),d(B)):h+=B.durationInSamples,p=x,y=B,f&&(Math.max(h,0)>r||Math.max(B.timestampInSamples,0)===r))break}let _=await this.demuxer.findNextPacketStart(k);if(!_)break;c=_.startPage,u=_.startSegmentIndex}return p}async getPacketSequential(e,t){let r=await this.sequentialScanMutex.acquire();try{let i=ni(e*this.internalSampleRate,14);e=i/this.internalSampleRate;let s=ue(this.sequentialScanCache,i,o=>o.timestampInSamples),a;if(s!==-1){let o=this.sequentialScanCache[s];a=this.createEncodedPacketFromOggPacket(o.packet,{timestampInSamples:o.timestampInSamples,vorbisLastBlocksize:o.vorbisLastBlockSize},t)}else a=await this.getFirstPacket(t);let n=0;for(;a&&a.timestamp<e;){let o=await this.getNextPacket(a,t);if(!o||o.timestamp>e)break;if(a=o,n++,n===100){n=0;let c=this.encodedPacketToMetadata.get(a);d(c),this.sequentialScanCache.length>0&&d(de(this.sequentialScanCache).timestampInSamples<=c.timestampInSamples),this.sequentialScanCache.push(c)}}return a}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},fn=(e,t,r)=>{let i=t,s=r;e:for(;;){for(s--,s;s>=0;s--)if(i.lacingValues[s]<255){s++;break e}if(d(s===-1),!(i.headerType&1)){s=0;break}let n=na(e,o=>o.headerStartPos<i.headerStartPos);if(!n)return null;i=n,s=i.lacingValues.length}if(d(s!==-1),s===i.lacingValues.length){let a=e[e.indexOf(i)+1];d(a),i=a,s=0}return{page:i,segmentIndex:s}},mn=(e,t,r)=>{if(r>0)return{page:t,segmentIndex:r-1};let i=na(e,s=>s.headerStartPos<t.headerStartPos);return i?{page:i,segmentIndex:i.lacingValues.length-1}:null},xl=class extends rr{constructor(e){super(e),this.metadataPromise=null,this.dataStart=-1,this.dataSize=-1,this.audioInfo=null,this.tracks=[],this.lastKnownPacketIndex=0,this.metadataTags={},this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{let e=this.reader.requestSlice(0,12);e instanceof Promise&&(e=await e),d(e);let t=Ee(e,4),r=t!=="RIFX",i=t==="RF64",s=$t(e,r),a=i?this.reader.fileSize:Math.min(s+8,this.reader.fileSize??1/0);if(Ee(e,4)!=="WAVE")throw new Error("Invalid WAVE file - wrong format");let o=0,c=null,l=e.filePos;for(;a===null||l<a;){let h=this.reader.requestSlice(l,8);if(h instanceof Promise&&(h=await h),!h)break;let f=Ee(h,4),w=$t(h,r),b=h.filePos;if(i&&o===0&&f!=="ds64")throw new Error('Invalid RF64 file: First chunk must be "ds64".');if(f==="fmt ")await this.parseFmtChunk(b,w,r);else if(f==="data"){if(c??(c=w),this.dataStart=h.filePos,this.dataSize=Math.min(c,(a??1/0)-this.dataStart),this.reader.fileSize===null)break}else if(f==="ds64"){let p=this.reader.requestSlice(b,w);if(p instanceof Promise&&(p=await p),!p)break;let y=Un(p,r);c=Un(p,r),a=Math.min(y+8,this.reader.fileSize??1/0)}else f==="LIST"?await this.parseListChunk(b,w,r):(f==="ID3 "||f==="id3 ")&&await this.parseId3Chunk(b,w);l=b+w+(w&1),o++}if(!this.audioInfo)throw new Error('Invalid WAVE file - missing "fmt " chunk');if(this.dataStart===-1)throw new Error('Invalid WAVE file - missing "data" chunk');let u=this.audioInfo.blockSizeInBytes;this.dataSize=Math.floor(this.dataSize/u)*u,this.tracks.push(new ot(this.input,new Pl(this)))})())}async parseFmtChunk(e,t,r){let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;let s=Kr(i,r),a=Kr(i,r),n=$t(i,r);i.skip(4);let o=Kr(i,r),c;if(t===14?c=8:c=Kr(i,r),t>=18&&s!==357){let l=Kr(i,r),u=t-18;if(Math.min(u,l)>=22&&s===65534){i.skip(6);let f=K(i,16);s=f[0]|f[1]<<8}}(s===7||s===6)&&(c=8),this.audioInfo={format:s,numberOfChannels:a,sampleRate:n,sampleSizeInBytes:Math.ceil(c/8),blockSizeInBytes:o}}async parseListChunk(e,t,r){var n,o,c,l,u,h,f,w,b,p,y;let i=this.reader.requestSlice(e,t);if(i instanceof Promise&&(i=await i),!i)return;let s=Ee(i,4);if(s!=="INFO"&&s!=="INF0")return;let a=i.filePos;for(;a<=e+t-8;){i.filePos=a;let k=Ee(i,4),T=$t(i,r),_=K(i,T),x=0;for(let I=0;I<_.length&&_[I]!==0;I++)x++;let B=String.fromCharCode(..._.subarray(0,x));switch((n=this.metadataTags).raw??(n.raw={}),this.metadataTags.raw[k]=B,k){case"INAM":case"TITL":(o=this.metadataTags).title??(o.title=B);break;case"TIT3":(c=this.metadataTags).description??(c.description=B);break;case"IART":(l=this.metadataTags).artist??(l.artist=B);break;case"IPRD":(u=this.metadataTags).album??(u.album=B);break;case"IPRT":case"ITRK":case"TRCK":{let I=B.split("/"),M=Number.parseInt(I[0],10),V=I[1]&&Number.parseInt(I[1],10);Number.isInteger(M)&&M>0&&((h=this.metadataTags).trackNumber??(h.trackNumber=M)),V&&Number.isInteger(V)&&V>0&&((f=this.metadataTags).tracksTotal??(f.tracksTotal=V))}break;case"ICRD":case"IDIT":{let I=new Date(B);Number.isNaN(I.getTime())||((w=this.metadataTags).date??(w.date=I))}break;case"YEAR":{let I=Number.parseInt(B,10);Number.isInteger(I)&&I>0&&((b=this.metadataTags).date??(b.date=new Date(I,0,1)))}break;case"IGNR":case"GENR":(p=this.metadataTags).genre??(p.genre=B);break;case"ICMT":case"CMNT":case"COMM":(y=this.metadataTags).comment??(y.comment=B);break}a+=8+T+(T&1)}}async parseId3Chunk(e,t){let r=this.reader.requestSlice(e,t);if(r instanceof Promise&&(r=await r),!r)return;let i=Si(r);if(i){let s=r.slice(e+10,i.size);nn(s,i,this.metadataTags)}}getCodec(){if(d(this.audioInfo),this.audioInfo.format===7)return"ulaw";if(this.audioInfo.format===6)return"alaw";if(this.audioInfo.format===1){if(this.audioInfo.sampleSizeInBytes===1)return"pcm-u8";if(this.audioInfo.sampleSizeInBytes===2)return"pcm-s16";if(this.audioInfo.sampleSizeInBytes===3)return"pcm-s24";if(this.audioInfo.sampleSizeInBytes===4)return"pcm-s32"}return this.audioInfo.format===3&&this.audioInfo.sampleSizeInBytes===4?"pcm-f32":null}async getMimeType(){return"audio/wav"}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return d(e),e.computeDuration()}async getTracks(){return await this.readMetadata(),this.tracks}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}},_r=2048,Pl=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return this.demuxer.getCodec()}getInternalCodecId(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.format}async getDecoderConfig(){let e=this.demuxer.getCodec();return e?(d(this.demuxer.audioInfo),{codec:e,numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate}):null}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getNumberOfChannels(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}getSampleRate(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getTimeResolution(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return je}async getFirstTimestamp(){return 0}async getPacketAtIndex(e,t){d(this.demuxer.audioInfo);let r=e*_r*this.demuxer.audioInfo.blockSizeInBytes;if(r>=this.demuxer.dataSize)return null;let i=Math.min(_r*this.demuxer.audioInfo.blockSizeInBytes,this.demuxer.dataSize-r);if(this.demuxer.reader.fileSize===null){let o=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);if(o instanceof Promise&&(o=await o),!o)return null}let s;if(t.metadataOnly)s=tt;else{let o=this.demuxer.reader.requestSlice(this.demuxer.dataStart+r,i);o instanceof Promise&&(o=await o),d(o),s=K(o,i)}let a=e*_r/this.demuxer.audioInfo.sampleRate,n=i/this.demuxer.audioInfo.blockSizeInBytes/this.demuxer.audioInfo.sampleRate;return this.demuxer.lastKnownPacketIndex=Math.max(e,a),new we(s,"key",a,n,e,i)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getPacket(e,t){d(this.demuxer.audioInfo);let r=Math.floor(Math.min(e*this.demuxer.audioInfo.sampleRate/_r,(this.demuxer.dataSize-1)/(_r*this.demuxer.audioInfo.blockSizeInBytes))),i=await this.getPacketAtIndex(r,t);if(i)return i;if(r===0)return null;d(this.demuxer.reader.fileSize===null);let s=await this.getPacketAtIndex(this.demuxer.lastKnownPacketIndex,t);for(;s;){let a=await this.getNextPacket(s,t);if(!a)break;s=a}return s}getNextPacket(e,t){d(this.demuxer.audioInfo);let r=Math.round(e.timestamp*this.demuxer.audioInfo.sampleRate/_r);return this.getPacketAtIndex(r+1,t)}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},vi=7,_i=9,gs=e=>{let t=e.filePos,r=K(e,9),i=new ce(r);if(i.readBits(12)!==4095||(i.skipBits(1),i.readBits(2)!==0))return null;let n=i.readBits(1),o=i.readBits(2)+1,c=i.readBits(4);if(c===15)return null;i.skipBits(1);let l=i.readBits(3);if(l===0)throw new Error("ADTS frames with channel configuration 0 are not supported.");i.skipBits(1),i.skipBits(1),i.skipBits(1),i.skipBits(1);let u=i.readBits(13);i.skipBits(11);let h=i.readBits(2)+1;if(h!==1)throw new Error("ADTS frames with more than one AAC frame are not supported.");let f=null;return n===1?e.filePos-=2:f=i.readBits(16),{objectType:o,samplingFrequencyIndex:c,channelConfiguration:l,frameLength:u,numberOfAacFrames:h,crcCheck:f,startPos:t}},ws=1024,Il=class extends rr{constructor(e){super(e),this.metadataPromise=null,this.firstFrameHeader=null,this.loadedSamples=[],this.tracks=[],this.readingMutex=new xt,this.lastSampleLoaded=!1,this.lastLoadedPos=0,this.nextTimestampInSamples=0,this.reader=e._reader}async readMetadata(){return this.metadataPromise??(this.metadataPromise=(async()=>{for(;!this.firstFrameHeader&&!this.lastSampleLoaded;)await this.advanceReader();d(this.firstFrameHeader),this.tracks=[new ot(this.input,new El(this))]})())}async advanceReader(){let e=this.reader.requestSliceRange(this.lastLoadedPos,vi,_i);if(e instanceof Promise&&(e=await e),!e){this.lastSampleLoaded=!0;return}let t=gs(e);if(!t){this.lastSampleLoaded=!0;return}if(this.reader.fileSize!==null&&t.startPos+t.frameLength>this.reader.fileSize){this.lastSampleLoaded=!0;return}this.firstFrameHeader||(this.firstFrameHeader=t);let r=ui[t.samplingFrequencyIndex];d(r!==void 0);let i=ws/r,s=t.crcCheck?_i:vi,a={timestamp:this.nextTimestampInSamples/r,duration:i,dataStart:t.startPos+s,dataSize:t.frameLength-s};this.loadedSamples.push(a),this.nextTimestampInSamples+=ws,this.lastLoadedPos=t.startPos+t.frameLength}async getMimeType(){return"audio/aac"}async getTracks(){return await this.readMetadata(),this.tracks}async computeDuration(){await this.readMetadata();let e=this.tracks[0];return d(e),e.computeDuration()}async getMetadataTags(){return{}}},El=class{constructor(e){this.demuxer=e}getId(){return 1}async getFirstTimestamp(){return 0}getTimeResolution(){return this.getSampleRate()/ws}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getName(){return null}getLanguageCode(){return je}getCodec(){return"aac"}getInternalCodecId(){return d(this.demuxer.firstFrameHeader),this.demuxer.firstFrameHeader.objectType}getNumberOfChannels(){d(this.demuxer.firstFrameHeader);let e=Ta[this.demuxer.firstFrameHeader.channelConfiguration];return d(e!==void 0),e}getSampleRate(){d(this.demuxer.firstFrameHeader);let e=ui[this.demuxer.firstFrameHeader.samplingFrequencyIndex];return d(e!==void 0),e}async getDecoderConfig(){d(this.demuxer.firstFrameHeader);let e=new Uint8Array(3),t=new ce(e),{objectType:r,samplingFrequencyIndex:i,channelConfiguration:s}=this.demuxer.firstFrameHeader;return r>31?(t.writeBits(5,31),t.writeBits(6,r-32)):t.writeBits(5,r),t.writeBits(4,i),t.writeBits(4,s),{codec:"mp4a.40.".concat(this.demuxer.firstFrameHeader.objectType),numberOfChannels:this.getNumberOfChannels(),sampleRate:this.getSampleRate(),description:e.subarray(0,Math.ceil((t.pos-1)/8))}}async getPacketAtIndex(e,t){if(e===-1)return null;let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=tt;else{let s=this.demuxer.reader.requestSlice(r.dataStart,r.dataSize);if(s instanceof Promise&&(s=await s),!s)return null;i=K(s,r.dataSize)}return new we(i,"key",r.timestamp,r.duration,e,r.dataSize)}getFirstPacket(e){return this.getPacketAtIndex(0,e)}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=Di(this.demuxer.loadedSamples,e.timestamp,a=>a.timestamp);if(i===-1)throw new Error("Packet was not created from this track.");let s=i+1;for(;s>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(s,t)}finally{r()}}async getPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=ue(this.demuxer.loadedSamples,e,s=>s.timestamp);if(i===-1&&this.demuxer.loadedSamples.length>0)return null;if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(i,t);if(i>=0&&i+1<this.demuxer.loadedSamples.length)return this.getPacketAtIndex(i,t);await this.demuxer.advanceReader()}}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}},pn=e=>e===0?null:e===1?192:e>=2&&e<=5?144*2**e:e===6?"uncommon-u8":e===7?"uncommon-u16":e>=8&&e<=15?2**e:null,Al=(e,t)=>{switch(e){case 0:return t;case 1:return 88200;case 2:return 176400;case 3:return 192e3;case 4:return 8e3;case 5:return 16e3;case 6:return 22050;case 7:return 24e3;case 8:return 32e3;case 9:return 44100;case 10:return 48e3;case 11:return 96e3;case 12:return"uncommon-u8";case 13:return"uncommon-u16";case 14:return"uncommon-u16-10";default:return null}},gn=e=>{let t=0,r=new ce(K(e,1));for(;r.readBits(1)===1;)t++;if(t===0)return r.readBits(7);let i=[],s=t-1,a=new ce(K(e,s)),n=8-t-1;for(let c=0;c<n;c++)i.unshift(r.readBits(1));for(let c=0;c<s;c++)for(let l=0;l<8;l++){let u=a.readBits(1);l<2||i.unshift(u)}return i.reduce((c,l,u)=>c|l<<u,0)},wn=(e,t)=>{if(t==="uncommon-u16")return Be(e)+1;if(t==="uncommon-u8")return H(e)+1;if(typeof t=="number")return t;Re(t),d(!1)},Bl=(e,t)=>t==="uncommon-u16"?Be(e):t==="uncommon-u16-10"?Be(e)*10:t==="uncommon-u8"?H(e):typeof t=="number"?t:null,Fl=e=>{let r=0;for(let i of e){r^=i;for(let s=0;s<8;s++)(r&128)!==0?r=r<<1^7:r<<=1,r&=255}return r},Ml=class extends rr{constructor(e){super(e),this.loadedSamples=[],this.metadataPromise=null,this.track=null,this.metadataTags={},this.audioInfo=null,this.lastLoadedPos=null,this.blockingBit=null,this.readingMutex=new xt,this.lastSampleLoaded=!1,this.reader=e._reader}async computeDuration(){return await this.readMetadata(),d(this.track),this.track.computeDuration()}async getMetadataTags(){return await this.readMetadata(),this.metadataTags}async getTracks(){return await this.readMetadata(),d(this.track),[this.track]}async getMimeType(){return"audio/flac"}async readMetadata(){let e=4;return this.metadataPromise??(this.metadataPromise=(async()=>{var t;for(;this.reader.fileSize===null||e<this.reader.fileSize;){let r=this.reader.requestSlice(e,4);if(r instanceof Promise&&(r=await r),e+=4,r===null)throw new Error("Metadata block at position ".concat(e," is too small! Corrupted file."));d(r);let i=H(r),s=Cr(r),a=(i&128)!==0;switch(i&127){case 0:{let o=this.reader.requestSlice(e,s);if(o instanceof Promise&&(o=await o),d(o),o===null)throw new Error("StreamInfo block at position ".concat(e," is too small! Corrupted file."));let c=K(o,34),l=new ce(c),u=l.readBits(16),h=l.readBits(16),f=l.readBits(24),w=l.readBits(24),b=l.readBits(20),p=l.readBits(3)+1;l.readBits(5);let y=l.readBits(36);l.skipBits(128);let k=new Uint8Array(42);k.set(new Uint8Array([102,76,97,67]),0),k.set(new Uint8Array([128,0,0,34]),4),k.set(c,8),this.audioInfo={numberOfChannels:p,sampleRate:b,totalSamples:y,minimumBlockSize:u,maximumBlockSize:h,minimumFrameSize:f,maximumFrameSize:w,description:k},this.track=new ot(this.input,new zl(this));break}case 4:{let o=this.reader.requestSlice(e,s);o instanceof Promise&&(o=await o),d(o),$i(K(o,s),this.metadataTags);break}case 6:{let o=this.reader.requestSlice(e,s);o instanceof Promise&&(o=await o),d(o);let c=O(o),l=O(o),u=Ce.decode(K(o,l)),h=O(o),f=Ce.decode(K(o,h));o.skip(16);let w=O(o),b=K(o,w);(t=this.metadataTags).images??(t.images=[]),this.metadataTags.images.push({data:b,mimeType:u,kind:c===3?"coverFront":c===4?"coverBack":"unknown",description:f});break}default:break}if(e+=s,a){this.lastLoadedPos=e;break}}})())}async readNextFlacFrame({startPos:e,isFirstPacket:t}){d(this.audioInfo);let r=6,s=this.audioInfo.maximumFrameSize+16,a=await this.reader.requestSliceRange(e,this.audioInfo.minimumFrameSize,s);if(!a)return null;let n=this.readFlacFrameHeader({slice:a,isFirstPacket:t});if(!n)return null;for(a.filePos=e+this.audioInfo.minimumFrameSize;;){if(a.filePos>a.end-r)return{num:n.num,blockSize:n.blockSize,sampleRate:n.sampleRate,size:a.end-e,isLastFrame:!0};if(H(a)===255){let c=H(a),l=this.blockingBit===1?249:248;if(c!==l){a.skip(-1);continue}a.skip(-2);let u=a.filePos-e;if(!this.readFlacFrameHeader({slice:a,isFirstPacket:!1})){a.skip(-1);continue}return{num:n.num,blockSize:n.blockSize,sampleRate:n.sampleRate,size:u,isLastFrame:!1}}}}readFlacFrameHeader({slice:e,isFirstPacket:t}){let r=e.filePos,i=K(e,4),s=new ce(i);if(s.readBits(15)!==32764)return null;if(this.blockingBit===null){d(t);let p=s.readBits(1);this.blockingBit=p}else if(this.blockingBit===1){if(d(!t),s.readBits(1)!==1)return null}else if(this.blockingBit===0){if(d(!t),s.readBits(1)!==0)return null}else throw new Error("Invalid blocking bit");let n=pn(s.readBits(4));if(!n)return null;d(this.audioInfo);let o=Al(s.readBits(4),this.audioInfo.sampleRate);if(!o||(s.readBits(4),s.readBits(3),s.readBits(1)!==0))return null;let l=gn(e),u=wn(e,n),h=Bl(e,o);if(h===null)return null;let f=e.filePos-r,w=H(e);e.skip(-f),e.skip(-1);let b=Fl(K(e,f));return w!==b?null:{num:l,blockSize:u,sampleRate:h}}async advanceReader(){await this.readMetadata(),d(this.lastLoadedPos!==null),d(this.audioInfo);let e=this.lastLoadedPos,t=await this.readNextFlacFrame({startPos:e,isFirstPacket:this.loadedSamples.length===0});if(!t){this.lastSampleLoaded=!0;return}let r=this.loadedSamples[this.loadedSamples.length-1],s={blockOffset:r?r.blockOffset+r.blockSize:0,blockSize:t.blockSize,byteOffset:e,byteSize:t.size};if(this.lastLoadedPos=this.lastLoadedPos+t.size,this.loadedSamples.push(s),t.isLastFrame){this.lastSampleLoaded=!0;return}}},zl=class{constructor(e){this.demuxer=e}getId(){return 1}getCodec(){return"flac"}getInternalCodecId(){return null}getNumberOfChannels(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.numberOfChannels}async computeDuration(){let e=await this.getPacket(1/0,{metadataOnly:!0});return(e?.timestamp??0)+(e?.duration??0)}getSampleRate(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}getName(){return null}getLanguageCode(){return je}getTimeResolution(){return d(this.demuxer.audioInfo),this.demuxer.audioInfo.sampleRate}async getFirstTimestamp(){return 0}async getDecoderConfig(){return d(this.demuxer.audioInfo),{codec:"flac",numberOfChannels:this.demuxer.audioInfo.numberOfChannels,sampleRate:this.demuxer.audioInfo.sampleRate,description:this.demuxer.audioInfo.description}}async getPacket(e,t){if(d(this.demuxer.audioInfo),e<0)throw new Error("Timestamp cannot be negative");let r=await this.demuxer.readingMutex.acquire();try{for(;;){let i=ue(this.demuxer.loadedSamples,e,o=>o.blockOffset/this.demuxer.audioInfo.sampleRate);if(i===-1){await this.demuxer.advanceReader();continue}let s=this.demuxer.loadedSamples[i],a=s.blockOffset/this.demuxer.audioInfo.sampleRate,n=s.blockSize/this.demuxer.audioInfo.sampleRate;if(a+n<=e){if(this.demuxer.lastSampleLoaded)return this.getPacketAtIndex(this.demuxer.loadedSamples.length-1,t);await this.demuxer.advanceReader();continue}return this.getPacketAtIndex(i,t)}}finally{r()}}async getNextPacket(e,t){let r=await this.demuxer.readingMutex.acquire();try{let i=e.sequenceNumber+1;if(this.demuxer.lastSampleLoaded&&i>=this.demuxer.loadedSamples.length)return null;for(;i>=this.demuxer.loadedSamples.length&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(i,t)}finally{r()}}getKeyPacket(e,t){return this.getPacket(e,t)}getNextKeyPacket(e,t){return this.getNextPacket(e,t)}async getPacketAtIndex(e,t){let r=this.demuxer.loadedSamples[e];if(!r)return null;let i;if(t.metadataOnly)i=tt;else{let n=this.demuxer.reader.requestSlice(r.byteOffset,r.byteSize);if(n instanceof Promise&&(n=await n),!n)return null;i=K(n,r.byteSize)}d(this.demuxer.audioInfo);let s=r.blockOffset/this.demuxer.audioInfo.sampleRate,a=r.blockSize/this.demuxer.audioInfo.sampleRate;return new we(i,"key",s,a,e,r.byteSize)}async getFirstPacket(e){for(;this.demuxer.loadedSamples.length===0&&!this.demuxer.lastSampleLoaded;)await this.demuxer.advanceReader();return this.getPacketAtIndex(0,e)}},Bt=class{},bs=class extends Bt{async _getMajorBrand(e){let t=e._reader.requestSlice(0,12);return t instanceof Promise&&(t=await t),!t||(t.skip(4),Ee(t,4)!=="ftyp")?null:Ee(t,4)}_createDemuxer(e){return new el(e)}},bn=class extends bs{async _canReadInput(e){let t=await this._getMajorBrand(e);return!!t&&t!=="qt  "}get name(){return"MP4"}get mimeType(){return"video/mp4"}},kn=class extends bs{async _canReadInput(e){return await this._getMajorBrand(e)==="qt  "}get name(){return"QuickTime File Format"}get mimeType(){return"video/quicktime"}},ks=class extends Bt{async isSupportedEBMLOfDocType(e,t){let r=e._reader.requestSlice(0,Et);if(r instanceof Promise&&(r=await r),!r)return!1;let i=Xa(r);if(i===null||i<1||i>8||ae(r,i)!==440786851)return!1;let a=Ya(r);if(a===null)return!1;let n=e._reader.requestSlice(r.filePos,a);if(n instanceof Promise&&(n=await n),!n)return!1;let o=r.filePos;for(;n.filePos<=o+a-ct;){let c=At(n);if(!c)break;let{id:l,size:u}=c,h=n.filePos;if(u===null)return!1;switch(l){case 17030:if(ae(n,u)!==1)return!1;break;case 17143:if(ae(n,u)!==1)return!1;break;case 17026:if(yr(n,u)!==t)return!1;break;case 17031:if(ae(n,u)>4)return!1;break}n.filePos=h+u}return!0}_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"matroska")}_createDemuxer(e){return new hl(e)}get name(){return"Matroska"}get mimeType(){return"video/x-matroska"}},yn=class extends ks{_canReadInput(e){return this.isSupportedEBMLOfDocType(e,"webm")}get name(){return"WebM"}get mimeType(){return"video/webm"}},Tn=class extends Bt{async _canReadInput(e){let t=e._reader.requestSlice(0,10);if(t instanceof Promise&&(t=await t),!t)return!1;let r=0,i=!1;for(;;){let c=e._reader.requestSlice(r,Ti);if(c instanceof Promise&&(c=await c),!c)break;let l=Si(c);if(!l)break;i=!0,r=c.filePos+l.size}let s=await ms(e._reader,r,r+4096);if(!s)return!1;if(i)return!0;r=s.startPos+s.header.totalSize;let a=await ms(e._reader,r,r+rn);if(!a)return!1;let n=s.header,o=a.header;return!(n.channel!==o.channel||n.sampleRate!==o.sampleRate)}_createDemuxer(e){return new yl(e)}get name(){return"MP3"}get mimeType(){return"audio/mpeg"}},Sn=class extends Bt{async _canReadInput(e){let t=e._reader.requestSlice(0,12);if(t instanceof Promise&&(t=await t),!t)return!1;let r=Ee(t,4);return r!=="RIFF"&&r!=="RIFX"&&r!=="RF64"?!1:(t.skip(4),Ee(t,4)==="WAVE")}_createDemuxer(e){return new xl(e)}get name(){return"WAVE"}get mimeType(){return"audio/wav"}},vn=class extends Bt{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Ee(t,4)==="OggS":!1}_createDemuxer(e){return new _l(e)}get name(){return"Ogg"}get mimeType(){return"application/ogg"}},_n=class extends Bt{async _canReadInput(e){let t=e._reader.requestSlice(0,4);return t instanceof Promise&&(t=await t),t?Ee(t,4)==="fLaC":!1}get name(){return"FLAC"}get mimeType(){return"audio/flac"}_createDemuxer(e){return new Ml(e)}},Cn=class extends Bt{async _canReadInput(e){let t=e._reader.requestSliceRange(0,vi,_i);if(t instanceof Promise&&(t=await t),!t)return!1;let r=gs(t);if(!r||(t=e._reader.requestSliceRange(r.frameLength,vi,_i),t instanceof Promise&&(t=await t),!t))return!1;let i=gs(t);return i?r.objectType===i.objectType&&r.samplingFrequencyIndex===i.samplingFrequencyIndex&&r.channelConfiguration===i.channelConfiguration:!1}_createDemuxer(e){return new Il(e)}get name(){return"ADTS"}get mimeType(){return"audio/aac"}},xn=new bn,Pn=new kn,In=new ks,En=new yn,An=new Tn,Bn=new Sn,Fn=new vn,Mn=new Cn,zn=new _n,Rl=[xn,Pn,In,En,Bn,Fn,zn,An,Mn],Rn=Se(Je(),1),Dl=typeof Rn<"u"?Rn:void 0,qt=class{constructor(){this._disposed=!1,this._sizePromise=null,this.onread=null}async getSizeOrNull(){if(this._disposed)throw new Ue;return this._sizePromise??(this._sizePromise=Promise.resolve(this._retrieveSize()))}async getSize(){if(this._disposed)throw new Ue;let e=await this.getSizeOrNull();if(e===null)throw new Error("Cannot determine the size of an unsized source.");return e}},Ol=class extends qt{constructor(e){if(!(e instanceof ArrayBuffer)&&!ArrayBuffer.isView(e))throw new TypeError("buffer must be an ArrayBuffer or ArrayBufferView.");super(),this._onreadCalled=!1,this._bytes=ge(e),this._view=le(e)}_retrieveSize(){return this._bytes.byteLength}_read(){return this._onreadCalled||(this.onread?.(0,this._bytes.byteLength),this._onreadCalled=!0),{bytes:this._bytes,view:this._view,offset:0}}_dispose(){}},Nl=class extends qt{constructor(e,t={}){if(!(e instanceof Blob))throw new TypeError("blob must be a Blob.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!mr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._readers=new WeakMap,this._blob=e,this._orchestrator=new Ts({maxCacheSize:t.maxCacheSize??8*2**20,maxWorkerCount:4,runWorker:this._runWorker.bind(this),prefetchProfile:ys.fileSystem})}_retrieveSize(){let e=this._blob.size;return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){let t=this._readers.get(e);for(t===void 0&&("stream"in this._blob?t=this._blob.slice(e.currentPos).stream().getReader():t=null,this._readers.set(e,t));e.currentPos<e.targetPos&&!e.aborted;)if(t){let{done:r,value:i}=await t.read();if(r){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Blob reader stopped unexpectedly before all requested data was read.");break}this.onread?.(e.currentPos,e.currentPos+i.length),this._orchestrator.supplyWorkerData(e,i)}else{let r=await this._blob.slice(e.currentPos,e.targetPos).arrayBuffer();this.onread?.(e.currentPos,e.currentPos+r.byteLength),this._orchestrator.supplyWorkerData(e,new Uint8Array(r))}e.running=!1}_dispose(){this._orchestrator.dispose()}},Dn=.5*2**20,Ul=(e,t,r)=>{if(t instanceof Error&&(t.message.includes("Failed to fetch")||t.message.includes("Load failed")||t.message.includes("NetworkError when attempting to fetch resource"))){let s=null;try{typeof window<"u"&&typeof window.location<"u"&&(s=new URL(r instanceof Request?r.url:r,window.location.href).origin)}catch{}if((typeof navigator<"u"&&typeof navigator.onLine=="boolean"?navigator.onLine:!0)&&s!==null&&s!==window.location.origin)return null}return Math.min(2**(e-2),16)},Ll=class extends qt{constructor(e,t={}){if(typeof e!="string"&&!(e instanceof URL)&&!(typeof Request<"u"&&e instanceof Request))throw new TypeError("url must be a string, URL or Request.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.requestInit!==void 0&&(!t.requestInit||typeof t.requestInit!="object"))throw new TypeError("options.requestInit, when provided, must be an object.");if(t.getRetryDelay!==void 0&&typeof t.getRetryDelay!="function")throw new TypeError("options.getRetryDelay, when provided, must be a function.");if(t.maxCacheSize!==void 0&&(!mr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(t.fetchFn!==void 0&&typeof t.fetchFn!="function")throw new TypeError("options.fetchFn, when provided, must be a function.");super(),this._existingResponses=new WeakMap,this._url=e,this._options=t,this._getRetryDelay=t.getRetryDelay??Ul,this._orchestrator=new Ts({maxCacheSize:t.maxCacheSize??64*2**20,maxWorkerCount:2,runWorker:this._runWorker.bind(this),prefetchProfile:ys.network})}async _retrieveSize(){let e=new AbortController,t=await da(this._options.fetchFn??fetch,this._url,la(this._options.requestInit??{},{headers:{Range:"bytes=0-"},signal:e.signal}),this._getRetryDelay);if(!t.ok)throw new Error("Error fetching ".concat(String(this._url),": ").concat(t.status," ").concat(t.statusText));let r,i;if(t.status===206)i=this._getPartialLengthFromRangeResponse(t),r=this._orchestrator.createWorker(0,Math.min(i,Dn));else{let s=t.headers.get("Content-Length");if(s)i=Number(s),r=this._orchestrator.createWorker(0,i),this._orchestrator.options.maxCacheSize=1/0,console.warn("HTTP server did not respond with 206 Partial Content, meaning the entire remote resource now has to be downloaded. For efficient media file streaming across a network, please make sure your server supports range requests.");else throw new Error("HTTP response (status ".concat(t.status,") must surface Content-Length header."))}return this._orchestrator.fileSize=i,this._existingResponses.set(r,{response:t,abortController:e}),this._orchestrator.runWorker(r),i}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){for(;!e.aborted;){let t=this._existingResponses.get(e);this._existingResponses.delete(e);let r=t?.abortController,i=t?.response;if(r||(r=new AbortController,i=await da(this._options.fetchFn??fetch,this._url,la(this._options.requestInit??{},{headers:{Range:"bytes=".concat(e.currentPos,"-")},signal:r.signal}),this._getRetryDelay)),d(i),!i.ok)throw new Error("Error fetching ".concat(String(this._url),": ").concat(i.status," ").concat(i.statusText));if(e.currentPos>0&&i.status!==206)throw new Error("HTTP server did not respond with 206 Partial Content to a range request. To enable efficient media file streaming across a network, please make sure your server supports range requests.");let s=this._getPartialLengthFromRangeResponse(i),a=e.targetPos-e.currentPos;if(s<a)throw new Error("HTTP response unexpectedly too short: Needed at least ".concat(a," bytes, got only ").concat(s,"."));if(!i.body)throw new Error("Missing HTTP response body stream. The used fetch function must provide the response body as a ReadableStream.");let n=i.body.getReader();for(;;){if(e.currentPos>=e.targetPos||e.aborted){r.abort(),e.running=!1;return}let o;try{o=await n.read()}catch(u){let h=this._getRetryDelay(1,u,this._url);if(h!==null){console.error("Error while reading response stream. Attempting to resume.",u),await new Promise(f=>setTimeout(f,1e3*h));break}else throw u}let{done:c,value:l}=o;if(c){if(this._orchestrator.forgetWorker(e),e.currentPos<e.targetPos)throw new Error("Response stream reader stopped unexpectedly before all requested data was read.");e.running=!1;return}this.onread?.(e.currentPos,e.currentPos+l.length),this._orchestrator.supplyWorkerData(e,l)}}e.running=!1}_getPartialLengthFromRangeResponse(e){let t=e.headers.get("Content-Range");if(t){let r=/\/(\d+)/.exec(t);if(r)return Number(r[1]);throw new Error("Invalid Content-Range header: ".concat(t))}else{let r=e.headers.get("Content-Length");if(r)return Number(r);throw new Error("Partial HTTP response (status 206) must surface either Content-Range or Content-Length header.")}}_dispose(){this._orchestrator.dispose()}},Vl=class extends qt{constructor(e,t={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!mr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._fileHandle=null,this._streamSource=new On({getSize:async()=>(this._fileHandle=await Dl.fs.open(e,"r"),(await this._fileHandle.stat()).size),read:async(r,i)=>{d(this._fileHandle);let s=new Uint8Array(i-r);return await this._fileHandle.read(s,0,i-r,r),s},maxCacheSize:t.maxCacheSize,prefetchProfile:"fileSystem"})}_read(e,t){return this._streamSource._read(e,t)}_retrieveSize(){return this._streamSource._retrieveSize()}_dispose(){this._streamSource._dispose(),this._fileHandle?.close(),this._fileHandle=null}},On=class extends qt{constructor(e){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(typeof e.getSize!="function")throw new TypeError("options.getSize must be a function.");if(typeof e.read!="function")throw new TypeError("options.read must be a function.");if(e.dispose!==void 0&&typeof e.dispose!="function")throw new TypeError("options.dispose, when provided, must be a function.");if(e.maxCacheSize!==void 0&&(!mr(e.maxCacheSize)||e.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");if(e.prefetchProfile&&!["none","fileSystem","network"].includes(e.prefetchProfile))throw new TypeError("options.prefetchProfile, when provided, must be one of 'none', 'fileSystem' or 'network'.");super(),this._options=e,this._orchestrator=new Ts({maxCacheSize:e.maxCacheSize??8*2**20,maxWorkerCount:2,prefetchProfile:ys[e.prefetchProfile??"none"],runWorker:this._runWorker.bind(this)})}_retrieveSize(){let e=this._options.getSize();if(e instanceof Promise)return e.then(t=>{if(!Number.isInteger(t)||t<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=t,t});if(!Number.isInteger(e)||e<0)throw new TypeError("options.getSize must return or resolve to a non-negative integer.");return this._orchestrator.fileSize=e,e}_read(e,t){return this._orchestrator.read(e,t)}async _runWorker(e){for(;e.currentPos<e.targetPos&&!e.aborted;){let t=e.currentPos,r=e.targetPos,i=this._options.read(e.currentPos,r);if(i instanceof Promise&&(i=await i),i instanceof Uint8Array){if(i=ge(i),i.length!==r-e.currentPos)throw new Error("options.read returned a Uint8Array with unexpected length: Requested ".concat(r-e.currentPos," bytes, but got ").concat(i.length,"."));this.onread?.(e.currentPos,e.currentPos+i.length),this._orchestrator.supplyWorkerData(e,i)}else if(i instanceof ReadableStream){let s=i.getReader();for(;e.currentPos<r&&!e.aborted;){let{done:a,value:n}=await s.read();if(a){if(e.currentPos<r)throw new Error("ReadableStream returned by options.read ended before supplying enough data. Requested ".concat(r-t," bytes, but got ").concat(e.currentPos-t));break}if(!(n instanceof Uint8Array))throw new TypeError("ReadableStream returned by options.read must yield Uint8Array chunks.");let o=ge(n);this.onread?.(e.currentPos,e.currentPos+o.length),this._orchestrator.supplyWorkerData(e,o)}}else throw new TypeError("options.read must return or resolve to a Uint8Array or a ReadableStream.")}e.running=!1}_dispose(){this._orchestrator.dispose(),this._options.dispose?.()}},Wl=class extends qt{constructor(e,t={}){if(!(e instanceof ReadableStream))throw new TypeError("stream must be a ReadableStream.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");if(t.maxCacheSize!==void 0&&(!mr(t.maxCacheSize)||t.maxCacheSize<0))throw new TypeError("options.maxCacheSize, when provided, must be a non-negative number.");super(),this._reader=null,this._cache=[],this._pendingSlices=[],this._currentIndex=0,this._targetIndex=0,this._maxRequestedIndex=0,this._endIndex=null,this._pulling=!1,this._stream=e,this._maxCacheSize=t.maxCacheSize??16*2**20}_retrieveSize(){return this._endIndex}_read(e,t){if(this._endIndex!==null&&t>this._endIndex)return null;this._maxRequestedIndex=Math.max(this._maxRequestedIndex,t);let r=ue(this._cache,e,l=>l.start),i=r!==-1?this._cache[r]:null;if(i&&i.start<=e&&t<=i.end)return{bytes:i.bytes,view:i.view,offset:i.start};let s=e,a=new Uint8Array(t-e);if(r!==-1)for(let l=r;l<this._cache.length;l++){let u=this._cache[l];if(u.start>=t)break;let h=Math.max(e,u.start);h>s&&this._throwDueToCacheMiss();let f=Math.min(t,u.end);h<f&&(a.set(u.bytes.subarray(h-u.start,f-u.start),h-e),s=f)}if(s===t)return{bytes:a,view:le(a),offset:e};this._currentIndex>s&&this._throwDueToCacheMiss();let{promise:n,resolve:o,reject:c}=ke();return this._pendingSlices.push({start:e,end:t,bytes:a,resolve:o,reject:c}),this._targetIndex=Math.max(this._targetIndex,t),this._pulling||(this._pulling=!0,this._pull().catch(l=>{if(this._pulling=!1,this._pendingSlices.length>0)this._pendingSlices.forEach(u=>u.reject(l)),this._pendingSlices.length=0;else throw l})),n}_throwDueToCacheMiss(){throw new Error("Read is before the cached region. With ReadableStreamSource, you must access the data more sequentially or increase the size of its cache.")}async _pull(){for(this._reader??(this._reader=this._stream.getReader());this._currentIndex<this._targetIndex&&!this._disposed;){let{done:e,value:t}=await this._reader.read();if(e){for(let s of this._pendingSlices)s.resolve(null);this._pendingSlices.length=0,this._endIndex=this._currentIndex;break}let r=this._currentIndex,i=this._currentIndex+t.byteLength;for(let s=0;s<this._pendingSlices.length;s++){let a=this._pendingSlices[s],n=Math.max(r,a.start),o=Math.min(i,a.end);n<o&&(a.bytes.set(t.subarray(n-r,o-r),n-a.start),o===a.end&&(a.resolve({bytes:a.bytes,view:le(a.bytes),offset:a.start}),this._pendingSlices.splice(s,1),s--))}for(this._cache.push({start:r,end:i,bytes:t,view:le(t),age:0});this._cache.length>0;){let s=this._cache[0];if(this._maxRequestedIndex-s.end<=this._maxCacheSize)break;this._cache.shift()}this._currentIndex+=t.byteLength}this._pulling=!1}_dispose(){this._pendingSlices.length=0,this._cache.length=0}},ys={none:(e,t)=>({start:e,end:t}),fileSystem:(e,t)=>(e=Math.floor((e-65536)/65536)*65536,t=Math.ceil((t+65536)/65536)*65536,{start:e,end:t}),network:(e,t,r)=>{e=Math.max(0,Math.floor((e-65536)/65536)*65536);for(let s of r){let n=Math.max((s.startPos+s.targetPos)/2,s.targetPos-8388608);if(Vi(e,t,n,s.targetPos)){let o=s.targetPos-s.startPos,c=Math.ceil((o+1)/8388608)*8388608,l=2**Math.ceil(Math.log2(o+1)),u=Math.min(l,c);t=Math.max(t,s.startPos+u)}}return t=Math.max(t,e+Dn),{start:e,end:t}}},Ts=class{constructor(e){this.options=e,this.fileSize=null,this.nextAge=0,this.workers=[],this.cache=[],this.currentCacheSize=0,this.disposed=!1}read(e,t){d(this.fileSize!==null);let r=this.options.prefetchProfile(e,t,this.workers),i=Math.max(r.start,0),s=Math.min(r.end,this.fileSize);d(i<=e&&t<=s);let a=null,n=ue(this.cache,e,k=>k.start),o=n!==-1?this.cache[n]:null;o&&o.start<=e&&t<=o.end&&(o.age=this.nextAge++,a={bytes:o.bytes,view:o.view,offset:o.start});let c=ue(this.cache,i,k=>k.start),l=a?null:new Uint8Array(t-e),u=0,h=i,f=[];if(c!==-1){for(let k=c;k<this.cache.length;k++){let T=this.cache[k];if(T.start>=s)break;if(T.end<=i)continue;let _=Math.max(i,T.start),x=Math.min(s,T.end);if(d(_<=x),h<_&&f.push({start:h,end:_}),h=x,l){let B=Math.max(e,T.start),I=Math.min(t,T.end);if(B<I){let M=B-e;l.set(T.bytes.subarray(B-T.start,I-T.start),M),M===u&&(u=I-e)}}T.age=this.nextAge++}h<s&&f.push({start:h,end:s})}else f.push({start:i,end:s});if(l&&u>=l.length&&(a={bytes:l,view:le(l),offset:e}),f.length===0)return d(a),a;let{promise:w,resolve:b,reject:p}=ke(),y=[];for(let k of f){let T=Math.max(e,k.start),_=Math.min(t,k.end);T===k.start&&_===k.end?y.push(k):T<_&&y.push({start:T,end:_})}for(let k of f){let T=l&&{start:e,bytes:l,holes:y,resolve:b,reject:p},_=!1;for(let x of this.workers)if(Vi(k.start-131072,k.start,x.currentPos,x.targetPos)){x.targetPos=Math.max(x.targetPos,k.end),_=!0,T&&!x.pendingSlices.includes(T)&&x.pendingSlices.push(T),x.running||this.runWorker(x);break}if(!_){let x=this.createWorker(k.start,k.end);T&&(x.pendingSlices=[T]),this.runWorker(x)}}return a||(d(l),a=w.then(k=>({bytes:k,view:le(k),offset:e}))),a}createWorker(e,t){let r={startPos:e,currentPos:e,targetPos:t,running:!1,aborted:!1,pendingSlices:[],age:this.nextAge++};for(this.workers.push(r);this.workers.length>this.options.maxWorkerCount;){let i=0,s=this.workers[0];for(let a=1;a<this.workers.length;a++){let n=this.workers[a];n.age<s.age&&(i=a,s=n)}if(s.running&&s.pendingSlices.length>0)break;s.aborted=!0,this.workers.splice(i,1)}return r}runWorker(e){d(!e.running),d(e.currentPos<e.targetPos),e.running=!0,e.age=this.nextAge++,this.options.runWorker(e).catch(t=>{if(e.running=!1,e.pendingSlices.length>0)e.pendingSlices.forEach(r=>r.reject(t)),e.pendingSlices.length=0;else throw t})}supplyWorkerData(e,t){if(this.disposed)return;let r=e.currentPos,i=r+t.length;this.insertIntoCache({start:r,end:i,bytes:t,view:le(t),age:this.nextAge++}),e.currentPos+=t.length,e.targetPos=Math.max(e.targetPos,e.currentPos);for(let s=0;s<e.pendingSlices.length;s++){let a=e.pendingSlices[s],n=Math.max(r,a.start),o=Math.min(i,a.start+a.bytes.length);n<o&&a.bytes.set(t.subarray(n-r,o-r),n-a.start);for(let c=0;c<a.holes.length;c++){let l=a.holes[c];r<=l.start&&i>l.start&&(l.start=i),l.end<=l.start&&(a.holes.splice(c,1),c--)}a.holes.length===0&&(a.resolve(a.bytes),e.pendingSlices.splice(s,1),s--)}for(let s=0;s<this.workers.length;s++){let a=this.workers[s];e===a||a.running||Vi(r,i,a.currentPos,a.targetPos)&&(this.workers.splice(s,1),s--)}}forgetWorker(e){let t=this.workers.indexOf(e);d(t!==-1),this.workers.splice(t,1)}insertIntoCache(e){if(this.options.maxCacheSize===0)return;let t=ue(this.cache,e.start,r=>r.start)+1;if(t>0){let r=this.cache[t-1];if(r.end>=e.end)return;if(r.end>e.start){let i=new Uint8Array(e.end-r.start);i.set(r.bytes,0),i.set(e.bytes,e.start-r.start),this.currentCacheSize+=e.end-r.end,r.bytes=i,r.view=le(i),r.end=e.end,t--,e=r}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length}else this.cache.splice(t,0,e),this.currentCacheSize+=e.bytes.length;for(let r=t+1;r<this.cache.length;r++){let i=this.cache[r];if(e.end<=i.start)break;if(e.end>=i.end){this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length,r--;continue}let s=new Uint8Array(i.end-e.start);s.set(e.bytes,0),s.set(i.bytes,i.start-e.start),this.currentCacheSize-=e.end-i.start,e.bytes=s,e.view=le(s),e.end=i.end,this.cache.splice(r,1);break}for(;this.currentCacheSize>this.options.maxCacheSize;){let r=0,i=this.cache[0];for(let s=1;s<this.cache.length;s++){let a=this.cache[s];a.age<i.age&&(r=s,i=a)}if(this.currentCacheSize-i.bytes.length<=this.options.maxCacheSize)break;this.cache.splice(r,1),this.currentCacheSize-=i.bytes.length}}dispose(){for(let e of this.workers)e.aborted=!0;this.workers.length=0,this.cache.length=0,this.disposed=!0}};ha();var Nn=class{constructor(e){if(this._demuxerPromise=null,this._format=null,this._disposed=!1,!e||typeof e!="object")throw new TypeError("options must be an object.");if(!Array.isArray(e.formats)||e.formats.some(t=>!(t instanceof Bt)))throw new TypeError("options.formats must be an array of InputFormat.");if(!(e.source instanceof qt))throw new TypeError("options.source must be a Source.");if(e.source._disposed)throw new Error("options.source must not be disposed.");this._formats=e.formats,this._source=e.source,this._reader=new Hl(e.source)}get disposed(){return this._disposed}_getDemuxer(){return this._demuxerPromise??(this._demuxerPromise=(async()=>{this._reader.fileSize=await this._source.getSizeOrNull();for(let e of this._formats)if(await e._canReadInput(this))return this._format=e,e._createDemuxer(this);throw new Error("Input has an unsupported or unrecognizable format.")})())}get source(){return this._source}async getFormat(){return await this._getDemuxer(),d(this._format),this._format}async computeDuration(){return(await this._getDemuxer()).computeDuration()}async getTracks(){return(await this._getDemuxer()).getTracks()}async getVideoTracks(){return(await this.getTracks()).filter(t=>t.isVideoTrack())}async getAudioTracks(){return(await this.getTracks()).filter(t=>t.isAudioTrack())}async getPrimaryVideoTrack(){return(await this.getTracks()).find(t=>t.isVideoTrack())??null}async getPrimaryAudioTrack(){return(await this.getTracks()).find(t=>t.isAudioTrack())??null}async getMimeType(){return(await this._getDemuxer()).getMimeType()}async getMetadataTags(){return(await this._getDemuxer()).getMetadataTags()}dispose(){this._disposed||(this._disposed=!0,this._source._disposed=!0,this._source._dispose())}[Symbol.dispose](){this.dispose()}},Ue=class extends Error{constructor(e="Input has been disposed."){super(e),this.name="InputDisposedError"}},Hl=class{constructor(e){this.source=e}requestSlice(e,t){if(this.source._disposed)throw new Ue;if(this.fileSize!==null&&e+t>this.fileSize)return null;let r=e+t,i=this.source._read(e,r);return i instanceof Promise?i.then(s=>s?new Ci(s.bytes,s.view,s.offset,e,r):null):i?new Ci(i.bytes,i.view,i.offset,e,r):null}requestSliceRange(e,t,r){if(this.source._disposed)throw new Ue;if(this.fileSize!==null)return this.requestSlice(e,Ie(this.fileSize-e,t,r));{let i=this.requestSlice(e,r),s=a=>{if(a)return a;let n=c=>(d(c!==null),this.requestSlice(e,Ie(c-e,t,r))),o=this.source._retrieveSize();return o instanceof Promise?o.then(n):n(o)};return i instanceof Promise?i.then(s):s(i)}}},Ci=class sa{constructor(t,r,i,s,a){this.bytes=t,this.view=r,this.offset=i,this.start=s,this.end=a,this.bufferPos=s-i}static tempFromBytes(t){return new sa(t,le(t),0,0,t.length)}get length(){return this.end-this.start}get filePos(){return this.offset+this.bufferPos}set filePos(t){this.bufferPos=t-this.offset}get remainingLength(){return Math.max(this.end-this.filePos,0)}skip(t){this.bufferPos+=t}slice(t,r=this.end-t){if(t<this.start||t+r>this.end)throw new RangeError("Slicing outside of original slice.");return new sa(this.bytes,this.view,this.offset,t,t+r)}},Le=(e,t)=>{if(e.filePos<e.start||e.filePos+t>e.end)throw new RangeError("Tried reading [".concat(e.filePos,", ").concat(e.filePos+t,"), but slice is [").concat(e.start,", ").concat(e.end,"). This is likely an internal error, please report it alongside the file that caused it."))},K=(e,t)=>{Le(e,t);let r=e.bytes.subarray(e.bufferPos,e.bufferPos+t);return e.bufferPos+=t,r},H=e=>(Le(e,1),e.view.getUint8(e.bufferPos++)),Kr=(e,t)=>{Le(e,2);let r=e.view.getUint16(e.bufferPos,t);return e.bufferPos+=2,r},Be=e=>{Le(e,2);let t=e.view.getUint16(e.bufferPos,!1);return e.bufferPos+=2,t},Cr=e=>{Le(e,3);let t=si(e.view,e.bufferPos,!1);return e.bufferPos+=3,t},Ss=e=>{Le(e,2);let t=e.view.getInt16(e.bufferPos,!1);return e.bufferPos+=2,t},$t=(e,t)=>{Le(e,4);let r=e.view.getUint32(e.bufferPos,t);return e.bufferPos+=4,r},O=e=>{Le(e,4);let t=e.view.getUint32(e.bufferPos,!1);return e.bufferPos+=4,t},xr=e=>{Le(e,4);let t=e.view.getUint32(e.bufferPos,!0);return e.bufferPos+=4,t},nr=e=>{Le(e,4);let t=e.view.getInt32(e.bufferPos,!1);return e.bufferPos+=4,t},ql=e=>{Le(e,4);let t=e.view.getInt32(e.bufferPos,!0);return e.bufferPos+=4,t},Un=(e,t)=>{let r,i;return t?(r=$t(e,!0),i=$t(e,!0)):(i=$t(e,!1),r=$t(e,!1)),i*4294967296+r},ut=e=>{let t=O(e),r=O(e);return t*4294967296+r},$l=e=>{let t=nr(e),r=O(e);return t*4294967296+r},jl=e=>{let t=xr(e);return ql(e)*4294967296+t},Ql=e=>{Le(e,4);let t=e.view.getFloat32(e.bufferPos,!1);return e.bufferPos+=4,t},Ln=e=>{Le(e,8);let t=e.view.getFloat64(e.bufferPos,!1);return e.bufferPos+=8,t},Ee=(e,t)=>{Le(e,t);let r="";for(let i=0;i<t;i++)r+=String.fromCharCode(e.bytes[e.bufferPos++]);return r},Vn=new Uint8Array([102,76,97,67]),Kl=38,Gl=34,Xl=class extends tr{constructor(e,t){super(e),this.metadataWritten=!1,this.blockSizes=[],this.frameSizes=[],this.sampleRate=null,this.channels=null,this.bitsPerSample=null,this.writer=e._writer,this.format=t}async start(){this.writer.write(Vn)}writeHeader({bitsPerSample:e,minimumBlockSize:t,maximumBlockSize:r,minimumFrameSize:i,maximumFrameSize:s,sampleRate:a,channels:n,totalSamples:o}){d(this.writer.getPos()===4);let c=!li(this.output._metadataTags),l=new ce(new Uint8Array(4));l.writeBits(1,+!c),l.writeBits(7,0),l.writeBits(24,Gl),this.writer.write(l.bytes);let u=new ce(new Uint8Array(18));if(u.writeBits(16,t),u.writeBits(16,r),u.writeBits(24,i),u.writeBits(24,s),u.writeBits(20,a),u.writeBits(3,n-1),u.writeBits(5,e-1),o>=2**32)throw new Error("This muxer only supports writing up to 2 ** 32 samples");u.writeBits(4,0),u.writeBits(32,o),this.writer.write(u.bytes),this.writer.write(new Uint8Array(16))}writePictureBlock(e){let t=32+e.mimeType.length+(e.description?.length??0)+e.data.length,r=new Uint8Array(t),i=0,s=le(r);s.setUint32(i,e.kind==="coverFront"?3:e.kind==="coverBack"?4:0),i+=4,s.setUint32(i,e.mimeType.length),i+=4,r.set(J.encode(e.mimeType),8),i+=e.mimeType.length,s.setUint32(i,e.description?.length??0),i+=4,r.set(J.encode(e.description??""),i),i+=e.description?.length??0,i+=16,s.setUint32(i,e.data.length),i+=4,r.set(e.data,i),i+=e.data.length,d(i===t);let a=new ce(new Uint8Array(4));a.writeBits(1,0),a.writeBits(7,6),a.writeBits(24,t),this.writer.write(a.bytes),this.writer.write(r)}writeVorbisCommentAndPictureBlock(){if(this.writer.seek(Kl+Vn.byteLength),li(this.output._metadataTags)){this.metadataWritten=!0;return}let e=this.output._metadataTags.images??[];for(let i of e)this.writePictureBlock(i);let t=ji(new Uint8Array(0),this.output._metadataTags,!1),r=new ce(new Uint8Array(4));r.writeBits(1,1),r.writeBits(7,4),r.writeBits(24,t.length),this.writer.write(r.bytes),this.writer.write(t),this.metadataWritten=!0}async getMimeType(){return"audio/flac"}async addEncodedVideoPacket(){throw new Error("FLAC does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();gr(r),d(r),d(r.decoderConfig),d(r.decoderConfig.description);try{if(this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),this.sampleRate===null&&(this.sampleRate=r.decoderConfig.sampleRate),this.channels===null&&(this.channels=r.decoderConfig.numberOfChannels),this.bitsPerSample===null){let u=new ce(ge(r.decoderConfig.description));u.skipBits(167);let h=u.readBits(5)+1;this.bitsPerSample=h}this.metadataWritten||this.writeVorbisCommentAndPictureBlock();let s=Ci.tempFromBytes(t.data);K(s,2);let a=K(s,2),n=new ce(a),o=pn(n.readBits(4));if(o===null)throw new Error("Invalid FLAC frame: Invalid block size.");gn(s);let c=wn(s,o);this.blockSizes.push(c),this.frameSizes.push(t.data.length);let l=this.writer.getPos();this.writer.write(t.data),this.format._options.onFrame&&this.format._options.onFrame(t.data,l),await this.writer.flush()}finally{i()}}addSubtitleCue(){throw new Error("FLAC does not support subtitles.")}async finalize(){let e=await this.mutex.acquire(),t=1/0,r=0,i=1/0,s=0,a=0;for(let n=0;n<this.blockSizes.length;n++)i=Math.min(i,this.frameSizes[n]),s=Math.max(s,this.frameSizes[n]),r=Math.max(r,this.blockSizes[n]),a+=this.blockSizes[n],n!==this.blockSizes.length-1&&(t=Math.min(t,this.blockSizes[n]));d(this.sampleRate!==null),d(this.channels!==null),d(this.bitsPerSample!==null),this.writer.seek(4),this.writeHeader({minimumBlockSize:t,maximumBlockSize:r,minimumFrameSize:i,maximumFrameSize:s,sampleRate:this.sampleRate,channels:this.channels,bitsPerSample:this.bitsPerSample,totalSamples:a}),e()}},Gr=/(?:(.+?)\n)?((?:\d{2}:)?\d{2}:\d{2}.\d{3})\s+-->\s+((?:\d{2}:)?\d{2}:\d{2}.\d{3})/g,Yl=/^WEBVTT(.|\n)*?\n{2}/,xi=/<(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})>/g,Zl=class{constructor(e){this.preambleText=null,this.preambleEmitted=!1,this.options=e}parse(e){e=e.replaceAll("\r\n","\n").replaceAll("\r","\n"),Gr.lastIndex=0;let t;if(!this.preambleText){if(!Yl.test(e))throw new Error("WebVTT preamble incorrect.");t=Gr.exec(e);let r=e.slice(0,t?.index??e.length).trimEnd();if(!r)throw new Error("No WebVTT preamble provided.");this.preambleText=r,t&&(e=e.slice(t.index),Gr.lastIndex=0)}for(;t=Gr.exec(e);){let r=e.slice(0,t.index),i=t[1],s=t.index+t[0].length,a=e.indexOf("\n",s)+1,n=e.slice(s,a).trim(),o=e.indexOf("\n\n",s);o===-1&&(o=e.length);let c=vs(t[2]),u=vs(t[3])-c,h=e.slice(a,o).trim();e=e.slice(o).trimStart(),Gr.lastIndex=0;let f={timestamp:c/1e3,duration:u/1e3,text:h,identifier:i,settings:n,notes:r},w={};this.preambleEmitted||(w.config={description:this.preambleText},this.preambleEmitted=!0),this.options.output(f,w)}}},Jl=/(?:(\d{2}):)?(\d{2}):(\d{2}).(\d{3})/,vs=e=>{let t=Jl.exec(e);if(!t)throw new Error("Expected match.");return 3600*1e3*Number(t[1]||"0")+60*1e3*Number(t[2])+1e3*Number(t[3])+Number(t[4])},Wn=e=>{let t=Math.floor(e/36e5),r=Math.floor(e%(3600*1e3)/(60*1e3)),i=Math.floor(e%(60*1e3)/1e3),s=e%1e3;return t.toString().padStart(2,"0")+":"+r.toString().padStart(2,"0")+":"+i.toString().padStart(2,"0")+"."+s.toString().padStart(3,"0")},Hn=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer),this.offsets=new WeakMap}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,Math.floor(e/2**32),!1),this.helperView.setUint32(4,e,!1),this.writer.write(this.helper.subarray(0,8))}writeAscii(e){for(let t=0;t<e.length;t++)this.helperView.setUint8(t%8,e.charCodeAt(t)),t%8===7&&this.writer.write(this.helper);e.length%8!==0&&this.writer.write(this.helper.subarray(0,e.length%8))}writeBox(e){if(this.offsets.set(e,this.writer.getPos()),e.contents&&!e.children)this.writeBoxHeader(e,e.size??e.contents.byteLength+8),this.writer.write(e.contents);else{let t=this.writer.getPos();if(this.writeBoxHeader(e,0),e.contents&&this.writer.write(e.contents),e.children)for(let s of e.children)s&&this.writeBox(s);let r=this.writer.getPos(),i=e.size??r-t;this.writer.seek(t),this.writeBoxHeader(e,i),this.writer.seek(r)}}writeBoxHeader(e,t){this.writeU32(e.largeSize?1:t),this.writeAscii(e.type),e.largeSize&&this.writeU64(t)}measureBoxHeader(e){return 8+(e.largeSize?8:0)}patchBox(e){let t=this.offsets.get(e);d(t!==void 0);let r=this.writer.getPos();this.writer.seek(t),this.writeBox(e),this.writer.seek(r)}measureBox(e){if(e.contents&&!e.children)return this.measureBoxHeader(e)+e.contents.byteLength;{let t=this.measureBoxHeader(e);if(e.contents&&(t+=e.contents.byteLength),e.children)for(let r of e.children)r&&(t+=this.measureBox(r));return t}}},ie=new Uint8Array(8),yt=new DataView(ie.buffer),be=e=>[(e%256+256)%256],q=e=>(yt.setUint16(0,e,!1),[ie[0],ie[1]]),qn=e=>(yt.setInt16(0,e,!1),[ie[0],ie[1]]),$n=e=>(yt.setUint32(0,e,!1),[ie[1],ie[2],ie[3]]),R=e=>(yt.setUint32(0,e,!1),[ie[0],ie[1],ie[2],ie[3]]),jt=e=>(yt.setInt32(0,e,!1),[ie[0],ie[1],ie[2],ie[3]]),or=e=>(yt.setUint32(0,Math.floor(e/2**32),!1),yt.setUint32(4,e,!1),[ie[0],ie[1],ie[2],ie[3],ie[4],ie[5],ie[6],ie[7]]),jn=e=>(yt.setInt16(0,2**8*e,!1),[ie[0],ie[1]]),Ft=e=>(yt.setInt32(0,2**16*e,!1),[ie[0],ie[1],ie[2],ie[3]]),_s=e=>(yt.setInt32(0,2**30*e,!1),[ie[0],ie[1],ie[2],ie[3]]),Cs=(e,t)=>{let r=[],i=e;do{let s=i&127;i>>=7,r.length>0&&(s|=128),r.push(s),t!==void 0&&t--}while(i>0||t);return r.reverse()},Fe=(e,t=!1)=>{let r=Array(e.length).fill(null).map((i,s)=>e.charCodeAt(s));return t&&r.push(0),r},xs=e=>{let t=null;for(let r of e)(!t||r.timestamp>t.timestamp)&&(t=r);return t},Qn=e=>{let t=e*(Math.PI/180),r=Math.round(Math.cos(t)),i=Math.round(Math.sin(t));return[r,i,0,-i,r,0,0,0,1]},Kn=Qn(0),Gn=e=>[Ft(e[0]),Ft(e[1]),_s(e[2]),Ft(e[3]),Ft(e[4]),_s(e[5]),Ft(e[6]),Ft(e[7]),_s(e[8])],$=(e,t,r)=>({type:e,contents:t&&new Uint8Array(t.flat(10)),children:r}),ne=(e,t,r,i,s)=>$(e,[be(t),$n(r),i??[]],s),eu=e=>e.isQuickTime?$("ftyp",[Fe("qt  "),R(512),Fe("qt  ")]):e.fragmented?$("ftyp",[Fe("iso5"),R(512),Fe("iso5"),Fe("iso6"),Fe("mp41")]):$("ftyp",[Fe("isom"),R(512),Fe("isom"),e.holdsAvc?Fe("avc1"):[],Fe("mp41")]),Pi=e=>({type:"mdat",largeSize:e}),tu=e=>({type:"free",size:e}),Xr=e=>$("moov",void 0,[ru(e.creationTime,e.trackDatas),...e.trackDatas.map(t=>iu(t,e.creationTime)),e.isFragmented?Nu(e.trackDatas):null,Yu(e)]),ru=(e,t)=>{let r=xe(Math.max(0,...t.filter(n=>n.samples.length>0).map(n=>{let o=xs(n.samples);return o.timestamp+o.duration})),Fs),i=Math.max(0,...t.map(n=>n.track.id))+1,s=!at(e)||!at(r),a=s?or:R;return ne("mvhd",+s,0,[a(e),a(e),R(Fs),a(r),Ft(1),jn(1),Array(10).fill(0),Gn(Kn),Array(24).fill(0),R(i)])},iu=(e,t)=>{let r=fd(e);return $("trak",void 0,[su(e,t),au(e,t),r.name!==void 0?$("udta",void 0,[$("name",[...J.encode(r.name)])]):null])},su=(e,t)=>{let r=xs(e.samples),i=xe(r?r.timestamp+r.duration:0,Fs),s=!at(t)||!at(i),a=s?or:R,n;if(e.type==="video"){let o=e.track.metadata.rotation;n=Qn(o??0)}else n=Kn;return ne("tkhd",+s,3,[a(t),a(t),R(e.track.id),R(0),a(i),Array(8).fill(0),q(0),q(e.track.id),jn(e.type==="audio"?1:0),q(0),Gn(n),Ft(e.type==="video"?e.info.width:0),Ft(e.type==="video"?e.info.height:0)])},au=(e,t)=>$("mdia",void 0,[nu(e,t),Ps(!0,ou[e.type],cu[e.type]),lu(e)]),nu=(e,t)=>{let r=xs(e.samples),i=xe(r?r.timestamp+r.duration:0,e.timescale),s=!at(t)||!at(i),a=s?or:R;return ne("mdhd",+s,0,[a(t),a(t),R(e.timescale),a(i),q(ro(e.track.metadata.languageCode??je)),q(0)])},ou={video:"vide",audio:"soun",subtitle:"text"},cu={video:"MediabunnyVideoHandler",audio:"MediabunnySoundHandler",subtitle:"MediabunnyTextHandler"},Ps=(e,t,r,i="\0\0\0\0")=>ne("hdlr",0,0,[e?Fe("mhlr"):R(0),Fe(t),Fe(i),R(0),R(0),Fe(r,!0)]),lu=e=>$("minf",void 0,[fu[e.type](),mu(),wu(e)]),uu=()=>ne("vmhd",0,1,[q(0),q(0),q(0),q(0)]),du=()=>ne("smhd",0,0,[q(0),q(0)]),hu=()=>ne("nmhd",0,0),fu={video:uu,audio:du,subtitle:hu},mu=()=>$("dinf",void 0,[pu()]),pu=()=>ne("dref",0,0,[R(1)],[gu()]),gu=()=>ne("url ",0,1),wu=e=>{let t=e.compositionTimeOffsetTable.length>1||e.compositionTimeOffsetTable.some(r=>r.sampleCompositionTimeOffset!==0);return $("stbl",void 0,[bu(e),Bu(e),t?Du(e):null,t?Ou(e):null,Mu(e),zu(e),Ru(e),Fu(e)])},bu=e=>{let t;if(e.type==="video")t=ku(td[e.track.source._codec],e);else if(e.type==="audio"){let r=to(e.track.source._codec,e.muxer.isQuickTime);d(r),t=_u(r,e)}else e.type==="subtitle"&&(t=Eu(sd[e.track.source._codec],e));return d(t),ne("stsd",0,0,[R(1)],[t])},ku=(e,t)=>$(e,[Array(6).fill(0),q(1),q(0),q(0),Array(12).fill(0),q(t.info.width),q(t.info.height),R(4718592),R(4718592),R(0),q(1),Array(32).fill(0),q(24),qn(65535)],[rd[t.track.source._codec](t),ii(t.info.decoderConfig.colorSpace)?yu(t):null]),yu=e=>$("colr",[Fe("nclx"),q(Ae[e.info.decoderConfig.colorSpace.primaries]),q(_t[e.info.decoderConfig.colorSpace.transfer]),q(nt[e.info.decoderConfig.colorSpace.matrix]),be((e.info.decoderConfig.colorSpace.fullRange?1:0)<<7)]),Tu=e=>e.info.decoderConfig&&$("avcC",[...ge(e.info.decoderConfig.description)]),Su=e=>e.info.decoderConfig&&$("hvcC",[...ge(e.info.decoderConfig.description)]),Xn=e=>{if(!e.info.decoderConfig)return null;let t=e.info.decoderConfig,r=t.codec.split("."),i=Number(r[1]),s=Number(r[2]),a=Number(r[3]),n=r[4]?Number(r[4]):1,o=r[8]?Number(r[8]):Number(t.colorSpace?.fullRange??0),c=(a<<4)+(n<<1)+o,l=r[5]?Number(r[5]):t.colorSpace?.primaries?Ae[t.colorSpace.primaries]:2,u=r[6]?Number(r[6]):t.colorSpace?.transfer?_t[t.colorSpace.transfer]:2,h=r[7]?Number(r[7]):t.colorSpace?.matrix?nt[t.colorSpace.matrix]:2;return ne("vpcC",1,0,[be(i),be(s),be(c),be(l),be(u),be(h),q(0)])},vu=e=>$("av1C",ba(e.info.decoderConfig.codec)),_u=(e,t)=>{let r=0,i,s=16;if(ve.includes(t.track.source._codec)){let a=t.track.source._codec,{sampleSize:n}=wt(a);s=8*n,s>16&&(r=1)}return r===0?i=[Array(6).fill(0),q(1),q(r),q(0),R(0),q(t.info.numberOfChannels),q(s),q(0),q(0),q(t.info.sampleRate<2**16?t.info.sampleRate:0),q(0)]:i=[Array(6).fill(0),q(1),q(r),q(0),R(0),q(t.info.numberOfChannels),q(Math.min(s,16)),q(0),q(0),q(t.info.sampleRate<2**16?t.info.sampleRate:0),q(0),R(1),R(s/8),R(t.info.numberOfChannels*s/8),R(2)],$(e,i,[id(t.track.source._codec,t.muxer.isQuickTime)?.(t)??null])},Is=e=>{let t;switch(e.track.source._codec){case"aac":t=64;break;case"mp3":t=107;break;case"vorbis":t=221;break;default:throw new Error("Unhandled audio codec: ".concat(e.track.source._codec))}let r=[...be(t),...be(21),...$n(0),...R(0),...R(0)];if(e.info.decoderConfig.description){let i=ge(e.info.decoderConfig.description);r=[...r,...be(5),...Cs(i.byteLength),...i]}return r=[...q(1),...be(0),...be(4),...Cs(r.length),...r,...be(6),...be(1),...be(2)],r=[...be(3),...Cs(r.length),...r],ne("esds",0,0,r)},Qt=e=>$("wave",void 0,[Cu(e),xu(e),$("\0\0\0\0")]),Cu=e=>$("frma",[Fe(to(e.track.source._codec,e.muxer.isQuickTime))]),xu=e=>{let{littleEndian:t}=wt(e.track.source._codec);return $("enda",[q(+t)])},Pu=e=>{let t=e.info.numberOfChannels,r=3840,i=e.info.sampleRate,s=0,a=0,n=new Uint8Array(0),o=e.info.decoderConfig?.description;if(o){d(o.byteLength>=18);let c=ge(o),l=hi(c);t=l.outputChannelCount,r=l.preSkip,i=l.inputSampleRate,s=l.outputGain,a=l.channelMappingFamily,l.channelMappingTable&&(n=l.channelMappingTable)}return $("dOps",[be(0),be(t),q(r),R(i),qn(s),be(a),...n])},Iu=e=>{let t=e.info.decoderConfig?.description;d(t);let r=ge(t);return ne("dfLa",0,0,[...r.subarray(4)])},Tt=e=>{let{littleEndian:t,sampleSize:r}=wt(e.track.source._codec),i=+t;return ne("pcmC",0,0,[be(i),be(8*r)])},Eu=(e,t)=>$(e,[Array(6).fill(0),q(1)],[ad[t.track.source._codec](t)]),Au=e=>$("vttC",[...J.encode(e.info.config.description)]),Bu=e=>ne("stts",0,0,[R(e.timeToSampleTable.length),e.timeToSampleTable.map(t=>[R(t.sampleCount),R(t.sampleDelta)])]),Fu=e=>{if(e.samples.every(r=>r.type==="key"))return null;let t=[...e.samples.entries()].filter(([,r])=>r.type==="key");return ne("stss",0,0,[R(t.length),t.map(([r])=>R(r+1))])},Mu=e=>ne("stsc",0,0,[R(e.compactlyCodedChunkTable.length),e.compactlyCodedChunkTable.map(t=>[R(t.firstChunk),R(t.samplesPerChunk),R(1)])]),zu=e=>{if(e.type==="audio"&&e.info.requiresPcmTransformation){let{sampleSize:t}=wt(e.track.source._codec);return ne("stsz",0,0,[R(t*e.info.numberOfChannels),R(e.samples.reduce((r,i)=>r+xe(i.duration,e.timescale),0))])}return ne("stsz",0,0,[R(0),R(e.samples.length),e.samples.map(t=>R(t.size))])},Ru=e=>e.finalizedChunks.length>0&&de(e.finalizedChunks).offset>=2**32?ne("co64",0,0,[R(e.finalizedChunks.length),e.finalizedChunks.map(t=>or(t.offset))]):ne("stco",0,0,[R(e.finalizedChunks.length),e.finalizedChunks.map(t=>R(t.offset))]),Du=e=>ne("ctts",1,0,[R(e.compositionTimeOffsetTable.length),e.compositionTimeOffsetTable.map(t=>[R(t.sampleCount),jt(t.sampleCompositionTimeOffset)])]),Ou=e=>{let t=1/0,r=-1/0,i=1/0,s=-1/0;d(e.compositionTimeOffsetTable.length>0),d(e.samples.length>0);for(let n=0;n<e.compositionTimeOffsetTable.length;n++){let o=e.compositionTimeOffsetTable[n];t=Math.min(t,o.sampleCompositionTimeOffset),r=Math.max(r,o.sampleCompositionTimeOffset)}for(let n=0;n<e.samples.length;n++){let o=e.samples[n];i=Math.min(i,xe(o.timestamp,e.timescale)),s=Math.max(s,xe(o.timestamp+o.duration,e.timescale))}let a=Math.max(-t,0);return s>=2**31?null:ne("cslg",0,0,[jt(a),jt(t),jt(r),jt(i),jt(s)])},Nu=e=>$("mvex",void 0,e.map(Uu)),Uu=e=>ne("trex",0,0,[R(e.track.id),R(1),R(0),R(0),R(0)]),Yn=(e,t)=>$("moof",void 0,[Lu(e),...t.map(Vu)]),Lu=e=>ne("mfhd",0,0,[R(e)]),Zn=e=>{let t=0,r=0,i=0,s=0,a=e.type==="delta";return r|=+a,a?t|=1:t|=2,t<<24|r<<16|i<<8|s},Vu=e=>$("traf",void 0,[Wu(e),Hu(e),qu(e)]),Wu=e=>{d(e.currentChunk);let t=0;t|=8,t|=16,t|=32,t|=131072;let r=e.currentChunk.samples[1]??e.currentChunk.samples[0],i={duration:r.timescaleUnitsToNextSample,size:r.size,flags:Zn(r)};return ne("tfhd",0,t,[R(e.track.id),R(i.duration),R(i.size),R(i.flags)])},Hu=e=>(d(e.currentChunk),ne("tfdt",1,0,[or(xe(e.currentChunk.startTimestamp,e.timescale))])),qu=e=>{d(e.currentChunk);let t=e.currentChunk.samples.map(p=>p.timescaleUnitsToNextSample),r=e.currentChunk.samples.map(p=>p.size),i=e.currentChunk.samples.map(Zn),s=e.currentChunk.samples.map(p=>xe(p.timestamp-p.decodeTimestamp,e.timescale)),a=new Set(t),n=new Set(r),o=new Set(i),c=new Set(s),l=o.size===2&&i[0]!==i[1],u=a.size>1,h=n.size>1,f=!l&&o.size>1,w=c.size>1||[...c].some(p=>p!==0),b=0;return b|=1,b|=4*+l,b|=256*+u,b|=512*+h,b|=1024*+f,b|=2048*+w,ne("trun",1,b,[R(e.currentChunk.samples.length),R(e.currentChunk.offset-e.currentChunk.moofOffset||0),l?R(i[0]):[],e.currentChunk.samples.map((p,y)=>[u?R(t[y]):[],h?R(r[y]):[],f?R(i[y]):[],w?jt(s[y]):[]])])},$u=e=>$("mfra",void 0,[...e.map(ju),Qu()]),ju=(e,t)=>ne("tfra",1,0,[R(e.track.id),R(63),R(e.finalizedChunks.length),e.finalizedChunks.map(i=>[or(xe(i.samples[0].timestamp,e.timescale)),or(i.moofOffset),R(t+1),R(1),R(1)])]),Qu=()=>ne("mfro",0,0,[R(0)]),Ku=()=>$("vtte"),Gu=(e,t,r,i,s)=>$("vttc",void 0,[s!==null?$("vsid",[jt(s)]):null,r!==null?$("iden",[...J.encode(r)]):null,t!==null?$("ctim",[...J.encode(Wn(t))]):null,i!==null?$("sttg",[...J.encode(i)]):null,$("payl",[...J.encode(e)])]),Xu=e=>$("vtta",[...J.encode(e)]),Yu=e=>{let t=[],r=e.format._options.metadataFormat??"auto",i=e.output._metadataTags;if(r==="mdir"||r==="auto"&&!e.isQuickTime){let s=Ju(i);s&&t.push(s)}else if(r==="mdta"){let s=ed(i);s&&t.push(s)}else(r==="udta"||r==="auto"&&e.isQuickTime)&&Zu(t,e.output._metadataTags);return t.length===0?null:$("udta",void 0,t)},Zu=(e,t)=>{for(let{key:r,value:i}of fr(t))switch(r){case"title":e.push(St("\xA9nam",i));break;case"description":e.push(St("\xA9des",i));break;case"artist":e.push(St("\xA9ART",i));break;case"album":e.push(St("\xA9alb",i));break;case"albumArtist":e.push(St("albr",i));break;case"genre":e.push(St("\xA9gen",i));break;case"date":e.push(St("\xA9day",i.toISOString().slice(0,10)));break;case"comment":e.push(St("\xA9cmt",i));break;case"lyrics":e.push(St("\xA9lyr",i));break;case"raw":break;case"discNumber":case"discsTotal":case"trackNumber":case"tracksTotal":case"images":break;default:Re(r)}if(t.raw)for(let r in t.raw){let i=t.raw[r];i==null||r.length!==4||e.some(s=>s.type===r)||(typeof i=="string"?e.push(St(r,i)):i instanceof Uint8Array&&e.push($(r,Array.from(i))))}},St=(e,t)=>{let r=J.encode(t);return $(e,[q(r.length),q(ro("und")),Array.from(r)])},Jn={"image/jpeg":13,"image/png":14,"image/bmp":27},eo=(e,t)=>{let r=[];for(let{key:i,value:s}of fr(e))switch(i){case"title":r.push({key:t?"title":"\xA9nam",value:dt(s)});break;case"description":r.push({key:t?"description":"\xA9des",value:dt(s)});break;case"artist":r.push({key:t?"artist":"\xA9ART",value:dt(s)});break;case"album":r.push({key:t?"album":"\xA9alb",value:dt(s)});break;case"albumArtist":r.push({key:t?"album_artist":"aART",value:dt(s)});break;case"comment":r.push({key:t?"comment":"\xA9cmt",value:dt(s)});break;case"genre":r.push({key:t?"genre":"\xA9gen",value:dt(s)});break;case"lyrics":r.push({key:t?"lyrics":"\xA9lyr",value:dt(s)});break;case"date":r.push({key:t?"date":"\xA9day",value:dt(s.toISOString().slice(0,10))});break;case"images":for(let a of s)a.kind==="coverFront"&&r.push({key:"covr",value:$("data",[R(Jn[a.mimeType]??0),R(0),Array.from(a.data)])});break;case"trackNumber":if(t){let a=e.tracksTotal!==void 0?"".concat(s,"/").concat(e.tracksTotal):s.toString();r.push({key:"track",value:dt(a)})}else r.push({key:"trkn",value:$("data",[R(0),R(0),q(0),q(s),q(e.tracksTotal??0),q(0)])});break;case"discNumber":t||r.push({key:"disc",value:$("data",[R(0),R(0),q(0),q(s),q(e.discsTotal??0),q(0)])});break;case"tracksTotal":case"discsTotal":break;case"raw":break;default:Re(i)}if(e.raw)for(let i in e.raw){let s=e.raw[i];s==null||!t&&i.length!==4||r.some(a=>a.key===i)||(typeof s=="string"?r.push({key:i,value:dt(s)}):s instanceof Uint8Array?r.push({key:i,value:$("data",[R(0),R(0),Array.from(s)])}):s instanceof Jt&&r.push({key:i,value:$("data",[R(Jn[s.mimeType]??0),R(0),Array.from(s.data)])}))}return r},Ju=e=>{let t=eo(e,!1);return t.length===0?null:ne("meta",0,0,void 0,[Ps(!1,"mdir","","appl"),$("ilst",void 0,t.map(r=>$(r.key,void 0,[r.value])))])},ed=e=>{let t=eo(e,!0);return t.length===0?null:$("meta",void 0,[Ps(!1,"mdta",""),ne("keys",0,0,[R(t.length)],t.map(r=>$("mdta",[...J.encode(r.key)]))),$("ilst",void 0,t.map((r,i)=>{let s=String.fromCharCode(...R(i+1));return $(s,void 0,[r.value])}))])},dt=e=>$("data",[R(1),R(0),...J.encode(e)]),td={avc:"avc1",hevc:"hvc1",vp8:"vp08",vp9:"vp09",av1:"av01"},rd={avc:Tu,hevc:Su,vp8:Xn,vp9:Xn,av1:vu},to=(e,t)=>{switch(e){case"aac":return"mp4a";case"mp3":return"mp4a";case"opus":return"Opus";case"vorbis":return"mp4a";case"flac":return"fLaC";case"ulaw":return"ulaw";case"alaw":return"alaw";case"pcm-u8":return"raw ";case"pcm-s8":return"sowt"}if(t)switch(e){case"pcm-s16":return"sowt";case"pcm-s16be":return"twos";case"pcm-s24":return"in24";case"pcm-s24be":return"in24";case"pcm-s32":return"in32";case"pcm-s32be":return"in32";case"pcm-f32":return"fl32";case"pcm-f32be":return"fl32";case"pcm-f64":return"fl64";case"pcm-f64be":return"fl64"}else switch(e){case"pcm-s16":return"ipcm";case"pcm-s16be":return"ipcm";case"pcm-s24":return"ipcm";case"pcm-s24be":return"ipcm";case"pcm-s32":return"ipcm";case"pcm-s32be":return"ipcm";case"pcm-f32":return"fpcm";case"pcm-f32be":return"fpcm";case"pcm-f64":return"fpcm";case"pcm-f64be":return"fpcm"}},id=(e,t)=>{switch(e){case"aac":return Is;case"mp3":return Is;case"opus":return Pu;case"vorbis":return Is;case"flac":return Iu}if(t)switch(e){case"pcm-s24":return Qt;case"pcm-s24be":return Qt;case"pcm-s32":return Qt;case"pcm-s32be":return Qt;case"pcm-f32":return Qt;case"pcm-f32be":return Qt;case"pcm-f64":return Qt;case"pcm-f64be":return Qt}else switch(e){case"pcm-s16":return Tt;case"pcm-s16be":return Tt;case"pcm-s24":return Tt;case"pcm-s24be":return Tt;case"pcm-s32":return Tt;case"pcm-s32be":return Tt;case"pcm-f32":return Tt;case"pcm-f32be":return Tt;case"pcm-f64":return Tt;case"pcm-f64be":return Tt}return null},sd={webvtt:"wvtt"},ad={webvtt:Au},ro=e=>{d(e.length===3);let t=0;for(let r=0;r<3;r++)t<<=5,t+=e.charCodeAt(r)-96;return t},Es=class{constructor(){this.ensureMonotonicity=!1,this.trackedWrites=null,this.trackedStart=-1,this.trackedEnd=-1}start(){}maybeTrackWrites(e){if(!this.trackedWrites)return;let t=this.getPos();if(t<this.trackedStart){if(t+e.byteLength<=this.trackedStart)return;e=e.subarray(this.trackedStart-t),t=0}let r=t+e.byteLength-this.trackedStart,i=this.trackedWrites.byteLength;for(;i<r;)i*=2;if(i!==this.trackedWrites.byteLength){let s=new Uint8Array(i);s.set(this.trackedWrites,0),this.trackedWrites=s}this.trackedWrites.set(e,t-this.trackedStart),this.trackedEnd=Math.max(this.trackedEnd,t+e.byteLength)}startTrackingWrites(){this.trackedWrites=new Uint8Array(2**10),this.trackedStart=this.getPos(),this.trackedEnd=this.trackedStart}stopTrackingWrites(){if(!this.trackedWrites)throw new Error("Internal error: Can't get tracked writes since nothing was tracked.");let t={data:this.trackedWrites.subarray(0,this.trackedEnd-this.trackedStart),start:this.trackedStart,end:this.trackedEnd};return this.trackedWrites=null,t}},As=2**16,Bs=2**32,io=class extends Es{constructor(e){if(super(),this.pos=0,this.maxPos=0,this.target=e,this.supportsResize="resize"in new ArrayBuffer(0),this.supportsResize)try{this.buffer=new ArrayBuffer(As,{maxByteLength:Bs})}catch{this.buffer=new ArrayBuffer(As),this.supportsResize=!1}else this.buffer=new ArrayBuffer(As);this.bytes=new Uint8Array(this.buffer)}ensureSize(e){let t=this.buffer.byteLength;for(;t<e;)t*=2;if(t!==this.buffer.byteLength){if(t>Bs)throw new Error("ArrayBuffer exceeded maximum size of ".concat(Bs," bytes. Please consider using another target."));if(this.supportsResize)this.buffer.resize(t);else{let r=new ArrayBuffer(t),i=new Uint8Array(r);i.set(this.bytes,0),this.buffer=r,this.bytes=i}}}write(e){this.maybeTrackWrites(e),this.ensureSize(this.pos+e.byteLength),this.bytes.set(e,this.pos),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.maxPos=Math.max(this.maxPos,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){}async finalize(){this.ensureSize(this.pos),this.target.buffer=this.buffer.slice(0,Math.max(this.maxPos,this.pos))}async close(){}getSlice(e,t){return this.bytes.slice(e,t)}},nd=2**24,od=2,cd=class extends Es{constructor(e){super(),this.pos=0,this.sections=[],this.lastWriteEnd=0,this.lastFlushEnd=0,this.writer=null,this.chunks=[],this.target=e,this.chunked=e._options.chunked??!1,this.chunkSize=e._options.chunkSize??nd}start(){this.writer=this.target._writable.getWriter()}write(e){if(this.pos>this.lastWriteEnd){let t=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(t))}this.maybeTrackWrites(e),this.sections.push({data:e.slice(),start:this.pos}),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength,this.lastWriteEnd=Math.max(this.lastWriteEnd,this.pos)}seek(e){this.pos=e}getPos(){return this.pos}async flush(){if(this.pos>this.lastWriteEnd){let r=this.pos-this.lastWriteEnd;this.pos=this.lastWriteEnd,this.write(new Uint8Array(r))}if(d(this.writer),this.sections.length===0)return;let e=[],t=[...this.sections].sort((r,i)=>r.start-i.start);e.push({start:t[0].start,size:t[0].data.byteLength});for(let r=1;r<t.length;r++){let i=e[e.length-1],s=t[r];s.start<=i.start+i.size?i.size=Math.max(i.size,s.start+s.data.byteLength-i.start):e.push({start:s.start,size:s.data.byteLength})}for(let r of e){r.data=new Uint8Array(r.size);for(let i of this.sections)r.start<=i.start&&i.start<r.start+r.size&&r.data.set(i.data,i.start-r.start);if(this.writer.desiredSize!==null&&this.writer.desiredSize<=0&&await this.writer.ready,this.chunked)this.writeDataIntoChunks(r.data,r.start),this.tryToFlushChunks();else{if(this.ensureMonotonicity&&r.start!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data,position:r.start}),this.lastFlushEnd=r.start+r.data.byteLength}}this.sections.length=0}writeDataIntoChunks(e,t){let r=this.chunks.findIndex(o=>o.start<=t&&t<o.start+this.chunkSize);r===-1&&(r=this.createChunk(t));let i=this.chunks[r],s=t-i.start,a=e.subarray(0,Math.min(this.chunkSize-s,e.byteLength));i.data.set(a,s);let n={start:s,end:s+a.byteLength};if(this.insertSectionIntoChunk(i,n),i.written[0].start===0&&i.written[0].end===this.chunkSize&&(i.shouldFlush=!0),this.chunks.length>od){for(let o=0;o<this.chunks.length-1;o++)this.chunks[o].shouldFlush=!0;this.tryToFlushChunks()}a.byteLength<e.byteLength&&this.writeDataIntoChunks(e.subarray(a.byteLength),t+a.byteLength)}insertSectionIntoChunk(e,t){let r=0,i=e.written.length-1,s=-1;for(;r<=i;){let a=Math.floor(r+(i-r+1)/2);e.written[a].start<=t.start?(r=a+1,s=a):i=a-1}for(e.written.splice(s+1,0,t),(s===-1||e.written[s].end<t.start)&&s++;s<e.written.length-1&&e.written[s].end>=e.written[s+1].start;)e.written[s].end=Math.max(e.written[s].end,e.written[s+1].end),e.written.splice(s+1,1)}createChunk(e){let r={start:Math.floor(e/this.chunkSize)*this.chunkSize,data:new Uint8Array(this.chunkSize),written:[],shouldFlush:!1};return this.chunks.push(r),this.chunks.sort((i,s)=>i.start-s.start),this.chunks.indexOf(r)}tryToFlushChunks(e=!1){d(this.writer);for(let t=0;t<this.chunks.length;t++){let r=this.chunks[t];if(!(!r.shouldFlush&&!e)){for(let i of r.written){let s=r.start+i.start;if(this.ensureMonotonicity&&s!==this.lastFlushEnd)throw new Error("Internal error: Monotonicity violation.");this.writer.write({type:"write",data:r.data.subarray(i.start,i.end),position:s}),this.lastFlushEnd=r.start+i.end}this.chunks.splice(t--,1)}}}finalize(){return this.chunked&&this.tryToFlushChunks(!0),d(this.writer),this.writer.close()}async close(){return this.writer?.close()}},ld=class extends Es{constructor(e){super(),this.target=e,this.pos=0}write(e){this.maybeTrackWrites(e),this.target.onwrite?.(this.pos,this.pos+e.byteLength),this.pos+=e.byteLength}getPos(){return this.pos}seek(e){this.pos=e}async flush(){}async finalize(){}async close(){}},so=Se(Je(),1),ud=typeof so<"u"?so:void 0,Pr=class{constructor(){this._output=null,this.onwrite=null}},ao=class extends Pr{constructor(){super(...arguments),this.buffer=null}_createWriter(){return new io(this)}},no=class extends Pr{constructor(e,t={}){if(super(),!(e instanceof WritableStream))throw new TypeError("StreamTarget requires a WritableStream instance.");if(t!=null&&typeof t!="object")throw new TypeError("StreamTarget options, when provided, must be an object.");if(t.chunked!==void 0&&typeof t.chunked!="boolean")throw new TypeError("options.chunked, when provided, must be a boolean.");if(t.chunkSize!==void 0&&(!Number.isInteger(t.chunkSize)||t.chunkSize<1024))throw new TypeError("options.chunkSize, when provided, must be an integer and not smaller than 1024.");this._writable=e,this._options=t}_createWriter(){return new cd(this)}},dd=class extends Pr{constructor(e,t={}){if(typeof e!="string")throw new TypeError("filePath must be a string.");if(!t||typeof t!="object")throw new TypeError("options must be an object.");super(),this._fileHandle=null;let r=new WritableStream({start:async()=>{this._fileHandle=await ud.fs.open(e,"w")},write:async i=>{d(this._fileHandle),await this._fileHandle.write(i.data,0,i.data.byteLength,i.position)},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}});this._streamTarget=new no(r,{chunked:!0,...t}),this._streamTarget._output=this._output}_createWriter(){return this._streamTarget._createWriter()}},oo=class extends Pr{_createWriter(){return new ld(this)}},Fs=1e3,hd=2082844800,fd=e=>{let t={},r=e.track;return r.metadata.name!==void 0&&(t.name=r.metadata.name),t},xe=(e,t,r=!0)=>{let i=e*t;return r?Math.round(i):i},md=class extends tr{constructor(e,t){super(e),this.auxTarget=new ao,this.auxWriter=this.auxTarget._createWriter(),this.auxBoxWriter=new Hn(this.auxWriter),this.mdat=null,this.ftypSize=null,this.trackDatas=[],this.allTracksKnown=ke(),this.creationTime=Math.floor(Date.now()/1e3)+hd,this.finalizedChunks=[],this.nextFragmentNumber=1,this.maxWrittenTimestamp=-1/0,this.format=t,this.writer=e._writer,this.boxWriter=new Hn(this.writer),this.isQuickTime=t instanceof Rs;let r=this.writer instanceof io?"in-memory":!1;this.fastStart=t._options.fastStart??r,this.isFragmented=this.fastStart==="fragmented",(this.fastStart==="in-memory"||this.isFragmented)&&(this.writer.ensureMonotonicity=!0),this.minimumFragmentDuration=t._options.minimumFragmentDuration??1}async start(){let e=await this.mutex.acquire(),t=this.output._tracks.some(r=>r.type==="video"&&r.source._codec==="avc");if(this.format._options.onFtyp&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(eu({isQuickTime:this.isQuickTime,holdsAvc:t,fragmented:this.isFragmented})),this.format._options.onFtyp){let{data:r,start:i}=this.writer.stopTrackingWrites();this.format._options.onFtyp(r,i)}if(this.ftypSize=this.writer.getPos(),this.fastStart!=="in-memory")if(this.fastStart==="reserve"){for(let r of this.output._tracks)if(r.metadata.maximumPacketCount===void 0)throw new Error("All tracks must specify maximumPacketCount in their metadata when using fastStart: 'reserve'.")}else this.isFragmented||(this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Pi(!0),this.boxWriter.writeBox(this.mdat));await this.writer.flush(),e()}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Wa({isQuickTime:this.isQuickTime,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,r){let i=this.trackDatas.find(c=>c.track===e);if(i)return i;_a(r),d(r),d(r.decoderConfig);let s={...r.decoderConfig};d(s.codedWidth!==void 0),d(s.codedHeight!==void 0);let a=!1;if(e.source._codec==="avc"&&!s.description){let c=Pa(t.data);if(!c)throw new Error("Couldn't extract an AVCDecoderConfigurationRecord from the AVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.264) when not providing a description, or provide a description (must be an AVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in AVCC format.");s.description=Ac(c),a=!0}else if(e.source._codec==="hevc"&&!s.description){let c=Ea(t.data);if(!c)throw new Error("Couldn't extract an HEVCDecoderConfigurationRecord from the HEVC packet. Make sure the packets are in Annex B format (as specified in ITU-T-REC-H.265) when not providing a description, or provide a description (must be an HEVCDecoderConfigurationRecord as specified in ISO 14496-15) and ensure the packets are in HEVC format.");s.description=Oc(c),a=!0}let n=dc(1/(e.metadata.frameRate??57600),1e6).denominator,o={muxer:this,track:e,type:"video",info:{width:s.codedWidth,height:s.codedHeight,decoderConfig:s,requiresAnnexBTransformation:a},timescale:n,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(o),this.trackDatas.sort((c,l)=>c.track.id-l.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),o}getAudioTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;gr(t),d(t),d(t.decoderConfig);let i={muxer:this,track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig,requiresPcmTransformation:!this.isFragmented&&ve.includes(e.source._codec)},timescale:t.decoderConfig.sampleRate,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[]};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;Ca(t),d(t),d(t.config);let i={muxer:this,track:e,type:"subtitle",info:{config:t.config},timescale:1e3,samples:[],sampleQueue:[],timestampProcessingQueue:[],timeToSampleTable:[],compositionTimeOffsetTable:[],lastTimescaleUnits:null,lastSample:null,finalizedChunks:[],currentChunk:null,compactlyCodedChunkTable:[],lastCueEndTimestamp:0,cueQueue:[],nextSourceId:0,cueToSourceId:new WeakMap};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,t,r),a=t.data;if(s.info.requiresAnnexBTransformation){let c=Ic(a);if(!c)throw new Error("Failed to transform packet data. Make sure all packets are provided in Annex B format, as specified in ITU-T-REC-H.264 and ITU-T-REC-H.265.");a=c}let n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),o=this.createSampleForTrack(s,a,n,t.duration,t.type);await this.registerSample(s,o)}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r),a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key"),n=this.createSampleForTrack(s,t.data,a,t.duration,t.type);s.info.requiresPcmTransformation&&await this.maybePadWithSilence(s,a),await this.registerSample(s,n)}finally{i()}}async maybePadWithSilence(e,t){let r=de(e.samples),i=r?r.timestamp+r.duration:0,s=t-i,a=xe(s,e.timescale);if(a>0){let{sampleSize:n,silentValue:o}=wt(e.info.decoderConfig.codec),c=a*e.info.numberOfChannels,l=new Uint8Array(n*c).fill(o),u=this.createSampleForTrack(e,new Uint8Array(l.buffer),i,s,"key");await this.registerSample(e,u)}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,r);this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),e.source._codec==="webvtt"&&(s.cueQueue.push(t),await this.processWebVTTCues(s,t.timestamp))}finally{i()}}async processWebVTTCues(e,t){for(;e.cueQueue.length>0;){let r=new Set([]);for(let c of e.cueQueue)d(c.timestamp<=t),d(e.lastCueEndTimestamp<=c.timestamp+c.duration),r.add(Math.max(c.timestamp,e.lastCueEndTimestamp)),r.add(c.timestamp+c.duration);let i=[...r].sort((c,l)=>c-l),s=i[0],a=i[1]??s;if(t<a)break;if(e.lastCueEndTimestamp<s){this.auxWriter.seek(0);let c=Ku();this.auxBoxWriter.writeBox(c);let l=this.auxWriter.getSlice(0,this.auxWriter.getPos()),u=this.createSampleForTrack(e,l,e.lastCueEndTimestamp,s-e.lastCueEndTimestamp,"key");await this.registerSample(e,u),e.lastCueEndTimestamp=s}this.auxWriter.seek(0);for(let c=0;c<e.cueQueue.length;c++){let l=e.cueQueue[c];if(l.timestamp>=a)break;xi.lastIndex=0;let u=xi.test(l.text),h=l.timestamp+l.duration,f=e.cueToSourceId.get(l);if(f===void 0&&a<h&&(f=e.nextSourceId++,e.cueToSourceId.set(l,f)),l.notes){let b=Xu(l.notes);this.auxBoxWriter.writeBox(b)}let w=Gu(l.text,u?s:null,l.identifier??null,l.settings??null,f??null);this.auxBoxWriter.writeBox(w),h===a&&e.cueQueue.splice(c--,1)}let n=this.auxWriter.getSlice(0,this.auxWriter.getPos()),o=this.createSampleForTrack(e,n,s,a-s,"key");await this.registerSample(e,o),e.lastCueEndTimestamp=a}}createSampleForTrack(e,t,r,i,s){return{timestamp:r,decodeTimestamp:r,duration:i,data:t,size:t.byteLength,type:s,timescaleUnitsToNextSample:xe(i,e.timescale)}}processTimestamps(e,t){if(e.timestampProcessingQueue.length===0)return;if(e.type==="audio"&&e.info.requiresPcmTransformation){let i=0;for(let s=0;s<e.timestampProcessingQueue.length;s++){let a=e.timestampProcessingQueue[s],n=xe(a.duration,e.timescale);i+=n}if(e.timeToSampleTable.length===0)e.timeToSampleTable.push({sampleCount:i,sampleDelta:1});else{let s=de(e.timeToSampleTable);s.sampleCount+=i}e.timestampProcessingQueue.length=0;return}let r=e.timestampProcessingQueue.map(i=>i.timestamp).sort((i,s)=>i-s);for(let i=0;i<e.timestampProcessingQueue.length;i++){let s=e.timestampProcessingQueue[i];s.decodeTimestamp=r[i],!this.isFragmented&&e.lastTimescaleUnits===null&&(s.decodeTimestamp=0);let a=xe(s.timestamp-s.decodeTimestamp,e.timescale),n=xe(s.duration,e.timescale);if(e.lastTimescaleUnits!==null){d(e.lastSample);let o=xe(s.decodeTimestamp,e.timescale,!1),c=Math.round(o-e.lastTimescaleUnits);if(d(c>=0),e.lastTimescaleUnits+=c,e.lastSample.timescaleUnitsToNextSample=c,!this.isFragmented){let l=de(e.timeToSampleTable);if(d(l),l.sampleCount===1){l.sampleDelta=c;let h=e.timeToSampleTable[e.timeToSampleTable.length-2];h&&h.sampleDelta===c&&(h.sampleCount++,e.timeToSampleTable.pop(),l=h)}else l.sampleDelta!==c&&(l.sampleCount--,e.timeToSampleTable.push(l={sampleCount:1,sampleDelta:c}));l.sampleDelta===n?l.sampleCount++:e.timeToSampleTable.push({sampleCount:1,sampleDelta:n});let u=de(e.compositionTimeOffsetTable);d(u),u.sampleCompositionTimeOffset===a?u.sampleCount++:e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:a})}}else e.lastTimescaleUnits=xe(s.decodeTimestamp,e.timescale,!1),this.isFragmented||(e.timeToSampleTable.push({sampleCount:1,sampleDelta:n}),e.compositionTimeOffsetTable.push({sampleCount:1,sampleCompositionTimeOffset:a}));e.lastSample=s}if(e.timestampProcessingQueue.length=0,d(e.lastSample),d(e.lastTimescaleUnits!==null),t!==void 0&&e.lastSample.timescaleUnitsToNextSample===0){d(t.type==="key");let i=xe(t.timestamp,e.timescale,!1),s=Math.round(i-e.lastTimescaleUnits);e.lastSample.timescaleUnitsToNextSample=s}}async registerSample(e,t){t.type==="key"&&this.processTimestamps(e,t),e.timestampProcessingQueue.push(t),this.isFragmented?(e.sampleQueue.push(t),await this.interleaveSamples()):this.fastStart==="reserve"?await this.registerSampleFastStartReserve(e,t):await this.addSampleToTrack(e,t)}async addSampleToTrack(e,t){if(!this.isFragmented&&(e.samples.push(t),this.fastStart==="reserve")){let i=e.track.metadata.maximumPacketCount;if(d(i!==void 0),e.samples.length>i)throw new Error("Track #".concat(e.track.id," has already reached the maximum packet count (").concat(i,"). Either add less packets or increase the maximum packet count."))}let r=!1;if(!e.currentChunk)r=!0;else{e.currentChunk.startTimestamp=Math.min(e.currentChunk.startTimestamp,t.timestamp);let i=t.timestamp-e.currentChunk.startTimestamp;if(this.isFragmented){let s=this.trackDatas.every(a=>{if(e===a)return t.type==="key";let n=a.sampleQueue[0];return n?n.type==="key":a.track.source._closed});i>=this.minimumFragmentDuration&&s&&t.timestamp>this.maxWrittenTimestamp&&(r=!0,await this.finalizeFragment())}else r=i>=.5}r&&(e.currentChunk&&await this.finalizeCurrentChunk(e),e.currentChunk={startTimestamp:t.timestamp,samples:[],offset:null,moofOffset:null}),d(e.currentChunk),e.currentChunk.samples.push(t),this.isFragmented&&(this.maxWrittenTimestamp=Math.max(this.maxWrittenTimestamp,t.timestamp))}async finalizeCurrentChunk(e){if(d(!this.isFragmented),!e.currentChunk)return;e.finalizedChunks.push(e.currentChunk),this.finalizedChunks.push(e.currentChunk);let t=e.currentChunk.samples.length;if(e.type==="audio"&&e.info.requiresPcmTransformation&&(t=e.currentChunk.samples.reduce((r,i)=>r+xe(i.duration,e.timescale),0)),(e.compactlyCodedChunkTable.length===0||de(e.compactlyCodedChunkTable).samplesPerChunk!==t)&&e.compactlyCodedChunkTable.push({firstChunk:e.finalizedChunks.length,samplesPerChunk:t}),this.fastStart==="in-memory"){e.currentChunk.offset=0;return}e.currentChunk.offset=this.writer.getPos();for(let r of e.currentChunk.samples)d(r.data),this.writer.write(r.data),r.data=null;await this.writer.flush()}async interleaveSamples(e=!1){if(d(this.isFragmented),!(!e&&!this.allTracksAreKnown()))e:for(;;){let t=null,r=1/0;for(let s of this.trackDatas){if(!e&&s.sampleQueue.length===0&&!s.track.source._closed)break e;s.sampleQueue.length>0&&s.sampleQueue[0].timestamp<r&&(t=s,r=s.sampleQueue[0].timestamp)}if(!t)break;let i=t.sampleQueue.shift();await this.addSampleToTrack(t,i)}}async finalizeFragment(e=!0){d(this.isFragmented);let t=this.nextFragmentNumber++;if(t===1){this.format._options.onMoov&&this.writer.startTrackingWrites();let f=Xr(this);if(this.boxWriter.writeBox(f),this.format._options.onMoov){let{data:w,start:b}=this.writer.stopTrackingWrites();this.format._options.onMoov(w,b)}}let r=this.trackDatas.filter(f=>f.currentChunk),i=Yn(t,r),s=this.writer.getPos(),a=s+this.boxWriter.measureBox(i),n=a+It,o=1/0;for(let f of r){f.currentChunk.offset=n,f.currentChunk.moofOffset=s;for(let w of f.currentChunk.samples)n+=w.size;o=Math.min(o,f.currentChunk.startTimestamp)}let c=n-a,l=c>=2**32;if(l)for(let f of r)f.currentChunk.offset+=ir-It;this.format._options.onMoof&&this.writer.startTrackingWrites();let u=Yn(t,r);if(this.boxWriter.writeBox(u),this.format._options.onMoof){let{data:f,start:w}=this.writer.stopTrackingWrites();this.format._options.onMoof(f,w,o)}d(this.writer.getPos()===a),this.format._options.onMdat&&this.writer.startTrackingWrites();let h=Pi(l);h.size=c,this.boxWriter.writeBox(h),this.writer.seek(a+(l?ir:It));for(let f of r)for(let w of f.currentChunk.samples)this.writer.write(w.data),w.data=null;if(this.format._options.onMdat){let{data:f,start:w}=this.writer.stopTrackingWrites();this.format._options.onMdat(f,w)}for(let f of r)f.finalizedChunks.push(f.currentChunk),this.finalizedChunks.push(f.currentChunk),f.currentChunk=null;e&&await this.writer.flush()}async registerSampleFastStartReserve(e,t){if(this.allTracksAreKnown()){if(!this.mdat){let r=Xr(this),s=this.boxWriter.measureBox(r)+this.computeSampleTableSizeUpperBound()+4096;d(this.ftypSize!==null),this.writer.seek(this.ftypSize+s),this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat=Pi(!0),this.boxWriter.writeBox(this.mdat);for(let a of this.trackDatas){for(let n of a.sampleQueue)await this.addSampleToTrack(a,n);a.sampleQueue.length=0}}await this.addSampleToTrack(e,t)}else e.sampleQueue.push(t)}computeSampleTableSizeUpperBound(){d(this.fastStart==="reserve");let e=0;for(let t of this.trackDatas){let r=t.track.metadata.maximumPacketCount;d(r!==void 0),e+=8*Math.ceil(2/3*r),e+=4*r,e+=8*Math.ceil(2/3*r),e+=12*Math.ceil(2/3*r),e+=4*r,e+=8*r}return e}async onTrackClose(e){let t=await this.mutex.acquire();if(e.type==="subtitle"&&e.source._codec==="webvtt"){let r=this.trackDatas.find(i=>i.track===e);r&&await this.processWebVTTCues(r,1/0)}this.allTracksAreKnown()&&this.allTracksKnown.resolve(),this.isFragmented&&await this.interleaveSamples(),t()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve();for(let t of this.trackDatas)t.type==="subtitle"&&t.track.source._codec==="webvtt"&&await this.processWebVTTCues(t,1/0);if(this.isFragmented){await this.interleaveSamples(!0);for(let t of this.trackDatas)this.processTimestamps(t);await this.finalizeFragment(!1)}else for(let t of this.trackDatas)this.processTimestamps(t),await this.finalizeCurrentChunk(t);if(this.fastStart==="in-memory"){this.mdat=Pi(!1);let t;for(let i=0;i<2;i++){let s=Xr(this),a=this.boxWriter.measureBox(s);t=this.boxWriter.measureBox(this.mdat);let n=this.writer.getPos()+a+t;for(let o of this.finalizedChunks){o.offset=n;for(let{data:c}of o.samples)d(c),n+=c.byteLength,t+=c.byteLength}if(n<2**32)break;t>=2**32&&(this.mdat.largeSize=!0)}this.format._options.onMoov&&this.writer.startTrackingWrites();let r=Xr(this);if(this.boxWriter.writeBox(r),this.format._options.onMoov){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onMoov(i,s)}this.format._options.onMdat&&this.writer.startTrackingWrites(),this.mdat.size=t,this.boxWriter.writeBox(this.mdat);for(let i of this.finalizedChunks)for(let s of i.samples)d(s.data),this.writer.write(s.data),s.data=null;if(this.format._options.onMdat){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onMdat(i,s)}}else if(this.isFragmented){let t=this.writer.getPos(),r=$u(this.trackDatas);this.boxWriter.writeBox(r);let i=this.writer.getPos()-t;this.writer.seek(this.writer.getPos()-4),this.boxWriter.writeU32(i)}else{d(this.mdat);let t=this.boxWriter.offsets.get(this.mdat);d(t!==void 0);let r=this.writer.getPos()-t;if(this.mdat.size=r,this.mdat.largeSize=r>=2**32,this.boxWriter.patchBox(this.mdat),this.format._options.onMdat){let{data:s,start:a}=this.writer.stopTrackingWrites();this.format._options.onMdat(s,a)}let i=Xr(this);if(this.fastStart==="reserve"){d(this.ftypSize!==null),this.writer.seek(this.ftypSize),this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(i);let s=this.boxWriter.offsets.get(this.mdat)-this.writer.getPos();this.boxWriter.writeBox(tu(s))}else this.format._options.onMoov&&this.writer.startTrackingWrites(),this.boxWriter.writeBox(i);if(this.format._options.onMoov){let{data:s,start:a}=this.writer.stopTrackingWrites();this.format._options.onMoov(s,a)}}e()}},pd=-(2**15),gd=2**15-1,co="Mediabunny",lo=6,uo=5,wd={video:1,audio:2,subtitle:17},bd=class extends tr{constructor(e,t){super(e),this.trackDatas=[],this.allTracksKnown=ke(),this.segment=null,this.segmentInfo=null,this.seekHead=null,this.tracksElement=null,this.tagsElement=null,this.attachmentsElement=null,this.segmentDuration=null,this.cues=null,this.currentCluster=null,this.currentClusterStartMsTimestamp=null,this.currentClusterMaxMsTimestamp=null,this.trackDatasInCurrentCluster=new Map,this.duration=0,this.writer=e._writer,this.format=t,this.ebmlWriter=new ll(this.writer),this.format._options.appendOnly&&(this.writer.ensureMonotonicity=!0)}async start(){let e=await this.mutex.acquire();this.writeEBMLHeader(),this.createSegmentInfo(),this.createCues(),await this.writer.flush(),e()}writeEBMLHeader(){this.format._options.onEbmlHeader&&this.writer.startTrackingWrites();let e={id:440786851,data:[{id:17030,data:1},{id:17143,data:1},{id:17138,data:4},{id:17139,data:8},{id:17026,data:this.format instanceof Os?"webm":"matroska"},{id:17031,data:2},{id:17029,data:2}]};if(this.ebmlWriter.writeEBML(e),this.format._options.onEbmlHeader){let{data:t,start:r}=this.writer.stopTrackingWrites();this.format._options.onEbmlHeader(t,r)}}maybeCreateSeekHead(e){if(this.format._options.appendOnly)return;let t=new Uint8Array([28,83,187,107]),r=new Uint8Array([21,73,169,102]),i=new Uint8Array([22,84,174,107]),s=new Uint8Array([25,65,164,105]),a=new Uint8Array([18,84,195,103]),n={id:290298740,data:[{id:19899,data:[{id:21419,data:t},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.cues)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:r},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.segmentInfo)-this.segmentDataOffset:0}]},{id:19899,data:[{id:21419,data:i},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tracksElement)-this.segmentDataOffset:0}]},this.attachmentsElement?{id:19899,data:[{id:21419,data:s},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.attachmentsElement)-this.segmentDataOffset:0}]}:null,this.tagsElement?{id:19899,data:[{id:21419,data:a},{id:21420,size:5,data:e?this.ebmlWriter.offsets.get(this.tagsElement)-this.segmentDataOffset:0}]}:null]};this.seekHead=n}createSegmentInfo(){let e={id:17545,data:new is(0)};this.segmentDuration=e;let t={id:357149030,data:[{id:2807729,data:1e6},{id:19840,data:co},{id:22337,data:co},this.format._options.appendOnly?null:e]};this.segmentInfo=t}createTracks(){let e={id:374648427,data:[]};this.tracksElement=e;for(let t of this.trackDatas){let r=lt[t.track.source._codec];d(r);let i=0;if(t.type==="audio"&&t.track.source._codec==="opus"){i=1e6*80;let s=t.info.decoderConfig.description;if(s){let a=ge(s),n=hi(a);i=Math.round(1e9*(n.preSkip/pr))}}e.data.push({id:174,data:[{id:215,data:t.track.id},{id:29637,data:t.track.id},{id:131,data:wd[t.type]},{id:156,data:0},{id:2274716,data:t.track.metadata.languageCode??je},{id:134,data:r},{id:22186,data:0},{id:22203,data:i},t.track.metadata.name!==void 0?{id:21358,data:new Wt(t.track.metadata.name)}:null,t.type==="video"?this.videoSpecificTrackInfo(t):null,t.type==="audio"?this.audioSpecificTrackInfo(t):null,t.type==="subtitle"?this.subtitleSpecificTrackInfo(t):null]})}}videoSpecificTrackInfo(e){let{frameRate:t,rotation:r}=e.track.metadata,i=[e.info.decoderConfig.description?{id:25506,data:ge(e.info.decoderConfig.description)}:null,t?{id:2352003,data:1e9/t}:null],s=r?pt(-r):0,a=e.info.decoderConfig.colorSpace,n={id:224,data:[{id:176,data:e.info.width},{id:186,data:e.info.height},e.info.alphaMode?{id:21440,data:1}:null,ii(a)?{id:21936,data:[{id:21937,data:nt[a.matrix]},{id:21946,data:_t[a.transfer]},{id:21947,data:Ae[a.primaries]},{id:21945,data:a.fullRange?2:1}]}:null,s?{id:30320,data:[{id:30321,data:0},{id:30325,data:new rs((s+180)%360-180)}]}:null]};return i.push(n),i}audioSpecificTrackInfo(e){let t=ve.includes(e.track.source._codec)?wt(e.track.source._codec):null;return[e.info.decoderConfig.description?{id:25506,data:ge(e.info.decoderConfig.description)}:null,{id:225,data:[{id:181,data:new rs(e.info.sampleRate)},{id:159,data:e.info.numberOfChannels},t?{id:25188,data:8*t.sampleSize}:null]}]}subtitleSpecificTrackInfo(e){return[{id:25506,data:J.encode(e.info.config.description)}]}maybeCreateTags(){let e=[],t=(s,a)=>{e.push({id:26568,data:[{id:17827,data:new Wt(s)},typeof a=="string"?{id:17543,data:new Wt(a)}:{id:17541,data:a}]})},r=this.output._metadataTags,i=new Set;for(let{key:s,value:a}of fr(r))switch(s){case"title":t("TITLE",a),i.add("TITLE");break;case"description":t("DESCRIPTION",a),i.add("DESCRIPTION");break;case"artist":t("ARTIST",a),i.add("ARTIST");break;case"album":t("ALBUM",a),i.add("ALBUM");break;case"albumArtist":t("ALBUM_ARTIST",a),i.add("ALBUM_ARTIST");break;case"genre":t("GENRE",a),i.add("GENRE");break;case"comment":t("COMMENT",a),i.add("COMMENT");break;case"lyrics":t("LYRICS",a),i.add("LYRICS");break;case"date":t("DATE",a.toISOString().slice(0,10)),i.add("DATE");break;case"trackNumber":{let n=r.tracksTotal!==void 0?"".concat(a,"/").concat(r.tracksTotal):a.toString();t("PART_NUMBER",n),i.add("PART_NUMBER")}break;case"discNumber":{let n=r.discsTotal!==void 0?"".concat(a,"/").concat(r.discsTotal):a.toString();t("DISC",n),i.add("DISC")}break;case"tracksTotal":case"discsTotal":break;case"images":case"raw":break;default:Re(s)}if(r.raw)for(let s in r.raw){let a=r.raw[s];a==null||i.has(s)||(typeof a=="string"||a instanceof Uint8Array)&&t(s,a)}e.length!==0&&(this.tagsElement={id:307544935,data:[{id:29555,data:[{id:25536,data:[{id:26826,data:50},{id:25546,data:"MOVIE"}]},...e]}]})}maybeCreateAttachments(){let e=this.output._metadataTags,t=[],r=new Set,i=e.images??[];for(let s of i){let a=s.name;a===void 0&&(a=(s.kind==="coverFront"?"cover":s.kind==="coverBack"?"back":"image")+(hc(s.mimeType)??""));let n;for(;;){n=0n;for(let o=0;o<8;o++)n<<=8n,n|=BigInt(Math.floor(Math.random()*256));if(n!==0n&&!r.has(n))break}r.add(n),t.push({id:24999,data:[s.description!==void 0?{id:18046,data:new Wt(s.description)}:null,{id:18030,data:new Wt(a)},{id:18016,data:s.mimeType},{id:18012,data:s.data},{id:18094,data:n}]})}for(let[s,a]of Object.entries(e.raw??{}))!(a instanceof ci)||!/^\d+$/.test(s)||i.find(o=>o.mimeType===a.mimeType&&pc(o.data,a.data))||t.push({id:24999,data:[a.description!==void 0?{id:18046,data:new Wt(a.description)}:null,{id:18030,data:new Wt(a.name??"")},{id:18016,data:a.mimeType??""},{id:18012,data:a.data},{id:18094,data:BigInt(s)}]});t.length!==0&&(this.attachmentsElement={id:423732329,data:t})}createSegment(){this.createTracks(),this.maybeCreateTags(),this.maybeCreateAttachments(),this.maybeCreateSeekHead(!1);let e={id:408125543,size:this.format._options.appendOnly?-1:lo,data:[this.seekHead,this.segmentInfo,this.tracksElement,this.attachmentsElement,this.tagsElement]};if(this.segment=e,this.format._options.onSegmentHeader&&this.writer.startTrackingWrites(),this.ebmlWriter.writeEBML(e),this.format._options.onSegmentHeader){let{data:t,start:r}=this.writer.stopTrackingWrites();this.format._options.onSegmentHeader(t,r)}}createCues(){this.cues={id:475249515,data:[]}}get segmentDataOffset(){return d(this.segment),this.ebmlWriter.dataOffsets.get(this.segment)}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async getMimeType(){await this.allTracksKnown.promise;let e=this.trackDatas.map(t=>t.type==="video"||t.type==="audio"?t.info.decoderConfig.codec:{webvtt:"wvtt"}[t.track.source._codec]);return Ja({isWebM:this.format instanceof Os,hasVideo:this.trackDatas.some(t=>t.type==="video"),hasAudio:this.trackDatas.some(t=>t.type==="audio"),codecStrings:e})}getVideoTrackData(e,t,r){let i=this.trackDatas.find(a=>a.track===e);if(i)return i;_a(r),d(r),d(r.decoderConfig),d(r.decoderConfig.codedWidth!==void 0),d(r.decoderConfig.codedHeight!==void 0);let s={track:e,type:"video",info:{width:r.decoderConfig.codedWidth,height:r.decoderConfig.codedHeight,decoderConfig:r.decoderConfig,alphaMode:!!t.sideData.alpha},chunkQueue:[],lastWrittenMsTimestamp:null};return e.source._codec==="vp9"?s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(wc(s.info.decoderConfig.codec))}:e.source._codec==="av1"&&(s.info.decoderConfig={...s.info.decoderConfig,description:new Uint8Array(ba(s.info.decoderConfig.codec))}),this.trackDatas.push(s),this.trackDatas.sort((a,n)=>a.track.id-n.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}getAudioTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;gr(t),d(t),d(t.decoderConfig);let i={track:e,type:"audio",info:{numberOfChannels:t.decoderConfig.numberOfChannels,sampleRate:t.decoderConfig.sampleRate,decoderConfig:t.decoderConfig},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}getSubtitleTrackData(e,t){let r=this.trackDatas.find(s=>s.track===e);if(r)return r;Ca(t),d(t),d(t.config);let i={track:e,type:"subtitle",info:{config:t.config},chunkQueue:[],lastWrittenMsTimestamp:null};return this.trackDatas.push(i),this.trackDatas.sort((s,a)=>s.track.id-a.track.id),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),i}async addEncodedVideoPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getVideoTrackData(e,t,r),a=t.type==="key",n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,a),o=t.duration;e.metadata.frameRate!==void 0&&(n=Oi(n,1/e.metadata.frameRate),o=Oi(o,1/e.metadata.frameRate));let c=s.info.alphaMode?t.sideData.alpha??null:null,l=this.createInternalChunk(t.data,n,o,t.type,c);e.source._codec==="vp9"&&this.fixVP9ColorSpace(s,l),s.chunkQueue.push(l),await this.interleaveChunks()}finally{i()}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getAudioTrackData(e,r),a=t.type==="key",n=this.validateAndNormalizeTimestamp(s.track,t.timestamp,a),o=this.createInternalChunk(t.data,n,t.duration,t.type);s.chunkQueue.push(o),await this.interleaveChunks()}finally{i()}}async addSubtitleCue(e,t,r){let i=await this.mutex.acquire();try{let s=this.getSubtitleTrackData(e,r),a=this.validateAndNormalizeTimestamp(s.track,t.timestamp,!0),n=t.text,o=Math.round(a*1e3);xi.lastIndex=0,n=n.replace(xi,h=>{let w=vs(h.slice(1,-1))-o;return"<".concat(Wn(w),">")});let c=J.encode(n),l="".concat(t.settings??"","\n").concat(t.identifier??"","\n").concat(t.notes??""),u=this.createInternalChunk(c,a,t.duration,"key",l.trim()?J.encode(l):null);s.chunkQueue.push(u),await this.interleaveChunks()}finally{i()}}async interleaveChunks(e=!1){if(!(!e&&!this.allTracksAreKnown())){e:for(;;){let t=null,r=1/0;for(let s of this.trackDatas){if(!e&&s.chunkQueue.length===0&&!s.track.source._closed)break e;s.chunkQueue.length>0&&s.chunkQueue[0].timestamp<r&&(t=s,r=s.chunkQueue[0].timestamp)}if(!t)break;let i=t.chunkQueue.shift();this.writeBlock(t,i)}e||await this.writer.flush()}}fixVP9ColorSpace(e,t){if(t.type!=="key"||!e.info.decoderConfig.colorSpace||!e.info.decoderConfig.colorSpace.matrix)return;let r=new ce(t.data);r.skipBits(2);let i=r.readBits(1),a=(r.readBits(1)<<1)+i;if(a===3&&r.skipBits(1),r.readBits(1)||r.readBits(1)!==0||(r.skipBits(2),r.readBits(24)!==4817730))return;a>=2&&r.skipBits(1);let l={rgb:7,bt709:2,bt470bg:1,smpte170m:3}[e.info.decoderConfig.colorSpace.matrix];dr(t.data,r.pos,r.pos+3,l)}createInternalChunk(e,t,r,i,s=null){return{data:e,type:i,timestamp:t,duration:r,additions:s}}writeBlock(e,t){this.segment||this.createSegment();let r=Math.round(1e3*t.timestamp),i=this.trackDatas.every(l=>{if(e===l)return t.type==="key";let u=l.chunkQueue[0];return u?u.type==="key":l.track.source._closed}),s=!1;if(!this.currentCluster)s=!0;else{d(this.currentClusterStartMsTimestamp!==null),d(this.currentClusterMaxMsTimestamp!==null);let l=r-this.currentClusterStartMsTimestamp;s=i&&r>this.currentClusterMaxMsTimestamp&&l>=1e3*(this.format._options.minimumClusterDuration??1)||l>gd}s&&this.createNewCluster(r);let a=r-this.currentClusterStartMsTimestamp;if(a<pd)return;let n=new Uint8Array(4),o=new DataView(n.buffer);o.setUint8(0,128|e.track.id),o.setInt16(1,a,!1);let c=Math.round(1e3*t.duration);if(t.additions){let l={id:160,data:[{id:161,data:[n,t.data]},t.type==="delta"?{id:251,data:new ja(e.lastWrittenMsTimestamp-r)}:null,t.additions?{id:30113,data:[{id:166,data:[{id:238,data:1},{id:165,data:t.additions}]}]}:null,c>0?{id:155,data:c}:null]};this.ebmlWriter.writeEBML(l)}else{o.setUint8(3,+(t.type==="key")<<7);let l={id:163,data:[n,t.data]};this.ebmlWriter.writeEBML(l)}this.duration=Math.max(this.duration,r+c),e.lastWrittenMsTimestamp=r,this.trackDatasInCurrentCluster.has(e)||this.trackDatasInCurrentCluster.set(e,{firstMsTimestamp:r}),this.currentClusterMaxMsTimestamp=Math.max(this.currentClusterMaxMsTimestamp,r)}createNewCluster(e){this.currentCluster&&this.finalizeCurrentCluster(),this.format._options.onCluster&&this.writer.startTrackingWrites(),this.currentCluster={id:524531317,size:this.format._options.appendOnly?-1:uo,data:[{id:231,data:e}]},this.ebmlWriter.writeEBML(this.currentCluster),this.currentClusterStartMsTimestamp=e,this.currentClusterMaxMsTimestamp=e,this.trackDatasInCurrentCluster.clear()}finalizeCurrentCluster(){if(d(this.currentCluster),!this.format._options.appendOnly){let i=this.writer.getPos()-this.ebmlWriter.dataOffsets.get(this.currentCluster),s=this.writer.getPos();this.writer.seek(this.ebmlWriter.offsets.get(this.currentCluster)+4),this.ebmlWriter.writeVarInt(i,uo),this.writer.seek(s)}if(this.format._options.onCluster){d(this.currentClusterStartMsTimestamp!==null);let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onCluster(i,s,this.currentClusterStartMsTimestamp/1e3)}let e=this.ebmlWriter.offsets.get(this.currentCluster)-this.segmentDataOffset,t=new Map;for(let[i,{firstMsTimestamp:s}]of this.trackDatasInCurrentCluster)t.has(s)||t.set(s,[]),t.get(s).push(i);let r=[...t.entries()].sort((i,s)=>i[0]-s[0]);for(let[i,s]of r)d(this.cues),this.cues.data.push({id:187,data:[{id:179,data:i},...s.map(a=>({id:183,data:[{id:247,data:a.track.id},{id:241,data:e}]}))]})}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleaveChunks(),e()}async finalize(){let e=await this.mutex.acquire();if(this.allTracksKnown.resolve(),this.segment||this.createSegment(),await this.interleaveChunks(!0),this.currentCluster&&this.finalizeCurrentCluster(),d(this.cues),this.ebmlWriter.writeEBML(this.cues),!this.format._options.appendOnly){let t=this.writer.getPos(),r=this.writer.getPos()-this.segmentDataOffset;this.writer.seek(this.ebmlWriter.offsets.get(this.segment)+4),this.ebmlWriter.writeVarInt(r,lo),this.segmentDuration.data=new is(this.duration),this.writer.seek(this.ebmlWriter.offsets.get(this.segmentDuration)),this.ebmlWriter.writeEBML(this.segmentDuration),d(this.seekHead),this.writer.seek(this.ebmlWriter.offsets.get(this.seekHead)),this.maybeCreateSeekHead(!0),this.ebmlWriter.writeEBML(this.seekHead),this.writer.seek(t)}e()}},kd=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer)}writeU32(e){this.helperView.setUint32(0,e,!1),this.writer.write(this.helper.subarray(0,4))}writeXingFrame(e){let t=this.writer.getPos(),r=255,i=224|e.mpegVersionId<<3|e.layer<<1,s;e.mpegVersionId&2?s=e.mpegVersionId&1?0:1:s=1;let a=0,n=155,o=-1,c=s*16*4+e.layer*16;for(let p=0;p<16;p++){let y=ls[c+p];if(ds(s,e.layer,1e3*y,e.sampleRate,a)>=n){o=p;break}}if(o===-1)throw new Error("No suitable bitrate found.");let l=o<<4|e.frequencyIndex<<2|a<<1,u=e.channel<<6|e.modeExtension<<4|e.copyright<<3|e.original<<2|e.emphasis;this.helper[0]=r,this.helper[1]=i,this.helper[2]=l,this.helper[3]=u,this.writer.write(this.helper.subarray(0,4));let h=hs(e.mpegVersionId,e.channel);this.writer.seek(t+h),this.writeU32(us);let f=0;e.frameCount!==null&&(f|=1),e.fileSize!==null&&(f|=2),e.toc!==null&&(f|=4),this.writeU32(f),this.writeU32(e.frameCount??0),this.writeU32(e.fileSize??0),this.writer.write(e.toc??new Uint8Array(100));let w=ls[c+o],b=ds(s,e.layer,1e3*w,e.sampleRate,a);this.writer.seek(t+b)}},yd=class extends tr{constructor(e,t){super(e),this.xingFrameData=null,this.frameCount=0,this.framePositions=[],this.xingFramePos=null,this.format=t,this.writer=e._writer,this.mp3Writer=new kd(e._writer)}async start(){li(this.output._metadataTags)||new on(this.writer).writeId3V2Tag(this.output._metadataTags)}async getMimeType(){return"audio/mpeg"}async addEncodedVideoPacket(){throw new Error("MP3 does not support video.")}async addEncodedAudioPacket(e,t){let r=await this.mutex.acquire();try{let i=this.format._options.xingHeader!==!1;if(!this.xingFrameData&&i){let s=le(t.data);if(s.byteLength<4)throw new Error("Invalid MP3 header in sample.");let a=s.getUint32(0,!1),n=an(a,null).header;if(!n)throw new Error("Invalid MP3 header in sample.");let o=hs(n.mpegVersionId,n.channel);if(s.byteLength>=o+4){let c=s.getUint32(o,!1);if(c===us||c===sn)return}this.xingFrameData={mpegVersionId:n.mpegVersionId,layer:n.layer,frequencyIndex:n.frequencyIndex,sampleRate:n.sampleRate,channel:n.channel,modeExtension:n.modeExtension,copyright:n.copyright,original:n.original,emphasis:n.emphasis,frameCount:null,fileSize:null,toc:null},this.xingFramePos=this.writer.getPos(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.frameCount++}this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),this.writer.write(t.data),this.frameCount++,await this.writer.flush(),i&&this.framePositions.push(this.writer.getPos())}finally{r()}}async addSubtitleCue(){throw new Error("MP3 does not support subtitles.")}async finalize(){if(!this.xingFrameData||this.xingFramePos===null)return;let e=await this.mutex.acquire(),t=this.writer.getPos();this.writer.seek(this.xingFramePos);let r=new Uint8Array(100);for(let i=0;i<100;i++){let s=Math.floor(this.framePositions.length*(i/100));d(s!==-1&&s<this.framePositions.length);let a=this.framePositions[s];r[i]=256*(a/t)}if(this.xingFrameData.frameCount=this.frameCount,this.xingFrameData.fileSize=t,this.xingFrameData.toc=r,this.format._options.onXingFrame&&this.writer.startTrackingWrites(),this.mp3Writer.writeXingFrame(this.xingFrameData),this.format._options.onXingFrame){let{data:i,start:s}=this.writer.stopTrackingWrites();this.format._options.onXingFrame(i,s)}this.writer.seek(t),e()}},Td=8192,Sd=class extends tr{constructor(e,t){super(e),this.trackDatas=[],this.bosPagesWritten=!1,this.allTracksKnown=ke(),this.pageBytes=new Uint8Array(hn),this.pageView=new DataView(this.pageBytes.buffer),this.format=t,this.writer=e._writer,this.writer.ensureMonotonicity=!0}async start(){}async getMimeType(){return await this.allTracksKnown.promise,dn({codecStrings:this.trackDatas.map(e=>e.codecInfo.codec)})}addEncodedVideoPacket(){throw new Error("Video tracks are not supported.")}getTrackData(e,t){let r=this.trackDatas.find(a=>a.track===e);if(r)return r;let i;do i=Math.floor(2**32*Math.random());while(this.trackDatas.some(a=>a.serialNumber===i));d(e.source._codec==="vorbis"||e.source._codec==="opus"),gr(t),d(t),d(t.decoderConfig);let s={track:e,serialNumber:i,internalSampleRate:e.source._codec==="opus"?pr:t.decoderConfig.sampleRate,codecInfo:{codec:e.source._codec,vorbisInfo:null,opusInfo:null},vorbisLastBlocksize:null,packetQueue:[],currentTimestampInSamples:0,pagesWritten:0,currentGranulePosition:0,currentLacingValues:[],currentPageData:[],currentPageSize:27,currentPageStartsWithFreshPacket:!0};return this.queueHeaderPackets(s,t),this.trackDatas.push(s),this.allTracksAreKnown()&&this.allTracksKnown.resolve(),s}queueHeaderPackets(e,t){if(d(t.decoderConfig),e.track.source._codec==="vorbis"){d(t.decoderConfig.description);let r=ge(t.decoderConfig.description);if(r[0]!==2)throw new TypeError("First byte of Vorbis decoder description must be 2.");let i=1,s=()=>{let b=0;for(;;){let p=r[i++];if(p===void 0)throw new TypeError("Vorbis decoder description is too short.");if(b+=p,p<255)return b}},a=s(),n=s();if(r.length-i<=0)throw new TypeError("Vorbis decoder description is too short.");let c=r.subarray(i,i+=a);i+=n;let l=r.subarray(i),u=new Uint8Array(7);u[0]=3,u[1]=118,u[2]=111,u[3]=114,u[4]=98,u[5]=105,u[6]=115;let h=ji(u,this.output._metadataTags,!0);e.packetQueue.push({data:c,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:h,endGranulePosition:0,timestamp:0,forcePageFlush:!1},{data:l,endGranulePosition:0,timestamp:0,forcePageFlush:!0});let w=le(c).getUint8(28);e.codecInfo.vorbisInfo={blocksizes:[1<<(w&15),1<<(w>>4)],modeBlockflags:za(l).modeBlockflags}}else if(e.track.source._codec==="opus"){if(!t.decoderConfig.description)throw new TypeError("For Ogg, Opus decoder description is required.");let r=ge(t.decoderConfig.description),i=new Uint8Array(8),s=le(i);s.setUint32(0,1332770163,!1),s.setUint32(4,1415669619,!1);let a=ji(i,this.output._metadataTags,!0);e.packetQueue.push({data:r,endGranulePosition:0,timestamp:0,forcePageFlush:!0},{data:a,endGranulePosition:0,timestamp:0,forcePageFlush:!0}),e.codecInfo.opusInfo={preSkip:hi(r).preSkip}}}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{let s=this.getTrackData(e,r);this.validateAndNormalizeTimestamp(s.track,t.timestamp,t.type==="key");let a=s.currentTimestampInSamples,{durationInSamples:n,vorbisBlockSize:o}=un(t.data,s.codecInfo,s.vorbisLastBlocksize);s.currentTimestampInSamples+=n,s.vorbisLastBlocksize=o,s.packetQueue.push({data:t.data,endGranulePosition:s.currentTimestampInSamples,timestamp:a/s.internalSampleRate,forcePageFlush:!1}),await this.interleavePages()}finally{i()}}addSubtitleCue(){throw new Error("Subtitle tracks are not supported.")}allTracksAreKnown(){for(let e of this.output._tracks)if(!e.source._closed&&!this.trackDatas.some(t=>t.track===e))return!1;return!0}async interleavePages(e=!1){if(!this.bosPagesWritten){if(!this.allTracksAreKnown())return;for(let t of this.trackDatas)for(;t.packetQueue.length>0;){let r=t.packetQueue.shift();if(this.writePacket(t,r,!1),r.forcePageFlush)break}this.bosPagesWritten=!0}e:for(;;){let t=null,r=1/0;for(let a of this.trackDatas){if(!e&&a.packetQueue.length<=1&&!a.track.source._closed)break e;a.packetQueue.length>0&&a.packetQueue[0].timestamp<r&&(t=a,r=a.packetQueue[0].timestamp)}if(!t)break;let i=t.packetQueue.shift(),s=t.packetQueue.length===0;this.writePacket(t,i,s)}e||await this.writer.flush()}writePacket(e,t,r){let i=t.data.length,s=0,a=0;for(;;){e.currentLacingValues.length===0&&s>0&&(e.currentPageStartsWithFreshPacket=!1);let o=Math.min(255,i);e.currentLacingValues.push(o),e.currentPageSize++,a+=o;let c=i<255;if(e.currentLacingValues.length===255){let l=t.data.subarray(s,a);if(s=a,e.currentPageData.push(l),e.currentPageSize+=l.length,this.writePage(e,r&&c),c)return}if(c)break;i-=255}let n=t.data.subarray(s);e.currentPageData.push(n),e.currentPageSize+=n.length,e.currentGranulePosition=t.endGranulePosition,(e.currentPageSize>=Td||t.forcePageFlush)&&this.writePage(e,r)}writePage(e,t){this.pageView.setUint32(0,ps,!0),this.pageView.setUint8(4,0);let r=0;e.currentPageStartsWithFreshPacket||(r|=1),e.pagesWritten===0&&(r|=2),t&&(r|=4),this.pageView.setUint8(5,r);let i=e.currentLacingValues.every(o=>o===255)?-1:e.currentGranulePosition;cc(this.pageView,6,i,!0),this.pageView.setUint32(14,e.serialNumber,!0),this.pageView.setUint32(18,e.pagesWritten,!0),this.pageView.setUint32(22,0,!0),this.pageView.setUint8(26,e.currentLacingValues.length),this.pageBytes.set(e.currentLacingValues,27);let s=27+e.currentLacingValues.length;for(let o of e.currentPageData)this.pageBytes.set(o,s),s+=o.length;let a=this.pageBytes.subarray(0,s),n=ln(a);if(this.pageView.setUint32(22,n,!0),e.pagesWritten++,e.currentLacingValues.length=0,e.currentPageData.length=0,e.currentPageSize=27,e.currentPageStartsWithFreshPacket=!0,this.format._options.onPage&&this.writer.startTrackingWrites(),this.writer.write(a),this.format._options.onPage){let{data:o,start:c}=this.writer.stopTrackingWrites();this.format._options.onPage(o,c,e.track.source)}}async onTrackClose(){let e=await this.mutex.acquire();this.allTracksAreKnown()&&this.allTracksKnown.resolve(),await this.interleavePages(),e()}async finalize(){let e=await this.mutex.acquire();this.allTracksKnown.resolve(),await this.interleavePages(!0);for(let t of this.trackDatas)t.currentLacingValues.length>0&&this.writePage(t,!0);e()}},vd=class{constructor(e){this.writer=e,this.helper=new Uint8Array(8),this.helperView=new DataView(this.helper.buffer)}writeU16(e){this.helperView.setUint16(0,e,!0),this.writer.write(this.helper.subarray(0,2))}writeU32(e){this.helperView.setUint32(0,e,!0),this.writer.write(this.helper.subarray(0,4))}writeU64(e){this.helperView.setUint32(0,e,!0),this.helperView.setUint32(4,Math.floor(e/2**32),!0),this.writer.write(this.helper)}writeAscii(e){this.writer.write(new TextEncoder().encode(e))}},_d=class extends tr{constructor(e,t){super(e),this.headerWritten=!1,this.dataSize=0,this.sampleRate=null,this.sampleCount=0,this.riffSizePos=null,this.dataSizePos=null,this.ds64RiffSizePos=null,this.ds64DataSizePos=null,this.ds64SampleCountPos=null,this.format=t,this.writer=e._writer,this.riffWriter=new vd(e._writer),this.isRf64=!!t._options.large}async start(){}async getMimeType(){return"audio/wav"}async addEncodedVideoPacket(){throw new Error("WAVE does not support video.")}async addEncodedAudioPacket(e,t,r){let i=await this.mutex.acquire();try{if(this.headerWritten||(gr(r),d(r),d(r.decoderConfig),this.writeHeader(e,r.decoderConfig),this.sampleRate=r.decoderConfig.sampleRate,this.headerWritten=!0),this.validateAndNormalizeTimestamp(e,t.timestamp,t.type==="key"),!this.isRf64&&this.writer.getPos()+t.data.byteLength>=2**32)throw new Error("Adding more audio data would exceed the maximum RIFF size of 4 GiB. To write larger files, use RF64 by setting `large: true` in the WavOutputFormatOptions.");this.writer.write(t.data),this.dataSize+=t.data.byteLength,this.sampleCount+=Math.round(t.duration*this.sampleRate),await this.writer.flush()}finally{i()}}async addSubtitleCue(){throw new Error("WAVE does not support subtitles.")}writeHeader(e,t){this.format._options.onHeader&&this.writer.startTrackingWrites();let r,i=e.source._codec,s=wt(i);s.dataType==="ulaw"?r=7:s.dataType==="alaw"?r=6:s.dataType==="float"?r=3:r=1;let a=t.numberOfChannels,n=t.sampleRate,o=s.sampleSize*a;if(this.riffWriter.writeAscii(this.isRf64?"RF64":"RIFF"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.riffSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("WAVE"),this.isRf64&&(this.riffWriter.writeAscii("ds64"),this.riffWriter.writeU32(28),this.ds64RiffSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64DataSizePos=this.writer.getPos(),this.riffWriter.writeU64(0),this.ds64SampleCountPos=this.writer.getPos(),this.riffWriter.writeU64(0),this.riffWriter.writeU32(0)),this.riffWriter.writeAscii("fmt "),this.riffWriter.writeU32(16),this.riffWriter.writeU16(r),this.riffWriter.writeU16(a),this.riffWriter.writeU32(n),this.riffWriter.writeU32(n*o),this.riffWriter.writeU16(o),this.riffWriter.writeU16(8*s.sampleSize),!li(this.output._metadataTags)){let c=this.format._options.metadataFormat??"info";c==="info"?this.writeInfoChunk(this.output._metadataTags):c==="id3"?this.writeId3Chunk(this.output._metadataTags):Re(c)}if(this.riffWriter.writeAscii("data"),this.isRf64?this.riffWriter.writeU32(4294967295):(this.dataSizePos=this.writer.getPos(),this.riffWriter.writeU32(0)),this.format._options.onHeader){let{data:c,start:l}=this.writer.stopTrackingWrites();this.format._options.onHeader(c,l)}}writeInfoChunk(e){let t=this.writer.getPos();this.riffWriter.writeAscii("LIST"),this.riffWriter.writeU32(0),this.riffWriter.writeAscii("INFO");let r=new Set,i=(n,o)=>{if(!et(o)){console.warn("Didn't write tag '".concat(n,"' because '").concat(o,"' is not ISO 8859-1-compatible."));return}let c=o.length+1,l=new Uint8Array(c);for(let u=0;u<o.length;u++)l[u]=o.charCodeAt(u);this.riffWriter.writeAscii(n),this.riffWriter.writeU32(c),this.writer.write(l),c&1&&this.writer.write(new Uint8Array(1)),r.add(n)};for(let{key:n,value:o}of fr(e))switch(n){case"title":i("INAM",o),r.add("INAM");break;case"artist":i("IART",o),r.add("IART");break;case"album":i("IPRD",o),r.add("IPRD");break;case"trackNumber":{let c=e.tracksTotal!==void 0?"".concat(o,"/").concat(e.tracksTotal):o.toString();i("ITRK",c),r.add("ITRK")}break;case"genre":i("IGNR",o),r.add("IGNR");break;case"date":i("ICRD",o.toISOString().slice(0,10)),r.add("ICRD");break;case"comment":i("ICMT",o),r.add("ICMT");break;case"albumArtist":case"discNumber":case"tracksTotal":case"discsTotal":case"description":case"lyrics":case"images":break;case"raw":break;default:Re(n)}if(e.raw)for(let n in e.raw){let o=e.raw[n];o==null||n.length!==4||r.has(n)||typeof o=="string"&&i(n,o)}let s=this.writer.getPos(),a=s-t-8;this.writer.seek(t+4),this.riffWriter.writeU32(a),this.writer.seek(s),a&1&&this.writer.write(new Uint8Array(1))}writeId3Chunk(e){let t=this.writer.getPos();this.riffWriter.writeAscii("ID3 "),this.riffWriter.writeU32(0);let i=new on(this.writer).writeId3V2Tag(e),s=this.writer.getPos();this.writer.seek(t+4),this.riffWriter.writeU32(i),this.writer.seek(s),i&1&&this.writer.write(new Uint8Array(1))}async finalize(){let e=await this.mutex.acquire(),t=this.writer.getPos();this.isRf64?(d(this.ds64RiffSizePos!==null),this.writer.seek(this.ds64RiffSizePos),this.riffWriter.writeU64(t-8),d(this.ds64DataSizePos!==null),this.writer.seek(this.ds64DataSizePos),this.riffWriter.writeU64(this.dataSize),d(this.ds64SampleCountPos!==null),this.writer.seek(this.ds64SampleCountPos),this.riffWriter.writeU64(this.sampleCount)):(d(this.riffSizePos!==null),this.writer.seek(this.riffSizePos),this.riffWriter.writeU32(t-8),d(this.dataSizePos!==null),this.writer.seek(this.dataSizePos),this.riffWriter.writeU32(this.dataSize)),this.writer.seek(t),e()}},Mt=class{getSupportedVideoCodecs(){return this.getSupportedCodecs().filter(e=>De.includes(e))}getSupportedAudioCodecs(){return this.getSupportedCodecs().filter(e=>Ne.includes(e))}getSupportedSubtitleCodecs(){return this.getSupportedCodecs().filter(e=>gt.includes(e))}_codecUnsupportedHint(e){return""}},Ms=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.fastStart!==void 0&&![!1,"in-memory","reserve","fragmented"].includes(e.fastStart))throw new TypeError("options.fastStart, when provided, must be false, 'in-memory', 'reserve', or 'fragmented'.");if(e.minimumFragmentDuration!==void 0&&(!Number.isFinite(e.minimumFragmentDuration)||e.minimumFragmentDuration<0))throw new TypeError("options.minimumFragmentDuration, when provided, must be a non-negative number.");if(e.onFtyp!==void 0&&typeof e.onFtyp!="function")throw new TypeError("options.onFtyp, when provided, must be a function.");if(e.onMoov!==void 0&&typeof e.onMoov!="function")throw new TypeError("options.onMoov, when provided, must be a function.");if(e.onMdat!==void 0&&typeof e.onMdat!="function")throw new TypeError("options.onMdat, when provided, must be a function.");if(e.onMoof!==void 0&&typeof e.onMoof!="function")throw new TypeError("options.onMoof, when provided, must be a function.");if(e.metadataFormat!==void 0&&!["mdir","mdta","udta","auto"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'auto', 'mdir', 'mdta', or 'udta'.");super(),this._options=e}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:2**32-1}}}get supportsVideoRotationMetadata(){return!0}_createMuxer(e){return new md(e,this)}},zs=class extends Ms{constructor(e){super(e)}get _name(){return"MP4"}get fileExtension(){return".mp4"}get mimeType(){return"video/mp4"}getSupportedCodecs(){return[...De,...er,"pcm-s16","pcm-s16be","pcm-s24","pcm-s24be","pcm-s32","pcm-s32be","pcm-f32","pcm-f32be","pcm-f64","pcm-f64be",...gt]}_codecUnsupportedHint(e){return new Rs().getSupportedCodecs().includes(e)?" Switching to MOV will grant support for this codec.":""}},Rs=class extends Ms{constructor(e){super(e)}get _name(){return"MOV"}get fileExtension(){return".mov"}get mimeType(){return"video/quicktime"}getSupportedCodecs(){return[...De,...Ne]}_codecUnsupportedHint(e){return new zs().getSupportedCodecs().includes(e)?" Switching to MP4 will grant support for this codec.":""}},Ds=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.appendOnly!==void 0&&typeof e.appendOnly!="boolean")throw new TypeError("options.appendOnly, when provided, must be a boolean.");if(e.minimumClusterDuration!==void 0&&(!Number.isFinite(e.minimumClusterDuration)||e.minimumClusterDuration<0))throw new TypeError("options.minimumClusterDuration, when provided, must be a non-negative number.");if(e.onEbmlHeader!==void 0&&typeof e.onEbmlHeader!="function")throw new TypeError("options.onEbmlHeader, when provided, must be a function.");if(e.onSegmentHeader!==void 0&&typeof e.onSegmentHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");if(e.onCluster!==void 0&&typeof e.onCluster!="function")throw new TypeError("options.onCluster, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new bd(e,this)}get _name(){return"Matroska"}getSupportedTrackCounts(){return{video:{min:0,max:1/0},audio:{min:0,max:1/0},subtitle:{min:0,max:1/0},total:{min:1,max:127}}}get fileExtension(){return".mkv"}get mimeType(){return"video/x-matroska"}getSupportedCodecs(){return[...De,...er,...ve.filter(e=>!["pcm-s8","pcm-f32be","pcm-f64be","ulaw","alaw"].includes(e)),...gt]}get supportsVideoRotationMetadata(){return!1}},Os=class extends Ds{constructor(e){super(e)}getSupportedCodecs(){return[...De.filter(e=>["vp8","vp9","av1"].includes(e)),...Ne.filter(e=>["opus","vorbis"].includes(e)),...gt]}get _name(){return"WebM"}get fileExtension(){return".webm"}get mimeType(){return"video/webm"}_codecUnsupportedHint(e){return new Ds().getSupportedCodecs().includes(e)?" Switching to MKV will grant support for this codec.":""}},Cd=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.xingHeader!==void 0&&typeof e.xingHeader!="boolean")throw new TypeError("options.xingHeader, when provided, must be a boolean.");if(e.onXingFrame!==void 0&&typeof e.onXingFrame!="function")throw new TypeError("options.onXingFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new yd(e,this)}get _name(){return"MP3"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".mp3"}get mimeType(){return"audio/mpeg"}getSupportedCodecs(){return["mp3"]}get supportsVideoRotationMetadata(){return!1}},xd=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.large!==void 0&&typeof e.large!="boolean")throw new TypeError("options.large, when provided, must be a boolean.");if(e.metadataFormat!==void 0&&!["info","id3"].includes(e.metadataFormat))throw new TypeError("options.metadataFormat, when provided, must be either 'info' or 'id3'.");if(e.onHeader!==void 0&&typeof e.onHeader!="function")throw new TypeError("options.onHeader, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new _d(e,this)}get _name(){return"WAVE"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".wav"}get mimeType(){return"audio/wav"}getSupportedCodecs(){return[...ve.filter(e=>["pcm-s16","pcm-s24","pcm-s32","pcm-f32","pcm-u8","ulaw","alaw"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},Pd=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onPage!==void 0&&typeof e.onPage!="function")throw new TypeError("options.onPage, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Sd(e,this)}get _name(){return"Ogg"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:0,max:1/0},subtitle:{min:0,max:0},total:{min:1,max:2**32}}}get fileExtension(){return".ogg"}get mimeType(){return"application/ogg"}getSupportedCodecs(){return[...Ne.filter(e=>["vorbis","opus"].includes(e))]}get supportsVideoRotationMetadata(){return!1}},Id=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");if(e.onFrame!==void 0&&typeof e.onFrame!="function")throw new TypeError("options.onFrame, when provided, must be a function.");super(),this._options=e}_createMuxer(e){return new Pc(e,this)}get _name(){return"ADTS"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".aac"}get mimeType(){return"audio/aac"}getSupportedCodecs(){return["aac"]}get supportsVideoRotationMetadata(){return!1}},Ed=class extends Mt{constructor(e={}){if(!e||typeof e!="object")throw new TypeError("options must be an object.");super(),this._options=e}_createMuxer(e){return new Xl(e,this)}get _name(){return"FLAC"}getSupportedTrackCounts(){return{video:{min:0,max:0},audio:{min:1,max:1},subtitle:{min:0,max:0},total:{min:1,max:1}}}get fileExtension(){return".flac"}get mimeType(){return"audio/flac"}getSupportedCodecs(){return["flac"]}get supportsVideoRotationMetadata(){return!1}},Ns=e=>{if(!e||typeof e!="object")throw new TypeError("Encoding config must be an object.");if(!De.includes(e.codec))throw new TypeError("Invalid video codec '".concat(e.codec,"'. Must be one of: ").concat(De.join(", "),"."));if(!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate must be a positive integer or a quality.");if(e.keyFrameInterval!==void 0&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("config.keyFrameInterval, when provided, must be a non-negative number.");if(e.sizeChangeBehavior!==void 0&&!["deny","passThrough","fill","contain","cover"].includes(e.sizeChangeBehavior))throw new TypeError("config.sizeChangeBehavior, when provided, must be 'deny', 'passThrough', 'fill', 'contain' or 'cover'.");if(e.onEncodedPacket!==void 0&&typeof e.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(e.onEncoderConfig!==void 0&&typeof e.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");ho(e.codec,e)},ho=(e,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.alpha!==void 0&&!["discard","keep"].includes(t.alpha))throw new TypeError("options.alpha, when provided, must be 'discard' or 'keep'.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.latencyMode!==void 0&&!["quality","realtime"].includes(t.latencyMode))throw new TypeError("latencyMode, when provided, must be 'quality' or 'realtime'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&va(t.fullCodecString)!==e)throw new TypeError("fullCodecString, when provided, must be a string that matches the specified codec (".concat(e,")."));if(t.hardwareAcceleration!==void 0&&!["no-preference","prefer-hardware","prefer-software"].includes(t.hardwareAcceleration))throw new TypeError("hardwareAcceleration, when provided, must be 'no-preference', 'prefer-hardware' or 'prefer-software'.");if(t.scalabilityMode!==void 0&&typeof t.scalabilityMode!="string")throw new TypeError("scalabilityMode, when provided, must be a string.");if(t.contentHint!==void 0&&typeof t.contentHint!="string")throw new TypeError("contentHint, when provided, must be a string.")},Us=e=>{let t=e.bitrate instanceof Ve?e.bitrate._toVideoBitrate(e.codec,e.width,e.height):e.bitrate;return{codec:e.fullCodecString??gc(e.codec,e.width,e.height,t),width:e.width,height:e.height,bitrate:t,bitrateMode:e.bitrateMode,alpha:e.alpha??"discard",framerate:e.framerate,latencyMode:e.latencyMode,hardwareAcceleration:e.hardwareAcceleration,scalabilityMode:e.scalabilityMode,contentHint:e.contentHint,...kc(e.codec)}},Ls=e=>{if(!e||typeof e!="object")throw new TypeError("Encoding config must be an object.");if(!Ne.includes(e.codec))throw new TypeError("Invalid audio codec '".concat(e.codec,"'. Must be one of: ").concat(Ne.join(", "),"."));if(e.bitrate===void 0&&(!ve.includes(e.codec)||e.codec==="flac"))throw new TypeError("config.bitrate must be provided for compressed audio codecs.");if(e.bitrate!==void 0&&!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("config.bitrate, when provided, must be a positive integer or a quality.");if(e.onEncodedPacket!==void 0&&typeof e.onEncodedPacket!="function")throw new TypeError("config.onEncodedChunk, when provided, must be a function.");if(e.onEncoderConfig!==void 0&&typeof e.onEncoderConfig!="function")throw new TypeError("config.onEncoderConfig, when provided, must be a function.");fo(e.codec,e)},fo=(e,t)=>{if(!t||typeof t!="object")throw new TypeError("Encoding options must be an object.");if(t.bitrateMode!==void 0&&!["constant","variable"].includes(t.bitrateMode))throw new TypeError("bitrateMode, when provided, must be 'constant' or 'variable'.");if(t.fullCodecString!==void 0&&typeof t.fullCodecString!="string")throw new TypeError("fullCodecString, when provided, must be a string.");if(t.fullCodecString!==void 0&&va(t.fullCodecString)!==e)throw new TypeError("fullCodecString, when provided, must be a string that matches the specified codec (".concat(e,")."))},Vs=e=>{let t=e.bitrate instanceof Ve?e.bitrate._toAudioBitrate(e.codec):e.bitrate;return{codec:e.fullCodecString??bc(e.codec,e.numberOfChannels,e.sampleRate),numberOfChannels:e.numberOfChannels,sampleRate:e.sampleRate,bitrate:t,bitrateMode:e.bitrateMode,...yc(e.codec)}},Ve=class{constructor(e){this._factor=e}_toVideoBitrate(e,t,r){let i=t*r,s={avc:1,hevc:.6,vp9:.6,av1:.4,vp8:1.2},a=1920*1080,n=3e6,o=Math.pow(i/a,.95),u=n*o*s[e]*this._factor;return Math.ceil(u/1e3)*1e3}_toAudioBitrate(e){if(ve.includes(e)||e==="flac")return;let r={aac:128e3,opus:64e3,mp3:16e4,vorbis:64e3}[e];if(!r)throw new Error("Unhandled codec: ".concat(e));let i=r*this._factor;return e==="aac"?i=[96e3,128e3,16e4,192e3].reduce((a,n)=>Math.abs(n-i)<Math.abs(a-i)?n:a):e==="opus"||e==="vorbis"?i=Math.max(6e3,i):e==="mp3"&&(i=[8e3,16e3,24e3,32e3,4e4,48e3,64e3,8e4,96e3,112e3,128e3,16e4,192e3,224e3,256e3,32e4].reduce((a,n)=>Math.abs(n-i)<Math.abs(a-i)?n:a)),Math.round(i/1e3)*1e3}},Ad=new Ve(.3),Bd=new Ve(.6),Fd=new Ve(1),Ws=new Ve(2),Md=new Ve(4),zd=e=>{if(De.includes(e))return Ii(e);if(Ne.includes(e))return Ei(e);if(gt.includes(e))return Ai(e);throw new TypeError("Unknown codec '".concat(e,"'."))},Ii=async(e,t={})=>{let{width:r=1280,height:i=720,bitrate:s=1e6,...a}=t;if(!De.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw new TypeError("width must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("height must be a positive integer.");if(!(s instanceof Ve)&&(!Number.isInteger(s)||s<=0))throw new TypeError("bitrate must be a positive integer or a quality.");ho(e,a);let n=null;return Ur.length>0&&(n??(n=Us({codec:e,width:r,height:i,bitrate:s,framerate:void 0,...a})),Ur.some(l=>l.supports(e,n)))?!0:typeof VideoEncoder>"u"||(r%2===1||i%2===1)&&(e==="avc"||e==="hevc")?!1:(n??(n=Us({codec:e,width:r,height:i,bitrate:s,framerate:void 0,...a,alpha:"discard"})),(await VideoEncoder.isConfigSupported(n)).supported===!0)},Ei=async(e,t={})=>{let{numberOfChannels:r=2,sampleRate:i=48e3,bitrate:s=128e3,...a}=t;if(!Ne.includes(e))return!1;if(!Number.isInteger(r)||r<=0)throw new TypeError("numberOfChannels must be a positive integer.");if(!Number.isInteger(i)||i<=0)throw new TypeError("sampleRate must be a positive integer.");if(!(s instanceof Ve)&&(!Number.isInteger(s)||s<=0))throw new TypeError("bitrate must be a positive integer.");fo(e,a);let n=null;return Lr.length>0&&(n??(n=Vs({codec:e,numberOfChannels:r,sampleRate:i,bitrate:s,...a})),Lr.some(c=>c.supports(e,n)))||ve.includes(e)?!0:typeof AudioEncoder>"u"?!1:(n??(n=Vs({codec:e,numberOfChannels:r,sampleRate:i,bitrate:s,...a})),(await AudioEncoder.isConfigSupported(n)).supported===!0)},Ai=async e=>!!gt.includes(e),Rd=async()=>{let[e,t,r]=await Promise.all([mo(),Bi(),po()]);return[...e,...t,...r]},mo=async(e=De,t)=>{let r=await Promise.all(e.map(i=>Ii(i,t)));return e.filter((i,s)=>r[s])},Bi=async(e=Ne,t)=>{let r=await Promise.all(e.map(i=>Ei(i,t)));return e.filter((i,s)=>r[s])},po=async(e=gt)=>{let t=await Promise.all(e.map(Ai));return e.filter((r,i)=>t[i])},go=async(e,t)=>{for(let r of e)if(await Ii(r,t))return r;return null},Dd=async(e,t)=>{for(let r of e)if(await Ei(r,t))return r;return null},Od=async e=>{for(let t of e)if(await Ai(t))return t;return null},Fi=class{constructor(){this._connectedTrack=null,this._closingPromise=null,this._closed=!1,this._timestampOffset=0}_ensureValidAdd(){if(!this._connectedTrack)throw new Error("Source is not connected to an output track.");if(this._connectedTrack.output.state==="canceled")throw new Error("Output has been canceled.");if(this._connectedTrack.output.state==="finalizing"||this._connectedTrack.output.state==="finalized")throw new Error("Output has been finalized.");if(this._connectedTrack.output.state==="pending")throw new Error("Output has not started.");if(this._closed)throw new Error("Source is closed.")}async _start(){}async _flushAndClose(e){}close(){if(this._closingPromise)return;let e=this._connectedTrack;if(!e)throw new Error("Cannot call close without connecting the source to an output track.");if(e.output.state==="pending")throw new Error("Cannot call close before output has been started.");this._closingPromise=(async()=>{await this._flushAndClose(!1),this._closed=!0,!(e.output.state==="finalizing"||e.output.state==="finalized")&&e.output._muxer.onTrackClose(e)})()}async _flushOrWaitForOngoingClose(e){return this._closingPromise?this._closingPromise:this._flushAndClose(e)}},Ir=class extends Fi{constructor(e){if(super(),this._connectedTrack=null,!De.includes(e))throw new TypeError("Invalid video codec '".concat(e,"'. Must be one of: ").concat(De.join(", "),"."));this._codec=e}},wo=class extends Ir{constructor(e){super(e)}add(e,t){if(!(e instanceof we))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedVideoPacket(this._connectedTrack,e,t)}},Hs=class{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastMultipleOfKeyFrameInterval=-1,this.codedWidth=null,this.codedHeight=null,this.resizeCanvas=null,this.customEncoder=null,this.customEncoderCallSerializer=new oi,this.customEncoderQueueSize=0,this.alphaEncoder=null,this.splitter=null,this.splitterCreationFailed=!1,this.alphaFrameQueue=[],this.error=null,this.errorNeedsNewStack=!0}async add(e,t,r){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.codedWidth!==null&&this.codedHeight!==null){if(e.codedWidth!==this.codedWidth||e.codedHeight!==this.codedHeight){let n=this.encodingConfig.sizeChangeBehavior??"deny";if(n!=="passThrough"){if(n==="deny")throw new Error("Video sample size must remain constant. Expected ".concat(this.codedWidth,"x").concat(this.codedHeight,", got ").concat(e.codedWidth,"x").concat(e.codedHeight,". To allow the sample size to change over time, set `sizeChangeBehavior` to a value other than 'strict' in the encoding options."));{let o=!1;this.resizeCanvas||(typeof document<"u"?(this.resizeCanvas=document.createElement("canvas"),this.resizeCanvas.width=this.codedWidth,this.resizeCanvas.height=this.codedHeight):this.resizeCanvas=new OffscreenCanvas(this.codedWidth,this.codedHeight),o=!0);let c=this.resizeCanvas.getContext("2d",{alpha:Or()});d(c),o||(Or()?(c.fillStyle="black",c.fillRect(0,0,this.codedWidth,this.codedHeight)):c.clearRect(0,0,this.codedWidth,this.codedHeight)),e.drawWithFit(c,{fit:n}),t&&e.close(),e=new Qe(this.resizeCanvas,{timestamp:e.timestamp,duration:e.duration,rotation:e.rotation}),t=!0}}}}else this.codedWidth=e.codedWidth,this.codedHeight=e.codedHeight;this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),d(this.encoderInitialized);let i=this.encodingConfig.keyFrameInterval??5,s=Math.floor(e.timestamp/i),a={...r,keyFrame:r?.keyFrame||i===0||s!==this.lastMultipleOfKeyFrameInterval};if(this.lastMultipleOfKeyFrameInterval=s,this.customEncoder){this.customEncoderQueueSize++;let n=e.clone(),o=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(n,a)).then(()=>this.customEncoderQueueSize--).catch(c=>this.error??(this.error=c)).finally(()=>{n.close()});this.customEncoderQueueSize>=4&&await o}else{d(this.encoder);let n=e.toVideoFrame();if(!this.alphaEncoder)this.encoder.encode(n,a),n.close();else if(!!n.format&&!n.format.includes("A")||this.splitterCreationFailed)this.alphaFrameQueue.push(null),this.encoder.encode(n,a),n.close();else{let c=n.displayWidth,l=n.displayHeight;if(!this.splitter)try{this.splitter=new Nd(c,l)}catch(u){console.error("Due to an error, only color data will be encoded.",u),this.splitterCreationFailed=!0,this.alphaFrameQueue.push(null),this.encoder.encode(n,a),n.close()}if(this.splitter){let u=this.splitter.extractColor(n),h=this.splitter.extractAlpha(n);this.alphaFrameQueue.push(h),this.encoder.encode(u,a),u.close(),n.close()}}t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(o=>this.encoder.addEventListener("dequeue",o,{once:!0}))}await this.muxer.mutex.currentPromise}finally{t&&e.close()}}ensureEncoder(e){let t=new Error;this.ensureEncoderPromise=(async()=>{let r=Us({width:e.codedWidth,height:e.codedHeight,...this.encodingConfig,framerate:this.source._connectedTrack?.metadata.frameRate});this.encodingConfig.onEncoderConfig?.(r);let i=Ur.find(s=>s.supports(this.encodingConfig.codec,r));if(i)this.customEncoder=new i,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=r,this.customEncoder.onPacket=(s,a)=>{if(!(s instanceof we))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(a!==void 0&&(!a||typeof a!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(s,a),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,s,a).catch(n=>{this.error??(this.error=n),this.errorNeedsNewStack=!1})},await this.customEncoder.init();else{if(typeof VideoEncoder>"u")throw new Error("VideoEncoder is not supported by this browser.");if(r.alpha="discard",this.encodingConfig.alpha==="keep"&&(r.latencyMode="quality"),(r.width%2===1||r.height%2===1)&&(this.encodingConfig.codec==="avc"||this.encodingConfig.codec==="hevc"))throw new Error("The dimensions ".concat(r.width,"x").concat(r.height," are not supported for codec '").concat(this.encodingConfig.codec,"'; both width and height must be even numbers. Make sure to round your dimensions to the nearest even number."));if(!(await VideoEncoder.isConfigSupported(r)).supported)throw new Error("This specific encoder configuration (".concat(r.codec,", ").concat(r.bitrate," bps, ").concat(r.width,"x").concat(r.height,", hardware acceleration: ").concat(r.hardwareAcceleration??"no-preference",") is not supported by this browser. Consider using another codec or changing your video parameters."));let n=[],o=[],c=0,l=0,u=(h,f,w)=>{let b={};if(f){let y=new Uint8Array(f.byteLength);f.copyTo(y),b.alpha=y}let p=we.fromEncodedChunk(h,b);this.encodingConfig.onEncodedPacket?.(p,w),this.muxer.addEncodedVideoPacket(this.source._connectedTrack,p,w).catch(y=>{this.error??(this.error=y),this.errorNeedsNewStack=!1})};this.encoder=new VideoEncoder({output:(h,f)=>{if(!this.alphaEncoder){u(h,null,f);return}let w=this.alphaFrameQueue.shift();d(w!==void 0),w?(this.alphaEncoder.encode(w,{keyFrame:h.type==="key"}),l++,w.close(),n.push({chunk:h,meta:f})):l===0?u(h,null,f):(o.push(c+l),n.push({chunk:h,meta:f}))},error:h=>{h.stack=t.stack,this.error??(this.error=h)}}),this.encoder.configure(r),this.encodingConfig.alpha==="keep"&&(this.alphaEncoder=new VideoEncoder({output:(h,f)=>{l--;let w=n.shift();for(d(w!==void 0),u(w.chunk,h,w.meta),c++;o.length>0&&o[0]===c;){o.shift();let b=n.shift();d(b!==void 0),u(b.chunk,null,b.meta)}},error:h=>{h.stack=t.stack,this.error??(this.error=h)}}),this.alphaEncoder.configure(r))}d(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||(await this.encoder.flush(),await this.alphaEncoder?.flush()),this.encoder.state!=="closed"&&this.encoder.close(),this.alphaEncoder&&this.alphaEncoder.state!=="closed"&&this.alphaEncoder.close(),this.alphaFrameQueue.forEach(t=>t?.close()),this.splitter?.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},Nd=class{constructor(e,t){this.lastFrame=null,typeof OffscreenCanvas<"u"?this.canvas=new OffscreenCanvas(e,t):(this.canvas=document.createElement("canvas"),this.canvas.width=e,this.canvas.height=t);let r=this.canvas.getContext("webgl2",{alpha:!0});if(!r)throw new Error("Couldn't acquire WebGL 2 context.");this.gl=r,this.colorProgram=this.createColorProgram(),this.alphaProgram=this.createAlphaProgram(),this.vao=this.createVAO(),this.sourceTexture=this.createTexture(),this.alphaResolutionLocation=this.gl.getUniformLocation(this.alphaProgram,"u_resolution"),this.gl.useProgram(this.colorProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.colorProgram,"u_sourceTexture"),0),this.gl.useProgram(this.alphaProgram),this.gl.uniform1i(this.gl.getUniformLocation(this.alphaProgram,"u_sourceTexture"),0)}createVertexShader(){return this.createShader(this.gl.VERTEX_SHADER,"#version 300 es\n			in vec2 a_position;\n			in vec2 a_texCoord;\n			out vec2 v_texCoord;\n			\n			void main() {\n				gl_Position = vec4(a_position, 0.0, 1.0);\n				v_texCoord = a_texCoord;\n			}\n		")}createColorProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_sourceTexture;\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n			\n			void main() {\n				vec4 source = texture(u_sourceTexture, v_texCoord);\n				fragColor = vec4(source.rgb, 1.0);\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createAlphaProgram(){let e=this.createVertexShader(),t=this.createShader(this.gl.FRAGMENT_SHADER,"#version 300 es\n			precision highp float;\n			\n			uniform sampler2D u_sourceTexture;\n			uniform vec2 u_resolution; // The width and height of the canvas\n			in vec2 v_texCoord;\n			out vec4 fragColor;\n\n			// This function determines the value for a single byte in the YUV stream\n			float getByteValue(float byteOffset) {\n				float width = u_resolution.x;\n				float height = u_resolution.y;\n\n				float yPlaneSize = width * height;\n\n				if (byteOffset < yPlaneSize) {\n					// This byte is in the luma plane. Find the corresponding pixel coordinates to sample from\n					float y = floor(byteOffset / width);\n					float x = mod(byteOffset, width);\n					\n					// Add 0.5 to sample the center of the texel\n					vec2 sampleCoord = (vec2(x, y) + 0.5) / u_resolution;\n					\n					// The luma value is the alpha from the source texture\n					return texture(u_sourceTexture, sampleCoord).a;\n				} else {\n					// Write a fixed value for chroma and beyond\n					return 128.0 / 255.0;\n				}\n			}\n			\n			void main() {\n				// Each fragment writes 4 bytes (R, G, B, A)\n				float pixelIndex = floor(gl_FragCoord.y) * u_resolution.x + floor(gl_FragCoord.x);\n				float baseByteOffset = pixelIndex * 4.0;\n\n				vec4 result;\n				for (int i = 0; i < 4; i++) {\n					float currentByteOffset = baseByteOffset + float(i);\n					result[i] = getByteValue(currentByteOffset);\n				}\n				\n				fragColor = result;\n			}\n		"),r=this.gl.createProgram();return this.gl.attachShader(r,e),this.gl.attachShader(r,t),this.gl.linkProgram(r),r}createShader(e,t){let r=this.gl.createShader(e);return this.gl.shaderSource(r,t),this.gl.compileShader(r),this.gl.getShaderParameter(r,this.gl.COMPILE_STATUS)||console.error("Shader compile error:",this.gl.getShaderInfoLog(r)),r}createVAO(){let e=this.gl.createVertexArray();this.gl.bindVertexArray(e);let t=new Float32Array([-1,-1,0,1,1,-1,1,1,-1,1,0,0,1,1,1,0]),r=this.gl.createBuffer();this.gl.bindBuffer(this.gl.ARRAY_BUFFER,r),this.gl.bufferData(this.gl.ARRAY_BUFFER,t,this.gl.STATIC_DRAW);let i=this.gl.getAttribLocation(this.colorProgram,"a_position"),s=this.gl.getAttribLocation(this.colorProgram,"a_texCoord");return this.gl.enableVertexAttribArray(i),this.gl.vertexAttribPointer(i,2,this.gl.FLOAT,!1,16,0),this.gl.enableVertexAttribArray(s),this.gl.vertexAttribPointer(s,2,this.gl.FLOAT,!1,16,8),e}createTexture(){let e=this.gl.createTexture();return this.gl.bindTexture(this.gl.TEXTURE_2D,e),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_S,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_WRAP_T,this.gl.CLAMP_TO_EDGE),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MIN_FILTER,this.gl.LINEAR),this.gl.texParameteri(this.gl.TEXTURE_2D,this.gl.TEXTURE_MAG_FILTER,this.gl.LINEAR),e}updateTexture(e){this.lastFrame!==e&&((e.displayWidth!==this.canvas.width||e.displayHeight!==this.canvas.height)&&(this.canvas.width=e.displayWidth,this.canvas.height=e.displayHeight),this.gl.activeTexture(this.gl.TEXTURE0),this.gl.bindTexture(this.gl.TEXTURE_2D,this.sourceTexture),this.gl.texImage2D(this.gl.TEXTURE_2D,0,this.gl.RGBA,this.gl.RGBA,this.gl.UNSIGNED_BYTE,e),this.lastFrame=e)}extractColor(e){return this.updateTexture(e),this.gl.useProgram(this.colorProgram),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4),new VideoFrame(this.canvas,{timestamp:e.timestamp,duration:e.duration??void 0,alpha:"discard"})}extractAlpha(e){this.updateTexture(e),this.gl.useProgram(this.alphaProgram),this.gl.uniform2f(this.alphaResolutionLocation,this.canvas.width,this.canvas.height),this.gl.viewport(0,0,this.canvas.width,this.canvas.height),this.gl.clear(this.gl.COLOR_BUFFER_BIT),this.gl.bindVertexArray(this.vao),this.gl.drawArrays(this.gl.TRIANGLE_STRIP,0,4);let{width:t,height:r}=this.canvas,i=Math.ceil(t/2)*Math.ceil(r/2),s=t*r+i*2,a=Math.ceil(s/(t*4)),n=new Uint8Array(4*t*a);this.gl.readPixels(0,0,t,a,this.gl.RGBA,this.gl.UNSIGNED_BYTE,n),n=n.subarray(0,s),d(n[t*r]===128),d(n[n.length-1]===128);let o={format:"I420",codedWidth:t,codedHeight:r,timestamp:e.timestamp,duration:e.duration??void 0,transfer:[n.buffer]};return new VideoFrame(n,o)}close(){this.gl.getExtension("WEBGL_lose_context")?.loseContext(),this.gl=null}},qs=class extends Ir{constructor(e){Ns(e),super(e.codec),this._encoder=new Hs(this,e)}add(e,t){if(!(e instanceof Qe))throw new TypeError("videoSample must be a VideoSample.");return this._encoder.add(e,!1,t)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Ud=class extends Ir{constructor(e,t){if(!(typeof HTMLCanvasElement<"u"&&e instanceof HTMLCanvasElement)&&!(typeof OffscreenCanvas<"u"&&e instanceof OffscreenCanvas))throw new TypeError("canvas must be an HTMLCanvasElement or OffscreenCanvas.");Ns(t),super(t.codec),this._encoder=new Hs(this,t),this._canvas=e}add(e,t=0,r){if(!Number.isFinite(e)||e<0)throw new TypeError("timestamp must be a non-negative number.");if(!Number.isFinite(t)||t<0)throw new TypeError("duration must be a non-negative number.");let i=new Qe(this._canvas,{timestamp:e,duration:t});return this._encoder.add(i,!0,r)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Ld=class extends Ir{constructor(e,t){if(!(e instanceof MediaStreamTrack)||e.kind!=="video")throw new TypeError("track must be a video MediaStreamTrack.");Ns(t),t={...t,latencyMode:"realtime"},super(t.codec),this._abortController=null,this._workerTrackId=null,this._workerListener=null,this._promiseWithResolvers=ke(),this._errorPromiseAccessed=!1,this._encoder=new Hs(this,t),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController;let e=null,t=!1,r=i=>{if(t){i.close();return}if(e===null){e=i.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new Qe(i),!0).catch(s=>{t=!0,this._abortController?.abort(),this._promiseWithResolvers.reject(s),this._workerTrackId!==null&&Ks({type:"stopTrack",trackId:this._workerTrackId})})};if(typeof MediaStreamTrackProcessor<"u"){let i=new MediaStreamTrackProcessor({track:this._track}),s=new WritableStream({write:r});i.readable.pipeTo(s,{signal:this._abortController.signal}).catch(a=>{a instanceof DOMException&&a.name==="AbortError"||this._promiseWithResolvers.reject(a)})}else if(await jd())this._workerTrackId=qd++,Ks({type:"videoTrack",trackId:this._workerTrackId,track:this._track},[this._track]),this._workerListener=s=>{let a=s.data;a.type==="videoFrame"&&a.trackId===this._workerTrackId?r(a.videoFrame):a.type==="error"&&a.trackId===this._workerTrackId&&this._promiseWithResolvers.reject(a.error)},rt.addEventListener("message",this._workerListener);else throw new Error("MediaStreamTrackProcessor is required but not supported by this browser.")}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._workerTrackId!==null&&(d(this._workerListener),Ks({type:"stopTrack",trackId:this._workerTrackId}),await new Promise(t=>{let r=i=>{let s=i.data;s.type==="trackStopped"&&s.trackId===this._workerTrackId&&(d(this._workerListener),rt.removeEventListener("message",this._workerListener),rt.removeEventListener("message",r),t())};rt.addEventListener("message",r)})),await this._encoder.flushAndClose(e)}},Er=class extends Fi{constructor(e){if(super(),this._connectedTrack=null,!Ne.includes(e))throw new TypeError("Invalid audio codec '".concat(e,"'. Must be one of: ").concat(Ne.join(", "),"."));this._codec=e}},bo=class extends Er{constructor(e){super(e)}add(e,t){if(!(e instanceof we))throw new TypeError("packet must be an EncodedPacket.");if(e.isMetadataOnly)throw new TypeError("Metadata-only packets cannot be added.");if(t!==void 0&&(!t||typeof t!="object"))throw new TypeError("meta, when provided, must be an object.");return this._ensureValidAdd(),this._connectedTrack.output._muxer.addEncodedAudioPacket(this._connectedTrack,e,t)}},$s=class{constructor(e,t){this.source=e,this.encodingConfig=t,this.ensureEncoderPromise=null,this.encoderInitialized=!1,this.encoder=null,this.muxer=null,this.lastNumberOfChannels=null,this.lastSampleRate=null,this.isPcmEncoder=!1,this.outputSampleSize=null,this.writeOutputValue=null,this.customEncoder=null,this.customEncoderCallSerializer=new oi,this.customEncoderQueueSize=0,this.error=null,this.errorNeedsNewStack=!0}async add(e,t){try{if(this.checkForEncoderError(),this.source._ensureValidAdd(),this.lastNumberOfChannels!==null&&this.lastSampleRate!==null){if(e.numberOfChannels!==this.lastNumberOfChannels||e.sampleRate!==this.lastSampleRate)throw new Error("Audio parameters must remain constant. Expected ".concat(this.lastNumberOfChannels," channels at ").concat(this.lastSampleRate," Hz, got ").concat(e.numberOfChannels," channels at ").concat(e.sampleRate," Hz."))}else this.lastNumberOfChannels=e.numberOfChannels,this.lastSampleRate=e.sampleRate;if(this.encoderInitialized||(this.ensureEncoderPromise||this.ensureEncoder(e),this.encoderInitialized||await this.ensureEncoderPromise),d(this.encoderInitialized),this.customEncoder){this.customEncoderQueueSize++;let r=e.clone(),i=this.customEncoderCallSerializer.call(()=>this.customEncoder.encode(r)).then(()=>this.customEncoderQueueSize--).catch(s=>this.error??(this.error=s)).finally(()=>{r.close()});this.customEncoderQueueSize>=4&&await i,await this.muxer.mutex.currentPromise}else if(this.isPcmEncoder)await this.doPcmEncoding(e,t);else{d(this.encoder);let r=e.toAudioData();this.encoder.encode(r),r.close(),t&&e.close(),this.encoder.encodeQueueSize>=4&&await new Promise(i=>this.encoder.addEventListener("dequeue",i,{once:!0})),await this.muxer.mutex.currentPromise}}finally{t&&e.close()}}async doPcmEncoding(e,t){d(this.outputSampleSize),d(this.writeOutputValue);let{numberOfChannels:r,numberOfFrames:i,sampleRate:s,timestamp:a}=e,n=2048,o=[];for(let h=0;h<i;h+=n){let f=Math.min(n,e.numberOfFrames-h),w=f*r*this.outputSampleSize,b=new ArrayBuffer(w),p=new DataView(b);o.push({frameCount:f,view:p})}let c=e.allocationSize({planeIndex:0,format:"f32-planar"}),l=new Float32Array(c/Float32Array.BYTES_PER_ELEMENT);for(let h=0;h<r;h++){e.copyTo(l,{planeIndex:h,format:"f32-planar"});for(let f=0;f<o.length;f++){let{frameCount:w,view:b}=o[f];for(let p=0;p<w;p++)this.writeOutputValue(b,(p*r+h)*this.outputSampleSize,l[f*n+p])}}t&&e.close();let u={decoderConfig:{codec:this.encodingConfig.codec,numberOfChannels:r,sampleRate:s}};for(let h=0;h<o.length;h++){let{frameCount:f,view:w}=o[h],b=w.buffer,p=h*n,y=new we(new Uint8Array(b),"key",a+p/s,f/s);this.encodingConfig.onEncodedPacket?.(y,u),await this.muxer.addEncodedAudioPacket(this.source._connectedTrack,y,u)}}ensureEncoder(e){let t=new Error;this.ensureEncoderPromise=(async()=>{let{numberOfChannels:r,sampleRate:i}=e,s=Vs({numberOfChannels:r,sampleRate:i,...this.encodingConfig});this.encodingConfig.onEncoderConfig?.(s);let a=Lr.find(n=>n.supports(this.encodingConfig.codec,s));if(a)this.customEncoder=new a,this.customEncoder.codec=this.encodingConfig.codec,this.customEncoder.config=s,this.customEncoder.onPacket=(n,o)=>{if(!(n instanceof we))throw new TypeError("The first argument passed to onPacket must be an EncodedPacket.");if(o!==void 0&&(!o||typeof o!="object"))throw new TypeError("The second argument passed to onPacket must be an object or undefined.");this.encodingConfig.onEncodedPacket?.(n,o),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,n,o).catch(c=>{this.error??(this.error=c),this.errorNeedsNewStack=!1})},await this.customEncoder.init();else if(ve.includes(this.encodingConfig.codec))this.initPcmEncoder();else{if(typeof AudioEncoder>"u")throw new Error("AudioEncoder is not supported by this browser.");if(!(await AudioEncoder.isConfigSupported(s)).supported)throw new Error("This specific encoder configuration (".concat(s.codec,", ").concat(s.bitrate," bps, ").concat(s.numberOfChannels," channels, ").concat(s.sampleRate," Hz) is not supported by this browser. Consider using another codec or changing your audio parameters."));this.encoder=new AudioEncoder({output:(o,c)=>{let l=we.fromEncodedChunk(o);this.encodingConfig.onEncodedPacket?.(l,c),this.muxer.addEncodedAudioPacket(this.source._connectedTrack,l,c).catch(u=>{this.error??(this.error=u),this.errorNeedsNewStack=!1})},error:o=>{o.stack=t.stack,this.error??(this.error=o)}}),this.encoder.configure(s)}d(this.source._connectedTrack),this.muxer=this.source._connectedTrack.output._muxer,this.encoderInitialized=!0})()}initPcmEncoder(){this.isPcmEncoder=!0;let e=this.encodingConfig.codec,{dataType:t,sampleSize:r,littleEndian:i}=wt(e);switch(this.outputSampleSize=r,r){case 1:t==="unsigned"?this.writeOutputValue=(s,a,n)=>s.setUint8(a,Ie((n+1)*127.5,0,255)):t==="signed"?this.writeOutputValue=(s,a,n)=>{s.setInt8(a,Ie(Math.round(n*128),-128,127))}:t==="ulaw"?this.writeOutputValue=(s,a,n)=>{let o=Ie(Math.floor(n*32767),-32768,32767);s.setUint8(a,Wc(o))}:t==="alaw"?this.writeOutputValue=(s,a,n)=>{let o=Ie(Math.floor(n*32767),-32768,32767);s.setUint8(a,qc(o))}:d(!1);break;case 2:t==="unsigned"?this.writeOutputValue=(s,a,n)=>s.setUint16(a,Ie((n+1)*32767.5,0,65535),i):t==="signed"?this.writeOutputValue=(s,a,n)=>s.setInt16(a,Ie(Math.round(n*32767),-32768,32767),i):d(!1);break;case 3:t==="unsigned"?this.writeOutputValue=(s,a,n)=>ca(s,a,Ie((n+1)*83886075e-1,0,16777215),i):t==="signed"?this.writeOutputValue=(s,a,n)=>oc(s,a,Ie(Math.round(n*8388607),-8388608,8388607),i):d(!1);break;case 4:t==="unsigned"?this.writeOutputValue=(s,a,n)=>s.setUint32(a,Ie((n+1)*21474836475e-1,0,4294967295),i):t==="signed"?this.writeOutputValue=(s,a,n)=>s.setInt32(a,Ie(Math.round(n*2147483647),-2147483648,2147483647),i):t==="float"?this.writeOutputValue=(s,a,n)=>s.setFloat32(a,n,i):d(!1);break;case 8:t==="float"?this.writeOutputValue=(s,a,n)=>s.setFloat64(a,n,i):d(!1);break;default:Re(r),d(!1)}}async flushAndClose(e){e||this.checkForEncoderError(),this.customEncoder?(e||this.customEncoderCallSerializer.call(()=>this.customEncoder.flush()),await this.customEncoderCallSerializer.call(()=>this.customEncoder.close())):this.encoder&&(e||await this.encoder.flush(),this.encoder.state!=="closed"&&this.encoder.close()),e||this.checkForEncoderError()}getQueueSize(){return this.customEncoder?this.customEncoderQueueSize:this.isPcmEncoder?0:this.encoder?.encodeQueueSize??0}checkForEncoderError(){if(this.error)throw this.errorNeedsNewStack&&(this.error.stack=new Error().stack),this.error}},js=class extends Er{constructor(e){Ls(e),super(e.codec),this._encoder=new $s(this,e)}add(e){if(!(e instanceof bt))throw new TypeError("audioSample must be an AudioSample.");return this._encoder.add(e,!1)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Vd=class extends Er{constructor(e){Ls(e),super(e.codec),this._accumulatedTime=0,this._encoder=new $s(this,e)}async add(e){if(!(e instanceof AudioBuffer))throw new TypeError("audioBuffer must be an AudioBuffer.");let t=bt._fromAudioBuffer(e,this._accumulatedTime);this._accumulatedTime+=e.duration;for(let r of t)await this._encoder.add(r,!0)}_flushAndClose(e){return this._encoder.flushAndClose(e)}},Wd=class extends Er{constructor(e,t){if(!(e instanceof MediaStreamTrack)||e.kind!=="audio")throw new TypeError("track must be an audio MediaStreamTrack.");Ls(t),super(t.codec),this._abortController=null,this._audioContext=null,this._scriptProcessorNode=null,this._promiseWithResolvers=ke(),this._errorPromiseAccessed=!1,this._encoder=new $s(this,t),this._track=e}get errorPromise(){return this._errorPromiseAccessed=!0,this._promiseWithResolvers.promise}async _start(){if(this._errorPromiseAccessed||console.warn("Make sure not to ignore the `errorPromise` field on MediaStreamVideoTrackSource, so that any internal errors get bubbled up properly."),this._abortController=new AbortController,typeof MediaStreamTrackProcessor<"u"){let e=null,t=new MediaStreamTrackProcessor({track:this._track}),r=new WritableStream({write:i=>{if(e===null){e=i.timestamp/1e6;let s=this._connectedTrack.output._muxer;s.firstMediaStreamTimestamp===null?(s.firstMediaStreamTimestamp=performance.now()/1e3,this._timestampOffset=-e):this._timestampOffset=performance.now()/1e3-s.firstMediaStreamTimestamp-e}if(this._encoder.getQueueSize()>=4){i.close();return}this._encoder.add(new bt(i),!0).catch(s=>{this._abortController?.abort(),this._promiseWithResolvers.reject(s)})}});t.readable.pipeTo(r,{signal:this._abortController.signal}).catch(i=>{i instanceof DOMException&&i.name==="AbortError"||this._promiseWithResolvers.reject(i)})}else{let e=window.AudioContext||window.webkitAudioContext;this._audioContext=new e({sampleRate:this._track.getSettings().sampleRate});let t=this._audioContext.createMediaStreamSource(new MediaStream([this._track]));this._scriptProcessorNode=this._audioContext.createScriptProcessor(4096),this._audioContext.state==="suspended"&&await this._audioContext.resume(),t.connect(this._scriptProcessorNode),this._scriptProcessorNode.connect(this._audioContext.destination);let r=!1,i=0;this._scriptProcessorNode.onaudioprocess=s=>{let a=bt._fromAudioBuffer(s.inputBuffer,i);i+=s.inputBuffer.duration;for(let n of a){if(!r){r=!0;let o=this._connectedTrack.output._muxer;o.firstMediaStreamTimestamp===null?o.firstMediaStreamTimestamp=performance.now()/1e3:this._timestampOffset=performance.now()/1e3-o.firstMediaStreamTimestamp}if(this._encoder.getQueueSize()>=4){n.close();continue}this._encoder.add(n,!0).catch(o=>{this._audioContext.suspend(),this._promiseWithResolvers.reject(o)})}}}}async _flushAndClose(e){this._abortController&&(this._abortController.abort(),this._abortController=null),this._audioContext&&(d(this._scriptProcessorNode),this._scriptProcessorNode.disconnect(),await this._audioContext.suspend()),await this._encoder.flushAndClose(e)}},Hd=()=>{let e=(i,s)=>{s?self.postMessage(i,{transfer:s}):self.postMessage(i)};e({type:"support",supported:typeof MediaStreamTrackProcessor<"u"});let t=new Map,r=new Set;self.addEventListener("message",i=>{let s=i.data;switch(s.type){case"videoTrack":{let a=new MediaStreamTrackProcessor({track:s.track}),n=new WritableStream({write:c=>{if(r.has(s.trackId)){c.close();return}e({type:"videoFrame",trackId:s.trackId,videoFrame:c},[c])}}),o=new AbortController;t.set(s.trackId,o),a.readable.pipeTo(n,{signal:o.signal}).catch(c=>{c instanceof DOMException&&c.name==="AbortError"||e({type:"error",trackId:s.trackId,error:c})})}break;case"stopTrack":{let a=t.get(s.trackId);a&&(a.abort(),t.delete(s.trackId)),r.add(s.trackId),e({type:"trackStopped",trackId:s.trackId})}break;default:Re(s)}})},qd=0,rt=null,$d=()=>{let e=new Blob(["(".concat(Hd.toString(),")()")],{type:"application/javascript"}),t=URL.createObjectURL(e);rt=new Worker(t)},Qs=null,jd=async()=>Qs!==null?Qs:(rt||$d(),new Promise(e=>{d(rt);let t=r=>{let i=r.data;i.type==="support"&&(Qs=i.supported,rt.removeEventListener("message",t),e(i.supported))};rt.addEventListener("message",t)})),Ks=(e,t)=>{d(rt),t?rt.postMessage(e,t):rt.postMessage(e)},Gs=class extends Fi{constructor(e){if(super(),this._connectedTrack=null,!gt.includes(e))throw new TypeError("Invalid subtitle codec '".concat(e,"'. Must be one of: ").concat(gt.join(", "),"."));this._codec=e}},Qd=class extends Gs{constructor(e){super(e),this._error=null,this._parser=new Zl({codec:e,output:(t,r)=>{this._connectedTrack?.output._muxer.addSubtitleCue(this._connectedTrack,t,r).catch(i=>{this._error??(this._error=i)})}})}add(e){if(typeof e!="string")throw new TypeError("text must be a string.");return this._checkForError(),this._ensureValidAdd(),this._parser.parse(e),this._connectedTrack.output._muxer.mutex.currentPromise}_checkForError(){if(this._error)throw this._error}async _flushAndClose(e){e||this._checkForError()}},ko=["video","audio","subtitle"],Xs=e=>{if(!e||typeof e!="object")throw new TypeError("metadata must be an object.");if(e.languageCode!==void 0&&!Dr(e.languageCode))throw new TypeError("metadata.languageCode, when provided, must be a three-letter, ISO 639-2/T language code.");if(e.name!==void 0&&typeof e.name!="string")throw new TypeError("metadata.name, when provided, must be a string.");if(e.maximumPacketCount!==void 0&&(!Number.isInteger(e.maximumPacketCount)||e.maximumPacketCount<0))throw new TypeError("metadata.maximumPacketCount, when provided, must be a non-negative integer.")},Ys=class{constructor(e){if(this.state="pending",this._tracks=[],this._startPromise=null,this._cancelPromise=null,this._finalizePromise=null,this._mutex=new xt,this._metadataTags={},!e||typeof e!="object")throw new TypeError("options must be an object.");if(!(e.format instanceof Mt))throw new TypeError("options.format must be an OutputFormat.");if(!(e.target instanceof Pr))throw new TypeError("options.target must be a Target.");if(e.target._output)throw new Error("Target is already used for another output.");e.target._output=this,this.format=e.format,this.target=e.target,this._writer=e.target._createWriter(),this._muxer=e.format._createMuxer(this)}addVideoTrack(e,t={}){if(!(e instanceof Ir))throw new TypeError("source must be a VideoSource.");if(Xs(t),t.rotation!==void 0&&![0,90,180,270].includes(t.rotation))throw new TypeError("Invalid video rotation: ".concat(t.rotation,". Has to be 0, 90, 180 or 270."));if(!this.format.supportsVideoRotationMetadata&&t.rotation)throw new Error("".concat(this.format._name," does not support video rotation metadata."));if(t.frameRate!==void 0&&(!Number.isFinite(t.frameRate)||t.frameRate<=0))throw new TypeError("Invalid video frame rate: ".concat(t.frameRate,". Must be a positive number."));this._addTrack("video",e,t)}addAudioTrack(e,t={}){if(!(e instanceof Er))throw new TypeError("source must be an AudioSource.");Xs(t),this._addTrack("audio",e,t)}addSubtitleTrack(e,t={}){if(!(e instanceof Gs))throw new TypeError("source must be a SubtitleSource.");Xs(t),this._addTrack("subtitle",e,t)}setMetadataTags(e){if(Wi(e),this.state!=="pending")throw new Error("Cannot set metadata tags after output has been started or canceled.");this._metadataTags=e}_addTrack(e,t,r){if(this.state!=="pending")throw new Error("Cannot add track after output has been started or canceled.");if(t._connectedTrack)throw new Error("Source is already used for a track.");let i=this.format.getSupportedTrackCounts(),s=this._tracks.reduce((c,l)=>c+(l.type===e?1:0),0),a=i[e].max;if(s===a)throw new Error(a===0?"".concat(this.format._name," does not support ").concat(e," tracks."):"".concat(this.format._name," does not support more than ").concat(a," ").concat(e," track").concat(a===1?"":"s","."));let n=i.total.max;if(this._tracks.length===n)throw new Error("".concat(this.format._name," does not support more than ").concat(n," tracks").concat(n===1?"":"s"," in total."));let o={id:this._tracks.length+1,output:this,type:e,source:t,metadata:r};if(o.type==="video"){let c=this.format.getSupportedVideoCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support video tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported video codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}else if(o.type==="audio"){let c=this.format.getSupportedAudioCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support audio tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported audio codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}else if(o.type==="subtitle"){let c=this.format.getSupportedSubtitleCodecs();if(c.length===0)throw new Error("".concat(this.format._name," does not support subtitle tracks.")+this.format._codecUnsupportedHint(o.source._codec));if(!c.includes(o.source._codec))throw new Error("Codec '".concat(o.source._codec,"' cannot be contained within ").concat(this.format._name,". Supported subtitle codecs are: ").concat(c.map(l=>"'".concat(l,"'")).join(", "),".")+this.format._codecUnsupportedHint(o.source._codec))}this._tracks.push(o),t._connectedTrack=o}async start(){let e=this.format.getSupportedTrackCounts();for(let r of ko){let i=this._tracks.reduce((a,n)=>a+(n.type===r?1:0),0),s=e[r].min;if(i<s)throw new Error(s===e[r].max?"".concat(this.format._name," requires exactly ").concat(s," ").concat(r," track").concat(s===1?"":"s","."):"".concat(this.format._name," requires at least ").concat(s," ").concat(r," track").concat(s===1?"":"s","."))}let t=e.total.min;if(this._tracks.length<t)throw new Error(t===e.total.max?"".concat(this.format._name," requires exactly ").concat(t," track").concat(t===1?"":"s","."):"".concat(this.format._name," requires at least ").concat(t," track").concat(t===1?"":"s","."));if(this.state==="canceled")throw new Error("Output has been canceled.");return this._startPromise?(console.warn("Output has already been started."),this._startPromise):this._startPromise=(async()=>{this.state="started",this._writer.start();let r=await this._mutex.acquire();await this._muxer.start();let i=this._tracks.map(s=>s.source._start());await Promise.all(i),r()})()}getMimeType(){return this._muxer.getMimeType()}async cancel(){if(this._cancelPromise)return console.warn("Output has already been canceled."),this._cancelPromise;if(this.state==="finalizing"||this.state==="finalized"){console.warn("Output has already been finalized.");return}return this._cancelPromise=(async()=>{this.state="canceled";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!0));await Promise.all(t),await this._writer.close(),e()})()}async finalize(){if(this.state==="pending")throw new Error("Cannot finalize before starting.");if(this.state==="canceled")throw new Error("Cannot finalize after canceling.");return this._finalizePromise?(console.warn("Output has already been finalized."),this._finalizePromise):this._finalizePromise=(async()=>{this.state="finalizing";let e=await this._mutex.acquire(),t=this._tracks.map(r=>r.source._flushOrWaitForOngoingClose(!1));await Promise.all(t),await this._muxer.finalize(),await this._writer.flush(),await this._writer.finalize(),this.state="finalized",e()})()}},yo=e=>{if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("options.video, when provided, must be an object.");if(e?.discard!==void 0&&typeof e.discard!="boolean")throw new TypeError("options.video.discard, when provided, must be a boolean.");if(e?.forceTranscode!==void 0&&typeof e.forceTranscode!="boolean")throw new TypeError("options.video.forceTranscode, when provided, must be a boolean.");if(e?.codec!==void 0&&!De.includes(e.codec))throw new TypeError("options.video.codec, when provided, must be one of: ".concat(De.join(", "),"."));if(e?.bitrate!==void 0&&!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("options.video.bitrate, when provided, must be a positive integer or a quality.");if(e?.width!==void 0&&(!Number.isInteger(e.width)||e.width<=0))throw new TypeError("options.video.width, when provided, must be a positive integer.");if(e?.height!==void 0&&(!Number.isInteger(e.height)||e.height<=0))throw new TypeError("options.video.height, when provided, must be a positive integer.");if(e?.fit!==void 0&&!["fill","contain","cover"].includes(e.fit))throw new TypeError("options.video.fit, when provided, must be one of 'fill', 'contain', or 'cover'.");if(e?.width!==void 0&&e.height!==void 0&&e.fit===void 0)throw new TypeError("When both options.video.width and options.video.height are provided, options.video.fit must also be provided.");if(e?.rotate!==void 0&&![0,90,180,270].includes(e.rotate))throw new TypeError("options.video.rotate, when provided, must be 0, 90, 180 or 270.");if(e?.crop!==void 0&&Ki(e.crop,"options.video."),e?.frameRate!==void 0&&(!Number.isFinite(e.frameRate)||e.frameRate<=0))throw new TypeError("options.video.frameRate, when provided, must be a finite positive number.");if(e?.alpha!==void 0&&!["discard","keep"].includes(e.alpha))throw new TypeError("options.video.alpha, when provided, must be either 'discard' or 'keep'.");if(e?.keyFrameInterval!==void 0&&(!Number.isFinite(e.keyFrameInterval)||e.keyFrameInterval<0))throw new TypeError("options.video.keyFrameInterval, when provided, must be a non-negative number.");if(e?.process!==void 0&&typeof e.process!="function")throw new TypeError("options.video.process, when provided, must be a function.");if(e?.processedWidth!==void 0&&(!Number.isInteger(e.processedWidth)||e.processedWidth<=0))throw new TypeError("options.video.processedWidth, when provided, must be a positive integer.");if(e?.processedHeight!==void 0&&(!Number.isInteger(e.processedHeight)||e.processedHeight<=0))throw new TypeError("options.video.processedHeight, when provided, must be a positive integer.")},To=e=>{if(e!==void 0&&(!e||typeof e!="object"))throw new TypeError("options.audio, when provided, must be an object.");if(e?.discard!==void 0&&typeof e.discard!="boolean")throw new TypeError("options.audio.discard, when provided, must be a boolean.");if(e?.forceTranscode!==void 0&&typeof e.forceTranscode!="boolean")throw new TypeError("options.audio.forceTranscode, when provided, must be a boolean.");if(e?.codec!==void 0&&!Ne.includes(e.codec))throw new TypeError("options.audio.codec, when provided, must be one of: ".concat(Ne.join(", "),"."));if(e?.bitrate!==void 0&&!(e.bitrate instanceof Ve)&&(!Number.isInteger(e.bitrate)||e.bitrate<=0))throw new TypeError("options.audio.bitrate, when provided, must be a positive integer or a quality.");if(e?.numberOfChannels!==void 0&&(!Number.isInteger(e.numberOfChannels)||e.numberOfChannels<=0))throw new TypeError("options.audio.numberOfChannels, when provided, must be a positive integer.");if(e?.sampleRate!==void 0&&(!Number.isInteger(e.sampleRate)||e.sampleRate<=0))throw new TypeError("options.audio.sampleRate, when provided, must be a positive integer.");if(e?.process!==void 0&&typeof e.process!="function")throw new TypeError("options.audio.process, when provided, must be a function.");if(e?.processedNumberOfChannels!==void 0&&(!Number.isInteger(e.processedNumberOfChannels)||e.processedNumberOfChannels<=0))throw new TypeError("options.audio.processedNumberOfChannels, when provided, must be a positive integer.");if(e?.processedSampleRate!==void 0&&(!Number.isInteger(e.processedSampleRate)||e.processedSampleRate<=0))throw new TypeError("options.audio.processedSampleRate, when provided, must be a positive integer.")},Zs=2,Js=48e3,Kd=class Yo{constructor(t){if(this._addedCounts={video:0,audio:0,subtitle:0},this._totalTrackCount=0,this._trackPromises=[],this._executed=!1,this._synchronizer=new Gd,this._totalDuration=null,this._maxTimestamps=new Map,this._canceled=!1,this.onProgress=void 0,this._computeProgress=!1,this._lastProgress=0,this.isValid=!1,this.utilizedTracks=[],this.discardedTracks=[],!t||typeof t!="object")throw new TypeError("options must be an object.");if(!(t.input instanceof Nn))throw new TypeError("options.input must be an Input.");if(!(t.output instanceof Ys))throw new TypeError("options.output must be an Output.");if(t.output._tracks.length>0||Object.keys(t.output._metadataTags).length>0||t.output.state!=="pending")throw new TypeError("options.output must be fresh: no tracks or metadata tags added and not started.");if(typeof t.video!="function"&&yo(t.video),typeof t.audio!="function"&&To(t.audio),t.trim!==void 0&&(!t.trim||typeof t.trim!="object"))throw new TypeError("options.trim, when provided, must be an object.");if(t.trim?.start!==void 0&&(!Number.isFinite(t.trim.start)||t.trim.start<0))throw new TypeError("options.trim.start, when provided, must be a non-negative number.");if(t.trim?.end!==void 0&&(!Number.isFinite(t.trim.end)||t.trim.end<0))throw new TypeError("options.trim.end, when provided, must be a non-negative number.");if(t.trim?.start!==void 0&&t.trim.end!==void 0&&t.trim.start>=t.trim.end)throw new TypeError("options.trim.start must be less than options.trim.end.");if(t.tags!==void 0&&(typeof t.tags!="object"||!t.tags)&&typeof t.tags!="function")throw new TypeError("options.tags, when provided, must be an object or a function.");if(typeof t.tags=="object"&&Wi(t.tags),t.showWarnings!==void 0&&typeof t.showWarnings!="boolean")throw new TypeError("options.showWarnings, when provided, must be a boolean.");this._options=t,this.input=t.input,this.output=t.output,this._startTimestamp=t.trim?.start??0,this._endTimestamp=t.trim?.end??1/0;let{promise:r,resolve:i}=ke();this._started=r,this._start=i}static async init(t){let r=new Yo(t);return await r._init(),r}async _init(){let t=await this.input.getTracks(),r=this.output.format.getSupportedTrackCounts(),i=1,s=1;for(let l of t){let u;if(l.isVideoTrack()?this._options.video&&(typeof this._options.video=="function"?(u=await this._options.video(l,i),yo(u),i++):u=this._options.video):l.isAudioTrack()?this._options.audio&&(typeof this._options.audio=="function"?(u=await this._options.audio(l,s),To(u),s++):u=this._options.audio):d(!1),u?.discard){this.discardedTracks.push({track:l,reason:"discarded_by_user"});continue}if(this._totalTrackCount===r.total.max){this.discardedTracks.push({track:l,reason:"max_track_count_reached"});continue}if(this._addedCounts[l.type]===r[l.type].max){this.discardedTracks.push({track:l,reason:"max_track_count_of_type_reached"});continue}l.isVideoTrack()?await this._processVideoTrack(l,u??{}):l.isAudioTrack()&&await this._processAudioTrack(l,u??{})}let a=await this.input.getMetadataTags(),n;if(this._options.tags){let l=typeof this._options.tags=="function"?await this._options.tags(a):this._options.tags;Wi(l),n=l}else n=a;let o=(await this.input.getFormat()).mimeType===this.output.format.mimeType,c=a.raw===n.raw;if(a.raw&&c&&!o&&delete n.raw,this.output.setMetadataTags(n),this.isValid=this._totalTrackCount>=r.total.min&&this._addedCounts.video>=r.video.min&&this._addedCounts.audio>=r.audio.min&&this._addedCounts.subtitle>=r.subtitle.min,this._options.showWarnings??!0){let l=[],u=this.discardedTracks.filter(h=>h.reason!=="discarded_by_user");u.length>0&&l.push("Some tracks had to be discarded from the conversion:",u),this.isValid||l.push("\n\n"+this._getInvalidityExplanation().join("")),l.length>0&&console.warn(...l)}}_getInvalidityExplanation(){let t=[];if(this.discardedTracks.length===0)t.push("Due to missing tracks, this conversion cannot be executed.");else{let r=this.discardedTracks.every(i=>i.reason==="discarded_by_user"||i.reason==="no_encodable_target_codec");if(t.push("Due to discarded tracks, this conversion cannot be executed."),r){let i=this.discardedTracks.flatMap(s=>s.reason==="discarded_by_user"?[]:s.track.type==="video"?this.output.format.getSupportedVideoCodecs():s.track.type==="audio"?this.output.format.getSupportedAudioCodecs():this.output.format.getSupportedSubtitleCodecs());i.length===1?t.push("\nTracks were discarded because your environment is not able to encode '".concat(i[0],"'.")):t.push("\nTracks were discarded because your environment is not able to encode any of the following codecs: ".concat(i.map(s=>"'".concat(s,"'")).join(", "),".")),i.includes("mp3")&&t.push("\nThe @mediabunny/mp3-encoder extension package provides support for encoding MP3.")}else t.push("\nCheck the discardedTracks field for more info.")}return t}async execute(){if(!this.isValid)throw new Error("Cannot execute this conversion because its output configuration is invalid. Make sure to always check the isValid field before executing a conversion.\n"+this._getInvalidityExplanation().join(""));if(this._executed)throw new Error("Conversion cannot be executed twice.");if(this._executed=!0,this.onProgress){this._computeProgress=!0,this._totalDuration=Math.min(await this.input.computeDuration()-this._startTimestamp,this._endTimestamp-this._startTimestamp);for(let t of this.utilizedTracks)this._maxTimestamps.set(t.id,0);this.onProgress?.(0)}await this.output.start(),this._start();try{await Promise.all(this._trackPromises)}catch(t){throw this._canceled||this.cancel(),t}this._canceled&&await new Promise(()=>{}),await this.output.finalize(),this._computeProgress&&this.onProgress?.(1)}async cancel(){if(!(this.output.state==="finalizing"||this.output.state==="finalized")){if(this._canceled){console.warn("Conversion already canceled.");return}this._canceled=!0,await this.output.cancel()}}async _processVideoTrack(t,r){let i=t.codec;if(!i){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let s,a=pt(t.rotation+(r.rotate??0)),n=this.output.format.supportsVideoRotationMetadata,[o,c]=a%180===0?[t.codedWidth,t.codedHeight]:[t.codedHeight,t.codedWidth],l=r.crop;l&&Qi(l,o,c);let[u,h]=l?[l.width,l.height]:[o,c],f=u,w=h,b=f/w,p=B=>Math.ceil(B/2)*2;r.width!==void 0&&r.height===void 0?(f=p(r.width),w=p(Math.round(f/b))):r.width===void 0&&r.height!==void 0?(w=p(r.height),f=p(Math.round(w*b))):r.width!==void 0&&r.height!==void 0&&(f=p(r.width),w=p(r.height));let y=await t.getFirstTimestamp(),k=!!r.forceTranscode||this._startTimestamp>0||y<0||!!r.frameRate||r.keyFrameInterval!==void 0||r.process!==void 0,T=f!==u||w!==h||a!==0&&!n||!!l,_=r.alpha??"discard",x=this.output.format.getSupportedVideoCodecs();if(!k&&!r.bitrate&&!T&&x.includes(i)&&(!r.codec||r.codec===i)){let B=new wo(i);s=B,this._trackPromises.push((async()=>{await this._started;let I=new br(t),V={decoderConfig:await t.getDecoderConfig()??void 0},he=Number.isFinite(this._endTimestamp)?await I.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let G of I.packets(void 0,he,{verifyKeyPackets:!0})){if(this._canceled)return;_==="discard"&&(delete G.sideData.alpha,delete G.sideData.alphaByteLength),this._reportProgress(t.id,G.timestamp),await B.add(G,V),this._synchronizer.shouldWait(t.id,G.timestamp)&&await this._synchronizer.wait(G.timestamp)}B.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}r.codec&&(x=x.filter(G=>G===r.codec));let I=r.bitrate??Ws,M=await go(x,{width:r.process&&r.processedWidth?r.processedWidth:f,height:r.process&&r.processedHeight?r.processedHeight:w,bitrate:I});if(!M){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}let V={codec:M,bitrate:I,keyFrameInterval:r.keyFrameInterval,sizeChangeBehavior:r.fit??"passThrough",alpha:_},he=new qs(V);if(s=he,!T){let G=new Ys({format:new zs,target:new oo}),W=new qs(V);G.addVideoTrack(W),await G.start();let fe=await new gi(t).getSample(y);if(fe)try{await W.add(fe),fe.close(),await G.finalize()}catch(We){console.info("Error when probing encoder support. Falling back to rerender path.",We),T=!0,G.cancel()}else await G.cancel()}T?this._trackPromises.push((async()=>{await this._started;let W=new Va(t,{width:f,height:w,fit:r.fit??"fill",rotation:a,crop:r.crop,poolSize:1,alpha:_==="keep"}).canvases(this._startTimestamp,this._endTimestamp),ee=r.frameRate,fe=null,We=null,zt=null,Me=async ze=>{d(fe),d(ee!==void 0);let Oe=Math.round((ze-We)*ee);for(let Rt=1;Rt<Oe;Rt++){let vt=new Qe(fe,{timestamp:We+Rt/ee,duration:1/ee});await this._registerVideoSample(t,r,he,vt)}};for await(let{canvas:ze,timestamp:Oe,duration:Rt}of W){if(this._canceled)return;let vt=Math.max(Oe-this._startTimestamp,0);if(zt=vt+Rt,ee!==void 0){let m=Math.floor(vt*ee)/ee;if(fe!==null)if(m<=We){fe=ze,We=m;continue}else await Me(m);vt=m}let Yr=new Qe(ze,{timestamp:vt,duration:ee!==void 0?1/ee:Rt});await this._registerVideoSample(t,r,he,Yr),ee!==void 0?(fe=ze,We=vt):Yr.close()}fe&&(d(zt!==null),d(ee!==void 0),await Me(Math.floor(zt*ee)/ee)),he.close(),this._synchronizer.closeTrack(t.id)})()):this._trackPromises.push((async()=>{await this._started;let G=new gi(t),W=r.frameRate,ee=null,fe=null,We=null,zt=async Me=>{d(ee),d(W!==void 0);let ze=Math.round((Me-fe)*W);for(let Oe=1;Oe<ze;Oe++)ee.setTimestamp(fe+Oe/W),ee.setDuration(1/W),await this._registerVideoSample(t,r,he,ee);ee.close()};for await(let Me of G.samples(this._startTimestamp,this._endTimestamp)){if(this._canceled){ee?.close();return}let ze=Math.max(Me.timestamp-this._startTimestamp,0);if(We=ze+Me.duration,W!==void 0){let Oe=Math.floor(ze*W)/W;if(ee!==null)if(Oe<=fe){ee.close(),ee=Me,fe=Oe;continue}else await zt(Oe);ze=Oe,Me.setDuration(1/W)}Me.setTimestamp(ze),await this._registerVideoSample(t,r,he,Me),W!==void 0?(ee=Me,fe=ze):Me.close()}ee&&(d(We!==null),d(W!==void 0),await zt(Math.floor(We*W)/W)),he.close(),this._synchronizer.closeTrack(t.id)})())}this.output.addVideoTrack(s,{frameRate:r.frameRate,languageCode:Dr(t.languageCode)?t.languageCode:void 0,name:t.name??void 0,rotation:T?0:a}),this._addedCounts.video++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerVideoSample(t,r,i,s){if(this._canceled)return;this._reportProgress(t.id,s.timestamp);let a;if(!r.process)a=[s];else{let n=r.process(s);n instanceof Promise&&(n=await n),Array.isArray(n)||(n=n===null?[]:[n]),a=n.map(o=>o instanceof Qe?o:typeof VideoFrame<"u"&&o instanceof VideoFrame?new Qe(o):new Qe(o,{timestamp:s.timestamp,duration:s.duration}))}for(let n of a){if(this._canceled)break;await i.add(n),this._synchronizer.shouldWait(t.id,n.timestamp)&&await this._synchronizer.wait(n.timestamp)}for(let n of a)n!==s&&n.close()}async _processAudioTrack(t,r){let i=t.codec;if(!i){this.discardedTracks.push({track:t,reason:"unknown_source_codec"});return}let s,a=t.numberOfChannels,n=t.sampleRate,o=await t.getFirstTimestamp(),c=r.numberOfChannels??a,l=r.sampleRate??n,u=c!==a||l!==n||this._startTimestamp>0||o<0,h=this.output.format.getSupportedAudioCodecs();if(!r.forceTranscode&&!r.bitrate&&!u&&h.includes(i)&&(!r.codec||r.codec===i)&&!r.process){let f=new bo(i);s=f,this._trackPromises.push((async()=>{await this._started;let w=new br(t),p={decoderConfig:await t.getDecoderConfig()??void 0},y=Number.isFinite(this._endTimestamp)?await w.getPacket(this._endTimestamp,{metadataOnly:!0})??void 0:void 0;for await(let k of w.packets(void 0,y)){if(this._canceled)return;this._reportProgress(t.id,k.timestamp),await f.add(k,p),this._synchronizer.shouldWait(t.id,k.timestamp)&&await this._synchronizer.wait(k.timestamp)}f.close(),this._synchronizer.closeTrack(t.id)})())}else{if(!await t.canDecode()){this.discardedTracks.push({track:t,reason:"undecodable_source_codec"});return}let w=null;r.codec&&(h=h.filter(y=>y===r.codec));let b=r.bitrate??Ws,p=await Bi(h,{numberOfChannels:r.process&&r.processedNumberOfChannels?r.processedNumberOfChannels:c,sampleRate:r.process&&r.processedSampleRate?r.processedSampleRate:l,bitrate:b});if(!p.some(y=>er.includes(y))&&h.some(y=>er.includes(y))&&(c!==Zs||l!==Js)){let k=(await Bi(h,{numberOfChannels:Zs,sampleRate:Js,bitrate:b})).find(T=>er.includes(T));k&&(u=!0,w=k,c=Zs,l=Js)}else w=p[0]??null;if(w===null){this.discardedTracks.push({track:t,reason:"no_encodable_target_codec"});return}if(u)s=this._resampleAudio(t,r,w,c,l,b);else{let y=new js({codec:w,bitrate:b});s=y,this._trackPromises.push((async()=>{await this._started;let k=new wi(t);for await(let T of k.samples(void 0,this._endTimestamp)){if(this._canceled)return;await this._registerAudioSample(t,r,y,T),T.close()}y.close(),this._synchronizer.closeTrack(t.id)})())}}this.output.addAudioTrack(s,{languageCode:Dr(t.languageCode)?t.languageCode:void 0,name:t.name??void 0}),this._addedCounts.audio++,this._totalTrackCount++,this.utilizedTracks.push(t)}async _registerAudioSample(t,r,i,s){if(this._canceled)return;this._reportProgress(t.id,s.timestamp);let a;if(!r.process)a=[s];else{let n=r.process(s);if(n instanceof Promise&&(n=await n),Array.isArray(n)||(n=n===null?[]:[n]),!n.every(o=>o instanceof bt))throw new TypeError("The audio process function must return an AudioSample, null, or an array of AudioSamples.");a=n}for(let n of a){if(this._canceled)break;await i.add(n),this._synchronizer.shouldWait(t.id,n.timestamp)&&await this._synchronizer.wait(n.timestamp)}for(let n of a)n!==s&&n.close()}_resampleAudio(t,r,i,s,a,n){let o=new js({codec:i,bitrate:n});return this._trackPromises.push((async()=>{await this._started;let c=new Xd({targetNumberOfChannels:s,targetSampleRate:a,startTime:this._startTimestamp,endTime:this._endTimestamp,onSample:h=>this._registerAudioSample(t,r,o,h)}),u=new wi(t).samples(this._startTimestamp,this._endTimestamp);for await(let h of u){if(this._canceled)return;await c.add(h)}await c.finalize(),o.close(),this._synchronizer.closeTrack(t.id)})()),o}_reportProgress(t,r){if(!this._computeProgress)return;d(this._totalDuration!==null),this._maxTimestamps.set(t,Math.max(r,this._maxTimestamps.get(t)));let i=Math.min(...this._maxTimestamps.values()),s=Ie(i/this._totalDuration,0,1);s!==this._lastProgress&&(this._lastProgress=s,this.onProgress?.(s))}},So=5,Gd=class{constructor(){this.maxTimestamps=new Map,this.resolvers=[]}computeMinAndMaybeResolve(){let e=1/0;for(let[,t]of this.maxTimestamps)e=Math.min(e,t);for(let t=0;t<this.resolvers.length;t++){let r=this.resolvers[t];r.timestamp-e<So&&(r.resolve(),this.resolvers.splice(t,1),t--)}return e}shouldWait(e,t){this.maxTimestamps.set(e,Math.max(t,this.maxTimestamps.get(e)??-1/0));let r=this.computeMinAndMaybeResolve();return t-r>=So}wait(e){let{promise:t,resolve:r}=ke();return this.resolvers.push({timestamp:e,resolve:r}),t}closeTrack(e){this.maxTimestamps.delete(e),this.computeMinAndMaybeResolve()}},Xd=class{constructor(e){this.sourceSampleRate=null,this.sourceNumberOfChannels=null,this.targetSampleRate=e.targetSampleRate,this.targetNumberOfChannels=e.targetNumberOfChannels,this.startTime=e.startTime,this.endTime=e.endTime,this.onSample=e.onSample,this.bufferSizeInFrames=Math.floor(this.targetSampleRate*5),this.bufferSizeInSamples=this.bufferSizeInFrames*this.targetNumberOfChannels,this.outputBuffer=new Float32Array(this.bufferSizeInSamples),this.bufferStartFrame=0,this.maxWrittenFrame=-1}doChannelMixerSetup(){d(this.sourceNumberOfChannels!==null);let e=this.sourceNumberOfChannels,t=this.targetNumberOfChannels;e===1&&t===2?this.channelMixer=(r,i)=>r[i*e]:e===1&&t===4?this.channelMixer=(r,i,s)=>r[i*e]*+(s<2):e===1&&t===6?this.channelMixer=(r,i,s)=>r[i*e]*+(s===2):e===2&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return .5*(r[s]+r[s+1])}:e===2&&t===4?this.channelMixer=(r,i,s)=>r[i*e+s]*+(s<2):e===2&&t===6?this.channelMixer=(r,i,s)=>r[i*e+s]*+(s<2):e===4&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return .25*(r[s]+r[s+1]+r[s+2]+r[s+3])}:e===4&&t===2?this.channelMixer=(r,i,s)=>{let a=i*e;return .5*(r[a+s]+r[a+s+2])}:e===4&&t===6?this.channelMixer=(r,i,s)=>{let a=i*e;return s<2?r[a+s]:s===2||s===3?0:r[a+s-2]}:e===6&&t===1?this.channelMixer=(r,i)=>{let s=i*e;return Math.SQRT1_2*(r[s]+r[s+1])+r[s+2]+.5*(r[s+4]+r[s+5])}:e===6&&t===2?this.channelMixer=(r,i,s)=>{let a=i*e;return r[a+s]+Math.SQRT1_2*(r[a+2]+r[a+s+4])}:e===6&&t===4?this.channelMixer=(r,i,s)=>{let a=i*e;return s<2?r[a+s]+Math.SQRT1_2*r[a+2]:r[a+s+2]}:this.channelMixer=(r,i,s)=>s<e?r[i*e+s]:0}ensureTempBufferSize(e){let t=this.tempSourceBuffer.length;for(;t<e;)t*=2;if(t!==this.tempSourceBuffer.length){let r=new Float32Array(t);r.set(this.tempSourceBuffer),this.tempSourceBuffer=r}}async add(e){this.sourceSampleRate===null&&(this.sourceSampleRate=e.sampleRate,this.sourceNumberOfChannels=e.numberOfChannels,this.tempSourceBuffer=new Float32Array(this.sourceSampleRate*this.sourceNumberOfChannels),this.doChannelMixerSetup());let t=e.numberOfFrames*e.numberOfChannels;this.ensureTempBufferSize(t);let r=e.allocationSize({planeIndex:0,format:"f32"}),i=new Float32Array(this.tempSourceBuffer.buffer,0,r/4);e.copyTo(i,{planeIndex:0,format:"f32"});let s=e.timestamp-this.startTime,a=e.numberOfFrames/this.sourceSampleRate,n=Math.min(s+a,this.endTime-this.startTime),o=Math.floor(s*this.targetSampleRate),c=Math.ceil(n*this.targetSampleRate);for(let l=o;l<c;l++){if(l<this.bufferStartFrame)continue;for(;l>=this.bufferStartFrame+this.bufferSizeInFrames;)await this.finalizeCurrentBuffer(),this.bufferStartFrame+=this.bufferSizeInFrames;let u=l-this.bufferStartFrame;d(u<this.bufferSizeInFrames);let w=(l/this.targetSampleRate-s)*this.sourceSampleRate,b=Math.floor(w),p=Math.ceil(w),y=w-b;for(let k=0;k<this.targetNumberOfChannels;k++){let T=0,_=0;b>=0&&b<e.numberOfFrames&&(T=this.channelMixer(i,b,k)),p>=0&&p<e.numberOfFrames&&(_=this.channelMixer(i,p,k));let x=T+y*(_-T),B=u*this.targetNumberOfChannels+k;this.outputBuffer[B]+=x}this.maxWrittenFrame=Math.max(this.maxWrittenFrame,u)}}async finalizeCurrentBuffer(){if(this.maxWrittenFrame<0)return;let e=(this.maxWrittenFrame+1)*this.targetNumberOfChannels,t=new Float32Array(e);t.set(this.outputBuffer.subarray(0,e));let r=this.bufferStartFrame/this.targetSampleRate,i=new bt({format:"f32",sampleRate:this.targetSampleRate,numberOfChannels:this.targetNumberOfChannels,timestamp:r,data:t});await this.onSample(i),this.outputBuffer.fill(0),this.maxWrittenFrame=-1}finalize(){return this.finalizeCurrentBuffer()}};return Ze(_e)})();typeof zi=="object"&&typeof zi.exports=="object"&&Object.assign(zi.exports,yh)});var rc=He((Pp,tc)=>{var Ri=ra(),Th=Go(),{Output:Sh,Mp4OutputFormat:vh,StreamTarget:_h,VideoSampleSource:Ch,VideoSample:Jo,QUALITY_HIGH:xh}=Zo(),Ph=require("fs/promises"),re,Ye,Xt,Yt,st,ur,ec;tc.exports=(ec=class{constructor(A){Pe(this,re);Pe(this,Ye);Pe(this,Xt,{});Pe(this,Yt,{});Pe(this,st,{});Pe(this,ur,{});v(this,"setStatus",A=>{[-1,0,1].includes(A)&&(P(this,Xt)[P(this,re)]=A)});v(this,"videoStart",async(A,g,S=null,C=20,U="av1",Q=!1,pe=!1)=>{let oe="".concat(A,"-").concat(g),Se=P(this,st)[P(this,re)]??null;if(Se!==null){if(oe===Se.recKey)return Se.filePath;throw new Error("Cannot record more than one video per agent")}let{fileName:Ze,filePath:Je,minSize:_e,maxSize:d}=await P(this,Ye).ipc.diskStorage.outputFilesInit(P(this,re),A,g,S??"mp4");P(this,st)[P(this,re)]={recKey:oe,filePath:Je},P(this,ur)[P(this,re)]={path:null,width:0,height:0,duration:0};let pt=1,de=0,at=0,ce=null,L=null,Dt=Number.isInteger(d)?d*1048576:null,dr=1e3/C,ge={av1:"av1",h264:"avc"},le=()=>{P(this,Ye).irc.send(Ri.WINDOW_MAIN,"irc-target:video:info",[P(this,re),{fileName:"\u{1F3A5} ".concat(Ze),rec:!0,total:at}])},Ce=(J=null)=>{delete P(this,st)[P(this,re)],P(this,Xt)[P(this,re)]===1&&P(this,Ye).irc.send(Ri.WINDOW_MAIN,"irc-target:download:info",[P(this,re),oe,{fileName:"\u{1F3A5} ".concat(Ze),totalBytes:de,progress:"100",done:!0,error:J}]),P(this,Ye).irc.send(Ri.WINDOW_MAIN,"irc-target:video:info",[P(this,re),{fileName:"\u{1F3A5} ".concat(Ze),rec:!1,total:at}]),J!==null&&P(this,Ye).ipc.diskStorage.outputFilesDelete(P(this,re),A,Ze),P(this,ur)[P(this,re)]={path:J===null?Je:null,duration:J===null?Math.floor(pt*dr/1e3):0,width:J===null?ce:0,height:J===null?L:0,error:J}};try{if(P(this,st)[P(this,re)]?.recKey!==oe||![1,0].includes(P(this,Xt)[P(this,re)]))throw new Error("Video recording cancelled");let J=new Ch({codec:ge[U]??"av1",bitrate:xh,sizeChangeBehavior:"fill",alpha:"discard"}),et=new Sh({format:new vh({fastStart:!1}),target:new _h(new WritableStream({start:async()=>{this._fileHandle=await Ph.open(Je,"w")},write:async Ae=>{if(typeof this._fileHandle?.write!="function"){delete P(this,st)[P(this,re)];return}await this._fileHandle.write(Ae.data,0,Ae.data.byteLength,Ae.position),de+=Ae.data.byteLength,Dt!==null&&de>=Dt&&delete P(this,st)[P(this,re)]},close:async()=>{this._fileHandle&&(await this._fileHandle.close(),this._fileHandle=null)}}),{chunked:!0,chunkSize:262144})});et.addVideoTrack(J),et.setMetadataTags({title:Ze,artist:"oglama.com",date:new Date,comment:"Generated by Oglama",raw:{"\xA9cpy":"\xA9 ".concat(new Date().getFullYear()," https://oglama.com/")}}),(async()=>{le();try{let Ae=Math.floor(performance.now()/1e3);await et.start();let zr=null,_t=null;if(!Q){let Zt=await P(this,Ye).ipc.target.getBounds(P(this,re));zr=Zt.width,_t=Zt.height}let{imgData:ri,imgSize:nt}=await P(this,Ye).ipc.target.captureFrame(P(this,re),zr,_t,!0);if(!nt?.width||!nt?.height)throw new Error("Cannot record video");for(ce=nt.width,L=nt.height,await J.add(new Jo(ri,{timestamp:0,duration:1/C,format:"BGRA",codedWidth:ce,codedHeight:L,rotation:0}));P(this,st)[P(this,re)]?.recKey===oe&&[1,0].includes(P(this,Xt)[P(this,re)]);){if(P(this,Xt)[P(this,re)]===0&&!pe){await new Promise(Ot=>setTimeout(Ot,250));continue}let Zt=performance.now(),{imgData:ii,imgSize:Ct}=await P(this,Ye).ipc.target.captureFrame(P(this,re));if(!Ct?.width||!Ct?.height){await new Promise(Ot=>setTimeout(Ot,250));continue}await J.add(new Jo(ii,{timestamp:pt*dr/1e3,duration:1/C,format:"BGRA",codedWidth:Ct.width,codedHeight:Ct.height,rotation:0})),pt++;let xt=Math.floor(performance.now()/1e3)-Ae;xt>at&&(at=xt,le());let Rr=performance.now()-Zt;Rr<dr&&await new Promise(Ot=>setTimeout(Ot,dr-Rr))}Ce(),await et.finalize()}catch(Ae){await et.finalize(),Ce("".concat(Ae.message??Ae))}do{if(de<=0){Ce('Failed to record video as "'.concat(Ze,'"'));break}if(Number.isInteger(_e)&&de<_e*1048576){Ce('Minimum file size not met for "'.concat(Ze,'" (').concat((de/1048576).toFixed(3),"MB)"));break}}while(!1);typeof P(this,Yt)[P(this,re)]=="function"&&(P(this,Yt)[P(this,re)](P(this,ur)[P(this,re)]),delete P(this,Yt)[P(this,re)])})()}catch(J){return Ce("".concat(J.message??J)),null}return Je});v(this,"videoStop",async()=>typeof P(this,st)[P(this,re)]=="object"&&typeof P(this,Yt)[P(this,re)]!="function"?new Promise(A=>{P(this,Yt)[P(this,re)]=A,delete P(this,st)[P(this,re)]}):P(this,ur)[P(this,re)]??{path:null,width:0,height:0,duration:0});ft(this,re,A),ft(this,Ye,new Th(Ri.getWorkerChannelName(A)).getSdk());for(let g of Object.getOwnPropertyNames(this))typeof this[g]=="function"&&P(this,Ye).irc.handle(g,this[g])}},re=new WeakMap,Ye=new WeakMap,Xt=new WeakMap,Yt=new WeakMap,st=new WeakMap,ur=new WeakMap,ec)});var Ih=rc(),ic=process.argv.filter(Y=>Y.indexOf("--agent-id=")>=0).shift();if(typeof ic=="string"){let Y=ic.split("=")[1];Y.length&&new Ih(Y)}
